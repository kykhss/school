<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Management Pro</title>
    
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://unpkg.com/cropperjs/dist/cropper.css" rel="stylesheet">
    

    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; opacity: 0; transition: opacity 0.5s ease-in-out; }
        .view.active { display: flex; opacity: 1; }
        #main-app {
            display: flex;
            height: 100vh;
        }
        /* Ensure the main app container takes full height (if not already set) */
#main-app {
    display: flex;
    height: 100vh; /* Or adjust if you have a fixed header/footer outside main-app */
    overflow: hidden; /* Important for flex children scrolling */
}

/* Sidebar styling */
#sidebar {
    width: 280px;
    min-width: 280px;
    height: 100vh; /* As per your requirement */
    /* Make sidebar a flex container to manage its children's layout */
    display: flex;
    flex-direction: column; /* Stack children vertically */
    background-color: #fff;
    border-right: 1px solid #dee2e6; /* Bootstrap's border-end color */

    /* The sidebar itself will now scroll if its content overflows */
    overflow-y: auto;
    overflow-x: hidden; /* Prevent horizontal scrolling */
    position: relative; /* Needed for z-index and potentially sticky positioning of children */
    z-index: 10;
    transition: transform 0.3s ease-in-out;
}
#sidebar2 {
        
        height: 90vh; /* On mobile, it's still full viewport height */
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        overflow-y: auto;
        overflow-x: hidden;
    }


/* Sidebar overlay for mobile (from previous solution) */
#sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    pointer-events: none;
}
#sidebar-overlay.show {
    opacity: 1;
    pointer-events: auto;
    display: block !important;
}

/* Mobile-specific styles (from previous solution) */
@media (max-width: 991.98px) {
    #sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 95vh; /* On mobile, it's still full viewport height */
        transform: translateX(-100%);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        overflow-y: auto;
        overflow-x: hidden;
    }
    #sidebar2 {
        
        height: 80vh; /* On mobile, it's still full viewport height */
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        overflow-y: auto;
        overflow-x: hidden;
    }
    #sidebar.show {
        transform: translateX(0);
    }
    #sidebar-toggle-btn {
        display: block !important;
    }
    #sidebar-close-btn {
        display: block !important;
    }
    /* Ensure the sticky header still works on mobile sidebar
    #sidebar > div:first-child {
        position: sticky;
        top: 0;
        background-color: #fff;
        z-index: 11;
    } */
}
        .nav-link.active {
            background-color: #e9ecef;
            font-weight: 600;
        }
        .absent-mark { color: #dc3545; font-weight: bold; }
        .border-start-primary { border-left: .25rem solid #4e73df!important; }
        .border-start-success { border-left: .25rem solid #1cc88a!important; }
        .border-start-info { border-left: .25rem solid #36b9cc!important; }
        .border-start-warning { border-left: .25rem solid #f6c23e!important; }
        
        /* Attendance Color Codes */
        .att-present { background-color: #d1e7dd; color: #0f5132; }
        .att-absent { background-color: #f8d7da; color: #842029; font-weight: bold; }
        .att-half { background-color: #fff3cd; color: #664d03; }
        .att-holiday { background-color: #e2e3e5; color: #41464b; }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
        }

        .sub-tab-btn.active {
            border-bottom: 2px solid #0d6efd;
            color: #0d6efd;
        }

        @media print {
    .no-print {
        display: none !important;
    }
    /* Optionally, to ensure only modal content prints well */
    body > *:not(#fullStudentDetailModal) {
        display: none;
    }
    #fullStudentDetailModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: auto; /* Allow content to dictate height */
        overflow: visible; /* Allow content to overflow for print */
        background-color: #fff; /* Ensure white background */
    }
    #fullStudentDetailModal .modal-dialog {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    #fullStudentDetailModal .modal-content {
        border: none;
        border-radius: 0;
        box-shadow: none;
        min-height: auto;
    }
    #fullStudentDetailModal .modal-body {
        padding: 20px; /* Adjust padding for print if needed */
    }
}

.ui-card {
    background-color: #ffffff;
    border-radius: 0.5rem;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    margin-bottom: 1.5rem;
}

.section-header {
    font-weight: 600;
    color: #333;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    border-bottom: 1px solid #e5e7eb;
}

.table thead th {
    background-color: #f9fafb;
    font-weight: 600;
    color: #4b5563;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.table-hover tbody tr:hover {
    background-color: #f3f4f6;
}

.table td, .table th {
    vertical-align: middle;
}

.color-dot-display {
    display: inline-block;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 1px solid #d1d5db;
    vertical-align: middle;
    margin-right: 0.5rem;
}

    </style>
</head>
<body class="bg-light">
    <!-- Notification Bell Dropdown -->
<!-- Notification Bell Dropdown -->
 <div id="offline-indicator" class="bg-danger text-white text-center p-2" style="display: none; position: fixed; width: 100%; z-index: 2000;">
  <i class="fas fa-exclamation-triangle me-2"></i> You are currently offline. Some features may be unavailable.
  </div>
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1030;">
    <div class="dropdown">
        <button class="btn btn-light btn-lg rounded-circle position-relative" type="button" id="notificationBell" onclick="toggleNotificationDropdown(event)">
            <i class="fas fa-bell text-secondary"></i>
            <span id="notification-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
                0
            </span>
        </button>
        <ul id="notification-list" class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationBell" style="width: 350px;">
            <!-- Notifications will be rendered here -->
        </ul>
    </div>
</div>

    <div id="custom-alert" class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1050; display: none;">
        <div id="custom-alert-content" class="alert d-flex align-items-center" role="alert">
            <i id="custom-alert-icon" class="fas me-2"></i>
            <div id="custom-alert-message"></div>
        </div>
    </div>

    <div id="app-container">
        <div id="login-screen" class=" view vh-100 align-items-center justify-content-center bg-light">
            <div class="card shadow-lg" style="width: 100%; max-width: 420px;">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <i class="fas fa-school fa-3x text-primary"></i>
                        <h1 class="mt-3 h3 fw-bold">School Management Pro</h1>
                        <p class="text-muted">Select your role to sign in</p>
                    </div>

                    <ul class="nav nav-tabs nav-fill mb-4" id="loginTab" role="tablist">
                        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#admin-login-view" type="button" role="tab">Admin</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#teacher-login-view" type="button" role="tab">Teacher</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#student-login-view" type="button" role="tab">Student</button></li>
                    </ul>

                    <form id="login-form">
                        <div class="tab-content">
                            <div class="tab-pane fade" id="admin-login-view" role="tabpanel">
                                <div class="mb-3"><label class="form-label">Username</label><input type="text" id="admin-user" value="" class="form-control"></div>
                                <div class="mb-3"><label class="form-label">Password</label><input type="password" id="admin-pass" value="" class="form-control"></div>
                            </div>
                            <div class="tab-pane fade active show" id="teacher-login-view" role="tabpanel">
                                <div class="mb-3"><label class="form-label">Email</label><input type="email" id="teacher-useremail" placeholder="Enter your email" class="form-control" style="text-transform: lowercase;"></div>
                                <div class="mb-3"><label class="form-label">Password</label><input type="password" id="teacher-password" placeholder="Last 5 digits of your mobile" class="form-control"></div>
                            </div>
                            <div class="tab-pane fade" id="student-login-view" role="tabpanel">
                                <div class="mb-3"><label class="form-label">Admission Number</label><input type="text" id="student-admn" placeholder="Last 4 digits of Admission No." class="form-control" style="text-transform: uppercase;"></div>
                                <div class="mb-3"><label class="form-label">Password</label><input type="password" id="student-dob" placeholder="Your year of birth (YYYY)" class="form-control"></div>
                            </div>
                        </div>
                        <div class="d-grid mt-4"><button type="submit" class="btn btn-primary btn-lg">Sign In</button></div>
                    </form>
                </div>
            </div>
        </div>

        <div id="main-app" class="view">
    <div id="sidebar-overlay" class="d-none"></div>

    <button id="sidebar-toggle-btn" class="btn btn-primary d-lg-none position-fixed top-0 start-0 m-3 z-3" style="z-index: 1000;">
        <i class="fas fa-bars"></i>
    </button>

    <aside id="sidebar" class="d-flex flex-column p-3 bg-white border-end">
        <div class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
            <i class="fas fa-school fa-2x text-primary"></i><span id="panel-title" class="fs-4 ms-3 fw-bold"></span>
            <button id="sidebar-close-btn" class="btn btn-sm btn-outline-secondary d-lg-none ms-auto"><i class="fas fa-times"></i></button>
            
        </div>
        
        <hr>
        <div id="sidebar2">
        <nav id="sidebar-nav" class="nav nav-pills flex-column mb-auto"></nav>
    </div>
        <hr>
        <button id="logout-btn" class="btn btn-outline-danger w-100"><i class="fas fa-sign-out-alt me-2"></i>Logout</button>
    
        <hr>
        
        </aside>

    <main id="main-content" class="flex-grow-1 p-4 overflow-auto bg-light"></main>
</div>
    </div>
<div class="modal fade" id="studentDetailModal" tabindex="-1" aria-labelledby="studentDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="studentDetailModalLabel">Student Fee Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="studentDetailModalBody">
        </div>
    </div>
  </div>
</div>

    <div class="modal fade" id="fullStudentDetailModal" tabindex="-1" aria-labelledby="fullStudentDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable"> <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="fullStudentDetailModalLabel">Student Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="fullStudentDetailModalBody">
        </div>
      <div class="modal-footer no-print"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="print-student-details-btn"><i class="fas fa-print me-2"></i>Print / Save PDF</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="editIssuanceModal" tabindex="-1" aria-labelledby="editIssuanceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editIssuanceModalLabel">Edit Book Issuance</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Student:</strong> <span id="modal-student-name"></span></p>
        <p><strong>Book:</strong> <span id="modal-book-title"></span></p>
        <hr>
        <form id="edit-issuance-form">
            <input type="hidden" id="modal-issuance-id">
            <div class="mb-3">
                <label for="modal-due-date" class="form-label">New Due Date</label>
                <input type="date" class="form-control" id="modal-due-date" required>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" id="modal-save-issuance-btn" class="btn btn-primary">Save Changes</button>
      </div>
    </div>
  </div>
</div>
   <!-- Cropper CSS -->
<link href="https://unpkg.com/cropperjs/dist/cropper.min.css" rel="stylesheet"/>

<!-- Cropper JS -->
<script src="https://unpkg.com/cropperjs/dist/cropper.min.js"></script>

    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, getDoc, getDocs, collection, onSnapshot, deleteDoc, writeBatch, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = 'school-management-app';
        const firebaseConfig = {
            apiKey: "AIzaSyAu5TDMWepJX7naoG5H3WpGJ1yxAu01whg",
            authDomain: "timetables-470dd.firebaseapp.com",
            projectId: "timetables-470dd",
            storageBucket: "timetables-470dd.appspot.com",
            messagingSenderId: "925422681424",
            appId: "1:925422681424:web:df91ce9de4dfef9c5ec055"
        };

        let db, auth;
        const mainContent = document.getElementById('main-content');
        const sidebarNav = document.getElementById('sidebar-nav');
        let classes = [], teachers = [], subjects = [], students = [], exams = [], classroomSubjects = [], examSchedules = [], marks = [], attendance = [], holidays = [], syllabuses = [], syllabusCompletion = [], chapters = [],books = [], bookIssuances = [];
;
        let feeStructures = [], studentFeeSetups = [], receipts = [];
        
        let unsubscribeListeners = [];
        let unsubscribeFeeListeners = [];
        
        let currentUserRole = null;
        let selectedUser = null; 
        let classToEdit = null, teacherToEdit = null, studentToEdit = null;let subjectToEdit = null; 
        let allocationToEdit = null; 
        let attendanceChart = null;
        let completionModalInstance = null;
        let receiptToEdit = null;
        let feeStructureToEdit = null;
        let activeFinancialYear = `${new Date().getFullYear()}-${new Date().getFullYear() + 1}`;
        let forms = [];
        let formResponses = [];
        let formToEdit = null;
        // --- Global Variables for Photo Handling and Cropper Instance ---
        let cropper =null;
        let rawPhotoFile = null; // Stores the raw file chosen by user for cropping
        let croppedPhotoBlob = null; // Stores the final cropped image as a Blob for upload
        let currentPhotoURL = ''; // Stores the URL of the student's existing photo (if editing)
        let reports = [], schoolDetails = {},vehicles = [];
        // Add this near your other global variables
let currentLibraryReportData = [];
let libraryReportSort = {
    column: 'dueDate', // Default column to sort by
    direction: 'asc'   // Default direction ('asc' or 'desc')
};

// Add this near the other fest-related global variables
let festParticipantFilters = {
    festId: '', // Stores the last selected Fest ID
    classId: '' // Stores the last selected Class ID
};

// Add these to your list of global variables
let festHouses = [], fests = [], festEvents = [], festRegistrations = [], festResults = [], festSettings = {};
// --- Global State & Timers ---
    let houseToEdit = null, festToEdit = null, eventToEdit = null;
   
        const adminNav = [
  { id: 'dashboard', icon: 'fa-tachometer-alt', text: 'Dashboard' },
  { id: 'add-student', icon: 'fa-user-plus', text: 'Add Student' },
  { id: 'student-mgt', icon: 'fa-users', text: 'Student Management' },
  { id: 'teacher-mgt', icon: 'fa-chalkboard-teacher', text: 'Teacher Management' },
  { id: 'class-mgt', icon: 'fa-school', text: 'Class Management' },
  { id: 'subject-mgt', icon: 'fa-book', text: 'Subject Management' },
  { id: 'subject-allocation', icon: 'fa-tasks', text: 'Subject Allocation' },
  { id: 'exam-mgt', icon: 'fa-file-signature', text: 'Exam Management' },
  { id: 'fee-mgt', icon: 'fa-receipt', text: 'Fee Management' },
  { id: 'attendance-mgt', icon: 'fa-calendar-check', text: 'Attendance' },
  { id: 'holiday-mgt', icon: 'fa-calendar-alt', text: 'Holiday Management' },
  { id: 'syllabus-tracker', icon: 'fa-tasks', text: 'Syllabus Tracker' },
  { id: 'form-mgt', icon: 'fa-wpforms', text: 'Form Creator' },
  { id: 'reports', icon: 'fa-chart-bar', text: 'Reports' }, // <-- ADD THIS LINE
  { id: 'school-details', icon: 'fa-university', text: 'School Details' }, // <-- ADD THIS
  { id: 'vehicle-mgt', icon: 'fa-bus', text: 'Vehicle Mgt' }, // <-- ADD THIS LINE
  { id: 'library-mgt', icon: 'fa-book-reader', text: 'Library Management' },
  { id: 'bulk-import', icon: 'fa-file-import', text: 'Bulk Import' },
  { id: 'fest-mgt', icon: 'fa-trophy', text: 'Fest Management' },
  { id: 'timetable-mgt', icon: 'fa-calendar-alt', text: 'Timetable Mgt' },

{ id: 'fest-scoreboard', icon: 'fa-chart-line', text: 'Live Scoreboard' },


 
];
const teacherNav = [
  { id: 'dashboard', icon: 'fa-tachometer-alt', text: 'Dashboard' },
  { id: 'student-mgt', icon: 'fa-users', text: 'Student List' },
  { id: 'attendance-mgt', icon: 'fa-calendar-check', text: 'My Class Attendance' },
  { id: 'exam-mgt', icon: 'fa-file-signature', text: 'Mark Entry' },
  { id: 'syllabus-tracker', icon: 'fa-tasks', text: 'Syllabus Tracker' },
  { id: 'teacher-forms', icon: 'fa-clipboard-check', text: 'Forms' }, // ✅ NEW
  { id: 'response-forms', icon: 'fa-table', text: 'Form Responses' },
  { id: 'fee-details', icon: 'fa-receipt', text: 'FeeDetails'},
  { id: 'exam-timetable', icon: 'fa-calendar-alt', text: 'Exam Timetable' },
  { id: 'class-timetable', icon: 'fa-calendar-days', text: 'Class Timetable' },{ id: 'library-mgt', icon: 'fa-book-reader', text: 'Library Management' },
{ id: 'class-timetable', icon: 'fa-calendar-days', text: 'Class Timetable' },

{ id: 'library-status', icon: 'fa-books', text: 'Library Status' },
{ id: 'fest-registration', icon: 'fa-user-check', text: 'Fest Registration' },
{ id: 'fest-scoreboard', icon: 'fa-chart-line', text: 'Live Scoreboard' },


];
const studentNav = [
  { id: 'dashboard', icon: 'fa-tachometer-alt', text: 'Dashboard' },
  { id: 'my-results', icon: 'fa-poll', text: 'My Results' },
  { id: 'my-attendance', icon: 'fa-calendar-alt', text: 'My Attendance' },
  { id: 'my-fees', icon: 'fa-rupee-sign', text: 'My Fees' },
  { id: 'forms', icon: 'fa-clipboard-check', text: 'Forms' }, // ✅ NEW
  { id: 'my-forms', icon: 'fa-file-alt', text: 'My Submissions' } ,// In your adminNav array
{ id: 'class-timetable', icon: 'fa-calendar-days', text: 'Class Timetable' },
{ id: 'my-library', icon: 'fa-book-open', text: 'My Library' },
{ id: 'my-fest-events', icon: 'fa-running', text: 'My Fest Events' },
{ id: 'fest-scoreboard', icon: 'fa-chart-line', text: 'Live Scoreboard' },


];

        const getCollectionRef = (name) => collection(db, `/artifacts/${appId}/public/data/${name}`);
        const getDocRef = (name, id) => doc(db, `/artifacts/${appId}/public/data/${name}`, id);
        const getFeeCollectionRef = (fy, name) => collection(db, `/artifacts/${appId}/public/data/feeData/${fy}/${name}`);
        const getFeeDocRef = (fy, name, id) => doc(db, `/artifacts/${appId}/public/data/feeData/${fy}/${name}`, id);

        function showAlert(message, type = 'danger') {
            const alertEl = document.getElementById('custom-alert');
            const contentEl = document.getElementById('custom-alert-content');
            const messageEl = document.getElementById('custom-alert-message');
            const iconEl = document.getElementById('custom-alert-icon');
            messageEl.textContent = message;
            
            contentEl.className = 'alert d-flex align-items-center'; // Reset classes
            if (type === 'success') {
                contentEl.classList.add('alert-success');
                iconEl.className = 'fas fa-check-circle me-2';
            } else { 
                contentEl.classList.add('alert-danger');
                iconEl.className = 'fas fa-exclamation-triangle me-2';
            }
            alertEl.style.display = 'block';
            setTimeout(() => { alertEl.style.display = 'none'; }, 3000);
        }
        
        
function onLoginSuccess(role, user) {
    currentUserRole = role;
    selectedUser = user;
 // Render the main application interface
    showMainApp();
    // Attach data listeners
    // attachMainDataListeners(role, user);
    attachFeeDataListeners(activeFinancialYear, role, user);
    
    // --- ✅ SESSION RESTORE LOGIC ---
    const savedSessionJSON = localStorage.getItem('schoolAppLastSession');
    if (savedSessionJSON) {
        const savedSession = JSON.parse(savedSessionJSON);
        const fifteenMinutes = 15 * 60 * 1000;

        // Check if the saved session is for the same user and is recent
        if (savedSession.userId === user.id && (Date.now() - savedSession.timestamp < fifteenMinutes)) {
            showAlert(`Restoring your previous session...`, 'info');
            // Restore the view, but do not push to history again
            navigateTo(savedSession.viewId, false); 
        }
        // Clean up the saved session regardless of whether it was used
        localStorage.removeItem('schoolAppLastSession');
    }
    // --- END OF LOGIC ---
}


        function attachMainDataListeners(role, user) {
    if (unsubscribeListeners.length > 0) {
        unsubscribeListeners.forEach(unsub => unsub());
        unsubscribeListeners = [];
    }

    let collectionsToWatch = {};

    // Base collections everyone needs
    const baseCollections = {
        classes: data => classes = data,
        subjects: data => subjects = data,
        exams: data => { exams = data; renderExamsList(); },
        holidays: data => holidays = data,
        schoolDetails: data => { if (data.length > 0) schoolDetails = data[0]; },
        festHouses: data => festHouses = data,
        fests: data => fests = data,
        festEvents: data => festEvents = data,
        festSettings: data => { if (data.length > 0) festSettings = data[0]; },
    };

    Object.assign(collectionsToWatch, baseCollections);

    switch (role) {
        case 'admin':
            // Admin needs everything
            Object.assign(collectionsToWatch, {
                teachers: data => teachers = data,
                students: data => { students = data; filterAndRenderStudents(); },
                classroomSubjects: data => classroomSubjects = data,
                examSchedules: data => examSchedules = data,
                marks: data => marks = data,
                attendance: data => attendance = data,
                syllabuses: data => syllabuses = data,
                syllabusCompletion: data => syllabusCompletion = data,
                chapters: data => chapters = data,
                forms: data => { forms = data; updateAllNotifications(); },
                formResponses: data => formResponses = data,
                reports: data => reports = data,
                books: data => books = data,
                bookIssuances: data => bookIssuances = data,
                vehicles: data => {
                    vehicles = data;
                    if (currentUserRole === 'admin') checkVehicleExpiriesAndNotify();
                },
                festRegistrations: data => festRegistrations = data,
                festResults: data => festResults = data,
            });
            break;

        case 'teacher':
            // Teacher needs their data, their class's data, and general school data
            Object.assign(collectionsToWatch, {
                teachers: data => teachers = data, // For general reference
                students: data => { students = data; filterAndRenderStudents(); }, // Filtered in view
                classroomSubjects: data => classroomSubjects = data, // Filtered in view
                examSchedules: data => examSchedules = data, // Filtered in view
                marks: data => marks = data, // Filtered in view
                attendance: data => attendance = data, // Filtered in view
                syllabuses: data => syllabuses = data, // Filtered in view
                syllabusCompletion: data => syllabusCompletion = data, // Filtered in view
                chapters: data => chapters = data, // Filtered in view
                forms: data => { forms = data; updateAllNotifications(); }, // Filtered in view
                formResponses: data => formResponses = data, // Filtered in view
                books: data => books = data,
                bookIssuances: data => bookIssuances = data,
                festRegistrations: data => festRegistrations = data,
                festResults: data => festResults = data,
            });
            break;

        case 'student':
            // Student needs their own data and general school data
            Object.assign(collectionsToWatch, {
                students: data => { students = data; }, // For their own profile
                marks: data => marks = data, // Filtered in view
                attendance: data => attendance = data, // Filtered in view
                forms: data => { forms = data; updateAllNotifications(); }, // Filtered in view
                formResponses: data => formResponses = data, // Filtered in view
                bookIssuances: data => bookIssuances = data, // Filtered in view
                festRegistrations: data => festRegistrations = data, // Filtered in view
            });
            // Render the main application interface
            break;
    }

    for (const [name, setter] of Object.entries(collectionsToWatch)) {
        const unsub = onSnapshot(getCollectionRef(name), snapshot => {
            setter(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            const activeNavId = document.querySelector('.nav-link.active')?.id.replace('nav-', '');
            if (activeNavId && window.viewRenderers[activeNavId]) {
                window.viewRenderers[activeNavId]();
            }
        }, (error) => {
            console.error(`[Firestore] Error listening to ${name}: `, error);
            showAlert(`Failed to load data: ${name}.`, 'danger');
        });
        unsubscribeListeners.push(unsub);
    }
    // Render the main application interface
    showMainApp();
}



// Add this new object to your script
const viewDependencies = {
    // Admin & General Views
    'dashboard': ['students', 'teachers', 'classes', 'subjects', 'attendance'],
    'add-student': ['classes', 'students'],
    'student-mgt': ['students', 'classes'],
    'teacher-mgt': ['teachers', 'classes'],
    'class-mgt': ['classes'],
    'subject-mgt': ['subjects'],
    'subject-allocation': ['classes', 'subjects', 'teachers', 'classroomSubjects'],
    'exam-mgt': ['exams', 'classes', 'subjects', 'teachers', 'examSchedules', 'marks'],
    'attendance-mgt': ['students', 'classes', 'holidays', 'attendance'],
    'holiday-mgt': ['holidays'],
    'syllabus-tracker': ['classes', 'subjects', 'teachers', 'classroomSubjects', 'chapters', 'syllabuses', 'syllabusCompletion'],
    'form-mgt': ['forms', 'formResponses'],
    'reports': ['reports', 'students', 'teachers', 'classes', 'subjects', 'classroomSubjects'],
    'school-details': ['schoolDetails'],
    'vehicle-mgt': ['vehicles'],
    'bulk-import': [], // No initial data needed
    'library-mgt': ['books', 'bookIssuances', 'students'],
    'fest-mgt': ['fests', 'festHouses', 'festEvents', 'festSettings', 'festRegistrations', 'festResults'],
    'timetable-mgt': ['classes', 'subjects', 'classroomSubjects', 'timetables'],

    // Teacher Views
    'teacher-forms': ['forms', 'formResponses', 'students'],
    'response-forms':['forms', 'formResponses', 'students'],
    'fee-details': ['students', 'classes', 'studentFeeSetups', 'receipts'],
    'exam-timetable': ['exams', 'examSchedules', 'subjects', 'classes'],
    'class-timetable': ['timetables', 'subjects', 'classes'],
    'library-status': ['bookIssuances', 'students', 'classes'],
    'fest-registration': ['fests', 'festEvents', 'festRegistrations', 'students', 'festSettings'],
    'fest-scoreboard': ['fests', 'festResults', 'festEvents', 'festRegistrations', 'festHouses'],


    // Student Views
    'my-results': ['exams', 'examSchedules', 'marks', 'subjects'],
    'my-attendance': ['holidays', 'attendance'],
    'my-fees': ['studentFeeSetups', 'receipts'],
    'forms': ['forms', 'formResponses'],
    'my-forms': ['forms', 'formResponses'],
    'my-library': ['bookIssuances'],
    'my-fest-events': ['fests', 'festRegistrations', 'festEvents'],
};

// Keep track of active listeners
let activeListeners = {};


/**
 * Unsubscribes from all active Firestore listeners.
 */
function unsubscribeAllListeners() {
    for (const key in activeListeners) {
        if (typeof activeListeners[key] === 'function') {
            activeListeners[key](); // Call the unsubscribe function
        }
    }
    activeListeners = {}; // Reset the object
}

/**
 * Attaches Firestore listeners only for the specified collections.
 * It avoids re-attaching listeners that are already active.
 * @param {string[]} collectionsToWatch - An array of collection names to listen to.
 */
async function attachDataListeners(collectionsToWatch) {
    if (!collectionsToWatch || collectionsToWatch.length === 0) return;

    // A map linking collection names to their state variable and any render function
    const collectionMap = {
        classes: { setter: data => classes = data },
        subjects: { setter: data => subjects = data },
        students: { setter: data => students = data, renderer: filterAndRenderStudents },
        teachers: { setter: data => teachers = data },
        exams: { setter: data => exams = data, renderer: renderExamsList },
        classroomSubjects: { setter: data => classroomSubjects = data },
        examSchedules: { setter: data => examSchedules = data },
        marks: { setter: data => marks = data },
        attendance: { setter: data => attendance = data },
        holidays: { setter: data => holidays = data },
        syllabuses: { setter: data => syllabuses = data },
        syllabusCompletion: { setter: data => syllabusCompletion = data },
        chapters: { setter: data => chapters = data },
        books: { setter: data => books = data },
        bookIssuances: { setter: data => bookIssuances = data },
        feeStructures: { setter: data => feeStructures = data },
        studentFeeSetups: { setter: data => studentFeeSetups = data },
        receipts: { setter: data => receipts = data },
        forms: { setter: data => forms = data, renderer: updateAllNotifications },
        formResponses: { setter: data => formResponses = data },
        reports: { setter: data => reports = data },
        schoolDetails: { setter: data => { if (data.length > 0) schoolDetails = data[0]; } },
        vehicles: { setter: data => vehicles = data, renderer: checkVehicleExpiriesAndNotify },
        festHouses: { setter: data => festHouses = data },
        fests: { setter: data => fests = data },
        festEvents: { setter: data => festEvents = data },
        festRegistrations: { setter: data => festRegistrations = data },
        festResults: { setter: data => festResults = data },
        festSettings: { setter: data => { if (data.length > 0) festSettings = data[0]; } },
        timetables: { setter: data => timetables = data },
    };

    collectionsToWatch.forEach(name => {
        // Only attach a listener if one isn't already active for this collection
        if (!activeListeners[name]) {
            const config = collectionMap[name];
            if (config) {
                const collectionRef = name.includes('fee') || name.includes('receipt')
                    ? getFeeCollectionRef(activeFinancialYear, name)
                    : getCollectionRef(name);

                const unsub = onSnapshot(collectionRef, snapshot => {
                    config.setter(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    // If a specific renderer function is associated, call it
                    if (config.renderer) {
                        config.renderer();
                    }
                }, (error) => {
                    console.error(`[Firestore] Error listening to ${name}: `, error);
                });

                // Store the new unsubscribe function
                activeListeners[name] = unsub;
            }
        }
    });
}

function attachFeeDataListeners(financialYear, role, user) {
    if (unsubscribeFeeListeners.length > 0) {
        unsubscribeFeeListeners.forEach(unsub => unsub());
        unsubscribeFeeListeners = [];
    }

    let collectionsToWatch = {
        feeStructures: data => feeStructures = data,
    };

    switch (role) {
        case 'admin':
            Object.assign(collectionsToWatch, {
                studentFeeSetups: data => studentFeeSetups = data,
                receipts: data => receipts = data,
            });
            break;
        case 'teacher':
            // For simplicity, teachers will get all setups and receipts and filter on the client.
            // This can be optimized with more complex queries if performance becomes an issue.
            Object.assign(collectionsToWatch, {
                studentFeeSetups: data => studentFeeSetups = data,
                receipts: data => receipts = data,
            });
            break;
        case 'student':
            // For student, we can listen to specific documents.
            // This is more efficient.
            const sfsRef = getFeeDocRef(financialYear, 'studentFeeSetups', user.id);
            const unsubSfs = onSnapshot(sfsRef, (doc) => {
                if (doc.exists()) {
                    // Update or add the single student's fee setup
                    const existingIndex = studentFeeSetups.findIndex(s => s.id === user.id);
                    if (existingIndex > -1) {
                        studentFeeSetups[existingIndex] = { id: doc.id, ...doc.data() };
                    } else {
                        studentFeeSetups.push({ id: doc.id, ...doc.data() });
                    }
                }
            });
            unsubscribeFeeListeners.push(unsubSfs);

            const receiptsQuery = query(getFeeCollectionRef(financialYear, 'receipts'), where('studentId', '==', user.id));
            const unsubReceipts = onSnapshot(receiptsQuery, (snapshot) => {
                receipts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });
            unsubscribeFeeListeners.push(unsubReceipts);
            break;
    }

    // Handle collections that are common or need full data for all roles
    for (const [collName, setter] of Object.entries(collectionsToWatch)) {
        const collRef = getFeeCollectionRef(financialYear, collName);
        const unsub = onSnapshot(collRef, snapshot => {
            setter(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            // Re-render the active fee tab if it's open
            const activeFeeTab = document.querySelector('#fee-main-tab .nav-link.active')?.dataset.subtab;
            if (activeFeeTab) {
                renderFeeSubTab(activeFeeTab);
            }
        });
        unsubscribeFeeListeners.push(unsub);
    }
}



        function renderSidebar(navItems) {
    sidebarNav.innerHTML = navItems.map(item => `<a href="#${item.id}" id="nav-${item.id}" class="nav-link text-dark"><i class="fas ${item.icon} me-2"></i>${item.text}</a>`).join('');
    navItems.forEach(item => {
        document.getElementById(`nav-${item.id}`).addEventListener('click', e => { 
            e.preventDefault(); 
            if (item.id === 'add-student') studentToEdit = null;
            navigateTo(item.id); 
        });
    });
}

      async  function navigateTo(viewId, pushState = true) {
    // 1. Get the required collections from our dependency map
    const requiredCollections = viewDependencies[viewId] || [];

    // 2. Attach listeners. This will only add listeners for collections not already active.
   await attachDataListeners(requiredCollections);

    // 3. Update the UI and render the view (this part remains the same)
    document.querySelectorAll('#sidebar-nav .nav-link').forEach(link => link.classList.remove('active'));
    const navLink = document.getElementById(`nav-${viewId}`);
    if (navLink) {
        navLink.classList.add('active');
    }

    if (pushState) {
        history.pushState({ viewId: viewId }, viewId, `#${viewId}`);
    }

    const renderFunc = window.viewRenderers[viewId];
    if (renderFunc) {
        setTimeout(() => {
            renderFunc();
        }, 100); 
    } else {
        mainContent.innerHTML = `<h1 class="h3">${viewId.replace(/-/g, ' ')}</h1><p>UI under construction.</p>`;
    }

    // Hide mobile sidebar
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    if (sidebar && sidebar.classList.contains('show')) {
        sidebar.classList.remove('show');
        sidebarOverlay.classList.remove('show');
        document.body.style.overflow = '';
    }
}

        
        // Find your existing showMainApp function and modify it like this:

function showMainApp() {
    document.getElementById('login-screen').classList.remove('active');
    document.getElementById('main-app').classList.add('active');
    const panelTitle = document.getElementById('panel-title');

    let navItems;
    if (currentUserRole === 'admin') {
        navItems = adminNav;
        panelTitle.textContent = "Admin Panel";
    } else if (currentUserRole === 'student') {
        navItems = studentNav;
        panelTitle.textContent = "Student Portal";
    } else if (currentUserRole === 'teacher') {
        let dynamicTeacherNav = teacherNav.filter(item =>
            item.id !== 'library-mgt' && item.id !== 'library-status'
        );

        if (selectedUser.roles && selectedUser.roles.includes('librarian')) {
            dynamicTeacherNav.push({ id: 'library-mgt', icon: 'fa-book-reader', text: 'Library Management' });
        } else if (selectedUser.classCharge) {
            dynamicTeacherNav.push({ id: 'library-status', icon: 'fa-books', text: 'Library Status' });
        }
        

        navItems = dynamicTeacherNav;
        panelTitle.textContent = "Teacher Panel";
    }

    renderSidebar(navItems);

    const initialViewId = 'dashboard';
    history.replaceState({ viewId: initialViewId }, initialViewId, `#${initialViewId}`);
    navigateTo(initialViewId, false);
}


        
        async function initializeAppAndAuth() {
            //document.getElementById('loading-spinner').classList.remove('d-none');
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // attachMainDataListeners();
                //  attachFeeDataListeners(activeFinancialYear);
                // document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('login-screen').classList.add('active');
            } catch (error) {
                //document.getElementById('loading-spinner').innerHTML = "Initialization Failed. Check Console.";
                console.error("Firebase Init Error:", error);
            }
        }
        
        document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    // Get the submit button from the form that triggered the event
    const submitButton = e.target.querySelector('button[type="submit"]');
    if (!submitButton) return; // Exit if the button isn't found

    // Store the button's original content and disable it
    const originalButtonHtml = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Signing In...`;

    try {
        const activeRole = document.querySelector('#loginTab .nav-link.active').getAttribute('data-bs-target').replace('#', '').replace('-login-view', '');

        if (!navigator.onLine) {
            showAlert('You are offline. Please connect to the internet to log in.', 'danger');
            return; // Early exit, 'finally' will still run
        }

        if (activeRole === 'admin') {
            const email = document.getElementById('admin-user').value.toLowerCase();
            const password = document.getElementById('admin-pass').value;

            if (!email || !password) {
                showAlert('Please enter admin email and password.', 'danger');
                return;
            }

            const q = query(getCollectionRef('teachers'), where('email', '==', email));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                showAlert('Admin user not found in the database.', 'danger');
            } else {
                const adminDoc = querySnapshot.docs[0];
                const adminData = { id: adminDoc.id, ...adminDoc.data() };

                if (adminData.role === 'admin') {
                    if (password === (adminData.mobile || '').slice(-5)) {
                        onLoginSuccess('admin', adminData);
                    } else {
                        showAlert('Incorrect password for admin.', 'danger');
                    }
                } else {
                    showAlert('This user does not have admin privileges.', 'danger');
                }
            }
        } else if (activeRole === 'teacher') {
            const email = document.getElementById('teacher-useremail').value.toLowerCase();
            const password = document.getElementById('teacher-password').value;
            if (!email || !password) {
                showAlert('Please enter email and password.', 'danger');
                return;
            }
            
            const q = query(getCollectionRef('teachers'), where('email', '==', email));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                showAlert('Teacher email not found.', 'danger');
            } else {
                const teacherDoc = querySnapshot.docs[0];
                const teacherData = { id: teacherDoc.id, ...teacherDoc.data() };
                if (password === (teacherData.mobile || '').slice(-5)) {
                    onLoginSuccess('teacher', teacherData);
                } else {
                    showAlert('Incorrect password for teacher.', 'danger');
                }
            }
        } else if (activeRole === 'student') {
            const admnNoSuffix = document.getElementById('student-admn').value.toUpperCase();
            const dobYear = document.getElementById('student-dob').value;
            if (!admnNoSuffix || !dobYear) {
                showAlert('Please enter Admission No. and Year of Birth.', 'danger');
                return;
            }

            const studentsSnapshot = await getDocs(getCollectionRef('students'));
            let foundStudent = null;
            studentsSnapshot.forEach(doc => {
                const studentData = doc.data();
                if (studentData.admissionNumber && studentData.admissionNumber.toUpperCase().endsWith(admnNoSuffix)) {
                    foundStudent = { id: doc.id, ...studentData };
                }
            });

            if (foundStudent) {
                const studentDobYear = (foundStudent.dob || '').split('-')[0];
                if (dobYear === studentDobYear) {
                    onLoginSuccess('student', foundStudent);
                } else {
                    showAlert('Incorrect year of birth.', 'danger');
                }
            } else {
                showAlert('Student admission number not found.', 'danger');
            }
        }
    } finally {
        // This block runs whether the login succeeds or fails,
        // ensuring the button is always restored to its original state.
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonHtml;
    }
});



        document.getElementById('logout-btn').addEventListener('click', () => {
    // Unsubscribe from all active Firestore listeners
    unsubscribeAllListeners(); // <<< ADD THIS LINE

    currentUserRole = null; 
    selectedUser = null;
    if(attendanceChart) { 
        attendanceChart.destroy(); 
        attendanceChart = null; 
    }
    document.getElementById('main-app').classList.remove('active');
    document.getElementById('login-screen').classList.add('active');
});

        // --- DASHBOARD ---
        window.renderDashboard = async () => {
            if (attendanceChart) {
                attendanceChart.destroy();
                attendanceChart = null;
            }
            let content = '';
            if (currentUserRole === 'admin') {
                content = `<h1 class="h2 mb-4">Admin Dashboard</h1>
                <div class="row">
                    <div class="col-xl-3 col-md-6 mb-4"><div class="card border-start-primary shadow h-100 py-2"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-primary text-uppercase mb-1">Students</div><div class="h5 mb-0 fw-bold text-gray-800">${students.length}</div></div><div class="col-auto"><i class="fas fa-users fa-2x text-body-tertiary"></i></div></div></div></div></div>
                    <div class="col-xl-3 col-md-6 mb-4"><div class="card border-start-success shadow h-100 py-2"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-success text-uppercase mb-1">Teachers</div><div class="h5 mb-0 fw-bold text-gray-800">${teachers.length}</div></div><div class="col-auto"><i class="fas fa-chalkboard-teacher fa-2x text-body-tertiary"></i></div></div></div></div></div>
                    <div class="col-xl-3 col-md-6 mb-4"><div class="card border-start-info shadow h-100 py-2"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-info text-uppercase mb-1">Classes</div><div class="h5 mb-0 fw-bold text-gray-800">${classes.length}</div></div><div class="col-auto"><i class="fas fa-school fa-2x text-body-tertiary"></i></div></div></div></div></div>
                    <div class="col-xl-3 col-md-6 mb-4"><div class="card border-start-warning shadow h-100 py-2"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-warning text-uppercase mb-1">Subjects</div><div class="h5 mb-0 fw-bold text-gray-800">${subjects.length}</div></div><div class="col-auto"><i class="fas fa-book fa-2x text-body-tertiary"></i></div></div></div></div></div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header fw-bold text-primary">This Month's School-wide Absentees</div>
                            <div class="card-body">
                                <canvas id="admin-attendance-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>`;
                mainContent.innerHTML = content;
                updateAllNotifications();
                renderAdminAttendanceChart();
            } else if (currentUserRole === 'teacher') {
                const chargeText = selectedUser.classCharge?.classId ? `${classes.find(c => c.id === selectedUser.classCharge.classId)?.name || ''} - ${selectedUser.classCharge.division}` : 'None';
                const subjectsTaught = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id)
                .map(cs => subjects.find(s => s.id === cs.subjectId)?.name).join(', ');


                content = `<h1 class="h2 mb-4">Welcome, ${selectedUser.name}!</h1>
<div class="row">
    <div class="col-lg-7">
        <div class="card shadow mb-4">
             <div class="card-header fw-bold text-primary">This Month's Class Absentee Trend</div>
             <div class="card-body"><canvas id="teacher-attendance-chart"></canvas></div>
        </div>
    </div>
    <div class="col-lg-5">
         <div class="card shadow mb-4">
             <div class="card-header fw-bold text-danger">Today's Absentees</div>
             <div class="card-body" id="today-absent-list"></div>
         </div>
         <div class="card shadow mb-4">
             <div class="card-header fw-bold text-primary">My Responsibilities</div>
             <div class="card-body">
                 <p><strong>Class Charge:</strong> ${chargeText}</p>
                 <p><strong>Subjects Taught:</strong> ${subjectsTaught || 'None'}</p>
             </div>
         </div>
    </div>
</div>`;
mainContent.innerHTML = content;

                renderTeacherDashboardData();
            } else if (currentUserRole === 'student') {
                const className = classes.find(c => c.id === selectedUser.classId) ? `${classes.find(c => c.id === selectedUser.classId).name} - ${selectedUser.division}` : 'N/A';
                 const setup = studentFeeSetups.find(sfs => sfs.id === selectedUser.id);
const payments = receipts.filter(r => r.studentId === selectedUser.id && !r.isCancelled);
let totalPaid = payments.reduce((sum, p) => sum + p.totalAmount, 0);
const balance = setup ? (setup.totalPayable - totalPaid) : 0;

content = `<h1 class="h2 mb-4">Welcome, ${selectedUser.name}!</h1>
 <div class="row">
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">My Details</h6></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6"><p><strong>Admission No:</strong> ${selectedUser.admissionNumber}</p><p><strong>Class:</strong> ${className}</p></div>
                    <div class="col-md-6"><p><strong>Date of Birth:</strong> ${new Date(selectedUser.dob).toLocaleDateString()}</p><p><strong>Father's Name:</strong> ${selectedUser.fatherName || 'N/A'}</p></div>
                </div>
            </div>
        </div>
        <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">Fee Summary</h6></div>
            <div class="card-body">
                <p><strong>Total Payable:</strong> ₹ ${setup?.totalPayable.toFixed(2) || '0.00'}</p>
                <p><strong>Total Paid:</strong> ₹ ${totalPaid.toFixed(2)}</p>
                <p class="fw-bold"><strong>Balance Due:</strong> ₹ ${balance.toFixed(2)}</p>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
         <div class="card shadow mb-4">
             <div class="card-header fw-bold text-primary">This Month's Attendance</div>
             <div class="card-body" id="student-dashboard-calendar"></div>
        </div>
    </div>
 </div>`;
mainContent.innerHTML = content;

                 const today = new Date();
                 const monthYear = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
                 generateStudentCalendar(selectedUser.id, monthYear, 'student-dashboard-calendar', true);
                 updateAllNotifications();
            }
        };
// --- SCHOOL DETAILS MODULE ---

/**
 * Renders the form for managing the school's core details.
 * This is the entry point for the "School Details" navigation item.
 */
window.renderSchoolDetailsModule = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }

    // Use the globally available 'schoolDetails' object to pre-fill the form
    const details = schoolDetails || {};

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">School Profile & Settings</h1>
        <div class="card shadow">
            <div class="card-header fw-bold text-primary">
                Manage School Information
            </div>
            <div class="card-body">
                <form id="school-details-form">
                    <div class="row">
                        <!-- Left Column: Form Fields -->
                        <div class="col-lg-8">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label for="school-name" class="form-label">School Name</label>
                                    <input type="text" id="school-name" class="form-control" value="${details.name || ''}" required>
                                </div>
                                <div class="col-md-12">
                                    <label for="school-address" class="form-label">Full Address</label>
                                    <textarea id="school-address" class="form-control" rows="3">${details.address || ''}</textarea>
                                </div>
                                <div class="col-md-6">
                                    <label for="school-phone" class="form-label">Phone Number</label>
                                    <input type="tel" id="school-phone" class="form-control" value="${details.phone || ''}">
                                </div>
                                <div class="col-md-6">
                                    <label for="school-email" class="form-label">Email Address</label>
                                    <input type="email" id="school-email" class="form-control" value="${details.email || ''}">
                                </div>
                                <div class="col-md-6">
                                    <label for="school-website" class="form-label">Website</label>
                                    <input type="url" id="school-website" class="form-control" value="${details.website || ''}">
                                </div>
                                <div class="col-md-6">
                                    <label for="school-affiliation" class="form-label">Affiliation No.</label>
                                    <input type="text" id="school-affiliation" class="form-control" value="${details.affiliation || ''}">
                                </div>
                            </div>
                        </div>
                        <!-- Right Column: Logo Upload -->
                        <div class="col-lg-4">
                            <label class="form-label">School Logo</label>
                            <div class="text-center border rounded p-3">
                                <img id="logo-preview" src="${details.logoUrl || 'https://placehold.co/200x200/e9ecef/6c757d?text=No+Logo'}" alt="School Logo Preview" class="img-thumbnail mb-3" style="max-height: 200px;">
                                <input type="file" id="logo-upload-input" class="form-control" accept="image/png, image/jpeg">
                            </div>
                        </div>
                    </div>
                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-save me-2"></i>Save School Details
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;

    attachSchoolDetailsListeners();
};

/**
 * Attaches event listeners for the school details form.
 */
function attachSchoolDetailsListeners() {
    const form = document.getElementById('school-details-form');
    const logoInput = document.getElementById('logo-upload-input');
    const logoPreview = document.getElementById('logo-preview');
    let logoFile = null; // To hold the new logo file if one is chosen

    // Listener for logo file selection to update the preview
    logoInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
            logoFile = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                logoPreview.src = event.target.result;
            };
            reader.readAsDataURL(logoFile);
        }
    });

    // Listener for form submission
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const saveButton = form.querySelector('button[type="submit"]');
        const originalButtonHtml = saveButton.innerHTML;
        saveButton.disabled = true;
        saveButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...`;

        // We use a fixed document ID 'main-details' for the single school profile
        const docId = 'main-details';
        const detailsToSave = {
            id: docId,
            name: document.getElementById('school-name').value,
            address: document.getElementById('school-address').value,
            phone: document.getElementById('school-phone').value,
            email: document.getElementById('school-email').value,
            website: document.getElementById('school-website').value,
            affiliation: document.getElementById('school-affiliation').value,
            logoUrl: schoolDetails.logoUrl || '' // Start with the existing URL
        };

        try {
            // If a new logo was selected, upload it first
            if (logoFile) {
                showAlert('Uploading new logo...', 'info');
                // We can reuse the Drive upload function, giving it a generic name
                const uploadResult = await uploadPhotoToDrive(logoFile, 'school_logo');
                if (uploadResult && uploadResult.success) {
                    detailsToSave.logoUrl = uploadResult.fileUrl; // Update with the new URL
                    showAlert('Logo uploaded successfully!', 'success');
                } else {
                    throw new Error('Logo upload to Drive failed.');
                }
            }

            // Save all details to Firestore
            await setDoc(getDocRef('schoolDetails', docId), detailsToSave);
            showAlert('School details saved successfully!', 'success');

        } catch (error) {
            console.error('Error saving school details:', error);
            showAlert('Failed to save school details. Please try again.', 'danger');
        } finally {
            saveButton.disabled = false;
            saveButton.innerHTML = originalButtonHtml;
        }
    });
}

        async function renderAdminAttendanceChart() {
            const ctx = document.getElementById('admin-attendance-chart').getContext('2d');
            const today = new Date();
            const monthYear = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
            const data = Array(daysInMonth).fill(0);
            
            const monthDataDoc = await getDoc(getDocRef('attendance', monthYear));
            const monthData = monthDataDoc.data() || {};

            for(const day in monthData){
                const dayIndex = parseInt(day) - 1;
                if(dayIndex >= 0 && dayIndex < daysInMonth){
                    const dayRecords = monthData[day];
                    let absentees = 0;
                    for(const studentId in dayRecords){
                        const record = dayRecords[studentId];
                        if(!record.FN || !record.AN) {
                            absentees++;
                        }
                    }
                    data[dayIndex] = absentees;
                }
            }

            attendanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Absentees',
                        data: data,
                        backgroundColor: 'rgba(220, 53, 69, 0.7)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1
                    }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        async function renderTeacherDashboardData() {
            const charge = selectedUser.classCharge;
            if(!charge) return;
            // Absentees List
            const todayStr = new Date().toISOString().slice(0, 10);
            const holiday = holidays.find(h => h.id === todayStr);
            const listContainer = document.getElementById('today-absent-list');

            if(holiday){
                listContainer.innerHTML = `<p class="text-info">Today is a holiday: ${holiday.narration}</p>`;
            } else {
                const today = new Date();
                const monthYear = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
                const dayStr = today.getDate().toString();
                const monthDataDoc = await getDoc(getDocRef('attendance', monthYear));
                const dayRecord = monthDataDoc.data()?.[dayStr] || {};

                const classStudents = students.filter(s => s.classId === charge.classId && s.division === charge.division);
                const absentees = classStudents.filter(s => !dayRecord[s.id] || !dayRecord[s.id].FN || !dayRecord[s.id].AN);
                
                if(absentees.length > 0) {
                    listContainer.innerHTML = `<ul class="list-group list-group-flush">${absentees.map(s => `<li class="list-group-item">${s.name}</li>`).join('')}</ul>`;
                } else {
                    listContainer.innerHTML = `<p class="text-success">No absentees reported today.</p>`;
                }
            }

            // Chart
            const ctx = document.getElementById('teacher-attendance-chart').getContext('2d');
            const today = new Date();
            const monthYear = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
            const data = Array(daysInMonth).fill(0);
            
            const monthDataDoc = await getDoc(getDocRef('attendance', monthYear));
            const monthData = monthDataDoc.data() || {};
            const classStudents = students.filter(s => s.classId === charge.classId && s.division === charge.division);

            for(const day in monthData){
                const dayIndex = parseInt(day) - 1;
                if(dayIndex >= 0 && dayIndex < daysInMonth){
                    const dayRecords = monthData[day];
                    let absentees = 0;
                    classStudents.forEach(student => {
                        const record = dayRecords[student.id];
                        if(!record || !record.FN || !record.AN){
                            absentees++;
                        }
                    });
                    data[dayIndex] = absentees;
                }
            }
             attendanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{ label: 'Absentees', data, backgroundColor: 'rgba(255, 159, 64, 0.7)' }]
                },
                options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
            updateAllNotifications();
        }
        
        // --- CLASS MANAGEMENT ---
        window.renderClassManagement = () => {
            const isEditMode = classToEdit !== null;
            mainContent.innerHTML = `<h1 class="h2 mb-4">Class Management</h1><div class="row"><div class="col-lg-4"><div class="card shadow mb-4"><div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">${isEditMode ? "Edit Class" : "Add New Class"}</h6></div><div class="card-body"><form id="class-form"><div class="mb-3"><label class="form-label">Academic Year</label><input id="academic-year" required class="form-control" ${isEditMode ? 'readonly' : ''}></div><div class="mb-3"><label class="form-label">Class Name</label><input id="class-name" placeholder="E.G., CLASS X" required class="form-control" ${isEditMode ? 'readonly' : ''}></div><div class="mb-3"><label class="form-label">Divisions (comma-separated)</label><input id="class-divisions" placeholder="A,B,C" required class="form-control"></div><div class="d-flex justify-content-end gap-2"><button type="button" id="cancel-edit-btn" class="btn btn-secondary ${!isEditMode ? 'd-none' : ''}">Cancel</button><button type="submit" class="btn btn-primary">${isEditMode ? "Update Class" : "Add Class"}</button></div></form></div></div></div><div class="col-lg-8"><div class="card shadow mb-4"><div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">Existing Classes</h6></div><div class="card-body" id="classes-list-container"></div></div></div></div>`;
            renderClassesList();
            const form = document.getElementById('class-form'), yearInput = document.getElementById('academic-year'), nameInput = document.getElementById('class-name'), divInput = document.getElementById('class-divisions');
            if (isEditMode) { yearInput.value = classToEdit.year; nameInput.value = classToEdit.name; divInput.value = (classToEdit.divisions || []).join(', '); } 
            else { yearInput.value = `${new Date().getFullYear()}-${new Date().getFullYear() + 1}`; }
            document.getElementById('cancel-edit-btn').addEventListener('click', () => { classToEdit = null; renderClassManagement(); });
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = e.target.querySelector('button[type="submit"]');
    if (!submitButton) return; // Exit if the button isn't found

    // Store the button's original content and disable it
    const originalButtonHtml = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Signing In...`;

                const docId = isEditMode ? classToEdit.id : `${yearInput.value}_${nameInput.value.toUpperCase().replace(/\s+/g, '_')}`;
                const data = { id: docId, year: yearInput.value, name: nameInput.value.toUpperCase(), divisions: divInput.value.split(',').map(d => d.trim().toUpperCase()).filter(Boolean) };
                await setDoc(getDocRef('classes', docId), data);
                showAlert(`Class '${data.name}' ${isEditMode ? 'updated' : 'saved'}.`, 'success');
                classToEdit = null; renderClassManagement();
                submitButton.disabled=flase;
                submitbutton.innerHTML=orginalButtonHtml;
            });
        };
        function renderClassesList() {
            const container = document.getElementById('classes-list-container'); if (!container) return;
            if (!classes || classes.length === 0) { container.innerHTML = `<p class="text-muted">No classes have been added.</p>`; return; }
            container.innerHTML = `<div class="list-group list-group-flush">${classes.sort((a,b)=>a.name.localeCompare(b.name)).map(cls => `<div class="list-group-item d-flex justify-content-between align-items-center"><div><h6 class="mb-0">${cls.name} <small class="text-muted">(${cls.year})</small></h6><div>${(cls.divisions || []).map(d => `<span class="badge bg-secondary me-1">${d}</span>`).join('')}</div></div><div><button onclick="window.handleEditClass('${cls.id}')" class="btn btn-sm btn-outline-primary me-2" title="Edit"><i class="fas fa-edit"></i></button><button onclick="window.handleDelete('classes', '${cls.id}')" class="btn btn-sm btn-outline-danger" title="Delete"><i class="fas fa-trash-alt"></i></button></div></div>`).join('')}</div>`;
        }
        window.handleEditClass = (id) => { classToEdit = classes.find(c => c.id === id); if(classToEdit) renderClassManagement(); };
        window.handleDelete = async (coll, id) => { if (confirm("Are you sure? This cannot be undone.")) { await deleteDoc(getDocRef(coll, id)); showAlert('Item deleted.', 'success'); }};

        // --- TEACHER MANAGEMENT ---
        window.renderTeacherManagement = () => {
    const isEditMode = teacherToEdit !== null;
    mainContent.innerHTML = `<h1 class="h2 mb-4">Teacher Management</h1><div class="row"><div class="col-lg-4"><div class="card shadow mb-4"><div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">${isEditMode ? "Edit Teacher" : "Add Teacher"}</h6></div><div class="card-body"><form id="teacher-form">
        <div class="mb-3"><label class="form-label">Teacher ID</label><input type="text" id="teacher-id" class="form-control" ${isEditMode ? 'readonly' : ''}></div>
        <div class="mb-3"><label class="form-label">Full Name</label><input type="text" id="teacher-name" class="form-control" required></div>
        <div class="mb-3"><label class="form-label">Mobile</label><input type="tel" id="teacher-mobile" class="form-control" required></div>
        <div class="mb-3">
            <label class="form-label">Roles</label>
            <input type="text" id="teacher-roles" class="form-control" placeholder="e.g., librarian, hod, admin">
            <small class="form-text text-muted">Separate multiple roles with a comma.</small>
        </div>
        <div class="mb-3"><label class="form-label">Email</label><input type="email" id="teacher-email" class="form-control" style="text-transform: lowercase;"></div>
        <div class="row mb-3"><div class="col"><label class="form-label">Class Charge</label><select id="teacher-class-charge" class="form-select"><option value="">NONE</option>${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div><div class="col"><label class="form-label">Division</label><select id="teacher-division-charge" class="form-select" disabled></select></div></div>
        <div class="d-flex justify-content-end gap-2"><button type="button" id="cancel-edit-btn" class="btn btn-secondary ${!isEditMode ? 'd-none' : ''}">Cancel</button><button type="submit" class="btn btn-primary">${isEditMode ? "Update" : "Add"}</button></div>
        </form></div></div></div><div class="col-lg-8"><div class="card shadow mb-4"><div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">Existing Teachers</h6></div><div class="card-body" id="teachers-list-container"></div></div></div></div>`;
    
    renderTeachersList();
    attachTeacherFormListeners();
};

        function renderTeachersList() {
    const container = document.getElementById('teachers-list-container'); 
    if (!container) return;
    if (!teachers || teachers.length === 0) { 
        container.innerHTML = `<p class="text-muted">No teachers added.</p>`; 
        return; 
    }
    
    const sortedTeachers = [...teachers].sort((a, b) => (a.name || "").localeCompare(b.name || ""));
    let listHTML = '<div class="list-group list-group-flush">';

    sortedTeachers.forEach(teacher => {
        let chargeText = 'None';
        if (teacher.classCharge?.classId) {
            const chargedClass = classes.find(c => c.id === teacher.classCharge.classId);
            chargeText = chargedClass ? `${chargedClass.name} - ${teacher.classCharge.division}` : 'N/A';
        }

        const rolesBadges = Array.isArray(teacher.roles) 
            ? teacher.roles.map(role => `<span class="badge bg-secondary me-1">${role}</span>`).join('')
            : `<span class="badge bg-light text-dark">${teacher.role || 'N/A'}</span>`;

        listHTML += `<div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${teacher.name}</h6>
                            <div class="mb-1">${rolesBadges}</div>
                            <small class="text-muted">${teacher.id} | Class Charge: <strong>${chargeText}</strong></small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" title="Edit" onclick="window.handleEditTeacher('${teacher.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger" title="Delete" onclick="window.handleDelete('teachers', '${teacher.id}')"><i class="fas fa-trash-alt"></i></button>
                        </div>
                     </div>`;
    });

    listHTML += '</div>';
    container.innerHTML = listHTML;
}

        function attachTeacherFormListeners() {
    const isEditMode = teacherToEdit !== null;
    const form = document.getElementById('teacher-form'), 
          idInput = document.getElementById('teacher-id'), 
          nameInput = document.getElementById('teacher-name'), 
          mobileInput = document.getElementById('teacher-mobile'), 
          emailInput = document.getElementById('teacher-email'), 
          rolesInput = document.getElementById('teacher-roles'), // Changed back to a single input
          classDropdown = document.getElementById('teacher-class-charge'), 
          divisionDropdown = document.getElementById('teacher-division-charge'), 
          cancelBtn = document.getElementById('cancel-edit-btn');
          
    const updateDivisionDropdown = (selectedClassId) => {
        const selectedClass = classes.find(c => c.id === selectedClassId);
        divisionDropdown.innerHTML = '<option value="">--</option>';
        divisionDropdown.disabled = true;
        if (selectedClass) {
            divisionDropdown.innerHTML += selectedClass.divisions.map(div => `<option value="${div}">${div}</option>`).join('');
            divisionDropdown.disabled = false;
        }
    };

    if (isEditMode) {
        idInput.value = teacherToEdit.id;
        nameInput.value = teacherToEdit.name;
        mobileInput.value = teacherToEdit.mobile;
        emailInput.value = teacherToEdit.email;

        // --- NEW: Join roles array into a comma-separated string for editing ---
        if (teacherToEdit.roles && Array.isArray(teacherToEdit.roles)) {
            rolesInput.value = teacherToEdit.roles.join(', ');
        }
        
        if (teacherToEdit.classCharge?.classId) {
            classDropdown.value = teacherToEdit.classCharge.classId;
            updateDivisionDropdown(teacherToEdit.classCharge.classId);
            divisionDropdown.value = teacherToEdit.classCharge.division;
        }
    } else {
        const latestIdNum = teachers.reduce((max, t) => {
            const num = parseInt((t.id || "").split('-')[1] || 0);
            return num > max ? num : max;
        }, 1000);
        idInput.value = `EMP-${latestIdNum + 1}`;
    }

    classDropdown.addEventListener('change', () => updateDivisionDropdown(classDropdown.value));
    cancelBtn.addEventListener('click', () => { teacherToEdit = null; renderTeacherManagement(); });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // --- NEW: Convert comma-separated string into a clean array ---
        const rolesArray = rolesInput.value.split(',')       // Split the string by commas
                                       .map(role => role.trim())   // Trim whitespace from each role
                                       .filter(Boolean);            // Remove any empty strings

        const teacherData = {
            id: idInput.value,
            name: nameInput.value,
            mobile: mobileInput.value,
            email: emailInput.value.toLowerCase(),
            roles: rolesArray, // Save the clean array
            classCharge: classDropdown.value ? { classId: classDropdown.value, division: divisionDropdown.value } : null,
        };

        // --- Audit fields logic remains the same ---
        if (isEditMode) {
            teacherData.lastUpdatedBy = selectedUser.id;
            teacherData.lastUpdatedAt = serverTimestamp();
        } else {
            teacherData.createdBy = selectedUser.id;
            teacherData.createdAt = serverTimestamp();
        }

        await setDoc(getDocRef('teachers', teacherData.id), teacherData, { merge: true });
        showAlert(`Teacher '${teacherData.name}' has been ${isEditMode ? 'updated' : 'added'}.`, 'success');
        teacherToEdit = null;
        renderTeacherManagement();
    });
}
        window.handleEditTeacher = (teacherId) => { teacherToEdit = teachers.find(t => t.id === teacherId); if (teacherToEdit) renderTeacherManagement(); };

        // --- SUBJECT MANAGEMENT ---
        window.renderSubjectManagement = () => {
    const isEditMode = subjectToEdit !== null;
    const currentSubject = subjectToEdit || {}; // Use currentSubject for pre-filling

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Subject Management</h1>
        <div class="row">
            <div class="col-lg-4">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-primary">${isEditMode ? "Edit Subject" : "Add New Subject"}</h6>
                    </div>
                    <div class="card-body">
                        <form id="add-subject-form">
                            <div class="mb-3">
                                <label class="form-label">Sector</label>
                                <select id="subject-sector" required class="form-select" ${isEditMode ? 'disabled' : ''}>
                                    <option value="">-- Select Sector --</option>
                                    <option value="SCHOOL" ${currentSubject.sector === 'SCHOOL' ? 'selected' : ''}>SCHOOL</option>
                                    <option value="MADRASSA" ${currentSubject.sector === 'MADRASSA' ? 'selected' : ''}>MADRASSA</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Subject ID</label>
                                <input id="subject-id" type="text" required class="form-control bg-light" value="${currentSubject.id || ''}" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Subject Name</label>
                                <input id="subject-name" type="text" required class="form-control" style="text-transform: uppercase;" value="${currentSubject.name || ''}">
                            </div>
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" id="cancel-edit-btn" class="btn btn-secondary ${!isEditMode ? 'd-none' : ''}">Cancel</button>
                                <button type="submit" class="btn btn-primary">${isEditMode ? "Update Subject" : "Add Subject"}</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-primary">Existing Subjects</h6>
                    </div>
                    <div class="card-body" id="subjects-list-container">
                        </div>
                </div>
            </div>
        </div>`;

    // Get DOM elements after they are rendered
    const subjectIdInput = document.getElementById('subject-id');
    const subjectNameInput = document.getElementById('subject-name');
    const subjectSectorSelect = document.getElementById('subject-sector');
    const addSubjectForm = document.getElementById('add-subject-form');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');

    // Function to generate the next Subject ID (only for Add mode)
    const generateSubjectId = () => {
        if (isEditMode) return; // Don't generate ID in edit mode

        let latestIdNum = 0;
        subjects.forEach(subject => {
            if (subject.id && subject.id.startsWith('SUB_')) {
                const numPart = parseInt(subject.id.split('_')[1], 10);
                if (!isNaN(numPart) && numPart > latestIdNum) {
                    latestIdNum = numPart;
                }
            }
        });
        subjectIdInput.value = `SUB_${(latestIdNum + 1).toString().padStart(3, '0')}`;
    };

    // Initial generation of Subject ID on load (if not in edit mode)
    if (!isEditMode) {
        generateSubjectId();
    }

    // Cancel Edit button listener
    cancelEditBtn.addEventListener('click', () => {
        subjectToEdit = null; // Clear edit state
        renderSubjectManagement(); // Re-render to show Add Subject form
    });

    // Event listener for form submission
    addSubjectForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const id = subjectIdInput.value.toUpperCase().trim();
        const name = subjectNameInput.value.toUpperCase().trim();
        const sector = subjectSectorSelect.value; // Get sector for new subjects

        // If in edit mode, the sector might be disabled, so retrieve from subjectToEdit
        const finalSector = isEditMode ? subjectToEdit.sector : sector;

        if (!finalSector) {
            showAlert('Please select a Sector.', 'danger');
            return;
        }
        if (!id || !name) {
            showAlert('Subject ID and Name are required.', 'danger');
            return;
        }

        // Check for uniqueness when adding a NEW subject
        if (!isEditMode) {
            const existingSubject = subjects.find(s => s.id === id);
            if (existingSubject) {
                showAlert('Subject ID already exists. Please re-generate or check existing list.', 'warning');
                generateSubjectId(); // Attempt to generate a new unique ID
                return;
            }
        }

        try {
            // Data to save/update
            const subjectData = {
                id: id,
                name: name,
                subjectId: id, // Keep subjectId field for consistency if needed elsewhere
                sector: finalSector // Use finalSector
            };

            await setDoc(getDocRef('subjects', id), subjectData);
            showAlert(`Subject '${subjectData.name}' ${isEditMode ? 'updated' : 'added'}.`, 'success');
            
            subjectToEdit = null; // Clear edit state after successful save/update
            renderSubjectManagement(); // Re-render to show updated list and clear form (or switch to add mode)

        } catch (error) {
            console.error("Error saving subject:", error);
            showAlert('Failed to save subject. Please try again.', 'danger');
        }
    });

    // Initial render of existing subjects list
    renderSubjectsList();
};

// --- renderSubjectsList function (Updated to include Edit button) ---
function renderSubjectsList() {
    const container = document.getElementById('subjects-list-container');
    if (!container) return;

    if (!subjects || subjects.length === 0) {
        container.innerHTML = '<p class="text-muted">No subjects added.</p>';
        return;
    }

    const sortedSubjects = [...subjects].sort((a, b) => (a.name || "").localeCompare(b.name || ""));

    container.innerHTML = `
        <table class="table table-hover table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Sector</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                ${sortedSubjects.map(s => `
                    <tr>
                        <td>${s.subjectId || 'N/A'}</td>
                        <td>${s.name || 'N/A'}</td>
                        <td>${s.sector || 'N/A'}</td>
                        <td class="text-end">
                            <button onclick="window.handleEditSubject('${s.id}')" class="btn btn-sm btn-outline-primary me-2" title="Edit Subject">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="window.handleDelete('subjects', '${s.id}')" class="btn btn-sm btn-outline-danger" title="Delete Subject">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>`).join('')}
            </tbody>
        </table>`;
}

// --- New Global Function for Editing Subject ---
window.handleEditSubject = (id) => {
    subjectToEdit = subjects.find(s => s.id === id);
    if (subjectToEdit) {
        renderSubjectManagement(); // Re-render the form with pre-filled data
    } else {
        showAlert('Subject not found for editing.', 'danger');
        console.warn('Subject not found for editing:', id);
    }
};

        // --- SUBJECT ALLOCATION ---
        window.renderSubjectAllocation = () => {
    const isEditMode = allocationToEdit !== null;
    const currentAllocation = allocationToEdit || {};

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Subject Allocation</h1>
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="row border-bottom pb-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Select Class</label>
                        <select id="alloc-class" class="form-select" ${isEditMode ? 'disabled' : ''}>
                            <option value="">-- Select Class --</option>
                            ${classes.map(c => `<option value="${c.id}" ${currentAllocation.classId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Select Division</label>
                        <select id="alloc-division" class="form-select" ${isEditMode ? 'disabled' : ''}></select>
                    </div>
                    ${!isEditMode ? `
                    <div class="col-md-4 d-flex align-items-end">
                        <button id="show-allocation-view-btn" class="btn btn-primary w-100">Load Allocation Form</button>
                    </div>` : ''}
                </div>
                
                <div id="allocation-view" class="${isEditMode ? '' : 'd-none'} row">
                    <div class="col-lg-4">
                        <h5 class="mb-3">${isEditMode ? 'Edit Allocation' : 'Allocate Subject'}</h5>
                        <form id="add-alloc-form">
                            <div class="mb-3">
                                <label class="form-label">Subject</label>
                                <select id="alloc-subject" class="form-select" ${isEditMode ? 'disabled' : ''}>
                                    <option value="">-- Select Subject --</option>
                                    ${subjects.map(s => `<option value="${s.id}" ${currentAllocation.subjectId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Teacher</label>
                                <select id="alloc-teacher" class="form-select">
                                    <option value="">-- Select Teacher --</option>
                                    ${teachers.map(t => `<option value="${t.id}" ${currentAllocation.teacherId === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Weekly Hours</label>
                                <input type="number" id="alloc-weekly-hour" class="form-control" placeholder="e.g., 5" value="${currentAllocation.weeklyHour || ''}">
                            </div>
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" id="cancel-edit-btn" class="btn btn-secondary ${!isEditMode ? 'd-none' : ''}">Cancel</button>
                                <button type="submit" class="btn btn-primary">${isEditMode ? "Update Allocation" : "Allocate"}</button>
                            </div>
                        </form>
                    </div>
                    <div class="col-lg-8" id="alloc-list-container">
                        </div>
                </div>
            </div>
        </div>`;

    const classSelect = document.getElementById('alloc-class');
    const divisionSelect = document.getElementById('alloc-division');
    const showAllocationViewBtn = document.getElementById('show-allocation-view-btn'); // New button
    const allocView = document.getElementById('allocation-view');
    const addAllocForm = document.getElementById('add-alloc-form');
    const allocSubjectSelect = document.getElementById('alloc-subject');
    const allocTeacherSelect = document.getElementById('alloc-teacher');
    const allocWeeklyHourInput = document.getElementById('alloc-weekly-hour');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');


    // Function to update division dropdown based on selected class
    const updateDivisionDropdown = () => {
        const cls = classes.find(c => c.id === classSelect.value);
        divisionSelect.innerHTML = '<option value="">-- Select Division --</option>';
        divisionSelect.disabled = !cls || isEditMode; // Disable if no class selected or in edit mode
        if (cls) {
            divisionSelect.innerHTML += cls.divisions.map(d => `<option value="${d}" ${currentAllocation.division === d ? 'selected' : ''}>${d}</option>`).join('');
        }
        // If in edit mode, ensure the correct division is selected if it wasn't pre-selected by currentAllocation.division
        if (isEditMode && currentAllocation.division) {
            divisionSelect.value = currentAllocation.division;
        }

        // Hide allocation view until a division is selected (if not in edit mode)
        if (!isEditMode) allocView.classList.add('d-none');
    };

    // Initial setup for division dropdown
    updateDivisionDropdown();
    // If in edit mode, immediately show the allocation view and render the list
    if (isEditMode) {
        renderAllocationList(currentAllocation.classId, currentAllocation.division);
    } else {
        // Only attach listener for show button if NOT in edit mode
        showAllocationViewBtn?.addEventListener('click', () => {
            const classId = classSelect.value;
            const division = divisionSelect.value;
            if (classId && division) {
                allocView.classList.remove('d-none');
                renderAllocationList(classId, division);
            } else {
                showAlert('Please select both a Class and a Division first.', 'warning');
            }
        });
    }


    // Event listeners for class/division selection (only if not in edit mode)
    if (!isEditMode) {
        classSelect.addEventListener('change', updateDivisionDropdown);
        divisionSelect.addEventListener('change', () => {
            // This is just a trigger to enable the "Load Allocation Form" button
            // Actual list rendering is done via that button's click or on form submit
            const classId = classSelect.value;
            const division = divisionSelect.value;
            if (classId && division) {
                // If a combination is selected, ensure the allocation form is shown
                // The list will be rendered when the "Load" button is clicked
            }
        });
    }

    // Cancel Edit button listener
    cancelEditBtn.addEventListener('click', () => {
        allocationToEdit = null; // Clear edit state
        renderSubjectAllocation(); // Re-render to show Add Allocation form
    });


    // Form submission listener
    addAllocForm.addEventListener('submit', async e => {
        e.preventDefault();

        const classId = classSelect.value;
        const division = divisionSelect.value;
        const subjectId = allocSubjectSelect.value;
        const teacherId = allocTeacherSelect.value;
        const weeklyHour = parseInt(allocWeeklyHourInput.value, 10) || 0; // Ensure it's a number

        if (!classId || !division || !subjectId || !teacherId || weeklyHour <= 0) {
            showAlert('All fields (Class, Division, Subject, Teacher, Weekly Hours > 0) are required.', 'danger');
            return;
        }

        let docId;
        // If editing, use the existing ID; otherwise, generate a new one
        if (isEditMode) {
            docId = allocationToEdit.id;
        } else {
            // Generate a unique ID for new allocation
            docId = `${classId}_${division}_${subjectId}_${teacherId}`;
            // Optional: Check for existing allocation to prevent duplicates when adding
            const existingAllocation = classroomSubjects.find(cs =>
                cs.classId === classId && cs.division === division &&
                cs.subjectId === subjectId && cs.teacherId === teacherId
            );
            if (existingAllocation) {
                showAlert('This specific subject-teacher allocation for this class/division already exists.', 'warning');
                return;
            }
        }

        const data = {
            id: docId,
            classId,
            division,
            subjectId,
            teacherId,
            weeklyHour // Include weeklyHour
        };

        try {
            await setDoc(getDocRef('classroomSubjects',docId), data); // Use setDoc for both add/update
            showAlert(`Allocation ${isEditMode ? 'updated' : 'saved'}.`, 'success');
            
            allocationToEdit = null; // Clear edit state
            renderSubjectAllocation(); // Re-render to show updated list and reset form
        } catch (error) {
            console.error("Error saving allocation:", error);
            showAlert("Failed to save allocation. Please try again.", "danger");
        }
    });renderFeeStructureTab
};

function renderAllocationList(classId, division) {
    const container = document.getElementById('alloc-list-container');
    if (!container) return;

    const filtered = classroomSubjects.filter(cs => cs.classId === classId && cs.division === division);
    const clsName = classes.find(c => c.id === classId)?.name;

    container.innerHTML = `<h5 class="mb-3">Allocated Subjects for ${clsName || 'N/A'} - ${division || 'N/A'}</h5>` + (filtered.length === 0 ? `<p class="text-muted">No subjects allocated for this class and division.</p>` : `
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Teacher</th>
                        <th>Weekly Hours</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${filtered.map(item => {
                        const subject = subjects.find(s => s.id === item.subjectId);
                        const teacher = teachers.find(t => t.id === item.teacherId);
                        return `
                            <tr>
                                <td>${subject?.name || 'N/A'}</td>
                                <td>${teacher?.name || 'N/A'}</td>
                                <td>${item.weeklyHour || 0}</td>
                                <td class="text-end">
                                    <button onclick="window.handleEditAllocation('${item.id}')" class="btn btn-sm btn-outline-primary me-2" title="Edit Allocation">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="window.handleDelete('classroomSubjects', '${item.id}')" class="btn btn-sm btn-outline-danger" title="Delete Allocation">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>`);
}

// --- New Global Function for Editing Allocation ---
window.handleEditAllocation = (id) => {
    allocationToEdit = classroomSubjects.find(alloc => alloc.id === id);
    if (allocationToEdit) {
        renderSubjectAllocation(); // Re-render the form with pre-filled data
    } else {
        showAlert('Allocation not found for editing.', 'danger');
        console.warn('Allocation not found for editing:', id);
    }
};
        // --- STUDENT MANAGEMENT & ADD STUDENT ---
        window.renderAddStudentForm = () => {
    const isEditMode = studentToEdit !== null;
    const currentStudent = studentToEdit || {};
    const formId = 'add-student-form';
    

    const formTitle = isEditMode ? 'Edit Student Details' : 'Add New Student';
    const buttonText = isEditMode ? 'Update Student' : 'Save Student';

    const mainContent = document.getElementById('main-content');
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">${formTitle}</h1>
        <div class="card shadow">
            <div class="card-body">
                <form id="add-student-form" class="needs-validation" novalidate>
                    <div class="border-bottom pb-3 mb-4">
                        <h5 class="text-primary">Personal Information</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="name" class="form-label">Full Name</label>
                                <input id="name" type="text" required class="form-control" value="${currentStudent.name || ''}">
                                <div class="invalid-feedback">Full name is required.</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="dob" class="form-label">Date of Birth</label>
                                <input id="dob" type="text" onkeyup="formatDate(this)" placeholder="DD/MM/YYYY" required class="form-control" value="${currentStudent.dob || ''}">
                                <span id="dob-words" class="text-muted small mt-1"></span>
                                <div class="invalid-feedback">Date of Birth is required.</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="gender" class="form-label">Gender</label>
                                <select id="gender" class="form-select">
                                    <option value="M" ${currentStudent.gender === 'M' ? 'selected' : ''}>MALE</option>
                                    <option value="F" ${currentStudent.gender === 'F' ? 'selected' : ''}>FEMALE</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="aadhaar" class="form-label">Aadhaar Number</label>
                                <input id="aadhaar" type="text" maxlength="14" onkeyup="formatAadhaar(this)" class="form-control" value="${currentStudent.aadhaar || ''}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="nationality" class="form-label">Nationality</label>
                                <select id="nationality" class="form-select">
                                    <option value="Indian" ${currentStudent.nationality === 'Indian' || !currentStudent.nationality ? 'selected' : ''}>Indian</option>
                                    <option value="Other" ${currentStudent.nationality === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="birthPlace" class="form-label">Birth Place</label>
                                <input id="birthPlace" type="text" class="form-control" value="${currentStudent.birthPlace || ''}">
                            </div>
                        </div>
                    </div>

                    <div class="border-bottom pb-3 mb-4">
                        <h5 class="text-primary">Admission & Academic Details</h5>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="admissionSector" class="form-label">Admission Sector</label>
                                <select id="admissionSector" class="form-select" ${isEditMode ? 'disabled' : ''}>
                                    <option value="KG" ${currentStudent.admissionSector === 'KG' ? 'selected' : ''}>KG</option>
                                    <option value="HS" ${currentStudent.admissionSector === 'HS' ? 'selected' : ''}>HIGH SCHOOL (HS)</option>
                                    <option value="HSS" ${currentStudent.admissionSector === 'HSS' ? 'selected' : ''}>HIGHER SECONDARY (HSS)</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="admissionId" class="form-label">Admission iD</label>
                                <input id="admissionId" type="text" readonly class="form-control bg-light" value="${currentStudent.id || ''}"> 
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="admissionNumber" class="form-label">Admission Number</label>
                                <input id="admissionNumber" type="text" readonly class="form-control bg-light" value="${currentStudent.admissionNumber || ''}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="admissionDate" class="form-label">Admission Date</label>
                                <input id="admissionDate" type="text" onkeyup="formatDate(this)" placeholder="DD/MM/YYYY" required class="form-control" value="${currentStudent.admissionDate || ''}">
                                <div class="invalid-feedback">Admission Date is required.</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="instructionMedium" class="form-label">Instruction Medium</label>
                                <select id="instructionMedium" class="form-select">
                                    <option value="">-- Select --</option>
                                    <option value="English" ${currentStudent.instructionMedium === 'English' ? 'selected' : ''}>English</option>
                                    <option value="Malayalam" ${currentStudent.instructionMedium === 'Malayalam' ? 'selected' : ''}>Malayalam</option>
                                    <option value="Hindi" ${currentStudent.instructionMedium === 'Hindi' ? 'selected' : ''}>Hindi</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="classId" class="form-label">Class</label>
                                <select id="classId" required class="form-select">
                                    <option value="">-- Select Class --</option>
                                    ${classes.map(c => `<option value="${c.id}" ${currentStudent.classId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                </select>
                                <div class="invalid-feedback">Class is required.</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="division" class="form-label">Division</label>
                                <select id="division" required class="form-select"></select>
                                <div class="invalid-feedback">Division is required.</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="aplBpl" class="form-label">APL/BPL</label>
                                <select id="aplBpl" class="form-select">
                                    <option value="">-- Select --</option>
                                    <option value="APL" ${currentStudent.aplBpl === 'APL' ? 'selected' : ''}>APL</option>
                                    <option value="BPL" ${currentStudent.aplBpl === 'BPL' ? 'selected' : ''}>BPL</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="busPoint" class="form-label">Bus Point</label>
                                <input id="busPoint" type="text" class="form-control" value="${currentStudent.busPoint || ''}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="vehicleStage" class="form-label">Vehicle Stage</label>
                                <input id="vehicleStage" type="text" class="form-control" value="${currentStudent.vehicleStage || ''}">
                            </div>
                        </div>
                    </div>

                    

                    <div class="border-bottom pb-3 mb-4">
                        <h5 class="text-primary">Contact & Address</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fatherName" class="form-label">Father's Name</label>
                                <input id="fatherName" type="text" class="form-control" value="${currentStudent.fatherName || ''}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="motherName" class="form-label">Mother's Name</label>
                                <input id="motherName" type="text" class="form-control" value="${currentStudent.motherName || ''}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="mobile1" class="form-label">Mobile Number 1</label>
                                <input id="mobile1" type="tel" class="form-control" value="${currentStudent.mobile1 || ''}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="mobile2" class="form-label">Mobile Number 2</label>
                                <input id="mobile2" type="tel" class="form-control" value="${currentStudent.mobile2 || ''}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="whatsappNo" class="form-label">WhatsApp Number (Student's)</label>
                                <input id="whatsappNo" type="tel" class="form-control" value="${currentStudent.whatsappNo || ''}">
                            </div>
                        </div>
                        <div class="border-bottom pb-3 mb-4">
                        <h5 class="text-primary">Sibling Information</h5>
                        <div class="form-check mb-3">
                            <input id="has-sibling" type="checkbox" class="form-check-input" ${currentStudent.hasSibling ? 'checked' : ''}>
                            <label for="has-sibling" class="form-check-label">Student has a sibling in this school</label>
                        </div>
                        <div id="sibling-info" class="row ${currentStudent.hasSibling ? '' : 'd-none'}">
                            <div class="col-md-6 mb-3">
                                <label for="siblingWhatsAppNumber" class="form-label">Sibling's WhatsApp Number</label>
                                <input id="siblingWhatsAppNumber" type="tel" placeholder="Enter sibling WhatsApp no." class="form-control" value="${currentStudent.siblingWhatsAppNumber || ''}">
                                <small class="form-text text-muted">Enter WhatsApp number to lookup sibling.</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="p-3 bg-light rounded">
                                    <h6 class="font-weight-bold">Sibling Details:</h6>
                                    <p id="sibling-details-display" class="text-muted mb-0">Details will appear here...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                        <h6 class="mt-4 mb-2 text-info">Current Address</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="houseName" class="form-label">House Name / Number</label>
                                <input id="houseName" type="text" class="form-control" value="${currentStudent.houseName || ''}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="place" class="form-label">Place</label>
                                <input id="place" type="text" class="form-control" value="${currentStudent.place || ''}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="state" class="form-label">State</label>
                                <select id="state" class="form-select">
                                    <option value="Kerala" ${currentStudent.state === 'Kerala' || !currentStudent.state ? 'selected' : ''}>Kerala</option>
                                    <option value="Other" ${currentStudent.state === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="district" class="form-label">District</label>
                                <select id="district" class="form-select">
                                    <option value="Malappuram" ${currentStudent.district === 'Malappuram' || !currentStudent.district ? 'selected' : ''}>Malappuram</option>
                                    <option value="Other" ${currentStudent.district === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="taluk" class="form-label">Taluk</label>
                                <input id="taluk" type="text" class="form-control" value="${currentStudent.taluk || ''}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="postOffice" class="form-label">Post Office</label>
                                <input id="postOffice" type="text" class="form-control" value="${currentStudent.postOffice || ''}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="pin" class="form-label">PIN Code</label>
                                <input id="pin" type="text" maxlength="6" class="form-control" value="${currentStudent.pin || ''}">
                            </div>
                        </div>
                    </div>

                    <div class="border-bottom pb-3 mb-4">
                        <h5 class="text-primary">Student Photo</h5>
                        <div class="d-flex align-items-center gap-3">
                            <div class="w-36 h-48 bg-gray-200 rounded-lg flex-shrink-0 border overflow-hidden d-flex justify-content-center align-items-center">
                                <img id="student-photo-display" class="w-full h-full object-cover" src="https://drive.google.com/thumbnail?id=${currentStudent.photoDriveId}&sz=400" alt="Student Photo">
                            </div>
                            <div>
                                <label for="photo-upload-input" class="btn btn-outline-primary btn-sm me-2">
                                    <span>Choose Photo...</span>
                                    <input id="photo-upload-input" type="file" accept="image/*" class="d-none">
                                </label>
                                <button type="button" id="remove-photo-btn" class="btn btn-outline-danger btn-sm ${currentStudent.photoURL ? '' : 'd-none'}">
                                    Remove Photo
                                </button>
                                <p class="text-muted small mt-2">Recommended size: 300x400 pixels (3:4 aspect ratio).</p>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary btn-lg">${buttonText}</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="photo-crop-modal" class="modal fade" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Crop Photo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="bg-dark d-flex justify-content-center align-items-center" style="height: 400px; overflow: hidden;">
                                    <img id="image-to-crop" src="" alt="Image to crop" style="max-width: 100%; max-height: 100%;">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-center mb-3">Live Preview (3:4)</h6>
                                <div id="crop-preview" class="mx-auto bg-light overflow-hidden border" style="width: 144px; height: 192px;"></div>
                                <div class="d-flex flex-wrap justify-content-center gap-1 mt-3">
                                    <button type="button" id="zoom-in-btn" title="Zoom In" class="btn btn-outline-secondary btn-sm"><i class="fas fa-search-plus"></i></button>
                                    <button type="button" id="zoom-out-btn" title="Zoom Out" class="btn btn-outline-secondary btn-sm"><i class="fas fa-search-minus"></i></button>
                                    <button type="button" id="move-left-btn" title="Move Left" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left"></i></button>
                                    <button type="button" id="move-right-btn" title="Move Right" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-right"></i></button>
                                    <button type="button" id="move-up-btn" title="Move Up" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-up"></i></button>
                                    <button type="button" id="move-down-btn" title="Move Down" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-down"></i></button>
                                    <button type="button" id="reset-crop-btn" title="Reset" class="btn btn-outline-secondary btn-sm"><i class="fas fa-sync-alt"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="cancel-crop-btn" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="crop-photo-btn" class="btn btn-primary">Crop & Use</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // --- DOM Element References ---
    const classDropdown = document.getElementById('classId');
    const divisionDropdown = document.getElementById('division');
    const admnSector = document.getElementById('admissionSector');
    const admnNum = document.getElementById('admissionNumber');
    const admnId = document.getElementById('admissionId');
    const dobInput = document.getElementById('dob');
    const admissionDateInput = document.getElementById('admissionDate');
    const hasSiblingCheckbox = document.getElementById('has-sibling');
    const siblingInfoDiv = document.getElementById('sibling-info');
    const siblingWhatsAppNumberInput = document.getElementById('whatsappNo');// document.getElementById('siblingWhatsAppNumber');
    const siblingDetailsDisplay = document.getElementById('sibling-details-display');
    const photoUploadInput = document.getElementById('photo-upload-input');
    const studentPhotoDisplay = document.getElementById('student-photo-display');
    const removePhotoBtn = document.getElementById('remove-photo-btn');
    const photoCropModalElement = document.getElementById('photo-crop-modal');
    const photoCropModal = new bootstrap.Modal(photoCropModalElement);
    const imageToCrop = document.getElementById('image-to-crop');
    const cropPreview = document.getElementById('crop-preview');
    //studentPhotoDisplay.src = `https://drive.google.com/thumbnail?id=${currentStudent.photoDriveId}&sz=400`;
   
    // --- Initializations and Event Listeners ---

    // Set initial DOB and Admission Date format
    const formElement = document.getElementById(formId);
    if (formElement) {
        formElement.addEventListener('input', () => saveFormToLocalStorage(formId));
    }
    loadFormFromLocalStorage(formId);

    if (currentStudent.dob) {
        dobInput.value = currentStudent.dob;
        window.formatDate(dobInput);
    }
    if (currentStudent.admissionDate) {
        admissionDateInput.value = currentStudent.admissionDate;
        window.formatDate(admissionDateInput);
    }

    // Initialize Division Dropdown
    const updateDivisions = () => {
        const selectedClass = classes.find(c => c.id === classDropdown.value);
        divisionDropdown.innerHTML = '<option value="">-- Select Division --</option>';
        if (selectedClass && selectedClass.divisions) {
            divisionDropdown.innerHTML += selectedClass.divisions.map(d =>
                `<option value="${d}" ${currentStudent.division === d ? 'selected' : ''}>${d}</option>`
            ).join('');
        }
    };
    updateDivisions();

    // Generate Admission Number (if not in edit mode)
    
        const generateAdmnNo = async () => {
                if(isEditMode) return;
                const q = query(getCollectionRef('students'), where('admissionSector', '==', admnSector.value));
                console.log(q);
                const snapshot = await getDocs(q);
                console.log(snapshot);
                admnId.value = `${admnSector.value}_${new Date().getFullYear().toString().slice(-2)}_${(snapshot.size + 1).toString().padStart(4, '0')}`;
                admnNum.value = (snapshot.size + 1).toString().padStart(4, '0');
            updateDivisions();
            };
            
    
     if(!isEditMode) generateAdmnNo();
    // Event Listeners for dynamic fields
    classDropdown.addEventListener('change', updateDivisions);
    admnSector.addEventListener('change', generateAdmnNo);
    
    // Sibling Info Toggle
    hasSiblingCheckbox.addEventListener('change', () => {
        siblingInfoDiv.classList.toggle('d-none', !hasSiblingCheckbox.checked);
        if (!hasSiblingCheckbox.checked) {
            siblingWhatsAppNumberInput.value = '';
            siblingDetailsDisplay.innerHTML = 'Details will appear here...';
        }
    });

    // Sibling WhatsApp Number Lookup
    siblingWhatsAppNumberInput.addEventListener('blur', async () => {
        const siblingWhatsAppNo = siblingWhatsAppNumberInput.value.trim();
        const studentWhatsAppNo = document.getElementById('whatsappNo').value.trim();

        if (siblingWhatsAppNo && siblingWhatsAppNo) {
            siblingDetailsDisplay.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Searching...';
            try {
                const q = query(getCollectionRef('students'), where('whatsappNo', '==', siblingWhatsAppNo));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    const siblingData = snapshot.docs[0].data();
                    siblingDetailsDisplay.innerHTML = `<strong>Name:</strong> ${siblingData.name}<br><strong>Class:</strong> ${siblingData.classId} - ${siblingData.division}<br><strong>Admission No:</strong> ${siblingData.id}`;
                    
                } else {
                    siblingDetailsDisplay.innerHTML = '<span class="text-danger">Sibling not found with this WhatsApp number.</span>';
                }
            } catch (error) {
                console.error("Error querying sibling:", error);
                siblingDetailsDisplay.innerHTML = '<span class="text-danger">Error searching sibling.</span>';
            }
        } else if (siblingWhatsAppNo === studentWhatsAppNo && siblingWhatsAppNo !== '') {
            siblingDetailsDisplay.innerHTML = '<span class="text-warning">Cannot be self.</span>';
            siblingWhatsAppNumberInput.value = '';
        } else {
            siblingDetailsDisplay.innerHTML = 'Details will appear here...';
        }
    });

    // ------------------------
// 1. Photo Upload & Modal Show
// ------------------------
if (isEditMode && currentStudent.photoDriveId) { // Check for photoDriveId
    // Construct the thumbnail URL
   // studentPhotoDisplay.src = `https://drive.google.com/thumbnail?id=${currentStudent.photoDriveId}&sz=400`;
    currentPhotoURL = currentStudent.photoURL; // Still keep the full URL if needed for other purposes
    removePhotoBtn.classList.remove('d-none');
} else {
   // studentPhotoDisplay.src = 'https://via.placeholder.com/150x200?text=No+Photo';
    removePhotoBtn.classList.add('d-none');
}

photoUploadInput.addEventListener('change', (event) => {
    const files = event.target.files;
    if (!files || !files.length) return;

    rawPhotoFile = files[0];
    const reader = new FileReader();

    reader.onload = (e) => {
        const imageUrl = e.target.result;

        // Assign onload before setting src
        imageToCrop.onload = () => {
            console.log("DEBUG: imageToCrop.onload fired.");

            if (typeof Cropper !== 'function') {
                console.error("Cropper.js library not loaded as a function.");
                showAlert("Image cropping feature is unavailable. Cropper.js not found.", "danger");
                photoCropModal.hide();
                return;
            }

            if (cropper) cropper.destroy();

            cropper = new Cropper(imageToCrop, {
                aspectRatio: 3 / 4,
                viewMode: 1,
                preview: cropPreview,
                autoCropArea: 0.8,
                zoomable: true,
                movable: true,
            });

            console.log("DEBUG: Cropper instance created.");
        };

        imageToCrop.src = imageUrl; // Triggers imageToCrop.onload
        photoCropModal.show();      // Show Bootstrap modal
    };

    reader.readAsDataURL(rawPhotoFile);
});

// ------------------------
// 2. Cropper Control Buttons
// ------------------------

document.getElementById('zoom-in-btn')?.addEventListener('click', () => cropper?.zoom(0.1));
document.getElementById('zoom-out-btn')?.addEventListener('click', () => cropper?.zoom(-0.1));
document.getElementById('move-left-btn')?.addEventListener('click', () => cropper?.move(-10, 0));
document.getElementById('move-right-btn')?.addEventListener('click', () => cropper?.move(10, 0));
document.getElementById('move-up-btn')?.addEventListener('click', () => cropper?.move(0, -10));
document.getElementById('move-down-btn')?.addEventListener('click', () => cropper?.move(0, 10));
document.getElementById('reset-crop-btn')?.addEventListener('click', () => cropper?.reset());

// ------------------------
// 3. Confirm Crop & Use
// ------------------------

document.getElementById('crop-photo-btn')?.addEventListener('click', () => {
    if (!cropper) return;

    cropper.getCroppedCanvas({
        width: 300,
        height: 400,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high',
    }).toBlob((blob) => {
        croppedPhotoBlob = blob;
        studentPhotoDisplay.src = URL.createObjectURL(blob);
        removePhotoBtn.classList.remove('d-none');
        photoCropModal.hide();
        cropper.destroy();
        cropper = null;
    }, 'image/jpeg', 0.9);
});

// ------------------------
// 4. Cancel Crop
// ------------------------

document.getElementById('cancel-crop-btn')?.addEventListener('click', () => {
    rawPhotoFile = null;
    croppedPhotoBlob = null;
    photoCropModal.hide();
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
});

// ------------------------
// 5. Remove Existing Photo
// ------------------------

removePhotoBtn.addEventListener('click', async () => {
    if (!confirm('Are you sure you want to remove the student photo?')) return;

    if (currentPhotoURL && currentStudent.photoURL === currentPhotoURL) {
        try {
            await deleteFileFromStorage(currentPhotoURL);
            showAlert('Photo removed from cloud storage.', 'info');
        } catch (error) {
            console.error('Error deleting photo from storage:', error);
            showAlert('Failed to remove photo from cloud storage.', 'danger');
        }
    }

    currentPhotoURL = '';
    croppedPhotoBlob = null;
    studentPhotoDisplay.src = 'https://placehold.co/150x200?text=No+Photo&font=roboto';
    removePhotoBtn.classList.add('d-none');

    //if (isEditMode) studentToEdit.photoURL = '';
});


    // --- Form Submission Handler ---
    document.getElementById('add-student-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;

        if (!form.checkValidity()) {
            e.stopPropagation();
            form.classList.add('was-validated');
            showAlert('Please fill in all required fields correctly.', 'warning');
            return;
        }
        form.classList.add('was-validated');

        const studentData = {
            id: admnId.value,
            name: document.getElementById('name').value.trim(),
            dob: document.getElementById('dob').value.trim(),
            gender: document.getElementById('gender').value,
            aadhaar: document.getElementById('aadhaar').value.trim(),
            nationality: document.getElementById('nationality').value,
            birthPlace: document.getElementById('birthPlace').value.trim(),

            admissionSector: admnSector.value,
            admissionNumber: admnNum.value,
            admissionDate: admissionDateInput.value.trim(),
            instructionMedium: document.getElementById('instructionMedium').value,
            classId: classDropdown.value,
            division: divisionDropdown.value,
            aplBpl: document.getElementById('aplBpl').value,
            busPoint: document.getElementById('busPoint').value.trim(),
            vehicleStage: document.getElementById('vehicleStage').value.trim(),

            hasSibling: hasSiblingCheckbox.checked,
            siblingWhatsAppNumber: hasSiblingCheckbox.checked ? siblingWhatsAppNumberInput.value.trim() : '',

            fatherName: document.getElementById('fatherName').value.trim(),
            motherName: document.getElementById('motherName').value.trim(),
            mobile1: document.getElementById('mobile1').value.trim(),
            mobile2: document.getElementById('mobile2').value.trim(),
            whatsappNo: document.getElementById('whatsappNo').value.trim(),
            
            houseName: document.getElementById('houseName').value.trim(),
            place: document.getElementById('place').value.trim(),
            state: document.getElementById('state').value,
            district: document.getElementById('district').value,
            taluk: document.getElementById('taluk').value.trim(),
            postOffice: document.getElementById('postOffice').value.trim(),
            pin: document.getElementById('pin').value.trim(),
            photoURL: '' 
        };

        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonHtml = submitButton.innerHTML;
        submitButton.disabled = true;
        submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...`;

        try {
            let newPhotoURL = '';
            let newPhotoDriveId = '';

            if (croppedPhotoBlob) {
                console.log(croppedPhotoBlob);
                showAlert('Uploading photo to Drive...', 'info');
                const uploadResult = await uploadPhotoToDrive(croppedPhotoBlob, studentData.admissionNumber);
                console.log(uploadResult);

                if (uploadResult && uploadResult.success) {

                    newPhotoURL = uploadResult.fileUrl; // <--- Photo URL from Drive
                    newPhotoDriveId = uploadResult.fileId; // <--- Photo ID from Drive
                    studentData.photoURL = uploadResult.fileUrl; // This is the standard view link
                    studentData.photoDriveId = uploadResult.fileId; // This is the ID you need for thumbnails

                    showAlert('Photo uploaded successfully to Drive!', 'success');
                } else {
                    showAlert('Failed to upload photo to Drive. Saving student without photo.', 'danger');
                    console.error('Drive upload failed:', uploadResult);
                }
            } else if (currentPhotoURL && currentPhotoURL !== 'https://via.placeholder.com/150x200?text=No+Photo') {
                // If no new photo cropped, but there's an existing photo (retained)
                newPhotoURL = currentPhotoURL;
                // Try to get the existing Drive ID from currentStudent or parse from URL
                newPhotoDriveId = isEditMode ? (studentToEdit.photoDriveId || studentToEdit.photoURL.match(/\/d\/([a-zA-Z0-9_-]+)/)?.[1] || '') : '';
            } else {
                // No photo, or photo was explicitly removed
                newPhotoURL = '';
                newPhotoDriveId = '';
            }

            studentData.photoURL = newPhotoURL; // This is the standard view link
            studentData.photoDriveId = newPhotoDriveId; // This is the ID you need for thumbnails


            // Save Student Data to Firestore (studentData contains only URL and ID, not the actual image)
            await setDoc(getDocRef('students', studentData.id), studentData);



            // Save Student Data to Firestore
            await setDoc(getDocRef('students', studentData.id), studentData);
            
            showAlert(`Student ${isEditMode ? 'updated' : 'added'} successfully.`, 'success');
            
            if (isEditMode) {
                studentToEdit = null;
                navigateTo('student-mgt');
            } else {
                form.reset();
                form.classList.remove('was-validated');
                studentPhotoDisplay.src = 'https://placehold.co/150x200?text=No+Photo&font=roboto' ;
                removePhotoBtn.classList.add('d-none');
                updateDivisions();
                generateAdmnNo();
                siblingInfoDiv.classList.add('d-none');
                siblingDetailsDisplay.innerHTML = 'Details will appear here...';
                rawPhotoFile = null;
                croppedPhotoBlob = null;
                currentPhotoURL = '';
            }
            localStorage.removeItem(`formData_${formId}`);
         
        } catch (error) {
            console.error('Error saving student:', error);
            showAlert('Failed to save student data. Please try again.', 'danger');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonHtml;
        }
    });

};



window.formatDate = (input) => {
    let value = input.value.replace(/\D/g, ''); // Remove non-digits
    if (value.length > 2) value = value.slice(0, 2) + '/' + value.slice(2);
    if (value.length > 5) value = value.slice(0, 5) + '/' + value.slice(5, 9);
    input.value = value;

    // Optional: Display date in words
    const dobWordsSpan = document.getElementById('dob-words');
    if (dobWordsSpan) {
        try {
            const [day, month, year] = value.split('/').map(Number);
            if (day && month && year && year > 1900 && year < 2100) { // Basic validation
                const dateObj = new Date(year, month - 1, day);
                dobWordsSpan.textContent = dateObj.toLocaleDateString('en-US', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
            } else {
                dobWordsSpan.textContent = '';
            }
        } catch (e) {
            dobWordsSpan.textContent = '';
        }
    }
};

window.formatAadhaar = (input) => {
    let value = input.value.replace(/\D/g, ''); // Remove non-digits
    if (value.length > 4) value = value.slice(0, 4) + ' ' + value.slice(4);
    if (value.length > 9) value = value.slice(0, 9) + ' ' + value.slice(9);
    input.value = value;
};




        
        window.renderStudentManagement = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }

    const currentYear = new Date().getFullYear();
    const currentAcademicYear = `${currentYear}-${currentYear + 1}`;

    const classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Student Management</h1>
        <div class="card shadow mb-4">
            <div class="card-body">
                <h5 class="fw-bold mb-3">Filter Students</h5>
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="filter-class" class="form-label">Class</label>
                        <select id="filter-class" class="form-select">
                            <option value="">-- All Classes --</option>
                            ${classOptions}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filter-division" class="form-label">Division</label>
                        <select id="filter-division" class="form-select" disabled>
                            <option value="">-- All Divisions --</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="student-search-input" class="form-label">Search (Admn No. or Name)</label>
                        <input type="text" id="student-search-input" class="form-control" placeholder="Search by Admn No. or Name">
                    </div>
                    <div class="col-md-2 d-flex justify-content-end">
                        <button id="new-admissions-btn" class="btn btn-outline-info w-100">
                            New Admissions (${currentAcademicYear})
                        </button>
                    </div>
                </div>
                <hr class="mt-4 mb-3">
                <div class="text-end">
                    <button id="reset-filters-btn" class="btn btn-outline-secondary btn-sm">Reset Filters</button>
                </div>
            </div>
        </div>

        <div id="student-report-section" class="card shadow mb-4 d-none">
            <div class="card-header fw-bold text-primary">Admission Report</div>
            <div class="card-body" id="admission-report-content">
                </div>
        </div>

        <div class="card shadow">
            <div class="card-header fw-bold text-primary">Student List</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>id</th>
                                <th>Admn No</th>
                                <th>Name</th>
                                <th>Class</th>
                                ${currentUserRole === 'admin' ? '<th class="text-end">Actions</th>' : ''}
                            </tr>
                        </thead>
                        <tbody id="student-list-tbody">
                            </tbody>
                    </table>
                </div>
                <p id="no-students-message" class="text-muted text-center mt-3 d-none">No students found matching your criteria.</p>
            </div>
        </div>
    `;

    // --- Get Filter Elements and Attach Listeners ---
    const filterClassDropdown = document.getElementById('filter-class');
    const filterDivisionDropdown = document.getElementById('filter-division');
    const studentSearchInput = document.getElementById('student-search-input');
    const newAdmissionsBtn = document.getElementById('new-admissions-btn');
    const resetFiltersBtn = document.getElementById('reset-filters-btn');

    // Function to update division dropdown based on selected class
    const updateFilterDivisions = () => {
        const selectedClass = classes.find(c => c.id === filterClassDropdown.value);
        filterDivisionDropdown.innerHTML = '<option value="">-- All Divisions --</option>';
        if (selectedClass && selectedClass.divisions) {
            filterDivisionDropdown.disabled = false;
            filterDivisionDropdown.innerHTML += selectedClass.divisions.map(d => `<option value="${d}">${d}</option>`).join('');
        } else {
            filterDivisionDropdown.disabled = true;
        }
        filterAndRenderStudents(); // Re-filter when class changes
    };

    filterClassDropdown.addEventListener('change', updateFilterDivisions);
    filterDivisionDropdown.addEventListener('change', filterAndRenderStudents);
    studentSearchInput.addEventListener('input', filterAndRenderStudents);
    
    let isNewAdmissionsFiltered = false; // State variable for new admissions filter

    newAdmissionsBtn.addEventListener('click', () => {
        isNewAdmissionsFiltered = !isNewAdmissionsFiltered; // Toggle state
        if (isNewAdmissionsFiltered) {
            // Apply new admissions filter
            newAdmissionsBtn.classList.remove('btn-outline-info');
            newAdmissionsBtn.classList.add('btn-info');
            // Reset other filters for a clean "new admissions" view
            filterClassDropdown.value = '';
            filterDivisionDropdown.value = '';
            filterDivisionDropdown.disabled = true;
            studentSearchInput.value = '';
        } else {
            // Remove new admissions filter
            newAdmissionsBtn.classList.remove('btn-info');
            newAdmissionsBtn.classList.add('btn-outline-info');
        }
        filterAndRenderStudents(); // Re-filter
    });

    resetFiltersBtn.addEventListener('click', () => {
        filterClassDropdown.value = '';
        filterDivisionDropdown.value = '';
        filterDivisionDropdown.disabled = true;
        studentSearchInput.value = '';
        isNewAdmissionsFiltered = false;
        newAdmissionsBtn.classList.remove('btn-info');
        newAdmissionsBtn.classList.add('btn-outline-info');
        filterAndRenderStudents(); // Re-filter
    });

    // Initial render of students and report when the page loads
    updateFilterDivisions(); // Populate divisions initially
    filterAndRenderStudents();

    // --- Attach event listener for the full student details modal ---
    // Use event delegation on the tbody for efficiency
    document.getElementById('student-list-tbody').addEventListener('click', (e) => {
        const studentNameLink = e.target.closest('.student-name-link'); // Find the closest link
        if (studentNameLink) {
            e.preventDefault(); // Prevent default link behavior
            const studentId = studentNameLink.dataset.id;
            populateAndShowFullStudentModal(studentId);
        }
    });

    // In window.renderStudentManagement or relevant setup
document.getElementById('print-student-details-btn').addEventListener('click', () => {
    // Here, you would replace the direct print logic with a call to printContentOfDiv
    const studentName = document.getElementById('fullStudentDetailModalLabel').textContent.replace('Student Details: ', '');

    const customHeader = `
        <h1 style="text-align:center; color:#0d6efd;">School Management Pro</h1>
        <h2 style="text-align:center;">Student Profile: ${studentName}</h2>
        <hr style="border: 1px solid #eee; margin: 15px 0;">
    `;
    const customFooter = `
        <p style="text-align:center; font-size: 0.7em; color: #777; margin-top: 30px;">
            Generated on ${new Date().toLocaleDateString('en-IN', { dateStyle: 'long' })}
        </p>
    `;
    const modalSpecificCss = `
        /* Ensure images print well */
        .img-thumbnail { border: 1px solid #ddd; padding: 5px; background-color: #fff; }
        /* Any specific overrides for modal content layout if needed */
        #student-details-printable .row { margin-bottom: 0.5em; }
        #student-details-printable strong { color: #555; display: inline-block; min-width: 120px; }
        #student-details-printable h5.text-info { color: #17a2b8 !important; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px; }
    `;

    printContentOfDiv('student-details-printable', `Student Profile - ${studentName}`, {
        customHeaderHtml: customHeader,
        customFooterHtml: customFooter,
        extraCss: modalSpecificCss
    });

    // The original modal hiding/showing logic after print is no longer needed in this button,
    // as the new print function handles its own window.
    // You might still want to close the modal after the print dialog appears, though.
    const studentDetailModal = bootstrap.Modal.getInstance(document.getElementById('fullStudentDetailModal'));
    if (studentDetailModal) {
        // Optional: Close modal after print initiated
        // studentDetailModal.hide();
    }
});

};

/**
 * Filters the student list based on selected criteria and renders the table and report.
 */
/**
 * Filters the student list based on selected criteria and renders the table and report.
 * This is the main function controlling the student management view's dynamic content.
 */
function filterAndRenderStudents() {
    const filterClassDropdown = document.getElementById('filter-class');
    const filterDivisionDropdown = document.getElementById('filter-division');
    const studentSearchInput = document.getElementById('student-search-input');
    const newAdmissionsBtn = document.getElementById('new-admissions-btn');
    const studentReportSection = document.getElementById('student-report-section');
    const admissionReportContent = document.getElementById('admission-report-content');
    const studentListTbody = document.getElementById('student-list-tbody');
    const noStudentsMessage = document.getElementById('no-students-message');

    const filterClassId = filterClassDropdown.value;
    const filterDivision = filterDivisionDropdown.value;
    const searchTerm = studentSearchInput.value.toLowerCase();
    const isNewAdmissionsFiltered = newAdmissionsBtn.classList.contains('btn-info'); // Check if the button is active

    let filteredStudents = currentUserRole === 'teacher' ?
        students.filter(s => s.classId === selectedUser.classCharge?.classId && s.division === selectedUser.classCharge?.division) :
        students;

    // Apply Class filter
    if (filterClassId) {
        filteredStudents = filteredStudents.filter(s => s.classId === filterClassId);
    }

    // Apply Division filter
    if (filterDivision) {
        filteredStudents = filteredStudents.filter(s => s.division === filterDivision);
    }

    // Apply Search Term filter (Admission No. or Name)
    if (searchTerm) {
        filteredStudents = filteredStudents.filter(s =>
            (s.admissionNumber && s.admissionNumber.toLowerCase().includes(searchTerm)) ||
            (s.name && s.name.toLowerCase().includes(searchTerm))
        );
    }

    // Apply "New Admissions" filter based on current year (assuming admissionDate or admissionNumber format)
    if (isNewAdmissionsFiltered) {
        const currentYear = new Date().getFullYear();
        filteredStudents = filteredStudents.filter(s => {
            if (s.admissionDate) {
                const admissionYear = new Date(s.admissionDate).getFullYear();
                return admissionYear === currentYear;
            }
            if (s.admissionNumber) {
                const parts = s.admissionNumber.split('_');
                if (parts.length === 3) {
                    const admissionYearSuffix = parseInt(parts[1], 10);
                    // Handle cases where suffix might imply a past century if current year is e.g. 2005 and suffix is 99
                    const fullAdmissionYear = (currentYear - (currentYear % 100)) + admissionYearSuffix; 
                    return fullAdmissionYear === currentYear;
                }
            }
            return false; 
        });
    }

    // Sort the filtered list for consistent display
    filteredStudents.sort((a, b) => (a.name || "").localeCompare(b.name || ""));

    // Render Student List Table
    if (filteredStudents.length > 0) {
        studentListTbody.innerHTML = filteredStudents.map(s => {
            const cls = classes.find(c => c.id === s.classId);
            return `<tr>
                        <td>${s.id||'id'}</td>
                        <td>${s.admissionNumber || 'N/A'}</td>
                        <td><a href="#" class="student-name-link fw-bold" data-id="${s.id}">${s.name || 'N/A'}</a></td>
                        <td>${cls?.name || 'N/A'} - ${s.division || 'N/A'}</td>
                        ${currentUserRole === 'admin' ? `<td class="text-end">
                            <button onclick="window.handleEditStudent('${s.id}')" class="btn btn-sm btn-outline-primary me-2" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="window.handleDelete('students', '${s.id}')" class="btn btn-sm btn-outline-danger" title="Delete"><i class="fas fa-trash-alt"></i></button>
                        </td>` : ''}
                    </tr>`;
        }).join('');
        noStudentsMessage.classList.add('d-none');
    } else {
        studentListTbody.innerHTML = '';
        noStudentsMessage.classList.remove('d-none');
    }

    // Generate and Render Admission Report only if there are filtered students
    if (filteredStudents.length > 0) {
        studentReportSection.classList.remove('d-none');
        generateAdmissionReport(filteredStudents, admissionReportContent);
    } else {
        studentReportSection.classList.add('d-none');
        admissionReportContent.innerHTML = ''; // Clear report if no students
    }
}

/**
 * Generates and displays a detailed admission report based on a given list of students.
 * The report provides a class-wise breakdown including gender counts and totals.
 * @param {Array<object>} studentsToReport - The list of students to generate the report for.
 * @param {HTMLElement} container - The DOM element to render the report into.
 */
function generateAdmissionReport(studentsToReport, container) {
    if (!container) {
        console.error('Report container not found!');
        return;
    }

    // --- Data Aggregation ---
    // Structure: { "CLASS_ID-DIVISION": { males: 0, females: 0, total: 0, className: "Grade X", divisionName: "A" } }
    const reportData = {};
    let grandTotalMales = 0;
    let grandTotalFemales = 0;
    let grandOverallTotal = 0;

    studentsToReport.forEach(s => {
        const classId = s.classId || 'Unassigned';
        const division = s.division || 'Unassigned';
        const classKey = `${classId}-${division}`;

        if (!reportData[classKey]) {
            const classObj = classes.find(c => c.id === classId);
            reportData[classKey] = {
                className: classObj?.name || 'N/A',
                divisionName: division,
                males: 0,
                females: 0,
                total: 0
            };
        }

        if (s.gender === 'M') {
            reportData[classKey].males++;
            grandTotalMales++;
        } else if (s.gender === 'F') {
            reportData[classKey].females++;
            grandTotalFemales++;
        }
        reportData[classKey].total++;
        grandOverallTotal++;
    });

    // Sort report data keys by class name, then division for consistent presentation
    const sortedClassKeys = Object.keys(reportData).sort((a, b) => {
        const [classA, divA] = a.split('-');
        const [classB, divB] = b.split('-');
        const classNameA = classes.find(c => c.id === classA)?.name || '';
        const classNameB = classes.find(c => c.id === classB)?.name || '';

        if (classNameA === classNameB) {
            return divA.localeCompare(divB);
        }
        return classNameA.localeCompare(classNameB);
    });

    // --- Report HTML Generation ---
    let reportHtml = `
        <h5 class="fw-bold text-secondary mb-3">Class-wise Admission Breakdown</h5>
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Class (Division)</th>
                        <th class="text-center">Males</th>
                        <th class="text-center">Females</th>
                        <th class="text-center">Total</th>
                    </tr>
                </thead>
                <tbody>`;

    if (sortedClassKeys.length === 0) {
        reportHtml += `<tr><td colspan="4" class="text-center text-muted">No data available for this report.</td></tr>`;
    } else {
        sortedClassKeys.forEach(key => {
            const data = reportData[key];
            reportHtml += `
                <tr>
                    <td>${data.className} (${data.divisionName})</td>
                    <td class="text-center">${data.males}</td>
                    <td class="text-center">${data.females}</td>
                    <td class="text-center">${data.total}</td>
                </tr>`;
        });
    }

    // --- Grand Totals Row ---
    reportHtml += `
                </tbody>
                <tfoot class="table-primary fw-bold">
                    <tr>
                        <td>Grand Total</td>
                        <td class="text-center">${grandTotalMales}</td>
                        <td class="text-center">${grandTotalFemales}</td>
                        <td class="text-center">${grandOverallTotal}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <p class="text-muted small mt-3">Report based on currently filtered students.</p>
    `;

    container.innerHTML = reportHtml;
}
/**
 * Populates the full student detail modal with comprehensive information and shows it.
 * @param {string} studentId - The ID of the student whose details to display.
 */
function populateAndShowFullStudentModal(studentId) {
    const student = students.find(s => s.id === studentId);
    if (!student) {
        showAlert('Student details not found.', 'danger');
        return;
    }

    const modalBody = document.getElementById('fullStudentDetailModalBody');
    const modalTitle = document.getElementById('fullStudentDetailModalLabel');

    const className = classes.find(c => c.id === student.classId)?.name || 'N/A';
    const dobFormatted = student.dob ? new Date(student.dob).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'N/A';
    const admissionDateFormatted = student.admissionDate ? new Date(student.admissionDate).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'N/A';

    // Build the HTML for the modal body
    modalBody.innerHTML = `
        <div id="student-details-printable">
            <h4 class="mb-3 text-center fw-bold text-primary">Student Profile</h4>
            <div class="row mb-4">
                <div class="col-md-3 text-center">
                    <img src="${student.photoDriveId ? `https://drive.google.com/thumbnail?id=${student.photoDriveId}&sz=400` : 'https://via.placeholder.com/150x200?text=No+Photo'}"
     alt="Student Photo" class="img-thumbnail mb-2" style="width: 150px; height: 200px; object-fit: cover;">
                </div>
                <div class="col-md-9">
                    <h5 class="fw-bold">${student.name || 'N/A'}</h5>
                    <p class="text-muted mb-1"><strong>Admission No:</strong> ${student.admissionNumber || 'N/A'}</p>
                    <p class="text-muted mb-1"><strong>Class:</strong> ${className} - ${student.division || 'N/A'}</p>
                    <p class="text-muted mb-1"><strong>Gender:</strong> ${student.gender==="M"?"Male":"Female" || 'N/A'}</p>
                </div>
            </div>

            <h5 class="fw-bold text-info border-bottom pb-2 mb-3">Personal Information</h5>
            <div class="row mb-3">
                <div class="col-md-4"><strong>Date of Birth:</strong> ${dobFormatted}</div>
                <div class="col-md-4"><strong>Aadhaar No:</strong> ${student.aadhaar || 'N/A'}</div>
                <div class="col-md-4"><strong>Nationality:</strong> ${student.nationality || 'N/A'}</div>
                <div class="col-md-4"><strong>Birth Place:</strong> ${student.birthPlace || 'N/A'}</div>
            </div>

            <h5 class="fw-bold text-info border-bottom pb-2 mb-3">Academic Details</h5>
            <div class="row mb-3">
                <div class="col-md-4"><strong>Admission Date:</strong> ${admissionDateFormatted}</div>
                <div class="col-md-4"><strong>Admission Sector:</strong> ${student.admissionSector || 'N/A'}</div>
                <div class="col-md-4"><strong>Instruction Medium:</strong> ${student.instructionMedium || 'N/A'}</div>
                <div class="col-md-4"><strong>APL/BPL:</strong> ${student.aplBpl || 'N/A'}</div>
                <div class="col-md-4"><strong>Bus Point:</strong> ${student.busPoint || 'N/A'}</div>
                <div class="col-md-4"><strong>Vehicle Stage:</strong> ${student.vehicleStage || 'N/A'}</div>
            </div>

            ${student.hasSibling ? `
            <h5 class="fw-bold text-info border-bottom pb-2 mb-3">Sibling Information</h5>
            <div class="row mb-3">
                <div class="col-md-6"><strong>Has Sibling:</strong> Yes</div>
                <div class="col-md-6"><strong>Sibling WhatsApp:</strong> ${student.siblingWhatsAppNumber || 'N/A'}</div>
                ${student.siblingDetailsDisplay ? `<div class="col-md-12"><strong>Sibling Details:</strong> ${student.siblingDetailsDisplay}</div>` : ''}
            </div>` : `<h5 class="fw-bold text-info border-bottom pb-2 mb-3">Sibling Information</h5><p class="text-muted">No sibling in this school recorded.</p>`}


            <h5 class="fw-bold text-info border-bottom pb-2 mb-3">Contact & Address</h5>
            <div class="row mb-3">
                <div class="col-md-6"><strong>Father's Name:</strong> ${student.fatherName || 'N/A'}</div>
                <div class="col-md-6"><strong>Mother's Name:</strong> ${student.motherName || 'N/A'}</div>
                <div class="col-md-4"><strong>Mobile 1:</strong> ${student.mobile1 || 'N/A'}</div>
                <div class="col-md-4"><strong>Mobile 2:</strong> ${student.mobile2 || 'N/A'}</div>
                <div class="col-md-4"><strong>WhatsApp (Student):</strong> ${student.whatsappNo || 'N/A'}</div>
            </div>
            <h6 class="mt-4 fw-bold text-secondary">Current Address:</h6>
            <div class="row">
                <div class="col-md-6"><strong>House Name/No:</strong> ${student.houseName || 'N/A'}</div>
                <div class="col-md-6"><strong>Place:</strong> ${student.place || 'N/A'}</div>
                <div class="col-md-4"><strong>Post Office:</strong> ${student.postOffice || 'N/A'}</div>
                <div class="col-md-4"><strong>PIN Code:</strong> ${student.pin || 'N/A'}</div>
                <div class="col-md-4"><strong>Taluk:</strong> ${student.taluk || 'N/A'}</div>
                <div class="col-md-4"><strong>District:</strong> ${student.district || 'N/A'}</div>
                <div class="col-md-4"><strong>State:</strong> ${student.state || 'N/A'}</div>
            </div>
        </div>
    `;

    modalTitle.textContent = `Student Details: ${student.name}`;
    const studentDetailModal = new bootstrap.Modal(document.getElementById('fullStudentDetailModal'));
    studentDetailModal.show();
}

        window.handleEditStudent = (id) => { studentToEdit = students.find(s => s.id === id); if(studentToEdit) navigateTo('add-student'); };

        // --- EXAM MANAGEMENT (ENHANCED) ---

// This replaces the existing window.renderExamManagement function
// --- EXAM MANAGEMENT (ENHANCED) ---

window.renderExamManagement = () => {
    const isAdmin = currentUserRole === 'admin';
    const isExamController = currentUserRole === 'teacher' || selectedUser.roles && selectedUser.roles.includes('exam_controller');

    if (!isAdmin && !isExamController) {
        mainContent.innerHTML = `<div class="alert alert-danger"><h4>Access Denied</h4><p>You do not have permission to access this module.</p></div>`;
        return;
    }

    mainContent.innerHTML = `<h1 class="h2 mb-4">Exam Management</h1>
    <ul class="nav nav-tabs" id="examTab" role="tablist">
        ${isAdmin ? `<li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#add-exam" type="button">Add Exam</button></li>` : ''}
        ${isAdmin ? `<li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#schedule" type="button">Schedule</button></li>` : '<li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#schedule" type="button">Schedule</button></li>'}
        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#timetable-view" type="button">Timetable</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#entry" type="button">Mark Entry</button></li>
        
        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#entry-report" type="button">Entry Report</button></li>

        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#results" type="button">Results</button></li>
    </ul>
    <div class="tab-content card" id="examTabContent">
        ${isAdmin ? `<div class="tab-pane fade p-4" id="add-exam" role="tabpanel"></div>` : ''}
        ${isAdmin ? `<div class="tab-pane fade p-4" id="schedule" role="tabpanel"></div>` : '<div class="tab-pane fade p-4" id="schedule" role="tabpanel"></div>'}
        <div class="tab-pane fade p-4" id="timetable-view" role="tabpanel"></div>
        <div class="tab-pane fade p-4" id="entry" role="tabpanel"></div>

        <div class="tab-pane fade p-4" id="entry-report" role="tabpanel"></div>

        <div class="tab-pane fade p-4" id="results" role="tabpanel"></div>
    </div>`;

    if (isAdmin) {
        renderExamAddTab();
        
    }
    renderExamScheduleTab();
    renderExamTimetableView();
    renderMarkEntryTab();
    renderEntryReportTab(); // <-- Call the new function
    renderResultsTab();
    
    const firstVisibleTab = mainContent.querySelector('#examTab .nav-link');
    if(firstVisibleTab) {
        new bootstrap.Tab(firstVisibleTab).show();
    }
};

/**
 * Generates the entry report, filtering schedules based on user role
 * and then calling the summary table renderer.
 * @param {string} examId - The ID of the selected exam.
 */
function generateEntryReport(examId) {
    const container = document.getElementById('entry-report-container');
    container.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary"></div><p class="mt-2">Generating Report...</p></div>`;

    let relevantSchedules = [];
    const isAdminOrController = currentUserRole === 'admin' || (currentUserRole === 'teacher' && selectedUser.roles && selectedUser.roles.includes('exam_controller'));

    if (isAdminOrController) {
        // Admins and controllers see all schedules for the exam
        relevantSchedules = examSchedules.filter(s => s.examId === examId);
    } else if (currentUserRole === 'teacher') {
        // Teachers see schedules only for subjects they handle
        const teacherAllocations = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id);
        relevantSchedules = examSchedules.filter(s =>
            s.examId === examId && teacherAllocations.some(ta =>
                ta.classId === s.classId && ta.division === s.division && ta.subjectId === s.subjectId
            )
        );
    }

    if (relevantSchedules.length === 0) {
        container.innerHTML = `<div class="alert alert-warning">No mark entries found for your allocated subjects in this exam.</div>`;
        return;
    }

    // Generate and display the summary table using the filtered schedules
    renderMarkEntrySummaryTable(examId, relevantSchedules, container);
}


/**
 * Renders the summary table of mark entry status into a specified container.
 * @param {string} examId - The ID of the exam.
 * @param {Array} schedules - The pre-filtered list of schedules to report on.
 * @param {HTMLElement} container - The DOM element to render the report into.
 */
function renderMarkEntrySummaryTable(examId, schedules, container) {
    let summaryData = [];
    
    schedules.forEach(schedule => {
        const { classId, division, subjectId } = schedule;
        const studentsInClass = students.filter(s => s.classId === classId && s.division === division);
        const totalStudents = studentsInClass.length;

        if (totalStudents === 0) return;

        const enteredCount = marks.filter(m => 
            m.examId === examId &&
            m.subjectId === subjectId &&
            studentsInClass.some(s => s.id === m.studentId)
        ).length;
        
        const className = classes.find(c => c.id === classId)?.name || 'N/A';
        const subjectName = subjects.find(sub => sub.id === subjectId)?.name || 'N/A';
        
        summaryData.push({
            className,
            division,
            subjectName,
            total: totalStudents,
            entered: enteredCount,
            pending: totalStudents - enteredCount
        });
    });

    if (summaryData.length === 0) {
        container.innerHTML = '<p class="alert alert-warning">No subjects have been scheduled for this exam.</p>';
        return;
    }

    summaryData.sort((a,b) => (a.className + a.division + a.subjectName).localeCompare(b.className + b.division + b.subjectName));

    const tableHTML = `
        <div class="table-responsive mt-4">
            <h5 class="mb-3">Mark Entry Status for: <strong>${exams.find(e=>e.id===examId)?.name}</strong></h5>
            <table class="table table-bordered table-hover table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Class</th>
                        <th>Subject</th>
                        <th>Total Students</th>
                        <th class="text-success">Entered</th>
                        <th class="text-danger">Pending</th>
                        <th style="width: 20%;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${summaryData.map(row => {
                        const percentage = row.total > 0 ? (row.entered / row.total) * 100 : 0;
                        const statusClass = percentage === 100 ? 'bg-success' : (percentage > 0 ? 'bg-warning' : 'bg-danger');
                        return `
                        <tr>
                            <td>${row.className} - ${row.division}</td>
                            <td>${row.subjectName}</td>
                            <td class="text-center">${row.total}</td>
                            <td class="text-center">${row.entered}</td>
                            <td class="text-center">${row.pending}</td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${percentage}%;" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">${percentage.toFixed(0)}%</div>
                                </div>
                            </td>
                        </tr>
                    `}).join('')}
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = tableHTML;
}
/**
 * Renders the UI for the new "Entry Report" tab.
 */
function renderEntryReportTab() {
    const container = document.getElementById('entry-report');
    if (!container) return;

    container.innerHTML = `
        <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
            <div class="col-md-6">
                <label class="form-label fw-bold">Select Exam to Generate Report</label>
                <select id="entry-report-exam" class="form-select">
                    <option value="">-- Choose an Exam --</option>
                    ${exams.map(ex => `<option value="${ex.id}">${ex.name}</option>`).join('')}
                </select>
            </div>
        </div>
        <div id="entry-report-container" class="mt-4">
            <p class="text-muted text-center p-5">Please select an exam to view the detailed entry report.</p>
        </div>
    `;

    document.getElementById('entry-report-exam').addEventListener('change', (e) => {
        if (e.target.value) {
            generateEntryReport(e.target.value);
        }
    });
}

/**
 * Generates the detailed entry report based on the user's role.
 * @param {string} examId - The ID of the selected exam.
 */
function generateEntryReportDetailed(examId) {
    const container = document.getElementById('entry-report-container');
    container.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary"></div><p class="mt-2">Generating Report...</p></div>`;

    let relevantSchedules = [];
    const isAdminOrController = currentUserRole === 'admin' || (currentUserRole === 'teacher' && selectedUser.roles.includes('exam_controller'));

    if (isAdminOrController) {
        // Admins and controllers see all schedules for the exam
        relevantSchedules = examSchedules.filter(s => s.examId === examId);
    } else if (currentUserRole === 'teacher') {
        // Teachers see schedules only for subjects they handle
        const teacherAllocations = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id);
        const teacherScheduleKeys = teacherAllocations.map(ta => `${ta.classId}_${ta.division}_${ta.subjectId}`);
        
        relevantSchedules = examSchedules.filter(s => 
            s.examId === examId && teacherScheduleKeys.includes(`${s.classId}_${s.division}_${s.subjectId}`)
        );
    }

    if (relevantSchedules.length === 0) {
        container.innerHTML = `<div class="alert alert-warning">No mark entries found for your allocated subjects in this exam.</div>`;
        return;
    }

    // Group schedules by class and division for report generation
    const groupedSchedules = relevantSchedules.reduce((acc, s) => {
        const key = `${s.classId}_${s.division}`;
        if (!acc[key]) {
            acc[key] = { classId: s.classId, division: s.division, schedules: [] };
        }
        acc[key].schedules.push(s);
        return acc;
    }, {});

    // Clear container and render a table for each group
    container.innerHTML = '';
    for (const key in groupedSchedules) {
        const group = groupedSchedules[key];
        renderDetailedMarkEntryTable(container, examId, group.classId, group.division, group.schedules);
    }
}

/**
 * Renders a single detailed mark entry table for a specific class/division.
 * @param {HTMLElement} container - The parent container to append the report to.
 * @param {string} examId
 * @param {string} classId
 * @param {string} division
 * @param {Array} schedulesForClass - The filtered schedule objects for this class.
 */
function renderDetailedMarkEntryTableDetailed(container, examId, classId, division, schedulesForClass) {
    const studentsInClass = students.filter(s => s.classId === classId && s.division === division);
    if (studentsInClass.length === 0) return;

    const className = classes.find(c => c.id === classId)?.name || 'N/A';
    const subjectHeaders = schedulesForClass.map(s => subjects.find(sub => sub.id === s.subjectId)).filter(Boolean);

    let tableHTML = `<h4 class="mt-4">Class: ${className} - ${division}</h4>
                     <div class="table-responsive">
                       <table class="table table-bordered table-sm">
                         <thead class="table-light">
                           <tr>
                             <th rowspan="2">Student Name</th>`;
    subjectHeaders.forEach(sub => {
        tableHTML += `<th colspan="2" class="text-center">${sub.name}</th>`;
    });
    tableHTML += `</tr><tr>`;
    subjectHeaders.forEach(sub => {
        const schedule = schedulesForClass.find(s => s.subjectId === sub.id);
        tableHTML += `<th class="text-center">TE / ${schedule.maxTE || 0}</th><th class="text-center">CE / ${schedule.maxCE || 0}</th>`;
    });
    tableHTML += `</tr></thead><tbody>`;

    studentsInClass.forEach(student => {
        tableHTML += `<tr><td>${student.name}</td>`;
        subjectHeaders.forEach(subject => {
            const mark = marks.find(m => m.examId === examId && m.studentId === student.id && m.subjectId === subject.id);
            const teMark = mark?.te ?? '-';
            const ceMark = mark?.ce ?? '-';
            tableHTML += `<td class="text-center ${teMark === 'AB' ? 'absent-mark' : ''}">${teMark}</td>
                          <td class="text-center ${ceMark === 'AB' ? 'absent-mark' : ''}">${ceMark}</td>`;
        });
        tableHTML += `</tr>`;
    });
    
    tableHTML += `</tbody></table></div>`;
    container.insertAdjacentHTML('beforeend', tableHTML);
}

// Reverted and enhanced version of renderExamScheduleTab
function renderExamScheduleTab() {
    const container = document.getElementById('schedule');
    if (!container) return;

    // Conditionally generate class options based on user role
    let classOptions = '';
    if (currentUserRole === 'teacher') {
        const teacherAllocations = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id);
        const uniqueClassIds = [...new Set(teacherAllocations.map(a => a.classId))];
        classOptions = uniqueClassIds.map(classId => {
            const c = classes.find(cls => cls.id === classId);
            return c ? `<option value="${c.id}">${c.name}</option>` : '';
        }).join('');
    } else { // For admin
        classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    container.innerHTML = `
        <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
            <div class="col-md-4"><label class="form-label fw-bold">Exam</label><select id="sched-exam" class="form-select">${exams.map(ex=>`<option value="${ex.id}">${ex.name}</option>`).join('')}</select></div>
            <div class="col-md-4"><label class="form-label fw-bold">Class</label><select id="sched-class" class="form-select">${classOptions}</select></div>
            <div class="col-md-4">
                <label class="form-label fw-bold">Divisions (select one or more)</label>
                <div id="sched-division-checkboxes" class="border rounded p-2" style="max-height: 120px; overflow-y: auto;"></div>
            </div>
        </div>
        <div id="schedule-sheet">
            <p class="text-center p-5 text-muted">Please select an exam, class, and at least one division to create the schedule.</p>
        </div>`;
    
    const examSelect = document.getElementById('sched-exam');
    const classSelect = document.getElementById('sched-class');
    const divisionContainer = document.getElementById('sched-division-checkboxes');

    const updateScheduleView = () => {
        const classId = classSelect.value;
        const selectedDivisions = Array.from(divisionContainer.querySelectorAll('input:checked')).map(cb => cb.value);
        const examId = examSelect.value;
        if (classId && selectedDivisions.length > 0 && examId) {
            loadScheduleSheet(examId, classId, selectedDivisions);
        } else {
            document.getElementById('schedule-sheet').innerHTML = `<p class="text-center p-5 text-muted">Please select an exam, class, and at least one division.</p>`;
        }
    };

    // This event listener now filters divisions based on teacher's allocation
    classSelect.addEventListener('change', () => {
        const selectedClassId = classSelect.value;
        divisionContainer.innerHTML = '';
        let divisionsToShow = [];

        if (currentUserRole === 'teacher') {
            const teacherAllocationsForClass = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id && cs.classId === selectedClassId);
            divisionsToShow = [...new Set(teacherAllocationsForClass.map(a => a.division))];
        } else { // For admin
            const cls = classes.find(c => c.id === selectedClassId);
            if (cls) divisionsToShow = cls.divisions;
        }
        
        divisionsToShow.forEach(d => {
            divisionContainer.innerHTML += `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${d}" id="div_${d}">
                    <label class="form-check-label" for="div_${d}">${d}</label>
                </div>`;
        });
        updateScheduleView();
    });

    divisionContainer.addEventListener('change', updateScheduleView);
    examSelect.addEventListener('change', updateScheduleView);
    
    // Initial population of divisions for the first class
    if (classSelect.options.length > 0) {
        classSelect.dispatchEvent(new Event('change'));
    } else if (currentUserRole === 'teacher') {
        // Display a message if the teacher has no classes assigned
        document.getElementById('schedule-sheet').innerHTML = `<p class="text-center p-5 text-muted">You have no classes allocated to schedule exams.</p>`;
    }
}

// Reverted and enhanced version of loadScheduleSheet
async function loadScheduleSheet(examId, classId, divisions) {
    const container = document.getElementById('schedule-sheet');
    container.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div></div>`;

    const selectedExam = exams.find(ex => ex.id === examId);

    // --- NEW: Role-based filtering logic ---
    const subjectIds = new Set();
    let relevantSubjects;

    // Check if the user is an admin or has the 'exam_controller' role
    const isAdminOrController = currentUserRole === 'admin' || (currentUserRole === 'teacher' && selectedUser.roles && selectedUser.roles.includes('exam_controller'));

    if (isAdminOrController) {
        // Admins/Controllers see all subjects for the selected class and division(s)
        relevantSubjects = classroomSubjects.filter(cs =>
            cs.classId === classId && divisions.includes(cs.division)
        );
    } else {
        // Teachers only see subjects they are personally allocated to
        relevantSubjects = classroomSubjects.filter(cs =>
            cs.classId === classId &&
            cs.teacherId === selectedUser.id &&
            divisions.includes(cs.division)
        );
    }

    relevantSubjects.forEach(cs => subjectIds.add(cs.subjectId));
    // --- End of new logic ---

    const allocatedSubjects = Array.from(subjectIds).map(id => subjects.find(s => s.id === id)).filter(Boolean);

    if (allocatedSubjects.length === 0) {
        container.innerHTML = `<div class="alert alert-warning">No subjects are allocated for this class/division combination that match your permissions.</div>`;
        return;
    }

    const existingSchedules = examSchedules.filter(s => s.examId === examId && s.classId === classId && s.division === divisions[0]);

    let tableHTML = `
        <p class="text-muted">Enter schedule details. This will apply to all selected divisions: <strong>${divisions.join(', ')}</strong>.</p>
        <div class="table-responsive">
            <table id="schedule-table" class="table table-bordered table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Subject</th>
                        <th>Exam Date</th>
                        <th>Session (FN/AN)</th>
                        <th>Max Marks (Theory)</th>
                        <th>Max Marks (Internal)</th>
                    </tr>
                </thead>
                <tbody>`;
    
    allocatedSubjects.forEach(subject => {
        if (selectedExam?.sector && subject?.sector && selectedExam.sector !== subject.sector) {
            return;
        }

        const schedule = existingSchedules.find(es => es.subjectId === subject.id);
        tableHTML += `<tr data-subject-id="${subject.id}">
            <td class="fw-bold">${subject.name}</td>
            <td><input type="date" name="date" value="${schedule?.date || ''}" class="form-control form-control-sm"></td>
            <td>
                <select name="session" class="form-select form-select-sm">
                    <option value="">--</option>
                    <option value="FN" ${schedule?.session === 'FN' ? 'selected' : ''}>FN</option>
                    <option value="AN" ${schedule?.session === 'AN' ? 'selected' : ''}>AN</option>
                </select>
            </td>
            <td><input type="number" name="maxTE" value="${schedule?.maxTE || ''}" placeholder="e.g., 80" class="form-control form-control-sm"></td>
            <td><input type="number" name="maxCE" value="${schedule?.maxCE || ''}" placeholder="e.g., 20" class="form-control form-control-sm"></td>
        </tr>`;
    });

    tableHTML += `</tbody></table></div><div class="text-end mt-3"><button id="save-schedule-btn" class="btn btn-success">Save for All Selected Divisions</button></div>`;
    container.innerHTML = tableHTML;
    document.getElementById('save-schedule-btn').addEventListener('click', () => saveExamSchedule(examId, classId, divisions));
}

// Reverted and enhanced version of saveExamSchedule
async function saveExamSchedule(examId, classId, divisions) {
    const batch = writeBatch(db);
    const scheduleRows = document.querySelectorAll('#schedule-table tbody tr');
    let hasDataToSave = false;

    scheduleRows.forEach(row => {
        const subjectId = row.dataset.subjectId;
        const date = row.querySelector('input[name="date"]').value;
        
        if (subjectId && date) {
            hasDataToSave = true;
            const subjectScheduleData = {
                examId,
                classId,
                subjectId,
                date: date,
                session: row.querySelector('select[name="session"]').value,
                maxTE: parseInt(row.querySelector('input[name="maxTE"]').value) || 0,
                maxCE: parseInt(row.querySelector('input[name="maxCE"]').value) || 0,
            };

            // Apply this schedule to all selected divisions
            divisions.forEach(division => {
                const scheduleId = `${examId}_${classId}_${division}_${subjectId}`;
                const scheduleRef = getDocRef('examSchedules', scheduleId);
                batch.set(scheduleRef, { ...subjectScheduleData, division, id: scheduleId });
            });
        }
    });

    if (hasDataToSave) {
        await batch.commit();
        showAlert(`Schedule saved successfully for divisions: ${divisions.join(', ')}!`, 'success');
    } else {
        showAlert('No schedule data entered to save.', 'warning');
    }
}

// Updated to work with the new (old) schedule structure
function renderExamTimetableView() {
    const container = document.getElementById('timetable-view');
    if (!container) return;

    container.innerHTML = `
        <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
            <div class="col-md-4"><label class="form-label fw-bold">Exam</label><select id="tt-view-exam" class="form-select">${exams.map(ex=>`<option value="${ex.id}">${ex.name}</option>`).join('')}</select></div>
            <div class="col-md-4"><label class="form-label fw-bold">Class</label><select id="tt-view-class" class="form-select">${classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
        </div>
        <div id="timetable-display-container"></div>
    `;

    const examSelect = document.getElementById('tt-view-exam');
    const classSelect = document.getElementById('tt-view-class');

    const displayTimetable = () => {
        const examId = examSelect.value;
        const classId = classSelect.value;
        if (examId && classId) {
            const classData = classes.find(c => c.id === classId);
            const divisions = classData ? classData.divisions : [];
            const schedules = examSchedules.filter(s => s.examId === examId && s.classId === classId);
            const displayContainer = document.getElementById('timetable-display-container');
            
            let html = '';
            divisions.forEach(division => {
                const divSchedules = schedules.filter(s => s.division === division)
                    .sort((a, b) => new Date(a.date) - new Date(b.date) || a.session.localeCompare(b.session));
                
                html += `<h4 class="mt-4">Timetable for ${classData.name} - ${division}</h4>`;
                if (divSchedules.length === 0) {
                    html += `<p class="text-muted">No schedule published for this division.</p>`;
                    return;
                }

                html += `<table class="table table-striped table-bordered">
                    <thead class="table-light"><tr><th>Date</th><th>Session</th><th>Subject</th></tr></thead>
                    <tbody>`;
                divSchedules.forEach(s => {
                    const subject = subjects.find(sub => sub.id === s.subjectId);
                    html += `<tr>
                        <td>${new Date(s.date).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</td>
                        <td>${s.session || 'N/A'}</td>
                        <td class="fw-bold">${subject ? subject.name : 'Unknown'}</td>
                    </tr>`;
                });
                html += `</tbody></table>`;
            });
            displayContainer.innerHTML = html;
        }
    };
    
    examSelect.addEventListener('change', displayTimetable);
    classSelect.addEventListener('change', displayTimetable);
    if (exams.length > 0 && classes.length > 0) displayTimetable();
}

// --- RESULTS TAB OVERHAUL ---

function renderResultsTab() {
    const container = document.getElementById('results');
    container.innerHTML = `
        <div class="d-flex justify-content-end align-items-center p-3 bg-light border rounded mb-3">
            <label class="form-label me-2 mb-0 fw-bold">Active Grading System:</label>
            <select id="shared-grading-system" class="form-select form-select-sm w-auto">
                <option value="type1">A+, A, B+, B...</option>
                <option value="type2">O, A, B, C...</option>
            </select>
        </div>

        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-ranklist" type="button">Class Rank List</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-reportcard" type="button">Student Report Card</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-exam-wise" type="button">Exam-wise Report</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-subject-wise" type="button">Subject-wise Analysis</button></li>
        </ul>
        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade" id="pills-ranklist" role="tabpanel"></div>
            <div class="tab-pane fade" id="pills-reportcard" role="tabpanel"></div>
            <div class="tab-pane fade show active" id="pills-exam-wise" role="tabpanel"></div>
            <div class="tab-pane fade" id="pills-subject-wise" role="tabpanel"></div>
        </div>`;
        
    renderExamWiseResultView();
    renderSubjectWiseResultView();
    renderRankListTab();
    renderReportCardTab();
}

// ----------------------------------------------------------------------------------
        // --- EXAM-WISE & SUBJECT-WISE RESULTS (ENHANCED) ---
        // ----------------------------------------------------------------------------------

        /**
         * Renders the UI for the "Exam-wise Report" tab, with dropdowns filtered for teachers.
         */
        function renderExamWiseResultView() {
            const container = document.getElementById('pills-exam-wise');
            let classOptions = '';

            // Filter classes for teachers, show all for admins
            if (currentUserRole === 'teacher') {
                const teacherAllocations = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id);
                const uniqueClassIds = [...new Set(teacherAllocations.map(a => a.classId))];
                classOptions = uniqueClassIds.map(classId => {
                    const c = classes.find(cls => cls.id === classId);
                    return c ? `<option value="${c.id}">${c.name}</option>` : '';
                }).join('');
            } else {
                classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }

            container.innerHTML = `
        <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
            <div class="col-md-3"><label class="form-label">Exam</label><select id="res-exam" class="form-select">${exams.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}</select></div>
            <div class="col-md-3"><label class="form-label">Class</label><select id="res-class" class="form-select">${classOptions}</select></div>
            <div class="col-md-3"><label class="form-label">Division</label><select id="res-division" class="form-select"></select></div>
            <div class="col-md-3">
                <label class="form-label">Sort By</label>
                <select id="ew-sort-by" class="form-select">
                    <option value="rank">Rank (Highest First)</option>
                    <option value="name">Alphabetical</option>
                </select>
            </div>
        </div>

        <div class="text-end my-3">
            <button id="print-exam-report-btn" class="btn btn-secondary" disabled>
                <i class="fas fa-print me-2"></i>Print Report
            </button>
        </div>

        <div id="printable-exam-report">
            <div id="exam-wise-chart-container" class="mb-4" style="height: 300px;">
                 <canvas id="exam-wise-performance-canvas"></canvas>
            </div>
            <div id="exam-wise-results-container" class="table-responsive"></div>
        </div>
        `;

    const examSelect = document.getElementById('res-exam');
    const classSelect = document.getElementById('res-class');
    const divisionSelect = document.getElementById('res-division');
    const sortBySelect = document.getElementById('ew-sort-by');
    const printBtn = document.getElementById('print-exam-report-btn');

    const generateTable = () => {
        const examId = examSelect.value;
        const classId = classSelect.value;
        const division = divisionSelect.value;
        if (examId && classId && division) {
            generateExamWiseResultsTable(examId, classId, division);
            printBtn.disabled = false; // Enable print button after report generates
        } else {
            printBtn.disabled = true;
        }
    };
    
    // Attach event listeners
    [examSelect, classSelect, divisionSelect, sortBySelect].forEach(el => el.addEventListener('change', generateTable));
    
    printBtn.addEventListener('click', () => {
        const examName = examSelect.options[examSelect.selectedIndex].text;
        const className = classSelect.options[classSelect.selectedIndex].text;
        const divisionName = divisionSelect.value;
        const reportTitle = `${examName} - Results`;
        const reportSubtitle = `Class: ${className} - ${divisionName} (${activeFinancialYear})`;
        
        printReportWithChart('printable-exam-report', 'exam-wise-performance-canvas', reportTitle, reportSubtitle);
    });


            // This listener now correctly filters divisions based on the teacher's allocations
            classSelect.addEventListener('change', () => {
                const selectedClassId = classSelect.value;
                let divisionOptionsHTML = '';
                if (currentUserRole === 'teacher') {
                    const teacherAllocationsForClass = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id && cs.classId === selectedClassId);
                    const uniqueDivisions = [...new Set(teacherAllocationsForClass.map(a => a.division))];
                    divisionOptionsHTML = uniqueDivisions.map(d => `<option value="${d}">${d}</option>`).join('');
                } else {
                    const cls = classes.find(c => c.id === selectedClassId);
                    divisionOptionsHTML = cls ? cls.divisions.map(d => `<option value="${d}">${d}</option>`).join('') : '';
                }
                divisionSelect.innerHTML = divisionOptionsHTML;
                generateTable();
            });

            examSelect.addEventListener('change', generateTable);
            divisionSelect.addEventListener('change', generateTable);
            
            if (classSelect.options.length > 0) {
                classSelect.dispatchEvent(new Event('change'));
            } else {
                 container.querySelector('#exam-wise-results-container').innerHTML = `<p class="text-muted p-5 text-center">No classes allocated to this teacher.</p>`;
            }
        }

        /**
 * Main controller function for the Exam-wise Report.
 * It fetches filter values and orchestrates data processing and rendering.
 * @param {string} examId
 * @param {string} classId
 * @param {string} division
 */

 /**
 * Creates a print-friendly view of a container, converting a canvas chart to an image.
 * @param {string} printableAreaId - The ID of the div that contains all content to print.
 * @param {string} canvasId - The ID of the canvas element to convert to an image.
 * @param {string} reportTitle - The main title for the printed report.
 * @param {string} reportSubtitle - The subtitle for the printed report.
 */
function printReportWithChart(printableAreaId, canvasId, reportTitle, reportSubtitle) {
    const printableArea = document.getElementById(printableAreaId);
    const canvas = document.getElementById(canvasId);
    if (!printableArea || !canvas) {
        showAlert('Report content not found for printing.', 'danger');
        return;
    }

    // Convert the canvas to a static image
    const chartImageURL = canvas.toDataURL('image/png', 1.0);

    // Clone the printable content to avoid modifying the live page
    const contentToPrint = printableArea.cloneNode(true);
    
    // Replace the canvas in the cloned content with the image
    const canvasInClone = contentToPrint.querySelector('#' + canvasId);
    if (canvasInClone) {
        const chartImage = document.createElement('img');
        chartImage.src = chartImageURL;
        chartImage.style.maxWidth = '100%';
        chartImage.style.height = 'auto';
        canvasInClone.parentNode.replaceChild(chartImage, canvasInClone);
    }
    
    // Create a new window for printing
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>${reportTitle}</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    body { font-family: 'Inter', sans-serif; padding: 20px; }
                    @page { 
                        size: A4 landscape; 
                        margin: 1cm; 
                    }

                    .table { font-size: 0.75rem; } /* Slightly smaller for landscape */
                    .table th, .table td { padding: 0.1rem; vertical-align: middle; }
                    .report-header { text-align: center; margin-bottom: 1.5rem; border-bottom: 1px solid #dee2e6; padding-bottom: 1rem; }
                    img { page-break-inside: avoid; } /* Prevent chart image from splitting across pages */
                </style>

            </head>
            <body>
                <div class="report-header">
                    <h4>${schoolDetails.name || 'School Management Pro'}</h4>
                    <h3>${reportTitle}</h3>
                    <p class="text-muted mb-0">${reportSubtitle}</p>
                </div>
                ${contentToPrint.innerHTML}
            </body>
        </html>
    `);

    printWindow.document.close();
    setTimeout(() => { // Timeout to ensure content and styles are loaded
        printWindow.focus();
        printWindow.print();
    }, 500);
}
async function generateExamWiseResultsTable(examId, classId, division) {
    const container = document.getElementById('exam-wise-results-container');
    if (!container) return; // Guard clause

    const schedulesForClass = examSchedules.filter(s => s.examId === examId && s.classId === classId && s.division === division);
    if (schedulesForClass.length === 0) {
        container.innerHTML = '<p class="text-muted p-5 text-center">Exam schedule not found for this selection.</p>';
        document.getElementById('exam-wise-chart-container').innerHTML = '<canvas id="exam-wise-performance-canvas"></canvas>';
        return;
    }

    // 1. Get configuration and filter data
    const gradingSystem = document.getElementById('shared-grading-system').value;
    const sortBy = document.getElementById('ew-sort-by').value;
    const studentsInClass = students.filter(s => s.classId === classId && s.division === division);
    const subjectHeaders = schedulesForClass.map(s => subjects.find(sub => sub.id === s.subjectId)).filter(Boolean);

    // 2. Process the raw data to get calculated results
    let resultsData = processExamResultsData(studentsInClass, schedulesForClass, marks, examId, gradingSystem);

    // 3. Sort the processed data
    resultsData.sort((a, b) => {
        if (sortBy === 'name') return a.studentName.localeCompare(b.studentName);
        if (a.finalStatus === 'PASS' && b.finalStatus === 'FAIL') return -1;
        if (a.finalStatus === 'FAIL' && b.finalStatus === 'PASS') return 1;
        return b.grandTotalMarks - a.grandTotalMarks;
    });

    // 4. Render the final table and chart
    container.innerHTML = renderExamResultsTable(resultsData, subjectHeaders);
    renderExamWisePerformanceChart(resultsData, gradingSystem, subjectHeaders);
}

/**
 * Processes raw data to calculate marks, totals, and grades for each student.
 * @param {Array} studentsInClass
 * @param {Array} schedules
 * @param {Array} allMarks
 * @param {string} examId
 * @param {string} gradingSystem
 * @returns {Array} A new array with calculated results for each student.
 */
function processExamResultsData(studentsInClass, schedules, allMarks, examId, gradingSystem) {
    const subjectHeaders = schedules.map(s => subjects.find(sub => sub.id === s.subjectId)).filter(Boolean);

    return studentsInClass.map(student => {
        let grandTotalMarks = 0;
        let grandMaxMarks = 0;
        let finalStatus = 'PASS';
        let subjectResults = [];

        subjectHeaders.forEach(subject => {
            const schedule = schedules.find(s => s.subjectId === subject.id);
            const maxTE = schedule?.maxTE || 0;
            const maxCE = schedule?.maxCE || 0;
            const maxTotal = maxTE + maxCE;
            const mark = allMarks.find(m => m.examId === examId && m.studentId === student.id && m.subjectId === subject.id);
            
            const te = mark?.te ?? 'N/A';
            const ce = mark?.ce ?? 'N/A';
            let total = 'N/A', pct = 'N/A', grade = 'N/A';

            if (te !== 'AB' && te !== 'N/A' && ce !== 'AB' && ce !== 'N/A') {
                total = (Number(te) || 0) + (Number(ce) || 0);
                pct = maxTotal > 0 ? ((total / maxTotal) * 100).toFixed(1) : 0;
                grade = gradingSystem === 'type1' ? calculateGrade(total, maxTotal) : calculateGradeType2(total, maxTotal);
                if (grade === 'E' || grade === 'F') finalStatus = 'FAIL';
                grandTotalMarks += total;
                grandMaxMarks += maxTotal;
            } else {
                finalStatus = 'FAIL';
            }
            subjectResults.push({ te, ce, maxTE, maxCE, total, pct, grade });
        });

        const grandPct = grandMaxMarks > 0 ? ((grandTotalMarks / grandMaxMarks) * 100) : 0;
        return {
            studentName: student.name,
            subjectResults,
            grandTotalMarks,
            grandMaxMarks,
            grandPct,
            finalStatus,
            overallGrade: gradingSystem === 'type1' ? calculateGrade(grandTotalMarks, grandMaxMarks) : calculateGradeType2(grandTotalMarks, grandMaxMarks)
        };
    });
}
/**
 * Renders the HTML table from the processed results data with cleaner headers.
 * @param {Array} resultsData - The processed data with calculated results.
 * @param {Array} subjectHeaders - The subject objects for table headers.
 * @returns {string} The complete HTML string for the results table.
 */
function renderExamResultsTable(resultsData, subjectHeaders) {
    // --- Build Header ---
    let headerHTML = `<thead><tr><th rowspan="2" class="align-middle">Student</th>`;
    
    // Header Row 1: Subject Name + Max Marks
    subjectHeaders.forEach(subject => {
        // Find the schedule to get the max marks for this subject
        const schedule = examSchedules.find(s => s.subjectId === subject.id);
        const maxTE = schedule?.maxTE || 0;
        const maxCE = schedule?.maxCE || 0;
        headerHTML += `<th colspan="4" class="text-center">
                         ${subject.name}
                         <br>
                         <small class="text-muted fw-normal">(Max TE: ${maxTE}, Max CE: ${maxCE})</small>
                       </th>`;
    });
    headerHTML += `<th colspan="3" rowspan="2" class="text-center table-primary align-middle">Grand Total</th></tr>`;

    // Header Row 2: Column Titles (TE, CE, etc.)
    headerHTML += `<tr>`;
    subjectHeaders.forEach(() => {
        headerHTML += `<th>TE/CE</th><th>Total</th><th>%</th><th>Grd</th>`;
    });
    headerHTML += `</tr></thead>`;

    // --- Build Body ---
    let bodyHTML = `<tbody>`;
    let rank = 1;
    resultsData.forEach(res => {
        const currentRank = res.finalStatus === 'PASS' ? rank++ : '-';
        const rowClass = res.finalStatus === 'FAIL' ? 'table-danger' : '';
        bodyHTML += `<tr class="${rowClass}"><td class="text-nowrap">${res.studentName}</td>`;
        
        // Data Rows: Show only the obtained marks
        res.subjectResults.forEach(subRes => {
            const gradeColor = (subRes.grade === 'E' || subRes.grade === 'F') ? 'text-danger fw-bold' : '';
            bodyHTML += `<td class="text-center ${gradeColor}">${subRes.te}/${subRes.ce}</td>
                         <td class="text-center ${gradeColor}">${subRes.total}</td>
                         <td class="text-center ${gradeColor}">${subRes.pct}%</td>
                         <td class="text-center ${gradeColor}">${subRes.grade}</td>`;
        });
        
        bodyHTML += `<td class="table-primary">${res.grandTotalMarks}/${res.grandMaxMarks}</td>
                     <td class="table-primary">${res.grandPct.toFixed(2)}%</td>
                     <td class="table-primary fw-bold">${res.finalStatus} (${currentRank})</td></tr>`;
    });
    bodyHTML += `</tbody>`;

    return `<table class="table table-bordered table-hover table-sm">${headerHTML}${bodyHTML}</table>`;
}

function renderExamWisePerformanceChart(resultsData, gradingSystem, subjects) {
    const canvas = document.getElementById('exam-wise-performance-canvas');
    if (!canvas) return;

    // Safely destroy any previous chart instance
    try {
        const existingChart = Chart.getChart(canvas);
        if (existingChart) existingChart.destroy();
    } catch (e) {}

    // Define a consistent color palette for the subjects
    const colorPalette = [
        'rgba(54, 162, 235, 0.7)',  // Blue
        'rgba(255, 99, 132, 0.7)',  // Red
        'rgba(75, 192, 192, 0.7)',  // Green
        'rgba(255, 206, 86, 0.7)',  // Yellow
        'rgba(153, 102, 255, 0.7)', // Purple
        'rgba(255, 159, 64, 0.7)',  // Orange
        'rgba(99, 255, 132, 0.7)',  // Lime
        'rgba(255, 99, 255, 0.7)'   // Magenta
    ];

    const gradeScale = gradingSystem === 'type1' 
        ? ['A+', 'A', 'B+', 'B', 'C+', 'C', 'D', 'E', 'AB'] 
        : ['O', 'A', 'B', 'C', 'D', 'E', 'F', 'AB'];

    // Create a new dataset for each subject
    const datasets = subjects.map((subject, index) => {
        const gradeCounts = gradeScale.reduce((acc, grade) => ({ ...acc, [grade]: 0 }), {});

        // Go through each student's results
        resultsData.forEach(studentResult => {
            // Find the result for the current subject
            const subjectResult = studentResult.subjectResults[index];
            if (subjectResult && gradeCounts[subjectResult.grade] !== undefined) {
                gradeCounts[subjectResult.grade]++;
            }
        });

        return {
            label: subject.name,
            data: Object.values(gradeCounts),
            backgroundColor: colorPalette[index % colorPalette.length], // Cycle through colors
        };
    });

    new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: {
            labels: gradeScale,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { stacked: false }, // Group bars by grade
                y: { 
                    stacked: false,
                    beginAtZero: true, 
                    ticks: { stepSize: 1 },
                    title: { display: true, text: 'Number of Students' } 
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Grade Distribution by Subject'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            }
        }
    });
}
        /**
         * Renders the UI for the "Subject-wise Analysis" tab with enhanced filtering and display options.
         */
        function renderSubjectWiseResultView() {
    const container = document.getElementById('pills-subject-wise');
    let classOptions = '';

    // Filter classes for teachers
    if (currentUserRole === 'teacher') {
        const teacherAllocations = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id);
        const uniqueClassIds = [...new Set(teacherAllocations.map(a => a.classId))];
        classOptions = uniqueClassIds.map(classId => {
            const c = classes.find(cls => cls.id === classId);
            return c ? `<option value="${c.id}">${c.name}</option>` : '';
        }).join('');
    } else {
        classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    container.innerHTML = `
        <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
            <div class="col-md-3"><label class="form-label">Class</label><select id="sw-class" class="form-select">${classOptions}</select></div>
            <div class="col-md-2"><label class="form-label">Division</label><select id="sw-division" class="form-select"></select></div>
            <div class="col-md-3"><label class="form-label">Subject</label><select id="sw-subject" class="form-select"></select></div>
            <div class="col-md-4"><label class="form-label">Exams (select multiple)</label><select id="sw-exams" class="form-select" multiple style="height: 100px;">${exams.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}</select></div>
        </div>

        <div class="row g-3 align-items-center mb-3 p-3 bg-light rounded">
            <div class="col-md-3">
                <label class="form-label">Grading System</label>
                <select id="sw-grading-system" class="form-select form-select-sm">
                    <option value="type1">A+, A, B+, B...</option>
                    <option value="type2">O, A, B, C...</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Sort By</label>
                <select id="sw-sort-by" class="form-select form-select-sm">
                    <option value="name">Alphabetical</option>
                    <option value="marks">Marks (Highest First)</option>
                    <option value="gender">Gender</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Color Code Scores</label>
                <select id="sw-color-code" class="form-select form-select-sm">
                    <option value="none">None</option>
                    <option value="fail_only">Fail Only (Red)</option>
                    <option value="full">Full Spectrum</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Display Mode</label>
                <select id="sw-mark-type" class="form-select form-select-sm">
                    <option value="total">Total</option>
                    <option value="te">TE Only</option>
                    <option value="ce">CE Only</option>
                    <option value="both">TE + CE</option>
                </select>
            </div>
        </div>
        <div id="subject-wise-results-container" class="table-responsive"></div>
        
        <div id="subject-wise-chart-container" class="mb-4" style="height: 300px;">
    <canvas id="subject-performance-canvas"></canvas>
</div>`;

    const classSelect = document.getElementById('sw-class');
    const divisionSelect = document.getElementById('sw-division');
    const subjectSelect = document.getElementById('sw-subject');
    const examsSelect = document.getElementById('sw-exams');

    const attachListeners = () => {
        [classSelect, divisionSelect, subjectSelect, examsSelect,
         document.getElementById('sw-grading-system'),
         document.getElementById('sw-sort-by'),
         document.getElementById('sw-color-code'),
         document.getElementById('sw-mark-type')
        ].forEach(el => {
            if (el) el.addEventListener('change', generateSubjectWiseTable);
        });
    };

    classSelect.addEventListener('change', () => {
        const selectedClassId = classSelect.value;
        let divisionOptionsHTML = '';
        if (currentUserRole === 'teacher') {
            const teacherAllocationsForClass = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id && cs.classId === selectedClassId);
            const uniqueDivisions = [...new Set(teacherAllocationsForClass.map(a => a.division))];
            divisionOptionsHTML = uniqueDivisions.map(d => `<option value="${d}">${d}</option>`).join('');
        } else {
            const cls = classes.find(c => c.id === selectedClassId);
            divisionOptionsHTML = cls ? cls.divisions.map(d => `<option value="${d}">${d}</option>`).join('') : '';
        }
        divisionSelect.innerHTML = divisionOptionsHTML;
        divisionSelect.dispatchEvent(new Event('change'));
    });

    divisionSelect.addEventListener('change', () => {
        const classId = classSelect.value;
        const division = divisionSelect.value;
        let subjectOptionsHTML = '';
        let allocated = classroomSubjects.filter(cs => cs.classId === classId && cs.division === division);

        // if (currentUserRole === 'teacher') {
        //     allocated = allocated.filter(cs => cs.teacherId === selectedUser.id);
        // }

        subjectOptionsHTML = allocated.map(a => {
            const subject = subjects.find(s => s.id === a.subjectId);
            return subject ? `<option value="${subject.id}">${subject.name}</option>` : '';
        }).join('');
        subjectSelect.innerHTML = subjectOptionsHTML;
        generateSubjectWiseTable();
    });

    attachListeners();
    if (classSelect.options.length > 0) {
        classSelect.dispatchEvent(new Event('change'));
    } else {
        container.innerHTML += `<p class="text-muted p-5 text-center">No classes or subjects allocated to this teacher.</p>`;
    }
}

        
        /**
         * New helper function to calculate an alternate grading scale.
         */
        function calculateGradeType2(score, maxScore) {
            if (score === 'AB') return 'AB';
            if (maxScore === 0) return '-';
            const percentage = (score / maxScore) * 100;
            if (percentage >= 90) return 'O'; // Outstanding
            if (percentage >= 80) return 'A';
            if (percentage >= 70) return 'B';
            if (percentage >= 60) return 'C';
            if (percentage >= 50) return 'D';
            if (percentage >= 35) return 'E';
            return 'F'; // Fail
        }
        
        /**
         * New helper function to apply CSS classes for color coding.
         */
        function getColorClass(score, maxScore, colorSystem) {
            if (colorSystem === 'none' || score === 'AB' || maxScore === 0) return '';
            const percentage = (score / maxScore) * 100;
            if (percentage < 35) return 'text-danger fw-bold';
            if (colorSystem === 'full') {
                 if (percentage >= 90) return 'text-success fw-bold';
                 if (percentage >= 80) return 'text-primary';
            }
            return '';
        }

       // Enhanced Subject-Wise Result View with Separate TE, CE, Total, Grade, Rank, Graph, and Filters

/**
 * Generates and displays the detailed subject-wise results table and performance chart.
 * This version features a cleaner, two-row header for exam marks.
 */
function generateSubjectWiseTable() {
    // --- Guard Clause to ensure elements exist ---
    const container = document.getElementById('subject-wise-results-container');
    const chartContainer = document.getElementById('subject-wise-chart-container');
    if (!container || !chartContainer) {
        return;
    }

    // --- Get Filter Values ---
    const classId = document.getElementById('sw-class').value;
    const division = document.getElementById('sw-division').value;
    const subjectId = document.getElementById('sw-subject').value;
    const selectedExamIds = Array.from(document.getElementById('sw-exams').selectedOptions).map(opt => opt.value);
    const gradingSystem = document.getElementById('shared-grading-system').value; // Using shared selector
    const sortBy = document.getElementById('sw-sort-by').value;
    const displayMode = document.getElementById('sw-mark-type').value;

    if (!classId || !division || !subjectId || selectedExamIds.length === 0) {
        container.innerHTML = '<p class="text-muted p-5 text-center">Please select a class, division, subject, and at least one exam.</p>';
        chartContainer.innerHTML = '<canvas id="subject-performance-canvas"></canvas>';
        return;
    }

    // --- Process Data (This logic remains the same) ---
    const studentsInClass = students.filter(s => s.classId === classId && s.division === division);
    const selectedExams = selectedExamIds.map(id => exams.find(e => e.id === id)).filter(Boolean);
    const results = processSubjectWiseResults(studentsInClass, selectedExams, subjectId, gradingSystem);

    // --- Sorting (This logic remains the same) ---
    if (sortBy === 'name') {
        results.sort((a, b) => a.student.name.localeCompare(b.student.name));
    } else if (sortBy === 'gender') {
        results.sort((a, b) => (a.student.gender || '').localeCompare(b.student.gender || ''));
    } else {
        results.sort((a, b) => b.totalSum - a.totalSum);
    }
    results.forEach((res, i) => res.rank = i + 1);

    // --- NEW: Render Table with Improved Headers ---
    container.innerHTML = renderSubjectWiseTableHTML(results, selectedExams, displayMode, subjectId);

    // --- Render Chart (This call remains the same) ---
    renderSubjectPerformanceChart(results, selectedExams, gradingSystem, subjectId);
}

/**
 * Helper function to generate the HTML for the subject-wise results table.
 * @param {Array} results - The processed and sorted results data.
 * @param {Array} selectedExams - The selected exam objects.
 * @param {string} displayMode - The selected display mode (e.g., 'total', 'both').
 * @param {string} subjectId - The ID of the subject being analyzed.
 * @returns {string} The complete HTML string for the table.
 */
function renderSubjectWiseTableHTML(results, selectedExams, displayMode, subjectId) {
    // --- Header Row 1: Exam Names ---
    let headerRow1 = `<thead>
                        <tr>
                            <th rowspan="2" class="align-middle">Rank</th>
                            <th rowspan="2" class="align-middle">Name</th>`;
    selectedExams.forEach(exam => {
        // --- MODIFIED: Colspan for 'both' mode is now 4 ---
        const colspan = displayMode === 'both' ? 4 : 3;
        headerRow1 += `<th colspan="${colspan}" class="text-center">${exam.name}</th>`;
    });
    headerRow1 += `<th rowspan="2" class="align-middle">Total</th>
                   <th rowspan="2" class="align-middle">Overall %</th>
                 </tr>`;

    // --- Header Row 2: Sub-columns (TE, CE, etc.) ---
    let headerRow2 = `<tr>`;
    selectedExams.forEach(exam => {
        const schedule = examSchedules.find(s => s.examId === exam.id && s.subjectId === subjectId);
        const maxTE = schedule?.maxTE || 0;
        const maxCE = schedule?.maxCE || 0;
        const maxTotal = maxTE + maxCE;

        if (displayMode === 'te') headerRow2 += `<th>TE / ${maxTE}</th>`;
        else if (displayMode === 'ce') headerRow2 += `<th>CE / ${maxCE}</th>`;
        else if (displayMode === 'total') headerRow2 += `<th>Total / ${maxTotal}</th>`;
        // --- MODIFIED: New headers for 'both' mode ---
        else if (displayMode === 'both') {
            headerRow2 += `<th>TE / CE</th><th>Total / ${maxTotal}</th>`;
        }
        headerRow2 += `<th>%</th><th>Grade</th>`;
    });
    headerRow2 += `</tr></thead>`;

    // --- Table Body ---
    let bodyHTML = `<tbody>`;
    results.forEach(res => {
        bodyHTML += `<tr>
                        <td>${res.rank}</td>
                        <td class="text-nowrap">${res.student.name}</td>`;
        selectedExams.forEach(exam => {
            const data = res.markData[exam.id];
            if (data) {
                const gradeColor = (data.grade === 'E' || data.grade === 'F') ? 'text-danger fw-bold' : '';
                if (displayMode === 'te') bodyHTML += `<td class="text-center ${gradeColor}">${data.te}</td>`;
                else if (displayMode === 'ce') bodyHTML += `<td class="text-center ${gradeColor}">${data.ce}</td>`;
                else if (displayMode === 'total') bodyHTML += `<td class="text-center ${gradeColor}">${data.total}</td>`;
                // --- MODIFIED: New data cells for 'both' mode ---
                else if (displayMode === 'both') {
                    bodyHTML += `<td class="text-center ${gradeColor}">${data.te} / ${data.ce}</td>
                                 <td class="text-center ${gradeColor}">${data.total}</td>`;
                }
                bodyHTML += `<td class="text-center ${gradeColor}">${data.percent === 'AB' ? 'AB' : data.percent.toFixed(1)}%</td>
                             <td class="text-center ${gradeColor}">${data.grade}</td>`;
            } else {
                // --- MODIFIED: Colspan for 'N/A' cells is now 4 for 'both' mode ---
                const colspan = displayMode === 'both' ? 4 : 3;
                bodyHTML += `<td colspan="${colspan}" class="text-muted text-center">N/A</td>`;
            }
        });
        bodyHTML += `<td class="fw-bold">${res.totalSum}</td>
                     <td class="fw-bold">${res.avgPercent.toFixed(1)}%</td>
                   </tr>`;
    });
    bodyHTML += `</tbody>`;

    return `<table class="table table-bordered table-sm">${headerRow1}${headerRow2}${bodyHTML}</table>`;
}


/**
 * Helper function to process raw data for the subject-wise table.
 * (This function is created by extracting the logic from the original generateSubjectWiseTable)
 */
function processSubjectWiseResults(studentsInClass, selectedExams, subjectId, gradingSystem) {
    return studentsInClass.map(student => {
        const markData = {};
        let totalSum = 0;
        let totalMax = 0;
        selectedExams.forEach(exam => {
            const schedule = examSchedules.find(s => s.examId === exam.id && s.subjectId === subjectId);
            const mark = marks.find(m => m.examId === exam.id && m.studentId === student.id && m.subjectId === subjectId);
            if (schedule && mark) {
                const te = mark.te === 'AB' ? 'AB' : Number(mark.te || 0);
                const ce = mark.ce === 'AB' ? 'AB' : Number(mark.ce || 0);
                const total = te === 'AB' || ce === 'AB' ? 'AB' : te + ce;
                const max = (schedule.maxTE || 0) + (schedule.maxCE || 0);
                const percent = total === 'AB' || max === 0 ? 'AB' : (total / max) * 100;
                const grade = total === 'AB' ? 'AB' : (gradingSystem === 'type1' ? calculateGrade(total, max) : calculateGradeType2(total, max));
                markData[exam.id] = { te, ce, total, percent, grade, max };
                if (total !== 'AB') {
                    totalSum += total;
                    totalMax += max;
                }
            } else {
                markData[exam.id] = null;
            }
        });
        const avgPercent = totalMax > 0 ? (totalSum / totalMax) * 100 : 0;
        return { student, markData, totalSum, avgPercent };
    });
}

        /**
         * New function to render a bar chart for subject performance.
         */
        /**
 * New function to render a bar chart for subject performance.
 */
function renderSubjectPerformanceChart(resultsData, exams, gradingSystem, subjectId) {
    const chartContainer = document.getElementById('subject-wise-chart-container');
    const canvas = document.getElementById('subject-performance-canvas');
    if (!canvas || !chartContainer) return; // Exit if elements aren't found

    // Safely destroy any existing chart instance on the canvas
    try {
        const existingChart = Chart.getChart(canvas);
        if (existingChart) {
            existingChart.destroy();
        }
    } catch (e) {
        // This catch block prevents errors if the canvas had no chart
    }

    if (resultsData.length === 0 || exams.length === 0) {
        chartContainer.innerHTML = '<canvas id="subject-performance-canvas"></canvas>'; // Keep canvas for next render
        return;
    }

    // Predefined, professional color palette
    const colorPalette = [
        'rgba(54, 162, 235, 0.6)', // Blue
        'rgba(255, 99, 132, 0.6)', // Red
        'rgba(75, 192, 192, 0.6)', // Green
        'rgba(255, 206, 86, 0.6)', // Yellow
        'rgba(153, 102, 255, 0.6)',// Purple
        'rgba(255, 159, 64, 0.6)' // Orange
    ];

    const gradeScale = gradingSystem === 'type1' ? ['A+', 'A', 'B+', 'B', 'C+', 'C', 'D', 'E', 'AB'] : ['O', 'A', 'B', 'C', 'D', 'E', 'F', 'AB'];
    
    const datasets = exams.map((exam, index) => {
        const gradeCounts = gradeScale.reduce((acc, grade) => ({ ...acc, [grade]: 0 }), {});
        
        // Find the schedule once per exam, not for every student
        const schedule = examSchedules.find(s => s.examId === exam.id && s.subjectId === subjectId);

        if (schedule) {
            resultsData.forEach(res => {
                const mark = marks.find(m => m.examId === exam.id && m.studentId === res.student.id && m.subjectId === subjectId);
                if (mark) {
                    const score = (mark.te === 'AB' || mark.ce === 'AB') ? 'AB' : (mark.te || 0) + (mark.ce || 0);
                    const grade = gradingSystem === 'type1' ? calculateGrade(score, schedule.maxTE + schedule.maxCE) : calculateGradeType2(score, schedule.maxTE + schedule.maxCE);
                    if (gradeCounts[grade] !== undefined) {
                        gradeCounts[grade]++;
                    }
                }
            });
        }

        return {
            label: exam.name,
            data: Object.values(gradeCounts),
            backgroundColor: colorPalette[index % colorPalette.length] // Cycle through the color palette
        };
    });

    // Instantiate the new chart on the canvas's 2D context
    new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: {
            labels: gradeScale,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1 // Ensure y-axis only shows whole numbers for student counts
                    },
                    title: { display: true, text: 'Number of Students' }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Grade Distribution Analysis'
                }
            }
        }
    });
}
function copyColumnData(tableId, colIndex) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const rows = table.querySelectorAll('tbody tr');
    const data = Array.from(rows).map(row => row.cells[colIndex]?.textContent || '').join('\n');
    
    // Use the Clipboard API
    navigator.clipboard.writeText(data).then(() => {
        showAlert('Column data copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy text: ', err);
        showAlert('Failed to copy column data.', 'danger');
    });
}
 function renderExamAddTab() {
            const container = document.getElementById('add-exam');
            container.innerHTML = `<div class="row"><div class="col-lg-5"><div class="card"><div class="card-header fw-bold">Add Exam Title</div><div class="card-body"><form id="add-exam-form" class="d-flex gap-2"><input id="exam-sector" class="form-control" placeholder="SECTOR , SCHOOL/MADRASSA" required><input id="exam-name" class="form-control" placeholder="E.G., QUARTERLY EXAM" required><button type="submit" class="btn btn-primary">Add</button></form></div></div></div><div class="col-lg-7"><div class="card"><div class="card-header fw-bold">Existing Exams</div><div class="card-body" id="exams-list"></div></div></div></div>`;
            document.getElementById('add-exam-form').addEventListener('submit', async e => { 
                e.preventDefault(); 
                const examName = document.getElementById('exam-name').value;
                const sector = document.getElementById('exam-sector').value;
                const examid = '2025-26'+examName;
                if(examName) {
                    await setDoc(getDocRef('exams',examid), {id:examid, name: examName ,sector:sector});
                    e.target.reset(); 
                    showAlert('Exam Added', 'success');
                }
            });
            renderExamsList();
        }

        function renderExamsList() {
            const list = document.getElementById('exams-list'); if(!list) return;
            list.innerHTML = exams.length > 0 ? `<ul class="list-group list-group-flush">${exams.map(e => `<li class="list-group-item d-flex justify-content-between align-items-center">${e.name}<button class="btn btn-sm btn-outline-danger" onclick="window.handleDelete('exams', '${e.id}')"><i class="fas fa-trash-alt"></i></button></li>`).join('')}</ul>` : `<p class="text-muted">No exams created.</p>`;
        }
        
        

        function renderMarkEntryTab() {
            const container = document.getElementById('entry');
            let classOptions = '';
            
            // --- MODIFICATION START ---
            // If the user is a teacher, populate classes based on their specific allocations.
            // Otherwise (for admin), show all classes.
            if (currentUserRole === 'teacher') {
                const teacherAllocations = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id);
                const uniqueClassIds = [...new Set(teacherAllocations.map(a => a.classId))];
                classOptions = uniqueClassIds.map(classId => {
                    const c = classes.find(cls => cls.id === classId);
                    return c ? `<option value="${c.id}">${c.name}</option>` : '';
                }).join('');
            } else {
                classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }
            // --- MODIFICATION END ---

            container.innerHTML = `
                <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
                    <div class="col-md-3"><label class="form-label">Exam</label><select id="mark-entry-exam" class="form-select">${exams.map(ex => `<option value="${ex.id}">${ex.name}</option>`).join('')}</select></div>
                    <div class="col-md-3"><label class="form-label">Class</label><select id="mark-entry-class" class="form-select">${classOptions}</select></div>
                    <div class="col-md-3"><label class="form-label">Division</label><select id="mark-entry-division" class="form-select"></select></div>
                    <div class="col-md-3"><label class="form-label">Subject</label><select id="mark-entry-subject" class="form-select" disabled></select></div>
                </div>
                <div id="mark-entry-sheet"></div>
                <div id="mark-entry-summary-container"></div>

                `;
            
            const examSelect = document.getElementById('mark-entry-exam');
            const classSelect = document.getElementById('mark-entry-class');
            const divisionSelect = document.getElementById('mark-entry-division');
            const subjectSelect = document.getElementById('mark-entry-subject');
            
            const updateMarkEntryView = () => {
                const examId = examSelect.value;
                const classId = classSelect.value;
                const division = divisionSelect.value;
                const subjectId = subjectSelect.value;
                loadMarkEntrySheet(examId, classId, division, subjectId);
            };

            const populateSubjects = () => {
                const examId = examSelect.value;
                const classId = classSelect.value;
                const division = divisionSelect.value;
                subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>'; 
                subjectSelect.disabled = true;

                if (examId && classId && division) {
                    // Get subjects scheduled for the exam in this class/division
                    let scheduledSubjects = examSchedules.filter(s => s.examId === examId && s.classId === classId && s.division === division);
                    
                    // --- MODIFICATION START ---
                    // If the user is a teacher, further filter subjects to only those they are allocated to
                    if (currentUserRole === 'teacher') {
                        const teacherSubjectIds = classroomSubjects
                            .filter(cs => cs.teacherId === selectedUser.id && cs.classId === classId && cs.division === division)
                            .map(cs => cs.subjectId);
                        
                        scheduledSubjects = scheduledSubjects.filter(s => teacherSubjectIds.includes(s.subjectId));
                    }
                    // --- MODIFICATION END ---

                    if (scheduledSubjects.length > 0) {
                        subjectSelect.innerHTML += scheduledSubjects.map(schedule => {
                            const subjectDetails = subjects.find(sub => sub.id === schedule.subjectId);
                            return subjectDetails ? `<option value="${subjectDetails.id}">${subjectDetails.name}</option>` : '';
                        }).join('');
                        subjectSelect.disabled = false;
                    }
                }else if (examId) {
            // Otherwise, if only an exam is selected, show the summary table
            document.getElementById('mark-entry-summary-container').style.display = 'block';
            document.getElementById('mark-entry-sheet').innerHTML = '';
            renderMarkEntrySummaryTable(examId);
            }

                document.getElementById('mark-entry-sheet').innerHTML = ''; // Clear sheet
            };
            
            // --- MODIFICATION START ---
            // This event listener now populates divisions based on the teacher's allocations for the selected class.
            classSelect.addEventListener('change', () => {
                const selectedClassId = classSelect.value;
                let divisionOptionsHTML = '';
                if (currentUserRole === 'teacher') {
                    const teacherAllocationsForClass = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id && cs.classId === selectedClassId);
                    const uniqueDivisions = [...new Set(teacherAllocationsForClass.map(a => a.division))];
                    divisionOptionsHTML = uniqueDivisions.map(d => `<option value="${d}">${d}</option>`).join('');
                } else {
                    const cls = classes.find(c => c.id === selectedClassId);
                    divisionOptionsHTML = cls ? cls.divisions.map(d => `<option value="${d}">${d}</option>`).join('') : '';
                }
                divisionSelect.innerHTML = divisionOptionsHTML;
                populateSubjects(); // Refresh subjects based on the new division
            });
            // --- MODIFICATION END ---

            divisionSelect.addEventListener('change', populateSubjects);
            examSelect.addEventListener('change', populateSubjects);
            subjectSelect.addEventListener('change', updateMarkEntryView);
            
            // Trigger the change event on the class dropdown to populate divisions and subjects on initial load
            if (classSelect.options.length > 0) {
                 classSelect.dispatchEvent(new Event('change'));
            }
        }

        function loadMarkEntrySheet(examId, classId, division, subjectId) {
            const container = document.getElementById('mark-entry-sheet');
            if (!examId || !classId || !division || !subjectId) { container.innerHTML = `<div class="text-center p-5 text-muted">Please select all filters to enter marks.</div>`; return; }
            
            const schedule = examSchedules.find(s => s.examId === examId && s.classId === classId && s.division === division && s.subjectId === subjectId);
            const maxTE = schedule?.maxTE || 0, maxCE = schedule?.maxCE || 0;
            const studentsInClass = students.filter(s => s.classId === classId && s.division === division).sort((a,b)=>a.name.localeCompare(b.name));
            if (studentsInClass.length === 0) { container.innerHTML = '<div class="alert alert-warning">No students found in this class/division.</div>'; return; }
            
            const existingMarks = marks.filter(m => m.examId === examId && m.subjectId === subjectId);
            // --- ✅ NEW: Calculate Entered and Pending Counts ---
    const enteredStudents = [];
    const notEnteredStudents = [];

    studentsInClass.forEach(student => {
        // A mark is considered "entered" if a record for that student exists in the filtered marks list.
        if (existingMarks.some(m => m.studentId === student.id)) {
            enteredStudents.push(student.name);
        } else {
            notEnteredStudents.push(student.name);
        }
    });

    // --- ✅ NEW: HTML for the summary section ---
    const summaryHTML = `
        <div class="card bg-light p-3 mb-4 border-0">
            <h6 class="fw-bold">Entry Status</h6>
            <div class="d-flex justify-content-around text-center mt-2">
                <div>
                    <h5 class="mb-0">${studentsInClass.length}</h5>
                    <small class="text-muted">Total Students</small>
                </div>
                <div>
                    <h5 class="mb-0 text-success">${enteredStudents.length}</h5>
                    <small class="text-muted">Marks Entered</small>
                </div>
                <div>
                    <h5 class="mb-0 text-danger">${notEnteredStudents.length}</h5>
                    <small class="text-muted">Pending</small>
                </div>
            </div>
            ${notEnteredStudents.length > 0 ? `
            <div class="mt-3">
                <a class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" href="#pending-list-collapse" role="button">
                    Show Pending Student List
                </a>
                <div class="collapse mt-2" id="pending-list-collapse">
                    <ul class="list-group list-group-flush small">
                        ${notEnteredStudents.map(name => `<li class="list-group-item py-1 bg-light">${name}</li>`).join('')}
                    </ul>
                </div>
            </div>` : ''}
        </div>
    `;


            
            let tableHTML = `<div class="table-responsive"><table id="marks-table" class="table table-bordered">
                <thead class="table-light"><tr><th>Student Name</th><th>Admission No.</th><th>Theory / ${maxTE}</th><th>Internal / ${maxCE}</th></tr></thead><tbody>`;
            studentsInClass.forEach(student => {
                const mark = existingMarks.find(m => m.studentId === student.id);
                const teValue = mark?.te === 'AB' ? 'AB' : (mark?.te ?? '');
                const ceValue = mark?.ce === 'AB' ? 'AB' : (mark?.ce ?? '');
                tableHTML += `<tr data-student-id="${student.id}">
                    <td class="fw-bold">${student.name}</td><td>${student.admissionNumber}</td>
                    <td><input type="text" name="te" class="form-control form-control-sm" value="${teValue}" data-max="${maxTE}"></td>
                    <td><input type="text" name="ce" class="form-control form-control-sm" value="${ceValue}" data-max="${maxCE}"></td>
                </tr>`;
            });
            tableHTML += `</tbody></table></div><div class="text-end mt-3"><button id="save-marks-btn" class="btn btn-success">Save Marks</button></div>`;
            container.innerHTML = tableHTML + summaryHTML;

            container.querySelectorAll('input[name="te"], input[name="ce"]').forEach(input => {
                if(input.value.toUpperCase() === 'AB') { input.classList.add('absent-mark'); }
                input.addEventListener('input', (e) => {
                    e.target.classList.remove('absent-mark');
                    if(e.target.value.toUpperCase() === 'AB') { e.target.classList.add('absent-mark'); return; }
                    const maxValue = parseInt(e.target.dataset.max, 10);
                    const currentValue = parseInt(e.target.value, 10);
                    if (!isNaN(currentValue) && currentValue > maxValue) { e.target.value = ''; }
                });
            });
            document.getElementById('save-marks-btn').addEventListener('click', () => saveMarks(examId, classId, division, subjectId));
        }

        async function saveMarks(examId, classId, division, subjectId) {
    const saveButton = document.getElementById('save-marks-btn');
    if (!saveButton) return; // Exit if button isn't found

    // Store original content, then disable button and show loading state
    const originalButtonHtml = saveButton.innerHTML;
    saveButton.disabled = true;
    saveButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...`;

    try {
        const batch = writeBatch(db);
        const markRows = document.querySelectorAll('#marks-table tbody tr');

        markRows.forEach(row => {
            const studentId = row.dataset.studentId;
            const teInput = row.querySelector('input[name="te"]');
            const ceInput = row.querySelector('input[name="ce"]');
            
            // Skip if both inputs are empty
            if (teInput.value.trim() === '' && ceInput.value.trim() === '') {
                return; // continue to next row
            }

            const te = teInput.value.toUpperCase() === 'AB' ? 'AB' : (parseInt(teInput.value) || 0);
            const ce = ceInput.value.toUpperCase() === 'AB' ? 'AB' : (parseInt(ceInput.value) || 0);

            if (studentId) {
                const markId = `${examId}_${studentId}_${subjectId}`;
                const markRef = getDocRef('marks', markId);
                batch.set(markRef, { examId, classId, division, subjectId, studentId, te, ce, lastUpdated: serverTimestamp() });
            }
        });

        await batch.commit();
        showAlert('Marks saved successfully!', 'success');

    } catch (error) {
        console.error("Error saving marks:", error);
        showAlert("Could not save marks. Please check the console.", "danger");
    } finally {
        // This block always runs, ensuring the button is restored
        saveButton.disabled = false;
        saveButton.innerHTML = originalButtonHtml;
    }
}
        
/**
 * Renders a summary table of mark entry status for a given exam across all classes.
 * @param {string} examId The ID of the exam to summarize.
 */
window.  renderMarkEntrySummaryTable = (examId) => {
    const summaryContainer = document.getElementById('mark-entry-summary-container');
    if (!summaryContainer) return;

    if (!examId) {
        summaryContainer.innerHTML = '<p class="text-muted p-5 text-center">Select an exam to view the mark entry status summary.</p>';
        return;
    }

    let summaryData = [];
    
    // Get all unique combinations of class, division, and subject for the selected exam
    const schedulesForExam = examSchedules.filter(s => s.examId === examId);
    
    schedulesForExam.forEach(schedule => {
        const { classId, division, subjectId } = schedule;
        const studentsInClass = students.filter(s => s.classId === classId && s.division === division);
        const totalStudents = studentsInClass.length;

        if (totalStudents === 0) return; // Skip if class has no students

        // Get the count of marks entered for this specific group
        const enteredCount = marks.filter(m => 
            m.examId === examId &&
            m.subjectId === subjectId &&
            studentsInClass.some(s => s.id === m.studentId)
        ).length;
        
        const className = classes.find(c => c.id === classId)?.name || 'N/A';
        const subjectName = subjects.find(sub => sub.id === subjectId)?.name || 'N/A';
        
        summaryData.push({
            className,
            division,
            subjectName,
            total: totalStudents,
            entered: enteredCount,
            pending: totalStudents - enteredCount
        });
    });

    if (summaryData.length === 0) {
        summaryContainer.innerHTML = '<p class="text-muted p-5 text-center">No subjects have been scheduled for this exam.</p>';
        return;
    }

    // Sort the data for a clean presentation
    summaryData.sort((a,b) => (a.className + a.division + a.subjectName).localeCompare(b.className + b.division + b.subjectName));

    const tableHTML = `
        <div class="table-responsive mt-4">
            <h5 class="mb-3">Mark Entry Status for: <strong>${exams.find(e=>e.id===examId)?.name}</strong></h5>
            <table class="table table-bordered table-hover table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Class</th>
                        <th>Subject</th>
                        <th>Total Students</th>
                        <th class="text-success">Entered</th>
                        <th class="text-danger">Pending</th>
                        <th style="width: 20%;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${summaryData.map(row => {
                        const percentage = row.total > 0 ? (row.entered / row.total) * 100 : 0;
                        const statusClass = percentage === 100 ? 'bg-success' : 'bg-warning';
                        return `
                        <tr>
                            <td>${row.className} - ${row.division}</td>
                            <td>${row.subjectName}</td>
                            <td class="text-center">${row.total}</td>
                            <td class="text-center">${row.entered}</td>
                            <td class="text-center">${row.pending}</td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${percentage}%;" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">${percentage.toFixed(0)}%</div>
                                </div>
                            </td>
                        </tr>
                    `}).join('')}
                </tbody>
            </table>
        </div>
    `;

    summaryContainer.innerHTML = tableHTML;
}

        function renderRankListTab() {
            const container = document.getElementById('pills-ranklist');

            // Determine class options based on user role
            let classOptions = '';
            if (currentUserRole === 'teacher') {
                const teacherAllocations = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id);
                const uniqueClassIds = [...new Set(teacherAllocations.map(a => a.classId))];
                classOptions = uniqueClassIds.map(classId => {
                    const c = classes.find(cls => cls.id === classId);
                    return c ? `<option value="${c.id}">${c.name}</option>` : '';
                }).join('');
            } else { // For admin
                classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }

            container.innerHTML = `
                <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
                    <div class="col-md-4"><label class="form-label">Exam</label><select id="res-exam" class="form-select">${exams.map(e=>`<option value="${e.id}">${e.name}</option>`).join('')}</select></div>
                    <div class="col-md-4"><label class="form-label">Class</label><select id="res-class" class="form-select">${classOptions}</select></div>
                    <div class="col-md-4"><label class="form-label">Division</label><select id="res-division" class="form-select"></select></div>
                </div>
                <div id="results-table-container"></div>`;
            
            const examSelect = document.getElementById('res-exam');
            const classSelect = document.getElementById('res-class');
            const divisionSelect = document.getElementById('res-division');
            
            const loadTable = () => generateResultsTable(document.getElementById('results-table-container'));
            
            // This listener now correctly filters divisions based on the teacher's allocations
            classSelect.addEventListener('change', () => {
                const selectedClassId = classSelect.value;
                let divisionOptionsHTML = '';
                if (currentUserRole === 'teacher') {
                    const teacherAllocationsForClass = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id && cs.classId === selectedClassId);
                    const uniqueDivisions = [...new Set(teacherAllocationsForClass.map(a => a.division))];
                    divisionOptionsHTML = uniqueDivisions.map(d => `<option value="${d}">${d}</option>`).join('');
                } else {
                    const cls = classes.find(c => c.id === selectedClassId);
                    divisionOptionsHTML = cls ? cls.divisions.map(d => `<option value="${d}">${d}</option>`).join('') : '';
                }
                divisionSelect.innerHTML = divisionOptionsHTML;
                loadTable(); // Load the table for the newly selected class/division
            });

            examSelect.addEventListener('change', loadTable);
            divisionSelect.addEventListener('change', loadTable);
            
            // Initial load for the first class in the list
            if (classSelect.options.length > 0) {
                 classSelect.dispatchEvent(new Event('change'));
            }
        }

        function generateResultsTable(container) {
            const examId = document.getElementById('res-exam').value;
            const classId = document.getElementById('res-class').value;
            const division = document.getElementById('res-division').value;
            
            if (!examId || !classId || !division) { 
                container.innerHTML = `<p class="text-center p-5 text-muted">Please select all filters.</p>`; 
                return; 
            }
            
            const studentsInClass = students.filter(s => s.classId === classId && s.division === division);
            const schedulesForClass = examSchedules.filter(s => s.examId === examId && s.classId === classId && s.division === division).sort((a,b) => (subjects.find(sub=>sub.id===a.subjectId)?.name || '').localeCompare(subjects.find(sub=>sub.id===b.subjectId)?.name || ''));
            const marksForExam = marks.filter(m => m.examId === examId);
            
            let results = [];
            studentsInClass.forEach(student => {
                let totalMark = 0, maxTotal = 0, status = 'P';
                schedulesForClass.forEach(schedule => {
                    const mark = marksForExam.find(m => m.studentId === student.id && m.subjectId === schedule.subjectId);
                    const te = mark?.te === 'AB' ? 'AB' : (parseInt(mark?.te) || 0);
                    const ce = mark?.ce === 'AB' ? 'AB' : (parseInt(mark?.ce) || 0);
                    const subjectTotal = (te === 'AB' || ce === 'AB') ? 'AB' : te + ce;
                    
                    // Fail if absent or below 35% in any subject
                    if (subjectTotal === 'AB' || ( (te !== 'AB' && ce !== 'AB') && (te+ce) / (schedule.maxTE + schedule.maxCE) < 0.35) ) {
                         status = 'F';
                    }
                    if (typeof subjectTotal === 'number') {
                        totalMark += subjectTotal;
                    }
                    maxTotal += (parseInt(schedule.maxTE || 0) + parseInt(schedule.maxCE || 0));
                });
                const percentage = maxTotal > 0 ? ((totalMark / maxTotal) * 100).toFixed(2) : 0;
                results.push({ student, totalMark, maxTotal, percentage, status });
            });
            results.sort((a, b) => b.totalMark - a.totalMark);

            container.innerHTML = `<div class="table-responsive"><table class="table table-bordered table-hover">
                <thead class="table-light"><tr><th>Rank</th><th>Name</th><th>Total</th><th>%</th><th>Result</th></tr></thead>
                <tbody>${results.map((res, i) => `
                    <tr class="${res.status === 'F' ? 'table-danger' : ''}">
                        <td class="fw-bold">${res.status === 'F' ? '-' : i + 1}</td>
                        <td>${res.student.name}</td>
                        <td>${res.totalMark} / ${res.maxTotal}</td>
                        <td>${res.percentage}%</td>
                        <td class="fw-bold">${res.status === 'P' ? 'PASS' : 'FAIL'}</td>
                    </tr>`).join('')}
                </tbody>
            </table></div>`;
        }
        
        function renderReportCardTab() {
            const container = document.getElementById('pills-reportcard');
            container.innerHTML = `
                <div class="row g-3 no-print">
                    <div class="col-md-5"><label class="form-label">Exam</label><select id="rc-exam" class="form-select">${exams.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}</select></div>
                    <div class="col-md-5"><label class="form-label">Search Student (Name or Admn No.)</label><input type="text" id="rc-student-search" class="form-control" placeholder="Start typing..."><div id="rc-student-suggestions" class="position-relative"></div></div>
                    <div class="col-md-2 d-flex align-items-end"><button id="rc-print-btn" class="btn btn-secondary w-100" disabled><i class="fas fa-print me-2"></i>Print</button></div>
                </div>
                <hr class="no-print">
                <div id="rc-results-container">
                    <p class="text-center p-5 text-muted">Please search for a student and select an exam to generate a report card.</p>
                </div>`;

            const searchInput = container.querySelector('#rc-student-search'), suggestionsBox = container.querySelector('#rc-student-suggestions'), examSelect = container.querySelector('#rc-exam'), printBtn = container.querySelector('#rc-print-btn');
            let selectedStudentId = null;

            const generateCard = () => {
                const examId = examSelect.value;
                if(selectedStudentId && examId) {
                    generateReportCardHTML(selectedStudentId, examId, 'rc-results-container');
                    printBtn.disabled = false;
                }
            };
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toUpperCase();
                suggestionsBox.innerHTML = '';
                if (query.length < 2) return;
                const matchingStudents = students.filter(s => s.name.toUpperCase().includes(query) || s.admissionNumber.toUpperCase().includes(query)).slice(0, 5);
                suggestionsBox.innerHTML = `<div class="list-group position-absolute w-100" style="z-index:1000">${matchingStudents.map(s => `<a href="#" class="list-group-item list-group-item-action" data-id="${s.id}" data-name="${s.name} (${s.admissionNumber})">${s.name} - ${s.admissionNumber}</a>`).join('')}</div>`;
            });
            document.addEventListener('click', (e) => { if (!suggestionsBox.contains(e.target)) suggestionsBox.innerHTML = ''; });
            suggestionsBox.addEventListener('click', (e) => {
                if (e.target.matches('[data-id]')) {
                    e.preventDefault();
                    selectedStudentId = e.target.dataset.id;
                    searchInput.value = e.target.dataset.name;
                    suggestionsBox.innerHTML = '';
                    generateCard();
                }
            });
            examSelect.addEventListener('change', generateCard);
            printBtn.addEventListener('click', () => window.print());
        }

        function generateReportCardHTML(studentId, examId, containerId) {
            const container = document.getElementById(containerId);
            const student = students.find(s => s.id === studentId);
            const exam = exams.find(e => e.id === examId);
            const studentClass = classes.find(c => c.id === student.classId);
            const schedules = examSchedules.filter(s => s.examId === examId && s.classId === student.classId && s.division === student.division);
            const marksForExam = marks.filter(m => m.examId === examId && m.studentId === student.id);
            
            let totalMarksObtained = 0, maxTotalMarks = 0;
            const subjectResults = schedules.map(schedule => {
                const subject = subjects.find(s => s.id === schedule.subjectId);
                const mark = marksForExam.find(m => m.subjectId === schedule.subjectId);
                const maxTE = schedule.maxTE || 0, maxCE = schedule.maxCE || 0, maxTotal = maxTE + maxCE;
                const te = (mark?.te === 'AB') ? 'AB' : (parseInt(mark?.te) || 0);
                const ce = (mark?.ce === 'AB') ? 'AB' : (parseInt(mark?.ce) || 0);
                const total = (te === 'AB' || ce === 'AB') ? 'AB' : te + ce;
                if (typeof total === 'number') totalMarksObtained += total;
                maxTotalMarks += maxTotal;
                return { subjectName: subject.name, te, ce, total, maxTE, maxCE, maxTotal, grade: calculateGrade(total, maxTotal) };
            });
            const percentage = maxTotalMarks > 0 ? ((totalMarksObtained / maxTotalMarks) * 100).toFixed(2) : 0;
            const finalResult = parseFloat(percentage) >= 35 ? 'PASS' : 'NEEDS IMPROVEMENT';

            container.innerHTML = `
            <div id="report-card-printable" class="p-4 border bg-white">
                <div class="text-center border-bottom pb-3 mb-3">
                    <h3 class="fw-bold">${schoolDetails.name || 'School Name'}</h3>
                    <p class="mb-0">${schoolDetails.address || 'School address'}</p>
                    <h5 class="mt-3">PROGRESS REPORT - ${exam.name.toUpperCase()}</h5>
                </div>
                <div class="row mb-3">
                    <div class="col-6"><strong>Student Name:</strong> ${student.name}</div>
                    <div class="col-6"><strong>Admission No:</strong> ${student.admissionNumber}</div>
                    <div class="col-6"><strong>Class:</strong> ${studentClass.name} - ${student.division}</div>
                    <div class="col-6"><strong>Date of Birth:</strong> ${new Date(student.dob).toLocaleDateString()}</div>
                </div>
                <table class="table table-bordered table-sm">
                    <thead class="table-light text-center"><tr><th>SUBJECT</th><th>THEORY</th><th>INTERNAL</th><th>TOTAL</th><th>MAX</th><th>GRADE</th></tr></thead>
                    <tbody>
                        ${subjectResults.map(res => `
                        <tr class="text-center">
                            <td class="text-start">${res.subjectName}</td><td>${res.te}</td><td>${res.ce}</td><td>${res.total}</td><td>${res.maxTotal}</td><td>${res.grade}</td>
                        </tr>`).join('')}
                    </tbody>
                    <tfoot class="fw-bold text-center">
                        <tr><td colspan="2" class="text-end">GRAND TOTAL</td><td>${totalMarksObtained}</td><td>${maxTotalMarks}</td><td colspan="2"></td></tr>
                    </tfoot>
                </table>
                <div class="row mt-4 fw-bold text-center">
                    <div class="col-6">Overall Percentage: <span class="fs-5">${percentage}%</span></div>
                    <div class="col-6">Final Result: <span class="fs-5 text-${finalResult === 'PASS' ? 'success':'danger'}">${finalResult}</span></div>
                </div>
                <div class="row mt-5 pt-5 text-center text-muted">
                    <div class="col-6"><hr class="mx-auto w-50">Class Teacher</div>
                    <div class="col-6"><hr class="mx-auto w-50">Principal</div>
                </div>
            </div>`;
        }

        function calculateGrade(score, maxScore) {
            if (score === 'AB') return 'AB';
            if (maxScore === 0) return '-';
            const percentage = (score / maxScore) * 100;
            if (percentage >= 90) return 'A+'; if (percentage >= 80) return 'A';
            if (percentage >= 70) return 'B+'; if (percentage >= 60) return 'B';
            if (percentage >= 50) return 'C+'; if (percentage >= 40) return 'C';
            if (percentage >= 30) return 'D';
            return 'E';
        }


        // --- ATTENDANCE MANAGEMENT ---
        window.renderAttendanceManagement = () => {
             mainContent.innerHTML = `<h1 class="h2 mb-4">Attendance Management</h1>
             <ul class="nav nav-tabs" id="attendanceTab" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#take-att" type="button">Take Attendance</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#class-report-att" type="button">Class Report</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#student-report-att" type="button">Student Report</button></li>
             </ul>
             <div class="tab-content card" id="attendanceTabContent">
                <div class="tab-pane fade show active p-4" id="take-att"></div>
                <div class="tab-pane fade p-4" id="class-report-att"></div>
                <div class="tab-pane fade p-4" id="student-report-att"></div>
             </div>`;
             renderTakeAttendanceTab();
             renderClassAttendanceReportTab();
             renderStudentAttendanceReportTab();
        };

        function renderTakeAttendanceTab(){
            const container = document.getElementById('take-att');
            let classOptions = '';
            if (currentUserRole === 'teacher' && selectedUser.classCharge) {
                const c = classes.find(cls => cls.id === selectedUser.classCharge.classId);
                if(c) classOptions = `<option value="${c.id}">${c.name}</option>`;
            } else {
                classOptions = classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
            }
            container.innerHTML = `<div class="row g-3 align-items-end border-bottom pb-3 mb-3">
                <div class="col-md-4"><label>Date</label><input type="date" id="att-date" value="${new Date().toISOString().slice(0,10)}" class="form-control"></div>
                <div class="col-md-4"><label>Class</label><select id="att-class" class="form-select">${classOptions}</select></div>
                <div class="col-md-4"><label>Division</label><select id="att-division" class="form-select"></select></div>
            </div>
            <div id="attendance-sheet"></div>`;
            const classSelect = document.getElementById('att-class'), divisionSelect = document.getElementById('att-division'), dateInput = document.getElementById('att-date');
            
            const loadSheet = () => {
                loadAttendanceSheet(dateInput.value, classSelect.value, divisionSelect.value);
            };

            classSelect.addEventListener('change', () => {
                const cls = classes.find(c => c.id === classSelect.value);
                divisionSelect.innerHTML = cls ? cls.divisions.map(d => `<option value="${d}">${d}</option>`).join('') : '';
                if(currentUserRole === 'teacher' && selectedUser.classCharge) { divisionSelect.value = selectedUser.classCharge.division; }
                loadSheet();
            });
            divisionSelect.addEventListener('change', loadSheet);
            dateInput.addEventListener('change', loadSheet);
            if(classes.length > 0) classSelect.dispatchEvent(new Event('change'));
        }

        async function loadAttendanceSheet(date, classId, division){
            const container = document.getElementById('attendance-sheet');
            if(!date || !classId || !division) { container.innerHTML = `<p class="text-center p-5 text-muted">Please select date, class, and division.</p>`; return; }
            
            // Check for holiday
            const holiday = holidays.find(h => h.id === date);
            if(holiday){
                container.innerHTML = `<div class="alert alert-info text-center">This day is declared as a holiday: <strong>${holiday.narration}</strong>. Attendance cannot be marked.</div>`;
                return;
            }

            const studentsInClass = students.filter(s => s.classId === classId && s.division === division).sort((a,b)=>a.name.localeCompare(b.name));
            if(studentsInClass.length === 0){ container.innerHTML = '<div class="alert alert-warning">No students found.</div>'; return; }
            const attendanceYearMonth = date.slice(0, 7);
            const day = parseInt(date.slice(8, 10)).toString();
            const attendanceDoc = await getDoc(getDocRef('attendance', attendanceYearMonth));
            const todaysAttendance = attendanceDoc.data()?.[day] || {};
            
           let tableHTML = `<div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">${studentsInClass.length} Students</h6>
        <div>
            <button id="invert-selection" class="btn btn-sm btn-outline-secondary me-2">Invert Selection</button>
            <button id="mark-all-present" class="btn btn-sm btn-outline-success">Mark All Present</button>
        </div>
    </div>
    <div class="table-responsive"><table class="table table-bordered">
    <thead class="table-light"><tr><th>Name</th><th>Admission No.</th><th class="text-center">Forenoon (FN)</th><th class="text-center">Afternoon (AN)</th></tr></thead><tbody>`;
    studentsInClass.forEach(s => {
                const studentAtt = todaysAttendance[s.id] || {FN: true, AN: true};
                tableHTML += `<tr><td class="fw-bold">${s.name}</td><td>${s.admissionNumber}</td>
                <td class="text-center"><input type="checkbox" data-id="${s.id}" data-session="FN" class="form-check-input att-check" ${studentAtt.FN ? 'checked' : ''}></td>
                <td class="text-center"><input type="checkbox" data-id="${s.id}" data-session="AN" class="form-check-input att-check" ${studentAtt.AN ? 'checked' : ''}></td></tr>`;
            });
            tableHTML += `</tbody></table></div><div class="text-end mt-3"><button id="save-att-btn" class="btn btn-primary">Save Attendance</button></div>`;
            container.innerHTML = tableHTML;
            document.getElementById('mark-all-present').addEventListener('click', () => document.querySelectorAll('.att-check').forEach(c => c.checked = true));
            document.getElementById('invert-selection').addEventListener('click', () => document.querySelectorAll('.att-check').forEach(c => c.checked = !c.checked));
            document.getElementById('save-att-btn').addEventListener('click', () => saveAttendance(date));
        }

        async function saveAttendance(date) {
            const attendanceYearMonth = date.slice(0, 7);
            const day = parseInt(date.slice(8, 10)).toString();
            const records = {};
            document.querySelectorAll('.att-check').forEach(c => {
                const id = c.dataset.id;
                if (!records[id]) records[id] = {};
                records[id][c.dataset.session] = c.checked;
            });
            try {
                await setDoc(getDocRef('attendance', attendanceYearMonth), { [day]: records }, { merge: true });
                showAlert('Attendance saved successfully!', 'success');
            } catch (error) { console.error("Error saving attendance: ", error); showAlert("Could not save attendance.", "danger");}
        }

        function renderClassAttendanceReportTab(){ 
            const container = document.getElementById('class-report-att');
            container.innerHTML = `<div class="row g-3 align-items-end border-bottom pb-3 mb-3">
                    <div class="col-md-4"><label class="form-label">Month</label><input type="month" id="report-month" value="${new Date().toISOString().slice(0,7)}" class="form-control"></div>
                    <div class="col-md-4"><label class="form-label">Class</label><select id="report-class" class="form-select">${classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                    <div class="col-md-4"><label class="form-label">Division</label><select id="report-division" class="form-select"></select></div>
                </div>
                <div id="class-report-container" class="table-responsive"></div>`;
            
            const monthSelect = document.getElementById('report-month'), classSelect = document.getElementById('report-class'), divisionSelect = document.getElementById('report-division');
            
            const generateReport = () => generateClassAttendanceReport(monthSelect.value, classSelect.value, divisionSelect.value);
            
            classSelect.addEventListener('change', () => {
                const cls = classes.find(c => c.id === classSelect.value);
                divisionSelect.innerHTML = cls ? cls.divisions.map(d=>`<option>${d}</option>`).join('') : '';
                generateReport();
            });
            monthSelect.addEventListener('change', generateReport);
            divisionSelect.addEventListener('change', generateReport);
            if(classes.length > 0) classSelect.dispatchEvent(new Event('change'));
        }

        async function generateClassAttendanceReport(monthYear, classId, division){
            const container = document.getElementById('class-report-container');
            if(!monthYear || !classId || !division){ container.innerHTML = '<p class="text-muted p-5 text-center">Please select all filters.</p>'; return; }

            const studentsInClass = students.filter(s => s.classId === classId && s.division === division).sort((a,b) => a.name.localeCompare(b.name));
            if(studentsInClass.length === 0){ container.innerHTML = '<div class="alert alert-warning">No students found.</div>'; return; }
            
            const monthDataDoc = await getDoc(getDocRef('attendance', monthYear));
            const monthData = monthDataDoc.data() || {};
            const workingDays = Object.keys(monthData).filter(key => !isNaN(parseInt(key)));
            const totalWorkingDays = workingDays.length;
            const daysInMonth = new Date(monthYear.split('-')[0], monthYear.split('-')[1], 0).getDate();
            
            let gridTable = `<h5 class="mt-4">Monthly Grid</h5><table class="table table-bordered table-sm text-center" style="font-size: 0.75rem;"><thead class="table-light"><tr><th class="text-start">Student Name</th>`;
            for(let i=1; i<=daysInMonth; i++){ gridTable += `<th>${i}</th>`; }
            gridTable += `</tr></thead><tbody>`;

            let summaryData = [];

            studentsInClass.forEach(student => {
                let present = 0, absent = 0, half = 0;
                gridTable += `<tr><td class="fw-bold text-start">${student.name}</td>`;
                for(let i=1; i<=daysInMonth; i++){
                    const dayStr = i.toString();
                    const dateStr = `${monthYear}-${dayStr.padStart(2,'0')}`;
                    const holiday = holidays.find(h => h.id === dateStr);
                    let status;
                    if(holiday){
                        status = { symbol: 'H', class: 'att-holiday' };
                    } else {
                         const dayData = monthData[dayStr];
                        const studentRecord = dayData ? dayData[student.id] : null;
                        status = calculateAttendanceStatus(studentRecord);
                        if(workingDays.includes(dayStr)){
                            if(status.symbol === 'P') present++;
                            else if(status.symbol === 'AB') absent++;
                            else if(status.symbol === '/' || status.symbol === '\\') half++;
                        }
                    }
                    gridTable += `<td class="${status.class}" title="${holiday ? holiday.narration : ''}">${status.symbol}</td>`;
                }
                gridTable += `</tr>`;
                summaryData.push({name: student.name, present, absent, half});
            });
            gridTable += '</tbody></table>';

            let summaryTable = `<h5 class="mt-4">Summary Report (Total Working Days: ${totalWorkingDays})</h5><table class="table table-striped table-bordered">
                <thead class="table-light"><tr><th>Student Name</th><th>Present</th><th>Half-days</th><th>Absent</th><th>Total Present</th></tr></thead><tbody>`;
            summaryData.forEach(data => {
                const totalPresent = data.present + (data.half * 0.5);
                summaryTable += `<tr><td>${data.name}</td><td>${data.present}</td><td>${data.half}</td><td>${totalWorkingDays - totalPresent}</td><td>${totalPresent}</td></tr>`;
            });
            summaryTable += '</tbody></table>';

            container.innerHTML = summaryTable + gridTable;
        }

        function calculateAttendanceStatus(record) {
            if (!record) return { symbol: '', class: '' }; // Not a working day
            if (record.FN && record.AN) return { symbol: 'P', class: 'att-present' };
            if (record.FN && !record.AN) return { symbol: '/', class: 'att-half' };
            if (!record.FN && record.AN) return { symbol: '\\', class: 'att-half' };
            return { symbol: 'AB', class: 'att-absent' };
        }

        function renderStudentAttendanceReportTab(){
            const container = document.getElementById('student-report-att');
             container.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-6"><label class="form-label">Search Student (Name or Admn No.)</label><input type="text" id="stu-att-search" class="form-control" placeholder="Start typing..."><div id="stu-att-suggestions" class="position-relative"></div></div>
                    <div class="col-md-4"><label class="form-label">Month</label><input type="month" id="stu-att-month" value="${new Date().toISOString().slice(0,7)}" class="form-control"></div>
                </div><hr>
                <div id="student-calendar-container"></div>`;
            const searchInput = container.querySelector('#stu-att-search'), suggestionsBox = container.querySelector('#stu-att-suggestions'), monthSelect = container.querySelector('#stu-att-month');
            let selectedStudentId = null;

            const generateCalendar = () => {
                if(selectedStudentId && monthSelect.value) {
                    generateStudentCalendar(selectedStudentId, monthSelect.value, 'student-calendar-container');
                }
            };
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toUpperCase(); suggestionsBox.innerHTML = '';
                if (query.length < 2) return;
                const matchingStudents = students.filter(s => s.name.toUpperCase().includes(query) || s.admissionNumber.toUpperCase().includes(query)).slice(0, 5);
                suggestionsBox.innerHTML = `<div class="list-group position-absolute w-100" style="z-index:1000">${matchingStudents.map(s => `<a href="#" class="list-group-item list-group-item-action" data-id="${s.id}" data-name="${s.name} (${s.admissionNumber})">${s.name} - ${s.admissionNumber}</a>`).join('')}</div>`;
            });
            document.addEventListener('click', (e) => { if (!suggestionsBox.contains(e.target)) suggestionsBox.innerHTML = ''; });
            suggestionsBox.addEventListener('click', (e) => {
                if (e.target.matches('[data-id]')) {
                    e.preventDefault(); selectedStudentId = e.target.dataset.id; searchInput.value = e.target.dataset.name;
                    suggestionsBox.innerHTML = ''; generateCalendar();
                }
            });
            monthSelect.addEventListener('change', generateCalendar);
        }

        async function generateStudentCalendar(studentId, monthYear, containerId, isDashboard = false){
            const container = document.getElementById(containerId);
            if(!studentId || !monthYear){ 
                container.innerHTML = `<p class="text-muted p-5 text-center">Select student and month to view calendar.</p>`;
                return;
            }
            
            const student = students.find(s => s.id === studentId);
            const monthDataDoc = await getDoc(getDocRef('attendance', monthYear));
            const monthData = monthDataDoc.data() || {};
            const [year, month] = monthYear.split('-').map(Number);
            const firstDayOfMonth = new Date(year, month - 1, 1).getDay();
            const daysInMonth = new Date(year, month, 0).getDate();
            
            let stats = { present: 0, absent: 0, halfDay: 0 };
            const workingDays = Object.keys(monthData).filter(key => !isNaN(parseInt(key)));
            workingDays.forEach(day => {
                const studentRecord = monthData[day]?.[studentId];
                if (studentRecord) {
                    if (studentRecord.FN && studentRecord.AN) { stats.present++; }
                    else if (studentRecord.FN || studentRecord.AN) { stats.halfDay++; }
                    else { stats.absent++; }
                } else {
                    stats.absent++;
                }
            });

            let calendarHTML = `
            <div class="p-2 border rounded-3 ${isDashboard ? '' : 'p-4'}">
                <div class="${isDashboard ? 'd-none' : 'd-md-flex justify-content-between align-items-md-center mb-4'}">
                    <div>
                        <h5 class="fw-bold">${student.name}</h5>
                        <p class="text-muted mb-0">Attendance Report for ${new Date(year, month-1).toLocaleString('default', { month: 'long', year: 'numeric' })}</p>
                    </div>
                    <div class="d-flex flex-wrap gap-3 mt-2 mt-md-0 small">
                        <span class="d-flex align-items-center"><span class="d-inline-block rounded-circle me-2" style="width:12px; height:12px; background-color: #d1e7dd;"></span>Present: <strong>${stats.present}</strong></span>
                        <span class="d-flex align-items-center"><span class="d-inline-block rounded-circle me-2" style="width:12px; height:12px; background-color: #fff3cd;"></span>Half-day: <strong>${stats.halfDay}</strong></span>
                        <span class="d-flex align-items-center"><span class="d-inline-block rounded-circle me-2" style="width:12px; height:12px; background-color: #f8d7da;"></span>Absent: <strong>${stats.absent}</strong></span>
                        <span class="d-flex align-items-center"><span class="d-inline-block rounded-circle me-2" style="width:12px; height:12px; background-color: #e2e3e5;"></span>Holiday</span>
                    </div>
                </div>

                <div class="calendar-grid text-center small fw-bold text-muted">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div class="calendar-grid text-center mt-1">`;
            
            for (let i = 0; i < firstDayOfMonth; i++) { calendarHTML += `<div></div>`; }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${monthYear}-${day.toString().padStart(2,'0')}`;
                const holiday = holidays.find(h => h.id === dateStr);
                let status;
                if(holiday){
                     status = { symbol: 'H', class: 'att-holiday', title: holiday.narration };
                } else {
                    const dayRecord = monthData[day.toString()] ? monthData[day.toString()][studentId] : null;
                    status = calculateAttendanceStatus(dayRecord);
                }
                
                calendarHTML += `<div class="border rounded p-2 d-flex flex-column justify-content-between ${status.class || 'bg-light'}" style="min-height: 50px;" title="${status.title || ''}">
                    <strong class="align-self-start small">${day}</strong>
                    <span class="fs-5 fw-bold">${status.symbol || ''}</span>
                </div>`;
            }
            calendarHTML += '</div></div>';
            container.innerHTML = calendarHTML;
        }

        // --- HOLIDAY MANAGEMENT ---
        window.renderHolidayManagement = () => {
             mainContent.innerHTML = `<h1 class="h2 mb-4">Holiday Management</h1><div class="row"><div class="col-lg-5"><div class="card shadow mb-4"><div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">Declare Holiday</h6></div><div class="card-body"><form id="holiday-form"><div class="mb-3"><label class="form-label">Date</label><input type="date" id="holiday-date" class="form-control" required></div><div class="mb-3"><label class="form-label">Narration / Reason</label><input type="text" id="holiday-narration" class="form-control" placeholder="E.g., Diwali" required></div><div class="d-flex justify-content-end"><button type="submit" class="btn btn-primary">Save Holiday</button></div></form></div></div></div><div class="col-lg-7"><div class="card shadow mb-4"><div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">Declared Holidays</h6></div><div class="card-body" id="holidays-list-container"></div></div></div></div>`;
            renderHolidaysList();
            document.getElementById('holiday-form').addEventListener('submit', async e => {
                e.preventDefault();
                const date = document.getElementById('holiday-date').value;
                const narration = document.getElementById('holiday-narration').value;
                if(date && narration){
                    await setDoc(getDocRef('holidays', date), {narration});
                    showAlert('Holiday saved successfully', 'success');
                    e.target.reset();
                } else {
                    showAlert('Please provide both date and narration.', 'danger');
                }
            });
        };

        function renderHolidaysList() {
            const container = document.getElementById('holidays-list-container');
            if(!container) return;
            const sortedHolidays = [...holidays].sort((a,b) => a.id.localeCompare(b.id));
            if(sortedHolidays.length === 0){
                container.innerHTML = '<p class="text-muted">No holidays declared yet.</p>';
                return;
            }
            container.innerHTML = `<ul class="list-group list-group-flush">${sortedHolidays.map(h => `<li class="list-group-item d-flex justify-content-between align-items-center">${new Date(h.id).toLocaleDateString('en-GB', {year: 'numeric', month: 'long', day: 'numeric'})} <span class="badge bg-info">${h.narration}</span><button class="btn btn-sm btn-outline-danger" onclick="window.handleDelete('holidays', '${h.id}')"><i class="fas fa-times"></i></button></li>`).join('')}</ul>`;
        }

        // --- STUDENT PORTAL ---
        window.renderMyResults = () => {
            mainContent.innerHTML = `<h1 class="h2 mb-4">My Results</h1><div class="card shadow"><div class="card-body">
                <div class="row mb-3 align-items-end"><div class="col-md-6"><label class="form-label">Select Exam</label><select id="my-res-exam" class="form-select">${exams.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}</select></div></div>
                <div id="my-results-container"></div>
            </div></div>`;
            const examSelect = document.getElementById('my-res-exam');
            const showMyReport = () => {
                if(selectedUser && examSelect.value) {
                    generateReportCardHTML(selectedUser.id, examSelect.value, 'my-results-container');
                }
            }
            examSelect.addEventListener('change', showMyReport);
            if(exams.length > 0) showMyReport();
        };

        window.renderMyAttendance = () => {
            const currentYear = new Date().getFullYear();
            const yearOptions = Array.from({length: 5}, (_, i) => `<option value="${currentYear - i}">${currentYear - i}</option>`).join('');
            const monthOptions = Array.from({length: 12}, (_, i) => `<option value="${i+1}">${new Date(0, i).toLocaleString('default', { month: 'long' })}</option>`).join('');

            mainContent.innerHTML = `<h1 class="h2 mb-4">My Attendance</h1><div class="card shadow"><div class="card-body">
                <div class="row g-3 align-items-end mb-4">
                    <div class="col-md-4"><label class="form-label">Year</label><select id="my-att-year" class="form-select">${yearOptions}</select></div>
                    <div class="col-md-4"><label class="form-label">Month</label><select id="my-att-month" class="form-select">${monthOptions}</select></div>
                </div>
                <div id="my-attendance-container"></div>
            </div></div>`;

            const yearSelect = document.getElementById('my-att-year');
            const monthSelect = document.getElementById('my-att-month');
            monthSelect.value = new Date().getMonth() + 1; // Default to current month

            const showMyCalendar = () => {
                const monthYear = `${yearSelect.value}-${monthSelect.value.padStart(2, '0')}`;
                generateStudentCalendar(selectedUser.id, monthYear, 'my-attendance-container');
            }
            yearSelect.addEventListener('change', showMyCalendar);
            monthSelect.addEventListener('change', showMyCalendar);
            showMyCalendar();
        };

        // --- SYLLABUS TRACKER ---
        window.renderSyllabusTracker = () => {
             mainContent.innerHTML = `<h1 class="h2 mb-4">Syllabus Tracker</h1>
             <ul class="nav nav-tabs" id="syllabusTab" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#add-chapters" type="button">Add Chapters</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#create-syllabus" type="button">Create Syllabus</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#mark-completion" type="button">Mark Completion</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#syllabus-report" type="button">Report</button></li>
             </ul>
             <div class="tab-content card" id="syllabusTabContent">
                <div class="tab-pane fade show active p-4" id="add-chapters"></div>
                <div class="tab-pane fade p-4" id="create-syllabus"></div>
                <div class="tab-pane fade p-4" id="mark-completion"></div>
                <div class="tab-pane fade p-4" id="syllabus-report"></div>
             </div>`;

             if (!document.getElementById('completionModal')) {
                const modal = document.createElement('div');
                modal.innerHTML = `
                <div class="modal fade" id="completionModal" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="completionModalLabel">Mark Portion as Complete</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <form id="completion-form">
                           <input type="hidden" id="completion-syllabus-id">
                           <input type="hidden" id="completion-chapter-no">
                           <input type="hidden" id="completion-topic">
                           <div class="mb-3">
                               <label class="form-label">Completion Date</label>
                               <input type="date" id="completion-date" class="form-control" required>
                           </div>
                           <div class="mb-3">
                               <label class="form-label">Periods Taken</label>
                               <input type="number" id="completion-periods" class="form-control" required>
                           </div>
                            <div class="mb-3">
                               <label class="form-label">Remarks</label>
                               <textarea id="completion-remarks" class="form-control"></textarea>
                           </div>
                        </form>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="save-completion-btn">Save Completion</button>
                      </div>
                    </div>
                  </div>
                </div>`;
                document.body.appendChild(modal);
                completionModalInstance = new bootstrap.Modal(document.getElementById('completionModal'));
                document.getElementById('save-completion-btn').addEventListener('click', async () => {
                    const syllabusId = document.getElementById('completion-syllabus-id').value;
                    const chapterNo = document.getElementById('completion-chapter-no').value;
                    const topic = document.getElementById('completion-topic').value;
                    const date = document.getElementById('completion-date').value;
                    const periods = document.getElementById('completion-periods').value;
                    const remarks = document.getElementById('completion-remarks').value;
                    const [classId, division, subjectId] = syllabusId.split('_');

                    if(syllabusId && topic && date && periods){
                        const completionId = `${syllabusId}_${chapterNo}_${topic.replace(/\s+/g, '-')}`;
                        await setDoc(getDocRef('syllabusCompletion', completionId), {
                            classId, division, subjectId, chapterNo, topic, date,
                            periods: parseInt(periods),
                            remarks,
                            teacherId: selectedUser.id,
                            teacherName: selectedUser.name
                        });
                        showAlert('Completion status saved!', 'success');
                        completionModalInstance.hide();
                    } else {
                        showAlert('Please fill all fields in the modal.', 'danger');
                    }
                });
             }
            
             renderAddChapterTab();
             renderCreateSyllabusTab();
             renderMarkCompletionTab();
             renderSyllabusReportTab();
        };
        
        window.openCompletionModal = (syllabusId, chapterNo, topic) => {
            document.getElementById('completion-form').reset();
            document.getElementById('completion-syllabus-id').value = syllabusId;
            document.getElementById('completion-chapter-no').value = chapterNo;
            document.getElementById('completion-topic').value = topic;
            document.getElementById('completion-date').value = new Date().toISOString().slice(0, 10);
            completionModalInstance.show();
        };

        window.revertCompletion = async (completionId) => {
            if(confirm("Are you sure you want to revert this topic to 'Pending'?")){
                await deleteDoc(getDocRef('syllabusCompletion', completionId));
                showAlert('Completion status reverted.', 'success');
            }
        };

        function renderAddChapterTab() {
            const container = document.getElementById('add-chapters');
            if (!container) return;
            container.innerHTML = `<div class="row">
                <div class="col-lg-5">
                    <div class="card">
                        <div class="card-header fw-bold">Add New Chapter</div>
                        <div class="card-body">
                            <form id="chapter-form">
                                <div class="mb-3"><label class="form-label">Class</label><select id="chapter-class" class="form-select">${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                                <div class="mb-3"><label class="form-label">Division</label><select id="chapter-division" class="form-select"></select></div>
                                <div class="mb-3"><label class="form-label">Subject</label><select id="chapter-subject" class="form-select"></select></div>
                                <hr>
                                <div class="mb-3"><label class="form-label">Chapter Number</label><input type="number" id="chapter-no" class="form-control" required></div>
                                <div class="mb-3"><label class="form-label">Chapter Name</label><input type="text" id="chapter-name" class="form-control" required></div>
                                <div class="d-flex justify-content-end"><button type="submit" class="btn btn-primary">Add Chapter</button></div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-lg-7">
                    <div class="card">
                        <div class="card-header fw-bold">Existing Chapters</div>
                        <div class="card-body" id="chapters-list-view">
                            <p class="text-muted text-center p-5">Select a class, division, and subject to view chapters.</p>
                        </div>
                    </div>
                </div>
            </div>`;
            
            const classSelect = document.getElementById('chapter-class'), divisionSelect = document.getElementById('chapter-division'), subjectSelect = document.getElementById('chapter-subject'), viewContainer = document.getElementById('chapters-list-view');

            const updateChapterView = () => {
                const classId = classSelect.value, division = divisionSelect.value, subjectId = subjectSelect.value;
                if (!classId || !division || !subjectId) {
                    viewContainer.innerHTML = `<p class="text-muted text-center p-5">Please select all filters.</p>`;
                    return;
                }
                const chapterDocId = `${classId}_${division}_${subjectId}`;
                const chapterDoc = chapters.find(c => c.id === chapterDocId);
                
                if (chapterDoc && chapterDoc.chapters) {
                    const chapterMap = chapterDoc.chapters;
                    const sortedKeys = Object.keys(chapterMap).sort((a,b) => parseInt(a) - parseInt(b));
                    viewContainer.innerHTML = `<ul class="list-group list-group-flush">${sortedKeys.map(key => `<li class="list-group-item"><strong>Chapter ${key}:</strong> ${chapterMap[key]}</li>`).join('')}</ul>`;
                } else {
                    viewContainer.innerHTML = `<p class="text-muted text-center p-5">No chapters found. Add one now.</p>`;
                }
            };
            
            const updateSubjects = () => {
                const classId = classSelect.value, division = divisionSelect.value;
                const allocated = classroomSubjects.filter(cs => cs.classId === classId && cs.division === division);
                subjectSelect.innerHTML = allocated.map(a => {
                    const subject = subjects.find(s => s.id === a.subjectId);
                    return subject ? `<option value="${subject.id}">${subject.name}</option>` : '';
                }).join('');
                if(allocated.length === 0) subjectSelect.innerHTML = '<option value="">No subjects allocated</option>';
                updateChapterView();
            };
            
            const updateDivisions = () => {
                const cls = classes.find(c => c.id === classSelect.value);
                divisionSelect.innerHTML = cls ? cls.divisions.map(d => `<option value="${d}">${d}</option>`).join('') : '';
                updateSubjects();
            };

            classSelect.addEventListener('change', updateDivisions);
            divisionSelect.addEventListener('change', updateSubjects);
            subjectSelect.addEventListener('change', updateChapterView);

            document.getElementById('chapter-form').addEventListener('submit', async e => {
                e.preventDefault();
                const classId = classSelect.value, division = divisionSelect.value, subjectId = subjectSelect.value;
                const chapterNo = document.getElementById('chapter-no').value;
                const chapterName = document.getElementById('chapter-name').value;

                if (!classId || !division || !subjectId || !chapterNo || !chapterName) {
                    showAlert('Please fill all fields.', 'danger');
                    return;
                }
                const chapterDocId = `${classId}_${division}_${subjectId}`;
                const docRef = getDocRef('chapters', chapterDocId);
                
                try {
                     await setDoc(docRef, { 
                        chapters: { [chapterNo]: chapterName }
                    }, { merge: true });
                    showAlert('Chapter added successfully!', 'success');
                    document.getElementById('chapter-no').value = '';
                    document.getElementById('chapter-name').value = '';
                } catch (error) {
                    console.error("Error adding chapter: ", error);
                    showAlert('Failed to add chapter.', 'danger');
                }
            });
            
            if (classes.length > 0) updateDivisions();
        }

        function renderCreateSyllabusTab() {
            const container = document.getElementById('create-syllabus');
            if (!container) return;
            container.innerHTML = `<div class="row">
                <div class="col-lg-5">
                    <div class="card">
                        <div class="card-header fw-bold">Define Syllabus Portions</div>
                        <div class="card-body">
                            <form id="syllabus-form">
                                <div class="mb-3"><label class="form-label">Class</label><select id="syllabus-class" class="form-select">${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                                <div class="mb-3"><label class="form-label">Division</label><select id="syllabus-division" class="form-select"></select></div>
                                <div class="mb-3"><label class="form-label">Subject</label><select id="syllabus-subject" class="form-select"></select></div>
                                <div class="mb-3"><label class="form-label">Chapter</label><select id="syllabus-chapter" class="form-select"></select></div>
                                <hr>
                                <div class="mb-3"><label class="form-label">Syllabus Topics (one per line)</label><textarea id="syllabus-topics" class="form-control" rows="8"></textarea></div>
                                <div class="d-flex justify-content-end"><button type="submit" class="btn btn-primary">Save Syllabus</button></div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-lg-7">
                    <div class="card">
                        <div class="card-header fw-bold">Current Topics for Chapter</div>
                        <div class="card-body" id="current-syllabus-view">
                            <p class="text-muted text-center p-5">Select a class, division, subject, and chapter to view or add topics.</p>
                        </div>
                    </div>
                </div>
            </div>`;
            
            const classSelect = document.getElementById('syllabus-class'), divisionSelect = document.getElementById('syllabus-division'), subjectSelect = document.getElementById('syllabus-subject'), chapterSelect = document.getElementById('syllabus-chapter'), topicsText = document.getElementById('syllabus-topics'), viewContainer = document.getElementById('current-syllabus-view');

            const updateSyllabusView = () => {
                const classId = classSelect.value, division = divisionSelect.value, subjectId = subjectSelect.value, chapterNo = chapterSelect.value;
                viewContainer.innerHTML = ''; topicsText.value = '';
                if (!classId || !division || !subjectId || !chapterNo) {
                    viewContainer.innerHTML = `<p class="text-muted text-center p-5">Please select all filters.</p>`; return;
                }
                const syllabusId = `${classId}_${division}_${subjectId}_${chapterNo}`;
                const syllabus = syllabuses.find(s => s.id === syllabusId);
                if (syllabus && syllabus.topics) {
                    topicsText.value = syllabus.topics.join('\n');
                    viewContainer.innerHTML = `<ol class="list-group list-group-numbered">${syllabus.topics.map(t => `<li class="list-group-item">${t}</li>`).join('')}</ol>`;
                } else {
                    viewContainer.innerHTML = `<p class="text-muted text-center p-5">No topics found for this chapter. You can add them now.</p>`;
                }
            };

            const updateChapters = () => {
                const classId = classSelect.value, division = divisionSelect.value, subjectId = subjectSelect.value;
                chapterSelect.innerHTML = '<option value="">-- Select Chapter --</option>';
                if (!classId || !division || !subjectId) { updateSyllabusView(); return; }
                
                const chapterDocId = `${classId}_${division}_${subjectId}`;
                const chapterDoc = chapters.find(c => c.id === chapterDocId);
                if (chapterDoc && chapterDoc.chapters) {
                    const sortedKeys = Object.keys(chapterDoc.chapters).sort((a,b) => parseInt(a) - parseInt(b));
                    chapterSelect.innerHTML += sortedKeys.map(key => `<option value="${key}">Ch ${key}: ${chapterDoc.chapters[key]}</option>`).join('');
                }
                updateSyllabusView();
            };
            
            const updateSubjects = () => {
                const classId = classSelect.value, division = divisionSelect.value;
                const allocated = classroomSubjects.filter(cs => cs.classId === classId && cs.division === division);
                subjectSelect.innerHTML = allocated.map(a => { const subject = subjects.find(s => s.id === a.subjectId); return subject ? `<option value="${subject.id}">${subject.name}</option>` : ''; }).join('');
                if(allocated.length === 0) subjectSelect.innerHTML = '<option value="">No subjects allocated</option>';
                updateChapters();
            };
            
            const updateDivisions = () => {
                const cls = classes.find(c => c.id === classSelect.value);
                divisionSelect.innerHTML = cls ? cls.divisions.map(d => `<option value="${d}">${d}</option>`).join('') : '';
                updateSubjects();
            };

            classSelect.addEventListener('change', updateDivisions);
            divisionSelect.addEventListener('change', updateSubjects);
            subjectSelect.addEventListener('change', updateChapters);
            chapterSelect.addEventListener('change', updateSyllabusView);

            document.getElementById('syllabus-form').addEventListener('submit', async e => {
                e.preventDefault();
                const classId = classSelect.value, division = divisionSelect.value, subjectId = subjectSelect.value, chapterNo = chapterSelect.value;
                const topics = topicsText.value.split('\n').map(t => t.trim()).filter(Boolean);
                if (!classId || !division || !subjectId || !chapterNo || topics.length === 0) {
                    showAlert('Please select all filters and enter at least one topic.', 'danger'); return;
                }
                const syllabusId = `${classId}_${division}_${subjectId}_${chapterNo}`;
                await setDoc(getDocRef('syllabuses', syllabusId), { classId, division, subjectId, chapterNo, topics });
                showAlert('Syllabus topics saved successfully!', 'success');
            });
            
            if (classes.length > 0) updateDivisions();
        }

        function renderMarkCompletionTab() {
            const container = document.getElementById('mark-completion');
            if (!container) return;

            let classOptions = '';
            if (currentUserRole === 'admin') {
                classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            } else if (currentUserRole === 'teacher') {
                const teacherAllocations = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id);
                const uniqueClassIds = [...new Set(teacherAllocations.map(a => a.classId))];
                classOptions = uniqueClassIds.map(classId => { const c = classes.find(cls => cls.id === classId); return c ? `<option value="${c.id}">${c.name}</option>` : ''; }).join('');
            }
            
            container.innerHTML = `<div class="row g-3 align-items-end border-bottom pb-3 mb-3">
                    <div class="col-md-4"><label class="form-label">Class</label><select id="comp-class" class="form-select">${classOptions}</select></div>
                    <div class="col-md-4"><label class="form-label">Division</label><select id="comp-division" class="form-select"></select></div>
                    <div class="col-md-4"><label class="form-label">Subject</label><select id="comp-subject" class="form-select"></select></div>
                </div>
                <div id="completion-list-view"></div>`;

            const classSelect = document.getElementById('comp-class'), divisionSelect = document.getElementById('comp-division'), subjectSelect = document.getElementById('comp-subject');

            const displayCompletionList = () => {
                const classId = classSelect.value, division = divisionSelect.value, subjectId = subjectSelect.value;
                const view = document.getElementById('completion-list-view');
                if (!classId || !division || !subjectId) {
                    view.innerHTML = `<p class="text-muted text-center p-5">Please select a class, division, and subject.</p>`; return;
                }
                const chapterDocId = `${classId}_${division}_${subjectId}`;
                const chapterDoc = chapters.find(c => c.id === chapterDocId);

                if (!chapterDoc || !chapterDoc.chapters) {
                    view.innerHTML = `<div class="alert alert-warning">No chapters defined for this subject. Please add chapters first.</div>`; return;
                }
                
                const completions = syllabusCompletion.filter(c => c.classId === classId && c.division === division && c.subjectId === subjectId);
                const syllabusForSubject = syllabuses.filter(s => s.classId === classId && s.division === division && s.subjectId === subjectId);

                let accordionHTML = '<div class="accordion">';
                const sortedChapterKeys = Object.keys(chapterDoc.chapters).sort((a,b)=>parseInt(a)-parseInt(b));

                sortedChapterKeys.forEach((chapterNo, index) => {
                    const chapterName = chapterDoc.chapters[chapterNo];
                    const syllabusId = `${classId}_${division}_${subjectId}`;
                    const syllabusForChapter = syllabusForSubject.find(s => s.chapterNo === chapterNo);
                    const topics = syllabusForChapter?.topics || [];

                    accordionHTML += `<div class="accordion-item">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${chapterNo}">
                            Chapter ${chapterNo}: ${chapterName}
                          </button>
                        </h2>
                        <div id="collapse-${chapterNo}" class="accordion-collapse collapse">
                          <div class="accordion-body"><ul class="list-group">`;
                    
                    if (topics.length > 0) {
                        topics.forEach(topic => {
                            const completion = completions.find(c => c.chapterNo === chapterNo && c.topic === topic);
                            if (completion) {
                                accordionHTML += `<li class="list-group-item list-group-item-success d-flex justify-content-between align-items-center">
                                    <div><i class="fas fa-check-circle me-2"></i><strong>${topic}</strong>
                                        <small class="d-block text-muted">Completed on ${new Date(completion.date).toLocaleDateString()} by ${completion.teacherName} | Periods: ${completion.periods}</small>
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="window.revertCompletion('${completion.id}')">Revert</button>
                                </li>`;
                            } else {
                                accordionHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${topic}
                                    <button class="btn btn-sm btn-primary" onclick="window.openCompletionModal('${syllabusId}', '${chapterNo}', '${topic}')">Mark Complete</button>
                                </li>`;
                            }
                        });
                    } else {
                        accordionHTML += '<li class="list-group-item text-muted">No topics defined for this chapter yet.</li>';
                    }

                    accordionHTML += `</ul></div></div></div>`;
                });
                accordionHTML += '</div>';
                view.innerHTML = accordionHTML;
            };

            const updateSubjects = () => {
                const classId = classSelect.value, division = divisionSelect.value;
                let allocFilter = cs => cs.classId === classId && cs.division === division;
                if (currentUserRole === 'teacher') { allocFilter = cs => cs.classId === classId && cs.division === division && cs.teacherId === selectedUser.id; }
                const allocated = classroomSubjects.filter(allocFilter);
                subjectSelect.innerHTML = allocated.map(a => { const subject = subjects.find(s => s.id === a.subjectId); return subject ? `<option value="${subject.id}">${subject.name}</option>` : '';}).join('');
                if(allocated.length === 0) subjectSelect.innerHTML = '<option value="">No subjects allocated</option>';
                displayCompletionList();
            };

            const updateDivisions = () => {
                const classId = classSelect.value; const cls = classes.find(c => c.id === classId); let divisionOptions;
                if(currentUserRole === 'teacher'){
                    const teacherAllocations = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id && cs.classId === classId);
                    const uniqueDivisions = [...new Set(teacherAllocations.map(a => a.division))];
                    divisionOptions = cls ? uniqueDivisions.map(d => `<option value="${d}">${d}</option>`).join('') : '';
                } else { divisionOptions = cls ? cls.divisions.map(d => `<option value="${d}">${d}</option>`).join('') : ''; }
                divisionSelect.innerHTML = divisionOptions;
                updateSubjects();
            };

            classSelect.addEventListener('change', updateDivisions);
            divisionSelect.addEventListener('change', updateSubjects);
            subjectSelect.addEventListener('change', displayCompletionList);

            if(classes.length > 0) updateDivisions();
        }

        function renderSyllabusReportTab() {
            const container = document.getElementById('syllabus-report');
            if(!container) return;
             container.innerHTML = `<div class="row g-3 align-items-end border-bottom pb-3 mb-3">
                    <div class="col-md-4"><label class="form-label">Class</label><select id="report-syllabus-class" class="form-select">${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                    <div class="col-md-4"><label class="form-label">Division</label><select id="report-syllabus-division" class="form-select"></select></div>
                    <div class="col-md-4"><label class="form-label">Subject</label><select id="report-syllabus-subject" class="form-select"></select></div>
                </div>
                <div id="syllabus-report-view"></div>`;
            
            const classSelect = document.getElementById('report-syllabus-class'), divisionSelect = document.getElementById('report-syllabus-division'), subjectSelect = document.getElementById('report-syllabus-subject');

            const displayReport = () => {
                const classId = classSelect.value, division = divisionSelect.value, subjectId = subjectSelect.value;
                const view = document.getElementById('syllabus-report-view');
                if (!classId || !division || !subjectId) {
                    view.innerHTML = `<p class="text-muted text-center p-5">Please select all filters.</p>`; return;
                }
                const chapterDocId = `${classId}_${division}_${subjectId}`;
                const chapterDoc = chapters.find(c => c.id === chapterDocId);
                if (!chapterDoc || !chapterDoc.chapters) {
                    view.innerHTML = `<div class="alert alert-warning">No chapters defined for this subject.</div>`; return;
                }
                
                const completions = syllabusCompletion.filter(c => c.classId === classId && c.division === division && c.subjectId === subjectId);
                const syllabusForSubject = syllabuses.filter(s => s.classId === classId && s.division === division && s.subjectId === subjectId);
                let totalTopics = 0;
                syllabusForSubject.forEach(s => totalTopics += (s.topics?.length || 0));
                const completedTopics = completions.length;
                const percentage = totalTopics > 0 ? ((completedTopics / totalTopics) * 100).toFixed(1) : 0;

                let reportHTML = `<div class="mb-4">
                    <h5>Overall Completion Status: ${completedTopics} of ${totalTopics} Topics</h5>
                    <div class="progress" style="height: 25px;"><div class="progress-bar" style="width: ${percentage}%;">${percentage}%</div></div>
                </div>
                <div class="table-responsive"><table class="table table-bordered">
                    <thead class="table-light"><tr><th>Chapter</th><th>Topic</th><th>Status</th><th>Completed On</th><th>Teacher</th><th>Periods</th></tr></thead><tbody>`;
                
                const sortedChapterKeys = Object.keys(chapterDoc.chapters).sort((a,b)=>parseInt(a)-parseInt(b));

                sortedChapterKeys.forEach(chapterNo => {
                    const chapterName = chapterDoc.chapters[chapterNo];
                    const syllabusForChapter = syllabusForSubject.find(s => s.chapterNo === chapterNo);
                    const topics = syllabusForChapter?.topics || [];
                    
                    if(topics.length > 0){
                         topics.forEach((topic, index) => {
                            const completion = completions.find(c => c.chapterNo === chapterNo && c.topic === topic);
                             reportHTML += `<tr>
                                ${index === 0 ? `<td rowspan="${topics.length}" class="align-middle"><strong>Ch ${chapterNo}:</strong><br>${chapterName}</td>` : ''}
                                <td>${topic}</td>
                                ${completion ? `<td class="text-success">Completed</td><td>${new Date(completion.date).toLocaleDateString()}</td><td>${completion.teacherName}</td><td>${completion.periods}</td>` : `<td class="text-danger">Pending</td><td colspan="3"></td>`}
                            </tr>`;
                         });
                    } else {
                         reportHTML += `<tr><td><strong>Ch ${chapterNo}:</strong><br>${chapterName}</td><td colspan="5" class="text-muted">No topics defined.</td></tr>`;
                    }
                });

                reportHTML += `</tbody></table></div>`;
                view.innerHTML = reportHTML;
            };

            const updateSubjects = () => {
                const classId = classSelect.value, division = divisionSelect.value;
                const allocated = classroomSubjects.filter(cs => cs.classId === classId && cs.division === division);
                subjectSelect.innerHTML = allocated.map(a => { const subject = subjects.find(s => s.id === a.subjectId); return subject ? `<option value="${subject.id}">${subject.name}</option>` : ''; }).join('');
                if(allocated.length === 0) subjectSelect.innerHTML = '<option value="">No subjects</option>';
                displayReport();
            };

            const updateDivisions = () => {
                const cls = classes.find(c => c.id === classSelect.value);
                divisionSelect.innerHTML = cls ? cls.divisions.map(d => `<option value="${d}">${d}</option>`).join('') : '';
                updateSubjects();
            };
            
            classSelect.addEventListener('change', updateDivisions);
            divisionSelect.addEventListener('change', updateSubjects);
            subjectSelect.addEventListener('change', displayReport);
            if(classes.length > 0) updateDivisions();
        }

        // --- FEE MANAGEMENT ---
        window.renderFeeManagement = () => {
            const currentYear = new Date().getFullYear();
            const yearOptions = Array.from({length: 5}, (_, i) => {
                const year = currentYear - i;
                const fy = `${year}-${year + 1}`;
                return `<option value="${fy}" ${fy === activeFinancialYear ? 'selected' : ''}>${fy}</option>`;
            }).join('');

            mainContent.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h2">Fee Management</h1>
                    <div>
                        <label for="master-fy-selector" class="form-label me-2">Active Financial Year:</label>
                        <select id="master-fy-selector" class="form-select d-inline-block w-auto">${yearOptions}</select>
                    </div>
                </div>
                <ul class="nav nav-tabs" id="fee-main-tab" role="tablist">
                    <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#fee-structure-tab" data-subtab="structure" type="button">Fee Structure</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fee-setup-tab" data-subtab="setup" type="button">Student Fee Setup</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fee-receipt-tab" data-subtab="receipt" type="button">Fee Receipt</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fee-reports-tab" data-subtab="reports" type="button">Reports</button></li>
                </ul>
                <div class="tab-content" id="fee-main-tab-content">
                    <div class="tab-pane fade show active" id="fee-structure-tab" role="tabpanel"></div>
                    <div class="tab-pane fade" id="fee-setup-tab" role="tabpanel"></div>
                    <div class="tab-pane fade" id="fee-receipt-tab" role="tabpanel"></div>
                    <div class="tab-pane fade" id="fee-reports-tab" role="tabpanel"></div>
                </div>`;

            document.getElementById('master-fy-selector').addEventListener('change', (e) => {
                activeFinancialYear = e.target.value;
                attachFeeDataListeners(activeFinancialYear);
                const activeSubTab = document.querySelector('#fee-main-tab .nav-link.active').dataset.subtab;
                renderFeeSubTab(activeSubTab);
            });
            
            document.querySelectorAll('#fee-main-tab .nav-link').forEach(tab => {
                tab.addEventListener('show.bs.tab', (event) => {
                     renderFeeSubTab(event.target.dataset.subtab);
                });
            });
            
            renderFeeSubTab('structure'); // Default view
        };

        function renderFeeSubTab(subtab) {
    // Clear edit state when switching tabs
    feeStructureToEdit = null;
    receiptToEdit = null;

    switch (subtab) {
        case 'structure':
            renderFeeStructureTab();
            break;
        case 'setup':
            renderStudentFeeSetupTab();
            break;
        case 'receipt':
            renderFeeReceiptTab();
            break;
        case 'reports':
            renderFeeReportsTab(); // <<< UPDATED LINE
            break;
    }
}

        function renderFeeStructureTab() {
    const container = document.getElementById('fee-structure-tab');
    if (!container) return; // Add null check for container
    const isEditMode = feeStructureToEdit !== null;

    container.innerHTML = `
        <div class="card p-4 mt-3">
            <div class="row">
                <div class="col-lg-5">
                    <form id="fee-structure-form" class="card p-3">
                        <h5 class="fw-bold mb-3">${isEditMode ? 'Edit Fee Structure' : 'Add Fee Structure'}</h5>
                        <div class="mb-3">
                            <label class="form-label">Fee Head</label>
                            <select id="fs-head" class="form-select" ${isEditMode ? 'disabled' : ''}>
                                <option value="">-- Select --</option>
                                <option value="TUITION FEE" ${feeStructureToEdit?.feeHead === 'TUITION FEE' ? 'selected' : ''}>TUITION FEE</option>
                                <option value="VEHICLE FEE" ${feeStructureToEdit?.feeHead === 'VEHICLE FEE' ? 'selected' : ''}>VEHICLE FEE</option>
                                <option value="EXAM FEE" ${feeStructureToEdit?.feeHead === 'EXAM FEE' ? 'selected' : ''}>EXAM FEE</option>
                            </select>
                            <div class="invalid-feedback">Please select a fee head.</div>
                        </div>
                        <div id="fs-dynamic-container">
                            </div>
                        <div class="text-end mt-3">
                            ${isEditMode ? '<button type="button" id="cancel-fee-edit-btn" class="btn btn-secondary me-2">Cancel</button>' : ''}
                            <button type="submit" class="btn btn-primary">${isEditMode ? 'Update' : 'Save'}</button>
                        </div>
                    </form>
                </div>
                <div class="col-lg-7" id="fee-structures-list">
                    </div>
            </div>
        </div>`;

    attachFeeStructureFormListeners();
    renderFeeStructuresList(); // Render the list on the right
}
        
        function renderStudentFeeSetupTab() {
             const container = document.getElementById('fee-setup-tab');
             container.innerHTML = `<div class="card p-4 mt-3">
                <h4 class="mb-3">Student Annual Fee Setup</h4>
                <p class="text-muted">Generate or view the annual fee structure for students. The system auto-fills fees from the 'Fee Structure' tab. You can then make manual adjustments (e.g., for concessions) and save.</p>
                <div class="row g-3 align-items-end mb-4">
                    <div class="col-md-4"><label class="form-label">Class</label><select id="sfs-class" class="form-select"><option value="">--</option>${classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                    <div class="col-md-4"><label class="form-label">Division</label><select id="sfs-division" class="form-select" disabled></select></div>
                    <div class="col-md-4"><button id="sfs-fetch-btn" class="btn btn-primary w-100">Fetch Students</button></div>
                </div>
                <div id="sfs-status" class="mt-4"></div>
            </div>`;
            attachStudentFeeSetupListeners();
        }

        function renderFeeReceiptTab(){
             const container = document.getElementById('fee-receipt-tab');
             container.innerHTML = `<div class="card p-4 mt-3">
                <h4 class="mb-3">Fee Receipt</h4>
                <div id="receipt-entry-form"></div>
                <hr>
                <h5 class="mb-3">Recent Receipts (${activeFinancialYear})</h5>
                <div id="recent-receipts-list"></div>
             </div>`;
             renderReceiptEntryForm();
             //renderRecentReceipts();
        }

        window.renderMyFees = () => {
             const setup = studentFeeSetups.find(sfs => sfs.id === selectedUser.id);
             const payments = receipts.filter(r => r.studentId === selectedUser.id && !r.isCancelled);
             let totalPaid = 0;
             payments.forEach(p => totalPaid += p.totalAmount);
             const balance = setup ? (setup.totalPayable - totalPaid) : 0;

             mainContent.innerHTML = `<h1 class="h2 mb-4">My Fee Status (${activeFinancialYear})</h1>
             <div class="row">
                <div class="col-md-4"><div class="card text-white bg-primary mb-3"><div class="card-body"><h5 class="card-title">Total Payable</h5><p class="card-text fs-4 fw-bold">₹ ${setup?.totalPayable.toFixed(2) || '0.00'}</p></div></div></div>
                <div class="col-md-4"><div class="card text-white bg-success mb-3"><div class="card-body"><h5 class="card-title">Total Paid</h5><p class="card-text fs-4 fw-bold">₹ ${totalPaid.toFixed(2)}</p></div></div></div>
                <div class="col-md-4"><div class="card text-white bg-danger mb-3"><div class="card-body"><h5 class="card-title">Balance Due</h5><p class="card-text fs-4 fw-bold">₹ ${balance.toFixed(2)}</p></div></div></div>
             </div>
             <div class="card shadow mt-4">
                <div class="card-header fw-bold">Fee Breakdown</div>
                <div class="card-body">
                    ${setup ? `
                    <table class="table">
                        <tbody>
                            <tr><th>Arrears from Previous Year</th><td>₹ ${setup.arrears?.toFixed(2) || '0.00'}</td></tr>
                            <tr><th>Tuition Fee (Term 1/2/3)</th><td>₹ ${setup.tf1?.toFixed(2)} / ${setup.tf2?.toFixed(2)} / ${setup.tf3?.toFixed(2)}</td></tr>
                            <tr><th>Vehicle Fee (Term 1/2/3)</th><td>₹ ${setup.vf1?.toFixed(2)} / ${setup.vf2?.toFixed(2)} / ${setup.vf3?.toFixed(2)}</td></tr>
                            <tr><th>Exam Fee</th><td>₹ ${setup.examFee?.toFixed(2) || '0.00'}</td></tr>
                            <tr class="text-danger"><th>Concession</th><td>- ₹ ${setup.concession?.toFixed(2) || '0.00'}</td></tr>
                        </tbody>
                    </table>` : '<p class="text-muted">Your fee structure has not been set up for this year.</p>'}
                </div>
             </div>
             <div class="card shadow mt-4">
                <div class="card-header fw-bold">Payment History</div>
                <div class="card-body">
                     ${payments.length > 0 ? `
                        <table class="table table-striped">
                            <thead><tr><th>Receipt No</th><th>Date</th><th>Amount</th><th>Status</th></tr></thead>
                            <tbody>${payments.map(p => `<tr><td>${p.id}</td><td>${new Date(p.date).toLocaleDateString()}</td><td>₹ ${p.totalAmount.toFixed(2)}</td><td><span class="badge bg-${p.isCancelled ? 'danger' : 'success'}">${p.isCancelled ? 'Cancelled' : 'Paid'}</span></td></tr>`).join('')}</tbody>
                        </table>
                     ` : '<p class="text-muted">No payments recorded for this year.</p>'}
                </div>
             </div>
             `;
        };

        function attachFeeStructureFormListeners() {
    const form = document.getElementById('fee-structure-form');
    if (!form) return;
    const headSelect = document.getElementById('fs-head');
    const dynamicContainer = document.getElementById('fs-dynamic-container');
    const isEditMode = feeStructureToEdit !== null;

    // Elements for dynamic fields (will be assigned after renderDynamicFields)
    let fsClassSelect, fsDivisionSelect, fsStageInput, fsTerm1Input, fsTerm2Input, fsTerm3Input, fsAmountInput;

    const renderDynamicFields = (head, dataToFill = {}) => {
        let html = '';
        if (head === 'TUITION FEE' || head === 'EXAM FEE') {
            // Class dropdown (single select)
            html += `<div class="mb-3">
                        <label class="form-label">Class</label>
                        <select id="fs-class" class="form-select" required>
                            <option value="">-- Select Class --</option>
                            ${classes.map(c => `<option value="${c.id}" ${dataToFill.classId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                        </select>
                        <div class="invalid-feedback">Please select a class.</div>
                    </div>`;

            // Divisions dropdown (MULTIPLE select)
            html += `<div class="mb-3">
                        <label class="form-label">Divisions <small>(Select one or more)</small></label>
                        <select id="fs-division" class="form-select" multiple required style="min-height: 100px;">
                            </select>
                        <div class="invalid-feedback">Please select at least one division.</div>
                    </div>`;

        } else if (head === 'VEHICLE FEE') {
            html += `<div class="mb-3">
                        <label class="form-label">Vehicle Stage</label>
                        <input id="fs-stage" class="form-control" placeholder="e.g., ROUTE 1" value="${dataToFill.stage || ''}" required>
                        <div class="invalid-feedback">Vehicle stage is required.</div>
                    </div>`;
        }
        
        if (head === 'TUITION FEE' || head === 'VEHICLE FEE') {
            html += `<div class="row">
                        <div class="col"><label class="form-label">Term 1</label><input type="number" id="fs-term1" class="form-control" value="${dataToFill.term1_amount || ''}" required></div>
                        <div class="col"><label class="form-label">Term 2</label><input type="number" id="fs-term2" class="form-control" value="${dataToFill.term2_amount || ''}" required></div>
                        <div class="col"><label class="form-label">Term 3</label><input type="number" id="fs-term3" class="form-control" value="${dataToFill.term3_amount || ''}" required></div>
                        <div class="invalid-feedback">Term amounts are required.</div>
                    </div>`;
        } else if (head === 'EXAM FEE') {
            html += `<div class="mb-3">
                        <label class="form-label">Annual Amount</label>
                        <input type="number" id="fs-amount" class="form-control" value="${dataToFill.amount || ''}" required>
                        <div class="invalid-feedback">Annual amount is required.</div>
                    </div>`;
        }
        dynamicContainer.innerHTML = html;

        // --- Get References to Newly Rendered Dynamic Elements ---
        fsClassSelect = document.getElementById('fs-class');
        fsDivisionSelect = document.getElementById('fs-division'); // This is the multiple select
        fsStageInput = document.getElementById('fs-stage');
        fsTerm1Input = document.getElementById('fs-term1');
        fsTerm2Input = document.getElementById('fs-term2');
        fsTerm3Input = document.getElementById('fs-term3');
        fsAmountInput = document.getElementById('fs-amount');

        // --- Attach Listener for Class Dropdown to Update Divisions ---
        if (fsClassSelect) {
            fsClassSelect.addEventListener('change', () => {
                const selectedClass = classes.find(c => c.id === fsClassSelect.value);
                fsDivisionSelect.innerHTML = ''; // Clear existing options

                if (selectedClass && selectedClass.divisions) {
                    selectedClass.divisions.map(d => {
                        const option = document.createElement('option');
                        option.value = d;
                        option.textContent = d;
                        // For edit mode, select the divisions that are part of this feeStructureToEdit
                        if (isEditMode && feeStructureToEdit.divisions && feeStructureToEdit.divisions.includes(d)) {
                            option.selected = true;
                        }
                        fsDivisionSelect.appendChild(option);
                    });
                }
            });
            // Trigger change event to populate divisions initially (if class is pre-selected in edit mode)
            fsClassSelect.dispatchEvent(new Event('change'));
        }
    };

    // --- PRE-FILL LOGIC FOR EDIT MODE ---
    if (isEditMode) {
        headSelect.value = feeStructureToEdit.feeHead;
        headSelect.disabled = true; // Disable fee head in edit mode as it's part of the ID
        renderDynamicFields(feeStructureToEdit.feeHead, feeStructureToEdit);
    } else {
        form.reset(); // Clear form for new entry
        dynamicContainer.innerHTML = ''; // Clear dynamic fields
        headSelect.disabled = false; // Enable fee head for new entry
    }

    headSelect.addEventListener('change', () => renderDynamicFields(headSelect.value));

    // --- Cancel Edit Button Listener ---
    const cancelEditBtn = document.getElementById('cancel-fee-edit-btn');
    if (cancelEditBtn) {
        cancelEditBtn.addEventListener('click', () => {
            feeStructureToEdit = null; // Clear edit state
            renderFeeStructureTab(); // Re-render to switch to Add mode
        });
    }

    // --- Form Submission Logic ---
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonHtml = submitButton.innerHTML;

        // Client-side validation
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            showAlert('Please fill in all required fields.', 'warning');
            return;
        }
        form.classList.add('was-validated'); // Apply validation styles even if valid

        submitButton.disabled = true;
        submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...`;

        try {
            const feeHead = headSelect.value; // Always get from the (possibly disabled) dropdown for current context
            const batch = writeBatch(db); // Use batch for multiple division saves

            let structuresToSave = []; // Array to hold all structure objects to save
            let affectedDocIds = new Set(); // Keep track of all doc IDs involved in the update

            if (feeHead === 'TUITION FEE' || feeHead === 'EXAM FEE') {
                const classId = fsClassSelect.value;
                const selectedDivisions = Array.from(fsDivisionSelect.selectedOptions).map(option => option.value);

                if (selectedDivisions.length === 0) {
                    showAlert('Please select at least one division.', 'warning');
                    return; // Stop submission
                }

                // Prepare data for each selected division
                selectedDivisions.forEach(division => {
                    const docId = `${feeHead.replace(' ', '_')}_${classId}_${division}`;
                    affectedDocIds.add(docId); // Add this docId to set
                    
                    let structureData = { 
                        financialYear: activeFinancialYear, 
                        feeHead, 
                        appliesTo: 'CLASS', 
                        classId, 
                        division // Store individual division here
                    };

                    if (feeHead === 'TUITION FEE') {
                        structureData = { ...structureData, term: 'TERM_BASED', 
                                          term1_amount: parseFloat(fsTerm1Input.value) || 0, 
                                          term2_amount: parseFloat(fsTerm2Input.value) || 0, 
                                          term3_amount: parseFloat(fsTerm3Input.value) || 0 };
                    } else { // EXAM FEE
                        structureData = { ...structureData, term: 'ANNUAL', 
                                          amount: parseFloat(fsAmountInput.value) || 0 };
                    }
                    structuresToSave.push({ id: docId, data: structureData });
                });

                // --- Handle Deletion of Unselected Divisions in Edit Mode ---
                if (isEditMode) {
                    const originalClassId = feeStructureToEdit.classId;
                    const originalDivisions = feeStructureToEdit.divisions || []; // Original divisions for this feeHead/classId
                    
                    // Filter out existing structures for this feeHead/classId that are NOT in the newly selected divisions
                    const structuresToDelete = feeStructures.filter(s =>
                        s.financialYear === activeFinancialYear &&
                        s.feeHead === feeHead &&
                        s.classId === originalClassId &&
                        s.division && // Ensure it has a division
                        !selectedDivisions.includes(s.division) // If this original division is NOT among the newly selected
                    );

                    structuresToDelete.forEach(s => {
                        batch.delete(getFeeDocRef(activeFinancialYear, 'feeStructures', s.id));
                        affectedDocIds.delete(s.id); // Remove from affected if deleted
                    });
                }


            } else if (feeHead === 'VEHICLE FEE') {
                const stage = fsStageInput.value;
                if (!stage) { showAlert('Please enter a vehicle stage.', 'danger'); return; }

                const docId = `VEHICLE_FEE_${stage.replace(/\s+/g, '_')}`;
                affectedDocIds.add(docId); // Add this docId to set

                let structureData = { 
                    financialYear: activeFinancialYear, 
                    feeHead, 
                    appliesTo: 'VEHICLE', 
                    stage, 
                    term: 'TERM_BASED', 
                    term1_amount: parseFloat(fsTerm1Input.value) || 0, 
                    term2_amount: parseFloat(fsTerm2Input.value) || 0, 
                    term3_amount: parseFloat(fsTerm3Input.value) || 0 
                };
                structuresToSave.push({ id: docId, data: structureData });

                // If in edit mode, and vehicle fee structure ID changed (unlikely but possible if stage changes)
                // This scenario might need manual old doc deletion or more complex ID management.
                // For now, it will simply set a new document and leave the old one if stage ID changes.
                // If stage is part of the ID and stage is editable, it's generally better to prevent editing ID part.
                // Or: if editing, check if original ID is different from new generated one, delete old if so.
                // For simplicity, current logic just updates/creates at new ID.
            }

            // Perform batch writes for all prepared structures
            structuresToSave.forEach(s => {
                batch.set(getFeeDocRef(activeFinancialYear, 'feeStructures', s.id), s.data);
            });

            await batch.commit();
            showAlert('Fee structure saved successfully!', 'success');
            
            feeStructureToEdit = null; // Clear edit state
            form.reset(); // Reset form
            form.classList.remove('was-validated'); // Clear validation styles
            dynamicContainer.innerHTML = ''; // Clear dynamic fields
            headSelect.disabled = false; // Re-enable fee head dropdown
            headSelect.value = ''; // Reset fee head dropdown
            
        } catch (error) {
            console.error("Error saving fee structure:", error);
            showAlert('Failed to save fee structure. Please try again.', 'danger');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonHtml;
        }
    });
}

        function renderFeeStructuresList() {
    const container = document.getElementById('fee-structures-list');
    if (!container) return;
    
    // Sort fee structures for consistent display
    const sortedFeeStructures = [...feeStructures].sort((a,b) => {
        const headA = a.feeHead || '';
        const headB = b.feeHead || '';
        const classA = classes.find(c => c.id === a.classId)?.name || '';
        const classB = classes.find(c => c.id === b.classId)?.name || '';
        
        // Primary sort by Fee Head
        if (headA !== headB) return headA.localeCompare(headB);
        // Secondary sort by Class Name
        if (classA !== classB) return classA.localeCompare(classB);
        // Tertiary sort by Division (if applicable)
        if (a.division && b.division) return a.division.localeCompare(b.division);
        // Fallback for stage if it's vehicle fee
        if (a.stage && b.stage) return a.stage.localeCompare(b.stage);
        return 0;
    });


    if (sortedFeeStructures.length === 0) {
        container.innerHTML = `<p class="text-muted text-center p-5">No fee structures defined for ${activeFinancialYear}.</p>`;
        return;
    }

    container.innerHTML = `<h5 class="mb-3">Existing Structures for ${activeFinancialYear}</h5>
        <ul class="list-group">
            ${sortedFeeStructures.map(s => {
                let details = '';
                let amountsHtml = '';

                if (s.appliesTo === 'CLASS') {
                    // Display class and division for class-based fees
                    details = `Class: ${classes.find(c => c.id === s.classId)?.name || 'N/A'} - Div: ${s.division || 'N/A'}`;
                } else if (s.appliesTo === 'VEHICLE') {
                    details = `Stage: ${s.stage}`;
                }

                if (s.term === 'TERM_BASED') {
                    amountsHtml = `
                        <p class="mb-0 text-sm text-muted">
                            Term 1: ₹${(s.term1_amount || 0).toFixed(2)} | 
                            Term 2: ₹${(s.term2_amount || 0).toFixed(2)} | 
                            Term 3: ₹${(s.term3_amount || 0).toFixed(2)}
                        </p>`;
                } else if (s.term === 'ANNUAL') {
                    amountsHtml = `<p class="mb-0 text-sm text-muted">Annual Amount: ₹${(s.amount || 0).toFixed(2)}</p>`;
                }

                return `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0"><strong>${s.feeHead}</strong> <small class="text-muted">(${details})</small></h6>
                            ${amountsHtml}
                        </div>
                        <div>
                            <button onclick="window.handleEditFeeStructure('${s.id}')" class="btn btn-sm btn-outline-primary me-2" title="Edit Fee Structure">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="window.handleDeleteFeeStructure('${s.id}')" class="btn btn-sm btn-outline-danger" title="Delete Fee Structure">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </li>`;
            }).join('')}
        </ul>`;
}

// Assume feeStructures global array contains documents like:
// { id: 'TUITION_FEE_CLASSX_A', feeHead: 'TUITION FEE', classId: 'CLASSX', division: 'A', ...amounts }
// { id: 'TUITION_FEE_CLASSX_B', feeHead: 'TUITION FEE', classId: 'CLASSX', division: 'B', ...amounts }

window.handleEditFeeStructure = (id) => {
    const selectedFeeStructure = feeStructures.find(fs => fs.id === id);
    if (selectedFeeStructure) {
        // When editing a class-division specific fee, we need to find ALL associated divisions
        // that share the same feeHead, financialYear, and classId.
        let relevantStructures = [];
        if (selectedFeeStructure.appliesTo === 'CLASS') {
            relevantStructures = feeStructures.filter(fs =>
                fs.financialYear === selectedFeeStructure.financialYear &&
                fs.feeHead === selectedFeeStructure.feeHead &&
                fs.classId === selectedFeeStructure.classId
            );
        } else { // For VEHICLE type, it's just the one selected
            relevantStructures = [selectedFeeStructure];
        }

        // Create a temporary object for editing that contains all relevant divisions
        feeStructureToEdit = {
            ...selectedFeeStructure, // Copy original properties
            // Add an array of all divisions for this class/fee head combination
            divisions: relevantStructures
                        .filter(s => s.division) // Only include items that actually have a division
                        .map(s => s.division)
        };

        renderFeeStructureTab(); // Re-render the form with pre-filled data
    } else {
        showAlert('Fee structure not found for editing.', 'danger');
        console.warn('Fee structure not found for editing:', id);
    }
};

/**
 * Deletes a fee structure from Firestore.
 * @param {string} id - The ID of the fee structure to delete.
 */
window.handleDeleteFeeStructure = async (id) => {
    if (confirm("Are you sure you want to delete this fee structure? This action cannot be undone.")) {
        try {
            // Use getFeeDocRef with the correct financial year and collection name
            await deleteDoc(getFeeDocRef(activeFinancialYear, 'feeStructures', id));
            showAlert('Fee structure deleted successfully.', 'success');
            // The real-time listener should automatically re-render the list.
        } catch (error) {
            console.error('Error deleting fee structure:', error);
            showAlert('Failed to delete fee structure. Please try again.', 'danger');
        }
    }
};


        function attachStudentFeeSetupListeners() {
            const classSelect = document.getElementById('sfs-class');
            const divisionSelect = document.getElementById('sfs-division');
            const fetchBtn = document.getElementById('sfs-fetch-btn');
            if(!fetchBtn) return;

            classSelect.addEventListener('change', () => {
                const cls = classes.find(c => c.id === classSelect.value);
                divisionSelect.innerHTML = '<option value="">--</option>';
                if (cls) {
                    divisionSelect.disabled = false;
                    divisionSelect.innerHTML += cls.divisions.map(d => `<option value="${d}">${d}</option>`).join('');
                } else {
                    divisionSelect.disabled = true;
                }
            });

            fetchBtn.addEventListener('click', () => {
                const classId = classSelect.value;
                const division = divisionSelect.value;
                if (classId && division) {
                    generateAndDisplayFeeSetup(activeFinancialYear, classId, division);
                } else {
                    showAlert('Please select a class and division.', 'danger');
                }
            });
        }

        // 2. This function fetches data and renders the editable fee table
// 2. This function fetches data and renders the editable fee table
async function generateAndDisplayFeeSetup(fy, classId, division) {
    const container = document.getElementById('sfs-status');
    container.innerHTML = '<p class="text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Fetching student data and calculating fees...</p>';

    const studentsInClass = students.filter(s => s.classId === classId && s.division === division);
    if (studentsInClass.length === 0) {
        container.innerHTML = '<p class="text-center text-red-500">No students found in this class.</p>';
        return;
    }

    // Prepare a data structure to hold the final fee setup for each student
    const studentFeeData = studentsInClass.map(student => {
        // First, check if a setup already exists for this student this year
        let savedSetup = studentFeeSetups.find(sfs => sfs.id === student.id);

        if (savedSetup) {
            // If it exists, use the saved data, but ensure student object is also passed
            return { student, ...savedSetup };
        } else {
            // If not, calculate the default fees from the Fee Structure
            // Find tuition fee for the class
            const tuitionFeeStructures = feeStructures.filter(fs =>
                fs.financialYear === fy &&
                fs.feeHead === 'TUITION FEE' &&
                fs.classId === classId &&
                // IMPORTANT: Filter by student's division also if tuition fee is division-specific
                (fs.division === undefined || fs.division === null || fs.division === student.division) // Handle general class fees or division-specific
            );
            // Assuming tuition fee is either per class OR per class-division.
            // If multiple divisions are allowed for tuition fee structures, this needs careful aggregation.
            // For now, let's assume one tuition fee structure per class-division if division is specified,
            // or one per class if division is not specified.
            const tutionFee = tuitionFeeStructures.find(fs => fs.classId === classId && (fs.division === student.division || fs.division === undefined || fs.division === null));

            // Find vehicle fee based on student's vehicleStage
            const vehicleFee = feeStructures.find(fs =>
                fs.financialYear === fy &&
                fs.feeHead === 'VEHICLE FEE' &&
                fs.stage === student.vehicleStage // Assumes student has a 'vehicleStage' property
            );
            
            // Find exam fee for the class (or class-division)
            const examFeeStructures = feeStructures.filter(fs =>
                fs.financialYear === fy &&
                fs.feeHead === 'EXAM FEE' &&
                fs.classId === classId &&
                (fs.division === undefined || fs.division === null || fs.division === student.division)
            );
            const examFee = examFeeStructures.find(fs => fs.classId === classId && (fs.division === student.division || fs.division === undefined || fs.division === null));

            // Special rule for orphans
            const isOrphan = student.isOrphan || false; // Assuming 'isOrphan' property on student object

            return {
                student, // Pass the student object itself
                arrears: 0, // Default to 0 for new setups
                tf1: isOrphan ? 0 : (tutionFee?.term1_amount || 0),
                tf2: isOrphan ? 0 : (tutionFee?.term2_amount || 0),
                tf3: isOrphan ? 0 : (tutionFee?.term3_amount || 0),
                vf1: isOrphan ? 0 : (vehicleFee?.term1_amount || 0),
                vf2: isOrphan ? 0 : (vehicleFee?.term2_amount || 0),
                vf3: isOrphan ? 0 : (vehicleFee?.term3_amount || 0),
                examFee: isOrphan ? 0 : (examFee?.amount || 0), // Exam fee is annual
                concession: 0, // Default to 0 for new setups
            };
        }
    });

    // Render the editable table
    // Updated table headers to include "Vehicle Stage"
    let tableHTML = `
        <p class="text-sm my-4">Found ${studentFeeData.length} students. Review the calculated fees below and make any necessary adjustments.</p>
        <div class="overflow-x-auto">
            <table id="sfs-table" class="w-full text-xs whitespace-nowrap table table-bordered table-striped">
                <thead><tr class="bg-gray-100">
                    <th class="p-2 text-left">Student Name</th>
                    <th>Vehicle Stage</th> <th>Arrears</th>
                    <th>TF1</th><th>TF2</th><th>TF3</th>
                    <th>VF1</th><th>VF2</th><th>VF3</th>
                    <th>Exam Fee</th><th>Concession</th>
                    <th class="font-bold">Total Payable</th>
                </tr></thead>
                <tbody>`;
    
    studentFeeData.forEach(data => {
        // Calculate total dynamically for display
        const total = (data.arrears + data.tf1 + data.tf2 + data.tf3 + data.vf1 + data.vf2 + data.vf3 + data.examFee) - data.concession;
        
        tableHTML += `
            <tr class="border-t" data-student-id="${data.student.id}">
                <td class="p-2 font-medium">${data.student.name}</td>
                <td>${data.student.vehicleStage || 'N/A'}</td> <td><input type="number" class="w-20 p-1 border rounded sfs-input form-control-sm" data-fee="arrears" value="${(data.arrears || 0).toFixed(2)}"></td>
                <td><input type="number" class="w-20 p-1 border rounded sfs-input form-control-sm" data-fee="tf1" value="${(data.tf1 || 0).toFixed(2)}"></td>
                <td><input type="number" class="w-20 p-1 border rounded sfs-input form-control-sm" data-fee="tf2" value="${(data.tf2 || 0).toFixed(2)}"></td>
                <td><input type="number" class="w-20 p-1 border rounded sfs-input form-control-sm" data-fee="tf3" value="${(data.tf3 || 0).toFixed(2)}"></td>
                <td><input type="number" class="w-20 p-1 border rounded sfs-input form-control-sm" data-fee="vf1" value="${(data.vf1 || 0).toFixed(2)}"></td>
                <td><input type="number" class="w-20 p-1 border rounded sfs-input form-control-sm" data-fee="vf2" value="${(data.vf2 || 0).toFixed(2)}"></td>
                <td><input type="number" class="w-20 p-1 border rounded sfs-input form-control-sm" data-fee="vf3" value="${(data.vf3 || 0).toFixed(2)}"></td>
                <td><input type="number" class="w-20 p-1 border rounded sfs-input form-control-sm" data-fee="examFee" value="${(data.examFee || 0).toFixed(2)}"></td>
                <td><input type="number" class="w-20 p-1 border rounded sfs-input text-danger form-control-sm" data-fee="concession" value="${(data.concession || 0).toFixed(2)}"></td>
                <td class="p-2 font-bold text-right align-middle">₹ ${total.toFixed(2)}</td>
            </tr>`;
    });

    tableHTML += `</tbody></table></div><div class="text-center mt-6"><button id="sfs-save-all-btn" class="btn btn-success">Save Setups for All ${studentFeeData.length} Students</button></div>`;
    container.innerHTML = tableHTML;
    
    // Attach listener to the save button
    document.getElementById('sfs-save-all-btn').addEventListener('click', () => saveAllFeeSetups(fy));

    // Optional: Add event listener for input changes to update "Total Payable" column dynamically
    // This requires a more complex setup using event delegation and recalculating the row total.
    // For simplicity, we'll keep it as is, and the total will be recalculated on save.
    // If you want live total update, you'd add:
    document.getElementById('sfs-table').addEventListener('input', (e) => {
        if (e.target.classList.contains('sfs-input')) {
            const row = e.target.closest('tr');
            const inputs = row.querySelectorAll('.sfs-input');
            let rowTotal = 0;
            let rowConcession = 0;
            inputs.forEach(input => {
                const amount = parseFloat(input.value) || 0;
                if (input.dataset.fee === 'concession') {
                    rowConcession = amount;
                } else {
                    rowTotal += amount;
                }
            });
            row.querySelector('.font-bold').textContent = `₹ ${(rowTotal - rowConcession).toFixed(2)}`;
        }
    });
}
// 3. This function reads the editable table and saves all data in a single batch
async function saveAllFeeSetups(fy) {
    const saveButton = document.getElementById('sfs-save-all-btn');
    saveButton.disabled = true; saveButton.innerHTML = 'Saving...';

    const batch = writeBatch(db);
    const studentRows = document.querySelectorAll('#sfs-table tbody tr');

    studentRows.forEach(row => {
        const studentId = row.dataset.studentId;
        const studentDocRef = getFeeDocRef(fy, 'studentFeeSetups', studentId);

        const feeData = { studentId, financialYear: fy };
        let totalPayable = 0;
        const inputs = row.querySelectorAll('.sfs-input');
        
        inputs.forEach(input => {
            const feeType = input.dataset.fee;
            const amount = parseFloat(input.value) || 0;
            feeData[feeType] = amount;
            if (feeType !== 'concession') {
                totalPayable += amount;
            }
        });
        feeData.totalPayable = totalPayable - feeData.concession;

        batch.set(studentDocRef, feeData);
    });

    try {
        await batch.commit();
        alert(`Fee setup for ${studentRows.length} students has been saved successfully!`);
    } catch (error) {
        console.error("Error saving fee setups: ", error);
        alert("An error occurred. Please check the console.");
    } finally {
        saveButton.disabled = false; saveButton.innerHTML = `Save Setups for All ${studentRows.length} Students`;
    }
}

// ✅ --- DEDICATED FUNCTION TO RENDER THE RECEIPT ENTRY FORM ---
async function renderReceiptEntryForm() {
    const container = document.getElementById('receipt-entry-form');
    const isEditMode = receiptToEdit !== null;

    // Determine current financial year (e.g., 2025-2026)
    const now = new Date();
    const currentFY = now.getMonth() >= 3 ? `${now.getFullYear()}-${now.getFullYear() + 1}` : `${now.getFullYear() - 1}-${now.getFullYear()}`;
    
    // Auto-generate next receipt number for the current financial year
    const fyReceipts = receipts.filter(r => r.financialYear === currentFY);
    const nextReceiptNum = `R${currentFY.slice(2,4)}${currentFY.slice(7,9)}-${(fyReceipts.length + 1).toString().padStart(4, '0')}`;
    
    // Pre-fill form if editing
    const currentReceipt = receiptToEdit || { receiptNo: nextReceiptNum, date: new Date().toISOString().slice(0,10), isStudent: true, paymentMode: 'CASH', items: [{head: '', amount: ''}] };

    container.innerHTML = `
        <h4 class="fw-semibold mb-4">${isEditMode ? `Edit Receipt: ${currentReceipt.receiptNo}` : 'New Fee Receipt'}</h4>
<form id="receipt-form">

    <div class="row g-3 p-3 border rounded mb-4">
        <div class="col-md-3">
            <label for="receipt-no" class="form-label">Receipt No.</label>
            <input type="text" id="receipt-no" value="${currentReceipt.receiptNo}" readonly class="form-control-plaintext">
        </div>
        <div class="col-md-3">
            <label for="receipt-date" class="form-label">Date</label>
            <input type="date" id="receipt-date" value="${currentReceipt.date}" class="form-control">
        </div>
        <div class="col-md-3">
            <label for="financial-year" class="form-label">Financial Year</label>
            <input type="text" id="financial-year" value="${currentFY}" readonly class="form-control-plaintext">
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <div class="form-check form-switch mb-1">
                <input class="form-check-input" type="checkbox" role="switch" id="is-student-check" ${currentReceipt.isStudent ? 'checked' : ''}>
                <label class="form-check-label" for="is-student-check">Is a Student?</label>
            </div>
        </div>
    </div>
    
    <div id="payer-details" class="row g-3 p-3 border rounded mb-4">
        </div>

    <div class="p-3 border rounded mb-4">
        <h5 class="fw-semibold mb-3">Fee Items</h5>
        <div id="fee-items-container" class="vstack gap-2">
            </div>
        <button type="button" id="add-fee-item-btn" class="btn btn-sm btn-outline-primary mt-3">
            <i class="fas fa-plus me-1"></i>Add Another Item
        </button>
    </div>

    <div class="row g-3 p-3 border rounded">
        <div class="col-md-4">
            <label for="payment-mode" class="form-label">Payment Mode</label>
            <select id="payment-mode" class="form-select">
                <option value="CASH">CASH</option>
                <option value="BANK">BANK</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="total-amount" class="form-label">Total Amount</label>
            <input type="text" id="total-amount" readonly class="form-control-plaintext fs-4 fw-bold">
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center pt-4 mt-3">
        <div>
            ${isEditMode && currentUserRole === 'admin' ? `<button type="button" id="cancel-receipt-btn" class="btn btn-danger">Cancel Receipt</button>` : ''}
        </div>
        <div>
            <button type="submit" class="btn btn-primary btn-lg">${isEditMode ? 'Update Receipt' : 'Save Receipt'}</button>
        </div>
    </div>
</form>
    `;

    // --- Attach all listeners and logic for the form ---
    const isStudentCheck = document.getElementById('is-student-check');
    const payerDetailsContainer = document.getElementById('payer-details');
    const feeItemsContainer = document.getElementById('fee-items-container');
    const addFeeItemBtn = document.getElementById('add-fee-item-btn');
    const totalAmountInput = document.getElementById('total-amount');
    const form = document.getElementById('receipt-form');

    // Function to render payer details section based on checkbox
    const renderPayerDetails = () => {
        if (isStudentCheck.checked) {
            payerDetailsContainer.innerHTML = `
                <div class="md:col-span-1"><label>Admission No.</label><input type="text" id="admn-no-search" class="mt-1 w-full" placeholder="Enter Admn No..."></div>
                <div class="md:col-span-2 bg-gray-100 p-2 rounded-md text-sm"><p id="student-info-display">Student details will appear here.</p></div>`;
            document.getElementById('admn-no-search').addEventListener('change', (e) => {
                const student = students.find(s => s.admissionNumber === e.target.value);
                document.getElementById('student-info-display').textContent = student ? `Name: ${student.name}, Class: ${classes.find(c=>c.id===student.classId)?.name}-${student.division}` : 'Student not found.';
            });
        } else {
            payerDetailsContainer.innerHTML = `<div><label>Paid By (Name)</label><input type="text" id="other-payer-name" class="mt-1 w-full" placeholder="Enter name..."></div>`;
        }
    };

    // Function to add a new fee item row
    const addFeeItemRow = (item = { head: '', amount: '' }) => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-3 gap-2 items-center';
        row.innerHTML = `
            <div class="col-span-2"><select class="w-full fee-head-select"><option value="">-- SELECT HEAD --</option></select></div>
            <div><input type="number" class="w-full fee-amount-input" value="${item.amount}"></div>
            <button type="button" class="text-red-500 remove-item-btn"><i class="fas fa-times-circle"></i></button>`;
        feeItemsContainer.appendChild(row);
        // Populate fee heads dropdown (you would fetch these from Firestore)
        const select = row.querySelector('.fee-head-select');
        ['TUTION FEE', 'VEHICLE FEE', 'EXAM FEE', 'MISC'].forEach(head => select.innerHTML += `<option value="${head}" ${item.head === head ? 'selected' : ''}>${head}</option>`);
    };
    
    // Function to update the total amount
    const updateTotal = () => {
        let total = 0;
        document.querySelectorAll('.fee-amount-input').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        totalAmountInput.value = total.toFixed(2);
    };

    // Attach event listeners
    isStudentCheck.addEventListener('change', renderPayerDetails);
    addFeeItemBtn.addEventListener('click', () => addFeeItemRow());
    feeItemsContainer.addEventListener('input', updateTotal);
    feeItemsContainer.addEventListener('click', (e) => {
        if (e.target.closest('.remove-item-btn')) {
            e.target.closest('.grid').remove();
            updateTotal();
        }
    });

    // Initial setup
    renderPayerDetails();
    currentReceipt.items.forEach(item => addFeeItemRow(item));
    updateTotal();
    
    // Form submission logic
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const receiptNo = document.getElementById('receipt-no').value;
        const receiptData = {
            receiptNo,
            date: document.getElementById('receipt-date').value,
            financialYear: document.getElementById('financial-year').value,
            isStudent: document.getElementById('is-student-check').checked,
            payerName: document.getElementById('other-payer-name')?.value || students.find(s=>s.admissionNumber===document.getElementById('admn-no-search')?.value)?.name,
            studentId: document.getElementById('admn-no-search')?.value ? students.find(s=>s.admissionNumber===document.getElementById('admn-no-search')?.value)?.id : null,
            items: [],
            totalAmount: parseFloat(document.getElementById('total-amount').value),
            paymentMode: document.getElementById('payment-mode').value,
            isCancelled: receiptToEdit?.isCancelled || false
        };
        
        document.querySelectorAll('#fee-items-container .grid').forEach(row => {
            receiptData.items.push({
                head: row.querySelector('.fee-head-select').value,
                amount: parseFloat(row.querySelector('.fee-amount-input').value) || 0
            });
        });
        
        await setDoc(getFeeDocRef(`${receiptData.financialYear}`,'receipts', receiptNo), receiptData);
        alert('Receipt saved successfully!');
        receiptToEdit = null;
        renderFeeSubTab('receipt');
    });
}
       
function renderFeeReportsTab() {
    const container = document.getElementById('fee-reports-tab');
    const classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

    container.innerHTML = `
        <div class="card p-4 mt-3">
            <h4 class="mb-3">Student Fee Report</h4>
            <p class="text-muted">Select a class, division, and term to generate a detailed fee report for <strong>${activeFinancialYear}</strong>.</p>
            <div class="row g-3 align-items-end mb-4">
                <div class="col-md-3">
                    <label for="fr-class" class="form-label">Class</label>
                    <select id="fr-class" class="form-select"><option value="">-- Select --</option>${classOptions}</select>
                </div>
                <div class="col-md-3">
                    <label for="fr-division" class="form-label">Division</label>
                    <select id="fr-division" class="form-select" disabled><option value="">--</option></select>
                </div>
                <div class="col-md-3">
                    <label for="fr-term" class="form-label">Term</label>
                    <select id="fr-term" class="form-select">
                        <option value="T1">Up to Term 1</option>
                        <option value="T2">Up to Term 2</option>
                        <option value="T3">Up to Term 3</option>
                        <option value="FY" selected>Full Year</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button id="fr-generate-btn" class="btn btn-primary w-100">Generate Report</button>
                </div>
            </div>
            <div id="fr-report-container" class="mt-4"></div>
        </div>`;
    
    attachFeeReportsListeners();
}


/**
 * Attaches listeners for the report generation form.
 */
/**
 * Attaches listeners for the report generation form and the dynamic report table.
 */
function attachFeeReportsListeners() {
    const classSelect = document.getElementById('fr-class');
    const divisionSelect = document.getElementById('fr-division');
    const generateBtn = document.getElementById('fr-generate-btn');
    const reportContainer = document.getElementById('fr-report-container');

    // Populate divisions when a class is selected
    classSelect.addEventListener('change', () => {
        const selectedClass = classes.find(c => c.id === classSelect.value);
        divisionSelect.innerHTML = '<option value="">-- Select --</option>';
        if (selectedClass) {
            divisionSelect.disabled = false;
            divisionSelect.innerHTML += selectedClass.divisions.map(d => `<option value="${d}">${d}</option>`).join('');
        } else {
            divisionSelect.disabled = true;
        }
    });

    // Generate the report on button click
    generateBtn.addEventListener('click', () => {
        const classId = classSelect.value;
        const division = divisionSelect.value;
        const term = document.getElementById('fr-term').value;
        if (classId && division && term) {
            generateAndDisplayFeeReport(classId, division, term,'fr-report-container');
        } else {
            showAlert('Please select a class, division, and term.', 'warning');
        }
    });
    
    // Use event delegation for dynamically created buttons and links in the report
    reportContainer.addEventListener('click', (e) => {
        const studentLink = e.target.closest('.student-details-link');
        const whatsAppBtn = e.target.closest('.whatsapp-btn');

        if (studentLink) {
            e.preventDefault();
            const studentId = studentLink.dataset.studentid;
            populateAndShowStudentModal(studentId);
        }
        
        if (whatsAppBtn) {
           // Use event delegation for WhatsApp buttons that will be dynamically created
    reportContainer.addEventListener('click', (e) => {
       whatsappFee(e);
    });
        }
    });
}

function whatsappFee (e){
    
        const whatsAppBtn = e.target.closest('.whatsapp-btn');
        if (whatsAppBtn) {
            const studentName = whatsAppBtn.dataset.name;
            const balance = whatsAppBtn.dataset.balance;
            const payable = whatsAppBtn.dataset.payable;
            const paid = whatsAppBtn.dataset.paid;
            const whatsAppNumber = whatsAppBtn.dataset.whatsapp;
            const schoolName = schoolDetails.name || 'School Name'; // Personalize your school name here

            const message = `Dear Parent/Student,
This is a friendly reminder regarding the fee payment for ${studentName} for the academic year ${activeFinancialYear}.

Fee Details:
- Total Payable: ₹ ${payable}
- Amount Paid: ₹ ${paid}
- *Balance Due: ₹ ${balance}*

Kindly clear the outstanding balance at your earliest convenience.
Thank you,
${schoolName}`;

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${whatsAppNumber}?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }
    
}
function generateAndDisplayFeeReport(classId, division, term,containerId){
    const reportContainer = document.getElementById(containerId); // MODIFIED
    if (!reportContainer) return; // Add a safety check

    reportContainer.innerHTML = `<div class="text-center text-muted"><div class="spinner-border" role="status"></div><p class="mt-2">Generating report...</p></div>`;


    //const reportContainer = document.getElementById('fr-report-container');
    reportContainer.innerHTML = `<div class="text-center text-muted"><div class="spinner-border" role="status"></div><p class="mt-2">Generating report...</p></div>`;

    const studentsInClass = students.filter(s => s.classId === classId && s.division === division);
    if (studentsInClass.length === 0) {
        reportContainer.innerHTML = '<div class="alert alert-warning">No students found for this selection.</div>';
        return;
    }

    const reportData = studentsInClass.map(student => {
        const setup = studentFeeSetups.find(sfs => sfs.id === student.id);
        const payments = receipts.filter(r => r.studentId === student.id && !r.isCancelled);
        const totalPaid = payments.reduce((sum, p) => sum + p.totalAmount, 0);

        let termPayable = 0;
        let termFees = { arrears: 0, tf: 0, vf: 0, examFee: 0 };
        
        if (setup) {
            termFees.arrears = setup.arrears || 0;
            // Calculate payable amount cumulatively based on the selected term
            if (term === 'T1' || term === 'T2' || term === 'T3' || term === 'FY') {
                termPayable += (setup.arrears || 0) + (setup.tf1 || 0) + (setup.vf1 || 0) + (setup.examFee || 0);
                termFees.tf += setup.tf1 || 0;
                termFees.vf += setup.vf1 || 0;
                termFees.examFee += setup.examFee || 0;
            }
            if (term === 'T2' || term === 'T3' || term === 'FY') {
                termPayable += (setup.tf2 || 0) + (setup.vf2 || 0);
                termFees.tf += setup.tf2 || 0;
                termFees.vf += setup.vf2 || 0;
            }
            if (term === 'T3' || term === 'FY') {
                termPayable += (setup.tf3 || 0) + (setup.vf3 || 0);
                termFees.tf += setup.tf3 || 0;
                termFees.vf += setup.vf3 || 0;
            }
            if (term === 'FY') termPayable = setup.totalPayable;
        }

        return {
            ...student,
            termPayable,
            totalPaid,
            balance: termPayable - totalPaid,
            termFees // Store term-wise breakdown for the main table
        };
    });

    displayFeeReport(reportData, containerId); // MODIFIED

}

/**
 * Renders the calculated fee report data into an HTML table with more detail.
 * @param {Array<object>} reportData Array of student objects with their fee details.
 */
function displayFeeReport(reportData, containerId) {
    const reportContainer = document.getElementById(containerId); // MODIFIED
    if (!reportContainer) return; // Add a safety check


    const tableRows = reportData.map(student => {
        const balance = student.balance;
        let balanceBadgeColor = balance <= 0 ? 'success' : 'danger';
        const whatsAppButton = (balance > 0 && student.whatsappNo) ?
            `<button class="btn btn-sm btn-success whatsapp-btn" data-balance="${balance.toFixed(2)}" data-name="${student.name}" data-whatsapp="${student.whatsappNo}"><i class="fab fa-whatsapp"></i></button>` : '';

        return `
            <tr>
                <td><a href="#" class="fw-bold student-details-link" data-studentid="${student.id}">${student.name}</a></td>
                <td>${student.admissionNumber}</td>
                <td>${student.termFees.arrears.toFixed(2)}</td>
                <td>${student.termFees.tf.toFixed(2)}</td>
                <td>${student.termFees.vf.toFixed(2)}</td>
                <td>${student.termFees.examFee.toFixed(2)}</td>
                <td class="fw-bold">${student.termPayable.toFixed(2)}</td>
                <td>${student.totalPaid.toFixed(2)}</td>
                <td><span class="badge bg-${balanceBadgeColor} p-2">₹ ${balance.toFixed(2)}</span></td>
                <td>${whatsAppButton}</td>
            </tr>`;
    }).join('');

    reportContainer.innerHTML = `
        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover" style="font-size: 0.85rem;">
                <thead class="table-light">
                    <tr>
                        <th>Student Name</th><th>Admn No.</th><th>Arrears</th><th>Tuition Fee</th>
                        <th>Vehicle Fee</th><th>Exam Fee</th><th>Total Payable</th><th>Total Paid</th><th>Balance</th><th>Action</th>
                    </tr>
                </thead>
                <tbody>${tableRows}</tbody>
            </table>
        </div>`;
}

window.renderTeacherFeeDetails = () => {
    const mainContent = document.getElementById('main-content'); // Or your main container

    // Find the class name from the classId stored in classCharge
    const className = classes.find(c => c.id === selectedUser.classCharge.classId)?.name || 'Unknown Class';
    const assignedClassText = `${className} - ${selectedUser.classCharge.division}`;

    mainContent.innerHTML = `
        <div class="card p-4 mt-3">
            <h4 class="mb-3">Student Fee Details</h4>
            
            <!-- Display the teacher's assigned class as static text -->
            <div class="mb-3">
                <label class="form-label">Your Assigned Class:</label>
                <p class="fs-5 fw-bold text-primary">${assignedClassText}</p>
            </div>
            
            <p class="text-muted">Select a term to view the fee status for your students for the year <strong>${activeFinancialYear}</strong>.</p>
            
            <div class="row g-3 align-items-end mb-4">
                <div class="col-md-6">
                    <label for="teacher-term" class="form-label">Term</label>
                    <select id="teacher-term" class="form-select">
                        <option value="T1">Up to Term 1</option>
                        <option value="T2">Up to Term 2</option>
                        <option value="T3">Up to Term 3</option>
                        <option value="FY" selected>Full Year</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <button id="teacher-generate-btn" class="btn btn-primary w-100">View Fee Details</button>
                </div>
            </div>
            <div id="teacher-report-container" class="mt-4">
                <!-- The fee report will be rendered here -->
            </div>
        </div>`;
    
    // Pass the teacher object to the listener setup function
    attachTeacherFeeListeners(selectedUser);
};


function attachTeacherFeeListeners(currentTeacher) {
    const generateBtn = document.getElementById('teacher-generate-btn');
    const reportContainer = document.getElementById('teacher-report-container');

    generateBtn.addEventListener('click', () => {
        const termSelector = document.getElementById('teacher-term');
        const term = termSelector.value;

        // Get classId and division directly from the teacher object
        const classId = currentTeacher.classCharge.classId;
        const division = currentTeacher.classCharge.division;

        // Call the REUSABLE report generator with the teacher's container ID
        generateAndDisplayFeeReport(classId, division, term, 'teacher-report-container');
    });

    // Event delegation for the modal and WhatsApp buttons remains the same
    // and is crucial for the dynamically generated report.
    reportContainer.addEventListener('click', (e) => {
        const studentLink = e.target.closest('.student-details-link');
        if (studentLink) {
            e.preventDefault();
            const studentId = studentLink.dataset.studentid;
            populateAndShowStudentModal(studentId);
        }
        
        const whatsAppBtn = e.target.closest('.whatsapp-btn');

        if (whatsAppBtn) {
            reportContainer.addEventListener('click', (e) => {
       whatsappFee(e);
    });
        }
    });
}


/**
 * Populates the student detail modal with fee structure and payment history, then shows it.
 * @param {string} studentId The ID of the student to show details for.
 */
function populateAndShowStudentModal(studentId) {
    const student = students.find(s => s.id === studentId);
    const setup = studentFeeSetups.find(sfs => sfs.id === studentId);
    const payments = receipts.filter(r => r.studentId === studentId && !r.isCancelled).sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (!student) return;

    // --- Fee Structure Tab Content ---
    const structureHTML = setup ? `
        <table class="table table-sm">
            <tbody>
                <tr><th>Arrears</th><td>₹ ${setup.arrears?.toFixed(2) || '0.00'}</td></tr>
                <tr><th>Tuition Fee (T1/T2/T3)</th><td>₹ ${setup.tf1?.toFixed(2)} / ${setup.tf2?.toFixed(2)} / ${setup.tf3?.toFixed(2)}</td></tr>
                <tr><th>Vehicle Fee (T1/T2/T3)</th><td>₹ ${setup.vf1?.toFixed(2)} / ${setup.vf2?.toFixed(2)} / ${setup.vf3?.toFixed(2)}</td></tr>
                <tr><th>Exam Fee</th><td>₹ ${setup.examFee?.toFixed(2) || '0.00'}</td></tr>
                <tr class="text-danger"><th>Concession</th><td>- ₹ ${setup.concession?.toFixed(2) || '0.00'}</td></tr>
                <tr class="fw-bold bg-light"><th>Total Payable Annually</th><td>₹ ${setup.totalPayable?.toFixed(2) || '0.00'}</td></tr>
            </tbody>
        </table>` : '<p class="text-muted">Fee setup not found for this student.</p>';

    // --- Payment History Tab Content ---
    const paymentsHTML = payments.length > 0 ? `
        <table class="table table-sm table-striped">
            <thead><tr><th>Receipt No</th><th>Date</th><th class="text-end">Amount</th></tr></thead>
            <tbody>
                ${payments.map(p => `<tr><td>${p.id}</td><td>${new Date(p.date).toLocaleDateString()}</td><td class="text-end">₹ ${p.totalAmount.toFixed(2)}</td></tr>`).join('')}
            </tbody>
        </table>` : '<p class="text-muted">No payments recorded.</p>';

    // --- Final Modal Body HTML with Tabs ---
    const modalBody = document.getElementById('studentDetailModalBody');
    modalBody.innerHTML = `
        <ul class="nav nav-tabs" id="studentFeeTabs" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" id="structure-tab" data-bs-toggle="tab" data-bs-target="#structure-content" type="button">Fee Structure</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments-content" type="button">Payment History</button></li>
        </ul>
        <div class="tab-content pt-3">
            <div class="tab-pane fade show active" id="structure-content">${structureHTML}</div>
            <div class="tab-pane fade" id="payments-content">${paymentsHTML}</div>
        </div>`;
    
    document.getElementById('studentDetailModalLabel').textContent = `Fee Details for: ${student.name}`;
    const studentModal = new bootstrap.Modal(document.getElementById('studentDetailModal'));
    studentModal.show();
}

/**
 * @file This script manages form creation, rendering, and response handling for a school management system.
 * It includes functionalities for admins to create and manage forms, for teachers to view and comment on student submissions,
 * and for students to fill out and edit their form responses.
 * @version 1.0.0
 */

// --- GLOBAL STATE ---

/**
 * The form currently being edited or created.
 * @type {object | null}
 */

// --- CORE RENDERING FUNCTIONS ---

/**
 * Renders the main form management interface for administrators.
 * Displays a table of all created forms with options to create, edit, toggle status, and view responses.
 */
window.renderFormManagement = () => {
    formToEdit = null; // Ensure formToEdit is reset for a fresh start
    const mainContent = document.getElementById('main-content');
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }

    const tableRows = forms.map(form => `
        <tr>
            <td>${form.title}</td>
            <td>${form.target}</td>
            <td>${form.classId || 'All'}</td>
            <td>${form.division || 'All'}</td>
            <td>
                <span class="badge bg-${form.isActive ? 'success' : 'secondary'}">
                    ${form.isActive ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-primary me-1" data-form-id="${form.id}" data-action="edit">Edit</button>
                <button class="btn btn-sm btn-warning" data-form-id="${form.id}" data-action="toggle-status">${form.isActive ? 'Deactivate' : 'Activate'}</button>
                <button class="btn btn-sm btn-outline-info" data-form-id="${form.id}" data-action="view-responses">Responses</button>
            </td>
        </tr>
    `).join('');

    const content = `
        <h1 class="h2 mb-4">Form Management</h1>
        <div class="text-end mb-3">
            <button class="btn btn-primary" id="create-new-form-btn">+ Create New Form</button>
        </div>
        ${forms.length ? `
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Target</th>
                            <th>Class</th>
                            <th>Division</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            </div>
        ` : '<p class="text-muted">No forms available.</p>'}
    `;

    mainContent.innerHTML = content;

    // Attach event listeners
    document.getElementById('create-new-form-btn')?.addEventListener('click', window.startNewForm);
    mainContent.addEventListener('click', (e) => {
        const target = e.target;
        const formId = target.dataset.formId;
        if (!formId) return;

        const action = target.dataset.action;
        if (action === 'edit') window.editForm(formId);
        if (action === 'toggle-status') window.toggleFormStatus(formId);
        if (action === 'view-responses') window.viewFormResponses(formId);
    });
};
/**
 * Renders the form builder interface for creating or editing a form.
 */
function renderFormBuilder() {
    // Ensure formToEdit is an object with default properties if it's null (for new forms)
    // or use the existing formToEdit if editing.
    formToEdit = formToEdit || { title: '', target: 'student', classId: '', division: '', fields: [], isActive: true };
    const isEdit = !!formToEdit.id;
    const form = formToEdit; // Now 'form' is guaranteed to have the structure

    const mainContent = document.getElementById('main-content'); // Ensure mainContent is defined here
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }

    // Main HTML structure for the form builder
    mainContent.innerHTML = `
        <h1 class="h2 mb-4">${isEdit ? 'Edit Form' : 'Create Form'}</h1>
        <form id="form-builder">
            <div class="mb-3">
                <label class="form-label">Form Title</label>
                <input class="form-control" id="form-title" value="${form.title}" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Target</label>
                <select class="form-select" id="form-target">
                    <option value="student" ${form.target === 'student' ? 'selected' : ''}>Students</option>
                    <option value="teacher" ${form.target === 'teacher' ? 'selected' : ''}>Teachers</option>
                </select>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <label class="form-label">Class</label>
                    <select class="form-select" id="form-class">
                        <option value="">--All--</option>
                        ${classes.map(c => `<option value="${c.id}" ${form.classId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                    </select>
                </div>
                <div class="col">
                    <label class="form-label">Division</label>
                    <input class="form-control" id="form-division" value="${form.division || ''}" placeholder="e.g., A">
                </div>
            </div>
            <div class="mb-3">
                <h5>Fields</h5>
                <div id="field-list"></div>
                <button type="button" class="btn btn-outline-primary mt-2" id="add-field-btn">Add Field</button>
            </div>
            <button type="submit" class="btn btn-success">${isEdit ? 'Update' : 'Create'} Form</button>
        </form>
    `;

    const fieldListContainer = document.getElementById('field-list');
    if (!fieldListContainer) {
        console.error('Field list container not found!');
        return;
    }

    // Initial render of the fields
    renderFieldList(form.fields);

    // --- SINGLE EVENT LISTENER SETUP ---
    // This listener is attached ONCE to the container and handles all clicks inside it.
    fieldListContainer.addEventListener('click', (e) => {
        const target = e.target;
        const action = target.dataset.action;
        if (!action) return;

        const fieldIndex = parseInt(target.dataset.fieldIndex, 10);
        // Validate fieldIndex
        if (isNaN(fieldIndex) || fieldIndex < 0 || fieldIndex >= formToEdit.fields.length) {
            console.warn('Invalid field index for action:', action, fieldIndex);
            return;
        }
        
        switch (action) {
            case 'remove-field':
                formToEdit.fields.splice(fieldIndex, 1);
                break;
            case 'add-condition':
                // Ensure conditions array exists before pushing
                if (!formToEdit.fields[fieldIndex].conditions) {
                    formToEdit.fields[fieldIndex].conditions = [];
                }
                formToEdit.fields[fieldIndex].conditions.push({ field: '', value: '' });
                break;
            case 'remove-condition':
                const conditionIndex = parseInt(target.dataset.conditionIndex, 10);
                // Validate conditionIndex
                if (isNaN(conditionIndex) || conditionIndex < 0 || !formToEdit.fields[fieldIndex].conditions || conditionIndex >= formToEdit.fields[fieldIndex].conditions.length) {
                    console.warn('Invalid condition index for action:', action, conditionIndex);
                    return;
                }
                formToEdit.fields[fieldIndex].conditions.splice(conditionIndex, 1);
                break;
            default:
                return; // Do nothing if the action is unknown
        }
        
        // Re-render the list to show the change
        renderFieldList(formToEdit.fields);
    });
    
    // Listener for input/select changes
    fieldListContainer.addEventListener('change', (e) => {
        const target = e.target;
        const { fieldIndex, key, conditionIndex } = target.dataset;
        if (fieldIndex === undefined || key === undefined) return;

        const value = target.type === 'checkbox' ? target.checked : target.value;
        const index = parseInt(fieldIndex, 10);

        if (isNaN(index) || index < 0 || index >= formToEdit.fields.length) {
            console.warn('Invalid field index for change event:', index);
            return;
        }

        if (conditionIndex !== undefined) {
            const condIdx = parseInt(conditionIndex, 10);
            if (isNaN(condIdx) || condIdx < 0 || !formToEdit.fields[index].conditions || condIdx >= formToEdit.fields[index].conditions.length) {
                console.warn('Invalid condition index for change event:', condIdx);
                return;
            }
            formToEdit.fields[index].conditions[condIdx][key] = value;
        } else {
            formToEdit.fields[index][key] = key === 'options' ? value.split(',').map(s => s.trim()) : value;
        }

        // If the field type was changed, we must re-render to show/hide the 'options' input
        if (key === 'type') {
            renderFieldList(formToEdit.fields);
        }
    });

    // Listener for the main "Add Field" button
    document.getElementById('add-field-btn')?.addEventListener('click', () => {
        formToEdit.fields.push({ label: '', type: 'text', required: false, conditions: [] });
        renderFieldList(formToEdit.fields);
    });

    // Listener for the form submission
    document.getElementById('form-builder')?.addEventListener('submit', handleFormSave);
}
/**
 * Renders the list of fields. This function is now simpler and only handles rendering.
 * @param {Array<object>} fields - The array of form fields.
 */
function renderFieldList(fields) {
    const container = document.getElementById('field-list');
    if (container) {
        // Ensure fields is an array before mapping
        container.innerHTML = (Array.isArray(fields) ? fields : []).map((field, index) => renderField(field, index, fields)).join('');
    } else {
        console.error('Field list container not found for rendering fields!');
    }
}
/**
 * Renders a single field card in the form builder.
 * @param {object} field - The field object.
 * @param {number} index - The index of the field.
 * @param {Array<object>} allFields - All fields in the form.
 * @returns {string} The HTML string for the field card.
 */
function renderField(field, index, allFields) {
    const fieldTypes = ['text', 'checkbox', 'dropdown', 'multiselect', 'date'];
    const typeOptions = fieldTypes.map(type => `<option value="${type}" ${field.type === type ? 'selected' : ''}>${type.charAt(0).toUpperCase() + type.slice(1)}</option>`).join('');

    // Ensure field properties are initialized to prevent 'undefined' in template literals
    const currentField = { 
        label: field.label || '', 
        type: field.type || 'text', 
        options: Array.isArray(field.options) ? field.options : [], 
        helper: field.helper || '', 
        placeholder: field.placeholder || '', 
        required: !!field.required, 
        conditions: Array.isArray(field.conditions) ? field.conditions : [] 
    };

    return `
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label>Label</label>
                        <input class="form-control" data-field-index="${index}" data-key="label" value="${currentField.label}">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label>Type</label>
                        <select class="form-select" data-field-index="${index}" data-key="type">${typeOptions}</select>
                    </div>
                </div>
                ${['dropdown','multiselect'].includes(currentField.type) ? `<div class="mb-2"><label>Options (comma separated)</label><input class="form-control" data-field-index="${index}" data-key="options" value="${currentField.options.join(', ')}"></div>` : ''}
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label>Helper Text</label>
                        <input class="form-control" data-field-index="${index}" data-key="helper" value="${currentField.helper}">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label>Placeholder</label>
                        <input class="form-control" data-field-index="${index}" data-key="placeholder" value="${currentField.placeholder}">
                    </div>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" data-field-index="${index}" data-key="required" ${currentField.required ? 'checked' : ''}>
                    <label class="form-check-label">Required</label>
                </div>
                <div class="mt-3 border-top pt-2">
                    <label class="form-label">Conditional Display</label>
                    <div id="conditions_${index}">${renderConditions(currentField, index, allFields)}</div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-action="add-condition" data-field-index="${index}">+ Add Condition</button>
                    ${currentField.conditions.length ? `<div class="text-muted small mt-1"><i class="fa fa-eye"></i> Shown if all conditions match</div>` : ''}
                </div>
                <button class="btn btn-sm btn-outline-danger mt-3" data-action="remove-field" data-field-index="${index}">Remove Field</button>
            </div>
        </div>
    `;
}/**
 * Renders the conditional logic inputs for a field.
 * @param {object} field - The field object.
 * @param {number} fieldIndex - The index of the field.
 * @param {Array<object>} allFields - All fields in the form.
 * @returns {string} The HTML for the conditions.
 */
function renderConditions(field, fieldIndex, allFields) {
    // Ensure field.conditions is an array before iterating
    const conditions = Array.isArray(field.conditions) ? field.conditions : [];

    // Filter out the current field itself from the list of fields to depend on
    const availableFieldsForConditions = allFields.filter((_, i) => i !== fieldIndex);

    return conditions.map((cond, condIndex) => `
        <div class="row g-2 align-items-center mb-2">
            <div class="col">
                <select class="form-select" data-field-index="${fieldIndex}" data-condition-index="${condIndex}" data-key="field">
                    <option value="">-- Select Field --</option>
                    ${availableFieldsForConditions.map(opt => `<option value="${opt.label}" ${opt.label === cond.field ? 'selected' : ''}>${opt.label}</option>`).join('')}
                </select>
            </div>
            <div class="col"><input class="form-control" placeholder="Value" data-field-index="${fieldIndex}" data-condition-index="${condIndex}" data-key="value" value="${cond.value || ''}"></div>
            <div class="col-auto"><button class="btn btn-sm btn-outline-danger" data-action="remove-condition" data-field-index="${fieldIndex}" data-condition-index="${condIndex}">×</button></div>
        </div>
    `).join('');
}/**
 * Initializes a new form object and renders the form builder.
 */
window.startNewForm = () => {
    formToEdit = { title: '', target: 'student', classId: '', division: '', fields: [], isActive: true };
    renderFormBuilder();
};/**
 * Finds a form by ID and renders the form builder for editing.
 * @param {string} id - The ID of the form to edit.
 */
window.editForm = (id) => {
    const form = forms.find(f => f.id === id);
    if (form) {
        // Deep copy to avoid direct mutation of the global 'forms' array
        formToEdit = JSON.parse(JSON.stringify(form)); 
        renderFormBuilder();
    } else {
        showAlert('Form not found for editing.', 'danger');
        console.warn('Form not found for editing:', id);
    }
};/**
 * Toggles the active status of a form.
 * @param {string} id - The ID of the form.
 */
window.toggleFormStatus = async (id) => {
    const form = forms.find(f => f.id === id);
    if (form) {
        try {
            await setDoc(getDocRef('forms', id), { ...form, isActive: !form.isActive });
            showAlert(`Form ${form.isActive ? 'deactivated' : 'activated'} successfully.`, 'success');
            // The UI is expected to update via real-time listeners.
            // If not, you would call renderFormManagement() here.
        } catch (error) {
            console.error('Failed to toggle form status:', error);
            showAlert('Failed to update form status. Please try again.', 'danger');
        }
    } else {
        showAlert('Form not found for status toggle.', 'danger');
        console.warn('Form not found for status toggle:', id);
    }
};/**
 * Handles the saving or updating of a form from the form builder.
 * @param {Event} e - The form submission event.
 */
async function handleFormSave(e) {
    e.preventDefault();
    
    const titleInput = document.getElementById('form-title');
    const title = titleInput ? titleInput.value.trim() : '';

    if (!title) {
        showAlert('Form title is required.', 'warning');
        if (titleInput) titleInput.focus();
        return;
    }

    const formTargetEl = document.getElementById('form-target');
    const formClassEl = document.getElementById('form-class');
    const formDivisionEl = document.getElementById('form-division');

    const id = formToEdit.id || `form_${Date.now()}`;
    const data = {
        id,
        title,
        target: formTargetEl ? formTargetEl.value : 'student', // Default if element not found
        classId: formClassEl ? formClassEl.value : '',
        division: formDivisionEl ? formDivisionEl.value.trim() : '',
        fields: formToEdit.fields,
        isActive: formToEdit.isActive,
    };

    try {
        await setDoc(getDocRef('forms', id), data);
        showAlert('Form saved successfully!', 'success');
        formToEdit = null; // Clear the edit state
        renderFormManagement(); // Go back to the form management view
    } catch (error) {
        console.error('Error saving form:', error);
        showAlert('An error occurred while saving the form. Please try again.', 'danger');
    }
}/**
 * Displays all responses for a specific form.
 * @param {string} formId - The ID of the form.
 */
window.viewFormResponses = (formId) => {
    const form = forms.find(f => f.id === formId);
    if (!form) {
        showAlert('Form not found.', 'danger');
        console.warn('Form not found for viewing responses:', formId);
        return;
    }

    // Filter responses for the specific form
    const responses = formResponses.filter(r => r.formId === formId);

    const headers = form.fields.map(f => `<th>${f.label}</th>`).join('');
    const rows = responses.map(r => {
        // Find the user's name (student or teacher) based on userId
        const user = students.find(s => s.id === r.userId) || teachers.find(t => t.id === r.userId);
        const userName = user ? user.name : 'Unknown User';

        const valuesHtml = form.fields.map(f => {
            const key = f.label.replace(/\s+/g, '_').toLowerCase();
            const value = r.values[key];
            return `<td>${value !== undefined && value !== null ? value : '—'}</td>`;
        }).join('');

        return `
            <tr>
                <td>${r.userId}</td>
                <td>${userName}</td>
                ${valuesHtml}
                <td><span class="badge bg-info">${r.status || 'N/A'}</span></td>
            </tr>
        `;
    }).join('');

    const mainContent = document.getElementById('main-content');
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Responses: ${form.title}</h1>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>User Name</th>
                        ${headers}
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>${rows.length ? rows : '<tr><td colspan="100%" class="text-center">No responses yet.</td></tr>'}</tbody>
            </table>
        </div>
        <div class="mt-3 text-end">
            <button class="btn btn-secondary" onclick="renderFormManagement()">Back to Forms</button>
        </div>
    `;
};
// --- TEACHER-SPECIFIC VIEWS ---
/**
 * Renders the dashboard for teachers to see forms they need to fill
 * and to review submissions from students in their class.
 */
window.renderTeacherForms = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }

    // Ensure selectedUser and classCharge are available
    if (!selectedUser || !selectedUser.classCharge) {
        mainContent.innerHTML = '<p class="text-danger">Error: Teacher class information not available.</p>';
        return;
    }

    const { classId, division } = selectedUser.classCharge;
    const studentsInClass = students.filter(s => s.classId === classId && s.division === division);

    // Forms targeted specifically to the teacher's class (for student submissions)
    const studentForms = forms.filter(f => 
        f.target === 'student' && 
        f.isActive && // Only show active forms for student submissions view
        (!f.classId || f.classId === classId) && 
        (!f.division || f.division === division)
    );
    const studentSubmissionsHtml = studentForms.length
        ? studentForms.map(form => renderStudentSubmissionTable(form, studentsInClass)).join('')
        : '<p class="text-muted">No student forms are assigned to your class.</p>';

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Teacher Dashboard</h1>
        <h4 class="mt-4">My Forms</h4>
        <div id="teacher-personal-forms"></div>
        <h4 class="mt-5">Student Submissions</h4>
        ${studentSubmissionsHtml}
    `;

    // Render personal forms into the dedicated container
    // This will use window.renderMyForms to filter forms relevant to the current teacher (selectedUser)
    renderMyForms(document.getElementById('teacher-personal-forms'));
};

window.renderTeacherclasswiseForms = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }

    if (!selectedUser || !selectedUser.classCharge) {
        mainContent.innerHTML = '<p class="alert alert-danger">Error: Teacher class information not available.</p>';
        return;
    }

    const { classId, division } = selectedUser.classCharge;
    const teacherClassName = classes.find(c => c.id === classId)?.name || `Class ${classId}`;

    // Filter forms that are specifically targeted as 'classwise' AND active
    // And match the teacher's class/division or are for 'All' classes/divisions.
    const classForms = forms.filter(f =>
        f.target === 'classwise' && // Assuming a new 'classwise' target type for these forms
        f.isActive &&
        (!f.classId || f.classId === classId) &&
        (!f.division || f.division === division)
    );

    // Initial render of the dashboard structure
    mainContent.innerHTML = `
        <h1 class="h2 mb-4">📋 Classwise Forms for ${teacherClassName} - ${division}</h1>
        <div class="mb-4 d-flex align-items-center gap-2">
            <label for="class-form-selector" class="form-label mb-0 fw-bold">Select Form:</label>
            <select class="form-select w-auto" id="class-form-selector">
                <option value="">-- Choose a form to review --</option>
                ${classForms.map(f => `<option value="${f.id}">${f.title}</option>`).join('')}
            </select>
        </div>
        <div id="class-form-response-table">
            <p class="text-muted">Please select a form from the dropdown to view and manage student data.</p>
        </div>
    `;

    // Event listener for form selection dropdown
    document.getElementById('class-form-selector')?.addEventListener('change', e => {
        const formId = e.target.value;
        if (!formId) {
            document.getElementById('class-form-response-table').innerHTML = '<p class="text-muted">Please select a form from the dropdown to view and manage student data.</p>';
            return;
        }

        const selectedForm = classForms.find(f => f.id === formId);
        if (!selectedForm) {
            showAlert('Selected form not found.', 'danger');
            return;
        }

        // Render the detailed table for the selected form
        renderClassFormSubmissionTable(selectedForm, classId, division);
    });
};

// --- New Helper Function for Conditional Field Display in Teacher View ---
/**
 * Determines if a field's input should be enabled/disabled in the teacher's classwise view
 * based on its conditional logic and the student's current (or submitted) values.
 * @param {object} field - The field configuration object.
 * @param {object} studentValues - The current/submitted values for the student for this form.
 * @param {Array<object>} allFormFields - All fields in the form config.
 * @returns {boolean} True if the field should be enabled, false if disabled.
 */
window.shouldShowFieldForTeacherView = (field, studentValues, allFormFields) => {
    // If no conditions, or conditions array is empty, always show/enable
    if (!field.conditions || field.conditions.length === 0) {
        return true;
    }

    // Check if ALL conditions are met based on the student's current values
    return field.conditions.every(cond => {
        const conditionField = allFormFields.find(f => f.label === cond.field);
        if (!conditionField) {
            // If the field this condition depends on doesn't exist, treat as not met or handle as error
            console.warn(`Condition field "${cond.field}" not found for "${field.label}".`);
            return false;
        }
        const normalizedConditionLabel = conditionField.label.replace(/\s+/g, '_').toLowerCase();
        const actualValue = studentValues[normalizedConditionLabel];
        
        // Convert actualValue to string for consistent comparison if needed
        const actualValueString = (actualValue !== undefined && actualValue !== null) ? String(actualValue) : '';

        // Compare actual value (from student's response) with the required condition value
        return actualValueString === String(cond.value || ''); // Ensure both are strings for comparison
    });
};


// --- New Function to Render the Detailed Submission Table for Teachers ---
/**
 * Renders the detailed table of student submissions for a selected form.
 * @param {object} form - The selected form object.
 * @param {string} classId - The class ID the teacher is viewing.
 * @param {string} division - The division the teacher is viewing.
 */
function renderClassFormSubmissionTable(form, classId, division) {
    const studentsInClass = students.filter(s => s.classId === classId && s.division === division);
    const tableContainer = document.getElementById('class-form-response-table');

    if (!tableContainer) {
        console.error('Table response container not found!');
        return;
    }

    // Headers: Student ID, Name, Admission No., then all form fields, then Teacher Comment
    const headers = ['ID', 'Name', 'Admission No.', ...form.fields.map(f => f.label), 'Comment'];

    const rows = studentsInClass.map(stu => {
        const response = formResponses.find(r => r.formId === form.id && r.userId === stu.id);
        const values = response?.values || {}; // Get values from response, or empty object if no response

        const studentDataCells = `
            <td><strong>${stu.id || 'N/A'}</strong></td>
            <td>${stu.name || 'N/A'}</td>
            <td>${stu.adnumber || 'N/A'}</td> `;

        const formFieldInputCells = form.fields.map(f => {
            const fieldName = f.label.replace(/\s+/g, '_').toLowerCase();
            const fieldValue = values[fieldName] !== undefined && values[fieldName] !== null ? values[fieldName] : '';

            // Determine if the field's input should be disabled based on conditional logic
            const shouldBeEnabled = window.shouldShowFieldForTeacherView(f, values, form.fields);
            const disabledAttr = shouldBeEnabled ? '' : 'disabled';
            const validationPattern = f.validation ? `pattern="${f.validation}"` : ''; // Assuming f.validation holds a regex string
            const validationTitle = f.validation ? `title="${f.helper || 'Invalid format'}"` : '';
            
            let inputHtml = '';
            switch (f.type) {
                case 'checkbox':
                    const isChecked = fieldValue === true || fieldValue === 'true'; // Handle boolean or string 'true'
                    inputHtml = `<div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox"
                                           data-field-name="${fieldName}" data-student-id="${stu.id}"
                                           ${isChecked ? 'checked' : ''} ${disabledAttr}>
                                </div>`;
                    break;
                case 'dropdown':
                    const options = (Array.isArray(f.options) ? f.options : [])
                        .map(o => `<option value="${o}" ${o === fieldValue ? 'selected' : ''}>${o}</option>`)
                        .join('');
                    inputHtml = `<select class="form-select form-select-sm"
                                        data-field-name="${fieldName}" data-student-id="${stu.id}"
                                        ${disabledAttr}>
                                    <option value="">—</option>${options}
                                </select>`;
                    break;
                case 'multiselect':
                     const multiOptions = (Array.isArray(f.options) ? f.options : [])
                        .map(o => `<option value="${o}" ${Array.isArray(fieldValue) && fieldValue.includes(o) ? 'selected' : ''}>${o}</option>`)
                        .join('');
                    inputHtml = `<select class="form-select form-select-sm" multiple
                                        data-field-name="${fieldName}" data-student-id="${stu.id}"
                                        ${disabledAttr}>
                                    ${multiOptions}
                                </select>`;
                    break;
                case 'date':
                    inputHtml = `<input type="date" class="form-control form-control-sm" value="${fieldValue}"
                                    data-field-name="${fieldName}" data-student-id="${stu.id}" ${disabledAttr}
                                    ${validationPattern} ${validationTitle}>`;
                    break;
                case 'text':
                default: // Default to text input
                    inputHtml = `<input type="text" class="form-control form-control-sm" value="${fieldValue}"
                                    data-field-name="${fieldName}" data-student-id="${stu.id}" ${disabledAttr}
                                    ${validationPattern} ${validationTitle}>`;
                    break;
            }

            return `<td>
                        ${inputHtml}
                        ${f.helper ? `<div class="form-text small text-muted mt-1"><code>${f.helper}</code></div>` : ''}
                        <div class="invalid-feedback">Please enter a valid value for <strong>${f.label}</strong>.</div>
                    </td>`;
        }).join('');

        const teacherComment = response?.teacherComment || '';
        const commentInputHtml = `
            <input type="text" class="form-control form-control-sm"
                   data-field-name="teacherComment" data-student-id="${stu.id}"
                   value="${teacherComment}">
        `;

        return `
            <tr>
                ${studentDataCells}
                ${formFieldInputCells}
                <td>${commentInputHtml}</td>
            </tr>`;
    }).join('');

    const tableHtml = `
        <form id="classwise-submissions-form-${form.id}">
            <div class="card shadow-sm">
                <div class="card-header fw-bold bg-light d-flex justify-content-between align-items-center">
                    <span>${form.title}</span>
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="window.downloadFormResponsesCSV('${form.id}', '${classId}', '${division}')">
                        <i class="fa fa-download me-1"></i> Export CSV
                    </button>
                </div>
                <div class="card-body p-3">
                    <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                        <table class="table table-sm table-bordered align-middle text-nowrap">
                            <thead class="table-light sticky-top" style="top: 0; z-index: 1;">
                                <tr>
                                    ${headers.map(h => `<th>${h}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>${rows.length ? rows : `<tr><td colspan="${headers.length}" class="text-center">No students found or no data to display for this form.</td></tr>`}</tbody>
                        </table>
                    </div>
                    <div class="text-end mt-3">
                        <button type="submit" class="btn btn-success" id="save-classwise-data-btn-${form.id}">
                            <i class="fa fa-save me-1"></i> Save All Changes
                        </button>
                    </div>
                </div>
            </div>
        </form>`;

    tableContainer.innerHTML = tableHtml;

    // Attach event listener for the batch save button
    document.getElementById(`save-classwise-data-btn-${form.id}`)?.addEventListener('click', async (e) => {
        e.preventDefault();
        await window.saveTeacherClasswiseForm(form, studentsInClass);
    });
}


// --- New Function for Batch Saving Teacher-Edited Student Form Data ---
/**
 * Saves all changes made by the teacher in the classwise submission table.
 * This includes updates to student form field values and teacher comments.
 * @param {object} form - The form object being edited.
 * @param {Array<object>} studentsInClass - Array of student objects in the teacher's class.
 */
window.saveTeacherClasswiseForm = async (form, studentsInClass) => {
    const saveButton = document.getElementById(`save-classwise-data-btn-${form.id}`);
    const originalButtonHtml = saveButton ? saveButton.innerHTML : '<i class="fa fa-save me-1"></i> Save All Changes';

    if (saveButton) {
        saveButton.disabled = true;
        saveButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...`;
    }

    try {
        const updatePromises = [];
        const formEl = document.getElementById(`classwise-submissions-form-${form.id}`);

        for (const student of studentsInClass) {
            // Find existing response or create a new stub if none exists
            let existingResponse = formResponses.find(r => r.formId === form.id && r.userId === student.id);
            let currentValues = existingResponse ? { ...existingResponse.values } : {}; // Clone existing values
            let teacherComment = existingResponse?.teacherComment || '';

            let hasChanged = false; // Flag to track if this student's response needs an update

            // 1. Collect form field values
            for (const field of form.fields) {
                const fieldName = field.label.replace(/\s+/g, '_').toLowerCase();
                const inputElement = formEl.querySelector(`[data-field-name="${fieldName}"][data-student-id="${student.id}"]`);

                if (inputElement) {
                    let newValue;
                    if (inputElement.type === 'checkbox') {
                        newValue = inputElement.checked;
                    } else if (inputElement.tagName === 'SELECT' && inputElement.multiple) {
                         newValue = Array.from(inputElement.selectedOptions).map(option => option.value);
                    } else {
                        newValue = inputElement.value.trim();
                    }
                    
                    // Only update if value is different AND field is enabled OR was previously present
                    const isEnabled = !inputElement.disabled;
                    if (isEnabled || (currentValues[fieldName] !== undefined)) {
                        // Check if the value actually changed
                        if (JSON.stringify(currentValues[fieldName]) !== JSON.stringify(newValue)) {
                            currentValues[fieldName] = newValue;
                            hasChanged = true;
                        }
                    }
                }
            }

            // 2. Collect teacher comment
            const commentInput = formEl.querySelector(`[data-field-name="teacherComment"][data-student-id="${student.id}"]`);
            if (commentInput) {
                const newComment = commentInput.value.trim();
                if (teacherComment !== newComment) {
                    teacherComment = newComment;
                    hasChanged = true;
                }
            }

            // If anything has changed for this student's response, prepare an update
            if (hasChanged) {
                const responseData = {
                    id: existingResponse ? existingResponse.id : `${form.id}_${student.id}`,
                    formId: form.id,
                    userId: student.id,
                    values: currentValues,
                    status: existingResponse?.status || 'submitted', // Maintain existing status, or default if new entry
                    timestamp: existingResponse?.timestamp || new Date().toISOString(), // Keep original timestamp if existing
                    teacherComment: teacherComment
                };
                updatePromises.push(setDoc(getDocRef('formResponses', responseData.id), responseData));
            }
        }

        if (updatePromises.length > 0) {
            await Promise.all(updatePromises);
            showAlert('All changes saved successfully!', 'success');
        } else {
            showAlert('No changes to save.', 'info');
        }

    } catch (error) {
        console.error('Error during batch save:', error);
        showAlert('An error occurred during batch save. Please try again.', 'danger');
    } finally {
        if (saveButton) {
            saveButton.disabled = false;
            saveButton.innerHTML = originalButtonHtml;
        }
    }
    // Optionally re-render table to reflect any dynamic changes if not using real-time listeners
    // renderClassFormSubmissionTable(form, form.classId, form.division);
};


// --- Update CSV Export to be class-specific ---
// Assuming downloadFormResponsesCSV is meant to be flexible
window.downloadFormResponsesCSV = (formId, classId = null, division = null) => {
    const form = forms.find(f => f.id === formId);
    if (!form) {
        showAlert('Form not found for CSV export.', 'danger');
        return;
    }

    let filteredResponses = formResponses.filter(r => r.formId === formId);
    let targetStudents = students;

    if (classId && division) {
        targetStudents = students.filter(s => s.classId === classId && s.division === division);
        const studentIdsInClass = new Set(targetStudents.map(s => s.id));
        filteredResponses = filteredResponses.filter(r => studentIdsInClass.has(r.userId));
    }

    const headers = ['User ID', 'User Name', 'Admission No.', ...form.fields.map(f => f.label), 'Teacher Comment', 'Student Reply'];
    const rows = filteredResponses.map(r => {
        const user = targetStudents.find(s => s.id === r.userId) || teachers.find(t => t.id === r.userId);
        const userName = user ? user.name : 'Unknown User';
        const userAdnumber = user?.adnumber || ''; // Assuming adnumber
        const teacherComment = r.teacherComment || '';
        const studentReply = r.studentReply || '';

        const fieldValues = form.fields.map(f => {
            const key = f.label.replace(/\s+/g, '_').toLowerCase();
            const value = r.values[key];
            if (Array.isArray(value)) {
                return value.join(';');
            }
            return value !== undefined && value !== null ? String(value) : '';
        });

        const rowData = [
            r.userId,
            userName,
            userAdnumber,
            ...fieldValues,
            teacherComment,
            studentReply
        ];
        
        return rowData.map(val => `"${String(val).replace(/"/g, '""')}"`).join(',');
    });

    const csvContent = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    let fileName = `${form.title.replace(/\s+/g, '_')}`;
    if (classId && division) {
        const className = classes.find(c => c.id === classId)?.name || classId;
        fileName += `_${className}_${division}`;
    }
    fileName += `_responses_${new Date().toISOString().slice(0,10)}.csv`;

    link.download = fileName;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
};
// --- STUDENT-SPECIFIC VIEWS ---
/**
 * Renders a table of student submissions for a specific form.
 * @param {object} form - The form object.
 * @param {Array<object>} studentsInClass - The list of students in the teacher's class.
 * @returns {string} The HTML string for the submission table.
 */
function renderStudentSubmissionTable(form, studentsInClass) {
    // Collect all field labels for headers
    const headers = ['Student ID', 'Name', ...form.fields.map(f => f.label), 'Teacher Comment', 'Student Reply'];

    const rows = studentsInClass.map(student => {
        const response = formResponses.find(r => r.formId === form.id && r.userId === student.id);
        
        // Map field values, using the normalized key
        const values = form.fields.map(f => {
            const normalizedLabel = f.label.replace(/\s+/g, '_').toLowerCase();
            const value = response?.values?.[normalizedLabel];
            return `<td>${value !== undefined && value !== null ? value : '—'}</td>`;
        }).join('');

        return `
            <tr>
                <td>${student.id}</td>
                <td>${student.name}</td>
                ${values}
                <td>
                    <input type="text" class="form-control form-control-sm"
                            id="comment_${student.id}_${form.id}"
                            value="${response?.teacherComment || ''}"
                            onblur="window.updateTeacherComment('${form.id}', '${student.id}', this.value)">
                </td>
                <td>
                    ${response?.studentReply ? `<i class='fa fa-reply me-1 text-info'></i> ${response.studentReply}` : '—'}
                </td>
            </tr>
        `;
    }).join('');

    return `
        <div class="card mb-4">
            <div class="card-header fw-bold d-flex justify-content-between align-items-items-center">
                <span>${form.title}</span>
                <div>
                    <button class="btn btn-sm btn-outline-success me-2" onclick="window.finalizeForm('${form.id}')">Finalize All</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="window.downloadFormResponsesCSV('${form.id}')">
                        <i class="fa fa-download"></i> Export CSV
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                        <tbody>${rows.length ? rows : '<tr><td colspan="${headers.length}" class="text-center">No student responses for this form.</td></tr>'}</tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

/**
 * Updates the teacher's comment on a student's form response.
 * @param {string} formId
 * @param {string} studentId
 * @param {string} comment
 */
/**
 * Updates the teacher's comment on a student's form response.
 * @param {string} formId
 * @param {string} studentId
 * @param {string} comment
 */
window.updateTeacherComment = async (formId, studentId, comment) => {
    const response = formResponses.find(r => r.formId === formId && r.userId === studentId);
    if (response) {
        try {
            await setDoc(getDocRef('formResponses', response.id), { ...response, teacherComment: comment });
            showAlert('Comment saved.', 'success');
        } catch (error) {
            console.error('Failed to update teacher comment:', error);
            showAlert('Failed to save comment. Please try again.', 'danger');
        }
    } else {
        console.warn(`Response not found for formId: ${formId}, studentId: ${studentId}`);
        // Optionally, showAlert('Response not found to add comment.', 'warning');
    }
};
/**
 * Finalizes all submitted responses for a form, preventing further edits.
 * @param {string} formId
 */
window.finalizeForm = async (formId) => {
    if (!confirm('Are you sure you want to finalize all submissions for this form? This action cannot be undone.')) return;

    const responsesToFinalize = formResponses.filter(r => r.formId === formId && r.status === 'submitted');
    
    if (responsesToFinalize.length === 0) {
        showAlert('No submitted responses to finalize for this form.', 'info');
        return;
    }

    const updatePromises = responsesToFinalize.map(r => 
        setDoc(getDocRef('formResponses', r.id), { ...r, status: 'finalized' })
    );

    try {
        await Promise.all(updatePromises);
        showAlert('Form finalized successfully. Students can no longer edit their responses.', 'success');
        // UI should update via real-time listeners.
    } catch (error) {
        console.error('Failed to finalize form responses:', error);
        showAlert('An error occurred during finalization. Please try again.', 'danger');
    }
};
// --- STUDENT/USER FORM FILLING & VIEWING ---

/**
 * Renders forms for the current user (student or teacher) to fill out or view.
 * @param {HTMLElement} [container=mainContent] - The container to render the content into.
 *//**
 * Renders forms for the current user (student or teacher) to fill out or view.
 * @param {HTMLElement} [container=mainContent] - The container to render the content into.
 */
window.renderMyForms = (container = document.getElementById('main-content')) => {
    if (!container) {
        console.error('Container element not found for renderMyForms!');
        return;
    }

    if (!selectedUser || !currentUserRole) {
        container.innerHTML = '<p class="text-danger">Error: User information not available.</p>';
        return;
    }

    const userForms = forms.filter(f => {
        if (f.target !== currentUserRole) return false;
        if (currentUserRole === 'student') {
            const classMatch = !f.classId || f.classId === selectedUser.classId;
            const divisionMatch = !f.division || f.division === selectedUser.division;
            return classMatch && divisionMatch;
        }
        // For teachers, if target is 'teacher', it applies to all teachers by default
        return true;
    });

    const categorizeForms = (formsList) => {
        const submitted = [], notSubmitted = [];
        formsList.forEach(form => {
            const hasResponse = formResponses.some(r => r.formId === form.id && r.userId === selectedUser.id);
            (hasResponse ? submitted : notSubmitted).push(form);
        });
        return { submitted, notSubmitted };
    };

    // Filter by isActive status first
    const activeForms = userForms.filter(f => f.isActive);
    const closedForms = userForms.filter(f => !f.isActive);

    const { submitted: activeSubmitted, notSubmitted: activeNotSubmitted } = categorizeForms(activeForms);
    const { submitted: closedSubmitted, notSubmitted: closedNotSubmitted } = categorizeForms(closedForms);

    const renderCategory = (title, icon, formsList) => {
        if (!formsList.length) return ''; // Only render if there are forms in the category
        return `
            <h4 class="mt-4"><i class="fa ${icon} me-1"></i> ${title}</h4>
            ${formsList.map(renderFormCardForUser).join('')}
        `;
    };

    container.innerHTML = `
        <h1 class="h2 mb-4">My Forms</h1>
        ${renderCategory('Active - To Do', 'fa-pencil-alt', activeNotSubmitted)}
        ${renderCategory('Active - Submitted', 'fa-check-circle', activeSubmitted)}
        ${renderCategory('Closed - Submitted', 'fa-folder', closedSubmitted)}
        ${renderCategory('Closed - Incomplete', 'fa-folder-open', closedNotSubmitted)}
        ${!userForms.length ? '<p class="text-muted">No forms found.</p>' : ''}
    `;

    // After rendering, initialize conditional logic for any forms rendered as submittable
    activeNotSubmitted.forEach(form => initializeConditionalForm(form));
    // If you allow editing submitted forms, you might also need to initialize them here.
};/**
 * Renders a single form card for the current user.
 * It can be a submittable form or a view of a submitted response.
 * @param {object} form - The form object.
 * @returns {string} The HTML for the form card.
 */
function renderFormCardForUser(form) {
    const response = formResponses.find(r => r.formId === form.id && r.userId === selectedUser.id);
    const isSubmitted = !!response;
    const isFinalized = response?.status === 'finalized';

    let statusBadge;
    if (!form.isActive) {
        statusBadge = '<span class="badge bg-light text-dark"><i class="fa fa-ban me-1"></i> Closed</span>';
    } else if (isFinalized) {
        statusBadge = '<span class="badge bg-secondary"><i class="fa fa-lock me-1"></i> Finalized</span>';
    } else if (isSubmitted) {
        statusBadge = '<span class="badge bg-info"><i class="fa fa-check me-1"></i> Submitted</span>';
    } else {
        statusBadge = '<span class="badge bg-success"><i class="fa fa-pencil-alt me-1"></i> Active</span>';
    }

    const cardBody = isSubmitted
        ? renderSubmittedFormView(form, response)
        : renderSubmittableForm(form);

    return `
        <div class="card mb-3">
            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                ${form.title}
                ${statusBadge}
            </div>
            <div class="card-body">${cardBody}</div>
        </div>
    `;
}/**
 * Renders the view for a form that has already been submitted.
 * @param {object} form - The form object.
 * @param {object} response - The user's response object.
 * @returns {string} HTML content for the card body.
 */
/**
 * Renders the fields for a form that the user can fill and submit.
 * @param {object} form - The form object.
 * @returns {string} HTML content for the card body.
 */
function renderSubmittableForm(form) {
    if (!form.isActive) {
        return '<p class="text-muted">This form is closed and no longer accepting responses.</p>';
    }

    const fieldsHtml = form.fields
        .map(field => renderFormInputField(field))
        .join('');

    return `
        <form id="form-submit-${form.id}" novalidate>
            ${fieldsHtml}
            <button type="submit" class="btn btn-primary">
                <i class="fa fa-paper-plane me-1"></i> Submit
            </button>
        </form>
    `;
}

function renderSubmittedFormView(form, response) {
    const isFinalized = response.status === 'finalized';

    const fieldList = form.fields.map(field => {
        const normalizedLabel = field.label.replace(/\s+/g, '_').toLowerCase();
        const value = response.values[normalizedLabel];
        return `<li class="list-group-item"><strong>${field.label}:</strong> ${value !== undefined && value !== null ? value : '<em>Not provided</em>'}</li>`;
    }).join('');

    return `
        <ul class="list-group list-group-flush mb-3">${fieldList}</ul>
        ${response.teacherComment ? `<p class="mb-2"><i class="fa fa-comment-dots text-muted me-1"></i><strong>Teacher's Comment:</strong> ${response.teacherComment}</p>` : ''}
        ${!isFinalized && form.isActive ? `<button class="btn btn-warning" onclick="window.editMyForm('${form.id}')"><i class="fa fa-edit me-1"></i> Edit Response</button>` : ''}
        ${response.studentReply ? `<p class="mt-2"><i class="fa fa-reply text-muted me-1"></i><strong>Your Reply:</strong> ${response.studentReply}</p>` : ''}
        ${isFinalized && currentUserRole === 'student' ? `<p class="text-info mt-2"><i class="fa fa-info-circle me-1"></i> This form has been finalized and can no longer be edited.</p>` : ''}
    `;
}/**
 * Attaches the conditional logic and event listeners to a submittable form
 * that has already been rendered to the page.
 * @param {object} form - The configuration object for the form to initialize.
 */
function initializeConditionalForm(form) {
    const formId = `form-submit-${form.id}`;
    const formEl = document.getElementById(formId);

    // If the form element doesn't exist on the page, do nothing.
    if (!formEl) {
        console.warn(`Form element with ID ${formId} not found. Conditional logic not initialized.`);
        return;
    }

    /**
     * Checks all conditional fields and toggles their visibility.
     */
    const updateVisibility = () => {
        // Get all current values from the form's inputs.
        const currentValues = {};
        form.fields.forEach(f => {
            const inputName = f.label.replace(/\s+/g, '_').toLowerCase();
            const inputEl = formEl.elements[inputName];
            if (inputEl) {
                // For checkbox, value is its checked state. For others, it's the trimmed value.
                currentValues[f.label] = inputEl.type === 'checkbox' ? inputEl.checked.toString() : inputEl.value.trim();
            }
        });

        // Loop through each field to check if its conditions are met.
        form.fields.forEach(fieldToCheck => {
            const containerId = `container_${fieldToCheck.label.replace(/\s+/g, '_').toLowerCase()}`;
            const fieldContainer = document.getElementById(containerId);
            if (!fieldContainer) {
                console.warn(`Container for field "${fieldToCheck.label}" not found. Cannot apply conditional logic.`);
                return;
            }

            let shouldShow = true;
            if (fieldToCheck.conditions && fieldToCheck.conditions.length > 0) {
                // All conditions must be true for the field to show
                shouldShow = fieldToCheck.conditions.every(cond => {
                    // Check if the actual value matches the condition's required value.
                    // Important: The value from currentValues[cond.field] should match cond.value exactly.
                    return currentValues[cond.field] === cond.value;
                });
            }

            // Toggle the display property.
            fieldContainer.style.display = shouldShow ? 'block' : 'none';

            // If a field becomes hidden, clear its value to avoid submitting hidden data
            // unless specifically required by design. This example clears it.
            if (!shouldShow) {
                const inputName = fieldToCheck.label.replace(/\s+/g, '_').toLowerCase();
                const inputEl = formEl.elements[inputName];
                if (inputEl) {
                    if (inputEl.type === 'checkbox') {
                        inputEl.checked = false;
                    } else {
                        inputEl.value = '';
                    }
                }
            }
        });
    };

    // Add a single 'change' event listener to the form to handle all interactions.
    // 'input' event might be better for text fields if real-time update is desired.
    formEl.addEventListener('change', updateVisibility);

    // Call it once immediately to set the correct initial visibility of all fields.
    updateVisibility();

    formEl.addEventListener('submit', (event) => {
        // We pass both the event and the form's configuration object
        handleFormSubmission(event, form);
    });
}
   /**
 * Handles the submission of a dynamic form.
 * It gathers and validates data only from visible fields before saving.
 * @param {Event} event - The form's submit event object.
 * @param {object} formConfig - The configuration object for the submitted form.
 */
window.editMyForm = (formId) => {
    const form = forms.find(f => f.id === formId);
    const response = formResponses.find(r => r.formId === formId && r.userId === selectedUser.id);
    if (!form || !response) return;

    mainContent.innerHTML = `<h1 class="h2 mb-4">Edit Form - ${form.title}</h1>
        <form id="edit-form-fields">
            ${form.fields.map(f => {
                const name = f.label.replace(/\s+/g, '_').toLowerCase();
                const val = response.values[name];
                if (f.type === 'text') {
                    return `<div class="mb-2"><label>${f.label}</label><input class="form-control" id="${name}" value="${val || ''}"></div>`;
                } else if (f.type === 'dropdown') {
                    return `<div class="mb-2"><label>${f.label}</label><select class="form-select" id="${name}"><option value="">Select</option><option${val === 'Option 1' ? ' selected' : ''}>Option 1</option><option${val === 'Option 2' ? ' selected' : ''}>Option 2</option></select></div>`;
                } else if (f.type === 'checkbox') {
                    return `<div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="${name}" ${val ? 'checked' : ''}>
                                <label class="form-check-label" for="${name}">${f.label}</label>
                            </div>`;
                }
                return '';
            }).join('')}
            <button type="submit" class="btn btn-success">Update</button>
        </form>`;

    document.getElementById('edit-form-fields').addEventListener('submit', async e => {
        e.preventDefault();
        const values = {};
        for (const f of form.fields) {
            const name = f.label.replace(/\s+/g, '_').toLowerCase();
            const el = document.getElementById(name);
            values[name] = f.type === 'checkbox' ? el?.checked || false : el?.value?.trim() || '';
        }
        await setDoc(getDocRef('formResponses', response.id), { ...response, values });
        showAlert('Form updated successfully', 'success');
        renderMyForms();
    });
};
async function handleFormSubmission(event, formConfig) {
    // 1. Prevent the default browser action (reloading the page)
    event.preventDefault();
    
    const formEl = event.target;
    const submitButton = formEl.querySelector('button[type="submit"]');
    const originalButtonHtml = submitButton.innerHTML;

    // Disable button to prevent multiple submissions
    if (submitButton) {
        submitButton.disabled = true;
        submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...`;
    }

    try {
        const values = {};
        let isValid = true;

        // 2. Loop through the fields DEFINED IN THE CONFIG to check for visibility and value
        for (const field of formConfig.fields) {
            const containerId = `container_${field.label.replace(/\s+/g, '_').toLowerCase()}`;
            const container = document.getElementById(containerId);
            
            // If the field's container is not visible, skip it
            if (!container || container.style.display === 'none') {
                continue; // Skip processing hidden fields
            }

            // The field is visible, so get its value
            const inputName = field.label.replace(/\s+/g, '_').toLowerCase();
            const inputEl = formEl.elements[inputName];
            
            if (!inputEl) {
                console.warn(`Input element for field "${field.label}" not found.`);
                continue; // Skip if input element is missing
            }

            let value;
            if (inputEl.type === 'checkbox') {
                value = inputEl.checked;
            } else if (inputEl.type === 'radio') {
                // For radio buttons, you might need to iterate over all radios with the same name
                // This example assumes a single input element for simplicity for now.
                value = inputEl.value.trim();
            } else if (inputEl.tagName === 'SELECT' && inputEl.multiple) {
                value = Array.from(inputEl.selectedOptions).map(option => option.value);
            } else {
                value = inputEl.value.trim();
            }

            // 3. Validate the visible field if it's required
            if (field.required && (value === '' || value === false || (Array.isArray(value) && value.length === 0))) {
                showAlert(`Please fill out the required field: ${field.label}`, 'warning');
                isValid = false;
                break; // Stop validation on first error
            }
            
            values[inputName] = value;
        }

        if (!isValid) {
            // Re-enable button and stop the submission if validation failed
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonHtml;
            }
            return; 
        }

        // 4. Construct the response object and save it
        // Assumes 'selectedUser' is globally available and valid
        if (!selectedUser || !selectedUser.id) {
            showAlert('User information is missing. Cannot submit form.', 'danger');
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonHtml;
            }
            return;
        }

        const responseData = {
            id: `${formConfig.id}_${selectedUser.id}`, 
            formId: formConfig.id,
            userId: selectedUser.id,
            values: values,
            status: 'submitted', // Or 'draft' if you have a save draft feature
            timestamp: new Date().toISOString(),
        };

        // Assumes 'setDoc' and 'getDocRef' are Firebase functions available globally
        await setDoc(getDocRef('formResponses', responseData.id), responseData);
        
        showAlert('Form submitted successfully!', 'success');
        
        // Refresh the UI to show the form has moved to the "Submitted" category
        window.renderMyForms();

    } catch (error) {
        console.error("Form submission failed:", error);
        showAlert('An error occurred during submission. Please try again.', 'danger');
    } finally {
        // Always re-enable button and restore its original content
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonHtml;
        }
    }
}

/**
 * Renders a single input field for a form.
 * @param {object} field - The field configuration object.
 * @returns {string} The HTML string for the input field.
 */
function renderFormInputField(field) {
    const name = field.label.replace(/\s+/g, '_').toLowerCase();
    const required = field.required ? 'required' : '';
    const helper = field.helper ? `<small class="form-text text-muted">${field.helper}</small>` : '';
    
    // Determine if the field should be hidden initially
    const hasConditions = field.conditions && field.conditions.length > 0;
    const initialStyle = hasConditions ? 'display:none;' : '';
    
    let fieldHtml = '';
    switch (field.type) {
        case 'checkbox':
            fieldHtml = `<div class="form-check mb-3"><input class="form-check-input" name="${name}" type="checkbox" id="${name}" ${required}><label class="form-check-label" for="${name}">${field.label}</label>${helper}</div>`;
            break;
        case 'dropdown':
            const options = (field.options || []).map(o => `<option value="${o}">${o}</option>`).join('');
            fieldHtml = `<div class="mb-3"><label for="${name}" class="form-label">${field.label}</label><select class="form-select" name="${name}" id="${name}" ${required}><option value="">-- Select --</option>${options}</select>${helper}</div>`;
            break;
        // ... other cases like multiselect, date, text
        default:
            fieldHtml = `<div class="mb-3"><label for="${name}" class="form-label">${field.label}</label><input type="text" class="form-control" name="${name}" id="${name}" placeholder="${field.placeholder || ''}" ${required}>${helper}</div>`;
            break;
    }

    // Wrap the field in a container div with a unique ID to control its visibility
    return `<div id="container_${name}" style="${initialStyle}">${fieldHtml}</div>`;
}



// --- UTILITY & HELPER FUNCTIONS ---

/**
 * Downloads form responses as a CSV file.
 * @param {string} formId - The ID of the form.
 */
window.downloadFormResponsesCSV = (formId) => {
    const form = forms.find(f => f.id === formId);
    if (!form) return;

    const responses = formResponses.filter(r => r.formId === formId);
    const headers = ['User ID', 'User Name', ...form.fields.map(f => f.label)];
    const rows = responses.map(r => {
        const user = students.find(s => s.id === r.userId) || teachers.find(t => t.id === r.userId);
        const rowData = [
            r.userId,
            user ? user.name : 'Unknown User',
            ...form.fields.map(f => r.values[f.label.replace(/\s+/g, '_').toLowerCase()] || '')
        ];
        return rowData.map(val => `"${String(val).replace(/"/g, '""')}"`).join(',');
    });

    const csvContent = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${form.title.replace(/\s+/g, '_')}_responses.csv`;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

/**
 * Renders a generic bulk import tool for uploading CSV data to Firestore collections.
 * Supports 'students' and 'teachers' collections.
 */
// --- BULK IMPORT MODULE (CORRECTED) ---

// Global variable to hold the parsed and potentially edited records
let currentBulkImportRecords = [];

/**
 * Renders a generic bulk import tool for uploading CSV data to Firestore collections.
 */
window.renderBulkImportTool = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Bulk Data Import (CSV)</h1>
        <div class="card shadow mb-4">
            <div class="card-body">
                <p class="text-muted">Upload a CSV file to bulk add/update data.</p>
                <div class="alert alert-info" role="alert">
                    <strong>Important CSV Format:</strong>
                    <ul>
                        <li>**Students/Teachers:** Your CSV MUST have a column named **'id'** (case-insensitive). Existing documents with the same 'id' will be overwritten.</li>
                        <li>**Subject Allocations:** Do NOT include an 'id' column. It will be generated automatically. Required columns are: **classId, division, subjectId, teacherId, weeklyHour**.</li>
                        <li>For teachers, use dot notation for nested fields: **classCharge.classId** and **classCharge.division**.</li>
                    </ul>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label for="collection-select" class="form-label">Select Collection</label>
                        <select id="collection-select" class="form-select" required>
                            <option value="">-- Choose Collection --</option>
                            <option value="students">Students</option>
                            <option value="teachers">Teachers</option>
                            <option value="classroomSubjects">Subject Allocations</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="csv-file-input" class="form-label">Upload CSV File</label>
                        <input type="file" id="csv-file-input" class="form-control" accept=".csv" required>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <button id="process-csv-btn" class="btn btn-primary btn-lg">
                        <i class="fas fa-file-import me-2"></i>Process CSV
                    </button>
                </div>

                <div id="upload-status-messages" class="mt-4"></div>
                
                <div id="editable-data-preview" class="mt-5 d-none">
                    <h4 class="mb-3">Review & Edit Data:</h4>
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table id="bulk-import-table" class="table table-bordered table-striped table-sm text-nowrap">
                            <thead class="table-light"></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-end mt-4">
                        <button id="cancel-review-btn" class="btn btn-secondary me-2">Cancel Review</button>
                        <button id="final-upload-btn" class="btn btn-success btn-lg">
                            <i class="fas fa-upload me-2"></i>Final Upload
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    const collectionSelect = document.getElementById('collection-select');
    const csvFileInput = document.getElementById('csv-file-input');
    const processCsvBtn = document.getElementById('process-csv-btn');
    const statusMessagesDiv = document.getElementById('upload-status-messages');
    const editableDataPreviewDiv = document.getElementById('editable-data-preview');
    const bulkImportTableHead = document.querySelector('#bulk-import-table thead');
    const bulkImportTableBody = document.querySelector('#bulk-import-table tbody');
    const finalUploadBtn = document.getElementById('final-upload-btn');
    const cancelReviewBtn = document.getElementById('cancel-review-btn');

    processCsvBtn.addEventListener('click', async () => {
        const collectionName = collectionSelect.value;
        const file = csvFileInput.files[0];

        if (!collectionName || !file) {
            showAlert('Please select a collection and a CSV file.', 'danger');
            return;
        }

        statusMessagesDiv.innerHTML = '';
        editableDataPreviewDiv.classList.add('d-none');
        processCsvBtn.disabled = true;
        processCsvBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Processing...`;

        const reader = new FileReader();
        reader.onload = async (e) => {
            const csvText = e.target.result;
            const parseResult = parseCSVForPreview(csvText, collectionName); 
            currentBulkImportRecords = parseResult.records;
            
            if (parseResult.errors.length > 0) {
                statusMessagesDiv.innerHTML = `<div class="alert alert-warning"><strong>Parsing Warnings:</strong><ul>${parseResult.errors.map(err => `<li>${err}</li>`).join('')}</ul></div>`;
            }

            if (currentBulkImportRecords.length > 0) {
                renderEditableTable(currentBulkImportRecords, bulkImportTableHead, bulkImportTableBody, collectionName);
                editableDataPreviewDiv.classList.remove('d-none');
                showAlert(`CSV processed! ${currentBulkImportRecords.length} records ready for review.`, 'success');
            } else {
                 showAlert('No valid records found to import.', 'danger');
            }
            processCsvBtn.disabled = false;
            processCsvBtn.innerHTML = `<i class="fas fa-file-import me-2"></i>Process CSV`;
        };
        reader.readAsText(file);
    });

    finalUploadBtn.addEventListener('click', async () => {
        const collectionName = collectionSelect.value;
        const recordsToUpload = readDataFromEditableTable(bulkImportTableHead, bulkImportTableBody, collectionName);

        if (recordsToUpload.length > 0) {
            await performFinalUpload(collectionName, recordsToUpload, statusMessagesDiv);
        } else {
            showAlert('No valid records to upload.', 'danger');
        }
    });

    cancelReviewBtn.addEventListener('click', () => {
        currentBulkImportRecords = [];
        editableDataPreviewDiv.classList.add('d-none');
        statusMessagesDiv.innerHTML = '';
        csvFileInput.value = '';
        collectionSelect.value = '';
        showAlert('Review cancelled.', 'info');
    });
};

/**
 * Parses CSV text into records, performs initial validation, and returns records with errors.
 */
function parseCSVForPreview(csvText, collectionName) {
    const lines = csvText.trim().split('\n');
    const records = [];
    const errors = [];
    if (lines.length <= 1) {
        errors.push('CSV file is empty or only contains headers.');
        return { records, errors };
    }

    const headers = lines[0].split(',').map(h => h.trim());
    
    if (collectionName !== 'classroomSubjects' && headers.indexOf('id') === -1) {
        errors.push(`CSV for '${collectionName}' must contain an "id" column.`);
        return { records, errors };
    }

    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        if (values.length !== headers.length) {
            errors.push(`Row ${i + 1}: Column count mismatch. Skipping.`);
            continue;
        }
        const record = { __rowIndex: i + 1 };
        headers.forEach((header, index) => {
            record[header] = values[index].trim();
        });
        records.push(record);
    }
    return { records, errors };
}

/**
 * Renders the parsed records into an editable HTML table for review.
 */
function renderEditableTable(records, theadElement, tbodyElement, collectionName) {
    const headers = Object.keys(records[0]).filter(key => !key.startsWith('__'));
    theadElement.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
    tbodyElement.innerHTML = records.map((record, rowIndex) => `
        <tr data-row-index="${rowIndex}">
            ${headers.map(header => `<td><input type="text" class="form-control form-control-sm editable-input" data-header="${header}" value="${record[header]}"></td>`).join('')}
        </tr>
    `).join('');
}

/**
 * Reads data directly from the editable table, performs final validation, and prepares for upload.
 */
function readDataFromEditableTable(theadElement, tbodyElement, collectionName) {
    const headers = Array.from(theadElement.querySelectorAll('th')).map(th => th.textContent.trim());
    const recordsToUpload = [];

    Array.from(tbodyElement.querySelectorAll('tr')).forEach(row => {
        const record = {};
        
        Array.from(row.querySelectorAll('.editable-input')).forEach((input, inputIndex) => {
            const header = headers[inputIndex];
            const value = input.value.trim();
            
            if (header.includes('.')) {
                const parts = header.split('.');
                const mainKey = parts[0] === 'classcharge' ? 'classCharge' : parts[0];
                const subKey = parts[1] === 'classid' ? 'classId' : parts[1];
                if (!record[mainKey]) record[mainKey] = {};
                record[mainKey][subKey] = value;
            } else {
                record[header] = value;
            }
        });
        recordsToUpload.push(record);
    });
    return recordsToUpload;
}

/**
 * Performs the final batch upload of records to Firestore.
 */
async function performFinalUpload(collectionName, recordsToUpload, statusDiv) {
    const finalUploadBtn = document.getElementById('final-upload-btn');
    finalUploadBtn.disabled = true;
    finalUploadBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Uploading...`;
    statusDiv.innerHTML = `<p class="text-info">Uploading ${recordsToUpload.length} records...</p>`;

    const batch = writeBatch(db);
    recordsToUpload.forEach(record => {
        let docId;
        let dataToSave = { ...record };

        if (collectionName === 'classroomSubjects') {
            docId = `${record.classId}_${record.division}_${record.subjectId}_${record.teacherId}`;
            dataToSave.id = docId;
            // Ensure weeklyHour is a number
            dataToSave.weeklyHour = parseInt(dataToSave.weeklyhour) || 0;
            delete dataToSave.weeklyhour; // remove lowercase version
        } else {
            docId = record.id;
        }
        
        if (docId) {
            const docRef = getDocRef(collectionName, docId);
            batch.set(docRef, dataToSave);
        }
    });

    try {
        await batch.commit();
        statusDiv.innerHTML = `<div class="alert alert-success">Successfully uploaded ${recordsToUpload.length} records.</div>`;
        showAlert('Bulk upload complete!', 'success');
        document.getElementById('editable-data-preview').classList.add('d-none');
    } catch (error) {
        console.error("Firestore batch commit failed:", error);
        statusDiv.innerHTML = `<div class="alert alert-danger">Failed to commit changes. Check console for details.</div>`;
        showAlert('Batch upload failed.', 'danger');
    } finally {
        finalUploadBtn.disabled = false;
        finalUploadBtn.innerHTML = `<i class="fas fa-upload me-2"></i>Final Upload`;
    }
}


async function uploadPhotoToDrive(photoBlob, studentId, subfolderName = 'studentPhotos-2025') { // <--- ADD subfolderName with default
    var subfolderName = "studentPhotos-2025";
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = async () => {
            const base64Image = reader.result;
            const formData = new FormData();
            formData.append('photoData', base64Image.split(',')[1]);
            formData.append('studentId', studentId);
            formData.append('subfolderName', subfolderName); // <--- ADD subfolderName to formData

            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyFVRUjvnf3dj5uh0m6BCAiPCWHdmyxV9HvTjEfTB29LWAy7kC5vk96qPDFqwz1JlOK/exec';

            try {
                const response = await fetch(`${SCRIPT_URL}?action=uploadStudentPhotoOnly`, {
                    method: 'POST',
                    body: formData,
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.success) {
                    resolve(result);
                } else {
                    reject(new Error(result.error || 'Unknown error during Drive upload.'));
                }
            } catch (error) {
                console.error('Error during Drive upload fetch:', error);
                reject(error);
            }
        };
        reader.onerror = (error) => {
            console.error('FileReader error:', error);
            reject(error);
        };
        reader.readAsDataURL(photoBlob);
    });
}


// --- REPORTS MODULE ---
// --- REPORTS MODULE ---

// Add 'reports' and 'schoolDetails' to your global variables at the top of the script
// let reports = [], schoolDetails = {};
// Also, add them to your Firestore data listeners in attachMainDataListeners
/*
    ...
    reports: data => reports = data,
    schoolDetails: data => {
        // Assuming schoolDetails is a single document with a known ID, e.g., 'details'
        if (data.length > 0) schoolDetails = data[0];
    },
    ...
*/


/**
 * Renders the main interface for the dynamic reports module.
 */// --- REPORTS MODULE (ENHANCED) ---
// --- REPORTS MODULE (ENHANCED) ---
// --- REPORTS MODULE (ENHANCED) ---

// Ensure 'reports' and 'schoolDetails' are part of your global variables and listeners.

/**
 * Renders the main interface for the enhanced dynamic reports module.
 */
/**
 * Renders the main interface for the enhanced dynamic reports module.
 */
/**
 * Renders the main interface for the enhanced dynamic reports module.
 */
window.renderReportsModule = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) return;

    mainContent.innerHTML = `
        <style>
            /* --- Style rules for the report builder UI --- */
            #report-fields-list .list-group-item { cursor: grab; }
            #report-fields-list .list-group-item:active { cursor: grabbing; }
            #report-fields-list .dragging { opacity: 0.5; }
            .field-actions { visibility: hidden; }
            .list-group-item:hover .field-actions { visibility: visible; }
            
            /* --- THIS IS THE CORRECTED SECTION --- */
            /* Text wrapping styles now apply to both headers (th) and cells (td) */
            .table-wrap th, .table-wrap td { white-space: normal !important; word-break: break-word; }
            .table-no-wrap th, .table-no-wrap td { white-space: nowrap !important; }
        </style>
        
        <h1 class="h2 mb-4">Advanced Report Generator</h1>
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-body">
                        <div class="row border-bottom pb-3 mb-3">
                            <div class="col-md-6"><label for="report-name" class="form-label fw-bold">1. Report Name</label><input type="text" id="report-name" class="form-control" placeholder="e.g., Student Contact List"></div>
                            <div class="col-md-6"><label for="report-collection-select" class="form-label fw-bold">2. Primary Data Source</label><select id="report-collection-select" class="form-select"><option value="">-- Choose --</option><option value="students">Students</option><option value="teachers">Teachers</option><option value="classes">Classes</option></select></div>
                        </div>

                        <div id="report-config-section" class="d-none">
                            <div class="row">
                                <div class="col-md-5">
                                    <label class="form-label fw-bold">3. Select, Order, & Size Fields</label>
                                    <div id="report-fields-list" class="list-group border rounded p-2" style="max-height: 400px; overflow-y: auto;"></div>
                                    <div class="mt-2"><button id="add-custom-field-btn" class="btn btn-sm btn-outline-secondary"><i class="fas fa-calculator"></i> Add Custom Field</button></div>
                                </div>
                                <div class="col-md-7">
                                    <label class="form-label fw-bold">4. Filter & Layout</label>
                                    <div id="report-filters-container" class="vstack gap-3 p-3 border rounded"></div>
                                </div>
                            </div>
                            <div class="text-center mt-4"><button id="generate-report-btn" class="btn btn-primary btn-lg">Generate Report</button></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card shadow"><div class="card-header fw-bold">Saved Reports</div><div id="saved-reports-list" class="list-group list-group-flush"></div></div>
            </div>
        </div>

        <div id="report-output-section" class="mt-4 d-none">
            <div class="card shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                        <h3 id="report-output-title" class="h4 mb-0"></h3>
                        <div class="btn-toolbar">
                            <button id="save-report-config-btn" class="btn btn-success me-2"><i class="fas fa-save me-2"></i>Save Configuration</button>
                            <button id="print-report-btn" class="btn btn-secondary me-2"><i class="fas fa-print me-2"></i>Print Report</button>
                            <button id="csv-export-btn" class="btn btn-primary"><i class="fas fa-file-csv me-2"></i>Download CSV</button>
                        </div>
                    </div>
                    <div id="report-content-container" class="table-responsive"></div>
                </div>
            </div>
        </div>
        
        ${createCustomFieldModal()}
    `;

    renderSavedReports();
    attachReportsModuleListeners();
};
/**
 * Attaches all necessary event listeners for the reports module.
 */
function attachReportsModuleListeners() {
    const collectionSelect = document.getElementById('report-collection-select');
    const configSection = document.getElementById('report-config-section');
    const fieldsList = document.getElementById('report-fields-list');
    
    if (collectionSelect) {
        collectionSelect.addEventListener('change', (e) => {
            const collectionName = e.target.value;
            if (configSection) configSection.classList.toggle('d-none', !collectionName);
            const outputSection = document.getElementById('report-output-section');
            if (outputSection) outputSection.classList.add('d-none');
            if (collectionName) {
                renderReportFilters(collectionName);
                renderReportFieldSelector(collectionName);
            }
        });
    }

    document.getElementById('generate-report-btn')?.addEventListener('click', generateAndRenderReport);
    document.getElementById('save-report-config-btn')?.addEventListener('click', saveReportConfiguration);
    document.getElementById('print-report-btn')?.addEventListener('click', printGeneratedReport);
    document.getElementById('add-related-field-btn')?.addEventListener('click', () => showAddRelatedFieldModal());
    document.getElementById('add-custom-field-btn')?.addEventListener('click', () => showAddCustomFieldModal());
    // Listeners for the export buttons
    document.getElementById('print-report-btn')?.addEventListener('click', printGeneratedReport);
    document.getElementById('csv-export-btn')?.addEventListener('click', downloadReportCSV);


    

    document.getElementById('saved-reports-list')?.addEventListener('click', (e) => {
        const loadBtn = e.target.closest('.load-report-btn');
        const deleteBtn = e.target.closest('.delete-report-btn');
        if (loadBtn) {
            const reportId = loadBtn.dataset.reportId;
            const report = reports.find(r => r.id === reportId);
            if (report) loadReportSettings(report);
        } else if (deleteBtn) {
            const reportId = deleteBtn.dataset.reportId;
            if (confirm('Are you sure you want to delete this report configuration?')) {
                deleteReport(reportId);
            }
        }
    });

    if (fieldsList) {
        fieldsList.addEventListener('click', e => {
            const editBtn = e.target.closest('.edit-field-btn');
            const deleteBtn = e.target.closest('.delete-field-btn');
            if (editBtn) {
                const fieldItem = editBtn.closest('.list-group-item');
                const fieldInfo = {
                    name: fieldItem.dataset.fieldName,
                    isCustom: fieldItem.dataset.isCustom === 'true',
                    relatedInfo: JSON.parse(fieldItem.dataset.relatedInfo || 'null'),
                    customInfo: JSON.parse(fieldItem.dataset.customInfo || 'null'),
                    element: fieldItem // Pass the element to update it later
                };
                if (fieldInfo.relatedInfo) {
                    showAddRelatedFieldModal(fieldInfo);
                } else if (fieldInfo.customInfo) {
                    showAddCustomFieldModal(fieldInfo);
                } else {
                    showAlert("Only 'Related' and 'Custom' fields can be edited.", 'info');
                }
            } else if (deleteBtn) {
                deleteBtn.closest('.list-group-item').remove();
            }
        });

        let draggedItem = null;
        fieldsList.addEventListener('dragstart', (e) => {
            draggedItem = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
        });
        fieldsList.addEventListener('dragend', () => draggedItem?.classList.remove('dragging'));
        fieldsList.addEventListener('dragover', (e) => {
            e.preventDefault();
            const afterElement = getDragAfterElement(fieldsList, e.clientY);
            const currentDragged = document.querySelector('.dragging');
            if (afterElement == null) fieldsList.appendChild(currentDragged);
            else fieldsList.insertBefore(currentDragged, afterElement);
        });

        const exportDropdownToggle = document.querySelector('#report-output-section .dropdown-toggle');
    if (exportDropdownToggle) {
        // This method safely creates a new dropdown instance or returns an existing one,
        // preventing conflicts when the view is re-rendered.
        bootstrap.Dropdown.getOrCreateInstance(exportDropdownToggle);
    }

    }
}

/**
 * Renders the list of saved reports with delete buttons.
 */
function renderSavedReports() {
    const container = document.getElementById('saved-reports-list');
    if (!container) return;
    if (!reports || reports.length === 0) {
        container.innerHTML = '<p class="text-muted p-3">No saved reports.</p>';
        return;
    }
    container.innerHTML = reports.map(report => `
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <a href="#" class="text-decoration-none text-dark flex-grow-1 load-report-btn" data-report-id="${report.id}">
                <h6 class="mb-1">${report.name}</h6>
                <small class="text-capitalize text-muted">${report.collection}</small>
            </a>
            <button class="btn btn-sm btn-outline-danger delete-report-btn" data-report-id="${report.id}" title="Delete Report">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
    `).join('');
}
function downloadReportCSV() {
    const config = getReportConfiguration();
    const dataContainer = document.getElementById('report-content-container');
    if (!config || !dataContainer.dataset.reportData) {
        showAlert('No report data available to download.', 'warning');
        return;
    }

    const data = JSON.parse(dataContainer.dataset.reportData);
    const headers = config.fields.filter(f => f.isSelected);
    const headerRow = headers.map(h => h.name).join(',');

    const rows = data.map(row => {
        return headers.map(header => {
            const value = getNestedValue(row, header.name);
            const stringValue = String(value).replace(/"/g, '""'); // Escape double quotes
            return `"${stringValue}"`;
        }).join(',');
    });

    const csvContent = [headerRow, ...rows].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `${config.name.replace(/\s+/g, '_')}_report.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}







/**
 * Deletes a saved report configuration from Firestore.
 * @param {string} reportId The ID of the report to delete.
 */
async function deleteReport(reportId) {
    try {
        await deleteDoc(getDocRef('reports', reportId));
        showAlert('Report configuration deleted successfully.', 'success');
        // The real-time listener will update the UI.
    } catch (error) {
        console.error("Error deleting report:", error);
        showAlert('Failed to delete report.', 'danger');
    }
}

/**
 * Renders filter and layout options based on the selected collection.
 * @param {string} collectionName The name of the selected collection.
 */
function renderReportFilters(collectionName) {
    const filtersContainer = document.getElementById('report-filters-container');
    if (!filtersContainer) return;

    let filterHtml = `
    <div class="form-check form-switch mt-3">
            <input class="form-check-input" type="checkbox" role="switch" id="report-text-wrap" checked>
            <label class="form-check-label" for="report-text-wrap">Enable Text Wrapping in Cells</label>
        </div>

        <div>
            <label class="form-label">Report Layout</label>
            <select id="report-layout-select" class="form-select">
                <option value="table">Table</option>
                <option value="cards">Cards</option>
                <option value="manual">Manual Layout</option>
            </select>
        </div>
        <div id="manual-layout-container" class="d-none">
            <label for="manual-layout-template" class="form-label">Manual HTML Layout</label>
            <textarea id="manual-layout-template" class="form-control" rows="8" placeholder="Use {{fieldName}} for placeholders. e.g., <h3>{{name}}</h3>"></textarea>
            <div class="mt-2">
                <small class="text-muted">Available Placeholders:</small>
                <div id="manual-layout-placeholders" class="d-flex flex-wrap gap-1 mt-1"></div>
            </div>
        </div>
    `;

    if (collectionName === 'students') {
        filterHtml += `
            <div>
                <label class="form-label">Filter by Class</label>
                <select id="report-filter-class" class="form-select">
                    <option value="all">-- All Classes (Grouped) --</option>
                    ${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                </select>
            </div>
            <div>
                <label class="form-label">Filter by Division</label>
                <select id="report-filter-division" class="form-select" disabled>
                    <option value="all">-- All Divisions --</option>
                </select>
            </div>
        `;
    }
    filtersContainer.innerHTML = filterHtml;

    document.getElementById('report-layout-select')?.addEventListener('change', e => {
        document.getElementById('manual-layout-container')?.classList.toggle('d-none', e.target.value !== 'manual');
    });

    const classFilter = document.getElementById('report-filter-class');
    if (classFilter) {
        classFilter.addEventListener('change', (e) => {
            const divisionSelect = document.getElementById('report-filter-division');
            const selectedClass = classes.find(c => c.id === e.target.value);
            if (divisionSelect) {
                divisionSelect.innerHTML = '<option value="all">-- All Divisions --</option>';
                if (selectedClass) {
                    divisionSelect.disabled = false;
                    divisionSelect.innerHTML += selectedClass.divisions.map(d => `<option value="${d}">${d}</option>`).join('');
                } else {
                    divisionSelect.disabled = true;
                }
            }
        });
    }
}

/**
 * The core data processing function. Fetches and enriches data from collections.
 * @param {string} collectionName - The primary collection to query.
 * @param {object} config - The full report configuration object.
 * @returns {Promise<Array<object>>} A promise that resolves to the processed data.
 */
/**
 * The core data processing function. Fetches and enriches data from collections.
 * @param {string} collectionName - The primary collection to query.
 * @param {object} config - The full report configuration object.
 * @returns {Promise<Array<object>>} A promise that resolves to the processed data.
 */
async function getReportData(collectionName, config) {
    let data = [];
    const filters = config.filters || {};
    const customFields = config.customFields || [];

    // Create deep copies to avoid modifying original data arrays
    if (collectionName === 'students') data = JSON.parse(JSON.stringify(students));
    else if (collectionName === 'teachers') data = JSON.parse(JSON.stringify(teachers));
    else if (collectionName === 'classes') data = JSON.parse(JSON.stringify(classes));
    else return [];

    data.forEach(item => {
        // 1. Compute derived fields based on the selected collection
        if (collectionName === 'teachers') {
            const allocations = classroomSubjects.filter(cs => cs.teacherId === item.id);
            item.allocatedClassesCount = allocations.length;
            item.handlingStudentCount = allocations.reduce((total, alloc) => {
                return total + students.filter(s => s.classId === alloc.classId && s.division === alloc.division).length;
            }, 0);
            
            // --- NEW: Create a detailed string of all teacher allocations ---
            item.allocationDetails = allocations.map(alloc => {
                const className = classes.find(c => c.id === alloc.classId)?.name || 'N/A';
                const subjectName = subjects.find(s => s.id === alloc.subjectId)?.name || 'N/A';
                return `${className} ${alloc.division} - ${subjectName} (${alloc.weeklyHour} hrs)`;
            }).join('; ');

        } else if (collectionName === 'classes') {
            // --- NEW: Get male, female, and total student counts for the class ---
            const studentsInClass = students.filter(s => s.classId === item.id);
            item.totalStudentCount = studentsInClass.length;
            item.maleCount = studentsInClass.filter(s => s.gender === 'MALE').length;
            item.femaleCount = studentsInClass.filter(s => s.gender === 'FEMALE').length;
            item.studentCount = item.totalStudentCount; // For backward compatibility

            const classTeacher = teachers.find(t => t.classCharge?.classId === item.id && t.classCharge?.division === item.divisions[0]); // Simple assumption for class teacher
            item.classIncharge = classTeacher ? classTeacher.name : 'N/A';

        } else if (collectionName === 'students') {
            const className = classes.find(c => c.id === item.classId)?.name;
            item.fullClassName = className ? `${className} - ${item.division}` : 'N/A';
        }

        // 2. Process custom calculated fields
        customFields.forEach(cf => {
            try {
                const formula = cf.formula.replace(/\{\{([^{}]+)\}\}/g, (match, fieldName) => {
                    const val = getNestedValue(item, fieldName.trim());
                    return typeof val === 'number' ? val : 0;
                });
                item[cf.alias] = new Function(`return ${formula}`)();
            } catch (e) {
                console.error(`Error calculating custom field '${cf.alias}':`, e);
                item[cf.alias] = 'Error';
            }
        });
    });

    // 3. Apply filters to the final dataset
    if (filters.classId && filters.classId !== 'all') {
        data = data.filter(item => item.classId === filters.classId);
        if (filters.division && filters.division !== 'all') {
            data = data.filter(item => item.division === filters.division);
        }
    }

    return data;
}


/**
 * Gathers settings, gets data, and renders the report output.
 */
async function generateAndRenderReport() {
    const outputSection = document.getElementById('report-output-section');
    const contentContainer = document.getElementById('report-content-container');
    const reportName = document.getElementById('report-name')?.value || 'Generated Report';
    
    document.getElementById('report-output-title').textContent = reportName;
    contentContainer.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Generating report...</p></div>`;
    outputSection.classList.remove('d-none');

    const config = getReportConfiguration();
    if (!config) {
        contentContainer.innerHTML = '<p class="text-danger">Could not generate report due to missing configuration.</p>';
        return;
    }
    
    const data = await getReportData(config.collection, config);
    renderReportOutput(data, config);
    
    // --- FIX: Manually initialize the dropdown ---
    // This line finds the new dropdown button and activates it.
    const exportDropdownBtn = outputSection.querySelector('.dropdown-toggle');
    if (exportDropdownBtn) {
        new bootstrap.Dropdown(exportDropdownBtn);
    }
}


function makeTableResizable(table) {
    const headers = table.querySelectorAll('th');
    headers.forEach(header => {
        const resizer = document.createElement('div');
        resizer.style.position = 'absolute';
        resizer.style.top = '0';
        resizer.style.right = '0';
        resizer.style.width = '5px';
        resizer.style.height = '100%';
        resizer.style.cursor = 'col-resize';
        resizer.style.userSelect = 'none';
        header.style.position = 'relative';
        header.appendChild(resizer);

        resizer.addEventListener('mousedown', (e) => {
            let x = 0;
            let w = 0;

            const onMouseMove = (e) => {
                const dx = e.clientX - x;
                header.style.width = `${w + dx}px`;
            };

            const onMouseUp = () => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };

            x = e.clientX;
            w = header.offsetWidth;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    });
}

/**
 * Renders the final report based on the chosen layout.
 * @param {Array<object>} data - The processed data to display.
 * @param {object} config - The report configuration object.
 */
function renderReportOutput(data, config) {
    const contentContainer = document.getElementById('report-content-container');
    if (!contentContainer) return;

    // Store the data on the element for CSV export access
    contentContainer.dataset.reportData = JSON.stringify(data);
    
    const selectedFields = config.fields.filter(f => f.isSelected);

    if (data.length === 0) {
        contentContainer.innerHTML = '<p class="text-center text-muted">No data found matching the criteria.</p>';
        return;
    }

    const renderGroup = (groupData, title) => {
        let html = title ? `<h4 class="mt-4">${title}</h4>` : '';
        if (config.layout === 'cards') {
            html += createReportCards(selectedFields, groupData);
        } else if (config.layout === 'manual') {
            html += createManualLayoutReport(config.manualTemplate, groupData);
        } else {
            // --- THIS IS THE CORRECTED LINE ---
            // We now correctly pass the 'config' object as the third argument.
            html += createReportTable(selectedFields, groupData, config);
        }
        return html;
    };

    if (config.filters && config.filters.classId === 'all' && config.collection === 'students') {
        contentContainer.innerHTML = '';
        classes.forEach(cls => {
            cls.divisions.forEach(div => {
                const classData = data.filter(s => s.classId === cls.id && s.division === div);
                if (classData.length > 0) {
                    contentContainer.innerHTML += `<div class="printable-group">${renderGroup(classData, `${cls.name} - ${div}`)}</div>`;
                }
            });
        });
    } else {
        contentContainer.innerHTML = renderGroup(data, '');
        const reportTable = document.getElementById('generated-report-table');
    if (reportTable) {
        makeTableResizable(reportTable);
    }

    }
}

/**
 * Creates an HTML string for a card-based layout.
 * @param {Array<object>} headers - The fields to display.
 * @param {Array<object>} data - The data for the cards.
 * @returns {string} The HTML string for the cards.
 */
function createReportCards(headers, data) {
    let cardsHtml = '<div class="row">';
    data.forEach(row => {
        cardsHtml += '<div class="col-md-6 col-lg-4 mb-3"><div class="card h-100 report-card"><div class="card-body">';
        headers.forEach((header, index) => {
            const value = getNestedValue(row, header.name);
            if (index === 0) {
                cardsHtml += `<h5 class="card-title">${value}</h5><hr>`;
            } else {
                cardsHtml += `<p class="card-text mb-1"><strong>${header.name}:</strong> ${value}</p>`;
            }
        });
        cardsHtml += '</div></div></div>';
    });
    cardsHtml += '</div>';
    return cardsHtml;
}

/**
 * Creates an HTML string by processing a manual template.
 * @param {string} template - The user-defined HTML template with placeholders.
 * @param {Array<object>} data - The data to populate the template.
 * @returns {string} The final rendered HTML string.
 */
function createManualLayoutReport(template, data) {
    if (!template) return '<p class="text-danger">Manual layout template is empty.</p>';
    let finalHtml = '<div class="row">';
    data.forEach(row => {
        let recordHtml = template;
        const placeholders = template.match(/\{\{.*?\}\}/g) || [];
        placeholders.forEach(placeholder => {
            const fieldName = placeholder.replace(/[{}]/g, '');
            const value = getNestedValue(row, fieldName);
            recordHtml = recordHtml.replace(new RegExp(placeholder, 'g'), value);
        });
        finalHtml += recordHtml;
    });
    finalHtml += '</div>';
    return finalHtml;
}

/**
 * Gathers the current report configuration from the UI.
 * @returns {object|null} The report configuration object or null if essential UI elements are missing.
 */
function getReportConfiguration() {
    // --- Get all necessary DOM elements ---
    const reportNameEl = document.getElementById('report-name');
    const collectionSelectEl = document.getElementById('report-collection-select');
    const layoutSelectEl = document.getElementById('report-layout-select');
    const manualTemplateEl = document.getElementById('manual-layout-template');
    const classFilterEl = document.getElementById('report-filter-class');
    const divisionFilterEl = document.getElementById('report-filter-division');

    // --- Guard clause to ensure essential elements exist ---
    if (!reportNameEl || !collectionSelectEl || !layoutSelectEl) {
        console.error("Cannot get report configuration: Essential UI elements are missing.");
        return null;
    }

    // --- Map over each field item in the list to gather its settings ---
    const fields = Array.from(document.querySelectorAll('#report-fields-list .list-group-item')).map(item => {
        
        // --- THIS IS THE CORRECTED SECTION ---
        // Safely get the width input and its value from within the map loop.
        const widthInput = item.querySelector('input[type="text"]');
        const width = widthInput ? widthInput.value.trim() : ''; // Default to empty string if not found

        // Return a complete object for the field
        return {
            name: item.dataset.fieldName,
            isSelected: item.querySelector('input[type="checkbox"]').checked,
            width: width, // Use the safe 'width' variable
            isCustom: item.dataset.isCustom === 'true',
            customInfo: JSON.parse(item.dataset.customInfo || 'null')
        };
    });

    // --- Construct and return the final configuration object ---
    return {
        name: reportNameEl.value,
        collection: collectionSelectEl.value,
        layout: layoutSelectEl.value,
        manualTemplate: manualTemplateEl ? manualTemplateEl.value : '',
        textWrap: document.getElementById('report-text-wrap')?.checked || false,
        fields: fields, // The 'fields' array is now complete and can be used directly
        customFields: fields.filter(f => f.customInfo).map(f => f.customInfo),
        filters: {
            classId: classFilterEl ? classFilterEl.value : null,
            division: divisionFilterEl ? divisionFilterEl.value : null
        }
    };
}
/**
 * Saves the current report configuration to Firestore.
 */
async function saveReportConfiguration() {
    const config = getReportConfiguration();
    if (!config) return;

    if (!config.name) {
        showAlert('Please enter a name for the report before saving.', 'warning');
        return;
    }

    config.id = config.name.replace(/\s+/g, '_').toLowerCase() + `_${Date.now()}`;

    try {
        await setDoc(getDocRef('reports', config.id), config);
        showAlert(`Report '${config.name}' configuration saved successfully.`, 'success');
    } catch (error) {
        console.error("Error saving report settings:", error);
        showAlert('Failed to save report configuration.', 'danger');
    }
}

/**
 * Prints the currently displayed report with a professional header.
 */
function printGeneratedReport() {
    const config = getReportConfiguration();
    if (!config) return;

    const reportTitle = config.name || 'Dynamic Report';
    let subTitle = `Data Source: ${config.collection}`;
    if (config.filters.classId && config.filters.classId !== 'all') {
        const className = classes.find(c => c.id === config.filters.classId)?.name || '';
        subTitle += ` | Class: ${className}`;
        if (config.filters.division && config.filters.division !== 'all') {
            subTitle += ` - ${config.filters.division}`;
        }
    }

    const headerHtml = `
        <div class='text-center mb-4'>
            ${schoolDetails.logoUrl ? `<img src="${schoolDetails.logoUrl}" alt="School Logo" style="max-height: 80px; margin-bottom: 1rem;">` : ''}
            <h1>${schoolDetails.name || 'School Name'}</h1>
            <p class='lead'>${schoolDetails.address || 'School Address'}</p>
            <hr>
            <h2>${reportTitle}</h2>
            <p class='text-muted'>${subTitle}</p>
        </div>
    `;
    printContentOfDiv('report-content-container', reportTitle, { customHeaderHtml: headerHtml });
}

/**
 * Helper to safely access nested property values.
 * @param {object} obj - The object to query.
 * @param {string} path - The dot-separated path to the value.
 * @returns {*} The value, or an empty string if not found.
 */
function getNestedValue(obj, path) {
    const value = path.split('.').reduce((o, k) => (o || {})[k], obj);
    return value !== undefined && value !== null ? value : '';
}

/**
 * Loads a saved report's configuration into the UI.
 * @param {object} report - The saved report configuration object.
 */
function loadReportSettings(report) {
    document.getElementById('report-name').value = report.name;
    const collectionSelect = document.getElementById('report-collection-select');
    collectionSelect.value = report.collection;
    
    renderReportFilters(report.collection);
    renderReportFieldSelector(report.collection, report.fields, report.relatedFields, report.customFields);
    if(document.getElementById('report-text-wrap')) {
        document.getElementById('report-text-wrap').checked = report.textWrap;
    }

    const layoutSelect = document.getElementById('report-layout-select');
    if(layoutSelect) {
        layoutSelect.value = report.layout || 'table';
        const manualContainer = document.getElementById('manual-layout-container');
        if (manualContainer) {
            manualContainer.classList.toggle('d-none', layoutSelect.value !== 'manual');
        }
        if (report.layout === 'manual') {
            document.getElementById('manual-layout-template').value = report.manualTemplate || '';
        }
    }
    if (report.filters) {
        const classFilter = document.getElementById('report-filter-class');
        if (classFilter) {
            classFilter.value = report.filters.classId || 'all';
            const divisionSelect = document.getElementById('report-filter-division');
            if(divisionSelect){
                const selectedClass = classes.find(c => c.id === classFilter.value);
                divisionSelect.innerHTML = '<option value="all">-- All Divisions --</option>';
                if (selectedClass) {
                    divisionSelect.disabled = false;
                    divisionSelect.innerHTML += selectedClass.divisions.map(d => `<option value="${d}">${d}</option>`).join('');
                    divisionSelect.value = report.filters.division || 'all';
                } else {
                    divisionSelect.disabled = true;
                }
            }
        }
    }
    showAlert(`Loaded settings for report: ${report.name}`, 'info');
    document.getElementById('report-output-section').classList.add('d-none');
}


/**
 * Renders the list of selectable fields and updates the manual layout placeholders.
 * @param {string} collectionName - The name of the collection.
 * @param {Array<object>} [savedFields=[]] - The array of saved field configurations.
 * @param {Array<object>} [relatedFields=[]] - The array of saved related field configurations.
 * @param {Array<object>} [customFields=[]] - The array of saved custom field configurations.
 */
function renderReportFieldSelector(collectionName, savedFields = [], relatedFields = [], customFields = []) {
    const fieldsList = document.getElementById('report-fields-list');
    const placeholdersContainer = document.getElementById('manual-layout-placeholders');
    
    if (!fieldsList || !placeholdersContainer) {
        console.error("Report module UI elements not found. Cannot render fields.");
        return;
    }
    
    fieldsList.innerHTML = '';
    placeholdersContainer.innerHTML = '';

    let baseFields = [];
    let sampleData;
    if (collectionName === 'students' && students.length > 0) sampleData = students[0];
    else if (collectionName === 'teachers' && teachers.length > 0) sampleData = teachers[0];
    else if (collectionName === 'classes' && classes.length > 0) sampleData = classes[0];

    if (sampleData) {
        baseFields = Object.keys(sampleData).filter(k => !k.startsWith('__'));
    }

    if (collectionName === 'teachers') baseFields.push('allocatedClassesCount', 'handlingStudentCount');
    else if (collectionName === 'classes') baseFields.push('studentCount', 'teacherCount');
    else if (collectionName === 'students') baseFields.push('fullClassName');

    const allAvailableFields = [
        ...baseFields, 
        ...(relatedFields || []).map(rf => rf.alias),
        ...(customFields || []).map(cf => cf.alias)
    ];
    allAvailableFields.forEach(field => {
        placeholdersContainer.innerHTML += `<span class="badge bg-light text-dark">{{${field}}}</span>`;
    });
    
    if (savedFields.length > 0) {
        savedFields.forEach(sf => {
            const relatedInfo = (relatedFields || []).find(rf => rf.alias === sf.name);
            const customInfo = (customFields || []).find(cf => cf.alias === sf.name);
            addReportFieldToList(sf.name, sf.isCustom, sf.isSelected, relatedInfo, customInfo);
        });
    } else {
        baseFields.forEach(field => addReportFieldToList(field));
    }
}

function addReportFieldToList(fieldName, isCustom = false, isSelected = true, relatedInfo = null, customInfo = null) {
    const fieldsList = document.getElementById('report-fields-list');
    if (!fieldsList) return;
    
    const item = document.createElement('div');
    item.className = 'list-group-item d-flex justify-content-between align-items-center';
    item.draggable = true;
    item.dataset.fieldName = fieldName;
    item.dataset.isCustom = isCustom;
    if (relatedInfo) item.dataset.relatedInfo = JSON.stringify(relatedInfo);
    if (customInfo) item.dataset.customInfo = JSON.stringify(customInfo);

    let badge = '';
    if (relatedInfo) badge = '<span class="badge bg-info ms-2">Related</span>';
    else if (customInfo) badge = '<span class="badge bg-warning text-dark ms-2">Custom</span>';

    item.innerHTML = `
        <div>
            <input class="form-check-input me-2" type="checkbox" ${isSelected ? 'checked' : ''}>
            <label class="form-check-label">${fieldName}</label>
            ${badge}
        </div>
        <div class="field-actions">
            <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1 edit-field-btn" title="Edit"><i class="fas fa-edit fa-xs"></i></button>
            <button class="btn btn-sm btn-outline-danger py-0 px-1 delete-field-btn" title="Delete"><i class="fas fa-trash-alt fa-xs"></i></button>
            <i class="fas fa-grip-vertical text-muted ms-2"></i>
        </div>
    `;
    fieldsList.appendChild(item);
}


/**
 * Shows and populates the modal for adding a new related field.
 */
function showAddRelatedFieldModal(fieldInfo = null) {
    const isEditMode = fieldInfo !== null;
    const primaryCollection = document.getElementById('report-collection-select').value;
    if (!primaryCollection) {
        showAlert('Please select a primary data source first.', 'warning');
        return;
    }

    const allCollections = { students, teachers, classes };
    const relatedCollectionSelect = document.getElementById('modal-related-collection');
    const localKeySelect = document.getElementById('modal-local-key');
    const foreignKeySelect = document.getElementById('modal-foreign-key');
    const returnFieldsContainer = document.getElementById('modal-return-fields-container');
    const aliasInput = document.getElementById('modal-alias');
    const joinWithInput = document.getElementById('modal-join-with');

    document.querySelectorAll('.primary-collection-name-span').forEach(span => {
        if(span) span.textContent = primaryCollection;
    });

    if(relatedCollectionSelect) {
        relatedCollectionSelect.innerHTML = Object.keys(allCollections)
            .filter(c => c !== primaryCollection)
            .map(c => `<option value="${c}">${c}</option>`).join('');
    }

    const populateKeys = (selectEl, collectionName) => {
        const sample = allCollections[collectionName]?.[0];
        if (selectEl) {
            selectEl.innerHTML = sample ? Object.keys(sample).filter(k => !k.startsWith('__')).map(k => `<option value="${k}">${k}</option>`).join('') : '';
        }
    };

    const populateReturnFields = (containerEl, collectionName) => {
        const sample = allCollections[collectionName]?.[0];
        if (containerEl) {
            containerEl.innerHTML = sample ? Object.keys(sample).filter(k => !k.startsWith('__')).map(k => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${k}" id="return_field_${k}">
                    <label class="form-check-label" for="return_field_${k}">${k}</label>
                </div>
            `).join('') : '';
        }
    };

    populateKeys(localKeySelect, primaryCollection);
    
    const updateRelatedFields = () => {
        const relatedCollection = relatedCollectionSelect.value;
        document.querySelectorAll('.related-collection-name-span').forEach(span => {
            if(span) span.textContent = relatedCollection;
        });
        populateKeys(foreignKeySelect, relatedCollection);
        populateReturnFields(returnFieldsContainer, relatedCollection);
    };
    
    if(relatedCollectionSelect) {
        relatedCollectionSelect.addEventListener('change', updateRelatedFields);
    }
    updateRelatedFields();

    if (isEditMode && fieldInfo.relatedInfo) {
        const info = fieldInfo.relatedInfo;
        const step = info.steps[0];
        aliasInput.value = info.alias;
        joinWithInput.value = info.joinWith;
        relatedCollectionSelect.value = step.relatedCollection;
        updateRelatedFields();
        localKeySelect.value = step.localKey;
        foreignKeySelect.value = step.foreignKey;
        step.returnFields.forEach(rf => {
            const checkbox = returnFieldsContainer.querySelector(`input[value="${rf}"]`);
            if (checkbox) checkbox.checked = true;
        });
    } else {
        aliasInput.value = '';
        joinWithInput.value = '';
    }

    const modal = new bootstrap.Modal(document.getElementById('relatedFieldModal'));
    
    document.getElementById('modal-add-field-btn').onclick = () => {
        const returnFields = Array.from(returnFieldsContainer.querySelectorAll('input:checked')).map(cb => cb.value);
        if (returnFields.length === 0) {
            showAlert('Please select at least one field to display.', 'danger');
            return;
        }
        const relatedInfo = {
            alias: aliasInput.value,
            joinWith: joinWithInput.value || ' ',
            steps: [{
                relatedCollection: relatedCollectionSelect.value,
                localKey: localKeySelect.value,
                foreignKey: foreignKeySelect.value,
                returnFields: returnFields
            }]
        };
        if (!relatedInfo.alias) {
            showAlert('Please provide a name (alias) for the new field.', 'danger');
            return;
        }

        if (isEditMode) {
            const item = fieldInfo.element;
            item.dataset.fieldName = relatedInfo.alias;
            item.dataset.relatedInfo = JSON.stringify(relatedInfo);
            item.querySelector('.form-check-label').textContent = relatedInfo.alias;
        } else {
            addReportFieldToList(relatedInfo.alias, false, true, relatedInfo);
        }
        modal.hide();
    };

    modal.show();
}

function showAddCustomFieldModal(fieldInfo = null) {
    const isEditMode = fieldInfo !== null;
    const aliasInput = document.getElementById('custom-field-alias');
    const formulaInput = document.getElementById('custom-field-formula');
    const placeholdersContainer = document.getElementById('custom-field-placeholders');
    
    const currentFields = Array.from(document.querySelectorAll('#report-fields-list .list-group-item'))
        .map(item => item.dataset.fieldName);
    if(placeholdersContainer) {
        placeholdersContainer.innerHTML = currentFields.map(f => `<span class="badge bg-light text-dark">{{${f}}}</span>`).join(' ');
    }

    if (isEditMode && fieldInfo.customInfo) {
        aliasInput.value = fieldInfo.customInfo.alias;
        formulaInput.value = fieldInfo.customInfo.formula;
    } else {
        aliasInput.value = '';
        formulaInput.value = '';
    }

    const modal = new bootstrap.Modal(document.getElementById('customFieldModal'));

    document.getElementById('modal-add-custom-btn').onclick = () => {
        const customInfo = {
            alias: aliasInput.value,
            formula: formulaInput.value
        };
        if (!customInfo.alias || !customInfo.formula) {
            showAlert('Please provide an alias and a formula.', 'danger');
            return;
        }
        
        if (isEditMode) {
            const item = fieldInfo.element;
            item.dataset.fieldName = customInfo.alias;
            item.dataset.customInfo = JSON.stringify(customInfo);
            item.querySelector('.form-check-label').textContent = customInfo.alias;
        } else {
            addReportFieldToList(customInfo.alias, true, true, null, customInfo);
        }
        modal.hide();
    };

    modal.show();
}

function createReportTable(headers, data, config) { // <-- 'config' is now correctly passed as a parameter
    const wrapClass = config.textWrap ? 'table-wrap' : 'table-no-wrap';
    let tableHTML = `<table id="generated-report-table" class="table table-bordered table-striped table-sm ${wrapClass}">`;
    tableHTML += `<thead><tr>${headers.map(h => `<th style="width: ${h.width || 'auto'};">${h.name}</th>`).join('')}</tr></thead>`;
    tableHTML += '<tbody>';
    data.forEach(row => {
        tableHTML += '<tr>';
        headers.forEach(header => {
            const value = getNestedValue(row, header.name);
            tableHTML += `<td>${(typeof value === 'object' && value !== null) ? JSON.stringify(value) : value}</td>`;
        });
        tableHTML += '</tr>';
    });
    tableHTML += '</tbody></table>';
    return tableHTML;
}



function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.list-group-item:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function printContentOfDiv(divId, title = 'Report', options = {}) {
    const { customHeaderHtml = '', customFooterHtml = '', extraCss = '' } = options;
    const contentEl = document.getElementById(divId);
    if (!contentEl) {
        showAlert('Could not find content to print.', 'danger');
        return;
    }

    const contentToPrint = contentEl.cloneNode(true);
    
    const groups = contentToPrint.querySelectorAll('.printable-group');
    if (groups.length > 0) {
        groups.forEach(group => {
            const headerNode = document.createElement('div');
            headerNode.innerHTML = customHeaderHtml;
            group.insertBefore(headerNode, group.firstChild);
        });
    }

    const printWindow = window.open('', '_blank', 'height=800,width=1000');
    if (!printWindow) {
        showAlert('Please allow pop-ups for this website to print the report.', 'warning');
        return;
    }

    printWindow.document.write(`
        <html>
            <head>
                <title>${title}</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    body { margin: 20px; font-family: 'Inter', sans-serif; }
                    table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
                    th, td { border: 1px solid #dee2e6; padding: 0.4rem; }
                    th { background-color: #f8f9fa; }
                    h1, h2, h3, h4, h5 { margin-top: 0; }
                    @media print {
                        .no-print { display: none; }
                        body { -webkit-print-color-adjust: exact; }
                        .printable-group { 
                            page-break-before: always;
                        }
                        .printable-group:first-child {
                            page-break-before: auto;
                        }
                    }
                    ${extraCss}
                </style>
            </head>
            <body>
                ${groups.length === 0 ? customHeaderHtml : ''}
                ${contentToPrint.innerHTML}
                ${customFooterHtml}
            </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 250);
}

// --- MODAL CREATION FUNCTIONS ---
function createRelatedFieldModal() {
    return `
        <div class="modal fade" id="relatedFieldModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Add/Edit Related Field</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div id="relation-steps-container">
                  <div class="relation-step border p-3 mb-3 rounded">
                    <h6>Step 1: Link from <strong class="primary-collection-name-span"></strong></h6>
                    <div class="row g-3">
                        <div class="col-md-6"><label class="form-label">Match Field From <strong class="primary-collection-name-span"></strong></label><select id="modal-local-key" class="form-select local-key-select"></select></div>
                        <div class="col-md-6"><label class="form-label">Related Collection</label><select id="modal-related-collection" class="form-select related-collection-select"></select></div>
                        <div class="col-md-6"><label class="form-label">With Field From <strong class="related-collection-name-span"></strong></label><select id="modal-foreign-key" class="form-select foreign-key-select"></select></div>
                    </div>
                  </div>
                </div>
                <hr>
                <div class="mb-3">
                    <label class="form-label">Field(s) to Display from Final Collection</label>
                    <div id="modal-return-fields-container" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;"></div>
                </div>
                 <div class="mb-3">
                    <label class="form-label">Join multiple fields with (optional)</label>
                    <input type="text" id="modal-join-with" class="form-control" placeholder="e.g., ' - ' or ', '">
                </div>
                <div class="mb-3">
                    <label class="form-label">New Field Name (Alias)</label>
                    <input type="text" id="modal-alias" class="form-control" placeholder="e.g., classInchargeName">
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="modal-add-field-btn" class="btn btn-primary">Save Field</button>
              </div>
            </div>
          </div>
        </div>`;
}

function createCustomFieldModal() {
    return `
        <div class="modal fade" id="customFieldModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Add/Edit Custom Calculated Field</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">New Field Name (Alias)</label>
                    <input type="text" id="custom-field-alias" class="form-control" placeholder="e.g., totalStudents">
                </div>
                <div class="mb-3">
                    <label class="form-label">Formula</label>
                    <input type="text" id="custom-field-formula" class="form-control" placeholder="e.g., {{studentCount}} + {{teacherCount}}">
                    <small class="text-muted">Use placeholders for fields. Only basic math (+, -, *, /) is supported.</small>
                </div>
                <div>
                    <small class="text-muted">Available Placeholders:</small>
                    <div id="custom-field-placeholders" class="d-flex flex-wrap gap-1 mt-1"></div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="modal-add-custom-btn" class="btn btn-primary">Save Custom Field</button>
              </div>
            </div>
          </div>
        </div>`;
}


// --- VEHICLE MANAGEMENT & NOTIFICATION MODULE (ENHANCED) ---
// --- VEHICLE MANAGEMENT & NOTIFICATION MODULE (PERFECTED) ---

let previousNotificationCount = 0; // To track new notifications for sound alert

/**
 * The main function to gather all notifications from different sources and update the UI.
 */
function updateAllNotifications() {
    const vehicleNotifications = getVehicleExpiryNotifications();
    const formNotifications = getPendingFormNotifications();
    const libraryNotifications = getLibraryDueNotifications(); 

    const allNotifications = [...vehicleNotifications, ...formNotifications ,...libraryNotifications];
    
    // Play a sound if the number of notifications has increased
    if (allNotifications.length > previousNotificationCount) {
        // Use Tone.js to play a simple synth note without external files
        try {
            const synth = new Tone.Synth().toDestination();
            synth.triggerAttackRelease("C5", "8n");
        } catch(e) {
            console.warn("Tone.js not available for notification sound.", e);
        }
    }
    previousNotificationCount = allNotifications.length;

    renderNotifications(allNotifications);
    updateSidebarBadges(allNotifications);
}

/**
 * Checks all vehicle documents for upcoming expiries.
 * @returns {Array<object>} An array of vehicle notification objects.
 */
function getVehicleExpiryNotifications() {
    const notifications = [];
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const thirtyDaysFromNow = new Date();
    thirtyDaysFromNow.setDate(today.getDate() + 30);

    (vehicles || []).forEach(vehicle => {
        const checkExpiry = (dateStr, docName) => {
            if (!dateStr) return;
            const expiryDate = new Date(dateStr);
            if (expiryDate <= thirtyDaysFromNow) {
                const timeDiff = expiryDate.getTime() - today.getTime();
                const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24));
                notifications.push({
                    type: 'vehicle',
                    id: `vehicle_${vehicle.id}_${docName}`,
                    title: vehicle.id,
                    docName: docName,
                    daysRemaining: daysRemaining,
                    expiryDate: expiryDate.toLocaleDateString('en-GB'),
                    targetView: 'vehicle-mgt'
                });
            }
        };

        checkExpiry(vehicle.taxExpiry, 'Tax');
        checkExpiry(vehicle.permitExpiry, 'Permit');
        checkExpiry(vehicle.insuranceExpiry, 'Insurance');
        checkExpiry(vehicle.fitnessExpiry, 'Fitness');
        checkExpiry(vehicle.pollutionExpiry, 'Pollution');
        checkExpiry(vehicle.gpsExpiry, 'GPS');
    });
    return notifications;
}

/**
 * Checks for active forms that the current user has not yet submitted.
 * @returns {Array<object>} An array of form notification objects.
 */
function getPendingFormNotifications() {
    if (!currentUserRole || !selectedUser) return [];

    const notifications = [];
    
    const applicableForms = (forms || []).filter(f => {
        if (!f.isActive) return false;
        if (f.target !== currentUserRole) return false;
        if (currentUserRole === 'student') {
            const classMatch = !f.classId || f.classId === selectedUser.classId;
            const divisionMatch = !f.division || f.division === selectedUser.division;
            return classMatch && divisionMatch;
        }
        return true;
    });

    applicableForms.forEach(form => {
        const hasResponded = (formResponses || []).some(r => r.formId === form.id && r.userId === selectedUser.id);
        if (!hasResponded) {
            let targetView = 'forms';
            if (currentUserRole === 'teacher') targetView = 'teacher-forms';
            
            notifications.push({
                type: 'form',
                id: `form_${form.id}`,
                title: form.title,
                text: 'A new form requires your attention.',
                targetView: targetView
            });
        }
    });

    return notifications;
}

/**
 * Renders all notifications in the dropdown menu and updates the main badge.
 * @param {Array<object>} notifications - An array of notification objects.
 */
function renderNotifications(notifications) {
    const notificationList = document.getElementById('notification-list');
    const notificationBadge = document.getElementById('notification-badge');
    if (!notificationList || !notificationBadge) return;

    if (notifications.length > 0) {
        notificationBadge.textContent = notifications.length;
        notificationBadge.classList.remove('d-none');
        
        notifications.sort((a, b) => (a.daysRemaining || 999) - (b.daysRemaining || 999));

        notificationList.innerHTML = notifications.map(n => {
            if (n.type === 'vehicle') {
                let daysText;
                if (n.daysRemaining < 0) daysText = `<span class="text-danger fw-bold">${n.docName} renewal was due ${Math.abs(n.daysRemaining)} days ago.</span>`;
                else if (n.daysRemaining === 0) daysText = `<span class="text-danger fw-bold">${n.docName} renewal is due today.</span>`;
                else daysText = `<span>${n.docName} renewal due in ${n.daysRemaining} days.</span>`;
                
                return `<li><a class="dropdown-item" href="#" onclick="event.preventDefault(); navigateTo('${n.targetView}');"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1 fw-bold">${n.title}</h6><small class="text-muted">${n.expiryDate}</small></div><p class="mb-0 small">${daysText}</p></a></li>`;
            } 
            else if (n.type === 'form') {
                 return `<li><a class="dropdown-item" href="#" onclick="event.preventDefault(); navigateTo('${n.targetView}');"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1 fw-bold">${n.title}</h6><small class="text-primary">New Form</small></div><p class="mb-0 small text-muted">${n.text}</p></a></li>`;
            }
            return '';
        }).join('') + '<li><hr class="dropdown-divider"></li><li><a id="clear-all-notifications" class="dropdown-item text-center text-muted small" href="#">Clear all</a></li>';
    
        document.getElementById('clear-all-notifications').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            notificationList.innerHTML = '<li><p class="p-3 text-center text-muted mb-0">No new notifications.</p></li>';
            notificationBadge.classList.add('d-none');
            previousNotificationCount = 0;
            updateSidebarBadges([]); // Clear sidebar badges as well
        });

    } else {
        notificationBadge.classList.add('d-none');
        notificationList.innerHTML = '<li><p class="p-3 text-center text-muted mb-0">No new notifications.</p></li>';
    }
}

/**
 * Updates notification badges on the sidebar navigation items.
 * @param {Array<object>} allNotifications - The combined list of all notifications.
 */
function updateSidebarBadges(allNotifications) {
    const vehicleNotifications = allNotifications.filter(n => n.type === 'vehicle').length;
    const formNotifications = allNotifications.filter(n => n.type === 'form').length;

    const updateBadge = (navItemId, count) => {
        const navItem = document.getElementById(navItemId);
        if (navItem) {
            const existingBadge = navItem.querySelector('.badge');
            if (existingBadge) existingBadge.remove();
            
            if (count > 0) {
                navItem.classList.add('d-flex', 'justify-content-between', 'align-items-center');
                navItem.insertAdjacentHTML('beforeend', `<span class="badge bg-danger rounded-pill">${count}</span>`);
            } else {
                navItem.classList.remove('d-flex', 'justify-content-between', 'align-items-center');
            }
        }
    };
    
    updateBadge('nav-vehicle-mgt', vehicleNotifications);
    if (currentUserRole === 'student') updateBadge('nav-forms', formNotifications);
    else if (currentUserRole === 'teacher') updateBadge('nav-teacher-forms', formNotifications);
}

/**
 * Manually toggles the notification dropdown visibility.
 * This provides a more robust solution than relying only on Bootstrap's data attributes.
 * @param {Event} event - The click event.
 */
window.toggleNotificationDropdown = (event) => {
    const menu = document.getElementById('notification-list');
    if (menu) {
        // This uses Bootstrap's built-in component instance to toggle
        const dropdown = new bootstrap.Dropdown(document.getElementById('notificationBell'));
        dropdown.toggle();
    }
    event.stopPropagation();
};


// Add a global click listener to hide the notification dropdown when clicking outside
window.addEventListener('click', function(event) {
    const notificationBell = document.getElementById('notificationBell');
    const notificationList = document.getElementById('notification-list');

    // If the bell or list doesn't exist, do nothing
    if (!notificationBell || !notificationList) {
        return;
    }

    // Check if the dropdown is open and the click is outside the bell button
    // The .contains check ensures that clicks inside the bell icon don't close the dropdown
    if (notificationList.classList.contains('show') && !notificationBell.contains(event.target)) {
        const dropdownInstance = bootstrap.Dropdown.getInstance(notificationBell);
        if (dropdownInstance) {
            dropdownInstance.hide();
        }
    }
});


/**
 * Renders the admin interface for managing vehicles and their documents.
 */
window.renderVehicleManagement = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) return;

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Vehicle Management</h1>
        <div class="row">
            <div class="col-lg-4">
                <div class="card shadow mb-4">
                    <div class="card-header py-3"><h6 id="vehicle-form-title" class="m-0 fw-bold text-primary">Add New Vehicle</h6></div>
                    <div class="card-body">
                        <form id="vehicle-form">
                            <div class="mb-3">
                                <label class="form-label">Registration Number</label>
                                <input id="vehicle-reg-no" class="form-control" placeholder="e.g., KL-55-AB-1234" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Vehicle Type</label>
                                <select id="vehicle-type" class="form-select">
                                    <option value="Bus">Bus</option>
                                    <option value="Van">Van</option>
                                    <option value="Cruiser">Cruiser</option>
                                    <option value="Jeep">Jeep</option>
                                    <option value="Car">Car</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Registration Date</label>
                                <input type="date" id="vehicle-reg-date" class="form-control">
                            </div>
                            <hr>
                            <h6 class="fw-bold mb-3">Document Expiry Dates</h6>
                            <div class="row g-3">
                                <div class="col-6"><label class="form-label">Tax</label><input type="date" id="vehicle-tax" class="form-control"></div>
                                <div class="col-6"><label class="form-label">Permit</label><input type="date" id="vehicle-permit" class="form-control"></div>
                                <div class="col-6"><label class="form-label">Insurance</label><input type="date" id="vehicle-insurance" class="form-control"></div>
                                <div class="col-6"><label class="form-label">Fitness</label><input type="date" id="vehicle-fitness" class="form-control"></div>
                                <div class="col-6"><label class="form-label">Pollution</label><input type="date" id="vehicle-pollution" class="form-control"></div>
                                <div class="col-6"><label class="form-label">GPS</label><input type="date" id="vehicle-gps" class="form-control"></div>
                            </div>
                            <div class="d-flex justify-content-end gap-2 mt-4">
                                <button type="button" id="cancel-vehicle-edit-btn" class="btn btn-secondary d-none">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Vehicle</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="card shadow mb-4">
                    <div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">Registered Vehicles</h6></div>
                    <div class="card-body" id="vehicles-list-container"></div>
                </div>
            </div>
        </div>
    `;

    renderVehiclesList();
    attachVehicleFormListeners();
};

/**
 * Renders the list of all registered vehicles with expiry highlighting.
 */
/**
 * A helper function to determine the highlighting class, status text, and priority
 * for a vehicle document based on its expiry date and importance.
 * @param {string} dateStr - The expiry date of the document.
 * @param {string} docKey - The key for the document type (e.g., 'taxExpiry').
 * @returns {object} An object containing className, statusText, and a numeric priority.
 */
function getExpiryDetails(dateStr, docKey) {
    // 1. Define the importance of each document
    const documentImportance = {
        critical: ['taxExpiry', 'fitnessExpiry', 'insuranceExpiry','pollutionExpiry','permitExpiry','gpsExpiry'],
        warning: ['permitExpiry', 'pollutionExpiry'],
        info: ['gpsExpiry']
    };

    if (!dateStr) return { className: '', statusText: 'Not set', priority: 0 };

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const expiryDate = new Date(dateStr);
    const thirtyDaysFromNow = new Date();
    thirtyDaysFromNow.setDate(today.getDate() + 30);

    const timeDiff = expiryDate.getTime() - today.getTime();
    const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24));

    let status = { className: '', statusText: `Expires on ${expiryDate.toLocaleDateString('en-GB')}`, priority: 0 };

    // 2. Determine status based on dates
    if (expiryDate < today) {
        status.statusText = `Expired ${Math.abs(daysRemaining)} days ago`;
        // Expired items get the highest priority
        if (documentImportance.critical.includes(docKey)) {
            status.className = 'bg-danger text-white';
            status.priority = 100;
        } else {
            status.className = 'table-danger';
            status.priority = 90;
        }
    } else if (expiryDate <= thirtyDaysFromNow) {
        status.statusText = `Expires in ${daysRemaining} days`;
        // Expiring items get medium priority
        if (documentImportance.critical.includes(docKey)) {
            status.className = 'bg-warning text-dark';
            status.priority = 80;
        } else {
            status.className = 'table-warning';
            status.priority = 70;
        }
    }

    return status;
}


/**
 * Renders the list of all registered vehicles with prioritized highlighting for rows and cells.
 */
function renderVehiclesList() {
    const container = document.getElementById('vehicles-list-container');
    if (!container) return;

    if (!vehicles || vehicles.length === 0) {
        container.innerHTML = '<p class="text-muted">No vehicles have been registered.</p>';
        return;
    }

    const formatDate = (dateStr) => dateStr ? new Date(dateStr).toLocaleDateString('en-GB') : 'N/A';

    let tableHTML = `
        <div class="table-responsive">
            <table class="table table-bordered table-sm" style="font-size: 0.85rem;">
                <thead class="table-light">
                    <tr>
                        <th>Reg. No</th><th>Type</th><th>Tax</th><th>Insurance</th><th>Fitness</th><th>Permit</th><th>Pollution</th><th>GPS</th><th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;

    vehicles.forEach(v => {
        const docKeys = ['taxExpiry', 'insuranceExpiry', 'fitnessExpiry', 'permitExpiry', 'pollutionExpiry', 'gpsExpiry'];
        
        // 1. Determine the highest priority issue for the entire row
        let rowHighlightPriority = 0;
        let rowHighlightClass = '';

        docKeys.forEach(key => {
            const details = getExpiryDetails(v[key], key);
            if (details.priority > rowHighlightPriority) {
                rowHighlightPriority = details.priority;
                // Use a lighter version for the row highlight
                if (details.className.includes('danger')) rowHighlightClass = 'table-danger';
                else if (details.className.includes('warning')) rowHighlightClass = 'table-warning';
            }
        });

        tableHTML += `<tr class="${rowHighlightClass}">
                        <td class="fw-bold">${v.id}</td>
                        <td>${v.type}</td>`;

        // 2. Generate each cell with its specific highlight and tooltip
        docKeys.forEach(key => {
            const details = getExpiryDetails(v[key], key);
            tableHTML += `<td class="${details.className}" title="${details.statusText}">${formatDate(v[key])}</td>`;
        });
        
        tableHTML += `<td>
                        <button class="btn btn-sm btn-outline-primary py-0 px-1" onclick="window.editVehicle('${v.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="window.handleDelete('vehicles', '${v.id}')"><i class="fas fa-trash"></i></button>
                      </td>
                    </tr>`;
    });

    tableHTML += '</tbody></table></div>';
    container.innerHTML = tableHTML;
}
/**
 * Attaches listeners to the vehicle form for saving and editing.
 */
function attachVehicleFormListeners() {
    const form = document.getElementById('vehicle-form');
    const regNoInput = document.getElementById('vehicle-reg-no');
    const cancelBtn = document.getElementById('cancel-vehicle-edit-btn');
    const formTitle = document.getElementById('vehicle-form-title');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const regNo = regNoInput.value.toUpperCase().replace(/\s+/g, '');
        if (!regNo) {
            showAlert('Registration Number is required.', 'danger');
            return;
        }

        const vehicleData = {
            id: regNo,
            type: document.getElementById('vehicle-type').value,
            regDate: document.getElementById('vehicle-reg-date').value,
            taxExpiry: document.getElementById('vehicle-tax').value,
            permitExpiry: document.getElementById('vehicle-permit').value,
            insuranceExpiry: document.getElementById('vehicle-insurance').value,
            fitnessExpiry: document.getElementById('vehicle-fitness').value,
            pollutionExpiry: document.getElementById('vehicle-pollution').value,
            gpsExpiry: document.getElementById('vehicle-gps').value,
        };

        try {
            await setDoc(getDocRef('vehicles', regNo), vehicleData);
            showAlert(`Vehicle '${regNo}' saved successfully.`, 'success');
            form.reset();
            regNoInput.readOnly = false;
            cancelBtn.classList.add('d-none');
            formTitle.textContent = 'Add New Vehicle';
        } catch (error) {
            console.error("Error saving vehicle:", error);
            showAlert('Failed to save vehicle data.', 'danger');
        }
    });

    cancelBtn.addEventListener('click', () => {
        form.reset();
        regNoInput.readOnly = false;
        cancelBtn.classList.add('d-none');
        formTitle.textContent = 'Add New Vehicle';
    });
}

/**
 * Populates the form with data for editing a vehicle.
 * @param {string} regNo - The registration number of the vehicle to edit.
 */
window.editVehicle = (regNo) => {
    const vehicle = vehicles.find(v => v.id === regNo);
    if (!vehicle) return;

    document.getElementById('vehicle-form-title').textContent = `Edit Vehicle: ${regNo}`;
    document.getElementById('vehicle-reg-no').value = vehicle.id;
    document.getElementById('vehicle-reg-no').readOnly = true;
    document.getElementById('vehicle-type').value = vehicle.type;
    document.getElementById('vehicle-reg-date').value = vehicle.regDate;
    document.getElementById('vehicle-tax').value = vehicle.taxExpiry;
    document.getElementById('vehicle-permit').value = vehicle.permitExpiry;
    document.getElementById('vehicle-insurance').value = vehicle.insuranceExpiry;
    document.getElementById('vehicle-fitness').value = vehicle.fitnessExpiry;
    document.getElementById('vehicle-pollution').value = vehicle.pollutionExpiry;
    document.getElementById('vehicle-gps').value = vehicle.gpsExpiry;

    document.getElementById('cancel-vehicle-edit-btn').classList.remove('d-none');
};



function checkVehicleExpiriesAndNotify() { /// not part of the notifications
    const notificationList = document.getElementById('notification-list');
    const notificationBadge = document.getElementById('notification-badge');
    if (!notificationList || !notificationBadge) return;

    const notifications = [];
    const today = new Date();
    const thirtyDaysFromNow = new Date();
    thirtyDaysFromNow.setDate(today.getDate() + 30);

    vehicles.forEach(vehicle => {
        const checkExpiry = (dateStr, docName) => {
            if (!dateStr) return;
            const expiryDate = new Date(dateStr);
            if (expiryDate <= thirtyDaysFromNow) {
                const timeDiff = expiryDate.getTime() - today.getTime();
                const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24));
                notifications.push({
                    vehicleReg: vehicle.id,
                    docName: docName,
                    daysRemaining: daysRemaining,
                    expiryDate: expiryDate.toLocaleDateString('en-GB')
                });
            }
        };

        checkExpiry(vehicle.taxExpiry, 'Tax');
        checkExpiry(vehicle.permitExpiry, 'Permit');
        checkExpiry(vehicle.insuranceExpiry, 'Insurance');
        checkExpiry(vehicle.fitnessExpiry, 'Fitness');
        checkExpiry(vehicle.pollutionExpiry, 'Pollution');
        checkExpiry(vehicle.gpsExpiry, 'GPS');
    });

    renderNotifications(notifications);
}

function getLibraryDueNotifications() {
    if (currentUserRole !== 'student' || !selectedUser) return [];
    const notifications = [];
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const twoDaysFromNow = new Date();
    twoDaysFromNow.setDate(today.getDate() + 2);

    const myIssuedBooks = bookIssuances.filter(item =>
        item.studentId === selectedUser.id && item.status === 'Issued'
    );

    myIssuedBooks.forEach(book => {
        const dueDate = new Date(book.dueDate);
        if (dueDate <= twoDaysFromNow) {
            const timeDiff = dueDate.getTime() - today.getTime();
            const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            notifications.push({
                type: 'library',
                id: `library_${book.id}`,
                title: `Return Book: ${book.bookTitle}`,
                text: daysRemaining < 0 ? `Overdue by ${Math.abs(daysRemaining)} day(s).` : `Due in ${daysRemaining} day(s).`,
                targetView: 'my-library'
            });
        }
    });
    return notifications;
}
// ===================================================================================
// --- 📚 LIBRARY MANAGEMENT MODULE ---
// ===================================================================================

let bookToEdit = null;


/**
 * Main renderer for the Library. Includes an access check.
 */
window.renderLibraryManagement = () => {
    // Access check: Allow only for Admins or teachers with the 'librarian' role.
    const hasAccess = currentUserRole === 'admin' || (currentUserRole === 'teacher' && selectedUser.roles && selectedUser.roles.includes('librarian'));
    
    if (!hasAccess) {
        mainContent.innerHTML = `
            <div class="alert alert-danger">
                <h4>Access Denied</h4>
                <p>You do not have permission to access this module. Please see your class library status if applicable.</p>
            </div>`;
        return;
    }

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Library Management</h1>
        <ul class="nav nav-tabs" id="libraryTab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#issue-return" type="button">Issue / Return</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#inventory" type="button">Book Inventory</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#reports" type="button">Reports</button></li>
        </ul>
        <div class="tab-content card" id="libraryTabContent">
            <div class="tab-pane fade show active p-4" id="issue-return" role="tabpanel"></div>
            <div class="tab-pane fade p-4" id="inventory" role="tabpanel"></div>
            <div class="tab-pane fade p-4" id="reports" role="tabpanel"></div>
        </div>
    `;

    renderIssueReturnTab();
    renderInventoryTab();
    renderLibraryReportsTab();
}

/**
 * Renders the Issue/Return tab with role-based filtering for the student list.
 */
function renderIssueReturnTab() {
    const container = document.getElementById('issue-return');

    let visibleStudents = [];
    const isLibrarianOrAdmin = currentUserRole === 'admin' || (currentUserRole === 'teacher' && selectedUser.roles && selectedUser.roles.includes('librarian'));

    if (isLibrarianOrAdmin) {
        // Full access for librarians and admins
        visibleStudents = students;
    } else if (currentUserRole === 'teacher' && selectedUser.classCharge) {
        // Limited access for regular class teachers
        const { classId, division } = selectedUser.classCharge;
        visibleStudents = students.filter(s => s.classId === classId && s.division === division);
    }
    
    const studentOptions = visibleStudents.map(s => `<option value="${s.id}">${s.name} (${s.admissionNumber})</option>`).join('');

    container.innerHTML = `
        <div class="row">
            <div class="col-md-6 border-end">
                <h5 class="fw-bold mb-3">Issue a Book</h5>
                <div class="mb-3">
                    <label class="form-label">Search Student</label>
                    <input type="text" id="issue-student-search" class="form-control" list="student-list-options" placeholder="Select by ID or Name">
                    <datalist id="student-list-options">${studentOptions}</datalist>
                </div>
                <div id="issue-student-info" class="p-3 bg-light rounded mb-3"></div>
                <div class="mb-3">
                    <label class="form-label">Search Book</label>
                    <input type="text" id="issue-book-search" class="form-control" list="book-list-options" placeholder="Select by ID or Title">
                    <datalist id="book-list-options">${books.map(b => `<option value="${b.id}">${b.title} by ${b.author}</option>`).join('')}</datalist>
                </div>
                <div id="issue-book-info" class="p-3 bg-light rounded mb-3"></div>
                <div class="text-end">
                    <button id="issue-book-btn" class="btn btn-primary" disabled>Issue Book</button>
                </div>
            </div>
            <div class="col-md-6">
                <h5 class="fw-bold mb-3">Process a Return</h5>
                <p class="text-muted">Search for a student to see their issued books.</p>
                <div id="return-books-list"></div>
            </div>
        </div>
    `;
    attachIssueReturnListeners();
}

function renderInventoryTab() {
    const container = document.getElementById('inventory');
    const isEditMode = bookToEdit !== null;
    container.innerHTML = `
        <div class="row">
            <div class="col-lg-5">
                <form id="book-form" class="card p-3">
                    <h5 class="fw-bold mb-3">${isEditMode ? `Edit Book: ${bookToEdit.title}` : 'Add New Book'}</h5>
                    <div class="mb-3"><label class="form-label">Book ID</label><input type="text" id="book-id" class="form-control" value="${bookToEdit?.id || ''}" ${isEditMode ? 'readonly' : ''}></div>
                    <div class="mb-3"><label class="form-label">Title</label><input type="text" id="book-title" class="form-control" value="${bookToEdit?.title || ''}"></div>
                    <div class="mb-3"><label class="form-label">Author</label><input type="text" id="book-author" class="form-control" value="${bookToEdit?.author || ''}"></div>
                    <div class="mb-3"><label class="form-label">Genre</label><input type="text" id="book-genre" class="form-control" value="${bookToEdit?.genre || ''}"></div>
                    <div class="mb-3"><label class="form-label">Total Copies</label><input type="number" id="book-copies" class="form-control" value="${bookToEdit?.totalCopies || ''}"></div>
                    <div class="text-end">
                         ${isEditMode ? `<button type="button" class="btn btn-secondary me-2" onclick="window.clearBookEdit()">Cancel</button>`: ''}
                        <button type="submit" class="btn btn-primary">${isEditMode ? 'Update' : 'Add Book'}</button>
                    </div>
                </form>
            </div>
            <div class="col-lg-7" id="book-inventory-list"></div>
        </div>
    `;
    renderBookInventoryList();
    attachInventoryFormListeners();
}

function renderLibraryReportsTab() {
    const container = document.getElementById('reports');

    const getSortIcon = (column) => {
        if (libraryReportSort.column !== column) return '<i class="fas fa-sort fa-xs text-muted ms-1"></i>';
        return libraryReportSort.direction === 'asc'
            ? '<i class="fas fa-sort-up text-primary ms-1"></i>'
            : '<i class="fas fa-sort-down text-primary ms-1"></i>';
    };

    container.innerHTML = `
        <h5 class="fw-bold mb-3">Issued Books Report</h5>
        
        <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
            <div class="col-md-4">
                <label for="report-filter-class" class="form-label">Filter by Class</label>
                <select id="report-filter-class" class="form-select form-select-sm">
                    <option value="">-- All Classes --</option>
                    ${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                </select>
            </div>
            <div class="col-md-4">
                <label for="report-filter-division" class="form-label">Filter by Division</label>
                <select id="report-filter-division" class="form-select form-select-sm" disabled>
                    <option value="">-- All --</option>
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                 <button id="download-report-csv" class="btn btn-success w-100">
                    <i class="fas fa-download me-2"></i>Download CSV
                 </button>
            </div>
        </div>

        <div class="form-check my-3">
            <input class="form-check-input" type="checkbox" id="overdue-filter-checkbox">
            <label class="form-check-label" for="overdue-filter-checkbox">
                Show only overdue books
            </label>
        </div>

        <div id="report-table-content"></div>
    `;

    const classFilter = document.getElementById('report-filter-class');
    const divisionFilter = document.getElementById('report-filter-division');
    const overdueCheckbox = document.getElementById('overdue-filter-checkbox');
    const reportContent = document.getElementById('report-table-content');

    const updateReport = () => {
        const selectedClassId = classFilter.value;
        const selectedDivision = divisionFilter.value;
        const showOnlyOverdue = overdueCheckbox.checked;

        // 1. Get initial data: all currently issued books
        let reportData = bookIssuances.filter(item => item.status === 'Issued');

        // 2. Apply class and division filters
        if (selectedClassId) {
            const studentIdsInClass = students
                .filter(s => s.classId === selectedClassId && (!selectedDivision || s.division === selectedDivision))
                .map(s => s.id);
            reportData = reportData.filter(item => studentIdsInClass.includes(item.studentId));
        }

        // 3. Apply overdue filter
        if (showOnlyOverdue) {
            reportData = reportData.filter(item => new Date(item.dueDate) < new Date());
        }

        // 4. Apply sorting
        reportData.sort((a, b) => {
            const valA = a[libraryReportSort.column] || '';
            const valB = b[libraryReportSort.column] || '';
            const comparison = valA.localeCompare(valB, undefined, { numeric: true });
            return libraryReportSort.direction === 'asc' ? comparison : comparison * -1;
        });
        
        // 5. Store the final data for CSV export
        currentLibraryReportData = [...reportData];

        // 6. Render the final table
        reportContent.innerHTML = `
            ${reportData.length === 0 ? '<p class="text-muted">No records match the current filters.</p>' : `
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th onclick="handleReportSort('studentName')" style="cursor: pointer;">Student Name ${getSortIcon('studentName')}</th>
                            <th onclick="handleReportSort('bookTitle')" style="cursor: pointer;">Book Title ${getSortIcon('bookTitle')}</th>
                            <th onclick="handleReportSort('issueDate')" style="cursor: pointer;">Issue Date ${getSortIcon('issueDate')}</th>
                            <th onclick="handleReportSort('dueDate')" style="cursor: pointer;">Due Date ${getSortIcon('dueDate')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${reportData.map(item => {
                            const isOverdue = new Date(item.dueDate) < new Date();
                            return `
                            <tr class="${isOverdue ? 'table-danger' : ''}">
                                <td>${item.studentName}</td>
                                <td>${item.bookTitle}</td>
                                <td>${new Date(item.issueDate).toLocaleDateString()}</td>
                                <td>${new Date(item.dueDate).toLocaleDateString()}</td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            </div>`}`;
    };

    // Attach event listeners
    classFilter.addEventListener('change', () => {
        const selectedClass = classes.find(c => c.id === classFilter.value);
        divisionFilter.innerHTML = '<option value="">-- All --</option>';
        divisionFilter.disabled = !selectedClass;
        if (selectedClass) {
            divisionFilter.innerHTML += selectedClass.divisions.map(d => `<option value="${d}">${d}</option>`).join('');
        }
        updateReport();
    });
    divisionFilter.addEventListener('change', updateReport);
    overdueCheckbox.addEventListener('change', updateReport);
    document.getElementById('download-report-csv').addEventListener('click', downloadLibraryReportCSV);

    // Initial render
    updateReport();
}

/**
 * Handles clicks on the report table headers to update the sorting state.
 * @param {string} column The name of the column to sort by.
 */
window.handleReportSort = (column) => {
    // If clicking the same column, toggle the direction
    if (libraryReportSort.column === column) {
        libraryReportSort.direction = libraryReportSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        // If clicking a new column, set it as the sort column and default to ascending
        libraryReportSort.column = column;
        libraryReportSort.direction = 'asc';
    }
    // Re-render the tab to apply the new sorting
    renderLibraryReportsTab();
};


/**
 * Downloads the currently filtered and sorted library report data as a CSV file.
 */
window.downloadLibraryReportCSV = () => {
    if (currentLibraryReportData.length === 0) {
        showAlert('No data to export.', 'info');
        return;
    }

    const headers = ['Student Name', 'Admission No', 'Class', 'Book Title', 'Issue Date', 'Due Date', 'Days Overdue'];
    
    const rows = currentLibraryReportData.map(item => {
        const student = students.find(s => s.id === item.studentId);
        const studentClass = student ? classes.find(c => c.id === student.classId) : null;
        const className = studentClass ? `${studentClass.name}-${student.division}` : 'N/A';
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const dueDate = new Date(item.dueDate);
        const timeDiff = today.getTime() - dueDate.getTime();
        const daysOverdue = timeDiff > 0 ? Math.floor(timeDiff / (1000 * 3600 * 24)) : 0;

        const rowData = [
            item.studentName,
            student?.admissionNumber || 'N/A',
            className,
            item.bookTitle,
            new Date(item.issueDate).toLocaleDateString(),
            new Date(item.dueDate).toLocaleDateString(),
            daysOverdue
        ];
        // Escape commas and quotes for CSV format
        return rowData.map(val => `"${String(val).replace(/"/g, '""')}"`).join(',');
    });

    const csvContent = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `library_report_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

// --- STUDENT & TEACHER RENDERERS ---
window.renderMyLibrary = () => {
    const issued = bookIssuances.filter(item => item.studentId === selectedUser.id && item.status === 'Issued');
    const history = bookIssuances.filter(item => item.studentId === selectedUser.id && item.status === 'Returned');

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">My Library</h1>
        <div class="card shadow mb-4">
            <div class="card-header fw-bold text-primary">Currently Issued Books</div>
            <div class="card-body">
                ${issued.length === 0 ? '<p class="text-muted">You have no books currently issued.</p>' : `
                <ul class="list-group list-group-flush">
                    ${issued.map(item => `<li class="list-group-item"><strong>${item.bookTitle}</strong><br><small class="text-muted">Issued: ${new Date(item.issueDate).toLocaleDateString()} | Due: ${new Date(item.dueDate).toLocaleDateString()}</small></li>`).join('')}
                </ul>`}
            </div>
        </div>
        <div class="card shadow">
            <div class="card-header fw-bold">My Reading History</div>
            <div class="card-body">
                 ${history.length === 0 ? '<p class="text-muted">No returned books in your history.</p>' : `
                <ul class="list-group list-group-flush">
                    ${history.map(item => `<li class="list-group-item"><strong>${item.bookTitle}</strong><br><small class="text-muted">Returned on: ${new Date(item.returnDate).toLocaleDateString()}</small></li>`).join('')}
                </ul>`}
            </div>
        </div>
    `;
}

window.renderTeacherLibraryStatus = () => {
    if (!selectedUser.classCharge) {
        mainContent.innerHTML = `<h1 class="h2 mb-4">Library Status</h1><p class="text-warning">You are not assigned as a class teacher to view this page.</p>`;
        return;
    }
    const { classId, division } = selectedUser.classCharge;
    const studentsInClass = students.filter(s => s.classId === classId && s.division === division);
    const studentIds = studentsInClass.map(s => s.id);
    const issuedToClass = bookIssuances.filter(item => studentIds.includes(item.studentId) && item.status === 'Issued');

    mainContent.innerHTML = `
         <h1 class="h2 mb-4">Library Status for Your Class</h1>
         <div class="card shadow">
            <div class="card-body table-responsive">
                <table class="table">
                    <thead><tr><th>Student Name</th><th>Book Title</th><th>Due Date</th></tr></thead>
                    <tbody>
                        ${studentsInClass.map(student => {
                            const book = issuedToClass.find(b => b.studentId === student.id);
                            return `
                                <tr>
                                    <td>${student.name}</td>
                                    ${book ? `<td>${book.bookTitle}</td><td>${new Date(book.dueDate).toLocaleDateString()}</td>` : '<td colspan="2" class="text-muted">No book issued</td>'}
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
         </div>
    `;
}

// --- HELPER & ACTION FUNCTIONS ---
function renderBookInventoryList() {
    const container = document.getElementById('book-inventory-list');
    container.innerHTML = `
        <h5 class="mb-3">All Books</h5>
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead><tr><th>ID</th><th>Title</th><th>Author</th><th>Available</th><th>Actions</th></tr></thead>
                <tbody>
                    ${books.map(b => `
                        <tr>
                            <td>${b.id}</td>
                            <td>${b.title}</td>
                            <td>${b.author}</td>
                            <td>${b.availableCopies} / ${b.totalCopies}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary py-0 px-1" onclick="window.editBook('${b.id}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="handleDelete('books', '${b.id}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function attachInventoryFormListeners() {
    document.getElementById('book-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('book-id').value.trim();
        const totalCopies = parseInt(document.getElementById('book-copies').value);
        if (!id) { showAlert('Book ID is required', 'danger'); return; }

        let availableCopies = totalCopies;
        if (bookToEdit) {
            const issuedCount = bookToEdit.totalCopies - bookToEdit.availableCopies;
            availableCopies = totalCopies - issuedCount;
        }

        const bookData = {
            id,
            title: document.getElementById('book-title').value,
            author: document.getElementById('book-author').value,
            genre: document.getElementById('book-genre').value,
            totalCopies,
            availableCopies
        };
        await setDoc(getDocRef('books', id), bookData);
        showAlert('Book saved successfully!', 'success');
        clearBookEdit();
    });
}

function attachIssueReturnListeners() {
    const studentSearch = document.getElementById('issue-student-search');
    const bookSearch = document.getElementById('issue-book-search');
    const studentInfo = document.getElementById('issue-student-info');
    const bookInfo = document.getElementById('issue-book-info');
    const issueBtn = document.getElementById('issue-book-btn');
    const returnList = document.getElementById('return-books-list');
    let selectedStudent = null;
    let selectedBook = null;

    // (The validation logic inside this function remains the same)
    const validateIssue = () => {
        issueBtn.disabled = true;
        if (!selectedStudent || !selectedBook) return;

        const currentlyIssuedCount = bookIssuances.filter(i => i.studentId === selectedStudent.id && i.status === 'Issued').length;
        if (currentlyIssuedCount >= 2) {
            studentInfo.innerHTML += '<p class="text-danger small mt-2">This student already has 2 books.</p>';
            return;
        }
        if (selectedBook.availableCopies <= 0) {
            bookInfo.innerHTML += '<p class="text-danger small mt-2">No copies of this book are available.</p>';
            return;
        }
        issueBtn.disabled = false;
    };

    studentSearch.addEventListener('change', () => {
        selectedStudent = students.find(s => s.id === studentSearch.value);
        if (selectedStudent) {
            const issuedCount = bookIssuances.filter(i => i.studentId === selectedStudent.id && i.status === 'Issued').length;
            studentInfo.innerHTML = `<strong>Name:</strong> ${selectedStudent.name}<br><strong>Class:</strong> ${getStudentClassName(selectedStudent.classId, selectedStudent.division)}<br><strong>Books Held:</strong> ${issuedCount}`;
            
            const studentBooks = bookIssuances.filter(i => i.studentId === selectedStudent.id && i.status === 'Issued');
            
            // --- MODIFIED: Added an "Edit" button next to the "Return" button ---
            returnList.innerHTML = studentBooks.length === 0 ? '<p class="text-muted">No books to return.</p>' :
                `<ul class="list-group">${studentBooks.map(b => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            ${b.bookTitle}<br>
                            <small>Due: ${new Date(b.dueDate).toLocaleDateString()}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="window.openEditIssuanceModal('${b.id}')">Edit</button>
                            <button class="btn btn-sm btn-success" onclick="window.returnBook('${b.id}')">Return</button>
                        </div>
                    </li>`).join('')}
                </ul>`;

        } else {
            studentInfo.innerHTML = '';
            returnList.innerHTML = '';
        }
        validateIssue();
    });


    bookSearch.addEventListener('change', () => {
        selectedBook = books.find(b => b.id === bookSearch.value);
        if (selectedBook) {
            bookInfo.innerHTML = `<strong>Title:</strong> ${selectedBook.title}<br><strong>Author:</strong> ${selectedBook.author}<br><strong>Available:</strong> ${selectedBook.availableCopies}`;
        } else {
            bookInfo.innerHTML = '';
        }
        validateIssue();
    });
    
    // --- MODIFIED: Add audit fields on issue ---
    issueBtn.addEventListener('click', async () => {
        const today = new Date();
        const dueDate = new Date();
        dueDate.setDate(today.getDate() + 15); // Set due date to 15 days from now

        const issuanceData = {
            bookId: selectedBook.id,
            bookTitle: selectedBook.title,
            studentId: selectedStudent.id,
            studentName: selectedStudent.name,
            issueDate: today.toISOString().slice(0, 10),
            dueDate: dueDate.toISOString().slice(0, 10),
            returnDate: null,
            status: 'Issued',
            // --- Audit Fields ---
            issuedByUserId: selectedUser.id,
            issuedByUserName: selectedUser.name
        };

        const bookRef = getDocRef('books', selectedBook.id);
        const issuanceRef = doc(collection(db, `/artifacts/${appId}/public/data/bookIssuances`));

        const batch = writeBatch(db);
        batch.set(issuanceRef, issuanceData);
        batch.update(bookRef, { availableCopies: selectedBook.availableCopies - 1 });
        await batch.commit();
        
        showAlert('Book issued successfully!', 'success');
        studentSearch.value = '';
        bookSearch.value = '';
        studentInfo.innerHTML = '';
        bookInfo.innerHTML = '';
        issueBtn.disabled = true;
    });
}

/**
 * Opens and populates the modal to edit an existing book issuance record.
 * @param {string} issuanceId - The ID of the bookIssuances document to edit.
 */
window.openEditIssuanceModal = (issuanceId) => {
    const issuance = bookIssuances.find(i => i.id === issuanceId);
    if (!issuance) {
        showAlert('Could not find the issuance record.', 'danger');
        return;
    }

    // Populate the modal with the existing data
    document.getElementById('modal-issuance-id').value = issuance.id;
    document.getElementById('modal-student-name').textContent = issuance.studentName;
    document.getElementById('modal-book-title').textContent = issuance.bookTitle;
    document.getElementById('modal-due-date').value = issuance.dueDate;
    
    // Show the modal
    const editModal = new bootstrap.Modal(document.getElementById('editIssuanceModal'));
    
    // Attach the save function to the button's click event
    document.getElementById('modal-save-issuance-btn').onclick = () => saveIssuanceChanges(editModal);
    
    editModal.show();
}

/**
 * Saves the changes from the edit issuance modal to Firestore.
 * @param {object} modalInstance - The Bootstrap modal instance to be hidden on success.
 */
async function saveIssuanceChanges(modalInstance) {
    const issuanceId = document.getElementById('modal-issuance-id').value;
    const newDueDate = document.getElementById('modal-due-date').value;

    if (!issuanceId || !newDueDate) {
        showAlert('New due date cannot be empty.', 'danger');
        return;
    }

    const issuanceRef = getDocRef('bookIssuances', issuanceId);

    try {
        await updateDoc(issuanceRef, {
            dueDate: newDueDate,
            // Add audit fields for the update action
            lastUpdatedByUserId: selectedUser.id,
            lastUpdatedByUserName: selectedUser.name,
            lastUpdatedAt: serverTimestamp()
        });
        
        showAlert('Due date updated successfully!', 'success');
        modalInstance.hide();
        // The real-time listener will automatically refresh the list in the UI.
    } catch (error) {
        console.error("Error updating issuance:", error);
        showAlert('Failed to update due date.', 'danger');
    }
}

// --- MODIFIED: Add audit fields on return ---
window.returnBook = async (issuanceId) => {
    const issuance = bookIssuances.find(i => i.id === issuanceId);
    if (!issuance) return;

    const book = books.find(b => b.id === issuance.bookId);
    
    const issuanceRef = getDocRef('bookIssuances', issuanceId);
    const bookRef = getDocRef('books', issuance.bookId);

    const batch = writeBatch(db);
    
    // --- Audit Fields ---
    const updateData = {
        status: 'Returned',
        returnDate: new Date().toISOString().slice(0, 10),
        returnedByUserId: selectedUser.id,
        returnedByUserName: selectedUser.name
    };
    
    batch.update(issuanceRef, updateData);
    if(book) {
        batch.update(bookRef, { availableCopies: book.availableCopies + 1 });
    }
    await batch.commit();

    showAlert('Book returned successfully!', 'success');
    // Manually trigger the change event on the student search to refresh the view
    document.getElementById('issue-student-search').dispatchEvent(new Event('change'));
}

window.editBook = (bookId) => {
    bookToEdit = books.find(b => b.id === bookId);
    renderInventoryTab();
}

window.clearBookEdit = () => {
    bookToEdit = null;
    renderInventoryTab();
}


// =========================================================================
// --- 1. GLOBAL STATE & INITIALIZATION
// =========================================================================

// Central state management object to hold temporary data and selections
const state = {
    festToEdit: null,
    houseToEdit: null,
    eventToEdit: null,
    registrationToEdit: null,
};

// Main function to render the entire fest management interface
window.renderFestManagement = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) {
        console.error("Fatal Error: #main-content container not found.");
        return;
    }

    // Set up the main tab structure
    mainContent.innerHTML = `
        <h1 class="h2 mb-4 fw-bold">Fest Management Dashboard</h1>
        <ul class="nav nav-tabs" id="festMgtTab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#fest-setup" type="button">Setup</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fest-events" type="button">Events</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fest-participants" type="button">Participants</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fest-scoring" type="button">Score Entry</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fest-final-results" type="button">Final Results</button></li>
        </ul>
        <div class="tab-content" id="festMgtTabContent">
            <div class="tab-pane fade show active" id="fest-setup" role="tabpanel"></div>
            <div class="tab-pane fade" id="fest-events" role="tabpanel"></div>
            <div class="tab-pane fade" id="fest-participants" role="tabpanel"></div>
            <div class="tab-pane fade" id="fest-scoring" role="tabpanel"></div>
            <div class="tab-pane fade" id="fest-final-results" role="tabpanel"></div>
        </div>
        
        <div class="modal fade" id="editRegistrationModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Registration</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div id="edit-modal-body" class="modal-body">
                        </div>
                    <div class="modal-footer">
                         <button type="button" class="btn btn-danger me-auto" id="edit-modal-delete-btn">Delete Registration</button>
                         <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                         <button type="button" id="edit-modal-save-btn" class="btn btn-primary">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Render content for each tab
    renderFestSetupTab();
    renderFestEventsTab();
    renderFestParticipantsTab();
    renderFestScoringTab();
    renderFestFinalResultsTab();
};


// =========================================================================
// --- 2. SETUP TAB (Fests, Houses, Global Settings)
// =========================================================================

/**
 * Renders the entire "Setup" tab, including forms and lists for fests and houses.
 */
function renderFestSetupTab() {
    const container = document.getElementById('fest-setup');
    if (!container) return;

    const limits = festSettings.houseEventLimits || { solo: 2, group: 1 };
    const ageCategoryRows = festSettings.ageCategories?.map(cat => `
        <tr>
            <td><input type="text" class="form-control form-control-sm age-cat-name" value="${cat.name}"></td>
            <td><input type="date" class="form-control form-control-sm age-cat-date" value="${cat.bornAfterDate}"></td>
            <td><button type="button" class="btn btn-sm btn-outline-danger py-0 px-2 remove-cat-row-btn">&times;</button></td>
        </tr>`).join('') || '';

    container.innerHTML = `
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="ui-card h-100">
                <h5 class="section-header"><i class="fas fa-trophy me-2"></i>Manage Fests</h5>
                <form id="fest-form" class="mb-4">
                    <div class="mb-3">
                        <label class="form-label">Fest ID</label>
                        <input type="text" id="fest-id" class="form-control" placeholder="e.g., ARTS2025" value="${state.festToEdit?.id || ''}" ${state.festToEdit ? 'readonly' : ''}>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Fest Name</label>
                        <input type="text" id="fest-name" class="form-control" placeholder="e.g., Annual Arts Fest 2025" value="${state.festToEdit?.name || ''}">
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" role="switch" id="fest-reg-status" ${state.festToEdit?.registrationOpen !== false ? 'checked' : ''}>
                        <label class="form-check-label" for="fest-reg-status">Registration Open</label>
                    </div>
                    <div class="text-end">
                        ${state.festToEdit ? `<button type="button" class="btn btn-secondary me-2" onclick="clearFestEdit()">Cancel</button>` : ''}
                        <button type="submit" class="btn btn-primary">${state.festToEdit ? 'Update' : 'Add'} Fest</button>
                    </div>
                </form>
                <hr>
                <h6 class="mt-4">Existing Fests</h6>
                <div id="fests-list"></div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="ui-card h-100">
                <h5 class="section-header"><i class="fas fa-flag-checkered me-2"></i>Manage Houses</h5>
                <form id="house-form" class="mb-4">
                     <div class="mb-3">
                        <label class="form-label">House ID</label>
                        <input type="text" id="house-id" class="form-control" placeholder="e.g., RED" value="${state.houseToEdit?.id || ''}" ${state.houseToEdit ? 'readonly' : ''}>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">House Name</label>
                        <input type="text" id="house-name" class="form-control" placeholder="e.g., Red Racers" value="${state.houseToEdit?.name || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">House Color</label>
                        <input type="color" id="house-color" class="form-control form-control-color" value="${state.houseToEdit?.color || '#FF0000'}" title="Choose color">
                    </div>
                    <div class="text-end">
                        ${state.houseToEdit ? `<button type="button" class="btn btn-secondary me-2" onclick="clearHouseEdit()">Cancel</button>` : ''}
                        <button type="submit" class="btn btn-primary">${state.houseToEdit ? 'Update' : 'Add'} House</button>
                    </div>
                </form>
                <hr>
                <h6 class="mt-4">Existing Houses</h6>
                <div id="houses-list"></div>
            </div>
        </div>

        <div class="col-12">
            <div class="ui-card">
                <h5 class="section-header"><i class="fas fa-cogs"></i> Global & Age Settings</h5>
                <div class="row">
                    <div class="col-md-4 mb-3"><label class="form-label">Max Events per Student</label><input type="number" id="max-events" class="form-control" value="${festSettings.maxEventsPerStudent || 3}"></div>
                    <div class="col-md-4 mb-3"><label class="form-label">Max Solo per House/Event</label><input type="number" id="limit-solo" class="form-control" value="${limits.solo}"></div>
                    <div class="col-md-4 mb-3"><label class="form-label">Max Group per House/Event</label><input type="number" id="limit-group" class="form-control" value="${limits.group}"></div>
                </div>
                <hr>
                <label class="form-label fw-bold">Age Categories (Define categories from youngest to oldest)</label>
                <div class="table-responsive">
                    <table id="age-category-table" class="table table-sm"><thead><tr><th>Name</th><th>Born On or After Date</th><th></th></tr></thead><tbody>${ageCategoryRows}</tbody></table>
                </div>
                <button type="button" id="add-age-category" class="btn btn-sm btn-outline-secondary mb-3"><i class="fas fa-plus me-1"></i>Add Category</button>
                <div class="text-end"><button id="save-fest-settings" class="btn btn-success">Save All Settings</button></div>
            </div>
        </div>
    </div>`;

    // Populate the lists and attach event listeners
    renderFestsList();
    renderHousesList();
    attachSetupTabListeners();
}

/**
 * Renders the list of existing fests.
 */
function renderFestsList() {
    const container = document.getElementById('fests-list');
    if (!container) return;

    if (fests.length === 0) {
        container.innerHTML = '<p class="text-muted text-center p-3">No fests created yet.</p>';
        return;
    }

    const sortedFests = [...fests].sort((a, b) => a.name.localeCompare(b.name));
    container.innerHTML = `
    <div class="table-responsive">
        <table class="table table-sm table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Status</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                ${sortedFests.map(fest => `
                <tr>
                    <td><strong>${fest.id}</strong></td>
                    <td>${fest.name}</td>
                    <td>
                        <span class="badge ${fest.registrationOpen !== false ? 'bg-success' : 'bg-secondary'}">
                            ${fest.registrationOpen !== false ? 'Open' : 'Closed'}
                        </span>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1" onclick="editFest('${fest.id}')" title="Edit"><i class="fas fa-edit fa-xs"></i></button>
                        <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="deleteFestItem('fests', '${fest.id}', 'renderFestSetupTab')" title="Delete"><i class="fas fa-trash fa-xs"></i></button>
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>
    </div>`;
}

/**
 * Renders the list of existing houses.
 */
function renderHousesList() {
    const container = document.getElementById('houses-list');
    if (!container) return;
    
    if (festHouses.length === 0) {
        container.innerHTML = '<p class="text-muted text-center p-3">No houses created yet.</p>';
        return;
    }

    const sortedHouses = [...festHouses].sort((a, b) => a.name.localeCompare(b.name));
    container.innerHTML = `
    <div class="table-responsive">
        <table class="table table-hover table-sm">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Color</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                ${sortedHouses.map(house => `
                <tr>
                    <td><strong>${house.id}</strong></td>
                    <td>${house.name}</td>
                    <td><span class="color-dot-display" style="background-color:${house.color};"></span> ${house.color}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1" onclick="editHouse('${house.id}')" title="Edit"><i class="fas fa-edit fa-xs"></i></button>
                        <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="deleteFestItem('festHouses', '${house.id}', 'renderFestSetupTab')" title="Delete"><i class="fas fa-trash fa-xs"></i></button>
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>
    </div>`;
}


/**
 * Attaches all event listeners for the Setup Tab.
 */
function attachSetupTabListeners() {
    // Fest form submission
    document.getElementById('fest-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('fest-id').value.trim().toUpperCase();
        const name = document.getElementById('fest-name').value.trim();
        const registrationOpen = document.getElementById('fest-reg-status').checked;

        if (!id || !name) {
            return showAlert('Fest ID and Name are required.', 'danger');
        }

        const festData = { id, name, registrationOpen };
        try {
            await setDoc(getDocRef('fests', id), festData, { merge: true });
            showAlert(`Fest '${name}' saved successfully.`, 'success');
            clearFestEdit(); // This will clear the form and re-render
        } catch (error) {
            console.error("Error saving fest:", error);
            showAlert('Failed to save fest. See console for details.', 'danger');
        }
    });

    // House form submission
    document.getElementById('house-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('house-id').value.trim().toUpperCase();
        const name = document.getElementById('house-name').value.trim();
        const color = document.getElementById('house-color').value;
        if (!id || !name) { return showAlert('House ID and Name are required.', 'danger'); }

        try {
            await setDoc(getDocRef('festHouses', id), { id, name, color }, { merge: true });
            showAlert(`House '${name}' saved successfully.`, 'success');
            clearHouseEdit(); // This will clear the form and re-render
        } catch (error) {
            console.error("Error saving house:", error);
            showAlert('Failed to save house. See console for details.', 'danger');
        }
    });
    
    // Add new age category row
    document.getElementById('add-age-category')?.addEventListener('click', () => {
        document.querySelector('#age-category-table tbody')?.insertAdjacentHTML('beforeend', `
            <tr>
                <td><input type="text" class="form-control form-control-sm age-cat-name" placeholder="e.g., Sub-Juniors"></td>
                <td><input type="date" class="form-control form-control-sm age-cat-date"></td>
                <td><button type="button" class="btn btn-sm btn-outline-danger py-0 px-2 remove-cat-row-btn">&times;</button></td>
            </tr>`);
    });
    
    // Remove age category row (delegated listener)
    document.getElementById('age-category-table')?.addEventListener('click', e => {
        if (e.target.classList.contains('remove-cat-row-btn')) {
            e.target.closest('tr').remove();
        }
    });

    // Save all global and age settings
    document.getElementById('save-fest-settings')?.addEventListener('click', async () => {
        const newSettings = {
            maxEventsPerStudent: parseInt(document.getElementById('max-events').value) || 3,
            houseEventLimits: {
                solo: parseInt(document.getElementById('limit-solo').value) || 2,
                group: parseInt(document.getElementById('limit-group').value) || 1,
            },
            ageCategories: []
        };
        
        document.querySelectorAll('#age-category-table tbody tr').forEach(row => {
            const name = row.querySelector('.age-cat-name')?.value.trim();
            const bornAfterDate = row.querySelector('.age-cat-date')?.value;
            if (name && bornAfterDate) {
                newSettings.ageCategories.push({ name, bornAfterDate });
            }
        });
        
        // Sort categories by date to ensure correct logic later
        newSettings.ageCategories.sort((a,b) => new Date(b.bornAfterDate) - new Date(a.bornAfterDate));

        try {
            await setDoc(getDocRef('festSettings', 'main'), newSettings);
            showAlert('Global settings saved successfully.', 'success');
        } catch (error) {
            console.error("Error saving global settings:", error);
            showAlert('Failed to save settings. See console for details.', 'danger');
        }
    });
}

// --- Setup Tab Helper Functions ---
window. editFest=(festId) => { state.festToEdit = fests.find(f => f.id === festId); renderFestSetupTab(); }
window. clearFestEdit = () => { state.festToEdit = null; renderFestSetupTab(); }
window. editHouse = (houseId) => { state.houseToEdit = festHouses.find(h => h.id === houseId); renderFestSetupTab(); }
window. clearHouseEdit = () => { state.houseToEdit = null; renderFestSetupTab(); }


// =========================================================================
// --- 3. EVENTS TAB
// =========================================================================

function renderFestEventsTab() {
    const container = document.getElementById('fest-events');
    if (!container) return;

    // Create a list of categories: General + any defined in settings
    const dynamicCategories = ['General', ...(festSettings.ageCategories?.map(c => c.name) || [])];
    const festOptions = fests.map(f => `<option value="${f.id}" ${state.eventToEdit?.festId === f.id ? 'selected' : ''}>${f.name}</option>`).join('');

    container.innerHTML = `
    <div class="row g-4">
        <div class="col-lg-5">
            <div class="ui-card h-100">
                <h5 class="section-header"><i class="fas fa-calendar-plus me-2"></i>${state.eventToEdit ? 'Edit Event' : 'Add New Event'}</h5>
                <form id="event-form">
                    <div class="mb-3">
                        <label class="form-label">Fest</label>
                        <select id="event-fest" class="form-select" ${fests.length === 0 ? 'disabled' : ''}>
                            ${fests.length > 0 ? festOptions : '<option>Please create a fest first</option>'}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Event Name</label>
                        <input type="text" id="event-name" class="form-control" value="${state.eventToEdit?.name || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select id="event-category" class="form-select">${dynamicCategories.map(c => `<option value="${c}" ${state.eventToEdit?.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" id="event-is-group" class="form-check-input" ${state.eventToEdit?.isGroupEvent ? 'checked' : ''}>
                        <label class="form-check-label" for="event-is-group">Is Group Event?</label>
                    </div>
                    <div class="text-end">
                        ${state.eventToEdit ? `<button type="button" class="btn btn-secondary me-2" onclick="clearEventEdit()">Cancel</button>` : ''}
                        <button type="submit" class="btn btn-primary" ${fests.length === 0 ? 'disabled' : ''}>${state.eventToEdit ? 'Update Event' : 'Save Event'}</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="ui-card h-100">
                <h5 class="section-header"><i class="fas fa-tasks me-2"></i>Created Events</h5>
                <div id="events-list"></div>
            </div>
        </div>
    </div>`;

    renderEventsList();
    attachEventsTabListeners();
}


function attachEventsTabListeners() {
    document.getElementById('event-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('event-name').value.trim();
        if (!name) return showAlert('Event Name is required.', 'danger');

        const eventData = {
            id: state.eventToEdit?.id || `EVT_${Date.now()}`,
            festId: document.getElementById('event-fest').value,
            name,
            category: document.getElementById('event-category').value,
            isGroupEvent: document.getElementById('event-is-group').checked
        };
        
        try {
            await setDoc(getDocRef('festEvents', eventData.id), eventData);
            showAlert(`Event '${name}' saved successfully.`, 'success');
            clearEventEdit(); // Clears form and re-renders tab
        } catch (error) {
            console.error("Error saving event: ", error);
            showAlert('Failed to save event. See console for details.', 'danger');
        }
    });
}

// --- Events Tab Helper Functions ---
function editEvent(eventId) { state.eventToEdit = festEvents.find(e => e.id === eventId); renderFestEventsTab(); }
function clearEventEdit() { state.eventToEdit = null; renderFestEventsTab(); }

// =========================================================================
// --- 4. GENERIC DELETE FUNCTION --- (Improved)
// =========================================================================
async function deleteFestItem(collectionName, id, rerenderFunctionName) {
    // Add specific checks for cascading deletes if needed
    if (collectionName === 'fests') {
        if (festEvents.some(e => e.festId === id)) {
            return showAlert('Cannot delete fest. It has associated events.', 'danger');
        }
    }

    if (confirm(`Are you sure you want to delete this item? This action cannot be undone.`)) {
        try {
            await deleteDoc(getDocRef(collectionName, id));
            showAlert('Item deleted successfully.', 'success');
            
            // Clear any edit state related to the deleted item
            if (collectionName === 'fests' && state.festToEdit?.id === id) clearFestEdit();
            if (collectionName === 'festHouses' && state.houseToEdit?.id === id) clearHouseEdit();
            if (collectionName === 'festEvents' && state.eventToEdit?.id === id) clearEventEdit();
            
            // The Firestore listener will auto-update the data array,
            // so we just need to re-render the view.
            if (window[rerenderFunctionName]) {
                window[rerenderFunctionName]();
            }
        } catch (error) {
            console.error(`Error deleting item from ${collectionName}:`, error);
            showAlert('Failed to delete item. See console for details.', 'danger');
        }
    }
}

// =========================================================================
// --- 5. PARTICIPANTS TAB ---
// =========================================================================

function renderFestParticipantsTab() {
    const container = document.getElementById('fest-participants');
    if (!container) return;

    const festOptions = fests.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
    const classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

    container.innerHTML = `
        <div class="ui-card mb-4">
            <h5 class="section-header"><i class="fas fa-filter me-2"></i>Filter Participants</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Filter by Fest</label>
                    <select id="participant-fest-filter" class="form-select">${festOptions}</select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Filter by Class</label>
                    <select id="participant-class-filter" class="form-select">
                        <option value="">All Classes</option>
                        ${classOptions}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Search by Name / Admn No.</label>
                    <input type="text" id="participant-search-input" class="form-control" placeholder="Start typing to search...">
                </div>
                <div class="col-md-2 d-grid">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registrationModal">
                        <i class="fas fa-user-plus me-2"></i>Register
                    </button>
                </div>
            </div>
        </div>
        <div id="participants-table-container" class="ui-card"></div>

        <div class="modal fade" id="registrationModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Admin Registration</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <label>Search Student by Admission No.</label>
                        <input type="text" id="reg-modal-student-search" class="form-control" placeholder="Enter Admn No and press Enter">
                        <div id="reg-modal-student-info" class="p-3 bg-light rounded mt-3 d-none"></div>
                        <div id="reg-modal-form-body" class="d-none mt-3"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="reg-modal-save-btn" class="btn btn-success" disabled>Save Registration</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    attachParticipantsTabListeners();
    // Initial render of the table
    if (fests.length > 0) {
        renderParticipantsTable();
    }
}

function attachParticipantsTabListeners() {
    // Filters
    document.getElementById('participant-fest-filter')?.addEventListener('change', renderParticipantsTable);
    document.getElementById('participant-class-filter')?.addEventListener('change', renderParticipantsTable);
    document.getElementById('participant-search-input')?.addEventListener('input', renderParticipantsTable);

    // Student search in modal
    document.getElementById('reg-modal-student-search')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const admnNo = e.target.value.trim();
            const student = students.find(s => s.admissionNumber.toLowerCase() === admnNo.toLowerCase());
            const infoDiv = document.getElementById('reg-modal-student-info');
            const formBody = document.getElementById('reg-modal-form-body');
            const saveBtn = document.getElementById('reg-modal-save-btn');

            if (student && infoDiv && formBody && saveBtn) {
                const festId = document.getElementById('participant-fest-filter').value;
                const existingReg = festRegistrations.find(r => r.festId === festId && r.studentId === student.id);
                if (existingReg) {
                     infoDiv.innerHTML = `<span class="text-danger"><strong>${student.name}</strong> is already registered for this fest. Please edit their registration from the main table.</span>`;
                     formBody.classList.add('d-none');
                     saveBtn.disabled = true;
                } else {
                    infoDiv.innerHTML = `<strong>${student.name}</strong> | Class: ${getStudentClassName(student.classId, student.division)} | DOB: ${student.dob}`;
                    renderEventsInModal(festId, student);
                    formBody.classList.remove('d-none');
                    saveBtn.disabled = false;
                }
                infoDiv.classList.remove('d-none');
            } else if (infoDiv && formBody && saveBtn) {
                infoDiv.innerHTML = `<span class="text-danger">No student found with Admn No: ${admnNo}</span>`;
                infoDiv.classList.remove('d-none');
                formBody.classList.add('d-none');
                saveBtn.disabled = true;
            }
        }
    });
    
    // Save new registration
    document.getElementById('reg-modal-save-btn')?.addEventListener('click', async () => {
         const admnNo = document.getElementById('reg-modal-student-search').value.trim();
         const student = students.find(s => s.admissionNumber.toLowerCase() === admnNo.toLowerCase());
         const festId = document.getElementById('participant-fest-filter').value;
         const houseId = document.getElementById('reg-modal-house')?.value;
         const selectedEvents = Array.from(document.querySelectorAll('#reg-modal-form-body .event-checkbox:checked')).map(cb => cb.value);

         if (!student || !houseId || !festId) {
             return showAlert('A valid student, fest, and house are required.', 'danger');
         }

         const regId = `${festId}_${student.id}`;
         const regData = {
             id: regId,
             festId,
             studentId: student.id,
             studentName: student.name,
             houseId,
             events: selectedEvents
         };

         try {
             await setDoc(getDocRef('festRegistrations', regId), regData);
             showAlert('Registration saved successfully!', 'success');
             const modalInstance = bootstrap.Modal.getInstance(document.getElementById('registrationModal'));
             if (modalInstance) modalInstance.hide();
             // The listener will auto-update and re-render the table
         } catch (error) {
             console.error("Error saving registration:", error);
             showAlert('Failed to save registration.', 'danger');
         }
    });

    // Reset modal on close
    document.getElementById('registrationModal')?.addEventListener('hidden.bs.modal', () => {
        document.getElementById('reg-modal-student-search').value = '';
        document.getElementById('reg-modal-student-info').classList.add('d-none');
        document.getElementById('reg-modal-form-body').classList.add('d-none');
        document.getElementById('reg-modal-save-btn').disabled = true;
    });
}

function renderEventsInModal(festId, student, existingReg = null) {
    const container = document.getElementById(existingReg ? 'edit-form-content' : 'reg-modal-form-body');
    if (!container) return;

    const studentCategory = getStudentAgeCategory(student.dob);
    const registeredEventIds = existingReg?.events || [];
    const maxEvents = festSettings.maxEventsPerStudent;
    const limits = festSettings.houseEventLimits;

    // Filter events that are either 'General' or match the student's specific age category
    const availableEvents = festEvents.filter(e => e.festId === festId && (e.category === 'General' || e.category === studentCategory));
    
    const selectedHouseId = existingReg?.houseId || festHouses[0]?.id || '';

    container.innerHTML = `
        <p class="mb-2"><strong>Student's Age Category:</strong> <span class="badge bg-info fs-6">${studentCategory}</span></p>
        <div class="mb-3">
            <label class="form-label">Assign House</label>
            <select id="reg-modal-house" class="form-select">
                ${festHouses.map(h => `<option value="${h.id}" ${h.id === selectedHouseId ? 'selected' : ''}>${h.name}</option>`).join('')}
            </select>
        </div>
        <hr>
        <h6>Select Events (Registered: <span id="event-count">${registeredEventIds.length}</span> / ${maxEvents})</h6>
        <div class="row g-3">
            ${availableEvents.length > 0 ? availableEvents.map(event => {
                const eventRegistrationsForHouse = festRegistrations.filter(r => r.festId === festId && r.houseId === selectedHouseId && r.events.includes(event.id));
                const countInHouse = eventRegistrationsForHouse.length;
                const limit = event.isGroupEvent ? limits.group : limits.solo;
                const isChecked = registeredEventIds.includes(event.id);
                // The house limit is full for this event, AND the current student is NOT the one registered
                const houseLimitReached = countInHouse >= limit && !eventRegistrationsForHouse.some(r => r.studentId === student.id);
                // Total event limit for the student is reached, and this event is not already checked
                const studentEventLimitReached = registeredEventIds.length >= maxEvents && !isChecked;

                const isDisabled = houseLimitReached || studentEventLimitReached;

                return `<div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input event-checkbox" type="checkbox" value="${event.id}" id="evt-check-${event.id}" ${isChecked ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                        <label class="form-check-label ${isDisabled ? 'text-muted' : ''}" for="evt-check-${event.id}">
                            ${event.name}
                            <span class="badge bg-light text-dark ms-2">${countInHouse}/${limit} in house</span>
                        </label>
                    </div>
                </div>`;
            }).join('') : '<p class="text-muted">No eligible events found for this student\'s category in the selected fest.</p>'}
        </div>`;

    // Re-attach listener for house change to re-render this form
    document.getElementById('reg-modal-house').addEventListener('change', () => {
        const updatedRegData = existingReg ? {...existingReg, houseId: document.getElementById('reg-modal-house').value} : null;
        renderEventsInModal(festId, student, updatedRegData);
    });
}


function renderParticipantsTable() {
    const container = document.getElementById('participants-table-container');
    // Guard Clause: If the main container for the table doesn't exist, stop.
    if (!container) return;

    // Get filter elements
    const festFilter = document.getElementById('participant-fest-filter');
    const classFilter = document.getElementById('participant-class-filter');
    const searchInput = document.getElementById('participant-search-input');

    // *** FIX FOR TypeError ***
    // Guard Clause: If any filter element is not yet on the page, stop execution.
    // This prevents errors if this function is called before the DOM is fully rendered.
    if (!festFilter || !classFilter || !searchInput) {
        return;
    }

    const festId = festFilter.value;
    const classId = classFilter.value;
    const searchTerm = searchInput.value.toLowerCase();


    let registrations = festRegistrations.filter(r => r.festId === festId);

    if (classId) {
        const studentIdsInClass = students.filter(s => s.classId === classId).map(s => s.id);
        registrations = registrations.filter(r => studentIdsInClass.includes(r.studentId));
    }

    if (searchTerm) {
        registrations = registrations.filter(r => {
            const student = students.find(s => s.id === r.studentId);
            return student && (student.name.toLowerCase().includes(searchTerm) || student.admissionNumber.toLowerCase().includes(searchTerm));
        });
    }

    if (registrations.length === 0) {
        container.innerHTML = '<h5 class="section-header"><i class="fas fa-users me-2"></i>Registered Participants (0)</h5><p class="text-muted text-center p-5">No participants found for the selected filters.</p>';
        return;
    }
    
    const tableRows = registrations.map(reg => {
        const student = students.find(s => s.id === reg.studentId);
        const house = festHouses.find(h => h.id === reg.houseId);
        const eventDetails = reg.events.map(eventId => {
             const event = festEvents.find(e => e.id === eventId);
             return event?.name || 'Unknown Event';
        }).join(', ');

        return `
            <tr>
                <td><strong>${student?.name || 'Unknown'}</strong><br><small class="text-muted">${student?.admissionNumber || 'N/A'}</small></td>
                <td>${getStudentClassName(student?.classId, student?.division)}</td>
                <td style="color:${house?.color};"><strong>${house?.name || 'N/A'}</strong></td>
                <td><small>${eventDetails || 'No events'}</small></td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-primary" onclick="openEditRegistrationModal('${reg.id}')">
                        <i class="fas fa-edit me-1"></i>Edit
                    </button>
                </td>
            </tr>`;
    }).join('');

    container.innerHTML = `
        <h5 class="section-header"><i class="fas fa-users me-2"></i>Registered Participants (${registrations.length})</h5>
        <div class="table-responsive">
            <table class="table table-sm table-striped table-hover">
                <thead><tr><th>Student Name</th><th>Class</th><th>House</th><th>Registered Events</th><th class="text-end">Actions</th></tr></thead>
                <tbody>${tableRows}</tbody>
            </table>
        </div>`;
}






// --- Participants Edit/Delete Functions ---
window. openEditRegistrationModal = (registrationId) => {
    const registration = festRegistrations.find(r => r.id === registrationId);
    if (!registration) return showAlert('Could not find registration to edit.', 'danger');

    const student = students.find(s => s.id === registration.studentId);
    if (!student) return showAlert('Could not find student for this registration.', 'danger');
    
    state.registrationToEdit = registration;

    const modalBody = document.getElementById('edit-modal-body');
    modalBody.innerHTML = `
        <p><strong>Editing for:</strong> ${student.name} (${student.admissionNumber})</p>
        <div id="edit-form-content"></div>`;
    
    renderEventsInModal(registration.festId, student, registration);

    // Attach listeners to modal buttons
    document.getElementById('edit-modal-save-btn').onclick = saveEditedRegistration;
    document.getElementById('edit-modal-delete-btn').onclick = deleteRegistration;

    const editModal = new bootstrap.Modal(document.getElementById('editRegistrationModal'));
    editModal.show();
}

async function saveEditedRegistration() {
    if (!state.registrationToEdit) return;

    const houseId = document.getElementById('reg-modal-house')?.value;
    const selectedEvents = Array.from(document.querySelectorAll('#edit-form-content .event-checkbox:checked')).map(cb => cb.value);

    const updatedRegData = { ...state.registrationToEdit, houseId, events: selectedEvents };

    try {
        await setDoc(getDocRef('festRegistrations', state.registrationToEdit.id), updatedRegData);
        showAlert('Registration updated successfully!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editRegistrationModal')).hide();
        state.registrationToEdit = null;
    } catch (error) {
        console.error("Error updating registration:", error);
        showAlert('Failed to update registration.', 'danger');
    }
}

async function deleteRegistration() {
    if (!state.registrationToEdit) return;

    if (confirm('Are you sure you want to delete this entire registration? This cannot be undone.')) {
        try {
            await deleteDoc(getDocRef('festRegistrations', state.registrationToEdit.id));
            showAlert('Registration deleted successfully.', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editRegistrationModal')).hide();
            state.registrationToEdit = null;
        } catch (error) {
            console.error("Error deleting registration:", error);
            showAlert('Failed to delete registration.', 'danger');
        }
    }
}


// =========================================================================
// --- 6. SCORE ENTRY TAB ---
// =========================================================================

function renderFestScoringTab() {
    const container = document.getElementById('fest-scoring');
    if (!container) return;

    container.innerHTML = `
        <div class="ui-card">
            <h5 class="section-header"><i class="fas fa-marker"></i> Enter Scores</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label">1. Select Fest</label>
                    <select id="scoring-fest" class="form-select">${fests.map(f => `<option value="${f.id}">${f.name}</option>`).join('')}</select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">2. Select Event</label>
                    <select id="scoring-event" class="form-select" disabled><option>-- Select a fest first --</option></select>
                </div>
            </div>
        </div>
        <div id="scoring-sheet-container" class="mt-4 ui-card">
             <p class="text-muted p-4 text-center">Please select a fest and an event to enter scores.</p>
        </div>`;

    attachScoringTabListeners();
    // Trigger initial population of the event dropdown
    if (fests.length > 0) {
         document.getElementById('scoring-fest').dispatchEvent(new Event('change'));
    }
}

function attachScoringTabListeners() {
    const festSelect = document.getElementById('scoring-fest');
    const eventSelect = document.getElementById('scoring-event');

    festSelect?.addEventListener('change', () => {
        const festId = festSelect.value;
        // Filter events for the selected fest and sort them alphabetically
        const eventsForFest = festEvents
            .filter(e => e.festId === festId)
            .sort((a, b) => a.name.localeCompare(b.name));
        
        if (eventSelect) {
            if (eventsForFest.length > 0) {
                eventSelect.innerHTML = '<option value="">-- Select an event --</option>';
                eventSelect.innerHTML += eventsForFest.map(e => `<option value="${e.id}">${e.name} (${e.category})</option>`).join('');
                eventSelect.disabled = false;
            } else {
                eventSelect.innerHTML = '<option>-- No events for this fest --</option>';
                eventSelect.disabled = true;
            }
        }
        // Clear the scoring sheet
        document.getElementById('scoring-sheet-container').innerHTML = '<p class="text-muted p-4 text-center">Please select an event.</p>';
    });

    eventSelect?.addEventListener('change', () => {
        const festId = festSelect.value;
        const eventId = eventSelect.value;
        if (eventId) {
            renderScoringSheet(festId, eventId);
        }
    });
}

function renderScoringSheet(festId, eventId) {
    const container = document.getElementById('scoring-sheet-container');
    const event = festEvents.find(e => e.id === eventId);
    if (!container || !event) return;

    // Find all registrations for this specific event
    const participants = festRegistrations.filter(r => r.festId === festId && r.events.includes(eventId));

    if (participants.length === 0) {
        container.innerHTML = `<h5 class="section-header text-warning"><i class="fas fa-exclamation-triangle"></i> No Participants</h5><p class="alert alert-warning">No students are registered for this event.</p>`;
        return;
    }

    const existingResult = festResults.find(r => r.id === `${festId}_${eventId}`);

    container.innerHTML = `
        <h5 class="section-header"><i class="fas fa-clipboard-check"></i> Score Entry: ${event.name}</h5>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Student Name</th>
                        <th>House</th>
                        <th>Points Awarded</th>
                    </tr>
                </thead>
                <tbody>
                    ${participants.map(p => {
                        const student = students.find(s => s.id === p.studentId);
                        const house = festHouses.find(h => h.id === p.houseId);
                        const savedPoints = existingResult?.results.find(res => res.studentId === p.studentId)?.points || '';
                        return `
                            <tr data-studentid="${p.studentId}">
                                <td>${student?.name || 'Unknown'}</td>
                                <td>${house?.name || 'N/A'}</td>
                                <td><input type="number" class="form-control form-control-sm score-points-input" value="${savedPoints}" min="0"></td>
                            </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>
        <div class="text-end mt-3">
            <button class="btn btn-success" onclick="saveEventScores('${festId}', '${eventId}')">
                <i class="fas fa-save me-2"></i>Save Scores
            </button>
        </div>`;
}

window. saveEventScores = (festId, eventId) => {
    const resultsWithPoints = [];
    document.querySelectorAll('#scoring-sheet-container tr[data-studentid]').forEach(row => {
        const studentId = row.dataset.studentid;
        const pointsInput = row.querySelector('.score-points-input');
        const points = parseInt(pointsInput.value) || 0;
        if (points > 0) {
            resultsWithPoints.push({ studentId, points });
        }
    });

    resultsWithPoints.sort((a, b) => b.points - a.points);
    
    const finalResults = resultsWithPoints.map((result, index, arr) => {
        const position = (index > 0 && result.points === arr[index - 1].points) 
            ? finalResults[index - 1].position
            : index + 1;
        return { ...result, position };
    });

    const resultId = `${festId}_${eventId}`;
    const resultData = { id: resultId, festId, eventId, results: finalResults };

    try {
         setDoc(getDocRef('festResults', resultId), resultData);
        showAlert('Scores saved successfully!', 'success');
        renderEventsList(); 
        if(document.getElementById('live-scoreboard-wrapper')) {
            displayLiveScoreboard(festId);
        }
    } catch (error) {
        console.error("Error saving scores:", error);
        showAlert('Failed to save scores.', 'danger');
    }
}






// =========================================================================
// --- 7. MODIFICATION FOR PENDING RESULTS ---
// =========================================================================
// Modify renderEventsList() to include the status badge

function renderEventsList() { // OVERRIDE the previous function
    const container = document.getElementById('events-list');
    if (!container) return;

    if (festEvents.length === 0) {
        container.innerHTML = '<p class="text-muted text-center p-5">No events created yet.</p>';
        return;
    }
    
    const eventsByFest = festEvents.reduce((acc, event) => {
        (acc[event.festId] = acc[event.festId] || []).push(event);
        return acc;
    }, {});

    let html = '';
    for (const festId in eventsByFest) {
        const fest = fests.find(f => f.id === festId);
        html += `<h6 class="mt-4 text-primary"><strong>${fest?.name || 'Unknown Fest'}</strong></h6>
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>Event Name</th>
                        <th>Category</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${eventsByFest[festId].sort((a,b) => a.name.localeCompare(b.name)).map(event => {
                        // Check if results exist for this event
                        const resultsExist = festResults.some(r => r.eventId === event.id);
                        const statusBadge = resultsExist 
                            ? `<span class="badge bg-success">Results Entered</span>`
                            : `<span class="badge bg-warning text-dark">Results Pending</span>`;

                        return `
                        <tr>
                            <td><strong>${event.name}</strong></td>
                            <td><span class="badge bg-secondary">${event.category}</span></td>
                            <td><span class="badge bg-info">${event.isGroupEvent ? 'Group' : 'Solo'}</span></td>
                            <td>${statusBadge}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1" onclick="editEvent('${event.id}')" title="Edit"><i class="fas fa-edit fa-xs"></i></button>
                                <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="deleteFestItem('festEvents', '${event.id}', 'renderFestEventsTab')" title="Delete"><i class="fas fa-trash fa-xs"></i></button>
                            </td>
                        </tr>`
                    }).join('')}
                </tbody>
            </table>
        </div>`;
    }
    container.innerHTML = html;
}

function getStudentAgeCategory(studentDob) {
    if (!studentDob || !festSettings.ageCategories || festSettings.ageCategories.length === 0) {
        return 'General';
    }
    const dob = new Date(studentDob);
    // The categories should already be sorted from youngest to oldest (latest bornAfterDate to earliest)
    const sortedCategories = festSettings.ageCategories;

    for (const category of sortedCategories) {
        if (dob >= new Date(category.bornAfterDate)) {
            return category.name;
        }
    }
    // If the student is older than all defined categories, you might have a default "Seniors" category
    // or return the last category name as a fallback.
    return 'General'; // Default fallback
}


function getStudentClassName(classId, division) {
    if (!classId) return 'N/A';
    const classInfo = classes.find(c => c.id === classId);
    return classInfo ? `${classInfo.name}-${division}` : 'N/A';
}



// =========================================================================
// --- 7. FINAL RESULTS TAB (with all missing function definitions) ---
// =========================================================================

// Global timers for the scoreboard animations
let categoryCarouselTimer = null;
let latestResultTimer = null;

function renderFestFinalResultsTab() {
    const container = document.getElementById('fest-final-results');
    if (!container) return;

    container.innerHTML = `
        <div class="ui-card">
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label">Select Fest to View</label>
                    <select id="final-results-fest" class="form-select">${fests.map(f => `<option value="${f.id}">${f.name}</option>`).join('')}</select>
                </div>
            </div>
        </div>
        <div id="live-scoreboard-wrapper" class="mt-4"></div>`;
    
    const festSelect = document.getElementById('final-results-fest');
    if (festSelect) {
        festSelect.addEventListener('change', (e) => displayLiveScoreboard(e.target.value));
        if (fests.length > 0) {
            // Automatically display the scoreboard for the first fest
            displayLiveScoreboard(festSelect.value);
        }
    }
}

function displayLiveScoreboard(festId) {
    // Clear any existing animation timers to prevent memory leaks
    if (categoryCarouselTimer) clearInterval(categoryCarouselTimer);
    if (latestResultTimer) clearInterval(latestResultTimer);

    const container = document.getElementById('live-scoreboard-wrapper');
    if (!container) return;

    container.innerHTML = `
        <div id="final-results-container">
            <h2 class="live-header mb-4"><span class="live-dot me-3"></span>Live Scoreboard<span class="live-dot ms-3"></span></h2>
            <div class="row g-4">
                <div class="col-lg-5"><div class="house-ranking-container" style="position: relative; min-height: 450px;"><ul class="house-ranking-list"></ul></div></div>
                <div class="col-lg-7">
                    <div class="category-breakdown-container mb-4"></div>
                    <div class="latest-result-container"></div>
                </div>
            </div>
        </div>`;
    
    updateHouseRankings(festId);
    startCategoryCarousel(festId);
    startLatestResultsTicker(festId);
}

function updateHouseRankings(festId) {
    const { housePoints } = calculateFinalResults(festId);
    const sortedHouses = Object.entries(housePoints).sort(([, a], [, b]) => b - a);
    const list = document.querySelector('.house-ranking-list');
    if (!list) return;

    const itemHeight = 82; // Height of each rank item for positioning
    list.innerHTML = sortedHouses.map(([houseId, points], index) => {
        const house = festHouses.find(h => h.id === houseId);
        return `
            <li class="house-rank-item" style="top: ${index * itemHeight}px;">
                <div class="house-rank-position">${index + 1}</div>
                <div class="house-rank-color" style="background-color: ${house?.color || '#ccc'};"></div>
                <div class="house-rank-name">${house?.name || 'Unknown'}</div>
                <div class="house-rank-points">${points}</div>
            </li>`;
    }).join('');
}

function startCategoryCarousel(festId) {
    const container = document.querySelector('.category-breakdown-container');
    if (!container) return;
    const categories = ['General', ...festSettings.ageCategories.map(c => c.name)];
    if(categories.length === 0) return;

    let currentCategoryIndex = 0;
    const displayCategory = () => {
        if(!container) { clearInterval(categoryCarouselTimer); return; }
        container.style.opacity = 0;
        setTimeout(() => {
            const categoryName = categories[currentCategoryIndex];
            const { eventBreakdown } = calculateFinalResults(festId);
            const categoryEvents = eventBreakdown[categoryName] || {};
            container.innerHTML = `
                <h3 class="category-breakdown-title">${categoryName} - Point Breakdown</h3>
                <div class="event-point-grid">
                    ${Object.entries(categoryEvents).map(([eventName, houses]) => `
                        <div class="event-point-item">
                            <div class="event-name">${eventName}</div>
                            <div class="house-points">
                                ${Object.entries(houses).map(([houseId, points]) => `<div title="${festHouses.find(h=>h.id===houseId)?.name}: ${points} pts" class="house-dot" style="background:${festHouses.find(h=>h.id===houseId)?.color};"></div>`).join('')}
                            </div>
                        </div>`).join('') || '<p class="text-muted">No results yet for this category.</p>'}
                </div>`;
            container.style.opacity = 1;
            currentCategoryIndex = (currentCategoryIndex + 1) % categories.length;
        }, 500); // 500ms for fade out
    };
    displayCategory();
    categoryCarouselTimer = setInterval(displayCategory, 8000); // Change category every 8 seconds
}

function startLatestResultsTicker(festId) {
    const container = document.querySelector('.latest-result-container');
    if (!container) return;

    const allWinners = [];
    festResults.filter(r => r.festId === festId).forEach(result => {
        const event = festEvents.find(e => e.id === result.eventId);
        result.results.forEach(winner => {
            if (winner.position <= 3) { // Only show top 3 positions
                 const student = students.find(s => s.id === winner.studentId);
                 if (student) allWinners.push({ ...winner, student, eventName: event?.name });
            }
        });
    });

    if (allWinners.length === 0) {
        container.innerHTML = `<h3 class="latest-result-title">Latest Results</h3><p class="text-muted">Waiting for first result...</p>`;
        return;
    }

    let currentResultIndex = 0;
    const displayResult = () => {
        if(!container) { clearInterval(latestResultTimer); return; }
        container.style.opacity = 0;
        setTimeout(() => {
            const winner = allWinners[currentResultIndex];
            const positionBadges = {1: 'badge-gold', 2: 'badge-silver', 3: 'badge-bronze'};
            const positionText = {1: '1st Place', 2: '2nd Place', 3: '3rd Place'};
            container.innerHTML = `
                <h3 class="latest-result-title">Latest Results</h3>
                <div class="latest-result-card">
                    <div class="latest-result-info">
                        <h4>${winner.student.name}</h4>
                        <p>${winner.eventName}</p>
                    </div>
                    <div class="latest-result-badge ${positionBadges[winner.position] || 'bg-secondary'}">
                        ${positionText[winner.position] || `${winner.position}th`}
                    </div>
                </div>`;
            container.style.opacity = 1;
            currentResultIndex = (currentResultIndex + 1) % allWinners.length;
        }, 500);
    };
    displayResult();
    latestResultTimer = setInterval(displayResult, 6000); // Change result every 6 seconds
}

function calculateFinalResults(festId) {
    const housePoints = {};
    festHouses.forEach(h => housePoints[h.id] = 0);
    const individualPoints = {};
    const eventBreakdown = {};

    const relevantResults = festResults.filter(r => r.festId === festId);

    for (const result of relevantResults) {
        const event = festEvents.find(e => e.id === result.eventId);
        if (!event) continue;

        if (!eventBreakdown[event.category]) eventBreakdown[event.category] = {};
        if (!eventBreakdown[event.category][event.name]) eventBreakdown[event.category][event.name] = {};

        for (const standing of result.results) {
            if (standing.points > 0) {
                const registration = festRegistrations.find(r => r.festId === festId && r.studentId === standing.studentId);
                if (registration?.houseId) {
                    housePoints[registration.houseId] = (housePoints[registration.houseId] || 0) + standing.points;
                    eventBreakdown[event.category][event.name][registration.houseId] = (eventBreakdown[event.category][event.name][registration.houseId] || 0) + standing.points;
                }
            }
        }
    }
    return { housePoints, individualPoints, eventBreakdown };
}

window.renderFestRegistration = () => {
    if (!selectedUser.classCharge) {
        mainContent.innerHTML = `<h1 class="h2 mb-4">Fest Registration</h1><p class="text-warning">You are not assigned as a class teacher.</p>`;
        return;
    }

    // Filter fests to show only those with registrationOpen = true
    const openFests = fests.filter(f => f.registrationOpen === true);

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Fest Registration</h1>
        ${openFests.length === 0 ? `
            <div class="alert alert-info">There are no fests currently open for registration.</div>
        ` : `
            <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label">Select Fest</label>
                    <select id="reg-fest" class="form-select">
                        ${openFests.map(f => `<option value="${f.id}">${f.name}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Select Student</label>
                    <select id="reg-student" class="form-select"></select>
                </div>
            </div>
            <div id="registration-form"></div>
        `}
    `;

    // Only attach listeners if there are open fests
    if (openFests.length > 0) {
        attachRegistrationListeners();
    }
}

function attachRegistrationListeners() {
    const festSelect = document.getElementById('reg-fest');
    const studentSelect = document.getElementById('reg-student');
    const { classId, division } = selectedUser.classCharge;

    // Populate the student dropdown with students from the teacher's class
    const studentsInClass = students.filter(s => s.classId === classId && s.division === division);
    studentSelect.innerHTML = '<option value="">-- Select a student --</option>';
    studentSelect.innerHTML += studentsInClass.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

    // When either the fest or the student changes, re-render the registration form
    festSelect?.addEventListener('change', () => {
        renderRegistrationForm(festSelect.value, studentSelect.value);
    });
    studentSelect?.addEventListener('change', () => {
        renderRegistrationForm(festSelect.value, studentSelect.value);
    });

    // Initial render
    renderRegistrationForm(festSelect.value, studentSelect.value);
}

/**
 * Renders the form showing available events for a selected student.
 * @param {string} festId The ID of the selected fest.
 * @param {string} studentId The ID of the selected student.
 */
function renderRegistrationForm(festId, studentId) {
    const container = document.getElementById('registration-form');
    if (!festId || !studentId) {
        container.innerHTML = '<p class="text-muted text-center p-5">Please select a fest and a student to continue.</p>';
        return;
    }

    const student = students.find(s => s.id === studentId);
    const fest = fests.find(f => f.id === festId);
    if (!student || !fest) return;

    // Find events that match the student's category (e.g., 'UP', 'HS') and the fest type
    const studentCategory = classes.find(c => c.id === student.classId)?.name.includes('UP') ? 'UP'
        : classes.find(c => c.id === student.classId)?.name.includes('HS') ? 'HS'
        : classes.find(c => c.id === student.classId)?.name.includes('HSS') ? 'HSS'
        : 'LP'; // A simple categorization logic

    const availableEvents = festEvents.filter(e =>
        e.festId === festId &&
        (e.category === studentCategory || e.category === 'General')
    );

    const registration = festRegistrations.find(r => r.id === `${festId}_${studentId}`);
    const registeredEventIds = registration?.events || [];
    const maxEvents = festSettings.maxEventsPerStudent || 3;

    container.innerHTML = `
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between">
                <span>Registering: <strong>${student.name}</strong></span>
                <span>Events Registered: <strong>${registeredEventIds.length} / ${maxEvents}</strong></span>
            </div>
            <div class="card-body">
                <form id="student-reg-form">
                    <div class="row">
                        ${availableEvents.map(event => `
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input event-checkbox" type="checkbox" value="${event.id}" 
                                           id="event-${event.id}" ${registeredEventIds.includes(event.id) ? 'checked' : ''}>
                                    <label class="form-check-label" for="event-${event.id}">
                                        ${event.name} <span class="badge bg-secondary">${event.isGroupEvent ? 'Group' : 'Solo'}</span>
                                    </label>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="text-end mt-4 border-top pt-3">
                        <button type="submit" class="btn btn-success">Save Registration</button>
                    </div>
                </form>
            </div>
        </div>
    `;

    // Add listener to the new form
    document.getElementById('student-reg-form').addEventListener('submit', (e) => {
        e.preventDefault();
        saveStudentRegistration(festId, student.id, student.name);
    });

    // Add listener to checkboxes to enforce max event limit
    const checkboxes = document.querySelectorAll('.event-checkbox');
    checkboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            const checkedCount = document.querySelectorAll('.event-checkbox:checked').length;
            if (checkedCount >= maxEvents) {
                checkboxes.forEach(c => {
                    if (!c.checked) c.disabled = true;
                });
            } else {
                checkboxes.forEach(c => c.disabled = false);
            }
        });
        // Trigger event once on load to set initial state
        cb.dispatchEvent(new Event('change'));
    });
}


/**
 * Saves the student's event registrations to Firestore.
 * @param {string} festId
 * @param {string} studentId
 * @param {string} studentName
 */
async function saveStudentRegistration(festId, studentId, studentName) {
    const selectedEvents = Array.from(document.querySelectorAll('.event-checkbox:checked')).map(cb => cb.value);
    const student = students.find(s => s.id === studentId);
    
    // Find house ID based on student's house name (assuming student object has a 'house' property)
    const house = festHouses.find(h => h.name === student?.house);

    const registrationData = {
        id: `${festId}_${studentId}`,
        festId: festId,
        studentId: studentId,
        studentName: studentName,
        houseId: house?.id || null, // Save the house ID
        events: selectedEvents,
        chestNo: festRegistrations.find(r => r.id === `${festId}_${studentId}`)?.chestNo || null // Preserve existing chest no
    };

    try {
        await setDoc(getDocRef('festRegistrations', registrationData.id), registrationData);
        showAlert('Registration saved successfully!', 'success');
        // Re-render the form to show the updated count
        renderRegistrationForm(festId, studentId);
    } catch (error) {
        console.error("Error saving registration:", error);
        showAlert('Failed to save registration.', 'danger');
    }
}


window.renderMyFestEvents = () => {
    mainContent.innerHTML = `
        <h1 class="h2 mb-4">My Fest Participation</h1>
        <div class="card shadow">
            <div class="card-body">
                <div class="mb-4">
                    <label for="my-fest-select" class="form-label">Select a Fest to View Your Details:</label>
                    <select id="my-fest-select" class="form-select">
                        ${fests.map(f => `<option value="${f.id}">${f.name}</option>`).join('')}
                    </select>
                </div>
                <div id="my-events-list-container">
                    </div>
            </div>
        </div>
    `;

    const festSelect = document.getElementById('my-fest-select');
    festSelect.addEventListener('change', () => renderMyEventsList());

    // Initial render for the default selected fest
    renderMyEventsList();
}

/**
 * Renders the list of events a student is registered for in a selected fest.
 * This is a helper function called by renderMyFestEvents.
 */
function renderMyEventsList() {
    const container = document.getElementById('my-events-list-container');
    const festSelect = document.getElementById('my-fest-select');
    const festId = festSelect.value;

    if (!festId) {
        container.innerHTML = '<p class="text-muted">Please select a fest.</p>';
        return;
    }

    // Find the student's registration document for the selected fest
    const registration = festRegistrations.find(r => r.festId === festId && r.studentId === selectedUser.id);

    if (!registration || registration.events.length === 0) {
        container.innerHTML = '<p class="alert alert-info">You are not registered for any events in this fest.</p>';
        return;
    }

    // Get the full details for each registered event
    const registeredEvents = registration.events.map(eventId => {
        return festEvents.find(e => e.id === eventId);
    }).filter(Boolean); // Filter out any undefined events

    container.innerHTML = `
        <div class="text-center mb-4">
            <h5 class="text-muted">Your Chest Number</h5>
            <span class="badge bg-primary p-3 fs-2">${registration.chestNo || "Not Assigned"}</span>
        </div>
        <h5 class="mt-4">You are registered for the following events:</h5>
        <ul class="list-group">
            ${registeredEvents.map(event => `
                <li class="list-group-item">
                    <strong>${event.name}</strong>
                    <span class="badge bg-info float-end">${event.category}</span>
                </li>
            `).join('')}
        </ul>
    `;
}








    window.renderTimetableManagement = () => {
    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Timetable Management</h1>
        <div class="card shadow">
            <div class="card-body">
                <div classs="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Class</label>
                        <select id="timetable-class" class="form-select">
                            <option value="">-- Select Class --</option>
                            ${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Division</label>
                        <select id="timetable-division" class="form-select" disabled></select>
                    </div>
                </div>
                <div id="timetable-grid-container" class="mt-4"></div>
            </div>
        </div>`;
    attachTimetableListeners();
};

function attachTimetableListeners() {
    const classSelect = document.getElementById('timetable-class');
    const divisionSelect = document.getElementById('timetable-division');

    classSelect.addEventListener('change', () => {
        const selectedClass = classes.find(c => c.id === classSelect.value);
        divisionSelect.innerHTML = '<option value="">-- Select Division --</option>';
        if (selectedClass) {
            divisionSelect.disabled = false;
            divisionSelect.innerHTML += selectedClass.divisions.map(d => `<option value="${d}">${d}</option>`).join('');
        } else {
            divisionSelect.disabled = true;
        }
    });

    divisionSelect.addEventListener('change', () => {
        if (classSelect.value && divisionSelect.value) {
            renderTimetableGrid(classSelect.value, divisionSelect.value);
        }
    });
}

function renderTimetableGrid(classId, division) {
    const container = document.getElementById('timetable-grid-container');
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const periods = Array.from({ length: 8 }, (_, i) => i + 1);
    const allocatedSubjects = classroomSubjects.filter(cs => cs.classId === classId && cs.division === division)
        .map(cs => ({ ...cs, subjectName: subjects.find(s => s.id === cs.subjectId)?.name || 'N/A' }));

    let gridHTML = `<table class="table table-bordered text-center">
                        <thead><tr><th>Day</th>${periods.map(p => `<th>Period ${p}</th>`).join('')}</tr></thead>
                        <tbody>`;

    days.forEach(day => {
        gridHTML += `<tr><td class="fw-bold">${day}</td>`;
        periods.forEach(period => {
            gridHTML += `<td>
                            <select class="form-select form-select-sm timetable-period-select" data-day="${day}" data-period="${period}">
                                <option value="">-</option>
                                ${allocatedSubjects.map(s => `<option value="${s.subjectId}">${s.subjectName}</option>`).join('')}
                            </select>
                         </td>`;
        });
        gridHTML += `</tr>`;
    });

    gridHTML += `</tbody></table>
                 <div class="text-end mt-3">
                    <button id="save-timetable-btn" class="btn btn-primary">Save Timetable</button>
                 </div>`;
    container.innerHTML = gridHTML;
}

document.getElementById('save-timetable-btn')?.addEventListener('click', async () => {
    const classId = document.getElementById('timetable-class').value;
    const division = document.getElementById('timetable-division').value;
    const timetableId = `${classId}_${division}`;
    const schedule = {};

    document.querySelectorAll('.timetable-period-select').forEach(select => {
        const day = select.dataset.day;
        const period = select.dataset.period;
        if (!schedule[day]) schedule[day] = {};
        schedule[day][period] = select.value;
    });

    try {
        await setDoc(getDocRef('timetables', timetableId), { schedule });
        showAlert('Timetable saved successfully!', 'success');
    } catch (error) {
        showAlert('Failed to save timetable.', 'danger');
    }
});

    
window.renderClassTimetableView = async () => {
    let classId, division;
    if (currentUserRole === 'student') {
        classId = selectedUser.classId;
        division = selectedUser.division;
    } else if (currentUserRole === 'teacher' && selectedUser.classCharge) {
        classId = selectedUser.classCharge.classId;
        division = selectedUser.classCharge.division;
    }

    if (!classId || !division) {
        mainContent.innerHTML = '<p>Timetable not available.</p>';
        return;
    }

    const timetableId = `${classId}_${division}`;
    const timetableDoc = await getDoc(getDocRef('timetables', timetableId));
    const timetableData = timetableDoc.exists() ? timetableDoc.data().schedule : {};

    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const periods = Array.from({ length: 8 }, (_, i) => i + 1);

    let tableHTML = `<h1 class="h2 mb-4">Class Timetable</h1>
                     <div class="table-responsive">
                        <table class="table table-bordered text-center">
                            <thead><tr><th>Day</th>${periods.map(p => `<th>Period ${p}</th>`).join('')}</tr></thead>
                            <tbody>`;
    days.forEach(day => {
        tableHTML += `<tr><td class="fw-bold">${day}</td>`;
        periods.forEach(period => {
            const subjectId = timetableData[day]?.[period] || '';
            const subjectName = subjects.find(s => s.id === subjectId)?.name || '-';
            tableHTML += `<td>${subjectName}</td>`;
        });
        tableHTML += `</tr>`;
    });
    tableHTML += `      </tbody>
                     </table>
                    </div>`;
    mainContent.innerHTML = tableHTML;
};



function saveFormToLocalStorage(formId) {
    const form = document.getElementById(formId);
    if (!form || !currentUserRole) return;

    const formData = {};
    for (const element of form.elements) {
        if (element.id) {
            if (element.type === 'checkbox') {
                formData[element.id] = element.checked;
            } else if (element.type !== 'submit' && element.type !== 'button') {
                formData[element.id] = element.value;
            }
        }
    }
    // We prefix the key with the user's role and form ID to keep data separate
    const storageKey = `formData_${currentUserRole}_${formId}`;
    localStorage.setItem(storageKey, JSON.stringify(formData));
}

/**
 * Loads and populates a form with data from localStorage.
 * @param {string} formId The ID of the form to load.
 */
window. loadFormFromLocalStorage = (formId) =>{
    const form = document.getElementById(formId);
    const storageKey = `formData_${currentUserRole}_${formId}`;
    const savedDataJSON = localStorage.getItem(storageKey);

    if (!form || !savedDataJSON) return;

    const savedData = JSON.parse(savedDataJSON);
    for (const key in savedData) {
        const element = form.elements[key];
        if (element) {
            if (element.type === 'checkbox') {
                element.checked = savedData[key];
            } else {
                element.value = savedData[key];
            }
        }
    }
    showAlert('Unsaved form data has been restored.', 'info');
    localStorage.setItem(storageKey,"");
}

// Add this event listener to handle browser back/forward buttons
window.addEventListener('popstate', (event) => {
    if (event.state && event.state.viewId) {
        // The 'false' argument is crucial. It prevents pushState from being called again,
        // which would break the browser's history.
        navigateTo(event.state.viewId, false);
    } else {
        // If the state is null, it might be the initial page load.
        // You can default to the dashboard.
        if (currentUserRole) {
            navigateTo('dashboard', false);
        }
    }
});

        // --- View Renderers ---
        window.viewRenderers = {
            'dashboard': window.renderDashboard, 'add-student': window.renderAddStudentForm,
            'student-mgt': window.renderStudentManagement, 'teacher-mgt': window.renderTeacherManagement,
            'class-mgt': window.renderClassManagement, 'subject-mgt': window.renderSubjectManagement,
            'subject-allocation': window.renderSubjectAllocation, 'exam-mgt': window.renderExamManagement,
            'attendance-mgt': window.renderAttendanceManagement, 'holiday-mgt': window.renderHolidayManagement, 'my-results': window.renderMyResults,
            'my-attendance': window.renderMyAttendance, 'syllabus-tracker': window.renderSyllabusTracker,
            'fee-mgt': window.renderFeeManagement, 'my-fees': window.renderMyFees,
            'form-mgt': window.renderFormManagement,    // Admin form creation
            'forms': window.renderMyForms,
            'teacher-forms': window.renderTeacherForms,
            'classwise-forms':window.renderTeacherclasswiseForms,
            'response-forms': window.renderTeacherclasswiseForms,
            'my-forms': window.renderStudentFormResponses,'fee-details':window.renderTeacherFeeDetails,
            'reports': window.renderReportsModule, // <-- ADD THIS LINE
             'school-details': window.renderSchoolDetailsModule, // <-- ADD THIS
'vehicle-mgt': window.renderVehicleManagement, // <-- ADD THIS LINE
    
            'bulk-import': window.renderBulkImportTool,
            'exam-timetable': window.renderUserExamTimetableView,    // For Teacher
    'my-exam-timetable': window.renderUserExamTimetableView, // For Student
    'timetable-mgt': window.renderTimetableManagement,
    // Inside the window.viewRenderers object
'library-mgt': window.renderLibraryManagement,
'library-status': window.renderTeacherLibraryStatus,
'my-library': window.renderMyLibrary,
// Inside the window.viewRenderers object
'fest-mgt': window.renderFestManagement,
'fest-registration': window.renderFestRegistration,
'my-fest-events': window.renderMyFestEvents,
'fest-scoreboard': window.renderFestScoreboard,
'timetable-mgt': window.renderTimetableManagement,
    'class-timetable': window.renderClassTimetableView,
    
    


        
        };
        
        // Start App
        initializeAppAndAuth();

        
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Cropper CSS -->
<link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet">

<!-- Bootstrap & Cropper JS (at end of body) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
<script>
    const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
const sidebarOverlay = document.getElementById('sidebar-overlay');

// Function to show the sidebar
function showSidebar() {
    sidebar.classList.add('show');
    sidebarOverlay.classList.add('show');
    document.body.style.overflow = 'hidden'; // Prevent scrolling main content when sidebar is open
}

// Function to hide the sidebar
function hideSidebar() {
    sidebar.classList.remove('show');
    sidebarOverlay.classList.remove('show');
    document.body.style.overflow = ''; // Restore scrolling
}

// Event Listeners
if (sidebarToggleBtn) {
    sidebarToggleBtn.addEventListener('click', showSidebar);
}

if (sidebarCloseBtn) {
    sidebarCloseBtn.addEventListener('click', hideSidebar);
}

if (sidebarOverlay) {
    sidebarOverlay.addEventListener('click', hideSidebar); // Clicking outside closes sidebar
}
window.addEventListener('DOMContentLoaded', () => {
    const mediaQuery = window.matchMedia('(max-width: 991.98px)');
    if (mediaQuery.matches) {
        // If it's a mobile view, ensure sidebar is hidden initially
        hideSidebar(); // Also ensures overflow is not hidden
    } else {
        // Desktop view, ensure sidebar is visible and overlay is hidden
        sidebar.classList.remove('show'); // Ensure no mobile 'show' class
        sidebarOverlay.classList.remove('show');
        document.body.style.overflow = ''; // Ensure scrolling is normal
    }
});

// Re-evaluate sidebar state on window resize
window.addEventListener('resize', () => {
    const mediaQuery = window.matchMedia('(max-width: 991.98px)');
    if (mediaQuery.matches) {
        // If resized to mobile, hide sidebar if not already hidden
        if (!sidebar.classList.contains('show')) { // Only hide if it's not already intentionally open
            hideSidebar();
        }
    } else {
        // If resized to desktop, ensure sidebar is visible and overlay is hidden
        sidebar.classList.remove('show'); // Ensure desktop default state
        sidebarOverlay.classList.remove('show');
        document.body.style.overflow = '';
    }
});

const offlineIndicator = document.getElementById('offline-indicator');

function handleOffline() {
    if (offlineIndicator) offlineIndicator.style.display = 'block';
    showAlert('You are offline. Functionality will be limited.', 'warning');
    // Detach Firebase listeners to prevent console errors and unnecessary retries
    if (unsubscribeListeners.length > 0) {
        unsubscribeListeners.forEach(unsub => unsub());
        unsubscribeListeners = [];
        console.log('Firebase listeners detached due to offline status.');
    }
    if (unsubscribeFeeListeners.length > 0) {
        unsubscribeFeeListeners.forEach(unsub => unsub());
        unsubscribeFeeListeners = [];
    }
}

function handleOnline() {
    if (offlineIndicator) offlineIndicator.style.display = 'none';
    showAlert('You are back online!', 'success');
    // Re-initialize data listeners if a user is logged in to get the latest data
    if (currentUserRole) {
        console.log('Re-attaching Firebase listeners...');
        attachMainDataListeners();
        attachFeeDataListeners(activeFinancialYear);
    }
}

window.addEventListener('offline', handleOffline);
window.addEventListener('online', handleOnline);

// --- SESSION SAVE & RESTORE LOGIC ---

// Save the last active view before the page is unloaded
window.addEventListener('beforeunload', (event) => {
    // Only save state if a user is logged in
    if (currentUserRole && selectedUser) {
        const activeNavId = document.querySelector('.nav-link.active')?.id.replace('nav-', '');
        if (activeNavId) {
            const sessionState = {
                userId: selectedUser.id,
                viewId: activeNavId,
                timestamp: Date.now()
            };
            localStorage.setItem('schoolAppLastSession', JSON.stringify(sessionState));
        }
        // This will trigger the browser's confirmation prompt
        event.preventDefault();
        event.returnValue = '';
    }
});


</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Management Pro</title>
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://unpkg.com/cropperjs/dist/cropper.css" rel="stylesheet">
   
    <style>
        .hall-ticket-page {
            position: relative;
            overflow: hidden;
            width: 210mm; /* A4 width */
            min-height: 297mm; /* A4 height */
            padding: .5cm;
            box-sizing: border-box;
            border: 2px solid #333; /* For visual separation in preview */
            margin: 10px auto; /* Center in preview */
            page-break-after: always; /* Each hall ticket on a new page when printing all */
        }
        .hall-ticket-page:last-child {
            page-break-after: avoid;
        }
        @media print {
            body { background-color: #fff; }
            .no-print { display: none !important; }
            .hall-ticket-page {
                border: none !important; /* Remove border when printing */
                margin: 0 !important;
                padding: 1.5cm !important; /* Apply padding as margin in print */
                box-shadow: none !important;
            }
            .hall-ticket-page table, .hall-ticket-page th, .hall-ticket-page td {
                border-color: #dee2e6 !important; /* Ensure borders print */
            }
            /* Specific for Room Allocation Report Print */
            .room-summary-item {
                page-break-inside: avoid; /* Prevent breaking a room summary across pages */
                margin-bottom: 15px; /* Spacing between rooms */
                border: 1px solid #eee;
                padding: 10px;
                border-radius: 5px;
            }
        }
        .copy-column-header {
    cursor: copy; /* Indicates it's copyable */
    text-decoration: underline dotted #888; /* Subtle underline */
}
.copy-column-header:hover {
    background-color: #f0f0f0; /* Light highlight on hover */
    color: #0d6efd; /* Blue text on hover */
}
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; opacity: 0; transition: opacity 0.5s ease-in-out; }
        .view.active { display: flex; opacity: 1; }
        #main-app {
            display: flex;
            height: 100vh;
        }
        /* Ensure the main app container takes full height (if not already set) */
#main-app {
    display: flex;
    height: 100vh; /* Or adjust if you have a fixed header/footer outside main-app */
    overflow: hidden; /* Important for flex children scrolling */
}

/* Sidebar styling */
#sidebar {
    width: 280px;
    min-width: 280px;
    height: 100vh; /* As per your requirement */
    /* Make sidebar a flex container to manage its children's layout */
    display: flex;
    flex-direction: column; /* Stack children vertically */
    background-color: #fff;
    border-right: 1px solid #dee2e6; /* Bootstrap's border-end color */

    /* The sidebar itself will now scroll if its content overflows */
    overflow-y: auto;
    overflow-x: hidden; /* Prevent horizontal scrolling */
    position: relative; /* Needed for z-index and potentially sticky positioning of children */
    z-index: 10;
    transition: transform 0.3s ease-in-out;
}
#sidebar2 {
        
        height: 90vh; /* On mobile, it's still full viewport height */
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        overflow-y: auto;
        overflow-x: hidden;
    }


/* Sidebar overlay for mobile (from previous solution) */
#sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    pointer-events: none;
}
#sidebar-overlay.show {
    opacity: 1;
    pointer-events: auto;
    display: block !important;
}

/* Mobile-specific styles (from previous solution) */
@media (max-width: 991.98px) {
    #sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 95vh; /* On mobile, it's still full viewport height */
        transform: translateX(-100%);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        overflow-y: auto;
        overflow-x: hidden;
    }
    #sidebar2 {
        
        height: 80vh; /* On mobile, it's still full viewport height */
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        overflow-y: auto;
        overflow-x: hidden;
    }
    #sidebar.show {
        transform: translateX(0);
    }
    #sidebar-toggle-btn {
        display: block !important;
    }
    #sidebar-close-btn {
        display: block !important;
    }
    /* Ensure the sticky header still works on mobile sidebar
    #sidebar > div:first-child {
        position: sticky;
        top: 0;
        background-color: #fff;
        z-index: 11;
    } */
}
        .nav-link.active {
            background-color: #e9ecef;
            font-weight: 600;
        }
        .absent-mark { color: #dc3545; font-weight: bold; }
        .border-start-primary { border-left: .25rem solid #4e73df!important; }
        .border-start-success { border-left: .25rem solid #1cc88a!important; }
        .border-start-info { border-left: .25rem solid #36b9cc!important; }
        .border-start-warning { border-left: .25rem solid #f6c23e!important; }
        
        /* Attendance Color Codes */
        .att-present { background-color: #d1e7dd; color: #0f5132; }
        .att-absent { background-color: #f8d7da; color: #842029; font-weight: bold; }
        .att-half { background-color: #fff3cd; color: #664d03; }
        .att-holiday { background-color: #e2e3e5; color: #41464b; }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
        }

        .sub-tab-btn.active {
            border-bottom: 2px solid #0d6efd;
            color: #0d6efd;
        }

        @media print {
    .no-print {
        display: none !important;
    }
    /* Optionally, to ensure only modal content prints well */
    body > *:not(#fullStudentDetailModal) {
        display: none;
    }
    #fullStudentDetailModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: auto; /* Allow content to dictate height */
        overflow: visible; /* Allow content to overflow for print */
        background-color: #fff; /* Ensure white background */
    }
    #fullStudentDetailModal .modal-dialog {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    #fullStudentDetailModal .modal-content {
        border: none;
        border-radius: 0;
        box-shadow: none;
        min-height: auto;
    }
    #fullStudentDetailModal .modal-body {
        padding: 20px; /* Adjust padding for print if needed */
    }
}

.ui-card {
    background-color: #ffffff;
    border-radius: 0.5rem;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    margin-bottom: 1.5rem;
}

.section-header {
    font-weight: 600;
    color: #333;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    border-bottom: 1px solid #e5e7eb;
}

.table thead th {
    background-color: #f9fafb;
    font-weight: 600;
    color: #4b5563;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.table-hover tbody tr:hover {
    background-color: #f3f4f6;
}

.table td, .table th {
    vertical-align: middle;
}

.color-dot-display {
    display: inline-block;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 1px solid #d1d5db;
    vertical-align: middle;
    margin-right: 0.5rem;
}

@media (max-width: 768px) {
    .tabs-container {
        width: 100%;
        overflow-x: auto;  /* Creates the horizontal scrollbar if needed */
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS devices */
    }

    .nav-tabs {
        flex-wrap: nowrap; /* Prevents Bootstrap tabs from stacking vertically */
        white-space: nowrap; /* Ensures all tabs stay in a single line */
    }

    /* Optional: Hide the scrollbar for a cleaner look */
    .tabs-container::-webkit-scrollbar {
        display: none; /* For Chrome, Safari, and Opera */
    }
    .tabs-container {
        -ms-overflow-style: none;  /* For IE and Edge */
        scrollbar-width: none;  /* For Firefox */
    }
    /* ========================================================================= */
/* --- ðŸ“± MOBILE TABLE ENHANCEMENTS --- */
/* ========================================================================= */

/* This targets screens smaller than 768px (tablets and phones) */

    /* 1. Reduce the font size for all tables to make them more compact */
    .table {
        font-size: 0.85em; /* Adjust this value as needed */
    }

    /* 2. Ensure the table's container can scroll horizontally */
    .table-responsive {
        overflow-x: auto;
    }

    /* 3. Make the FIRST header cell (TH) of each row sticky */
    .table th:first-child {
        position: -webkit-sticky; /* For Safari */
        position: sticky;
        left: 0;
        z-index: 2; /* Ensures it stays on top of other content */
        
        /* Add a background color to prevent text from showing through */
        background-color: #f8f9fa; /* Matches Bootstrap's default light header */
    }

    /* 4. Make the FIRST data cell (TD) of each row sticky */
    .table td:first-child {
        position: -webkit-sticky; /* For Safari */
        position: sticky;
        left: 0;
        z-index: 1;

        /* Add a background color to prevent text from showing through */
        background-color: #ffffff; /* White for standard table rows */
    }

    /* Optional: Add a subtle shadow to the sticky column to show it's layered */
    .table th:first-child,
    .table td:first-child {
        box-shadow: 5px 0 5px -5px rgba(0,0,0,0.1);
    }
}
/* Add this to your main <style> tag */
.event-selected {
    background-color: #e0f2e9 !important; /* A light, pleasant green */
    border-radius: 5px;
}
    </style>
</head>
<body class="bg-light">
    <!-- Notification Bell Dropdown -->
<!-- Notification Bell Dropdown -->
 <div id="offline-indicator" class="bg-danger text-white text-center p-2" style="display: none; position: fixed; width: 100%; z-index: 2000;">
  <i class="fas fa-exclamation-triangle me-2"></i> You are currently offline. Some features may be unavailable.
  </div>
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1030;">
    <div class="dropdown">
        <button class="btn btn-light btn-lg rounded-circle position-relative" type="button" id="notificationBell" onclick="toggleNotificationDropdown(event)">
            <i class="fas fa-bell text-secondary"></i>
            <span id="notification-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
                0
            </span>
        </button>
        <ul id="notification-list" class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationBell" style="width: 350px;">
            <!-- Notifications will be rendered here -->
        </ul>
    </div>
</div>

 <!-- Global Alert Toast -->
    <div class="position-fixed top-0 start-0 end-0 d-flex justify-content-center justify-content-md-end p-1" style="z-index: 1055;">
    <div id="alert-toast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-circle me-2"></i>
            <strong class="me-auto" id="alert-title">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="alert-body"></div>
    </div>
</div>
    
    <div id="custom-alert" class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1050; display: none;">
        <div id="custom-alert-content" class="alert d-flex align-items-center" role="alert">
            <i id="custom-alert-icon" class="fas me-2"></i>
            <div id="custom-alert-message"></div>
        </div>
    </div>

    <div id="app-container">
        <div id="login-screen" class=" view vh-100 align-items-center justify-content-center bg-light">
            <div class="card shadow-lg" style="width: 100%; max-width: 420px;">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <i class="fas fa-school fa-3x text-primary"></i>
                        <h1 class="mt-3 h3 fw-bold">School Management Pro</h1>
                        <p class="text-muted">Select your role to sign in</p>
                    </div>

                    <ul class="nav nav-tabs nav-fill mb-4" id="loginTab" role="tablist">
                        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#admin-login-view" type="button" role="tab">Admin</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#teacher-login-view" type="button" role="tab">Teacher</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#student-login-view" type="button" role="tab">Student</button></li>
                    </ul>

                    <form id="login-form">
                        <div class="tab-content">
                            <div class="tab-pane fade" id="admin-login-view" role="tabpanel">
                                <div class="mb-3"><label class="form-label">Username</label><input type="text" id="admin-user" value="" class="form-control"></div>
                                <div class="mb-3"><label class="form-label">Password</label><input type="password" id="admin-pass" value="" class="form-control"></div>
                            </div>
                            <div class="tab-pane fade active show" id="teacher-login-view" role="tabpanel">
                                <div class="mb-3"><label class="form-label">Email</label><input type="email" id="teacher-useremail" placeholder="Enter your email" class="form-control" style="text-transform: lowercase;"></div>
                                <div class="mb-3"><label class="form-label">Password</label><input type="password" id="teacher-password" placeholder="Last 5 digits of your mobile" class="form-control"></div>
                            </div>
                            <div class="tab-pane fade" id="student-login-view" role="tabpanel">
                                <div class="mb-3"><label class="form-label">Admission Number</label><input type="text" id="student-admn" placeholder="Last 4 digits of Admission No." class="form-control" style="text-transform: uppercase;"></div>
                                <div class="mb-3"><label class="form-label">Password</label><input type="password" id="student-dob" placeholder="Your year of birth (YYYY)" class="form-control"></div>
                            </div>
                        </div>
                        <div class="d-grid mt-4"><button type="submit" class="btn btn-primary btn-lg">Sign In</button></div>
                    </form>
                </div>
            </div>
        </div>

        <div id="main-app" class="view">
    <div id="sidebar-overlay" class="d-none"></div>

    <button id="sidebar-toggle-btn" class="btn btn-primary d-lg-none position-fixed top-0 start-0 m-3 z-3" style="z-index: 1000;">
        <i class="fas fa-bars"></i>
    </button>

    <aside id="sidebar" class="d-flex flex-column p-3 bg-white border-end">
        <div class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
            <i class="fas fa-school fa-2x text-primary"></i><span id="panel-title" class="fs-4 ms-3 fw-bold"></span>
            <button id="sidebar-close-btn" class="btn btn-sm btn-outline-secondary d-lg-none ms-auto"><i class="fas fa-times"></i></button>
            
        </div>
        
        <hr>
        <div id="sidebar2">
        <nav id="sidebar-nav" class="nav nav-pills flex-column mb-auto"></nav>
    </div>
        <hr>
        <button id="logout-btn" class="btn btn-outline-danger w-100"><i class="fas fa-sign-out-alt me-2"></i>Logout</button>
    
        <hr>
        
        </aside>

    <main id="main-content" class="flex-grow-1 p-4 overflow-auto bg-light"></main>
</div>
    </div>
<div class="modal fade" id="studentDetailModal" tabindex="-1" aria-labelledby="studentDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="studentDetailModalLabel">Student Fee Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="studentDetailModalBody">
        </div>
    </div>
  </div>
</div>

    <div class="modal fade" id="fullStudentDetailModal" tabindex="-1" aria-labelledby="fullStudentDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable"> <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="fullStudentDetailModalLabel">Student Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="fullStudentDetailModalBody">
        </div>
      <div class="modal-footer no-print"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="print-student-details-btn"><i class="fas fa-print me-2"></i>Print / Save PDF</button>
        <button type="button" class="btn btn-primary" id="print-student-extract-btn"><i class="fas fa-print me-2"></i>Ad-Form</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="editIssuanceModal" tabindex="-1" aria-labelledby="editIssuanceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editIssuanceModalLabel">Edit Book Issuance</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Student:</strong> <span id="modal-student-name"></span></p>
        <p><strong>Book:</strong> <span id="modal-book-title"></span></p>
        <hr>
        <form id="edit-issuance-form">
            <input type="hidden" id="modal-issuance-id">
            <div class="mb-3">
                <label for="modal-due-date" class="form-label">New Due Date</label>
                <input type="date" class="form-control" id="modal-due-date" required>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" id="modal-save-issuance-btn" class="btn btn-primary">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="admissionExtractModal" tabindex="-1" aria-labelledby="admissionExtractModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="admissionExtractModalLabel">Admission Extract (FORM 3)</h5>
        <button type="button" class="btn-close no-print" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="admission-extract-modal-body">
        </div>
      <div class="modal-footer no-print">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="print-admission-extract-btn"><i class="fas fa-print me-2"></i>Print Extract</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Pay Fees via UPI</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-5 text-center">
            <h6>1. Scan this QR Code (for Desktop)</h6>
            <div id="qr-code-container" class="p-3 border rounded bg-light" style="min-height: 250px;">
                </div>
            <p class="mt-2" id="upi-uri-display" style="word-break: break-all; font-size: 0.7rem;"></p>
          </div>
          <div class="col-md-7">
            <h6>2. Enter Amount & Pay</h6>
            <div class="mb-3">
              <label class="form-label">Amount to Pay (INR)</label>
              <input type="number" id="payment-amount" class="form-control form-control-lg">
            </div>
            <div class="alert alert-info">
              <p class="fw-bold">Your current balance is: <span id="modal-balance-due">â‚¹0.00</span></p>
            </div>
            <hr>
            <h6>3. Confirm Your Payment</h6>
            <p class="text-danger fw-bold">After paying, you MUST enter the UPI Transaction ID below to confirm.</p>
            <div class="mb-3">
                <label class="form-label">UPI Transaction ID (UTR)</label>
                <input type="text" id="upi-transaction-id" class="form-control" placeholder="Enter the 12-digit UTR here" required>
            </div>
            
            <div class="d-grid gap-2">
                <a href="#" id="pay-with-upi-app-btn" class="btn btn-success btn-lg d-lg-none">
                    <i class="fas fa-mobile-alt me-2"></i>Pay with UPI App
                </a>
                <button id="confirm-payment-btn" class="btn btn-primary btn-lg">Confirm Payment</button>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="poster-modal" tabindex="-1" aria-labelledby="posterModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="posterModalLabel">Topper Poster Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="poster-image-display" src="" class="img-fluid" alt="Generated Topper Poster">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <a id="save-poster-btn" href="#" class="btn btn-primary" download="topper-poster.png">
          <i class="fas fa-download me-2"></i>Save Poster
        </a>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="eventSelectionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="event-modal-title">Select Events</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="event-modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="event-modal-save-btn" class="btn btn-primary">Confirm Events</button>
                </div>
            </div>
        </div>
</div>

<div class="modal fade" id="editRegistrationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
    <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Edit Registration</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="edit-modal-body"></div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-danger" id="edit-modal-delete-btn">Delete Registration</button>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="edit-modal-save-btn" class="btn btn-success">Save Changes</button>
                </div>
            </div>
    </div>

    <div class="modal fade" id="addFestModal" tabindex="-1" aria-labelledby="addFestModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addFestModalLabel">Create New Fest / Sports Meet</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="add-fest-form">
          <div class="mb-3">
            <label for="new-fest-name" class="form-label">Name</label>
            <input type="text" id="new-fest-name" class="form-control" placeholder="e.g., Annual Sports Meet 2025" required>
          </div>
          <div class="mb-3">
            <label for="new-fest-type" class="form-label">Type</label>
            <select id="new-fest-type" class="form-select" required>
                <option value="Arts">Arts Fest</option>
                <option value="Sports">Sports Meet</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="save-new-fest-btn" class="btn btn-primary">Create Fest</button>
      </div>
    </div>
  </div>
</div>
</div>
</div>

<div class="modal fade" id="liabilityCheckModal" tabindex="-1" aria-labelledby="liabilityCheckModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="liabilityCheckModalLabel">Liability Check for TC Issuance</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="liability-check-modal-body">
        </div>
      <div class="modal-footer" id="liability-check-modal-footer">
        </div>
    </div>
  </div>
</div>
<div class="modal fade" id="tcPrintModal" tabindex="-1" aria-labelledby="tcPrintModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tcPrintModalLabel">Transfer Certificate Preview</h5>
        <button type="button" class="btn-close no-print" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="tc-modal-body">
        </div>
      <div class="modal-footer no-print">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="print-final-tc-btn">
            <i class="fas fa-print me-2"></i>Print TC
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="resignTeacherModal" tabindex="-1" aria-labelledby="resignTeacherModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="resignTeacherModalLabel">Teacher Off-boarding Wizard</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="resign-teacher-id">
        <p>You are processing the resignation for <strong id="resign-teacher-name"></strong>. Please follow the steps below.</p>
        
        <ul class="nav nav-pills nav-fill" id="resign-wizard-tabs" role="tablist">
          <li class="nav-item" role="presentation"><button class="nav-link" id="step-tab-1" data-bs-toggle="pill" data-bs-target="#step-pane-1" type="button" role="tab">1. Class Charge</button></li>
          <li class="nav-item" role="presentation"><button class="nav-link" id="step-tab-2" data-bs-toggle="pill" data-bs-target="#step-pane-2" type="button" role="tab">2. Subjects</button></li>
          <li class="nav-item" role="presentation"><button class="nav-link" id="step-tab-3" data-bs-toggle="pill" data-bs-target="#step-pane-3" type="button" role="tab">3. Roles</button></li>
          <li class="nav-item" role="presentation"><button class="nav-link" id="step-tab-4" data-bs-toggle="pill" data-bs-target="#step-pane-4" type="button" role="tab">4. Finalize</button></li>
        </ul>

        <div class="tab-content pt-4" id="resign-wizard-content">
          <div class="tab-pane fade" id="step-pane-1" role="tabpanel" style="display: none;">
            <h6 class="text-primary">Re-assign Class Charge (Mandatory)</h6>
            <p>This teacher is the charge of <strong id="class-charge-info"></strong>. You must select a new teacher.</p>
            <select id="reassign-class-charge-select" class="form-select"><option value="">-- Select New Class Teacher --</option></select>
          </div>
          <div class="tab-pane fade" id="step-pane-2" role="tabpanel" style="display: none;">
            <h6 class="text-primary">Re-assign Subject Allocations (Mandatory)</h6>
            <p>This teacher is assigned to the following <strong id="subject-count-info"></strong> subject(s):</p>
            <div id="subject-allocations-list" class="list-group list-group-flush border rounded mb-3" style="max-height: 150px; overflow-y: auto;"></div>
            <label for="reassign-subjects-select" class="form-label">You must re-assign them all to a single new teacher.</label>
            <select id="reassign-subjects-select" class="form-select"><option value="">-- Select New Subject Teacher --</option></select>
          </div>
          <div class="tab-pane fade" id="step-pane-3" role="tabpanel" style="display: none;">
             <h6 class="text-primary">Re-assign Special Roles (Optional)</h6>
             <p>This teacher has the roles: <strong id="roles-info"></strong>. You can optionally transfer these to another teacher.</p>
             <select id="reassign-roles-select" class="form-select"><option value="">-- Do Not Re-assign --</option></select>
          </div>
          <div class="tab-pane fade" id="step-pane-4" role="tabpanel" style="display: none;">
             <h6 class="text-primary">Finalize Resignation</h6>
             <p>Please enter the final details for this teacher's departure.</p>
             <div class="mb-3"><label for="resignation-date" class="form-label">Resignation Date</label><input type="date" class="form-control" id="resignation-date" required></div>
             <div class="mb-3"><label for="resignation-reason" class="form-label">Reason (Optional)</label><textarea id="resignation-reason" class="form-control" rows="2"></textarea></div>
          </div>
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-secondary" id="resign-wizard-prev-btn" style="display: none;">Previous</button>
        <div>
            <button type="button" class="btn btn-primary" id="resign-wizard-next-btn">Next</button>
            <button type="button" id="confirm-resignation-btn" class="btn btn-danger" style="display: none;">Confirm & Process</button>
        </div>
      </div>
    </div>
  </div>
</div>


   <!-- Cropper CSS -->
<link href="https://unpkg.com/cropperjs/dist/cropper.min.css" rel="stylesheet"/>

<!-- Cropper JS -->
<script src="https://unpkg.com/cropperjs/dist/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script type="module">
      // Correct import for side effects
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, getDoc, getDocs,updateDoc, collection, onSnapshot, deleteDoc, writeBatch, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
       //import {getData, getStudentsData, showSidebar, hideSidebar, printExamTimetable,generateTopperPoster } from "./finalgs.js";
      // import {generateTopperPoster } from "./finalgs.js";
        const mainContent = document.getElementById('main-content');
        const sidebarNav = document.getElementById('sidebar-nav');
         const appId = 'school-management-app';
        const firebaseConfig = {
            apiKey: "AIzaSyAu5TDMWepJX7naoG5H3WpGJ1yxAu01whg",
            authDomain: "timetables-470dd.firebaseapp.com",
            projectId: "timetables-470dd",
            storageBucket: "timetables-470dd.appspot.com",
            messagingSenderId: "925422681424",
            appId: "1:925422681424:web:df91ce9de4dfef9c5ec055"
        };

        let db, auth;
       
        
        let classes = [], teachers = [], subjects = [],  exams = [], classroomSubjects = [], examSchedules = [], 
        // marks = [], 
        // Add this near your other global variables
        
        
        attendance = [], holidays = [], syllabuses = [], syllabusCompletion = [], chapters = [],books = [], bookIssuances = [];
        let feeStructures = [], studentFeeSetups = [], receipts = [];
        let currentViewId = null;
        let unsubscribeListeners = [];
        let unsubscribeFeeListeners = [];
        
        let currentUserRole = null;
        let selectedUser = null; 
        // currentUserRole = 'admin'; // Or 'teacher'
        // selectedUser = { id: 'teacher123', name: 'John Doe',role:'admin', roles: ['teacher', 'exam_controller'] }; // Or the logged-in user
        
        let classToEdit = null, teacherToEdit = null, studentToEdit = null;let subjectToEdit = null; 
        let allocationToEdit = null; 
        let attendanceChart = null;
        let completionModalInstance = null;
        let receiptToEdit = null;
        let feeStructureToEdit = null;
        let activeFinancialYear = `${new Date().getFullYear()}-${new Date().getFullYear() + 1}`;
        let forms = [];
        let formResponses = [];
        let formToEdit = null;
        // --- Global Variables for Photo Handling and Cropper Instance ---
        let cropper =null;
        let rawPhotoFile = null; // Stores the raw file chosen by user for cropping
        let croppedPhotoBlob = null; // Stores the final cropped image as a Blob for upload
        let currentPhotoURL = ''; // Stores the URL of the student's existing photo (if editing)
        let reports = [], schoolDetails = {},vehicles = [];
       // let unsubscribeMarksListener = null; // To manage the dynamic marks listener
        // Add this near your other global variables

        let activeMarksListeners = {}; // NEW: To store multiple listeners
        let marks = {};              // Store marks in an object for easier management
        let examRoomAllocationRules = [];

let currentLibraryReportData = [];
let libraryReportSort = {
    column: 'dueDate', // Default column to sort by
    direction: 'asc'   // Default direction ('asc' or 'desc')
};

// Add this near the other fest-related global variables
let festParticipantFilters = {
    festId: '', // Stores the last selected Fest ID
    classId: '' // Stores the last selected Class ID
};

let students =[];
// Add these to your list of global variables
let festHouses = [], fests = [], festEvents = [], festRegistrations = [], festResults = [], festSettings = {};
let festGroups =[];
// --- Global State & Timers ---
let houseToEdit = null, festToEdit = null, eventToEdit = null;
   let initialDataPromises = {};
let dataLoadStatus = {}; // To track if a collection has received its first snapshot
let collectionLoadPromises = {}; // Stores Promises that resolve when a specific collection's initial load is complete { collectionName: Promise }

// Global variable to store a teacher's unique class-division assignments
let teacherAssignedClasses = [];
let pendingPayments =[];
let bookAllotments =[];
let examRooms = [];
let examDuties = [];
let examAbsentees = [];
let examRegistrationSettings = {}; // Single document,
let timetables = [];

let roomToEdit = null; // Local state for editing a room (can be global if preferred)

schoolDetails = {
            fullname: 'KATTILANGADI YATHEEMKHANA HIGHER SECONDARY SCHOOL',
            name: 'KYHSS-19094',
            address: 'Kattilangadi yatheemkhana Higher Secondary School',
            logoUrl: 'KYHSSLOGO.jpg',
            hmSignPng: 'sign3.jpg',
            schoolSealPng: 'SEAL.jpg'
        };

        // A final, unified function to handle all data fetching needs.
async function getData(storeName, idOrQueryObj = null) {
    try {
        const store = appDb[storeName];
        if (!store) {
            console.error(`Store "${storeName}" does not exist in the database.`);
            return null;
        }

        const isById = typeof idOrQueryObj === 'string';
        attachDataListeners([storeName]);
        // --- PATH 1: Fetch by ID ---
        if (isById) {
            const docId = idOrQueryObj;
            let localDoc = await store.get(docId);

            if (localDoc) return localDoc;
        }

        // --- PATH 2: Query data from cache ---
        let localData = idOrQueryObj
            ? await store.where(idOrQueryObj).toArray()
            : await store.toArray();

        if (localData.length > 0) return localData;

        // --- Try online fetch if offline cache is empty ---
        if (navigator.onLine) {
            try {
                if (storeName === 'marks') {
                    await syncDataForUser();
                } else {
                    attachDataListeners([storeName]);
                }

                await waitForCollectionLoad(storeName);

                // re-fetch from IndexedDB after sync
                localData = idOrQueryObj
                    ? await store.where(idOrQueryObj).toArray()
                    : await store.toArray();

                return localData;
            } catch (err) {
                console.error(`Error fetching ${storeName} from Firestore:`, err);
            }
        }

        return [];
    } catch (error) {
        console.error(`Error fetching data from "${storeName}":`, error);
        return null;
    }
}

        // exams = [
        //     { id: 'EXAM001', name: 'Term Exam 2025' },
        //     { id: 'EXAM002', name: 'Annual Exam 2025' }
        // ];

        // examSchedules = [
        //     { examId: 'EXAM001', date: '2025-08-10', session: 'FN', classId: 'CLASS10', division: 'A', subjectId: 'SUBMATH', maxTE: 70, maxCE: 30 },
        //     { examId: 'EXAM001', date: '2025-08-10', session: 'FN', classId: 'CLASS10', division: 'B', subjectId: 'SUBMATH', maxTE: 70, maxCE: 30 },
        //     { examId: 'EXAM001', date: '2025-08-10', session: 'AN', classId: 'CLASS10', division: 'A', subjectId: 'SUBSCI', maxTE: 70, maxCE: 30 },
        //     { examId: 'EXAM001', date: '2025-08-11', session: 'FN', classId: 'CLASS10', division: 'A', subjectId: 'SUBLANG', maxTE: 70, maxCE: 30 },
        //     { examId: 'EXAM002', date: '2025-11-20', session: 'FN', classId: 'CLASS10', division: 'A', subjectId: 'SUBPHY', maxTE: 70, maxCE: 30 }
        // ];

        // examRooms = [
        //     { id: 'HALL-A', name: 'Main Exam Hall A', capacity: 50, isLab: false, description: 'Ground floor hall' },
        //     { id: 'ROOM-101', name: 'Classroom 101', capacity: 25, isLab: false, description: 'First floor' },
        //     { id: 'LAB-CHEM', name: 'Chemistry Lab', capacity: 20, isLab: true, description: 'Science lab' }
        // ];

        // examDuties = [
        //     { id: 'EXAM001_20250810_FN_HALL-A', examId: 'EXAM001', date: '2025-08-10', session: 'FN', roomId: 'HALL-A', dutyTeacherId: 'teacher123', dutyTeacherName: 'John Doe' }
        // ];

        // examAbsentees = []; // Populated dynamically
        
        // // Example for testing absentee notifications. Add an absentee if none exists.
        // setTimeout(() => {
        //     if (examAbsentees.length === 0) {
        //         examAbsentees.push(
        //             { id: 'EXAM001_studentA_20250721_FN_SUBMATH', examId: 'EXAM001', classId: 'CLASS10', division: 'A', subjectId: 'SUBMATH', date: '2025-07-21', session: 'FN', studentId: 'studentA', studentName: 'Alice Smith', admissionNumber: 'ADMN001', reportedByTeacherId: 'teacher123', notifiedToClassCharge: false },
        //             { id: 'EXAM001_studentB_20250721_FN_SUBMATH', examId: 'EXAM001', classId: 'CLASS10', division: 'B', subjectId: 'SUBMATH', date: '2025-07-21', session: 'FN', studentId: 'studentB', studentName: 'Bob Johnson', admissionNumber: 'ADMN002', reportedByTeacherId: 'teacher123', notifiedToClassCharge: false }
        //         );
        //         // Trigger notification check if tab is active, or user navigates to it
        //         if (document.getElementById('exam-control-notifications')?.classList.contains('active')) {
        //              checkAbsenteeNotifications();
        //         }
        //     }
        // }, 1000); // Simulate data arriving

        // examRegistrationSettings = {
        //     'CLASS10_M': 101,
        //     'CLASS10_F': 101
        // };

        // examRoomAllocationRules = []; // Stores the rules used for allocation

        // classes = [
        //     { id: 'CLASS10', name: 'Class 10', divisions: ['A', 'B', 'C'] },
        //     { id: 'CLASS9', name: 'Class 9', divisions: ['A', 'B'] }
        // ];
        // subjects = [
        //     { id: 'SUBMATH', name: 'Mathematics' },
        //     { id: 'SUBSCI', name: 'Science' },
        //     { id: 'SUBLANG', name: 'English' },
        //     { id: 'SUBPHY', name: 'Physics' }
        // ];
        // students = [
        //     { id: 'studentA', name: 'Alice Smith', admissionNumber: 'ADMN001', classId: 'CLASS10', division: 'A', gender: 'F', examRegNumbers: { 'EXAM001': 'FCLASS10_101', 'EXAM002': 'FCLASS10_001' }, examRoomAllocations: {} },
        //     { id: 'studentB', name: 'Bob Johnson', admissionNumber: 'ADMN002', classId: 'CLASS10', division: 'B', gender: 'M', examRegNumbers: { 'EXAM001': 'MCLASS10_101' }, examRoomAllocations: {} },
        //     { id: 'studentC', name: 'Charlie Brown', admissionNumber: 'ADMN003', classId: 'CLASS10', division: 'A', gender: 'M', examRegNumbers: { 'EXAM001': 'MCLASS10_102' }, examRoomAllocations: {} },
        //     { id: 'studentD', name: 'Diana Prince', admissionNumber: 'ADMN004', classId: 'CLASS10', division: 'B', gender: 'F', examRegNumbers: { 'EXAM001': 'FCLASS10_102' }, examRoomAllocations: {} },
        //     { id: 'studentE', name: 'Eve Adams', admissionNumber: 'ADMN005', classId: 'CLASS9', division: 'A', gender: 'F', examRegNumbers: { 'EXAM001': 'FCLASS9_101' }, examRoomAllocations: {} },
        //     { id: 'studentF', name: 'Frank White', admissionNumber: 'ADMN006', classId: 'CLASS9', division: 'A', gender: 'M', examRegNumbers: { 'EXAM001': 'MCLASS9_101' }, examRoomAllocations: {} }
        // ];
        // // Simulate some room allocations for testing Hall Tickets/Reports
        // students.forEach(s => {
        //     if (s.id === 'studentA') { s.examRoomAllocations['EXAM001_20250810_FN'] = 'HALL-A'; s.examRoomAllocations['EXAM001_20250810_AN'] = 'ROOM-101'; }
        //     if (s.id === 'studentB') { s.examRoomAllocations['EXAM001_20250810_FN'] = 'HALL-A'; }
        //     if (s.id === 'studentC') { s.examRoomAllocations['EXAM001_20250810_FN'] = 'HALL-A'; }
        //     if (s.id === 'studentD') { s.examRoomAllocations['EXAM001_20250810_FN'] = 'ROOM-101'; }
        //     if (s.id === 'studentE') { s.examRoomAllocations['EXAM001_20250810_FN'] = 'LAB-CHEM'; }
        //     if (s.id === 'studentF') { s.examRoomAllocations['EXAM001_20250810_FN'] = 'LAB-CHEM'; }
        // });

        // // Simulate some allocation rules for testing
        // examRoomAllocationRules.push({
        //     id: 'EXAM001_20250810_FN_HALL-A',
        //     examId: 'EXAM001', date: '2025-08-10', session: 'FN', roomId: 'HALL-A',
        //     regNoRangeText: 'FCLASS10_101, MCLASS10_101-MCLASS10_102',
        //     allocatedBy: 'admin', allocatedAt: new Date()
        // });
        // examRoomAllocationRules.push({
        //     id: 'EXAM001_20250810_FN_ROOM-101',
        //     examId: 'EXAM001', date: '2025-08-10', session: 'FN', roomId: 'ROOM-101',
        //     regNoRangeText: 'FCLASS10_102',
        //     allocatedBy: 'admin', allocatedAt: new Date()
        // });
        // examRoomAllocationRules.push({
        //     id: 'EXAM001_20250810_FN_LAB-CHEM',
        //     examId: 'EXAM001', date: '2025-08-10', session: 'FN', roomId: 'LAB-CHEM',
        //     regNoRangeText: 'FCLASS9_101, MCLASS9_101',
        //     allocatedBy: 'admin', allocatedAt: new Date()
        // });

        // teachers = [
        //     { id: 'teacher123', name: 'John Doe', mobile: '9876543210', classCharge: { classId: 'CLASS10', division: 'A' } },
        //     { id: 'teacher456', name: 'Jane Smith', mobile: '9988776655', classCharge: { classId: 'CLASS10', division: 'B' } }
        // ];
        

function waitForCollectionLoad(collectionName) {
    if (dataLoadStatus[collectionName]) {
        return Promise.resolve(); // Data is already loaded, resolve immediately
    }

    if (!collectionLoadPromises[collectionName]) {
        // Create a new Deferred-style Promise if one doesn't exist
        // This is a common pattern for creating a Promise that can be resolved externally.
        let resolveFunc;
        collectionLoadPromises[collectionName] = new Promise(resolve => {
            resolveFunc = resolve;
        });
        collectionLoadPromises[collectionName].resolve = resolveFunc; // Store the resolve function
    }
    return collectionLoadPromises[collectionName];
}

        const adminNav = [
  { id: 'dashboard', icon: 'fa-tachometer-alt', text: 'Dashboard' },
  { id: 'add-student', icon: 'fa-user-plus', text: 'Add Student' },
  { id: 'student-mgt', icon: 'fa-users', text: 'Student Management' },
  { id: 'progression-mgt', icon: 'fa-user-graduate', text: 'Progression' }, // <-- ADD THIS LINE
  
  { id: 'teacher-mgt', icon: 'fa-chalkboard-teacher', text: 'Teacher Management' },
  { id: 'class-mgt', icon: 'fa-school', text: 'Class Management' },
  { id: 'subject-mgt', icon: 'fa-book', text: 'Subject Management' },
  { id: 'subject-allocation', icon: 'fa-tasks', text: 'Subject Allocation' },
  { id: 'exam-mgt', icon: 'fa-file-signature', text: 'Exam Management' },
  { id: 'exam-control', icon: 'fa-clipboard-check', text: 'Exam Control' }, // <-- ADD THIS LINE
  { id: 'exam-reports', icon: 'fa-chart-pie', text: 'Exam Toppers' }, // <-- NEW TOP-LEVEL MODULE
  { id: 'fee-mgt', icon: 'fa-receipt', text: 'Fee Management' },
  { id: 'attendance-mgt', icon: 'fa-calendar-check', text: 'Attendance' },
  { id: 'holiday-mgt', icon: 'fa-calendar-alt', text: 'Holiday Management' },
  { id: 'syllabus-tracker', icon: 'fa-tasks', text: 'Syllabus Tracker' },
  { id: 'form-mgt', icon: 'fa-wpforms', text: 'Form Creator' },
  { id: 'reports', icon: 'fa-chart-bar', text: 'Reports' }, // <-- ADD THIS LINE
  { id: 'school-details', icon: 'fa-university', text: 'School Details' }, // <-- ADD THIS
  { id: 'vehicle-mgt', icon: 'fa-bus', text: 'Vehicle Mgt' }, // <-- ADD THIS LINE
  { id: 'library-mgt', icon: 'fa-book-reader', text: 'Library Management' },
  { id: 'bulk-import', icon: 'fa-file-import', text: 'Bulk Import' },
  { id: 'fest-mgt', icon: 'fa-trophy', text: 'Fest Management' },
  { id: 'timetable-mgt', icon: 'fa-calendar-alt', text: 'Timetable Mgt' },
  { id: 'birthdays', icon: 'fa-birthday-cake', text: 'Today\'s Birthdays' }, // ðŸŽ‚ Add this line

{ id: 'fest-scoreboard', icon: 'fa-chart-line', text: 'Live Scoreboard' },
{ id: 'master-control', icon: 'fa-cogs', text: 'Master Control' },



 
];
const teacherNav = [
  { id: 'dashboard', icon: 'fa-tachometer-alt', text: 'Dashboard' },
  { id: 'student-mgt', icon: 'fa-users', text: 'Student List' },
  { id: 'attendance-mgt', icon: 'fa-calendar-check', text: 'My Class Attendance' },
  { id: 'exam-mgt', icon: 'fa-file-signature', text: 'Mark Entry' },
  { id: 'syllabus-tracker', icon: 'fa-tasks', text: 'Syllabus Tracker' },
  { id: 'teacher-forms', icon: 'fa-clipboard-check', text: 'Forms' }, // âœ… NEW
  //{ id: 'response-forms', icon: 'fa-table', text: 'Form Responses' },
  { id: 'classwise-forms', icon: 'fa-edit', text: 'Class Data Entry' },
  { id: 'mark-absentee', icon: 'fa-user-times', text: 'Mark Absentee' }, 
  { id: 'fee-details', icon: 'fa-receipt', text: 'FeeDetails'},
  { id: 'exam-timetable', icon: 'fa-calendar-alt', text: 'Exam Timetable' },
  { id: 'exam-reports', icon: 'fa-chart-pie', text: 'Exam Toppers' }, // <-- NEW TOP-LEVEL MODULE
  { id: 'class-timetable', icon: 'fa-calendar-days', text: 'Class Timetable' },{ id: 'library-mgt', icon: 'fa-book-reader', text: 'Library Management' },
{ id: 'class-timetable', icon: 'fa-calendar-days', text: 'Class Timetable' },
{ id: 'birthdays', icon: 'fa-birthday-cake', text: 'Today\'s Birthdays' }, // ðŸŽ‚ Add this line

{ id: 'library-status', icon: 'fa-books', text: 'Library Status' },
{ id: 'fest-registration', icon: 'fa-user-check', text: 'Fest Registration' },
{ id: 'fest-scoreboard', icon: 'fa-chart-line', text: 'Live Scoreboard' },
{ id: 'progression-mgt', icon: 'fa-user-graduate', text: 'Class Progression' }, // <-- ADD THIS LINE

];
const studentNav = [
  { id: 'dashboard', icon: 'fa-tachometer-alt', text: 'Dashboard' },
  { id: 'my-results', icon: 'fa-poll', text: 'My Results' },
  { id: 'my-attendance', icon: 'fa-calendar-alt', text: 'My Attendance' },
  { id: 'my-fees', icon: 'fa-rupee-sign', text: 'My Fees' },
  { id: 'forms', icon: 'fa-clipboard-check', text: 'Forms' }, // âœ… NEW
  { id: 'my-forms', icon: 'fa-file-alt', text: 'My Submissions' } ,// In your adminNav array
{ id: 'class-timetable', icon: 'fa-calendar-days', text: 'Class Timetable' },
{ id: 'my-library', icon: 'fa-book-open', text: 'My Library' },
{ id: 'my-fest-events', icon: 'fa-running', text: 'My Fest Events' },
{ id: 'fest-scoreboard', icon: 'fa-chart-line', text: 'Live Scoreboard' },


];

        const getCollectionRef = (name) => collection(db, `/artifacts/${appId}/public/data/${name}`);
        const getDocRef = (name, id) => doc(db, `/artifacts/${appId}/public/data/${name}`, id);
        const getFeeCollectionRef = (fy, name) => collection(db, `/artifacts/${appId}/public/data/feeData/${fy}/${name}`);
        const getFeeDocRef = (fy, name, id) => doc(db, `/artifacts/${appId}/public/data/feeData/${fy}/${name}`, id);

        function showAlert2(message, type = 'danger') {
            const alertEl = document.getElementById('custom-alert');
            const contentEl = document.getElementById('custom-alert-content');
            const messageEl = document.getElementById('custom-alert-message');
            const iconEl = document.getElementById('custom-alert-icon');
            messageEl.textContent = message;
            
            contentEl.className = 'alert d-flex align-items-center'; // Reset classes
            if (type === 'success') {
                contentEl.classList.add('alert-success');
                iconEl.className = 'fas fa-check-circle me-2';
            } else { 
                contentEl.classList.add('alert-danger');
                iconEl.className = 'fas fa-exclamation-triangle me-2';
            }
            alertEl.style.display = 'block';
            setTimeout(() => { alertEl.style.display = 'none'; }, 3000);
        }
        function showAlert(message, type = 'info') {
            const toastEl = document.getElementById('alert-toast');
            const titleEl = document.getElementById('alert-title');
            const bodyEl = document.getElementById('alert-body');
            const headerIcon = toastEl.querySelector('.toast-header i');

            titleEl.textContent = type.charAt(0).toUpperCase() + type.slice(1);
            bodyEl.textContent = message;
            
            toastEl.className = 'toast'; // Reset classes
            headerIcon.className = 'fas fa-circle me-2';

            let toastClass = 'bg-info';
            if (type === 'success') toastClass = 'bg-success';
            if (type === 'danger') toastClass = 'bg-danger';
            
            toastEl.classList.add(toastClass, 'text-white');
            headerIcon.classList.add('text-white');
            
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

    
// This function processes existing data, it does not fetch new data.
// It should be called after `classroomSubjects` and `teachers` are loaded.
async function updateTeacherAssignedClasses() {
    // Check if the user is a teacher and the required data is ready
    if (currentUserRole === 'teacher' && selectedUser && classroomSubjects) {
        const uniquePairs = new Set();
        teacherAssignedClasses = [];

        // 1. Add all classes where the teacher teaches a subject
        classroomSubjects.forEach(cs => {
            if (cs.teacherId === selectedUser.id) {
                const key = `${cs.classId}|${cs.division}`;
                if (!uniquePairs.has(key)) {
                    uniquePairs.add(key);
                    teacherAssignedClasses.push({ classId: cs.classId, division: cs.division });
                }
            }
        });

        // 2. Add the teacher's class charge, if it exists
        if (selectedUser.classCharge && selectedUser.classCharge.classId) {
            const { classId, division } = selectedUser.classCharge;
            const key = `${classId}|${division}`;
            if (!uniquePairs.has(key)) {
                uniquePairs.add(key);
                teacherAssignedClasses.push({ classId, division });
            }
        }

        // --- NEW FALLBACK LOGIC ---
        // 3. If the list is STILL empty, check if the user is an admin.
        // If so, give them access to ALL classes.
        if (teacherAssignedClasses.length === 0 && currentUserRole === 'admin') {
            console.log("Teacher has no specific classes, but is an admin. Granting access to all classes.");
            classes.forEach(c => {
                c.divisions.forEach(d => {
                    teacherAssignedClasses.push({ classId: c.id, division: d });
                });
            });
        }
        // --- END OF NEW LOGIC ---
        
    } else {
        teacherAssignedClasses = []; // Clear if not a teacher or data not ready
    }
    
    console.log('Final teacherAssignedClasses:', teacherAssignedClasses);
}
// --- MODIFY your onLoginSuccess function ---

// --- In your <script type="module"> block ---
// REPLACE your entire onLoginSuccess function with this one

async function onLoginSuccess(role, user) {
    //console.log('mythreestudents',await getData('students')); 
    currentUserRole = role;
    selectedUser = user;
    unsubscribeAllListeners();

    showMainApp(); // Render the main app layout

    if (navigator.onLine) {
        // --- ONLINE: Fetch all data and populate the cache ---
        showAlert('Syncing latest data from server...', 'info');
        try {
           // await getData('classroomSubjects');
            
    

            const collectionsToCache = [
  'classes', 'subjects', 'classroomSubjects', 'teachers', 'exams', 'examSchedules', 'holidays', 
  'books', 'bookIssuances', 'feeStructures', 
  'studentFeeSetups', 'attendance'
];

// Fetch all collections in parallel, but also assign resolved results to window
const dataPromises = collectionsToCache.map(async (name) => {
  const data = await getData(name);
  window[name] = data;
  console.log(name,data);
  return data;
});

// Wait for all collections to populate
await Promise.all(dataPromises);

// âœ… Now safe to run dependent logic
updateTeacherAssignedClasses();

            showAlert('Data sync complete!', 'success');

            // CORRECT: Now that the cache is warm, attach real-time listeners for future updates
         attachDataListeners(collectionsToCache);
            // You can re-add your other specific listeners here if needed
        attachFeeDataListeners(activeFinancialYear, role, user);
            // syncDataForUser();
            
        } catch (error) {
            console.error("Initial data sync failed:", error);
            showAlert("Failed to sync initial data. App may not work correctly offline.", 'danger');
        }
    } else {
        // --- OFFLINE: Load all data from the local cache ---
        showAlert('You are offline. Loading data from local cache.', 'info');
        try {
            // Get all table names directly from Dexie's schema
            const allTables = appDb.tables.map(table => table.name);
            for (const name of allTables) {
                 window[name] = await appDb[name].toArray();
            }
        } catch (dbError) {
            console.error("Error loading data from IndexedDB:", dbError);
            showAlert("Could not load local data.", "danger");
        }
    }

    // After data is loaded (either from network or cache), navigate to dashboard
    await navigateTo('dashboard');
}


async function onLoginSuccessold (role, user) {
    currentUserRole = role;
    selectedUser = user;
    unsubscribeAllListeners(); // Clean up any previous session listeners
    
    // IMPORTANT: Call this AFTER 'classroomSubjects' (and teachers/students) are loaded
        updateTeacherAssignedClasses(); // Populate the teacherAssignedClasses array

    showMainApp(); // Render the main app layout (sidebar, main-content divs)

    // Define core essential collections that *must* be loaded before any view is rendered.
    // Ensure 'classroomSubjects' is in this list as 'updateTeacherAssignedClasses' depends on it.
    const coreCollections = ['classes','subjects', 'exams', 'holidays', 'schoolDetails', 'festSettings','classroomSubjects', 'teachers', 'examDuties', 'examAbsentees', 'examRegistrationSettings'];

    try {
        showAlert(`Loading essential school data...`, 'info');
        // Initiate listeners for all core collections
        await attachDataListeners(coreCollections);
        setupInitialMarksListeners();
        // Wait for ALL core collections to deliver their initial snapshot
        const coreCollectionPromises = coreCollections.map(name => waitForCollectionLoad(name));
        await Promise.all(coreCollectionPromises);
        showAlert(`Core data loaded.`, 'success');

        // IMPORTANT: Call this AFTER 'classroomSubjects' (and teachers/students) are loaded
        updateTeacherAssignedClasses(); // Populate the teacherAssignedClasses array

        // Attach other background listeners (e.g., marks, fees)
        // These don't necessarily block initial UI, but ensure data is streamed.
        attachFeeDataListeners(activeFinancialYear, role, user);
        syncDataForUser(); // This will leverage teacherAssignedClasses for marks

        // Determine the initial view as before
        let initialViewId = 'dashboard';
        const savedSessionJSON = localStorage.getItem('schoolAppLastSession');
        if (savedSessionJSON) {
            const savedSession = JSON.parse(savedSessionJSON);
            const fifteenMinutes = 15 * 60 * 1000;
            if (savedSession.userId === user.id && (Date.now() - savedSession.timestamp < fifteenMinutes)) {
                showAlert(`Restoring your previous session...`, 'info');
                initialViewId = savedSession.viewId;
            }
            localStorage.removeItem('schoolAppLastSession');
        }

        // Navigate to the initial view, which will internally wait for *its* specific data.
        await navigateTo(initialViewId, false);

    } catch (error) {
        console.error("Initial data load failed:", error);
        showAlert("Failed to load essential school data. Please try again.", 'danger');
        // Optionally, force logout or show a retry button
    }
}

//onLoginSuccess('admin',selectedUser);
 
// Add this new object to your script
const viewDependencies = {
    // Admin & General Views
    'dashboard': ['schoolDetails','students', 'teachers', 'classes', 'subjects', 'attendance','classroomSubjects'],
    'add-student': ['classes', 'students'],
    'student-mgt': ['students', 'classes'],
    'teacher-mgt': ['teachers', 'classes'],
    'class-mgt': ['classes'],
    'subject-mgt': ['subjects'],
    'subject-allocation': ['classes', 'subjects', 'teachers', 'classroomSubjects'],
    'exam-mgt': ['marks','exams', 'classes', 'subjects', 'teachers', 'examSchedules','classroomSubjects'],
    'exam-control': ['exams', 'classes', 'subjects', 'teachers', 'examSchedules','classroomSubjects','examRooms', 'examDuties', 'examAbsentees', 'examRegistrationSettings','examRoomAllocationRules'],
    'attendance-mgt': ['students', 'classes', 'holidays', 'attendance'],
    'holiday-mgt': ['holidays'],
    'syllabus-tracker': ['classes', 'subjects', 'teachers', 'classroomSubjects', 'chapters', 'syllabuses', 'syllabusCompletion'],
    'form-mgt': ['forms', 'formResponses'],
    'forms': ['forms', 'formResponses'],
    'classwise-forms': ['forms', 'formResponses'],
    'teacher-forms': ['forms', 'formResponses'],
    
    'fee-mgt' : ['pendingPayments','classes','students','feeStructures','studentFeeSetups','receipts'],
    'reports': ['reports', 'students', 'teachers', 'classes', 'subjects', 'classroomSubjects'],
    'school-details': ['schoolDetails'],
    'vehicle-mgt': ['vehicles'],
    'bulk-import': [], // No initial data needed
    'library-mgt': ['books', 'bookIssuances', 'students'],
    'fest-mgt': ['fests', 'festHouses', 'festEvents', 'festSettings', 'festRegistrations', 'festResults','festGroups'],
    'timetable-mgt': ['classes', 'subjects', 'classroomSubjects', 'timetables'],

    // Teacher Views
    'teacher-forms': ['forms', 'formResponses', 'students'],
    'response-forms':['forms', 'formResponses', 'students'],
    'fee-details': ['students', 'classes', 'studentFeeSetups', 'receipts','feeStructures'],
    'exam-timetable': ['exams', 'examSchedules', 'subjects', 'classes'],
    'class-timetable': ['timetables', 'subjects', 'classes'],
    'library-status': ['bookIssuances', 'students', 'classes'],
    'fest-registration': ['fests', 'festEvents', 'festRegistrations', 'students', 'festSettings','festGroups'],
    'fest-scoreboard': ['fests', 'festResults', 'festEvents', 'festRegistrations', 'festHouses'],


    // Student Views
    'my-results': ['exams', 'examSchedules', 'subjects'],
    'my-attendance': ['holidays', 'attendance'],
    'my-fees': ['schoolDetails','studentFeeSetups', 'receipts'],
    'forms': ['forms', 'formResponses','schoolDetails'],
    'my-forms': ['forms', 'formResponses'],
    'my-library': ['bookIssuances'],
    'my-fest-events': ['fests', 'festRegistrations', 'festEvents','festGroups'],
};

// Keep track of active listeners
let activeListeners = {};



/**
 * Attaches Firestore listeners only for the specified collections.
 * It avoids re-attaching listeners that are already active.
 * @param {string[]} collectionsToWatch - An array of collection names to listen to.
 */
/**
 * Attaches Firestore listeners for the specified collections.
 * Enhanced to scope data for teachers across all their assigned classes/divisions.
 * It does NOT return a Promise directly anymore. Instead, use `waitForCollectionLoad`.
 * @param {string[]} collectionsToWatch - An array of collection names to listen to.
 */
const collectionMap = {
        classes: { setter: data => classes = data, renderer: null },
        subjects: { setter: data => subjects = data, renderer: null },
        students: { setter: data => students = data, renderer: null },
        teachers: { setter: data => teachers = data, renderer: null },
        exams: { setter: data => exams = data, renderer: renderExamsList },
        classroomSubjects: { setter: data => classroomSubjects = data, renderer: updateTeacherAssignedClasses },
        examSchedules: { setter: data => examSchedules = data, renderer: null },
        examRoomAllocationRules: { setter: data => examRoomAllocationRules = data, renderer: null },
        attendance: { setter: data => attendance = data, renderer: null },
        holidays: { setter: data => holidays = data, renderer: null },
        syllabuses: { setter: data => syllabuses = data, renderer: null },
        syllabusCompletion: { setter: data => syllabusCompletion = data, renderer: null },
        chapters: { setter: data => chapters = data, renderer: null },
        books: { setter: data => books = data, renderer: null },
        bookIssuances: { setter: data => bookIssuances = data, renderer: null },
        bookAllotments: {setter: data => bookAllotments = data, renderer: null },
        feeStructures: { setter: data => feeStructures = data, renderer: null },
        studentFeeSetups: { setter: data => studentFeeSetups = data, renderer: null },
        receipts: { setter: data => receipts = data, renderer: null },
        forms: { setter: data => forms = data, renderer: updateAllNotifications },
        formResponses: { setter: data => formResponses = data, renderer: null },
        reports: { setter: data => reports = data, renderer: null },
        schoolDetails: { setter: data => { if (data.length > 0) schoolDetails = data[0]; }, renderer: null },
        vehicles: { setter: data => vehicles = data, renderer: updateAllNotifications },
        festHouses: { setter: data => festHouses = data, renderer: null },
        fests: { setter: data => fests = data, renderer: null },
        festEvents: { setter: data => festEvents = data, renderer: null },
        festGroups: { setter: data => festGroups = data, renderer: null },
        festRegistrations: { setter: data => festRegistrations = data, renderer: null },
        festResults: { setter: data => festResults = data, renderer: null },
        festSettings: { setter: data => { if (data.length > 0) festSettings = data[0]; }, renderer: null },
        timetables: { setter: data => timetables = data, renderer: null },
        examRooms: { setter: data => examRooms = data, renderer: null },
        pendingPayments: { setter: data => pendingPayments = data, renderer: null },
    examDuties: { setter: data => examDuties = data, renderer: null },
    examAbsentees: { setter: data => examAbsentees = data, renderer: checkAbsenteeNotifications },
    examRegistrationSettings: { setter: data => { if (data.length > 0) examRegistrationSettings = data[0]; }, renderer: null }, // Assuming it's a single doc
    
    
    };
async function attachDataListeners(collectionsToWatch, main = false) {
    if (!collectionsToWatch || collectionsToWatch.length === 0) {
        return;
    }
    if (!navigator.onLine) {
        showAlert('You are offline. Data may be outdated.', 'warning');
    }

    collectionsToWatch.forEach(name => {
        if (activeListeners[name] && dataLoadStatus[name]) {
            return;
        }

        const config = collectionMap[name];
        if (!config) {
            console.warn(`No configuration found for collection: ${name}.`);
            if (collectionLoadPromises[name] && collectionLoadPromises[name].resolve) {
                collectionLoadPromises[name].resolve();
            }
            return;
        }

        if (activeListeners[name]) {
            activeListeners[name]();
            delete activeListeners[name];
        }

        let queriesToExecuteForCollection = [];
        const collectionsWithSingleDivisionField = ['students','syllabusCompletion', 'studentFeeSetups'];
        const collectionsWithDivisionArrayField = ['chapters','syllabuses'];

        if (currentUserRole === 'teacher' && (collectionsWithSingleDivisionField.includes(name) || collectionsWithDivisionArrayField.includes(name))) {
            if (teacherAssignedClasses.length > 0) {
                teacherAssignedClasses.forEach(({ classId, division }) => {
                    let currentQuery;
                    const isFeeCollection = name === 'studentFeeSetups';
                    const baseRef = isFeeCollection ? getFeeCollectionRef(activeFinancialYear, name) : getCollectionRef(name);

                    if (collectionsWithSingleDivisionField.includes(name)) {
                        currentQuery = query(baseRef, where('classId', '==', classId), where('division', '==', division));
                    } else if (collectionsWithDivisionArrayField.includes(name)) {
                        currentQuery = query(baseRef, where('classId', '==', classId), where('appliesToDivisions', 'array-contains', division));
                    }
                    if (currentQuery) {
                        queriesToExecuteForCollection.push({ key: `${name}_${classId}_${division}`, query: currentQuery });
                    }
                });
            } else {
                queriesToExecuteForCollection.push({ key: `${name}_empty`, query: query(getCollectionRef(name), where('nonExistentField', '==', 'impossibleValue')) });
            }
        } else {
            const isFeeCollection = ['receipts', 'feeStructures', 'studentFeeSetups'].includes(name);
            queriesToExecuteForCollection.push({ key: `${name}_all`, query: isFeeCollection ? getFeeCollectionRef(activeFinancialYear, name) : getCollectionRef(name) });
        }

        let collectedData = {};
        let queriesCompletedInitialSnapshot = 0;
        let expectedInitialSnapshots = queriesToExecuteForCollection.length;

        // If for some reason there are no queries, we must resolve the promise immediately.
        if (expectedInitialSnapshots === 0) {
            dataLoadStatus[name] = true;
            if (collectionLoadPromises[name] && collectionLoadPromises[name].resolve) {
                collectionLoadPromises[name].resolve();
            }
            return;
        }

        const currentCollectionUnsubs = [];

        queriesToExecuteForCollection.forEach(qInfo => {
            const unsub = onSnapshot(qInfo.query, async snapshot => {

                // --- FIX: Handle initial load status immediately ---
                // This block now runs first, ensuring that even an empty initial snapshot
                // signals that the query has completed its first run.
                if (!dataLoadStatus[name]) {
                    queriesCompletedInitialSnapshot++;
                    if (queriesCompletedInitialSnapshot >= expectedInitialSnapshots) {
                        dataLoadStatus[name] = true;
                        if (collectionLoadPromises[name] && collectionLoadPromises[name].resolve) {
                            collectionLoadPromises[name].resolve();
                            console.log(`âœ… Promise resolved for '${name}' after initial load.`);
                        }
                    }
                }
                // --- END OF FIX ---

                const changes = snapshot.docChanges();

                // It's still efficient to stop if there are no data changes to process.
                // The crucial promise logic above has already run.
                if (changes.length === 0) {
                    // Even with no changes, we might need to update the UI (e.g., from a loading state to "No data found").
                    // So we'll update the global state and re-render.
                    config.setter(Object.values(collectedData));
                    if (config.renderer) config.renderer();
                    return;
                }

                const toAddOrUpdate = [];
                const toDelete = [];

                changes.forEach(change => {
                    const docData = { id: change.doc.id, ...change.doc.data() };
                    if (change.type === "added" || change.type === "modified") {
                        collectedData[change.doc.id] = docData;
                        toAddOrUpdate.push(docData);
                    } else if (change.type === "removed") {
                        delete collectedData[change.doc.id];
                        toDelete.push(change.doc.id);
                    }
                });

                config.setter(Object.values(collectedData));

                try {
                    const store = appDb[name];
                    await appDb.transaction('rw', store, async () => {
                        if (toDelete.length > 0) await store.bulkDelete(toDelete);
                        if (toAddOrUpdate.length > 0) await store.bulkPut(toAddOrUpdate);
                    });
                } catch (error) {
                    console.error(`Error applying incremental updates to ${name}:`, error);
                }

                if (config.renderer) {
                    config.renderer();
                }

            }, (error) => {
                console.error(`[Firestore] Error listening to ${name} (query ${qInfo.key}): `, error);
                // Also handle promise resolution on error to prevent hangs
                if (!dataLoadStatus[name]) {
                    queriesCompletedInitialSnapshot++;
                    if (queriesCompletedInitialSnapshot >= expectedInitialSnapshots) {
                        dataLoadStatus[name] = true;
                        if (collectionLoadPromises[name] && collectionLoadPromises[name].resolve) {
                            collectionLoadPromises[name].resolve();
                        }
                    }
                }
            });
            currentCollectionUnsubs.push(unsub);
        });
        activeListeners[name] = () => currentCollectionUnsubs.forEach(unsub => unsub());
    });
}




/**
 * Attaches a Firestore listener that fetches marks for only one specific class and division.
 * It detaches any previous marks listener before creating a new one.
 * @param {string} classId - The ID of the class to fetch marks for.
 * @param {string} division - The division to fetch marks for.
 */

 function setupInitialMarksListeners() {
    let classDataArray = [];

    if (currentUserRole === 'teacher') {
        // Get all class/division allocations for this teacher
        const teacherAllocations = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id);
        const uniquePairs = new Set();

        teacherAllocations.forEach(({ classId, division }) => {
            const key = `${classId}_${division}`;
            if (!uniquePairs.has(key)) {
                uniquePairs.add(key);
                classDataArray.push({ classId, division });
            }
        });

    } else if (currentUserRole === 'student') {
        if (selectedUser?.classId && selectedUser?.division) {
            classDataArray.push({
                classId: selectedUser.classId,
                division: selectedUser.division
            });
        }

    } else if (currentUserRole === 'admin') {
        // Admin: all classes/divisions
        classDataArray = classes.flatMap(cls =>
            cls.divisions.map(division => ({
                classId: cls.id,
                division
            }))
        );
    }

    // Attach listeners without examId (null)
    attachMarksListener(null, classDataArray);
}

// --- In your <script type="module"> block ---
// REPLACE your syncDataForUser function with this one

function syncDataForUser() {
    // Detach any previous marks listeners to prevent duplicates
    Object.values(activeMarksListeners).forEach(unsub => unsub());
    activeMarksListeners = {};

    let queriesToRun = [];

    // 1. Determine the scope based on the user role (this logic remains the same)
    if (currentUserRole === 'admin') {
        queriesToRun.push({ key: 'all_marks', query: getCollectionRef('marks') });
    } else if (currentUserRole === 'teacher') {
        const uniqueClassKeys = [...new Set(classroomSubjects.filter(cs => cs.teacherId === selectedUser.id).map(a => `${a.classId}|${a.division}`))];
        uniqueClassKeys.forEach(key => {
            const [classId, division] = key.split('|');
            queriesToRun.push({
                key: `${classId}_${division}`,
                query: query(getCollectionRef('marks'), where('classId', '==', classId), where('division', '==', division))
            });
        });
    } else if (currentUserRole === 'student') {
        queriesToRun.push({
            key: `student_${selectedUser.id}`,
            query: query(getCollectionRef('marks'), where('studentId', '==', selectedUser.id))
        });
    }

    // 2. Execute queries and attach listeners that sync with IndexedDB
    queriesToRun.forEach(qInfo => {
        if (!activeMarksListeners[qInfo.key]) {
            const unsubscribe = onSnapshot(qInfo.query, async (snapshot) => {
                const changes = snapshot.docChanges();
                if (changes.length === 0) return;

                // Prepare arrays for batch operations
                const toAddOrUpdate = [];
                const toDelete = [];

                changes.forEach(change => {
                    const docData = { id: change.doc.id, ...change.doc.data() };
                    if (change.type === "removed") {
                        delete marks[change.doc.id]; // Update in-memory object
                        toDelete.push(change.doc.id); // Add ID to delete array for DB
                    } else {
                        marks[change.doc.id] = docData; // Update in-memory object
                        toAddOrUpdate.push(docData);    // Add full object for DB
                    }
                });

                // --- Perform efficient batch database operations ---
                try {
                    if (toAddOrUpdate.length > 0) {
                        await appDb.marks.bulkPut(toAddOrUpdate);
                        console.log(`[Sync] ${toAddOrUpdate.length} mark(s) saved to IndexedDB.`);
                    }
                    if (toDelete.length > 0) {
                        await appDb.marks.bulkDelete(toDelete);
                        console.log(`[Sync] ${toDelete.length} mark(s) removed from IndexedDB.`);
                    }
                } catch (error) {
                    console.error('Error updating marks in IndexedDB:', error);
                }

            }, (error) => {
                console.error(`[Firestore] Error listening to marks for ${qInfo.key}:`, error);
            });
            if (collectionLoadPromises[name] && collectionLoadPromises[name].resolve) {
                collectionLoadPromises[name].resolve();
            }
            activeMarksListeners[qInfo.key] = unsubscribe;
        }
    });
}

/**
 * Attaches a Firestore listener for marks data, syncing changes in real-time
 * to both the in-memory 'marks' object and the 'marks' table in IndexedDB.
 * @param {string} examId
 * @param {string} classId
 * @param {string} division
 * @param {string|null} refresh - If not null, forces the listener to re-attach.
 */
function attachMarksListener(examId, classId, division, refresh = null) {
    if (!classId || !division) {
        return;
    }

    const listenerKey = `${classId}_${division}}`;

    if (activeMarksListeners[listenerKey] && refresh === null) {
        generateExamWiseResultsTable(examId, classId, division);
        return;
    }

    // --- Bug Fix: Correctly constructed queries ---
    let marksQuery;
    if (examId && classId && division) {
        marksQuery = query(getCollectionRef('marks'),
            where('classId', '==', classId),
            where('division', '==', division)
        );
    } else { // This covers cases with only class/division
        marksQuery = query(getCollectionRef('marks'),
            where('classId', '==', classId),
            where('division', '==', division)
        );
    }

    const unsubscribe = onSnapshot(marksQuery, async (snapshot) => {
        const changes = snapshot.docChanges();
        if (changes.length === 0) {
            // Even if no data changes, re-render in case the UI needs an update
            generateExamWiseResultsTable(examId, classId, division);
            return;
        }

        // --- MODIFICATION: Prepare for batch IndexedDB operations ---
        const toAddOrUpdate = [];
        const toDelete = [];

        changes.forEach(change => {
            const docData = { id: change.doc.id, ...change.doc.data() };
            if (change.type === "removed") {
                delete marks[change.doc.id]; // Update in-memory object
                toDelete.push(change.doc.id); // Add ID to delete array
            } else { // "added" or "modified"
                marks[change.doc.id] = docData; // Update in-memory object
                toAddOrUpdate.push(docData);    // Add full object to update array
            }
        });

        // --- MODIFICATION: Save changes to IndexedDB ---
        try {
            if (toAddOrUpdate.length > 0) {
                await appDb.marks.bulkPut(toAddOrUpdate);
            }
            if (toDelete.length > 0) {
                await appDb.marks.bulkDelete(toDelete);
            }
        } catch (error) {
            console.error('Error syncing marks to IndexedDB:', error);
            showAlert('Failed to save marks data locally.', 'danger');
        }
        
        // After data arrives or updates, re-render the results table
        generateExamWiseResultsTable(examId, classId, division);

    }, (error) => {
        console.error(`[Firestore] Error listening to marks for ${listenerKey}: `, error);
    });

    // Store the new unsubscribe function
    activeMarksListeners[listenerKey] = unsubscribe;
}




function attachMarksListenerarray(examId, classDataArray = []) {
    // If no classDataArray is provided, fallback to selected class/division
    if (!Array.isArray(classDataArray) || classDataArray.length === 0) {
        const classId = selectedUser?.classId || null;
        const division = selectedUser?.division || null;
        if (classId && division) {
            classDataArray = [{ classId, division }];
        } else {
            console.warn('attachMarksListener: No valid class/division available.');
            return;
        }
    }

    classDataArray.forEach(({ classId, division }) => {
        const listenerKey = `${classId}_${division}`;

        if (activeMarksListeners[listenerKey]) {
            // Already listening for this combination, re-render if needed
            generateExamWiseResultsTable(examId,classId, division);
            return;
        }

        // Create Firestore query
        let marksQuery;
        if (examId) {
            marksQuery = query(
                getCollectionRef('marks'),
                where('examId', '==', examId),
                where('classId', '==', classId),
                where('division', '==', division)
            );
        } else {
            marksQuery = query(
                getCollectionRef('marks'),
                where('classId', '==', classId),
                where('division', '==', division)
            );
        }

        const unsubscribe = onSnapshot(marksQuery, (snapshot) => {
            snapshot.docChanges().forEach(change => {
                if (change.type === "removed") {
                    delete marks[change.doc.id];
                } else {
                    marks[change.doc.id] = { id: change.doc.id, ...change.doc.data() };
                }
            });

            generateExamWiseResultsTable(examId, classId, division);
        }, (error) => {
            console.error(`[Firestore] Error listening to marks for ${listenerKey}:`, error);
        });

        activeMarksListeners[listenerKey] = unsubscribe;
    });
}



function unsubscribeAllListeners() {
    // Unsubscribe from general listeners
    for (const key in activeListeners) {
        if (typeof activeListeners[key] === 'function') {
            activeListeners[key]();
        }
    }
    activeListeners = {};

    // --- NEW: Also unsubscribe from all active marks listeners ---
    for (const key in activeMarksListeners) {
        if (typeof activeMarksListeners[key] === 'function') {
            activeMarksListeners[key]();
        }
    }
    activeMarksListeners = {};
}

function attachFeeDataListeners(financialYear, role, user) {
    if (unsubscribeFeeListeners.length > 0) {
        unsubscribeFeeListeners.forEach(unsub => unsub());
        unsubscribeFeeListeners = [];
    }

    let collectionsToWatch = {
        feeStructures: data => feeStructures = data,
    };

    switch (role) {
        case 'admin':
            Object.assign(collectionsToWatch, {
                studentFeeSetups: data => studentFeeSetups = data,
                receipts: data => receipts = data,
            });
            break;
        case 'teacher':
            // For simplicity, teachers will get all setups and receipts and filter on the client.
            // This can be optimized with more complex queries if performance becomes an issue.
            Object.assign(collectionsToWatch, {
                studentFeeSetups: data => studentFeeSetups = data,
                receipts: data => receipts = data,
            });
            break;
        case 'student':
            // For student, we can listen to specific documents.
            // This is more efficient.
            const sfsRef = getFeeDocRef(financialYear, 'studentFeeSetups', user.id);
            const unsubSfs = onSnapshot(sfsRef, (doc) => {
                if (doc.exists()) {
                    // Update or add the single student's fee setup
                    const existingIndex = studentFeeSetups.findIndex(s => s.id === user.id);
                    if (existingIndex > -1) {
                        studentFeeSetups[existingIndex] = { id: doc.id, ...doc.data() };
                    } else {
                        studentFeeSetups.push({ id: doc.id, ...doc.data() });
                    }
                }
            });
            unsubscribeFeeListeners.push(unsubSfs);

            const receiptsQuery = query(getFeeCollectionRef(financialYear, 'receipts'), where('studentId', '==', user.id));
            const unsubReceipts = onSnapshot(receiptsQuery, (snapshot) => {
                receipts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });
            unsubscribeFeeListeners.push(unsubReceipts);
            break;
    }

    // Handle collections that are common or need full data for all roles
    for (const [collName, setter] of Object.entries(collectionsToWatch)) {
        const collRef = getFeeCollectionRef(financialYear, collName);
        const unsub = onSnapshot(collRef, snapshot => {
            setter(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            // Re-render the active fee tab if it's open
            console.log()
            const activeFeeTab = document.querySelector('#fee-main-tab .nav-link.active')?.dataset.subtab;
            if (activeFeeTab) {
                renderFeeSubTab(activeFeeTab);
            }
        });
        unsubscribeFeeListeners.push(unsub);
    }
}



        function renderSidebar(navItems) {
    sidebarNav.innerHTML = navItems.map(item => `<a href="#${item.id}" id="nav-${item.id}" class="nav-link text-dark"><i class="fas ${item.icon} me-2"></i>${item.text}</a>`).join('');
    navItems.forEach(item => {
        document.getElementById(`nav-${item.id}`).addEventListener('click', e => { 
            e.preventDefault(); 
            if (item.id === 'add-student') studentToEdit = null;
            navigateTo(item.id); 
        });
    });
}

// REPLACE your existing navigateTo function with this optimized version

async function navigateTo(viewId, pushState = true) {
    currentViewId = viewId; // <-- ADD THIS LINE to track the active view
    const mainContent = document.getElementById('main-content');
    if (!mainContent) return;

    // 1. Show a loading spinner for better user experience
    mainContent.innerHTML = `
        <div class="d-flex justify-content-center align-items-center" style="height: 80vh;">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    `;

    // Update sidebar active link and browser history
    document.querySelectorAll('#sidebar-nav .nav-link').forEach(link => link.classList.remove('active'));
    const navLink = document.getElementById(`nav-${viewId}`);
    if (navLink) navLink.classList.add('active');
    if (pushState) history.pushState({ viewId }, viewId, `#${viewId}`);

    const collectionsToCache = viewDependencies[viewId] || [];

    try {
        // This creates an array of promises, but does NOT wait for them.
        const dataPromises = collectionsToCache.map(name => getData(name));
    
    // 1. Capture the results from all promises (this is correct)
    const resolvedDataArray = await Promise.all(dataPromises);

    // 2. Loop through the results and use your 'collectionMap' setter to update the correct variable
    collectionsToCache.forEach((name, index) => {
        const data = resolvedDataArray[index]; // Get the data for the current collection
        const config = collectionMap[name];   // <-- Get the config for this collection
        
        if (data && config && config.setter) {
            config.setter(data); // <-- Use the setter to update the correct variable directly!
            console.log(`Successfully cached '${name}' with ${Array.isArray(data) ? data.length : 1} records.`);
        }
    });
    
    // Now you can safely call functions that depend on this data
    updateTeacherAssignedClasses();
    showAlert('Data sync complete!', 'success');

        // This code will ONLY run after all data is fetched and assigned.
        console.log("All data loaded. Ready to render.");
        console.log("Students array now contains:",students); // Now it will have data

        // Now, it is safe to render the view.
        const renderFunc = window.viewRenderers[viewId];
        if (renderFunc) {
            renderFunc();
        } else {
            mainContent.innerHTML = `<p>UI under construction or renderer not found.</p>`;
        }

    } catch (error) {
        console.error(`Failed to load data for view ${viewId}:`, error);
        mainContent.innerHTML = `<div class="alert alert-danger">Failed to load data.</div>`;
    }


    // Hide mobile sidebar if it's open
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    if (sidebar && sidebar.classList.contains('show')) {
        sidebar.classList.remove('show');
        sidebarOverlay.classList.remove('show');
        document.body.style.overflow = '';
    }
}
    function attachAdminDataListeners(collectionsToWatch) {
    collectionsToWatch.forEach(name => {
        if (!activeListeners[name]) {
            const unsub = onSnapshot(getCollectionRef(name), (snapshot) => {
                const dataObject = {};
                snapshot.docs.forEach(doc => {
                    dataObject[doc.id] = { id: doc.id, ...doc.data() };
                });
                window[name] = dataObject;
            });
            activeListeners[name] = unsub;
        }
    });
}


        
        // Find your existing showMainApp function and modify it like this:

function showMainApp() {
    document.getElementById('login-screen').classList.remove('active');
    document.getElementById('main-app').classList.add('active');
    const panelTitle = document.getElementById('panel-title');

    let navItems;
    if (currentUserRole === 'admin') {
        navItems = adminNav;
        panelTitle.textContent = "Admin Panel";
    } else if (currentUserRole === 'student') {
        navItems = studentNav;
        panelTitle.textContent = "Student Portal";
    } else if (currentUserRole === 'teacher') {
        let dynamicTeacherNav = teacherNav.filter(item =>
            item.id !== 'library-mgt' && item.id !== 'library-status' 
        );

        if (selectedUser.roles && selectedUser.roles.includes('librarian')) {
            dynamicTeacherNav.push({ id: 'library-mgt', icon: 'fa-book-reader', text: 'Library Management' });
        } else if (selectedUser.classCharge) {
            dynamicTeacherNav.push({ id: 'library-status', icon: 'fa-books', text: 'Library Status' });
        }
        
        if (selectedUser.roles && selectedUser.roles.includes('exam_controller')) {
            dynamicTeacherNav.push(
               { id: 'exam-mgt', icon: 'fa-file-signature', text: 'Mark Entry' }, // Existing mark entry
                { id: 'exam-control', icon: 'fa-clipboard-check', text: 'Exam Control' } // New Exam Control
             );
        }
        if (selectedUser.roles && selectedUser.roles.includes('festmgr')) {
            dynamicTeacherNav.push(
               { id: 'fest-mgt', icon: 'fa-trophy', text: 'Fest Management' } // Existing mark entry
             );
        }
        
        navItems = dynamicTeacherNav;
        panelTitle.textContent = "Teacher Panel";
    }

    renderSidebar(navItems);

    // REMOVED the navigation logic from here.
    // const initialViewId = 'dashboard';
    // history.replaceState({ viewId: initialViewId }, initialViewId, `#${initialViewId}`);
    // navigateTo(initialViewId, false);
}


        
        async function initializeAppAndAuth() {
            //document.getElementById('loading-spinner').classList.remove('d-none');
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                        // ---> ADD THIS LOGIC HERE <---
        const inDataEntryMode = await checkForDataEntryMode();
        if (inDataEntryMode) {
            return; // Stop normal app execution if in data entry mode
        }
                // attachMainDataListeners();
             attachFeeDataListeners(activeFinancialYear);
                // document.getElementById('loading-spinner').style.display = 'none';
            document.getElementById('login-screen').classList.add('active');
            } catch (error) {
                //document.getElementById('loading-spinner').innerHTML = "Initialization Failed. Check Console.";
                console.error("Firebase Init Error:", error);
            }
        }
        
        document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    // Get the submit button from the form that triggered the event
    const submitButton = e.target.querySelector('button[type="submit"]');
    if (!submitButton) return; // Exit if the button isn't found

    // Store the button's original content and disable it
    const originalButtonHtml = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Signing In...`;

    try {
        const activeRole = document.querySelector('#loginTab .nav-link.active').getAttribute('data-bs-target').replace('#', '').replace('-login-view', '');

        if (!navigator.onLine) {
            showAlert('You are offline. Please connect to the internet to log in.', 'danger');
            return; // Early exit, 'finally' will still run
        }

        if (activeRole === 'admin') {
            const email = document.getElementById('admin-user').value.toLowerCase();
            const password = document.getElementById('admin-pass').value;

            if (!email || !password) {
                showAlert('Please enter admin email and password.', 'danger');
                return;
            }

            const q = query(getCollectionRef('teachers'), where('email', '==', email));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                showAlert('Admin user not found in the database.', 'danger');
            } else {
                const adminDoc = querySnapshot.docs[0];
                const adminData = { id: adminDoc.id, ...adminDoc.data() };

                if (adminData.role === 'admin') {
                    if (password === (adminData.mobile || '').slice(-5)) {
                        onLoginSuccess('admin', adminData);
                    } else {
                        showAlert('Incorrect password for admin.', 'danger');
                    }
                } else {
                    showAlert('This user does not have admin privileges.', 'danger');
                }
            }
            //onLoginSuccess('admin', selectedUser);
        } else if (activeRole === 'teacher') {
            const email = document.getElementById('teacher-useremail').value.toLowerCase();
            const password = document.getElementById('teacher-password').value;
            if (!email || !password) {
                showAlert('Please enter email and password.', 'danger');
                return;
            }
            
            const q = query(getCollectionRef('teachers'), where('email', '==', email));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                showAlert('Teacher email not found.', 'danger');
            } else {
                const teacherDoc = querySnapshot.docs[0];
                const teacherData = { id: teacherDoc.id, ...teacherDoc.data() };
                if (password === (teacherData.mobile || '').slice(-5)) {
                    onLoginSuccess('teacher', teacherData);
                } else {
                    showAlert('Incorrect password for teacher.', 'danger');
                }
            }
        } else if (activeRole === 'student') {
            const admnNoSuffix = document.getElementById('student-admn').value.toUpperCase();
            const dobYear = document.getElementById('student-dob').value;
            if (!admnNoSuffix || !dobYear) {
                showAlert('Please enter Admission No. and Year of Birth.', 'danger');
                return;
            }

            const studentsSnapshot = await getDocs(getCollectionRef('students'));
            let foundStudent = null;
            studentsSnapshot.forEach(doc => {
                const studentData = doc.data();
                if (studentData.admissionNumber && studentData.admissionNumber.toUpperCase().endsWith(admnNoSuffix)) {
                    foundStudent = { id: doc.id, ...studentData };
                }
            });

            if (foundStudent) {
                const studentDobYear = (foundStudent.dob || '').split('-')[0];
                if (dobYear === studentDobYear) {
                    onLoginSuccess('student', foundStudent);
                } else {
                    showAlert('Incorrect year of birth.', 'danger');
                }
            } else {
                showAlert('Student admission number not found.', 'danger');
            }
        }
    } finally {
        // This block runs whether the login succeeds or fails,
        // ensuring the button is always restored to its original state.
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonHtml;
    }
});
document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitButton = e.target.querySelector('button[type="submit"]');
    if (!submitButton) return;

    const originalButtonHtml = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Signing In...`;

    try {
        const activeRole = document.querySelector('#loginTab .nav-link.active').getAttribute('data-bs-target').replace('#', '').replace('-login-view', '');

        if (activeRole === 'teacher') {
            const email = document.getElementById('teacher-useremail').value.toLowerCase();
            const password = document.getElementById('teacher-password').value;
            if (!email || !password) {
                showAlert('Please enter email and password.', 'danger');
                return; // Early exit
            }

            // 1. --- ALWAYS TRY LOCAL DB FIRST ---
            const localTeacher = await appDb.teachers.where('email').equalsIgnoreCase(email).first();

            if (localTeacher && password === (localTeacher.mobile || '').slice(-5)) {
                // 2. --- LOCAL LOGIN SUCCESS ---
                showAlert('Logged in successfully from local cache.', 'success');
                onLoginSuccess('teacher', localTeacher);
                return; // Login successful, stop here.
            }

            // 3. --- LOCAL LOGIN FAILED, CHECK IF ONLINE TO TRY SERVER ---
            if (!navigator.onLine) {
                showAlert('Offline login failed. Credentials do not match cached data.', 'danger');
                return; // Definitive failure if offline.
            }

            // 4. --- TRY SERVER (FIREBASE) AS FALLBACK ---
            const q = query(getCollectionRef('teachers'), where('email', '==', email));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                showAlert('Teacher email not found on the server.', 'danger');
            } else {
                const teacherDoc = querySnapshot.docs[0];
                const teacherData = { id: teacherDoc.id, ...teacherDoc.data() };
                if (password === (teacherData.mobile || '').slice(-5)) {
                    // 5. --- SERVER LOGIN SUCCESS & CACHE UPDATE ---
                    await appDb.teachers.put(teacherData); // Update local DB for next time
                    showAlert('Logged in successfully from server.', 'success');
                    onLoginSuccess('teacher', teacherData);
                } else {
                    showAlert('Incorrect password.', 'danger');
                }
            }
        } else if (activeRole === 'student') {
            const admnNoSuffix = document.getElementById('student-admn').value.toUpperCase();
            const dobYear = document.getElementById('student-dob').value;
            if (!admnNoSuffix || !dobYear) {
                showAlert('Please enter Admission No. and Year of Birth.', 'danger');
                return;
            }
            
            // 1. --- ALWAYS TRY LOCAL DB FIRST ---
            const localStudent = await appDb.students.where('admissionNumber').endsWithIgnoreCase(admnNoSuffix).first();

            if (localStudent && dobYear === (localStudent.dob || '').split('-')[0]) {
                // 2. --- LOCAL LOGIN SUCCESS ---
                showAlert('Logged in successfully from local cache.', 'success');
                onLoginSuccess('student', localStudent);
                return; // Login successful, stop here.
            }

            // 3. --- LOCAL LOGIN FAILED, CHECK IF ONLINE TO TRY SERVER ---
            if (!navigator.onLine) {
                showAlert('Offline login failed. Credentials do not match cached data.', 'danger');
                return; // Definitive failure if offline.
            }

            // 4. --- TRY SERVER (FIREBASE) AS FALLBACK ---
            const studentsSnapshot = await getDocs(getCollectionRef('students'));
            let foundStudent = null;
            studentsSnapshot.forEach(doc => {
                const studentData = doc.data();
                if (studentData.admissionNumber && studentData.admissionNumber.toUpperCase().endsWith(admnNoSuffix)) {
                    foundStudent = { id: doc.id, ...studentData };
                }
            });
            
            if (foundStudent) {
                if (dobYear === (foundStudent.dob || '').split('-')[0]) {
                    // 5. --- SERVER LOGIN SUCCESS & CACHE UPDATE ---
                    await appDb.students.put(foundStudent); // Update local DB for next time
                    showAlert('Logged in successfully from server.', 'success');
                    onLoginSuccess('student', foundStudent);
                } else {
                    showAlert('Incorrect year of birth.', 'danger');
                }
            } else {
                showAlert('Student admission number not found on the server.', 'danger');
            }
        } // Find the admin login block in your script and REPLACE it with this

else if (activeRole === 'admin') {
    const email = document.getElementById('admin-user').value.toLowerCase();
    const password = document.getElementById('admin-pass').value;
    if (!email || !password) {
        showAlert('Please enter admin email and password.', 'danger');
        return; // Early exit
    }

    // 1. --- ALWAYS TRY LOCAL DB FIRST ---
    const localAdmin = await appDb.teachers.where('email').equalsIgnoreCase(email).first();

    if (localAdmin && localAdmin.role === 'admin' && password === (localAdmin.mobile || '').slice(-5)) {
        // 2. --- LOCAL LOGIN SUCCESS ---
        // The user was found in the local cache, is an admin, and the password matches.
        showAlert('Logged in as Admin from local cache.', 'success');
        onLoginSuccess('admin', localAdmin);
        return; // Login successful, stop here.
    }

    // 3. --- LOCAL LOGIN FAILED, CHECK IF ONLINE TO TRY SERVER ---
    if (!navigator.onLine) {
        showAlert('Offline admin login failed. Credentials do not match cached data.', 'danger');
        return; // Definitive failure if offline.
    }

    // 4. --- TRY SERVER (FIREBASE) AS FALLBACK ---
    showAlert('Checking server for admin credentials...', 'info');
    const q = query(getCollectionRef('teachers'), where('email', '==', email));
    const querySnapshot = await getDocs(q);

    if (querySnapshot.empty) {
        showAlert('Admin user not found in the database.', 'danger');
    } else {
        const adminDoc = querySnapshot.docs[0];
        const adminData = { id: adminDoc.id, ...adminDoc.data() };

        if (adminData.role === 'admin') {
            if (password === (adminData.mobile || '').slice(-5)) {
                // 1. Unsubscribe from all active Firestore listeners to stop data syncing
    unsubscribeAllListeners();

    // 2. Clear all data from every table in your IndexedDB database
    try {
        const clearPromises = appDb.tables.map(table => table.clear());
        await Promise.all(clearPromises);
        console.log('IndexedDB has been cleared successfully.');
    } catch (error) {
        console.error('Failed to clear IndexedDB:', error);
        showAlert('Could not clear local data.', 'danger');
    }
                onLoginSuccess('admin', adminData);
            } else {
                showAlert('Incorrect password for admin.', 'danger');
            }
        } else {
            showAlert('This user does not have admin privileges.', 'danger');
        }
    }
}
    } finally {
        // This block always runs, ensuring the button is restored
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonHtml;
    }
});


        document.getElementById('logout-btn').addEventListener('click', async () => {
    // 1. Unsubscribe from all active Firestore listeners to stop data syncing
    unsubscribeAllListeners();

    // 2. Destroy any active charts to prevent memory leaks
    if(window.attendanceChart) { 
        window.attendanceChart.destroy(); 
        window.attendanceChart = null; 
    }
    // (Destroy any other charts here as well)

    try {
        // --- THIS IS THE KEY CHANGE ---
        // 3. Close the active connection to the database. This is essential, especially on mobile.
        console.log('Closing IndexedDB connection...');
        appDb.close();

        // 4. Delete the entire 'SchoolAppDB' database and wait for it to complete.
        console.log('Deleting IndexedDB database...');
        await Dexie.delete('SchoolAppDB'); // Use Dexie's static delete method
        console.log('IndexedDB database has been deleted successfully.');

        // 5. After deletion is successful, update the UI and reload for a fresh start.
        document.getElementById('main-app').classList.remove('active');
        document.getElementById('login-screen').classList.add('active');
        window.location.reload();

    } catch (error) {
        console.error('Failed to delete IndexedDB:', error);
        showAlert('Error during logout. You may need to clear your browser cache manually.', 'danger');
        
        // As a fallback, still try to log the user out visually
        document.getElementById('main-app').classList.remove('active');
        document.getElementById('login-screen').classList.add('active');
    }
});

        // --- DASHBOARD ---
        window.renderDashboard = async () => {
            if (attendanceChart) {
                attendanceChart.destroy();
                attendanceChart = null;
            }
            let content = '';
            if (currentUserRole === 'admin') {
                console.log(window.students);
                content = `<h1 class="h2 mb-4">Admin Dashboard</h1>
                <div class="row">
                    <div class="col-xl-3 col-md-6 mb-4"><div class="card border-start-primary shadow h-100 py-2"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-primary text-uppercase mb-1">Students</div><div class="h5 mb-0 fw-bold text-gray-800">${students.length}</div></div><div class="col-auto"><i class="fas fa-users fa-2x text-body-tertiary"></i></div></div></div></div></div>
                    <div class="col-xl-3 col-md-6 mb-4"><div class="card border-start-success shadow h-100 py-2"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-success text-uppercase mb-1">Teachers</div><div class="h5 mb-0 fw-bold text-gray-800">${teachers.length}</div></div><div class="col-auto"><i class="fas fa-chalkboard-teacher fa-2x text-body-tertiary"></i></div></div></div></div></div>
                    <div class="col-xl-3 col-md-6 mb-4"><div class="card border-start-info shadow h-100 py-2"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-info text-uppercase mb-1">Classes</div><div class="h5 mb-0 fw-bold text-gray-800">${classes.length}</div></div><div class="col-auto"><i class="fas fa-school fa-2x text-body-tertiary"></i></div></div></div></div></div>
                    <div class="col-xl-3 col-md-6 mb-4"><div class="card border-start-warning shadow h-100 py-2"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-warning text-uppercase mb-1">Subjects</div><div class="h5 mb-0 fw-bold text-gray-800">${subjects.length}</div></div><div class="col-auto"><i class="fas fa-book fa-2x text-body-tertiary"></i></div></div></div></div></div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header fw-bold text-primary">This Month's School-wide Absentees</div>
                            <div class="card-body">
                                <canvas id="admin-attendance-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>`;
                mainContent.innerHTML = content;
                updateAllNotifications();
                renderAdminAttendanceChart();
            } else if (currentUserRole === 'teacher') {
    const chargeText = selectedUser.classCharge?.classId ? `${classes.find(c => c.id === selectedUser.classCharge.classId)?.name || ''} - ${selectedUser.classCharge.division}` : 'None';
    const subjectsTaught = classroomSubjects
        .filter(cs => cs.teacherId === selectedUser.id)
        .map(cs => {
            const subject = subjects.find(s => s.id === cs.subjectId);
            const aClass = classes.find(c => c.id === cs.classId); // Use 'aClass' to avoid conflict with 'class' keyword
            if (subject && aClass) {
                return `${subject.name} (${aClass.name} - ${cs.division})`;
            }
            return null; // Return null if subject or class isn't found
        })
        .filter(Boolean) // This will remove any null entries
        .join(', ');

    // --- NEW LOGIC START ---
    // Check for additional roles and create HTML to display them as badges
    let additionalRolesHtml = '';
    if (selectedUser.roles && selectedUser.roles.length > 0) {
        
        additionalRolesHtml = `<hr class="my-3"><p class="mb-2"><strong>Additional Roles:</strong></p>`;
        
        additionalRolesHtml += selectedUser.roles.map(role => {
            // Format the role name for display (e.g., 'exam_controller' -> 'Exam Controller')
            const prettyName = role.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase());
            
            // Assign a color based on the role for better visuals
            let badgeColor = 'bg-secondary';
            if (role.includes('exam_controller')) badgeColor = 'bg-info text-dark';
            if (role.includes('librarian')) badgeColor = 'bg-success';
            if (role.includes('fest')) badgeColor = 'bg-warning text-dark';
            
            return `<span class="badge ${badgeColor} me-1 fs-6">${prettyName}</span>`;
        }).join('');
    }
    // --- NEW LOGIC END ---

    content = `<h1 class="h2 mb-4">Welcome, ${selectedUser.name}!</h1>
    <div class="row">
        <div class="col-lg-7">
            <div class="card shadow mb-4">
                 <div class="card-header fw-bold text-primary">This Month's Class Absentee Trend</div>
                 <div class="card-body"><canvas id="teacher-attendance-chart"></canvas></div>
            </div>
        </div>
        <div class="col-lg-5">
             <div class="card shadow mb-4">
    <div class="card-header fw-bold text-danger">Absentees List</div>
    <div class="card-body">
        <label for="absentee-list-date-selector" class="form-label small">Select Date</label>
        <input type="date" id="absentee-list-date-selector" class="form-control mb-3">
        
        <div id="absentee-list-display"></div>
    </div>
</div>

             <div class="card shadow mb-4">
                 <div class="card-header fw-bold text-primary">My Responsibilities</div>
                 <div class="card-body">
                     <p><strong>Class Charge:</strong> ${chargeText}</p>
                     <p><strong>Subjects Taught:</strong> ${subjectsTaught || 'None'}</p>
                     
                     ${additionalRolesHtml}

                 </div>
             </div>
        </div>
    </div>`;
    mainContent.innerHTML = content;
    renderTeacherDashboardData();

            } else if (currentUserRole === 'student') {
                const className = classes.find(c => c.id === selectedUser.classId) ? `${classes.find(c => c.id === selectedUser.classId).name} - ${selectedUser.division}` : 'N/A';
                 const setup = studentFeeSetups.find(sfs => sfs.id === selectedUser.id);
const payments = receipts.filter(r => r.studentId === selectedUser.id && !r.isCancelled);
let totalPaid = payments.reduce((sum, p) => sum + p.totalAmount, 0);
const balance = setup ? (setup.totalPayable - totalPaid) : 0;

content = `<h1 class="h2 mb-4">Welcome, ${selectedUser.name}!</h1>
 <div class="row">
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">My Details</h6></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6"><p><strong>Admission No:</strong> ${selectedUser.admissionNumber}</p><p><strong>Class:</strong> ${className}</p></div>
                    <div class="col-md-6"><p><strong>Date of Birth:</strong> ${new Date(selectedUser.dob).toLocaleDateString()}</p><p><strong>Father's Name:</strong> ${selectedUser.fatherName || 'N/A'}</p></div>
                </div>
            </div>
        </div>
        <div class="card shadow mb-4">
            <div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">Fee Summary</h6></div>
            <div class="card-body">
                <p><strong>Total Payable:</strong> â‚¹ ${setup?.totalPayable.toFixed(2) || '0.00'}</p>
                <p><strong>Total Paid:</strong> â‚¹ ${totalPaid.toFixed(2)}</p>
                <p class="fw-bold"><strong>Balance Due:</strong> â‚¹ ${balance.toFixed(2)}</p>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
         <div class="card shadow mb-4">
             <div class="card-header fw-bold text-primary">This Month's Attendance</div>
             <div class="card-body" id="student-dashboard-calendar"></div>
        </div>
    </div>
 </div>`;
mainContent.innerHTML = content;

                 const today = new Date();
                 const monthYear = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
                 generateStudentCalendar(selectedUser.id, monthYear, 'student-dashboard-calendar', true);
                 updateAllNotifications();
            }
        };

        async function renderTeacherDashboardData() {
            //console.log('mythreestudents',await getData('students')); 
    // Using optional chaining (?.) to prevent a crash if the class is not found.
const charge = selectedUser.classCharge?.classId 
    ? `${classes.find(c => c.id === selectedUser.classCharge.classId)?.name || 'N/A'} - ${selectedUser.classCharge.division}` 
    : 'None';
    if (!charge) return;

    // --- RENDER THE NEW UI SHELL ---
    // The "Today's Absentees" card has been replaced with the new "Absentees List" card
    const listCardContainer = document.getElementById('today-absent-list')?.parentElement; // Find the card body's parent
    if (listCardContainer) {
        listCardContainer.innerHTML = `
            <div class="card-header fw-bold text-danger">Absentees List</div>
            <div class="card-body">
                <label for="absentee-list-date-selector" class="form-label small">Select Date</label>
                <input type="date" id="absentee-list-date-selector" class="form-control mb-3">
                <div id="absentee-list-display"></div>
            </div>
        `;
    }

    // --- ATTACH LISTENERS AND LOAD INITIAL DATA ---
    const dateSelector = document.getElementById('absentee-list-date-selector');
    if (dateSelector) {
        // Set the initial date to today
        const today = new Date();
        today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
        dateSelector.value = today.toISOString().slice(0, 10);

        // Load the absentee list for today
        displayAbsenteesForDate(dateSelector.value);

        // Add a listener to reload the list when the date changes
        dateSelector.addEventListener('change', () => {
            displayAbsenteesForDate(dateSelector.value);
        });
    }

    // --- RENDER THE CHART (This part remains the same) ---
    await renderTeacherAttendanceChart(charge);
    
    updateAllNotifications();
}
// --- SCHOOL DETAILS MODULE ---

/**
 * Renders the form for managing the school's core details.
 * This is the entry point for the "School Details" navigation item.
 */
/**
 * Renders the form for managing the school's core details, now including UPI fields.
 * This is the entry point for the "School Details" navigation item.
 */
window.renderSchoolDetailsModule = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }

    // Use the globally available 'schoolDetails' object to pre-fill the form
    const details = schoolDetails || {};

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">School Profile & Settings</h1>
        <div class="card shadow">
            <div class="card-header fw-bold text-primary">
                Manage School Information
            </div>
            <div class="card-body">
                <form id="school-details-form">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label for="school-name" class="form-label">School Name</label>
                                    <input type="text" id="school-name" class="form-control" value="${details.name || ''}" required>
                                </div>
                                <div class="col-md-12">
                                    <label for="school-address" class="form-label">Full Address</label>
                                    <textarea id="school-address" class="form-control" rows="3">${details.address || ''}</textarea>
                                </div>
                                <div class="col-md-6">
                                    <label for="school-phone" class="form-label">Phone Number</label>
                                    <input type="tel" id="school-phone" class="form-control" value="${details.phone || ''}">
                                </div>
                                <div class="col-md-6">
                                    <label for="school-email" class="form-label">Email Address</label>
                                    <input type="email" id="school-email" class="form-control" value="${details.email || ''}">
                                </div>
                                <div class="col-md-6">
                                    <label for="school-website" class="form-label">Website</label>
                                    <input type="url" id="school-website" class="form-control" value="${details.website || ''}">
                                </div>
                                <div class="col-md-6">
                                    <label for="school-affiliation" class="form-label">Affiliation No.</label>
                                    <input type="text" id="school-affiliation" class="form-control" value="${details.affiliation || ''}">
                                </div>
                                <div class="col-md-6">
                                    <label for="school-upi-id" class="form-label">School UPI ID</label>
                                    <input type="text" id="school-upi-id" class="form-control" value="${details.upiId || ''}" placeholder="e.g., schoolname@oksbi">
                                </div>
                                <div class="col-md-6">
                                    <label for="school-upi-payee-name" class="form-label">UPI Payee Name</label>
                                    <input type="text" id="school-upi-payee-name" class="form-control" value="${details.upiPayeeName || ''}" placeholder="e.g., KYHSS School Fees">
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <label class="form-label">School Logo</label>
                            <div class="text-center border rounded p-3">
                                <img id="logo-preview" src="${details.logoUrl || 'https://placehold.co/200x200/e9ecef/6c757d?text=No+Logo'}" alt="School Logo Preview" class="img-thumbnail mb-3" style="max-height: 200px;">
                                <input type="file" id="logo-upload-input" class="form-control" accept="image/png, image/jpeg">
                            </div>
                        </div>
                    </div>
                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-save me-2"></i>Save School Details
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;

    attachSchoolDetailsListeners();
};

/**
 * Attaches event listeners for the school details form, now including UPI fields.
 */
function attachSchoolDetailsListeners() {
    const form = document.getElementById('school-details-form');
    const logoInput = document.getElementById('logo-upload-input');
    const logoPreview = document.getElementById('logo-preview');
    let logoFile = null; // To hold the new logo file if one is chosen

    // Listener for logo file selection to update the preview
    logoInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
            logoFile = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                logoPreview.src = event.target.result;
            };
            reader.readAsDataURL(logoFile);
        }
    });

    // Listener for form submission
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const saveButton = form.querySelector('button[type="submit"]');
        const originalButtonHtml = saveButton.innerHTML;
        saveButton.disabled = true;
        saveButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...`;

        // We use a fixed document ID 'main-details' for the single school profile
        const docId = 'main-details';
        const detailsToSave = {
            id: docId,
            name: document.getElementById('school-name').value,
            address: document.getElementById('school-address').value,
            phone: document.getElementById('school-phone').value,
            email: document.getElementById('school-email').value,
            website: document.getElementById('school-website').value,
            affiliation: document.getElementById('school-affiliation').value,
            // UPI Fields Added Here
            upiId: document.getElementById('school-upi-id').value,
            upiPayeeName: document.getElementById('school-upi-payee-name').value,
            logoUrl: schoolDetails.logoUrl || '' // Start with the existing URL
        };

        try {
            // If a new logo was selected, upload it first
            if (logoFile) {
                showAlert('Uploading new logo...', 'info');
                // We can reuse the Drive upload function, giving it a generic name
                const uploadResult = await uploadPhotoToDrive(logoFile, 'school_logo');
                if (uploadResult && uploadResult.success) {
                    detailsToSave.logoUrl = uploadResult.fileUrl; // Update with the new URL
                    showAlert('Logo uploaded successfully!', 'success');
                } else {
                    throw new Error('Logo upload to Drive failed.');
                }
            }

            // Save all details to Firestore
            await setDoc(getDocRef('schoolDetails', docId), detailsToSave, { merge: true });
            showAlert('School details saved successfully!', 'success');

        } catch (error) {
            console.error('Error saving school details:', error);
            showAlert('Failed to save school details. Please try again.', 'danger');
        } finally {
            saveButton.disabled = false;
            saveButton.innerHTML = originalButtonHtml;
        }
    });
}
        // --- In your <script type="module"> block ---

async function renderAdminAttendanceChart() {
    const ctx = document.getElementById('admin-attendance-chart')?.getContext('2d');
    if (!ctx) return; // Exit if canvas not found

    const today = new Date();
    const monthYear = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
    const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
    const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
    const data = Array(daysInMonth).fill(0);

    // --- CHANGE 1: Fetch data using the cache-first getData function ---
    const monthData = await getData('attendance',monthYear);
    console.log(monthData);

    if (monthData) {
        // --- CHANGE 2: New logic to read "exceptions" ---
        for (const day in monthData) {
            // Ensure the key is a day number, not the 'id' field
            if (isNaN(parseInt(day))) continue;

            const dayIndex = parseInt(day) - 1;
            if (dayIndex >= 0 && dayIndex < daysInMonth) {
                const dayRecords = monthData[day]; // This contains all class records for the day
                let totalAbsenteesForDay = 0;

                // Loop through each class record for the day (e.g., "CLASS10-A", "CLASS10-B")
                for (const classKey in dayRecords) {
                    const classData = dayRecords[classKey];
                    if (classData.status === 'SUBMITTED' && classData.exceptions) {
                        // The number of absentees is the number of keys in the exceptions object
                        totalAbsenteesForDay += Object.keys(classData.exceptions).length;
                    }
                }
                data[dayIndex] = totalAbsenteesForDay;
            }
        }
    }

    if (attendanceChart) attendanceChart.destroy();
    attendanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Total School-wide Absentees',
                data: data,
                backgroundColor: 'rgba(220, 53, 69, 0.7)',
                borderColor: 'rgba(220, 53, 69, 1)',
                borderWidth: 1
            }]
        },
        options: { scales: { y: { beginAtZero: true } } }
    });
}

/**
 * Renders the attendance bar chart for the teacher's dashboard.
 * @param {object} charge - The teacher's class charge object { classId, division }.
 */
async function renderTeacherAttendanceChart(charge) {
    const ctx = document.getElementById('teacher-attendance-chart')?.getContext('2d');
    // Exit if the canvas element isn't on the page or if there's no class charge info
    if (!ctx || !charge) return;

    const today = new Date();
    const monthYear = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
    const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
    const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
    const data = Array(daysInMonth).fill(0);

    // Fetch the month's attendance data using our cache-first function
    const monthData = await getData('attendance', monthYear);
    
    if (monthData) {
        const classKey = `${charge.classId}-${charge.division}`;
        
        // Loop through the days in the fetched data
        for (const day in monthData) {
            if (isNaN(parseInt(day))) continue; // Skip non-day fields like 'id'

            const dayIndex = parseInt(day) - 1;
            if (dayIndex >= 0 && dayIndex < daysInMonth) {
                const classData = monthData[day]?.[classKey];
                
                // If attendance was submitted for this class on this day...
                if (classData?.status === 'SUBMITTED' && classData.exceptions) {
                    // ...the number of absentees is the count of students in the exceptions list.
                    data[dayIndex] = Object.keys(classData.exceptions).length;
                }
            }
        }
    }

    // Destroy the old chart instance before creating a new one
    if (attendanceChart) attendanceChart.destroy();
    
    attendanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{ 
                label: `Absentees in ${charge.classId}-${charge.division}`, 
                data, 
                backgroundColor: 'rgba(255, 159, 64, 0.7)' 
            }]
        },
        options: { 
            scales: { 
                y: { 
                    beginAtZero: true, 
                    ticks: { stepSize: 1 } 
                } 
            } 
        }
    });
}

/**
 * Fetches and displays the list of absentees for a given date.
 * @param {string} dateString - The selected date in "YYYY-MM-DD" format.
 */
async function displayAbsenteesForDate(dateString) {
    const container = document.getElementById('absentee-list-display');
    if (!container) return;

    container.innerHTML = `<div class="text-center"><div class="spinner-border spinner-border-sm"></div></div>`;

    const charge = selectedUser.classCharge;
    const monthYear = dateString.slice(0, 7);
    const dayStr = new Date(dateString + 'T00:00:00').getDate().toString();
    const classKey = `${charge.classId}-${charge.division}`;

    const monthData = await getData('attendance', monthYear);
    const dayData = monthData?.[dayStr]?.[classKey];

    // 1. Check if attendance was submitted
    if (dayData?.status !== 'SUBMITTED') {
        container.innerHTML = `<p class="text-muted text-center p-2">Attendance not yet submitted for this date.</p>`;
        return;
    }

    const exceptions = dayData.exceptions || {};
    const absenteeIds = Object.keys(exceptions);

    // 2. Check if there were any absentees
    if (absenteeIds.length === 0) {
        container.innerHTML = `<p class="text-success text-center p-2">No absentees reported for this date.</p>`;
        return;
    }

    // 3. Build the list of absentees with notification buttons
    let listHtml = '<ul class="list-group list-group-flush">';
    absenteeIds.forEach(id => {
        const student = students.find(s => s.id === id);
        const record = exceptions[id];
        let status = '';
        if (!record.FN && !record.AN) status = 'Absent (Full Day)';
        else if (!record.FN) status = 'Absent (FN)';
        else if (!record.AN) status = 'Absent (AN)';

        if (student) {
            listHtml += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${student.name}</strong><br>
                        <small class="text-muted">${status}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-success" onclick="notifyParentOfAbsence('${student.id}', '${dateString}')" title="Notify Parent via WhatsApp">
                        <i class="fab fa-whatsapp"></i> Notify
                    </button>
                </li>
            `;
        }
    });
    listHtml += '</ul>';

    container.innerHTML = listHtml;
}

/**
 * Opens WhatsApp to notify a parent of their child's absence.
 * @param {string} studentId - The ID of the absent student.
 * @param {string} dateString - The date of the absence.
 */
window.notifyParentOfAbsence = (studentId, dateString) => {
    const student = students.find(s => s.id === studentId);
    if (!student) return;

    // Use parent's mobile number, defaulting to mobile1
    const parentNumber = student.mobile1 || student.whatsappNo;
    if (!parentNumber) {
        showAlert('No contact number found for this student\'s parent.', 'warning');
        return;
    }

    const schoolName = schoolDetails.name || 'the school';
    const formattedDate = new Date(dateString + 'T00:00:00').toLocaleDateString('en-GB');

    const message = `Dear Parent,\nThis is to inform you that your child, ${student.name} of class ${student.classId}-${student.division}, was marked absent from ${schoolName} today, ${formattedDate}.\n\nPlease contact the school office for any queries.\nThank you.`;
    const encodedMessage = encodeURIComponent(message);
    const whatsappUrl = `https://wa.me/${parentNumber}?text=${encodedMessage}`;

    window.open(whatsappUrl, '_blank');
};

//         async function renderTeacherDashboardData() {
//     const charge = selectedUser.classCharge;
//     if (!charge) return; // Nothing to render if teacher has no class charge

//     // --- Logic for "Today's Absentees" list (remains the same) ---
//     const todayStr = new Date().toISOString().slice(0, 10);
//     const holiday = holidays.find(h => h.id === todayStr);
//     const listContainer = document.getElementById('today-absent-list');

//     if (listContainer) {
//         if (holiday) {
//             listContainer.innerHTML = `<p class="text-info">Today is a holiday: ${holiday.narration}</p>`;
//         } else {
//             const today = new Date();
//             const monthYear = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
//             const dayStr = today.getDate().toString();
//             const classKey = `${charge.classId}-${charge.division}`;
            
//             const monthData = await getData('attendance', monthYear);
//             const todaysExceptions = monthData?.[dayStr]?.[classKey]?.exceptions || {};
//             const absenteeIds = Object.keys(todaysExceptions);
            
//             if (absenteeIds.length > 0) {
//                 const absenteeNames = absenteeIds.map(id => students.find(s => s.id === id)?.name || 'Unknown Student');
//                 listContainer.innerHTML = `<ul class="list-group list-group-flush">${absenteeNames.map(name => `<li class="list-group-item">${name}</li>`).join('')}</ul>`;
//             } else {
//                 listContainer.innerHTML = `<p class="text-success">No absentees reported today.</p>`;
//             }
//         }
//     }

//     // --- Call the new, separate function to render the chart ---
//     await renderTeacherAttendanceChart(charge);
    
//     updateAllNotifications();
// }
        
        // --- CLASS MANAGEMENT (WITH ORDER FIELD) ---
window.renderClassManagement = () => {
    const isEditMode = classToEdit !== null;
    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Class Management</h1>
        <div class="row">
            <div class="col-lg-4">
                <div class="card shadow mb-4">
                    <div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">${isEditMode ? "Edit Class" : "Add New Class"}</h6></div>
                    <div class="card-body">
                        <form id="class-form">
                            <div class="mb-3"><label class="form-label">Academic Year</label><input id="academic-year" required class="form-control" ${isEditMode ? 'readonly' : ''}></div>
                            <div class="row">
                                <div class="col-8"><label class="form-label">Class Name</label><input id="class-name" placeholder="E.g., CLASS X" required class="form-control" ${isEditMode ? 'readonly' : ''}></div>
                                <div class="col-4"><label class="form-label">Order</label><input type="number" id="class-order" placeholder="e.g., 10" required class="form-control"></div>
                            </div>
                            <div class="mb-3"><label class="form-label">Class Alias</label><input id="class-alias" placeholder="E.g., X" required class="form-control"></div>
                            <div class="mb-3"><label class="form-label">Divisions (comma-separated)</label><input id="class-divisions" placeholder="A,B,C" required class="form-control"></div>
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" id="cancel-edit-btn" class="btn btn-secondary ${!isEditMode ? 'd-none' : ''}">Cancel</button>
                                <button type="submit" class="btn btn-primary">${isEditMode ? "Update Class" : "Add Class"}</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="card shadow mb-4">
                    <div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">Existing Classes</h6></div>
                    <div class="card-body" id="classes-list-container"></div>
                </div>
            </div>
        </div>`;

    renderClassesList(); // This function also needs a small update (see below)
    const form = document.getElementById('class-form');
    const yearInput = document.getElementById('academic-year');
    const nameInput = document.getElementById('class-name');
    const orderInput = document.getElementById('class-order'); // New
    const aliasInput = document.getElementById('class-alias');
    const divInput = document.getElementById('class-divisions');

    if (isEditMode) {
        yearInput.value = classToEdit.year;
        nameInput.value = classToEdit.name;
        orderInput.value = classToEdit.order || ''; // New
        aliasInput.value = classToEdit.alias;
        divInput.value = (classToEdit.divisions || []).join(', ');
    } else {
        yearInput.value = `${new Date().getFullYear()}-${new Date().getFullYear() + 1}`;
    }

    document.getElementById('cancel-edit-btn').addEventListener('click', () => { classToEdit = null; renderClassManagement(); });
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const docId = isEditMode ? classToEdit.id : `${yearInput.value}_${nameInput.value.toUpperCase().replace(/\s+/g, '_')}`;
        const data = {
            id: docId,
            year: yearInput.value,
            name: nameInput.value.toUpperCase(),
            order: parseInt(orderInput.value, 10) || 0, // New
            alias: aliasInput.value.toUpperCase(),
            divisions: divInput.value.split(',').map(d => d.trim().toUpperCase()).filter(Boolean)
        };
        await setDoc(getDocRef('classes', docId), data);
        showAlert(`Class '${data.name}' ${isEditMode ? 'updated' : 'saved'}.`, 'success');
        classToEdit = null;
        renderClassManagement();
    });
};

// Also, replace your old renderClassesList with this one to show the order
function renderClassesList() {
    const container = document.getElementById('classes-list-container');
    if (!container) return;
    if (!classes || classes.length === 0) { container.innerHTML = `<p class="text-muted">No classes added.</p>`; return; }
    
    // Sort by the new 'order' property
    const sortedClasses = [...classes].sort((a, b) => (a.order || 0) - (b.order || 0));

    container.innerHTML = `<div class="list-group list-group-flush">${sortedClasses.map(cls => `
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
                <h6 class="mb-0">${cls.name} <span class="badge bg-primary rounded-pill">${cls.order}</span></h6>
                <div>${(cls.divisions || []).map(d => `<span class="badge bg-secondary me-1">${d}</span>`).join('')}</div>
            </div>
            <div>
                <button onclick="window.handleEditClass('${cls.id}')" class="btn btn-sm btn-outline-primary me-2" title="Edit"><i class="fas fa-edit"></i></button>
                <button onclick="window.handleDelete('classes', '${cls.id}')" class="btn btn-sm btn-outline-danger" title="Delete"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>`).join('')}</div>`;
}
        window.handleEditClass = (id) => { classToEdit = classes.find(c => c.id === id); if(classToEdit) renderClassManagement(); };
        window.handleDelete = async (coll, id) => { if (confirm("Are you sure? This cannot be undone.")) { await deleteDoc(getDocRef(coll, id)); showAlert('Item deleted.', 'success'); }};

// --- TEACHER MANAGEMENT (WITH RE-ASSIGNMENT WORKFLOW) ---

// --- TEACHER MANAGEMENT (WITH RE-ASSIGNMENT WIZARD) ---

window.renderTeacherManagement = () => {
    const isEditMode = teacherToEdit !== null;

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Teacher Management</h1>
        <div class="row">
            <div class="col-lg-4">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-primary">${isEditMode ? "Edit Teacher" : "Add Teacher"}</h6>
                    </div>
                    <div class="card-body">
                        <form id="teacher-form">
                            <div class="mb-3">
                                <label class="form-label">Teacher ID</label>
                                <input type="text" id="teacher-id" class="form-control" ${isEditMode ? 'readonly' : ''}>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Full Name</label>
                                <input type="text" id="teacher-name" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Mobile</label>
                                <input type="tel" id="teacher-mobile" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Roles</label>
                                <input type="text" id="teacher-roles" class="form-control" placeholder="e.g., librarian, hod, admin">
                                <small class="form-text text-muted">Separate multiple roles with a comma.</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" id="teacher-email" class="form-control" style="text-transform: lowercase;">
                            </div>
                            <div class="row mb-3">
                                <div class="col">
                                    <label class="form-label">Class Charge</label>
                                    <select id="teacher-class-charge" class="form-select">
                                        <option value="">NONE</option>
                                        ${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="col">
                                    <label class="form-label">Division</label>
                                    <select id="teacher-division-charge" class="form-select" disabled></select>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" id="cancel-edit-btn" class="btn btn-secondary ${!isEditMode ? 'd-none' : ''}">Cancel</button>
                                <button type="submit" class="btn btn-primary">${isEditMode ? "Update" : "Add"}</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#active-teachers-pane">Active Staff</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#inactive-teachers-pane">Inactive Staff</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="active-teachers-pane">
                                <div id="teachers-list-container"></div>
                            </div>
                            <div class="tab-pane fade" id="inactive-teachers-pane">
                                <div id="inactive-teachers-list-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    
    renderActiveTeachersList();
    renderInactiveTeachersList();
    attachTeacherFormListeners();
};

function renderActiveTeachersList() {
    // This function is unchanged
    const container = document.getElementById('teachers-list-container');
    const activeTeachers = teachers.filter(t => t.status !== 'Inactive').sort((a, b) => (a.name || "").localeCompare(b.name || ""));
    if (!container) return;
    if (activeTeachers.length === 0) {
        container.innerHTML = `<p class="text-muted p-3">No active teachers found.</p>`; return;
    }
    container.innerHTML = `<div class="list-group list-group-flush">${activeTeachers.map(teacher => {
        let chargeText = 'None';
        if (teacher.classCharge?.classId) {
            const chargedClass = classes.find(c => c.id === teacher.classCharge.classId);
            chargeText = chargedClass ? `${chargedClass.name} - ${teacher.classCharge.division}` : 'N/A';
        }
        const rolesBadges = Array.isArray(teacher.roles) ? teacher.roles.map(role => `<span class="badge bg-info text-dark me-1">${role}</span>`).join('') : '';
        return `<div class="list-group-item d-flex justify-content-between align-items-center"><div><h6 class="mb-1">${teacher.name}</h6><div class="mb-2">${rolesBadges}</div><small class="text-muted">${teacher.id} | Class Charge: <strong>${chargeText}</strong></small></div><div><button class="btn btn-sm btn-outline-primary me-2" title="Edit" onclick="window.handleEditTeacher('${teacher.id}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-warning" title="Mark as Resigned" onclick="window.handleResignClick('${teacher.id}')"><i class="fas fa-user-minus"></i> Resign</button></div></div>`;
    }).join('')}</div>`;
}

function renderInactiveTeachersList() {
    // This function is unchanged
    const container = document.getElementById('inactive-teachers-list-container');
    const inactiveTeachers = teachers.filter(t => t.status === 'Inactive').sort((a, b) => (a.name || "").localeCompare(b.name || ""));
    if (!container) return;
    if (inactiveTeachers.length === 0) {
        container.innerHTML = `<p class="text-muted p-3">No inactive teachers found.</p>`; return;
    }
    container.innerHTML = `<div class="list-group list-group-flush">${inactiveTeachers.map(teacher => `<div class="list-group-item d-flex justify-content-between align-items-center"><div><h6 class="mb-1 text-muted">${teacher.name}</h6><small class="d-block"><strong>Resigned on:</strong> ${new Date(teacher.resignationDate).toLocaleDateString()}</small><small class="d-block"><strong>Reason:</strong> ${teacher.resignationReason || 'N/A'}</small></div><div><button class="btn btn-sm btn-outline-success me-2" title="Re-activate Teacher" onclick="window.handleReactivateTeacher('${teacher.id}')"><i class="fas fa-user-plus"></i> Re-activate</button><button class="btn btn-sm btn-outline-danger" title="Delete Permanently" onclick="window.handleDelete('teachers', '${teacher.id}')"><i class="fas fa-trash-alt"></i></button></div></div>`).join('')}</div>`;
}

/**
 * Attaches all necessary event listeners for the Teacher Management module,
 * including the Add/Edit form and the Resignation wizard.
 */
function attachTeacherFormListeners() {
    const isEditMode = teacherToEdit !== null;
    const form = document.getElementById('teacher-form');
    const idInput = document.getElementById('teacher-id');
    const nameInput = document.getElementById('teacher-name');
    const mobileInput = document.getElementById('teacher-mobile');
    const emailInput = document.getElementById('teacher-email');
    const rolesInput = document.getElementById('teacher-roles');
    const classDropdown = document.getElementById('teacher-class-charge');
    const divisionDropdown = document.getElementById('teacher-division-charge');
    const cancelBtn = document.getElementById('cancel-edit-btn');
          
    const updateDivisionDropdown = (selectedClassId) => {
        const selectedClass = classes.find(c => c.id === selectedClassId);
        divisionDropdown.innerHTML = '<option value="">--</option>';
        divisionDropdown.disabled = true;
        if (selectedClass) {
            divisionDropdown.innerHTML += selectedClass.divisions.map(div => `<option value="${div}">${div}</option>`).join('');
            divisionDropdown.disabled = false;
        }
    };

    if (isEditMode) {
        idInput.value = teacherToEdit.id;
        nameInput.value = teacherToEdit.name;
        mobileInput.value = teacherToEdit.mobile;
        emailInput.value = teacherToEdit.email;
        if (teacherToEdit.roles && Array.isArray(teacherToEdit.roles)) {
            rolesInput.value = teacherToEdit.roles.join(', ');
        }
        if (teacherToEdit.classCharge?.classId) {
            classDropdown.value = teacherToEdit.classCharge.classId;
            updateDivisionDropdown(teacherToEdit.classCharge.classId);
            divisionDropdown.value = teacherToEdit.classCharge.division;
        }
    } else {
        const latestIdNum = teachers.reduce((max, t) => {
            const num = parseInt((t.id || "").split('-')[1] || 0);
            return num > max ? num : max;
        }, 1000);
        idInput.value = `EMP-${latestIdNum + 1}`;
    }

    classDropdown.addEventListener('change', () => updateDivisionDropdown(classDropdown.value));
    cancelBtn.addEventListener('click', () => { teacherToEdit = null; renderTeacherManagement(); });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const rolesArray = rolesInput.value.split(',').map(role => role.trim().toLowerCase()).filter(Boolean);
        const teacherData = {
            id: idInput.value,
            name: nameInput.value,
            mobile: mobileInput.value,
            email: emailInput.value.toLowerCase(),
            roles: rolesArray,
            classCharge: classDropdown.value ? { classId: classDropdown.value, division: divisionDropdown.value } : null,
            status: teacherToEdit?.status || 'Active'
        };

        if (!isEditMode) {
            teacherData.createdAt = serverTimestamp();
            teacherData.createdBy = selectedUser.id;
        }

        await setDoc(getDocRef('teachers', teacherData.id), teacherData, { merge: true });
        showAlert(`Teacher '${teacherData.name}' has been ${isEditMode ? 'updated' : 'added'}.`, 'success');
        teacherToEdit = null;
        renderTeacherManagement();
    });
    
    // Attach listeners for the Resignation Wizard buttons
    document.getElementById('resign-wizard-next-btn')?.addEventListener('click', handleResignWizardNext);
    document.getElementById('resign-wizard-prev-btn')?.addEventListener('click', handleResignWizardPrev);
    document.getElementById('confirm-resignation-btn')?.addEventListener('click', handleConfirmResignation);
}
/**
 * Finds a teacher by their ID and sets the form to edit mode.
 * Includes a check to alert the user if the teacher is not found.
 * @param {string} teacherId - The ID of the teacher to edit.
 */
window.handleEditTeacher = (teacherId) => {
    // Ensure the global 'teachers' array has data before searching.
    if (!teachers || teachers.length === 0) {
        showAlert('Teacher data is not available. Please check your connection and try again.', 'danger');
        console.error('Attempted to edit a teacher, but the global teachers array is empty.');
        return;
    }

    // Find the teacher in the now-confirmed global array.
    teacherToEdit = teachers.find(t => t.id === teacherId);

    if (teacherToEdit) {
        // If found, re-render the management tab to enter edit mode.
        renderTeacherManagement();
    } else {
        // If not found, inform the user.
        showAlert(`Error: Could not find a teacher with ID: ${teacherId}`, 'danger');
        console.warn(`Teacher with ID ${teacherId} not found in the 'teachers' array.`);
    }
};

window.handleReactivateTeacher = async (teacherId) => {
    // This function is unchanged
    if (!confirm('Are you sure you want to re-activate this teacher?')) return;
    await updateDoc(getDocRef('teachers', teacherId), { status: 'Active', resignationDate: null, resignationReason: null, roles: ['teacher'] });
    showAlert('Teacher has been re-activated.', 'success');
};

// NEW AND REVISED FUNCTIONS FOR THE RESIGNATION WIZARD

let resignWizardSteps = []; // Global to hold the steps for the current wizard instance

window.handleResignClick = (teacherId) => {
    const teacher = teachers.find(t => t.id === teacherId);
    if (!teacher) return;

    resignWizardSteps = []; // Reset steps for this instance

    // Set basic info in the modal
    document.getElementById('resign-teacher-id').value = teacherId;
    document.getElementById('resign-teacher-name').textContent = teacher.name;

    // Get a list of other active teachers for the dropdowns
    const otherActiveTeachers = teachers.filter(t => t.id !== teacherId && t.status !== 'Inactive');
    const teacherOptions = `<option value="">-- Select a new teacher --</option>` + 
                           otherActiveTeachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');

    // --- Check for each responsibility and prepare the UI ---

    // 1. Class Charge
    const classChargeDiv = document.getElementById('reassign-class-charge-div');
    if (teacher.classCharge?.classId) {
        resignWizardSteps.push('1');
        const classInfo = classes.find(c => c.id === teacher.classCharge.classId);
        document.getElementById('class-charge-info').textContent = `${classInfo.name}-${teacher.classCharge.division}`;
        document.getElementById('reassign-class-charge-select').innerHTML = teacherOptions;
    }

    // 2. Subject Allocations
    const subjectsDiv = document.getElementById('reassign-subjects-div');
    const subjectAllocs = classroomSubjects.filter(cs => cs.teacherId === teacherId);
    if (subjectAllocs.length > 0) {
        resignWizardSteps.push('2');
        document.getElementById('subject-count-info').textContent = `${subjectAllocs.length}`;
        document.getElementById('reassign-subjects-select').innerHTML = teacherOptions;

        // --- NEW: Display the list of subjects being transferred ---
        const subjectListContainer = document.getElementById('subject-allocations-list');
        const listHtml = subjectAllocs.map(alloc => {
            const className = classes.find(c => c.id === alloc.classId)?.name || 'N/A';
            const subjectName = subjects.find(s => s.id === alloc.subjectId)?.name || 'N/A';
            return `<li class="list-group-item list-group-item-light py-1 px-2">${subjectName} <small class="text-muted">(${className} - ${alloc.division})</small></li>`;
        }).join('');
        subjectListContainer.innerHTML = `<ul class="list-group list-group-flush">${listHtml}</ul>`;
    }

    // 3. Special Roles
    const rolesDiv = document.getElementById('reassign-roles-div');
    const specialRoles = teacher.roles?.filter(r => r && r.toLowerCase() !== 'teacher') || [];
    if (specialRoles.length > 0) {
        resignWizardSteps.push('3');
        document.getElementById('roles-info').textContent = specialRoles.join(', ');
        document.getElementById('reassign-roles-select').innerHTML = `<option value="">-- Do Not Re-assign --</option>` + teacherOptions;
    }

    // 4. Finalize Step is always last
    resignWizardSteps.push('4');

    // Show/hide steps and activate the first one
    document.querySelectorAll('#resign-wizard-tabs .nav-link').forEach(tab => {
        const step = tab.id.split('-')[2];
        const stepPane = document.getElementById(`step-pane-${step}`);
        const isStepNeeded = resignWizardSteps.includes(step);

        tab.parentElement.style.display = isStepNeeded ? 'block' : 'none';
        if(stepPane) stepPane.style.display = isStepNeeded ? 'block' : 'none'; // Also control pane visibility
    });

    const firstStep = resignWizardSteps[0];
    const firstTab = new bootstrap.Tab(document.getElementById(`step-tab-${firstStep}`));
    firstTab.show();
    
    updateResignWizardButtons();

    const modal = new bootstrap.Modal(document.getElementById('resignTeacherModal'));
    modal.show();
};

function handleResignWizardNext() {
    const currentActiveTab = document.querySelector('#resign-wizard-tabs .nav-link.active');
    const currentStep = currentActiveTab.id.split('-')[2];
    
    // --- MANDATORY CHECKS ---
    if (currentStep === '1' && !document.getElementById('reassign-class-charge-select').value) {
        return showAlert('You must select a new Class Teacher to proceed.', 'warning');
    }
    if (currentStep === '2' && !document.getElementById('reassign-subjects-select').value) {
        return showAlert('You must select a new teacher for the subject allocations.', 'warning');
    }

    const currentStepIndex = resignWizardSteps.indexOf(currentStep);
    if (currentStepIndex < resignWizardSteps.length - 1) {
        const nextStep = resignWizardSteps[currentStepIndex + 1];
        const nextTab = new bootstrap.Tab(document.getElementById(`step-tab-${nextStep}`));
        nextTab.show();
    }
    updateResignWizardButtons();
}

function handleResignWizardPrev() {
    const currentActiveTab = document.querySelector('#resign-wizard-tabs .nav-link.active');
    const currentStep = currentActiveTab.id.split('-')[2];
    const currentStepIndex = resignWizardSteps.indexOf(currentStep);
    if (currentStepIndex > 0) {
        const prevStep = resignWizardSteps[currentStepIndex - 1];
        const prevTab = new bootstrap.Tab(document.getElementById(`step-tab-${prevStep}`));
        prevTab.show();
    }
    updateResignWizardButtons();
}

function updateResignWizardButtons() {
    const currentActiveTab = document.querySelector('#resign-wizard-tabs .nav-link.active');
    const currentStep = currentActiveTab.id.split('-')[2];
    const currentStepIndex = resignWizardSteps.indexOf(currentStep);

    const prevBtn = document.getElementById('resign-wizard-prev-btn');
    const nextBtn = document.getElementById('resign-wizard-next-btn');
    const confirmBtn = document.getElementById('confirm-resignation-btn');

    prevBtn.style.display = currentStepIndex > 0 ? 'inline-block' : 'none';
    nextBtn.style.display = currentStepIndex < resignWizardSteps.length - 1 ? 'inline-block' : 'none';
    confirmBtn.style.display = currentStepIndex === resignWizardSteps.length - 1 ? 'inline-block' : 'none';
}

async function handleConfirmResignation() {
    const teacherId = document.getElementById('resign-teacher-id').value;
    const resignationDate = document.getElementById('resignation-date').value;
    if (!resignationDate) return showAlert('Resignation date is required.', 'danger');

    const resigningTeacher = teachers.find(t => t.id === teacherId);
    const batch = writeBatch(db);
    
    // Step 1: Update resigning teacher's document
    batch.update(getDocRef('teachers', teacherId), {
        status: 'Inactive',
        resignationDate: resignationDate,
        resignationReason: document.getElementById('resignation-reason').value,
        classCharge: null, roles: []
    });

    // Step 2: Re-assign Class Charge if applicable
    const newClassTeacherId = document.getElementById('reassign-class-charge-select').value;
    if (newClassTeacherId && resigningTeacher.classCharge) {
        batch.update(getDocRef('teachers', newClassTeacherId), { classCharge: resigningTeacher.classCharge });
    }

    // Step 3: Re-assign Subjects if applicable
    const newSubjectTeacherId = document.getElementById('reassign-subjects-select').value;
    if (newSubjectTeacherId) {
        const subjectAllocs = classroomSubjects.filter(cs => cs.teacherId === teacherId);
        for (const alloc of subjectAllocs) {
            batch.delete(getDocRef('classroomSubjects', alloc.id));
            const newAllocId = `${alloc.classId}_${alloc.division}_${alloc.subjectId}_${newSubjectTeacherId}`;
            batch.set(getDocRef('classroomSubjects', newAllocId), { ...alloc, id: newAllocId, teacherId: newSubjectTeacherId });
        }
    }

    // Step 4: Re-assign Roles if applicable
    const newRolesTeacherId = document.getElementById('reassign-roles-select').value;
    const specialRoles = resigningTeacher.roles?.filter(r => r && r.toLowerCase() !== 'teacher') || [];
    if (newRolesTeacherId && specialRoles.length > 0) {
        const newRolesTeacher = teachers.find(t => t.id === newRolesTeacherId);
        const newRolesSet = new Set([...(newRolesTeacher.roles || []), ...specialRoles]);
        batch.update(getDocRef('teachers', newRolesTeacherId), { roles: Array.from(newRolesSet) });
    }

    try {
        await batch.commit();
        showAlert('Resignation process completed successfully.', 'success');
        bootstrap.Modal.getInstance(document.getElementById('resignTeacherModal')).hide();
    } catch (error) {
        console.error('Error during resignation process:', error);
        showAlert('Failed to process resignation.', 'danger');
    }
}
        // --- SUBJECT MANAGEMENT ---
        window.renderSubjectManagement = () => {
    const isEditMode = subjectToEdit !== null;
    const currentSubject = subjectToEdit || {}; // Use currentSubject for pre-filling

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Subject Management</h1>
        <div class="row">
            <div class="col-lg-4">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-primary">${isEditMode ? "Edit Subject" : "Add New Subject"}</h6>
                    </div>
                    <div class="card-body">
                        <form id="add-subject-form">
                            <div class="mb-3">
                                <label class="form-label">Sector</label>
                                <select id="subject-sector" required class="form-select" ${isEditMode ? 'disabled' : ''}>
                                    <option value="">-- Select Sector --</option>
                                    <option value="SCHOOL" ${currentSubject.sector === 'SCHOOL' ? 'selected' : ''}>SCHOOL</option>
                                    <option value="MADRASSA" ${currentSubject.sector === 'MADRASSA' ? 'selected' : ''}>MADRASSA</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Subject ID</label>
                                <input id="subject-id" type="text" required class="form-control bg-light" value="${currentSubject.id || ''}" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Subject Name</label>
                                <input id="subject-name" type="text" required class="form-control" style="text-transform: uppercase;" value="${currentSubject.name || ''}">
                            </div>
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" id="cancel-edit-btn" class="btn btn-secondary ${!isEditMode ? 'd-none' : ''}">Cancel</button>
                                <button type="submit" class="btn btn-primary">${isEditMode ? "Update Subject" : "Add Subject"}</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 fw-bold text-primary">Existing Subjects</h6>
                    </div>
                    <div class="card-body" id="subjects-list-container">
                        </div>
                </div>
            </div>
        </div>`;

    // Get DOM elements after they are rendered
    const subjectIdInput = document.getElementById('subject-id');
    const subjectNameInput = document.getElementById('subject-name');
    const subjectSectorSelect = document.getElementById('subject-sector');
    const addSubjectForm = document.getElementById('add-subject-form');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');

    // Function to generate the next Subject ID (only for Add mode)
    const generateSubjectId = () => {
        if (isEditMode) return; // Don't generate ID in edit mode

        let latestIdNum = 0;
        subjects.forEach(subject => {
            if (subject.id && subject.id.startsWith('SUB_')) {
                const numPart = parseInt(subject.id.split('_')[1], 10);
                if (!isNaN(numPart) && numPart > latestIdNum) {
                    latestIdNum = numPart;
                }
            }
        });
        subjectIdInput.value = `SUB_${(latestIdNum + 1).toString().padStart(3, '0')}`;
    };

    // Initial generation of Subject ID on load (if not in edit mode)
    if (!isEditMode) {
        generateSubjectId();
    }

    // Cancel Edit button listener
    cancelEditBtn.addEventListener('click', () => {
        subjectToEdit = null; // Clear edit state
        renderSubjectManagement(); // Re-render to show Add Subject form
    });

    // Event listener for form submission
    addSubjectForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const id = subjectIdInput.value.toUpperCase().trim();
        const name = subjectNameInput.value.toUpperCase().trim();
        const sector = subjectSectorSelect.value; // Get sector for new subjects

        // If in edit mode, the sector might be disabled, so retrieve from subjectToEdit
        const finalSector = isEditMode ? subjectToEdit.sector : sector;

        if (!finalSector) {
            showAlert('Please select a Sector.', 'danger');
            return;
        }
        if (!id || !name) {
            showAlert('Subject ID and Name are required.', 'danger');
            return;
        }

        // Check for uniqueness when adding a NEW subject
        if (!isEditMode) {
            const existingSubject = subjects.find(s => s.id === id);
            if (existingSubject) {
                showAlert('Subject ID already exists. Please re-generate or check existing list.', 'warning');
                generateSubjectId(); // Attempt to generate a new unique ID
                return;
            }
        }

        try {
            // Data to save/update
            const subjectData = {
                id: id,
                name: name,
                subjectId: id, // Keep subjectId field for consistency if needed elsewhere
                sector: finalSector // Use finalSector
            };

            await setDoc(getDocRef('subjects', id), subjectData);
            showAlert(`Subject '${subjectData.name}' ${isEditMode ? 'updated' : 'added'}.`, 'success');
            
            subjectToEdit = null; // Clear edit state after successful save/update
            renderSubjectManagement(); // Re-render to show updated list and clear form (or switch to add mode)

        } catch (error) {
            console.error("Error saving subject:", error);
            showAlert('Failed to save subject. Please try again.', 'danger');
        }
    });

    // Initial render of existing subjects list
    renderSubjectsList();
};

// --- renderSubjectsList function (Updated to include Edit button) ---
function renderSubjectsList() {
    const container = document.getElementById('subjects-list-container');
    if (!container) return;

    if (!subjects || subjects.length === 0) {
        container.innerHTML = '<p class="text-muted">No subjects added.</p>';
        return;
    }

    const sortedSubjects = [...subjects].sort((a, b) => (a.name || "").localeCompare(b.name || ""));

    container.innerHTML = `
        <table class="table table-hover table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Sector</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                ${sortedSubjects.map(s => `
                    <tr>
                        <td>${s.subjectId || 'N/A'}</td>
                        <td>${s.name || 'N/A'}</td>
                        <td>${s.sector || 'N/A'}</td>
                        <td class="text-end">
                            <button onclick="window.handleEditSubject('${s.id}')" class="btn btn-sm btn-outline-primary me-2" title="Edit Subject">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="window.handleDelete('subjects', '${s.id}')" class="btn btn-sm btn-outline-danger" title="Delete Subject">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>`).join('')}
            </tbody>
        </table>`;
}

// --- New Global Function for Editing Subject ---
window.handleEditSubject = (id) => {
    subjectToEdit = subjects.find(s => s.id === id);
    if (subjectToEdit) {
        renderSubjectManagement(); // Re-render the form with pre-filled data
    } else {
        showAlert('Subject not found for editing.', 'danger');
        console.warn('Subject not found for editing:', id);
    }
};

// --- SUBJECT ALLOCATION (ENHANCED WITH TEACHER RE-ASSIGNMENT) ---

// Main function to render the module with view mode toggle
window.renderSubjectAllocation = () => {
    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Subject Allocation</h1>
        <div class="card shadow mb-4">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#class-wise-view-pane">View by Class</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#teacher-wise-view-pane">View by Teacher & Re-assign</button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="class-wise-view-pane"></div>
                    <div class="tab-pane fade" id="teacher-wise-view-pane"></div>
                </div>
            </div>
        </div>`;

    renderClassWiseAllocationView();
    renderTeacherWiseAllocationView();
};

// --- View 1: The original "View by Class" functionality ---
function renderClassWiseAllocationView() {
    const container = document.getElementById('class-wise-view-pane');
    const isEditMode = allocationToEdit !== null;
    const currentAllocation = allocationToEdit || {};

    container.innerHTML = `
        <div class="row border-bottom pb-3 mb-3">
            <div class="col-md-4">
                <label class="form-label">Select Class</label>
                <select id="alloc-class" class="form-select" ${isEditMode ? 'disabled' : ''}>
                    <option value="">-- Select Class --</option>
                    ${classes.map(c => `<option value="${c.id}" ${currentAllocation.classId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Select Division</label>
                <select id="alloc-division" class="form-select" ${isEditMode ? 'disabled' : ''}></select>
            </div>
            ${!isEditMode ? `<div class="col-md-4 d-flex align-items-end"><button id="show-allocation-view-btn" class="btn btn-primary w-100">Load Allocation Form</button></div>` : ''}
        </div>
        <div id="allocation-view" class="${isEditMode ? '' : 'd-none'} row">
            <div class="col-lg-4">
                <h5 class="mb-3">${isEditMode ? 'Edit Allocation' : 'Allocate Subject'}</h5>
                <form id="add-alloc-form">
                    <div class="mb-3">
                        <label class="form-label">Subject</label>
                        <select id="alloc-subject" class="form-select" ${isEditMode ? 'disabled' : ''}>
                            <option value="">-- Select Subject --</option>
                            ${subjects.map(s => `<option value="${s.id}" ${currentAllocation.subjectId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Teacher</label>
                        <select id="alloc-teacher" class="form-select">
                            <option value="">-- Select Teacher --</option>
                            ${teachers.filter(t => t.status !== 'Inactive').map(t => `<option value="${t.id}" ${currentAllocation.teacherId === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Weekly Hours</label>
                        <input type="number" id="alloc-weekly-hour" class="form-control" placeholder="e.g., 5" value="${currentAllocation.weeklyHour || ''}">
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" id="cancel-edit-btn" class="btn btn-secondary ${!isEditMode ? 'd-none' : ''}">Cancel</button>
                        <button type="submit" class="btn btn-primary">${isEditMode ? "Update Allocation" : "Allocate"}</button>
                    </div>
                </form>
            </div>
            <div class="col-lg-8" id="alloc-list-container"></div>
        </div>`;

    // Attach all original listeners for this view
    const classSelect = document.getElementById('alloc-class');
    const divisionSelect = document.getElementById('alloc-division');
    const showAllocationViewBtn = document.getElementById('show-allocation-view-btn');
    const addAllocForm = document.getElementById('add-alloc-form');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');

    const updateDivisionDropdown = () => {
        const cls = classes.find(c => c.id === classSelect.value);
        divisionSelect.innerHTML = '<option value="">-- Select Division --</option>';
        divisionSelect.disabled = !cls || isEditMode;
        if (cls) {
            divisionSelect.innerHTML += cls.divisions.map(d => `<option value="${d}" ${currentAllocation.division === d ? 'selected' : ''}>${d}</option>`).join('');
        }
        if (isEditMode && currentAllocation.division) {
            divisionSelect.value = currentAllocation.division;
        }
        if (!isEditMode) document.getElementById('allocation-view').classList.add('d-none');
    };

    updateDivisionDropdown();

    if (isEditMode) {
        renderAllocationList(currentAllocation.classId, currentAllocation.division);
    } else {
        showAllocationViewBtn?.addEventListener('click', () => {
            const classId = classSelect.value;
            const division = divisionSelect.value;
            if (classId && division) {
                document.getElementById('allocation-view').classList.remove('d-none');
                renderAllocationList(classId, division);
            } else {
                showAlert('Please select both a Class and a Division first.', 'warning');
            }
        });
    }

    if (!isEditMode) {
        classSelect.addEventListener('change', updateDivisionDropdown);
    }
    
    cancelEditBtn.addEventListener('click', () => {
        allocationToEdit = null;
        renderSubjectAllocation();
    });

    addAllocForm.addEventListener('submit', async e => {
        e.preventDefault();
        const classId = classSelect.value;
        const division = divisionSelect.value;
        const subjectId = document.getElementById('alloc-subject').value;
        const teacherId = document.getElementById('alloc-teacher').value;
        const weeklyHour = parseInt(document.getElementById('alloc-weekly-hour').value, 10) || 0;

        if (!classId || !division || !subjectId || !teacherId || weeklyHour <= 0) {
            return showAlert('All fields are required.', 'danger');
        }
        const docId = isEditMode ? allocationToEdit.id : `${classId}_${division}_${subjectId}_${teacherId}`;
        const data = { id: docId, classId, division, subjectId, teacherId, weeklyHour };

        await setDoc(getDocRef('classroomSubjects', docId), data);
        showAlert(`Allocation ${isEditMode ? 'updated' : 'saved'}.`, 'success');
        
        allocationToEdit = null;
        renderSubjectAllocation();
    });
}

// Helper for View 1: Renders the list of allocations for a class
function renderAllocationList(classId, division) {
    const container = document.getElementById('alloc-list-container');
    const filtered = classroomSubjects.filter(cs => cs.classId === classId && cs.division === division);
    const clsName = classes.find(c => c.id === classId)?.name;

    container.innerHTML = `
        <h5 class="mb-3">Allocated Subjects for ${clsName || 'N/A'} - ${division || 'N/A'}</h5>
        ${(filtered.length === 0) ? `<p class="text-muted">No subjects allocated.</p>` : `
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead><tr><th>Subject</th><th>Teacher</th><th>Weekly Hours</th><th class="text-end">Actions</th></tr></thead>
                <tbody>
                    ${filtered.map(item => {
                        const subject = subjects.find(s => s.id === item.subjectId);
                        const teacher = teachers.find(t => t.id === item.teacherId);
                        return `<tr>
                            <td>${subject?.name || 'N/A'}</td>
                            <td>${teacher?.name || 'N/A'}</td>
                            <td>${item.weeklyHour || 0}</td>
                            <td class="text-end">
                                <button onclick="window.handleEditAllocation('${item.id}')" class="btn btn-sm btn-outline-primary me-2" title="Edit"><i class="fas fa-edit"></i></button>
                                <button onclick="window.handleDelete('classroomSubjects', '${item.id}')" class="btn btn-sm btn-outline-danger" title="Delete"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>`}`;
}

// Helper for View 1: Sets up the form for editing
window.handleEditAllocation = (id) => {
    allocationToEdit = classroomSubjects.find(alloc => alloc.id === id);
    if (allocationToEdit) {
        renderSubjectAllocation();
    } else {
        showAlert('Allocation not found for editing.', 'danger');
    }
};

// --- View 2: The new "View by Teacher" and Re-assignment Tool ---
function renderTeacherWiseAllocationView() {
    const container = document.getElementById('teacher-wise-view-pane');
    
    const activeTeachers = teachers.filter(t => t.status !== 'Inactive');
    const teacherOptions = activeTeachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');

    container.innerHTML = `
        <div class="row">
            <div class="col-md-5">
                <label for="from-teacher-select" class="form-label fw-bold">1. Select Source Teacher</label>
                <select id="from-teacher-select" class="form-select">
                    <option value="">-- Select a teacher to see allocations --</option>
                    ${teacherOptions}
                </select>
            </div>
        </div>
        <div id="teacher-allocations-container" class="mt-4"></div>
    `;

    document.getElementById('from-teacher-select').addEventListener('change', (e) => {
        displayTeacherAllocations(e.target.value);
    });
}

// Helper for View 2: Displays a teacher's allocations and the reassignment controls
function displayTeacherAllocations(teacherId) {
    const container = document.getElementById('teacher-allocations-container');
    if (!teacherId) {
        container.innerHTML = '';
        return;
    }

    const allocations = classroomSubjects.filter(cs => cs.teacherId === teacherId);
    
    if (allocations.length === 0) {
        container.innerHTML = `<p class="text-muted">This teacher has no subject allocations.</p>`;
        return;
    }

    const activeTeachers = teachers.filter(t => t.status !== 'Inactive' && t.id !== teacherId); // Exclude the source teacher
    const teacherOptions = activeTeachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');

    container.innerHTML = `
        <h5 class="mb-3">Current Allocations</h5>
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm table-striped">
                <thead><tr>
                    <th><input type="checkbox" id="select-all-allocations" class="form-check-input"></th>
                    <th>Class</th><th>Subject</th><th>Weekly Hours</th>
                </tr></thead>
                <tbody>
                    ${allocations.map(alloc => {
                        const cls = classes.find(c => c.id === alloc.classId);
                        const sub = subjects.find(s => s.id === alloc.subjectId);
                        return `<tr data-alloc-id="${alloc.id}">
                            <td><input type="checkbox" class="form-check-input alloc-checkbox"></td>
                            <td>${cls?.name || 'N/A'} - ${alloc.division}</td>
                            <td>${sub?.name || 'N/A'}</td>
                            <td>${alloc.weeklyHour}</td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>
        <hr>
        <div class="row align-items-end">
            <div class="col-md-5">
                <label for="to-teacher-select" class="form-label fw-bold">2. Re-assign selected to:</label>
                <select id="to-teacher-select" class="form-select">
                    <option value="">-- Select new teacher --</option>
                    ${teacherOptions}
                </select>
            </div>
            <div class="col-md-4">
                <button id="reassign-btn" class="btn btn-warning">Re-assign Selected Subjects</button>
            </div>
        </div>
    `;

    document.getElementById('select-all-allocations').addEventListener('change', (e) => {
        container.querySelectorAll('.alloc-checkbox').forEach(cb => cb.checked = e.target.checked);
    });

    document.getElementById('reassign-btn').addEventListener('click', handleReassignSubjects);
}

// Helper for View 2: The logic to perform the reassignment
async function handleReassignSubjects() {
    const fromTeacherId = document.getElementById('from-teacher-select').value;
    const toTeacherId = document.getElementById('to-teacher-select').value;
    const selectedRows = document.querySelectorAll('#teacher-allocations-container .alloc-checkbox:checked');
    const allocationIdsToMove = Array.from(selectedRows).map(cb => cb.closest('tr').dataset.allocId);

    if (!toTeacherId) {
        return showAlert('Please select a target teacher to re-assign subjects to.', 'warning');
    }
    if (allocationIdsToMove.length === 0) {
        return showAlert('Please select one or more subjects to re-assign.', 'warning');
    }

    const toTeacher = teachers.find(t => t.id === toTeacherId);
    if (!confirm(`Are you sure you want to re-assign ${allocationIdsToMove.length} subject(s) to ${toTeacher?.name}?`)) {
        return;
    }

    const batch = writeBatch(db);

    for (const allocId of allocationIdsToMove) {
        const originalAlloc = classroomSubjects.find(cs => cs.id === allocId);
        if (originalAlloc) {
            // 1. Delete the old allocation document
            batch.delete(getDocRef('classroomSubjects', originalAlloc.id));

            // 2. Create the new allocation document with the new teacher ID
            const newAllocId = `${originalAlloc.classId}_${originalAlloc.division}_${originalAlloc.subjectId}_${toTeacherId}`;
            const newAllocData = { ...originalAlloc, id: newAllocId, teacherId: toTeacherId };
            batch.set(getDocRef('classroomSubjects', newAllocId), newAllocData);
        }
    }

    try {
        await batch.commit();
        showAlert('Subjects re-assigned successfully!', 'success');
        // Refresh the view to show the updated allocations
        displayTeacherAllocations(fromTeacherId);
    } catch (error) {
        console.error("Error re-assigning subjects:", error);
        showAlert('An error occurred during re-assignment. See console for details.', 'danger');
    }
}
        // --- STUDENT MANAGEMENT & ADD STUDENT ---
        window.renderAddStudentForm = () => {
    const isEditMode = studentToEdit !== null;
    const currentStudent = studentToEdit || {};
    const formId = 'add-student-form';
    

    const formTitle = isEditMode ? 'Edit Student Details' : 'Add New Student';
    const buttonText = isEditMode ? 'Update Student' : 'Save Student';

    const mainContent = document.getElementById('main-content');
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">${formTitle}</h1>
        <div class="card shadow">
            <div class="card-body">
                <form id="add-student-form" class="needs-validation" novalidate>
                    <div class="border-bottom pb-3 mb-4">
                        <h5 class="text-primary">Personal Information</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="name" class="form-label">Full Name</label>
                                <input id="name" type="text" required class="form-control" value="${currentStudent.name || ''}">
                                <div class="invalid-feedback">Full name is required.</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="dob" class="form-label">Date of Birth</label>
                                <input id="dob" type="text" onkeyup="formatDate(this)" placeholder="DD/MM/YYYY" required class="form-control" value="${currentStudent.dob || ''}">
                                <span id="dob-words" class="text-muted small mt-1"></span>
                                <div class="invalid-feedback">Date of Birth is required.</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="gender" class="form-label">Gender</label>
                                <select id="gender" class="form-select">
                                    <option value="M" ${currentStudent.gender === 'M' ? 'selected' : ''}>MALE</option>
                                    <option value="F" ${currentStudent.gender === 'F' ? 'selected' : ''}>FEMALE</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="aadhaar" class="form-label">Aadhaar Number</label>
                                <input id="aadhaar" type="text" maxlength="14" onkeyup="formatAadhaar(this)" class="form-control" value="${currentStudent.aadhaar || ''}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="nationality" class="form-label">Nationality</label>
                                <select id="nationality" class="form-select">
                                    <option value="Indian" ${currentStudent.nationality === 'Indian' || !currentStudent.nationality ? 'selected' : ''}>Indian</option>
                                    <option value="Other" ${currentStudent.nationality === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="birthPlace" class="form-label">Birth Place</label>
                                <input id="birthPlace" type="text" class="form-control" value="${currentStudent.birthPlace || ''}">
                            </div>
                        </div>
                    </div>

                    <div class="border-bottom pb-3 mb-4">
                        <h5 class="text-primary">Admission & Academic Details</h5>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="admissionSector" class="form-label">Admission Sector</label>
                                <select id="admissionSector" class="form-select" ${isEditMode ? 'disabled' : ''}>
                                    <option value="KG" ${currentStudent.admissionSector === 'KG' ? 'selected' : ''}>KG</option>
                                    <option value="HS" ${currentStudent.admissionSector === 'HS' ? 'selected' : ''}>HIGH SCHOOL (HS)</option>
                                    <option value="HSS" ${currentStudent.admissionSector === 'HSS' ? 'selected' : ''}>HIGHER SECONDARY (HSS)</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="admissionId" class="form-label">Admission iD</label>
                                <input id="admissionId" type="text" class="form-control bg-light" value="${currentStudent.id || ''}"> 
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="admissionNumber" class="form-label">Admission Number</label>
                                <input id="admissionNumber" type="text"  class="form-control bg-light" value="${currentStudent.admissionNumber || ''}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="admissionDate" class="form-label">Admission Date</label>
                                <input id="admissionDate" type="text" onkeyup="formatDate(this)" placeholder="DD/MM/YYYY" required class="form-control" value="${currentStudent.admissionDate || ''}">
                                <div class="invalid-feedback">Admission Date is required.</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="instructionMedium" class="form-label">Instruction Medium</label>
                                <select id="instructionMedium" class="form-select">
                                    <option value="">-- Select --</option>
                                    <option value="English" ${currentStudent.instructionMedium === 'English' ? 'selected' : ''}>English</option>
                                    <option value="Malayalam" ${currentStudent.instructionMedium === 'Malayalam' ? 'selected' : ''}>Malayalam</option>
                                    <option value="Hindi" ${currentStudent.instructionMedium === 'Hindi' ? 'selected' : ''}>Hindi</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="classId" class="form-label">Class</label>
                                <select id="classId" required class="form-select">
                                    <option value="">-- Select Class --</option>
                                    ${classes.map(c => `<option value="${c.id}" ${currentStudent.classId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                </select>
                                <div class="invalid-feedback">Class is required.</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="division" class="form-label">Division</label>
                                <select id="division" required class="form-select"></select>
                                <div class="invalid-feedback">Division is required.</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="aplBpl" class="form-label">APL/BPL</label>
                                <select id="aplBpl" class="form-select">
                                    <option value="">-- Select --</option>
                                    <option value="APL" ${currentStudent.aplBpl === 'APL' ? 'selected' : ''}>APL</option>
                                    <option value="BPL" ${currentStudent.aplBpl === 'BPL' ? 'selected' : ''}>BPL</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="busPoint" class="form-label">Bus Point</label>
                                <input id="busPoint" type="text" class="form-control" value="${currentStudent.busPoint || ''}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="vehicleStage" class="form-label">Vehicle Stage</label>
                                <input id="vehicleStage" type="text" class="form-control" value="${currentStudent.vehicleStage || ''}">
                            </div>
                        </div>
                    </div>

                    

                    <div class="border-bottom pb-3 mb-4">
                        <h5 class="text-primary">Contact & Address</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fatherName" class="form-label">Father's Name</label>
                                <input id="fatherName" type="text" class="form-control" value="${currentStudent.fatherName || ''}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="motherName" class="form-label">Mother's Name</label>
                                <input id="motherName" type="text" class="form-control" value="${currentStudent.motherName || ''}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="guardian-type" class="form-label">Guardian Type</label>
                                <select id="guardian-type" class="form-select">
                                    <option value="Father" ${currentStudent.guardianType === 'Father' || !currentStudent.guardianType ? 'selected' : ''}>Father</option>
                                    <option value="Mother" ${currentStudent.guardianType === 'Mother' ? 'selected' : ''}>Mother</option>
                                    <option value="Local Guardian" ${currentStudent.guardianType === 'Local Guardian' ? 'selected' : ''}>Local Guardian</option>
                                </select>
                            </div>
                            <div id="local-guardian-fields" class="row ${currentStudent.guardianType === 'Local Guardian' ? '' : 'd-none'}">
                                <div class="col-md-6 mb-3">
                                    <label for="localGuardianName" class="form-label">Local Guardian Name</label>
                                    <input id="localGuardianName" type="text" class="form-control" value="${currentStudent.localGuardianName || ''}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="localGuardianRelation" class="form-label">Relation to Student</label>
                                    <input id="localGuardianRelation" type="text" class="form-control" value="${currentStudent.localGuardianRelation || ''}">
                                </div>
                            </div>

                            <div class="col-md-4 mb-3">
                                <label for="mobile1" class="form-label">Mobile Number 1</label>
                                <input id="mobile1" type="tel" class="form-control" value="${currentStudent.mobile1 || ''}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="mobile2" class="form-label">Mobile Number 2</label>
                                <input id="mobile2" type="tel" class="form-control" value="${currentStudent.mobile2 || ''}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="whatsappNo" class="form-label">WhatsApp Number (Student's)</label>
                                <input id="whatsappNo" type="tel" class="form-control" value="${currentStudent.whatsappNo || ''}">
                            </div>
                        </div>
                        <div class="border-bottom pb-3 mb-4">
                        <h5 class="text-primary">Sibling Information</h5>
                        <div class="form-check mb-3">
                            <input id="has-sibling" type="checkbox" class="form-check-input" ${currentStudent.hasSibling ? 'checked' : ''}>
                            <label for="has-sibling" class="form-check-label">Student has a sibling in this school</label>
                        </div>
                        <div id="sibling-info" class="row ${currentStudent.hasSibling ? '' : 'd-none'}">
                            <div class="col-md-6 mb-3">
                                <label for="siblingWhatsAppNumber" class="form-label">Sibling's WhatsApp Number</label>
                                <input id="siblingWhatsAppNumber" type="tel" placeholder="Enter sibling WhatsApp no." class="form-control" value="${currentStudent.siblingWhatsAppNumber || ''}">
                                <small class="form-text text-muted">Enter WhatsApp number to lookup sibling.</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="p-3 bg-light rounded">
                                    <h6 class="font-weight-bold">Sibling Details:</h6>
                                    <p id="sibling-details-display" class="text-muted mb-0">Details will appear here...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                        <h6 class="mt-4 mb-2 text-info">Current Address</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="houseName" class="form-label">House Name / Number</label>
                                <input id="houseName" type="text" class="form-control" value="${currentStudent.houseName || ''}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="place" class="form-label">Place</label>
                                <input id="place" type="text" class="form-control" value="${currentStudent.place || ''}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="state" class="form-label">State</label>
                                <select id="state" class="form-select">
                                    <option value="Kerala" ${currentStudent.state === 'Kerala' || !currentStudent.state ? 'selected' : ''}>Kerala</option>
                                    <option value="Other" ${currentStudent.state === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="district" class="form-label">District</label>
                                <select id="district" class="form-select">
                                    <option value="Malappuram" ${currentStudent.district === 'Malappuram' || !currentStudent.district ? 'selected' : ''}>Malappuram</option>
                                    <option value="Other" ${currentStudent.district === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="taluk" class="form-label">Taluk</label>
                                <input id="taluk" type="text" class="form-control" value="${currentStudent.taluk || ''}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="postOffice" class="form-label">Post Office</label>
                                <input id="postOffice" type="text" class="form-control" value="${currentStudent.postOffice || ''}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="pin" class="form-label">PIN Code</label>
                                <input id="pin" type="text" maxlength="6" class="form-control" value="${currentStudent.pin || ''}">
                            </div>
                        </div>
                    </div>
                    <div class="border-bottom pb-3 mb-4">
                        <h5 class="text-primary">Previous School Details</h5>
                        <div class="form-check mb-3">
                            <input id="prevSchoolSame" type="checkbox" class="form-check-input" ${currentStudent.prevSchoolSame ? 'checked' : ''}>
                            <label for="prevSchoolSame" class="form-check-label">Previous School is this School</label>
                        </div>
                        <div id="previous-school-fields" class="row ${currentStudent.prevSchoolSame ? 'd-none' : ''}"> <div class="col-md-6 mb-3">
                                <label for="preSchool" class="form-label">Previous School Name</label>
                                <input id="preSchool" type="text" class="form-control" value="${currentStudent.preSchool || ''}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="preClass" class="form-label">Last Class Attended</label>
                                <input id="preClass" type="text" class="form-control" value="${currentStudent.preClass || ''}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="preAdnumber" class="form-label">Previous Admission No.</label>
                                <input id="preAdnumber" type="text" class="form-control" value="${currentStudent.preAdnumber || ''}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="tcDate" class="form-label">Transfer Certificate Date</label>
                                <input id="tcDate" type="date" class="form-control" value="${currentStudent.tcDate || ''}">
                            </div>
                        </div>
                    </div>


                    <div class="border-bottom pb-3 mb-4">
                        <h5 class="text-primary">Student Photo</h5>
                        <div class="d-flex align-items-center gap-3">
                            <div class="w-36 h-48 bg-gray-200 rounded-lg flex-shrink-0 border overflow-hidden d-flex justify-content-center align-items-center">
                                <img id="student-photo-display" class="w-full h-full object-cover" src="https://drive.google.com/thumbnail?id=${currentStudent.photoDriveId}&sz=400" alt="Student Photo">
                            </div>
                            <div>
                                <label for="photo-upload-input" class="btn btn-outline-primary btn-sm me-2">
                                    <span>Choose Photo...</span>
                                    <input id="photo-upload-input" type="file" accept="image/*" class="d-none">
                                </label>
                                <button type="button" id="remove-photo-btn" class="btn btn-outline-danger btn-sm ${currentStudent.photoURL ? '' : 'd-none'}">
                                    Remove Photo
                                </button>
                                <p class="text-muted small mt-2">Recommended size: 300x400 pixels (3:4 aspect ratio).</p>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary btn-lg">${buttonText}</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="photo-crop-modal" class="modal fade" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Crop Photo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="bg-dark d-flex justify-content-center align-items-center" style="height: 400px; overflow: hidden;">
                                    <img id="image-to-crop" src="" alt="Image to crop" style="max-width: 100%; max-height: 100%;">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6 class="text-center mb-3">Live Preview (3:4)</h6>
                                <div id="crop-preview" class="mx-auto bg-light overflow-hidden border" style="width: 144px; height: 192px;"></div>
                                <div class="d-flex flex-wrap justify-content-center gap-1 mt-3">
                                    <button type="button" id="zoom-in-btn" title="Zoom In" class="btn btn-outline-secondary btn-sm"><i class="fas fa-search-plus"></i></button>
                                    <button type="button" id="zoom-out-btn" title="Zoom Out" class="btn btn-outline-secondary btn-sm"><i class="fas fa-search-minus"></i></button>
                                    <button type="button" id="move-left-btn" title="Move Left" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left"></i></button>
                                    <button type="button" id="move-right-btn" title="Move Right" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-right"></i></button>
                                    <button type="button" id="move-up-btn" title="Move Up" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-up"></i></button>
                                    <button type="button" id="move-down-btn" title="Move Down" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-down"></i></button>
                                    <button type="button" id="reset-crop-btn" title="Reset" class="btn btn-outline-secondary btn-sm"><i class="fas fa-sync-alt"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="cancel-crop-btn" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="crop-photo-btn" class="btn btn-primary">Crop & Use</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // --- DOM Element References ---
    const classDropdown = document.getElementById('classId');
    const divisionDropdown = document.getElementById('division');
    const admnSector = document.getElementById('admissionSector');
    const admnNum = document.getElementById('admissionNumber');
    const admnId = document.getElementById('admissionId');
    const dobInput = document.getElementById('dob');
    const admissionDateInput = document.getElementById('admissionDate');
    const hasSiblingCheckbox = document.getElementById('has-sibling');
    const siblingInfoDiv = document.getElementById('sibling-info');
    const siblingWhatsAppNumberInput = document.getElementById('whatsappNo');// document.getElementById('siblingWhatsAppNumber');
    const siblingDetailsDisplay = document.getElementById('sibling-details-display');
    const photoUploadInput = document.getElementById('photo-upload-input');
    const studentPhotoDisplay = document.getElementById('student-photo-display');
    const removePhotoBtn = document.getElementById('remove-photo-btn');
    const photoCropModalElement = document.getElementById('photo-crop-modal');
    const photoCropModal = new bootstrap.Modal(photoCropModalElement);
    const imageToCrop = document.getElementById('image-to-crop');
    const cropPreview = document.getElementById('crop-preview');

    // NEW: Guardian Type and Previous School fields
    const guardianTypeSelect = document.getElementById('guardian-type');
    const localGuardianFieldsDiv = document.getElementById('local-guardian-fields');
    const prevSchoolSameCheckbox = document.getElementById('prevSchoolSame');
    const previousSchoolFieldsDiv = document.getElementById('previous-school-fields');


    //studentPhotoDisplay.src = `https://drive.google.com/thumbnail?id=${currentStudent.photoDriveId}&sz=400`;
   
    // --- Initializations and Event Listeners ---

    // Set initial DOB and Admission Date format
    const formElement = document.getElementById(formId);
    if (formElement) {
        formElement.addEventListener('input', () => saveFormToLocalStorage(formId));
    }

    loadFormFromLocalStorage(formId);

    if (currentStudent.dob) {
        dobInput.value = currentStudent.dob;
        window.formatDate(dobInput);
    }
    if (currentStudent.admissionDate) {
        admissionDateInput.value = currentStudent.admissionDate;
        window.formatDate(admissionDateInput);
    }

    // Initialize Division Dropdown
    const updateDivisions = () => {
        const selectedClass = classes.find(c => c.id === classDropdown.value);
        divisionDropdown.innerHTML = '<option value="">-- Select Division --</option>';
        if (selectedClass && selectedClass.divisions) {
            divisionDropdown.innerHTML += selectedClass.divisions.map(d =>
                `<option value="${d}" ${currentStudent.division === d ? 'selected' : ''}>${d}</option>`
            ).join('');
        }
    };
    updateDivisions();

    // Generate Admission Number (if not in edit mode)
    
        const generateAdmnNo = async () => {
    if (isEditMode) return;

    const sector = admnSector.value;
    if (!sector) return;

    // 1. Determine the start of the current academic year (e.g., June 1st).
    const now = new Date();
    const currentYear = now.getFullYear();
    const academicYearStartMonth = 5; // June (0-indexed)
    const academicYearStartDate = new Date(now.getMonth() < academicYearStartMonth ? currentYear - 1 : currentYear, academicYearStartMonth, 1);

    // 2. Fetch all students for the selected sector.
    const q = query(getCollectionRef('students'), where('admissionSector', '==', sector));
    const snapshot = await getDocs(q);

    // 3. Filter on the client-side to find only students admitted in the current academic year.
    const studentsInCurrentYear = snapshot.docs.filter(doc => {
        const admissionDateStr = doc.data().admissionDate;
        if (!admissionDateStr) return false;
        // Convert DD/MM/YYYY string to a valid Date object for comparison.
        const parts = admissionDateStr.split('/');
        if (parts.length !== 3) return false; // Invalid date format
        const admissionDate = new Date(parts[2], parts[1] - 1, parts[0]);
        return admissionDate >= academicYearStartDate;
    });

    // 4. Find the highest existing admission number from this year's students.
    // This is more reliable than just counting, as it handles deleted records correctly.
    let maxAdmnNum = 0;
    studentsInCurrentYear.forEach(studentDoc => {
        const admnNum = parseInt(studentDoc.data().admissionNumber, 10);
        if (!isNaN(admnNum) && admnNum > maxAdmnNum) {
            maxAdmnNum = admnNum;
        }
    });

    // 5. The next admission number is the highest number found, plus one.
    const nextAdmnNum = maxAdmnNum + 1;

    // 6. Generate the new ID and Admission Number using this corrected count.
    admnId.value = `${sector}_${new Date().getFullYear().toString().slice(-2)}_${nextAdmnNum.toString().padStart(4, '0')}`;
    admnNum.value = nextAdmnNum.toString().padStart(4, '0');

    updateDivisions();
};

            // --- NEW: Guardian Type Listener ---
    guardianTypeSelect.addEventListener('change', () => {
        if (guardianTypeSelect.value === 'Local Guardian') {
            localGuardianFieldsDiv.classList.remove('d-none');
        } else {
            localGuardianFieldsDiv.classList.add('d-none');
            // Clear fields if hidden
            document.getElementById('localGuardianName').value = '';
            document.getElementById('localGuardianRelation').value = '';
        }
    });

    // --- NEW: Previous School Same Checkbox Listener ---
    prevSchoolSameCheckbox.addEventListener('change', () => {
        if (prevSchoolSameCheckbox.checked) {
            previousSchoolFieldsDiv.classList.add('d-none');
            // Clear fields if hidden
            document.getElementById('preSchool').value = '';
            document.getElementById('preClass').value = '';
            document.getElementById('preAdnumber').value = '';
            document.getElementById('tcDate').value = '';
        } else {
            previousSchoolFieldsDiv.classList.remove('d-none');
        }
    });
                
     if(!isEditMode) generateAdmnNo();
    // Event Listeners for dynamic fields
    classDropdown.addEventListener('change', updateDivisions);
    admnSector.addEventListener('change', generateAdmnNo);
    
    // Sibling Info Toggle
    hasSiblingCheckbox.addEventListener('change', () => {
        siblingInfoDiv.classList.toggle('d-none', !hasSiblingCheckbox.checked);
        if (!hasSiblingCheckbox.checked) {
            siblingWhatsAppNumberInput.value = '';
            siblingDetailsDisplay.innerHTML = 'Details will appear here...';
        }
    });

    // Sibling WhatsApp Number Lookup
    siblingWhatsAppNumberInput.addEventListener('blur', async () => {
        const siblingWhatsAppNo = siblingWhatsAppNumberInput.value.trim();
        const studentWhatsAppNo = document.getElementById('whatsappNo').value.trim();

        if (siblingWhatsAppNo && siblingWhatsAppNo) {
            siblingDetailsDisplay.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Searching...';
            try {
                const q = query(getCollectionRef('students'), where('whatsappNo', '==', siblingWhatsAppNo));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    const siblingData = snapshot.docs[0].data();
                    siblingDetailsDisplay.innerHTML = `<strong>Name:</strong> ${siblingData.name}<br><strong>Class:</strong> ${siblingData.classId} - ${siblingData.division}<br><strong>Admission No:</strong> ${siblingData.id}`;
                    
                } else {
                    siblingDetailsDisplay.innerHTML = '<span class="text-danger">Sibling not found with this WhatsApp number.</span>';
                }
            } catch (error) {
                console.error("Error querying sibling:", error);
                siblingDetailsDisplay.innerHTML = '<span class="text-danger">Error searching sibling.</span>';
            }
        } else if (siblingWhatsAppNo === studentWhatsAppNo && siblingWhatsAppNo !== '') {
            siblingDetailsDisplay.innerHTML = '<span class="text-warning">Cannot be self.</span>';
            siblingWhatsAppNumberInput.value = '';
        } else {
            siblingDetailsDisplay.innerHTML = 'Details will appear here...';
        }
    });

    // ------------------------
// 1. Photo Upload & Modal Show
// ------------------------
if (isEditMode && currentStudent.photoDriveId) { // Check for photoDriveId
    // Construct the thumbnail URL
   // studentPhotoDisplay.src = `https://drive.google.com/thumbnail?id=${currentStudent.photoDriveId}&sz=400`;
    currentPhotoURL = currentStudent.photoURL; // Still keep the full URL if needed for other purposes
    removePhotoBtn.classList.remove('d-none');
} else {
   // studentPhotoDisplay.src = 'https://via.placeholder.com/150x200?text=No+Photo';
    removePhotoBtn.classList.add('d-none');
}

photoUploadInput.addEventListener('change', (event) => {
    const files = event.target.files;
    if (!files || !files.length) return;

    rawPhotoFile = files[0];
    const reader = new FileReader();

    reader.onload = (e) => {
        const imageUrl = e.target.result;

        // Assign onload before setting src
        imageToCrop.onload = () => {
            console.log("DEBUG: imageToCrop.onload fired.");

            if (typeof Cropper !== 'function') {
                console.error("Cropper.js library not loaded as a function.");
                showAlert("Image cropping feature is unavailable. Cropper.js not found.", "danger");
                photoCropModal.hide();
                return;
            }

            if (cropper) cropper.destroy();

            cropper = new Cropper(imageToCrop, {
                aspectRatio: 3 / 4,
                viewMode: 1,
                preview: cropPreview,
                autoCropArea: 0.8,
                zoomable: true,
                movable: true,
            });

            console.log("DEBUG: Cropper instance created.");
        };

        imageToCrop.src = imageUrl; // Triggers imageToCrop.onload
        photoCropModal.show();      // Show Bootstrap modal
    };

    reader.readAsDataURL(rawPhotoFile);
});

// ------------------------
// 2. Cropper Control Buttons
// ------------------------

document.getElementById('zoom-in-btn')?.addEventListener('click', () => cropper?.zoom(0.1));
document.getElementById('zoom-out-btn')?.addEventListener('click', () => cropper?.zoom(-0.1));
document.getElementById('move-left-btn')?.addEventListener('click', () => cropper?.move(-10, 0));
document.getElementById('move-right-btn')?.addEventListener('click', () => cropper?.move(10, 0));
document.getElementById('move-up-btn')?.addEventListener('click', () => cropper?.move(0, -10));
document.getElementById('move-down-btn')?.addEventListener('click', () => cropper?.move(0, 10));
document.getElementById('reset-crop-btn')?.addEventListener('click', () => cropper?.reset());

// ------------------------
// 3. Confirm Crop & Use
// ------------------------

document.getElementById('crop-photo-btn')?.addEventListener('click', () => {
    if (!cropper) return;

    cropper.getCroppedCanvas({
        width: 300,
        height: 400,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high',
    }).toBlob((blob) => {
        croppedPhotoBlob = blob;
        studentPhotoDisplay.src = URL.createObjectURL(blob);
        removePhotoBtn.classList.remove('d-none');
        photoCropModal.hide();
        cropper.destroy();
        cropper = null;
    }, 'image/jpeg', 0.9);
});

// ------------------------
// 4. Cancel Crop
// ------------------------

document.getElementById('cancel-crop-btn')?.addEventListener('click', () => {
    rawPhotoFile = null;
    croppedPhotoBlob = null;
    photoCropModal.hide();
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
});

// ------------------------
// 5. Remove Existing Photo
// ------------------------

removePhotoBtn.addEventListener('click', async () => {
    if (!confirm('Are you sure you want to remove the student photo?')) return;

    if (currentPhotoURL && currentStudent.photoURL === currentPhotoURL) {
        try {
            await deleteFileFromStorage(currentPhotoURL);
            showAlert('Photo removed from cloud storage.', 'info');
        } catch (error) {
            console.error('Error deleting photo from storage:', error);
            showAlert('Failed to remove photo from cloud storage.', 'danger');
        }
    }

    currentPhotoURL = '';
    croppedPhotoBlob = null;
    studentPhotoDisplay.src = 'https://placehold.co/150x200?text=No+Photo&font=roboto';
    removePhotoBtn.classList.add('d-none');

    //if (isEditMode) studentToEdit.photoURL = '';
});


    // --- Form Submission Handler ---
    document.getElementById('add-student-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;

        if (!form.checkValidity()) {
            e.stopPropagation();
            form.classList.add('was-validated');
            showAlert('Please fill in all required fields correctly.', 'warning');
            return;
        }
        form.classList.add('was-validated');

        const studentData = {
            id: admnId.value,
            name: document.getElementById('name').value.trim(),
            dob: document.getElementById('dob').value.trim(),
            gender: document.getElementById('gender').value,
            aadhaar: document.getElementById('aadhaar').value.trim(),
            nationality: document.getElementById('nationality').value,
            birthPlace: document.getElementById('birthPlace').value.trim(),

            admissionSector: admnSector.value,
            admissionNumber: admnNum.value,
            admissionDate: admissionDateInput.value.trim(),
            instructionMedium: document.getElementById('instructionMedium').value,
            classId: classDropdown.value,
            division: divisionDropdown.value,
            aplBpl: document.getElementById('aplBpl').value,
            busPoint: document.getElementById('busPoint').value.trim(),
            vehicleStage: document.getElementById('vehicleStage').value.trim(),

            hasSibling: hasSiblingCheckbox.checked,
            siblingWhatsAppNumber: hasSiblingCheckbox.checked ? siblingWhatsAppNumberInput.value.trim() : '',

            fatherName: document.getElementById('fatherName').value.trim(),
            motherName: document.getElementById('motherName').value.trim(),
            guardianType: guardianTypeSelect.value, // NEW
            localGuardianName: guardianTypeSelect.value === 'Local Guardian' ? document.getElementById('localGuardianName').value.trim() : '', // NEW
            localGuardianRelation: guardianTypeSelect.value === 'Local Guardian' ? document.getElementById('localGuardianRelation').value.trim() : '', // NEW


            mobile1: document.getElementById('mobile1').value.trim(),
            mobile2: document.getElementById('mobile2').value.trim(),
            whatsappNo: document.getElementById('whatsappNo').value.trim(),
            
            houseName: document.getElementById('houseName').value.trim(),
            place: document.getElementById('place').value.trim(),
            state: document.getElementById('state').value,
            district: document.getElementById('district').value,
            taluk: document.getElementById('taluk').value.trim(),
            postOffice: document.getElementById('postOffice').value.trim(),
            pin: document.getElementById('pin').value.trim(),

            prevSchoolSame: prevSchoolSameCheckbox.checked, // NEW
            preSchool: prevSchoolSameCheckbox.checked ? '' : document.getElementById('preSchool').value.trim(), // NEW
            preClass: prevSchoolSameCheckbox.checked ? '' : document.getElementById('preClass').value.trim(), // NEW
            preAdnumber: prevSchoolSameCheckbox.checked ? '' : document.getElementById('preAdnumber').value.trim(), // NEW
            tcDate: prevSchoolSameCheckbox.checked ? '' : document.getElementById('tcDate').value, // NEW
            

            photoURL: '' 
        };

        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonHtml = submitButton.innerHTML;
        submitButton.disabled = true;
        submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...`;

        try {
            let newPhotoURL = '';
            let newPhotoDriveId = '';

            if (croppedPhotoBlob) {
                console.log(croppedPhotoBlob);
                showAlert('Uploading photo to Drive...', 'info');
                const uploadResult = await uploadPhotoToDrive(croppedPhotoBlob, studentData.admissionNumber);
                console.log(uploadResult);

                if (uploadResult && uploadResult.success) {

                    newPhotoURL = uploadResult.fileUrl; // <--- Photo URL from Drive
                    newPhotoDriveId = uploadResult.fileId; // <--- Photo ID from Drive
                    studentData.photoURL = uploadResult.fileUrl; // This is the standard view link
                    studentData.photoDriveId = uploadResult.fileId; // This is the ID you need for thumbnails

                    showAlert('Photo uploaded successfully to Drive!', 'success');
                } else {
                    showAlert('Failed to upload photo to Drive. Saving student without photo.', 'danger');
                    console.error('Drive upload failed:', uploadResult);
                }
            } else if (currentPhotoURL && currentPhotoURL !== 'https://via.placeholder.com/150x200?text=No+Photo') {
                // If no new photo cropped, but there's an existing photo (retained)
                newPhotoURL = currentPhotoURL;
                // Try to get the existing Drive ID from currentStudent or parse from URL
                newPhotoDriveId = isEditMode ? (studentToEdit.photoDriveId || studentToEdit.photoURL.match(/\/d\/([a-zA-Z0-9_-]+)/)?.[1] || '') : '';
            } else {
                // No photo, or photo was explicitly removed
                newPhotoURL = '';
                newPhotoDriveId = '';
            }

            studentData.photoURL = newPhotoURL; // This is the standard view link
            studentData.photoDriveId = newPhotoDriveId; // This is the ID you need for thumbnails


            // Save Student Data to Firestore (studentData contains only URL and ID, not the actual image)
            await setDoc(getDocRef('students', studentData.id), studentData);

            
            showAlert(`Student ${isEditMode ? 'updated' : 'added'} successfully.`, 'success');
            
            if (isEditMode) {
                studentToEdit = null;
                navigateTo('student-mgt');
            } else {
                form.reset();
                form.classList.remove('was-validated');
                studentPhotoDisplay.src = 'https://placehold.co/150x200?text=No+Photo&font=roboto' ;
                removePhotoBtn.classList.add('d-none');
                updateDivisions();
                generateAdmnNo();
                siblingInfoDiv.classList.add('d-none');
                siblingDetailsDisplay.innerHTML = 'Details will appear here...';
                rawPhotoFile = null;
                croppedPhotoBlob = null;
                currentPhotoURL = '';
            }
            localStorage.removeItem(`formData_${formId}`);
         
        } catch (error) {
            console.error('Error saving student:', error);
            showAlert('Failed to save student data. Please try again.', 'danger');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonHtml;
            localStorage.removeItem(`formData_${formId}`);
        }
    });

};



window.formatDate = (input) => {
    let value = input.value.replace(/\D/g, ''); // Remove non-digits
    if (value.length > 2) value = value.slice(0, 2) + '/' + value.slice(2);
    if (value.length > 5) value = value.slice(0, 5) + '/' + value.slice(5, 9);
    input.value = value;

    // Optional: Display date in words
    const dobWordsSpan = document.getElementById('dob-words');
    if (dobWordsSpan) {
        try {
            const [day, month, year] = value.split('/').map(Number);
            if (day && month && year && year > 1900 && year < 2100) { // Basic validation
                const dateObj = new Date(year, month - 1, day);
                dobWordsSpan.textContent = dateObj.toLocaleDateString('en-US', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
            } else {
                dobWordsSpan.textContent = '';
            }
        } catch (e) {
            dobWordsSpan.textContent = '';
        }
    }
};

window.formatAadhaar = (input) => {
    let value = input.value.replace(/\D/g, ''); // Remove non-digits
    if (value.length > 4) value = value.slice(0, 4) + ' ' + value.slice(4);
    if (value.length > 9) value = value.slice(0, 9) + ' ' + value.slice(9);
    input.value = value;
};




        let currentFilteredStudents = []; // Store the full list of filtered students

window.renderStudentManagement = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }

    const currentYear = new Date().getFullYear();
    const currentAcademicYear = `${currentYear}-${currentYear + 1}`;
    const classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Student Management</h1>
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">Filter Students</h5>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="show-inactive-toggle">
                        <label class="form-check-label" for="show-inactive-toggle">Show Inactive Students</label>
                    </div>
                </div>
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="filter-class" class="form-label">Class</label>
                        <select id="filter-class" class="form-select">
                            <option value="">-- All Classes --</option>
                            ${classOptions}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filter-division" class="form-label">Division</label>
                        <select id="filter-division" class="form-select" disabled>
                            <option value="">-- All Divisions --</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="student-search-input" class="form-label">Search (Admn No. or Name)</label>
                        <input type="text" id="student-search-input" class="form-control" placeholder="Search by Admn No. or Name">
                    </div>
                    <div class="col-md-2 d-flex justify-content-end">
                        <button id="new-admissions-btn" class="btn btn-outline-info w-100">
                            New Admissions (${currentAcademicYear})
                        </button>
                    </div>
                </div>
                <hr class="mt-4 mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                         <button id="export-students-btn" class="btn btn-success btn-sm">
                             <i class="fas fa-file-excel me-1"></i> Export Filtered Data
                         </button>
                    </div>
                    <div>
                        <button id="toggle-report-btn" class="btn btn-info btn-sm me-2">
                            <i class="fas fa-chart-pie me-1"></i> Show/Hide Report
                        </button>
                        <button id="reset-filters-btn" class="btn btn-outline-secondary btn-sm">Reset Filters</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="student-report-section" class="card shadow mb-4 d-none">
            <div class="card-header fw-bold text-primary d-flex justify-content-between align-items-center">
                <span id="admission-report-title">Admission Report</span>
                <button id="print-admission-report-btn" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-print me-1"></i> Print Report
                </button>
            </div>
            <div class="card-body" id="admission-report-content"></div>
        </div>

        <div class="card shadow">
            <div class="card-header fw-bold text-primary" id="student-list-title">Student List (Active Students)</div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span class="text-muted">Showing <span id="pagination-start">0</span> to <span id="pagination-end">0</span> of <span id="pagination-total">0</span> students</span>
                    </div>
                    <div class="btn-group" role="group" aria-label="Pagination controls">
                        <button id="prev-page-btn" class="btn btn-outline-primary btn-sm" disabled>Previous</button>
                        <button id="next-page-btn" class="btn btn-outline-primary btn-sm" disabled>Next</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>id</th>
                                <th>Admn No</th>
                                <th>Name</th>
                                <th>Class</th>
                                ${currentUserRole === 'admin' ? '<th class="text-end">Actions</th>' : ''}
                            </tr>
                        </thead>
                        <tbody id="student-list-tbody"></tbody>
                    </table>
                </div>
                <p id="no-students-message" class="text-muted text-center mt-3 d-none">No students found matching your criteria.</p>
            </div>
        </div>
    `;

    const filterClassDropdown = document.getElementById('filter-class');
    const filterDivisionDropdown = document.getElementById('filter-division');
    const studentSearchInput = document.getElementById('student-search-input');
    const newAdmissionsBtn = document.getElementById('new-admissions-btn');
    const resetFiltersBtn = document.getElementById('reset-filters-btn');
    const exportStudentsBtn = document.getElementById('export-students-btn');
    const toggleReportBtn = document.getElementById('toggle-report-btn');
    const studentReportSection = document.getElementById('student-report-section');
    const showInactiveToggle = document.getElementById('show-inactive-toggle');

    let currentPage = 1;
    const studentsPerPage = 50;
    let currentFilteredStudents = [];

    const updateFilterDivisions = () => {
        const selectedClass = classes.find(c => c.id === filterClassDropdown.value);
        filterDivisionDropdown.innerHTML = '<option value="">-- All Divisions --</option>';
        if (selectedClass?.divisions) {
            filterDivisionDropdown.disabled = false;
            filterDivisionDropdown.innerHTML += selectedClass.divisions.map(d => `<option value="${d}">${d}</option>`).join('');
        } else {
            filterDivisionDropdown.disabled = true;
        }
        currentPage = 1;
        filterAndRenderStudents();
    };

    const filterAndRenderStudents = (genderFilter = null) => {
        const admissionReportContent = document.getElementById('admission-report-content');
        const showInactive = showInactiveToggle.checked;

        // --- MODIFICATION: Choose the base student list based on the toggle ---
        document.getElementById('student-list-title').textContent = `Student List (${showInactive ? 'Inactive' : 'Active'} Students)`;
        document.getElementById('admission-report-title').textContent = `Admission Report (${showInactive ? 'Inactive' : 'Active'} Students)`;

        let baseStudentList = showInactive
            ? students.filter(s => s.status === 'TC Issued' || s.status === 'Graduated')
            : students.filter(s => s.status !== 'TC Issued' && s.status !== 'Graduated');

        const filterClassId = filterClassDropdown.value;
        const filterDivision = filterDivisionDropdown.value;
        const searchTerm = studentSearchInput.value.toLowerCase();
        const isNewAdmissionsFiltered = newAdmissionsBtn.classList.contains('btn-info');
        
        let studentsToFilter = currentUserRole === 'teacher' 
            ? baseStudentList.filter(s => s.classId === selectedUser.classCharge?.classId && s.division === selectedUser.classCharge?.division) 
            : baseStudentList;

        if (filterClassId) studentsToFilter = studentsToFilter.filter(s => s.classId === filterClassId);
        if (filterDivision) studentsToFilter = studentsToFilter.filter(s => s.division === filterDivision);
        if (searchTerm) {
            studentsToFilter = studentsToFilter.filter(s => {
                const name = s.name?.toLowerCase() || '';
                const admnNo = String(s.admissionNumber || '');
                return name.includes(searchTerm) || admnNo.includes(searchTerm);
            });
        }
        if (isNewAdmissionsFiltered) {
            const currentYear = new Date().getFullYear();
            studentsToFilter = studentsToFilter.filter(s => {
                if (s.admissionDate) return new Date(s.admissionDate).getFullYear() === currentYear;
                return false;
            });
        }
        if (genderFilter === 'M' || genderFilter === 'F') {
            studentsToFilter = studentsToFilter.filter(s => s.gender === genderFilter);
        }

        studentsToFilter.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
        currentFilteredStudents = studentsToFilter;
        
        renderPaginatedStudents();

        if (currentFilteredStudents.length > 0) {
            generateAdmissionReport(studentsToFilter, admissionReportContent);
        } else {
            studentReportSection.classList.add('d-none');
            admissionReportContent.innerHTML = '';
        }
    };

    const renderPaginatedStudents = () => {
        const studentListTbody = document.getElementById('student-list-tbody');
        const noStudentsMessage = document.getElementById('no-students-message');
        const paginationTotal = document.getElementById('pagination-total');
        const paginationStart = document.getElementById('pagination-start');
        const paginationEnd = document.getElementById('pagination-end');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        
        const totalStudents = currentFilteredStudents.length;
        const totalPages = Math.ceil(totalStudents / studentsPerPage);
        
        const startIndex = (currentPage - 1) * studentsPerPage;
        const endIndex = Math.min(startIndex + studentsPerPage, totalStudents);
        const studentsToDisplay = currentFilteredStudents.slice(startIndex, endIndex);

        paginationTotal.textContent = totalStudents;
        paginationStart.textContent = totalStudents > 0 ? startIndex + 1 : 0;
        paginationEnd.textContent = endIndex;
        
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;

        if (studentsToDisplay.length > 0) {
            studentListTbody.innerHTML = studentsToDisplay.map(s => {
                const cls = classes.find(c => c.id === s.classId);
                return `<tr>
                    <td>${s.id || 'id'}</td>
                    <td>${s.admissionNumber || 'N/A'}</td>
                    <td><a href="#" class="student-name-link fw-bold" data-id="${s.id}">${s.name || 'N/A'}</a></td>
                    <td>${cls?.name || 'N/A'} - ${s.division || 'N/A'}</td>
                    ${currentUserRole === 'admin' ? `<td class="text-end">
                        <button onclick="window.handleEditStudent('${s.id}')" class="btn btn-sm btn-outline-primary me-2" title="Edit"><i class="fas fa-edit"></i></button>
                        <button onclick="window.handleDelete('students', '${s.id}')" class="btn btn-sm btn-outline-danger" title="Delete"><i class="fas fa-trash-alt"></i></button>
                        <button onclick="window.showAdmissionExtractModal('${s.id}')" class="btn btn-sm btn-outline-info ad-form-btn" title="Admission Form"><i class="fas fa-file-alt"></i></button>
                    </td>` : ''}
                </tr>`;
            }).join('');
            noStudentsMessage.classList.add('d-none');
        } else {
            studentListTbody.innerHTML = '';
            noStudentsMessage.classList.remove('d-none');
        }
    };
    
    // --- EVENT LISTENERS ---
    
    showInactiveToggle.addEventListener('change', () => filterAndRenderStudents());
    toggleReportBtn.addEventListener('click', () => studentReportSection.classList.toggle('d-none'));

    studentReportSection.addEventListener('click', (e) => {
        if (e.target.id === 'print-admission-report-btn') {
            printContentOfDiv('admission-report-content', 'Admission Report');
        }
    });

    filterClassDropdown.addEventListener('change', updateFilterDivisions);
    filterDivisionDropdown.addEventListener('change', () => { currentPage = 1; filterAndRenderStudents(); });
    studentSearchInput.addEventListener('input', () => { currentPage = 1; filterAndRenderStudents(); });

    let isNewAdmissionsFiltered = false;
    newAdmissionsBtn.addEventListener('click', () => {
        isNewAdmissionsFiltered = !isNewAdmissionsFiltered;
        newAdmissionsBtn.classList.toggle('btn-info');
        newAdmissionsBtn.classList.toggle('btn-outline-info');
        currentPage = 1;
        filterAndRenderStudents();
    });

    resetFiltersBtn.addEventListener('click', () => {
        filterClassDropdown.value = '';
        filterDivisionDropdown.value = '';
        filterDivisionDropdown.disabled = true;
        studentSearchInput.value = '';
        isNewAdmissionsFiltered = false;
        newAdmissionsBtn.classList.remove('btn-info');
        newAdmissionsBtn.classList.add('btn-outline-info');
        currentPage = 1;
        filterAndRenderStudents();
    });

    document.getElementById('prev-page-btn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderPaginatedStudents(); } });
    document.getElementById('next-page-btn').addEventListener('click', () => { const totalPages = Math.ceil(currentFilteredStudents.length / studentsPerPage); if (currentPage < totalPages) { currentPage++; renderPaginatedStudents(); } });
    exportStudentsBtn.addEventListener('click', () => exportFilteredStudentsToCsv(currentFilteredStudents));

    document.getElementById('student-list-tbody').addEventListener('click', (e) => {
        const studentNameLink = e.target.closest('.student-name-link');
        if (studentNameLink) { e.preventDefault(); populateAndShowFullStudentModal(studentNameLink.dataset.id); }
        const adFormButton = e.target.closest('.ad-form-btn');
        if (adFormButton) { e.preventDefault(); showAdmissionExtractModal(adFormButton.dataset.id); }
    });

    document.getElementById('print-student-extract-btn')?.addEventListener('click', showAdmissionExtractModal);
    document.getElementById('print-student-details-btn')?.addEventListener('click', () => {
        const studentName = document.getElementById('fullStudentDetailModalLabel').textContent.replace('Student Details: ', '');
        printContentOfDiv('student-details-printable', `Student Profile - ${studentName}`);
    });

    // Initial Render
    updateFilterDivisions();
};

/**
 * Creates and downloads a CSV file from the filtered student data.
 * @param {Array<object>} students - The list of students to export.
 */
function exportFilteredStudentsToCsv(students) {
    if (!students || students.length === 0) {
        alert('No students to export.');
        return;
    }

    const headers = ["ID", "Admission Number", "Name", "Class", "Division", "Gender", "Admission Date"];
    const csvRows = [headers.join(',')];

    students.forEach(student => {
        const classInfo = classes.find(c => c.id === student.classId);
        const className = classInfo ? classInfo.name : 'N/A';

        const row = [
            `"${student.id || ''}"`,
            `"${student.admissionNumber || ''}"`,
            `"${student.name || ''}"`,
            `"${className}"`,
            `"${student.division || ''}"`,
            `"${student.gender || ''}"`,
            `"${student.admissionDate || ''}"`
        ];
        csvRows.push(row.join(','));
    });

    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    const date = new Date().toISOString().slice(0, 10);
    link.href = URL.createObjectURL(blob);
    link.setAttribute('download', `student_list_${date}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    alert(`Successfully exported ${students.length} students to CSV.`);
}

/**
 * Displays the Admission Extract (FORM 3) for a specific student in a modal.
 * @param {string} studentId - The ID of the student.
 */
window. showAdmissionExtractModal=(studentId) => {
    const student = students.find(s => s.id === studentId);
    if (!student) {
        showAlert('Student details not found for Admission Extract.', 'danger');
        return;
    }

    const modalBody = document.getElementById('admission-extract-modal-body');
    const modalTitle = document.getElementById('admissionExtractModalLabel');

    modalBody.innerHTML = generateAdmissionExtractHTML(student);
    modalTitle.textContent = `Admission Extract (FORM 3) - ${student.name}`;

    const admissionExtractModal = new bootstrap.Modal(document.getElementById('admissionExtractModal'));
    admissionExtractModal.show();

    // Attach print listener to the modal's print button
    document.getElementById('print-admission-extract-btn').onclick = () => {
        printContentOfDiv('admission-extract-modal-body', `Admission Extract - ${student.name}`, {
            pageSize: 'A4 portrait',
            pageMargins: '0.3cm',
            extraCss: `
                /* Specific CSS for Admission Extract Form in print */
                .admission-extract-content { font-size: 0.9em; line-height: 1.0; }
                .admission-extract-content table, .admission-extract-content th, .admission-extract-content td {
                    border-color: #000 !important; /* Ensure black borders for print */
                    font-size: 0.9em;
                    padding: 2px 2px; /* Tighter padding */
                }
                .admission-extract-content h3, .admission-extract-content h4, .admission-extract-content h5, .admission-extract-content h6 {
                    margin-top: 2px !important; margin-bottom: 2px !important;
                }
                .admission-extract-content p { margin-top: 1px !important; margin-bottom: 1px !important; }
                .admission-extract-content .photo-cell img { border: none !important; } /* Remove border from photo if it has one */
                /* Ensure specific elements like signature lines fit */
                #signature-line { height: 1.5em; border-bottom: 1px solid #000; display: inline-block; width: 60%; vertical-align: bottom; }
                .text-underline { text-decoration: underline; }
            `
        });
    };
}


// Helper to format date into "DD/MM/YYYY"
const formatSlashDate = (dateStr) => {
    if (!dateStr) return 'N/A';
    try {
        const d = new Date(dateStr);
        // Ensure date is valid after parsing
        if (isNaN(d.getTime())) return 'N/A';
        return d.toLocaleDateString('en-GB'); // DD/MM/YYYY
    } catch (e) {
        console.error("Error formatting date:", dateStr, e);
        return 'N/A';
    }
};

// Helper to convert number to words for dates (simplified version)
const numberToWords = (num) => {
    const units = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
    const teens = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
    const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];

    if (num === 0) return 'zero';
    if (num < 10) return units[num];
    if (num >= 10 && num < 20) return teens[num - 10];
    if (num < 100) return tens[Math.floor(num / 10)] + (num % 10 !== 0 ? '-' + units[num % 10] : '');
    // For numbers > 99, this simple function will return the number as a string.
    // For full number to words (hundreds, thousands), you'd need a more extensive function.
    return String(num);
};

// Helper to convert date to words (DD Month YYYY)
const dateToWords = (dateStr) => {
    if (!dateStr) return 'N/A';
    try {
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return 'N/A';
        const day = d.getDate();
        const month = d.toLocaleString('default', { month: 'long' });
        const year = d.getFullYear();
        return `${numberToWords(day).replace('-', ' ')} ${month} ${numberToWords(year).replace('-', ' ')}`;
    } catch (e) {
        console.error("Error converting date to words:", dateStr, e);
        return 'N/A';
    }
};


/**
 * Calculates age in years and completed months based on a specific date (June 1st of admission year).
 * @param {string} dobString - Student's Date of Birth (YYYY-MM-DD format).
 * @param {string} admissionDateString - Student's Admission Date (YYYY-MM-DD format).
 * @returns {string} Age in "X Years, Y Months" format.
 */
const calculateAgeForAdmission = (dobString, admissionDateString) => {
    if (!dobString || !admissionDateString) return 'N/A';
    try {
        const dob = new Date(dobString);
        const admissionYear = new Date(admissionDateString).getFullYear();
        const calculationDate = new Date(admissionYear, 5, 1); // June 1st of Admission Year

        if (isNaN(dob.getTime()) || isNaN(calculationDate.getTime())) return 'N/A';

        let ageYears = calculationDate.getFullYear() - dob.getFullYear();
        let ageMonths = calculationDate.getMonth() - dob.getMonth();

        if (calculationDate.getDate() < dob.getDate()) {
            ageMonths--; // Subtract a month if not yet past the DOB day in the calculation month
        }

        if (ageMonths < 0) {
            ageYears--;
            ageMonths += 12; // Adjust to positive months
        }

        return `${ageYears} Years, ${ageMonths} Months`;
    } catch (e) {
        console.error("Error calculating age for admission:", dobString, admissionDateString, e);
        return 'N/A';
    }
};


/**
 * Generates the HTML for the Admission Extract (FORM 3).
 * @param {object} student - The student data object.
 * @returns {string} The full HTML content for the admission extract.
 */
function generateAdmissionExtractHTML(student) {
    console.log(student);
    const schoolName = schoolDetails.fullname || 'KATTILANGADI YATHEEMKHANA HIGHER SECONDARY SCHOOL';
    const schoolAddressLine = 'ATHAVANAD-19094';

    // Prepare data for the template using new helper functions
    const formattedDob = formatSlashDate(student.dob);
    const wordsDob = dateToWords(student.dob);
    const calculatedAge = calculateAgeForAdmission(student.dob, student.admissionDate); // Use admissionDate for age calculation base
    
    const studentAdmittedClass = classes.find(c => c.id === student.classId)?.name || student.classId;
    const studentPhotoSrc = student.photoDriveId
        ? `https://drive.google.com/thumbnail?id=${student.photoDriveId}&sz=400`
        : 'https://placehold.co/100x150?text=Student+Photo';

    const childGenderPronoun = student.gender === 'M' ? 'son' : (student.gender === 'F' ? 'daughter' : 'child');
    const displayGuardian = student.guardianType === 'Local Guardian' ? student.localGuardianName : (student.fatherName || student.motherName);
    const displayRelation = student.guardianType === 'Local Guardian' ? student.localGuardianRelation : (student.guardianType || '');
    const localGuardianAddress = (student.localGuardianName && student.localGuardianAddress) ? `${student.localGuardianName}, ${student.localGuardianAddress}` : 'N/A';




    return `
        <div class="admission-extract-content" style="font-family: Arial, sans-serif; font-size: 0.9em; line-height: 1.3;">
            <div style="text-align: center; margin-bottom: 5px;">
                <h6 style="margin: 0;">FORM 3</h6>
                <p style="margin: 0; font-size: 0.8em;">(See rule VI-I (1))</p>
                <h4 style="margin: 2px 0 2px 0;">${schoolName}</h4>
                <h5 style="margin: 0; font-size: 1.1em;">APPLICATION FOR ADMISSION</h5>
            </div>
            
            <p style="margin-top: 0; margin-bottom: 5px;">FORM NO: <span style="font-weight: bold; color: red;"> ${student.id || 'N/A'} _ ${student.admissionNumber || 'N/A'}</span></p>
            
            <table style="margin-top:5px; border: 1px solid #000;">
                <tr>
                    <td style="width: 35%;">Name of Pupil with Initials:</td>
                    <th colspan="4" style="text-align: center; font-weight: bold;">${student.name || 'N/A'}</th>
                </tr>
                <tr>
                    <td>Name of Parent or Guardian and Relationship to the Pupil:</td>
                    <th colspan="3" style="height: 30px;">${student.fatherName || student.motherName || 'N/A'}</th>
                    <td rowspan="4" class="photo-cell" style="width: 120px; text-align: center; border-left: 1px solid #000;">
                        <img src="${studentPhotoSrc}" alt="Student Photo" style="width: 100px; height: 150px; object-fit: cover; display: block; margin: 0 auto;">
                    </td>
                </tr>
                <tr>
                    <td>Local Guardian Name & Relationship:</td>
                    <th colspan="3">${displayGuardian || 'N/A'} / ${displayRelation || 'N/A'}</th>
                </tr>
                <tr>
                    <td>Mark of Identification:</td>
                    <th colspan="3">${student.identification || ''}</th>
                </tr>
                <tr>
                    <td>Occupation and Address of Parent or Guardian:</td>
                    <th colspan="3">${student.occupation || 'N/A'}<br>${student.houseName || 'N/A'} (H), ${student.postOffice || 'N/A'} (PO), ${student.place || 'N/A'} PIN:${student.pin || 'N/A'}</th>
                </tr>
                <tr>
                    <th>Aadhar Number:<br><span style="font-size: larger; font-weight: bold;">${student.aadhaar || 'N/A'}</span></th>
                    <th colspan="2">Mobile No 1 : ${student.mobile1 || 'N/A'}</th>
                    <th colspan="2">Mobile No 2 : ${student.mobile2 || 'N/A'}</th>
                </tr>
                <tr>
                    <td rowspan="2">Name, Address, and Occupation of Local Guardian:</td>
                    <th colspan="4">${student.localGuardianName || ''}<br>${localGuardianAddress || ''}</th>
                </tr>
                <tr>
                    <th colspan="2">MobileNo: ${student.guardianNumber || ''}</th>
                    <th colspan="2">WhatsApp No: ${student.whatsappNo || ''}</th>
                </tr>
                <tr>
                    <td rowspan="2" colspan="1" style="text-align: center;">School Previously Attended:</td>
                    <td>Name of School</td>
                    <td>Standard:</td>
                    <td>Admission No:</td>
                    <td>TC Date:</td>
                </tr>
                <tr>
                    <th>${student.preSchool || ''}</th>
                    <th>${student.preClass || ''}</th>
                    <th>${student.preAdnumber || ''}</th>
                    <th>${formatSlashDate(student.tcDate)}</th>
                </tr>
                <tr>
                    <td rowspan="2" colspan="2">(a) Date of Birth (in figures and words )<br>(b) Whether certified extract from Registered of birth declaration form / the declaration from the Parent or Guardian / certificate from the Registered medical Practitioner has been produced (Vide Rule VI-I) or aadhar</td>
                    <th colspan="3" style="text-align: center; font-weight: bold;">${formattedDob}</th>
                </tr>
                <tr>
                    <th colspan="3" style="text-align: center; font-weight: bold;">${wordsDob}</th>
                </tr>
                <tr>
                    <td colspan="2">Age ( year and completed month given) :</td>
                    <th colspan="3"><span style="font-weight: bold;">${calculatedAge}</span> OLD</th>
                </tr>
                <tr>
                    <td>Religion / Caste:</td>
                    <th>${student.religion || 'ISLAM MAPPILA'}</th>
                    <th colspan="2">Nationality and State to which the pupil belongs</th>
                    <th>${student.nationality || 'INDIAN'}</th>
                </tr>
                <tr>
                    <th>Does the candidate belong ' SC/ST/OBC':</th>
                    <th>${student.casteCategory || 'OBC'}</th>
                    <th colspan="2">Standard to which admission is sought (in letter and words)</th>
                    <th>${studentAdmittedClass || 'N/A'}</th>
                </tr>
                <tr>
                    <th>The language in which the pupil desires to be instructed:</th>
                    <th>${student.instructionMedium==='1'?'ENGLISH':'MALAYALAM' || 'ENGLISH'}</th>
                    <td colspan="2">Mother Tongue of the pupil:</td>
                    <th>${student.motherTongue || 'MALAYALAM'}</th>
                </tr>
                <tr>
                    <td colspan="2">No. and date of transfer certificate produced on admission.:</td>
                    <th colspan="3">${student.tcNumber || ''}</th>
                </tr>
                <tr>
                    <td colspan="2">Whether immunized from Tetanus, Diphtheria, Measles polio and B.C.G</td>
                    <th colspan="3">${student.immunized || 'NO'}</th>
                </tr>
                <tr>
                    <td colspan="2"> First language </td>
                    <th colspan="3">${student.firstLanguage || 'ARABIC'}</th>
                </tr>
                <tr>
                    <td rowspan="2" colspan="1" style="text-align: center;">School Vehicle Needed:</td>
                    <th colspan="1" style="text-align: center;">Vehicle Need</th>
                    <th colspan="2" style="text-align: center;"> Pickup Point: </th>
                    <th style="text-align: center;"> Stage:</th>
                </tr>
                <tr>
                    <td colspan="1" style="text-align: center;">${student.vehicleNeed? "Yes" : "No"}</td>
                    <td colspan="2" style="text-align: center;">${student.busPoint || ''}</td>
                    <td style="text-align: center;">${student.vehicleStage || ''}</td>
                </tr>
                <tr>
                    <td>If siblings or relatives in any class,:</td>
                    <th colspan="1" style="text-align: center;">${student.hasSibling ? "Yes" : "No"}</th>
                    <th colspan="3">${student.siblingDetails || student.siblingWhatsAppNumber || ''}</th>
                </tr>
            </table>

            <p style="margin-top: 20px; margin-bottom: 5px;">I have read the school rules and undertake that my ward will abide by them. I declare the above details are correct to the best of my knowledge.</p>
            <h6 style="text-align: center; margin: 10px 0 5px 0;text-decoration: underline;">Age Declaration</h6>
            <p>I <b style="text-decoration: underline;"> ${student.guardian || student.motherName || 'N/A'} </b> do here declare the date of birth of my <b style="text-decoration: underline;"> ${childGenderPronoun} </b> ${student.name || 'N/A'} is <b style="text-decoration: underline;"> ${formattedDob} </b> in words <b style="text-decoration: underline;">${wordsDob}</b> and that I shall not ask in future for any change in the same.</p>
            
            <div style="text-align: left; margin-top: 20px; display: flex; justify-content: space-between;">
                <p>Place: KATTILANGADI</p>
                <p>Signature of Parent or Guardian: <span style="display: inline-block; width: 150px; border-bottom: 1px solid #000; height: 1em;"></span></p>
            </div>
            <p style="margin-top: 5px;">Date: ${formatSlashDate(student.admissionDate)}</p>
            
            <div style="margin-top: 20px;">
                <h6 style="margin: 0; text-align:center;text-decoration: underline;">To be filled in by the Vice Principal:</h6>
                <p style="text-align: center; display: flex; justify-content: space-between; align-items: flex-end; margin-top: 15px;">
                    <span>Date of Admission: <span style="display: inline-block; width: 100px; border-bottom: 1px solid #000; height: 1em;"></span></span>
                     <span>Standard to which admitted: <span style="display: inline-block; width: 100px; border-bottom: 1px solid #000; height: 1em;"></span></span>
                    </p>
                     <pstyle="text-align: center; display: flex; justify-content: space-between; align-items: flex-end;">
                       <span style="font-size:1.1em;"><b>Admission No: <b style="text-decoration: underline;"> ${student.admissionNumber || 'N/A'}</b></b></span>
                       <span style="text-align: right; margin-top: 30px;">Signature of Vice Principal: <span style="display: inline-block; width: 150px; border-bottom: 1px solid #000; height: 1em;"></span></span>
            
                        </p>
                </div>
        </div>
    `;
}

/**
 * Generates and displays a detailed admission report based on a given list of students.
 * The report provides a class-wise breakdown including gender counts and totals.
 * @param {Array<object>} studentsToReport - The list of students to generate the report for.
 * @param {HTMLElement} container - The DOM element to render the report into.
 */
function generateAdmissionReport(studentsToReport, container) {
    if (!container) {
        console.error('Report container not found!');
        return;
    }

    // --- Data Aggregation ---
    const reportData = {};
    let grandTotalMales = 0;
    let grandTotalFemales = 0;
    let grandOverallTotal = 0;

    studentsToReport.forEach(s => {
        const classId = s.classId || 'Unassigned';
        const division = s.division || 'Unassigned';
        const classKey = `${classId}$${division}`;

        if (!reportData[classKey]) {
            const classObj = classes.find(c => c.id === classId);
            reportData[classKey] = {
                className: classObj?.name || 'N/A',
                divisionName: division,
                males: 0,
                females: 0,
                total: 0
            };
        }

        if (s.gender === 'M') {
            reportData[classKey].males++;
            grandTotalMales++;
        } else if (s.gender === 'F') {
            reportData[classKey].females++;
            grandTotalFemales++;
        }
        reportData[classKey].total++;
        grandOverallTotal++;
    });

    // Sort report data keys by class name, then division for consistent presentation
    const sortedClassKeys = Object.keys(reportData).sort((a, b) => {
        const [classA, divA] = a.split('$');
        const [classB, divB] = b.split('$');
        const classNameA = classes.find(c => c.id === classA)?.name || '';
        const classNameB = classes.find(c => c.id === classB)?.name || '';

        if (classNameA === classNameB) {
            return divA.localeCompare(divB);
        }
        return classNameA.localeCompare(classNameB);
    });

    // --- Report HTML Generation ---
    let reportHtml = `
        <h5 class="fw-bold text-secondary mb-3">Class-wise Admission Breakdown</h5>
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Class (Division)</th>
                        <th class="text-center">Males</th>
                        <th class="text-center">Females</th>
                        <th class="text-center">Total</th>
                    </tr>
                </thead>
                <tbody>`;

    if (sortedClassKeys.length === 0) {
        reportHtml += `<tr><td colspan="4" class="text-center text-muted">No data available for this report.</td></tr>`;
    } else {
        sortedClassKeys.forEach(key => {
            const data = reportData[key];
            const [classId, division] = key.split('$'); // Extract classId and division for data attributes

            reportHtml += `
                <tr>
                    <td>${data.className} (${data.divisionName})</td>
                    <td class="text-center clickable-count" data-class-id="${classId}" data-division="${division}" data-gender="M" title="Click to view male students">${data.males}</td>
                    <td class="text-center clickable-count" data-class-id="${classId}" data-division="${division}" data-gender="F" title="Click to view female students">${data.females}</td>
                    <td class="text-center clickable-count" data-class-id="${classId}" data-division="${division}" data-gender="all" title="Click to view all students in this class">${data.total}</td>
                </tr>`;
        });
    }

    // --- Grand Totals Row ---
    reportHtml += `
                </tbody>
                <tfoot class="table-primary fw-bold">
                    <tr>
                        <td>Grand Total</td>
                        <td class="text-center clickable-count" data-class-id="" data-division="" data-gender="M" title="Click to view all male students">${grandTotalMales}</td>
                        <td class="text-center clickable-count" data-class-id="" data-division="" data-gender="F" title="Click to view all female students">${grandTotalFemales}</td>
                        <td class="text-center clickable-count" data-class-id="" data-division="" data-gender="all" title="Click to view all students">${grandOverallTotal}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <p class="text-muted small mt-3">Report based on currently filtered students.</p>
    `;

    container.innerHTML = reportHtml;

    // Attach event listener for the clickable counts
    container.querySelectorAll('.clickable-count').forEach(cell => {
        cell.addEventListener('click', (event) => {
            const clickedCell = event.currentTarget;
            const classId = clickedCell.dataset.classId;
            const division = clickedCell.dataset.division;
            const gender = clickedCell.dataset.gender;

            // Trigger the main student list filtering
            applyReportFiltersToMainList(classId, division, gender);
        });
    });
}


/**
 * Applies filters from the Admission Report to the main Student List UI.
 * @param {string} classId - The class ID to filter by (or empty string for all).
 * @param {string} division - The division to filter by (or empty string for all).
 * @param {string} gender - The gender to filter by ('M', 'F', or 'all').
 */
function applyReportFiltersToMainList(classId, division, gender) {
    console.log('reportfilter mainlist');
    console.log(classId,division,gender);
    const filterClassDropdown = document.getElementById('filter-class');
    const filterDivisionDropdown = document.getElementById('filter-division');
    const studentSearchInput = document.getElementById('student-search-input');
    const newAdmissionsBtn = document.getElementById('new-admissions-btn'); // Assuming you want to reset this

    if (!filterClassDropdown || !filterDivisionDropdown || !studentSearchInput || !newAdmissionsBtn) {
        console.error("applyReportFiltersToMainList: Required DOM elements not found. Skipping filter application.");
        return;
    }

    // Reset other filters
    studentSearchInput.value = '';
    // newAdmissionsBtn.classList.remove('btn-info'); // Deactivate "New Admissions" filter visually if active
    // You might want to toggle this programmatically if it's just a visual state.
    // For now, let filterAndRenderStudents handle the actual filtering based on button's class.

    // Set class filter
    filterClassDropdown.value = classId;

    // Trigger change event on class filter to update division dropdown options
    // This is important because the division dropdown's options depend on the selected class.
    const event = new Event('change');
    filterClassDropdown.dispatchEvent(event);

    // After a small delay (to allow division options to populate), set division and trigger render
    setTimeout(() => {
        filterDivisionDropdown.value = division;
        // Call filterAndRenderStudents with the new gender parameter
        // This will trigger the final re-render of the student list.
       // filterAndRenderStudents(gender);
    }, 50); // Small delay to ensure division dropdown is populated
}

/**
 * Populates the full student detail modal with comprehensive information and shows it.
 * @param {string} studentId - The ID of the student whose details to display.
 */


function populateAndShowFullStudentModal(studentId) {
   const student = students.find(s => s.id === studentId);
    if (!student) {
        showAlert('Student details not found.', 'danger');
        return;
    }

    // --- 1. Get references to all necessary modal elements ---
    const modalEl = document.getElementById('fullStudentDetailModal');
    const modalBody = document.getElementById('fullStudentDetailModalBody');
    const modalTitle = document.getElementById('fullStudentDetailModalLabel');
    const modalFooter = modalEl.querySelector('.modal-footer');

    const className = classes.find(c => c.id === student.classId)?.name || 'N/A';
    const dobFormatted = student.dob ? new Date(student.dob).toLocaleDateString('en-GB') : 'N/A';
    const admissionDateFormatted = student.admissionDate ? new Date(student.admissionDate).toLocaleDateString('en-GB') : 'N/A';
    const studentPhotoSrc = student.photoDriveId ? `https://drive.google.com/thumbnail?id=${student.photoDriveId}&sz=400` : 'https://placehold.co/150x200?text=No+Photo';

    let statusBadge = '';
    // --- NEW: More robust status check for display ---
    const studentStatus = student.status || 'Active'; // Default to 'Active' if status field doesn't exist
    if (studentStatus === 'TC Issued') {
        statusBadge = `<span class="badge bg-danger ms-2">TC Issued</span>`;
    } else if (studentStatus === 'Graduated') {
        statusBadge = `<span class="badge bg-secondary ms-2">Graduated</span>`;
    } else {
        statusBadge = `<span class="badge bg-success ms-2">Active</span>`;
    }

    // Build the HTML for the modal body
    modalBody.innerHTML = `
        <div id="student-details-printable">
            <h4 class="mb-3 text-center fw-bold text-primary">Student Profile</h4>
            <div class="row mb-4 align-items-center">
                <div class="col-md-3 text-center">
                    <img src="${studentPhotoSrc}"
                         alt="Student Photo" class="img-thumbnail rounded-3 shadow-sm mb-2" style="width: 150px; height: 200px; object-fit: cover; border: 2px solid #ddd;">
                    <p class="small text-muted mb-0">Admn No: ${student.admissionNumber || 'N/A'}</p>
                </div>
                <div class="col-md-9">
                    <h4 class="fw-bold text-primary">${student.name || 'N/A'}</h4>
                    <p class="text-muted mb-1"><strong>Class:</strong> ${className} - ${student.division || 'N/A'}</p>
                    <p class="text-muted mb-1"><strong>Gender:</strong> ${student.gender==="M"?"Male":"Female" || 'N/A'}</p>
                    <p class="text-muted mb-1"><strong>Date of Birth:</strong> ${dobFormatted}</p>
                    <p class="text-muted mb-1"><strong>Mobile:</strong> ${student.mobile1 || 'N/A'}</p>
                </div>
            </div>

            <h5 class="fw-bold text-info border-bottom pb-2 mb-3">Academic Details</h5>
            <div class="row mb-3 gx-3 gy-2">
                <div class="col-md-4"><strong>Admission Date:</strong> ${admissionDateFormatted}</div>
                <div class="col-md-4"><strong>Admission Sector:</strong> ${student.admissionSector || 'N/A'}</div>
                <div class="col-md-4"><strong>Instruction Medium:</strong> ${student.instructionMedium || 'N/A'}</div>
                <div class="col-md-4"><strong>APL/BPL:</strong> ${student.aplBpl || 'N/A'}</div>
                <div class="col-md-4"><strong>Bus Point:</strong> ${student.busPoint || 'N/A'}</div>
                <div class="col-md-4"><strong>Vehicle Stage:</strong> ${student.vehicleStage || 'N/A'}</div>
            </div>

            ${student.hasSibling ? `
            <h5 class="fw-bold text-info border-bottom pb-2 mb-3">Sibling Information</h5>
            <div class="row mb-3 gx-3 gy-2">
                <div class="col-md-6"><strong>Has Sibling:</strong> Yes</div>
                <div class="col-md-6"><strong>Sibling WhatsApp:</strong> ${student.siblingWhatsAppNumber || 'N/A'}</div>
                ${student.siblingDetailsDisplay ? `<div class="col-md-12"><strong>Sibling Details:</strong> ${student.siblingDetailsDisplay}</div>` : ''}
            </div>` : `<h5 class="fw-bold text-info border-bottom pb-2 mb-3">Sibling Information</h5><p class="text-muted">No sibling in this school recorded.</p>`}


            <h5 class="fw-bold text-info border-bottom pb-2 mb-3">Contact & Address</h5>
            <div class="row mb-3 gx-3 gy-2">
                <div class="col-md-6"><strong>Father's Name:</strong> ${student.fatherName || 'N/A'}</div>
                <div class="col-md-6"><strong>Mother's Name:</strong> ${student.motherName || 'N/A'}</div>
                <div class="col-md-4"><strong>Mobile 1:</strong> ${student.mobile1 || 'N/A'}</div>
                <div class="col-md-4"><strong>Mobile 2:</strong> ${student.mobile2 || 'N/A'}</div>
                <div class="col-md-4"><strong>WhatsApp (Student):</strong> ${student.whatsappNo || 'N/A'}</div>
            </div>
            <h6 class="mt-4 fw-bold text-secondary">Current Address:</h6>
            <div class="row gx-3 gy-2">
                <div class="col-md-6"><strong>House Name/No:</strong> ${student.houseName || 'N/A'}</div>
                <div class="col-md-6"><strong>Place:</strong> ${student.place || 'N/A'}</div>
                <div class="col-md-4"><strong>Post Office:</strong> ${student.postOffice || 'N/A'}</div>
                <div class="col-md-4"><strong>PIN Code:</strong> ${student.pin || 'N/A'}</div>
                <div class="col-md-4"><strong>Taluk:</strong> ${student.taluk || 'N/A'}</div>
                <div class="col-md-4"><strong>District:</strong> ${student.district || 'N/A'}</div>
                <div class="col-md-4"><strong>State:</strong> ${student.state || 'N/A'}</div>
            </div>
        </div>
    `;
// a. Clean up any previously added dynamic buttons
    modalFooter.querySelector('#issue-tc-btn')?.remove();
    modalFooter.querySelector('#view-tc-btn')?.remove();
    
    // b. Add button based on student status
    if (currentUserRole === 'admin') {
        if (studentStatus === 'Active') {
            // Show "Issue TC" button for active students
            const tcButtonHtml = `
                <button type="button" class="btn btn-warning me-auto" id="issue-tc-btn" onclick="window.checkStudentLiabilities('${student.id}')">
                    <i class="fas fa-stamp me-2"></i>Issue TC
                </button>`;
            modalFooter.insertAdjacentHTML('afterbegin', tcButtonHtml);
        } else if (studentStatus === 'TC Issued' || studentStatus === 'Graduated') {
            // Show "View Issued TC" button for inactive students
            const viewTcButtonHtml = `
                <button type="button" class="btn btn-info me-auto" id="view-tc-btn" onclick="window.showExistingTC('${student.id}')">
                    <i class="fas fa-print me-2"></i>View Issued TC
                </button>`;
            modalFooter.insertAdjacentHTML('afterbegin', viewTcButtonHtml);
        }
    }
    
    // c. Re-attach onclick events for standard buttons
    modalFooter.querySelector('#print-student-details-btn').onclick = () => {
         printContentOfDiv('student-details-printable', `Student Profile - ${student.name}`);
    };
    modalFooter.querySelector('#print-student-extract-btn').onclick = () => {
        showAdmissionExtractModal(student.id);
    };

    modalTitle.textContent = `Student Details: ${student.name}`;
    const studentDetailModal = bootstrap.Modal.getOrCreateInstance(modalEl);
    studentDetailModal.show();
}


        window.handleEditStudent = (id) => { studentToEdit = students.find(s => s.id === id); if(studentToEdit) navigateTo('add-student'); };


        /**
 * Gathers all outstanding dues for a student and displays them in a modal.
 * @param {string} studentId The ID of the student to check.
 */

 /**
 * Displays the previously issued Transfer Certificate for a student.
 * @param {string} studentId The ID of the student.
 */
window.showExistingTC = (studentId) => {
    const student = students.find(s => s.id === studentId);
    if (!student) {
        showAlert('Student data not found.', 'danger');
        return;
    }

    // 1. Generate the HTML for the Transfer Certificate
    const tcHtml = generateTCHTML(studentId);
    
    // 2. Get the TC modal elements
    const tcModalEl = document.getElementById('tcPrintModal');
    const tcModalBody = document.getElementById('tc-modal-body');
    const printTcBtn = document.getElementById('print-final-tc-btn');

    // 3. Populate and show the modal
    tcModalBody.innerHTML = tcHtml;
    printTcBtn.onclick = () => {
         printContentOfDiv('tc-modal-body', `TC_${student.name}`, { pageSize: 'A4 portrait' });
    };
    
    const tcModal = bootstrap.Modal.getOrCreateInstance(tcModalEl);
    tcModal.show();
};

window.checkStudentLiabilities = (studentId) => {
    const student = students.find(s => s.id === studentId);
    if (!student) return showAlert('Student not found!', 'danger');

    const liabilities = [];

    // --- 1. Check for Fee Dues ---
    const setup = studentFeeSetups.find(sfs => sfs.id === student.id);
    const payments = receipts.filter(r => r.studentId === student.id && !r.isCancelled);
    const totalPaid = payments.reduce((sum, p) => sum + p.totalAmount, 0);
    const balance = setup ? (setup.totalPayable - totalPaid) : 0;

    if (balance > 0) {
        liabilities.push(`<strong>Fee Balance:</strong> An amount of â‚¹${balance.toFixed(2)} is outstanding.`);
    }

    // --- 2. Check for Library Dues ---
    const unreturnedBooks = bookIssuances.filter(item => item.studentId === student.id && item.status === 'Issued');
    if (unreturnedBooks.length > 0) {
        unreturnedBooks.forEach(book => {
            liabilities.push(`<strong>Unreturned Book:</strong> "${book.bookTitle}" (Due: ${new Date(book.dueDate).toLocaleDateString('en-GB')})`);
        });
    }

    // --- 3. (Future) Add checks for other liabilities here ---
    // e.g., lab equipment, sports fees, etc.

    // --- 4. Display the results in the modal ---
    showLiabilitiesModal(student, liabilities);
};

/**
 * Populates and shows the liability check modal.
 * @param {object} student The student object.
 * @param {Array<string>} liabilities An array of liability description strings.
 */
function showLiabilitiesModal(student, liabilities) {
    const modalBody = document.getElementById('liability-check-modal-body');
    const modalFooter = document.getElementById('liability-check-modal-footer');
    
    if (liabilities.length > 0) {
        // If there are dues, show them in a list
        modalBody.innerHTML = `
            <div class="alert alert-danger">
                <h6 class="alert-heading">Dues Pending!</h6>
                <p>The Transfer Certificate cannot be issued until the following liabilities are cleared:</p>
                <hr>
                <ul class="mb-0">
                    ${liabilities.map(item => `<li>${item}</li>`).join('')}
                </ul>
            </div>
        `;
        modalFooter.innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>`;
    } else {
        // If everything is clear, show a success message and the "Proceed" button
        modalBody.innerHTML = `
            <div class="alert alert-success">
                <h6 class="alert-heading"><i class="fas fa-check-circle me-2"></i>All Clear!</h6>
                <p class="mb-0">No outstanding liabilities found for ${student.name}. You can proceed with issuing the Transfer Certificate.</p>
            </div>
        `;
        modalFooter.innerHTML = `
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-success" onclick="issueTransferCertificate('${student.id}')">
                Proceed to Issue TC
            </button>
        `;
    }
    
    const liabilityModal = new bootstrap.Modal(document.getElementById('liabilityCheckModal'));
    liabilityModal.show();
}

/**
 * Final step for TC issuance. Updates student status and generates the printable TC.
 * @param {string} studentId The ID of the student.
 */
window.issueTransferCertificate = async (studentId) => {
    try {
        const studentRef = getDocRef('students', studentId);
        // First, update the student's status in the database
        await updateDoc(studentRef, {
            status: 'TC Issued',
            lastDay: new Date().toISOString().slice(0, 10) // Record the date of TC issuance
        });
        
        showAlert('Student status updated to "TC Issued". Generating certificate...', 'success');
        
        // --- NEW LOGIC ---
        // 1. Generate the HTML for the Transfer Certificate
        const tcHtml = generateTCHTML(studentId);
        
        // 2. Get the new TC modal elements
        const tcModalEl = document.getElementById('tcPrintModal');
        const tcModalBody = document.getElementById('tc-modal-body');
        const printTcBtn = document.getElementById('print-final-tc-btn');

        // 3. Populate and show the modal
        tcModalBody.innerHTML = tcHtml;
        const student = students.find(s => s.id === studentId);
        printTcBtn.onclick = () => {
             printContentOfDiv('tc-modal-body', `TC_${student.name}`, { pageSize: 'A4 portrait' });
        };
        
        const tcModal = new bootstrap.Modal(tcModalEl);
        tcModal.show();
        
        // 4. Hide the previous modals
        bootstrap.Modal.getInstance(document.getElementById('liabilityCheckModal'))?.hide();
        bootstrap.Modal.getInstance(document.getElementById('fullStudentDetailModal'))?.hide();

    } catch (error) {
        console.error("Error issuing TC:", error);
        showAlert('Could not issue TC. An error occurred.', 'danger');
    }
}

/**
 * Generates the full HTML for a professional Transfer Certificate.
 * @param {string} studentId The ID of the student.
 * @returns {string} The complete HTML content for the TC.
 */
function generateTCHTML(studentId) {
    const student = students.find(s => s.id === studentId);
    if (!student) return `<div class="alert alert-danger">Student data not found.</div>`;

    const schoolName = schoolDetails.fullname || 'KATTILANGADI YATHEEMKHANA HIGHER SECONDARY SCHOOL';
    const schoolAddress = schoolDetails.name || 'ATHAVANAD, TIRUR';
    const schoolAffiliation = schoolDetails.affiliation || 'GOVT. AIDED';

    // Helper functions for date formatting
    const formatDate = (dateStr) => dateStr ? new Date(dateStr).toLocaleDateString('en-GB') : 'N/A';
    const dateToWords = (dateStr) => {
        if (!dateStr) return 'N/A';
        try {
            return new Date(dateStr).toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            }).replace(/,/g, '');
        } catch (e) { return 'N/A'; }
    };

    return `
    <div style="width: 210mm; min-height: 297mm; padding: 1.5cm; border: 1px solid #ccc; box-sizing: border-box; font-family: 'Times New Roman', serif;">
        <div class="text-center mb-4">
            ${schoolDetails.logoUrl ? `<img src="${schoolDetails.logoUrl}" alt="School Logo" style="max-height: 80px;">` : ''}
            <h3 style="margin-bottom: 0;">${schoolName}</h3>
            <p style="margin-bottom: 5px;">(${schoolAffiliation})</p>
            <h4 style="border: 2px solid black; display: inline-block; padding: 5px 15px; margin-top: 10px;">TRANSFER CERTIFICATE</h4>
        </div>

        <div class="row" style="font-size: 1.1em; line-height: 1.8;">
            <div class="col-6"><strong>Admission No:</strong> ${student.admissionNumber}</div>
            <div class="col-6 text-end"><strong>Book No:</strong> _______ <strong>TC No:</strong> _______</div>
        </div>

        <table class="table table-bordered mt-3" style="font-size: 1.1em; line-height: 1.6;">
            <tbody>
                <tr><td style="width: 5%;">1.</td><td style="width: 45%;">Name of Pupil</td><td>${student.name}</td></tr>
                <tr><td>2.</td><td>Religion & Community</td><td>${student.religion || 'ISLAM MAPPILA'}</td></tr>
                <tr><td>3.</td><td>Name of Father / Guardian</td><td>${student.fatherName || 'N/A'}</td></tr>
                <tr><td>4.</td><td>Nationality</td><td>${student.nationality || 'INDIAN'}</td></tr>
                <tr><td>5.</td><td>Date of Birth (in figures & words)</td><td>${formatDate(student.dob)}<br><em>${dateToWords(student.dob)}</em></td></tr>
                <tr><td>6.</td><td>Class to which pupil was admitted</td><td>${student.preClass || 'N/A'}</td></tr>
                <tr><td>7.</td><td>Date of Admission</td><td>${formatDate(student.admissionDate)}</td></tr>
                <tr><td>8.</td><td>Class in which pupil last studied</td><td>${classes.find(c=>c.id === student.classId)?.name || 'N/A'}</td></tr>
                <tr><td>9.</td><td>Date of leaving</td><td>${formatDate(student.lastDay)}</td></tr>
                <tr><td>10.</td><td>No. of school days up to date of leaving</td><td>___</td></tr>
                <tr><td>11.</td><td>No. of school days pupil attended</td><td>___</td></tr>
                <tr><td>12.</td><td>Whether qualified for promotion</td><td>___</td></tr>
                <tr><td>13.</td><td>Whether all fees have been paid</td><td>Yes</td></tr>
                <tr><td>14.</td><td>Character and Conduct</td><td>Good</td></tr>
            </tbody>
        </table>

        <div class="row" style="margin-top: 100px;">
            <div class="col-4">
                <p>Date: ${new Date().toLocaleDateString('en-GB')}</p>
                <div style="margin-top: 80px;">
                    <p style="border-top: 1px dashed #000; display: inline-block;">School Seal</p>
                </div>
            </div>
            <div class="col-8 text-end">
                <p>Prepared by: ______________ Checked by: ______________</p>
                <div style="margin-top: 80px;">
                    ${schoolDetails.hmSignPng ? `<img src="${schoolDetails.hmSignPng}" alt="HM Signature" style="max-height: 60px; margin-bottom: -15px;">` : ''}
                    <p style="border-top: 1px dashed #000; display: inline-block; padding: 0 50px;">
                        <strong>Headmaster / Principal</strong>
                    </p>
                </div>
            </div>
        </div>
    </div>
    `;
}
        // --- EXAM MANAGEMENT (ENHANCED) ---

// This replaces the existing window.renderExamManagement function
// --- EXAM MANAGEMENT (ENHANCED) ---

window.renderExamManagement = () => {
    const isAdmin = currentUserRole === 'admin';
    const isExamController = currentUserRole === 'teacher' || selectedUser.roles && selectedUser.roles.includes('exam_controller');

    if (!isAdmin && !isExamController) {
        mainContent.innerHTML = `<div class="alert alert-danger"><h4>Access Denied</h4><p>You do not have permission to access this module.</p></div>`;
        return;
    }

    mainContent.innerHTML = `<h1 class="h2 mb-4">Exam Management</h1>
    <ul class="nav nav-tabs" id="examTab" role="tablist">
        ${isAdmin ? `<li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#schedule" type="button">Schedule</button></li>` : '<li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#schedule" type="button">Schedule</button></li>'}
        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#timetable-view" type="button">Timetable</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#entry" type="button">Mark Entry</button></li>
        
        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#entry-report" type="button">Entry Report</button></li>

        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#results" type="button">Results</button></li>
    </ul>
    <div class="tab-content card" id="examTabContent">
        ${isAdmin ? `<div class="tab-pane fade p-4" id="add-exam" role="tabpanel"></div>` : ''}
        ${isAdmin ? `<div class="tab-pane fade p-4" id="schedule" role="tabpanel"></div>` : '<div class="tab-pane fade p-4" id="schedule" role="tabpanel"></div>'}
        <div class="tab-pane fade p-4" id="timetable-view" role="tabpanel"></div>
        <div class="tab-pane fade p-4" id="consolidated-view" role="tabpanel"></div>
    
        <div class="tab-pane fade p-4" id="entry" role="tabpanel"></div>
        
        <div class="tab-pane fade p-4" id="entry-report" role="tabpanel"></div>

        <div class="tab-pane fade p-4" id="results" role="tabpanel"></div>
    </div>`;

    if (isAdmin) {
        renderExamAddTab();
        
    }
    renderExamScheduleTab();
    renderExamTimetableView();
    renderConsolidatedTimetableView(); 
    renderMarkEntryTab();
    renderEntryReportTab(); // <-- Call the new function
    renderResultsTab();
    
    
    const firstVisibleTab = mainContent.querySelector('#examTab .nav-link');
    if(firstVisibleTab) {
        new bootstrap.Tab(firstVisibleTab).show();
    }
};
// Global variable to hold the complete, unfiltered report data
let reportData = [];
async function renderEntryReportTab() {
    await getData('marks');
    const container = document.getElementById('entry-report');
    if (!container) return;

    const isClassTeacher = currentUserRole === 'teacher' && selectedUser.classCharge;

    // --- NEW: Conditional Tab UI ---
    const tabNav = isClassTeacher ? `
        <ul class="nav nav-tabs">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overall-report-pane">Overall Report</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#my-class-pending-pane">My Class Pending</button></li>
        </ul>` : '';

    const tabContent = `
        <div class="tab-content">
            <div class="tab-pane fade show active" id="overall-report-pane">
                <div id="entry-report-container" class="mt-4">
                    <p class="text-muted text-center p-5">Please select an exam to view the detailed entry report.</p>
                </div>
            </div>
            ${isClassTeacher ? `
            <div class="tab-pane fade" id="my-class-pending-pane">
                <div id="my-class-pending-container" class="mt-4">
                    <p class="text-muted text-center p-5">Select an exam to see pending entries for your class.</p>
                </div>
            </div>` : ''}
        </div>`;

    container.innerHTML = `
        <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
            <div class="col-md-6">
                <label class="form-label fw-bold">Select Exam to Generate Report</label>
                <select id="entry-report-exam" class="form-select">
                    <option value="">-- Choose an Exam --</option>
                    ${exams.map(ex => `<option value="${ex.id}">${ex.name}</option>`).join('')}
                </select>
            </div>
        </div>
        ${tabNav}
        ${tabContent}
    `;

    document.getElementById('entry-report-exam').addEventListener('change', (e) => {
        const examId = e.target.value;
        if (examId) {
            generateEntryReport(examId); // Always generate the main report
            if (isClassTeacher) {
                renderMyClassPendingList(examId); // Also generate the teacher's pending list
            }
        } else {
            document.getElementById('entry-report-container').innerHTML = `<p class="text-muted text-center p-5">Please select an exam.</p>`;
            if (isClassTeacher) {
                document.getElementById('my-class-pending-container').innerHTML = `<p class="text-muted text-center p-5">Please select an exam.</p>`;
            }
        }
    });
}

/**
 * Generates the data for the main entry report and renders the controls and table.
 */
async function generateEntryReport(examId) {
    const container = document.getElementById('entry-report-container');
    container.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>`;

    let relevantSchedules = [];
    const isAdminOrController = currentUserRole === 'admin' || selectedUser.roles?.includes('exam_controller');

    if (isAdminOrController) {
        relevantSchedules = examSchedules.filter(s => s.examId === examId);
    } else if (currentUserRole === 'teacher') {
        const teacherAllocations = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id);
        relevantSchedules = examSchedules.filter(s =>
            s.examId === examId && teacherAllocations.some(ta =>
                ta.classId === s.classId && ta.division === s.division && ta.subjectId === s.subjectId
            )
        );
    }

    if (relevantSchedules.length === 0) {
        container.innerHTML = `<div class="alert alert-warning">No mark entries found for your allocated subjects in this exam.</div>`;
        return;
    }
    
    const rawReportData = [];
    relevantSchedules.forEach(schedule => {
        const studentsInClass = students.filter(s => s.classId === schedule.classId && s.division === schedule.division);
        if (studentsInClass.length === 0) return;
        const enteredCount = studentsInClass.filter(student => marks[`${examId}_${student.id}_${schedule.subjectId}`]).length;
        
        rawReportData.push({
            classId: schedule.classId,
            className: classes.find(c => c.id === schedule.classId)?.name || 'N/A',
            division: schedule.division,
            subjectId: schedule.subjectId,
            subjectName: subjects.find(sub => sub.id === schedule.subjectId)?.name || 'N/A',
            total: studentsInClass.length,
            entered: enteredCount,
            pending: studentsInClass.length - enteredCount
        });
    });

    reportData = rawReportData.sort((a,b) => (a.className + a.division + a.subjectName).localeCompare(b.className + b.division + b.subjectName));
    renderReportControlsAndTable(examId);
}

/**
 * Renders the filters and the table for the overall report view.
 */
function renderReportControlsAndTable(examId) {
    const container = document.getElementById('entry-report-container');
    if (reportData.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">No subjects scheduled for this exam.</div>';
        return;
    }
    
    const classOptions = [...new Set(reportData.map(d => d.classId))].map(id => `<option value="${id}">${classes.find(c => c.id === id)?.name || ''}</option>`).join('');
    const divisionOptions = [...new Set(reportData.map(d => d.division))].map(d => `<option value="${d}">${d}</option>`).join('');
    const subjectOptions = [...new Set(reportData.map(d => d.subjectId))].map(id => `<option value="${id}">${subjects.find(s => s.id === id)?.name || ''}</option>`).join('');

    container.innerHTML = `
        <div class="row g-3 align-items-end mb-3">
            <div class="col-md-3"><label class="form-label">Class</label><select id="report-filter-class" class="form-select"><option value="">All</option>${classOptions}</select></div>
            <div class="col-md-2"><label class="form-label">Division</label><select id="report-filter-division" class="form-select"><option value="">All</option>${divisionOptions}</select></div>
            <div class="col-md-3"><label class="form-label">Subject</label><select id="report-filter-subject" class="form-select"><option value="">All</option>${subjectOptions}</select></div>
            <div class="col-md-4 text-md-end">
                <button id="toggle-pending-btn" class="btn btn-outline-info btn-sm ${showPendingOnly ? 'active' : ''}"><i class="fas fa-exclamation-triangle me-1"></i> Show Pending Only</button>
                <button id="report-export-pdf-btn" class="btn btn-danger btn-sm"><i class="fas fa-file-pdf me-2"></i>Export as PDF</button>
            </div>
        </div>
        <div id="report-table-container"></div>`;

    document.getElementById('report-filter-class').addEventListener('change', filterAndRenderReport);
    document.getElementById('report-filter-division').addEventListener('change', filterAndRenderReport);
    document.getElementById('report-filter-subject').addEventListener('change', filterAndRenderReport);
    document.getElementById('report-export-pdf-btn').addEventListener('click', () => exportReportToPdf(examId));
    document.getElementById('toggle-pending-btn').addEventListener('click', (e) => {
        showPendingOnly = !showPendingOnly;
        e.currentTarget.classList.toggle('active', showPendingOnly);
        filterAndRenderReport();
    });

    filterAndRenderReport();
}

/**
 * Filters the global report data based on UI controls and renders the summary table.
 */
function filterAndRenderReport() {
    const classId = document.getElementById('report-filter-class').value;
    const division = document.getElementById('report-filter-division').value;
    const subjectId = document.getElementById('report-filter-subject').value;
    const examId = document.getElementById('entry-report-exam').value;

    let filteredData = [...reportData];
    if (classId) filteredData = filteredData.filter(d => d.classId === classId);
    if (division) filteredData = filteredData.filter(d => d.division === division);
    if (subjectId) filteredData = filteredData.filter(d => d.subjectId === subjectId);
    if (showPendingOnly) filteredData = filteredData.filter(row => row.pending > 0);
    
    renderSummaryTableHTML(filteredData, examId);
}

/**
 * Renders the HTML for the summary table.
 */
function renderSummaryTableHTML(displayData, examId) {
    const container = document.getElementById('report-table-container');
    if (!container) return;

    if (displayData.length === 0) {
        container.innerHTML = '<p class="text-muted text-center p-4">No matching entries found.</p>';
        return;
    }

    const tableHTML = `
        <h5 class="mb-3">Mark Entry Status for: <strong>${exams.find(e=>e.id===examId)?.name}</strong></h5>
        <div id="report-table-printable" class="table-responsive">
            <table class="table table-bordered table-hover table-sm">
                <thead class="table-light">
                    <tr><th>Class</th><th>Subject</th><th class="text-center">Total</th><th class="text-center text-success">Entered</th><th class="text-center text-danger">Pending</th><th class="text-center" style="width: 20%;">Status</th></tr>
                </thead>
                <tbody>
                    ${displayData.map(row => {
                        const percentage = row.total > 0 ? (row.entered / row.total) * 100 : 0;
                        const statusClass = percentage === 100 ? 'bg-success' : (percentage > 0 ? 'bg-warning' : 'bg-danger');
                        return `<tr><td>${row.className} - ${row.division}</td><td>${row.subjectName}</td><td class="text-center">${row.total}</td><td class="text-center">${row.entered}</td><td class="text-center">${row.pending}</td><td>
                            <div class="progress" style="height: 20px;"><div class="progress-bar ${statusClass}" role="progressbar" style="width: ${percentage}%;">${percentage.toFixed(0)}%</div></div>
                        </td></tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>`;
    container.innerHTML = tableHTML;
}

/**
 * Renders a summary table for the class teacher showing the mark entry status
 * for each subject in their class for the selected exam.
 */
function renderMyClassPendingList(examId) {
    const container = document.getElementById('my-class-pending-container');
    if (!container || !selectedUser.classCharge) return;

    const { classId, division } = selectedUser.classCharge;
    
    // Get active students in the teacher's class
    const studentsInClass = students.filter(s => 
        s.classId === classId && 
        s.division === division && 
        s.status !== 'TC Issued' && 
        s.status !== 'Graduated'
    );

    // Get all subjects allocated to this specific class and division
    const subjectsForClass = classroomSubjects.filter(cs => 
        cs.classId === classId && 
        cs.division === division
    );
    
    if (studentsInClass.length === 0 || subjectsForClass.length === 0) {
        container.innerHTML = '<div class="alert alert-info">There are no active students or subjects allocated to your class.</div>';
        return;
    }

    // --- NEW: Calculate the entry status for each subject ---
    const subjectStatusList = subjectsForClass.map(cs => {
        const subject = subjects.find(s => s.id === cs.subjectId);
        const totalStudents = studentsInClass.length;
        
        // Count how many students have marks entered for this specific subject
        const enteredCount = studentsInClass.filter(student => {
            const markId = `${examId}_${student.id}_${cs.subjectId}`;
            return !!marks[markId]; // Check if a mark entry exists
        }).length;
        
        const pendingCount = totalStudents - enteredCount;
        const percentage = totalStudents > 0 ? (enteredCount / totalStudents) * 100 : 0;
        const statusClass = percentage === 100 ? 'bg-success' : (percentage > 0 ? 'bg-warning' : 'bg-danger');

        return {
            subjectName: subject?.name || 'Unknown Subject',
            total: totalStudents,
            entered: enteredCount,
            pending: pendingCount,
            percentage,
            statusClass
        };
    }).sort((a, b) => a.subjectName.localeCompare(b.subjectName)); // Sort alphabetically by subject name

    // --- NEW: Render the summary table ---
    const tableHtml = `
        <div class="table-responsive">
            <table class="table table-bordered table-hover table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Subject</th>
                        <th class="text-center">Total Students</th>
                        <th class="text-center text-success">Entered</th>
                        <th class="text-center text-danger">Pending</th>
                        <th class="text-center" style="width: 25%;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${subjectStatusList.map(row => `
                        <tr>
                            <td>${row.subjectName}</td>
                            <td class="text-center">${row.total}</td>
                            <td class="text-center">${row.entered}</td>
                            <td class="text-center">${row.pending}</td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar ${row.statusClass}" role="progressbar" 
                                         style="width: ${row.percentage}%;" 
                                         aria-valuenow="${row.percentage}" aria-valuemin="0" aria-valuemax="100">
                                         ${row.percentage.toFixed(0)}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;

    container.innerHTML = tableHtml;
}

const exportReportToPdf = (examId) => {
    // 1. --- Basic Setup ---
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const tableElement = document.getElementById('report-table-printable').querySelector('table');

    if (!tableElement) {
        showAlert('Error: Report table not found for export.', 'danger');
        return;
    }

    const examName = exams.find(e => e.id === examId)?.name || 'Exam Summary';
    const reportTitle = `Mark Entry Report for: ${examName}`;

    // 2. --- Prepare Data for AutoTable ---
    const head = Array.from(tableElement.querySelectorAll('thead tr')).map(tr => 
        Array.from(tr.querySelectorAll('th')).map(th => th.innerText)
    );
    
    const body = Array.from(tableElement.querySelectorAll('tbody tr')).map(tr => 
        Array.from(tr.querySelectorAll('td')).map(td => td.innerText)
    );

    // 3. --- Generate the PDF using autoTable ---
    doc.autoTable({
        head: head,
        body: body,
        // REMOVED startY and ADDED margin. This is the key change.
        margin: { top: 30 }, // Reserve 30mm space at the top of EVERY page
        theme: 'striped',
        styles: {
            fontSize: 8,
            cellPadding: 2,
        },
        headStyles: {
            fillColor: [22, 160, 133],
            textColor: 255,
            fontStyle: 'bold',
        },
        // This hook adds a header and footer to EVERY page.
        didDrawPage: function (data) {
            // Header (drawn at 20mm, well within the 30mm margin)
            doc.setFontSize(16);
            doc.setTextColor(40);
            doc.text(reportTitle, data.settings.margin.left, 20);

            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            doc.setFontSize(10);
            doc.text(`Page ${data.pageNumber} of ${pageCount}`, data.settings.margin.left, doc.internal.pageSize.height - 10);
        }
    });

    // 4. --- Save the PDF ---
    doc.save(`Mark_Entry_Report_${examName.replace(/\s/g, '_')}.pdf`);
    showAlert('PDF export successful!', 'success');
};

// Reverted and enhanced version of renderExamScheduleTab
function renderExamScheduleTab() {
    const container = document.getElementById('schedule');
    if (!container) return;

    // Conditionally generate class options based on user role
    let classOptions = '';
    if (currentUserRole === 'teacher') {
        const teacherAllocations = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id);
        const uniqueClassIds = [...new Set(teacherAllocations.map(a => a.classId))];
        classOptions = uniqueClassIds.map(classId => {
            const c = classes.find(cls => cls.id === classId);
            return c ? `<option value="${c.id}">${c.name}</option>` : '';
        }).join('');
    } else { // For admin
        classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    container.innerHTML = `
        <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
            <div class="col-md-4"><label class="form-label fw-bold">Exam</label><select id="sched-exam" class="form-select">${exams.map(ex=>`<option value="${ex.id}">${ex.name}</option>`).join('')}</select></div>
            <div class="col-md-4"><label class="form-label fw-bold">Class</label><select id="sched-class" class="form-select">${classOptions}</select></div>
            <div class="col-md-4">
                <label class="form-label fw-bold">Divisions (select one or more)</label>
                <div id="sched-division-checkboxes" class="border rounded p-2" style="max-height: 120px; overflow-y: auto;"></div>
            </div>
        </div>
        <div id="schedule-sheet">
            <p class="text-center p-5 text-muted">Please select an exam, class, and at least one division to create the schedule.</p>
        </div>`;
    
    const examSelect = document.getElementById('sched-exam');
    const classSelect = document.getElementById('sched-class');
    const divisionContainer = document.getElementById('sched-division-checkboxes');

    const updateScheduleView = () => {
        const classId = classSelect.value;
        const selectedDivisions = Array.from(divisionContainer.querySelectorAll('input:checked')).map(cb => cb.value);
        const examId = examSelect.value;
        if (classId && selectedDivisions.length > 0 && examId) {
            loadScheduleSheet(examId, classId, selectedDivisions);
        } else {
            document.getElementById('schedule-sheet').innerHTML = `<p class="text-center p-5 text-muted">Please select an exam, class, and at least one division.</p>`;
        }
    };

    // This event listener now filters divisions based on teacher's allocation
    classSelect.addEventListener('change', () => {
        const selectedClassId = classSelect.value;
        divisionContainer.innerHTML = '';
        let divisionsToShow = [];

        if (currentUserRole === 'teacher') {
            const teacherAllocationsForClass = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id && cs.classId === selectedClassId);
            divisionsToShow = [...new Set(teacherAllocationsForClass.map(a => a.division))];
        } else { // For admin
            const cls = classes.find(c => c.id === selectedClassId);
            if (cls) divisionsToShow = cls.divisions;
        }
        
        divisionsToShow.forEach(d => {
            divisionContainer.innerHTML += `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${d}" id="div_${d}">
                    <label class="form-check-label" for="div_${d}">${d}</label>
                </div>`;
        });
        updateScheduleView();
    });

    divisionContainer.addEventListener('change', updateScheduleView);
    examSelect.addEventListener('change', updateScheduleView);
    
    // Initial population of divisions for the first class
    if (classSelect.options.length > 0) {
        classSelect.dispatchEvent(new Event('change'));
    } else if (currentUserRole === 'teacher') {
        // Display a message if the teacher has no classes assigned
        document.getElementById('schedule-sheet').innerHTML = `<p class="text-center p-5 text-muted">You have no classes allocated to schedule exams.</p>`;
    }
}

// Reverted and enhanced version of loadScheduleSheet
async function loadScheduleSheet(examId, classId, divisions) {
    const container = document.getElementById('schedule-sheet');
    container.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div></div>`;

    const selectedExam = exams.find(ex => ex.id === examId);

    // --- NEW: Role-based filtering logic ---
    const subjectIds = new Set();
    let relevantSubjects;

    // Check if the user is an admin or has the 'exam_controller' role
    const isAdminOrController = currentUserRole === 'admin' || (currentUserRole === 'teacher' && selectedUser.roles && selectedUser.roles.includes('exam_controller'));

    if (isAdminOrController) {
        // Admins/Controllers see all subjects for the selected class and division(s)
        relevantSubjects = classroomSubjects.filter(cs =>
            cs.classId === classId && divisions.includes(cs.division)
        );
    } else {
        // Teachers only see subjects they are personally allocated to
        relevantSubjects = classroomSubjects.filter(cs =>
            cs.classId === classId &&
            cs.teacherId === selectedUser.id &&
            divisions.includes(cs.division)
        );
    }

    relevantSubjects.forEach(cs => subjectIds.add(cs.subjectId));
    // --- End of new logic ---

    const allocatedSubjects = Array.from(subjectIds).map(id => subjects.find(s => s.id === id)).filter(Boolean);

    if (allocatedSubjects.length === 0) {
        container.innerHTML = `<div class="alert alert-warning">No subjects are allocated for this class/division combination that match your permissions.</div>`;
        return;
    }

    const existingSchedules = examSchedules.filter(s => s.examId === examId && s.classId === classId && s.division === divisions[0]);

    let tableHTML = `
        <p class="text-muted">Enter schedule details. This will apply to all selected divisions: <strong>${divisions.join(', ')}</strong>.</p>
        <div class="table-responsive">
            <table id="schedule-table" class="table table-bordered table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Subject</th>
                        <th>Exam Date</th>
                        <th>Session (FN/AN)</th>
                        <th>Max Marks (Theory)</th>
                        <th>Max Marks (Internal)</th>
                    </tr>
                </thead>
                <tbody>`;
    
    allocatedSubjects.forEach(subject => {
        if (selectedExam?.sector && subject?.sector && selectedExam.sector !== subject.sector) {
            return;
        }

        const schedule = existingSchedules.find(es => es.subjectId === subject.id);
        tableHTML += `<tr data-subject-id="${subject.id}">
            <td class="fw-bold">${subject.name}</td>
            <td><input type="date" name="date" value="${schedule?.date || ''}" class="form-control form-control-sm"></td>
            <td>
                <select name="session" class="form-select form-select-sm">
                    <option value="">--</option>
                    <option value="FN" ${schedule?.session === 'FN' ? 'selected' : ''}>FN</option>
                    <option value="AN" ${schedule?.session === 'AN' ? 'selected' : ''}>AN</option>
                </select>
            </td>
            <td><input type="number" name="maxTE" value="${schedule?.maxTE || ''}" placeholder="e.g., 80" class="form-control form-control-sm"></td>
            <td><input type="number" name="maxCE" value="${schedule?.maxCE || ''}" placeholder="e.g., 20" class="form-control form-control-sm"></td>
        </tr>`;
    });

    tableHTML += `</tbody></table></div><div class="text-end mt-3"><button id="save-schedule-btn" class="btn btn-success">Save for All Selected Divisions</button></div>`;
    container.innerHTML = tableHTML;
    document.getElementById('save-schedule-btn').addEventListener('click', () => saveExamSchedule(examId, classId, divisions));
}

// Reverted and enhanced version of saveExamSchedule
async function saveExamSchedule(examId, classId, divisions) {
    const saveButton = document.getElementById('save-schedule-btn');
    if (!saveButton) return;

    // Store original button state and disable it
    const originalButtonHtml = saveButton.innerHTML;
    saveButton.disabled = true;
    saveButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Saving...`;

    try{
    const batch = writeBatch(db);
    const scheduleRows = document.querySelectorAll('#schedule-table tbody tr');
    let hasDataToSave = false;

    scheduleRows.forEach(row => {
        const subjectId = row.dataset.subjectId;
        const date = row.querySelector('input[name="date"]').value;
        
        if (subjectId && date) {
            hasDataToSave = true;
            const subjectScheduleData = {
                examId,
                classId,
                subjectId,
                date: date,
                session: row.querySelector('select[name="session"]').value,
                maxTE: parseInt(row.querySelector('input[name="maxTE"]').value) || 0,
                maxCE: parseInt(row.querySelector('input[name="maxCE"]').value) || 0,
            };

            // Apply this schedule to all selected divisions
            divisions.forEach(division => {
                const scheduleId = `${examId}_${classId}_${division}_${subjectId}`;
                const scheduleRef = getDocRef('examSchedules', scheduleId);
                batch.set(scheduleRef, { ...subjectScheduleData, division: division, id: scheduleId });
            });
        }
    });

    if (hasDataToSave) {
            await batch.commit();
            showAlert(`Schedule saved successfully for divisions: ${divisions.join(', ')}!`, 'success');
        } else {
            showAlert('No schedule data entered to save.', 'warning');
        }
    } catch (error) {
        console.error("Error saving exam schedule:", error);
        showAlert("Failed to save schedule. Please check your connection and try again.", "danger");
    } finally {
        // This block ALWAYS runs, ensuring the UI is restored.
        saveButton.disabled = false;
        saveButton.innerHTML = originalButtonHtml;
    }
}

// Updated to work with the new (old) schedule structure
function renderExamTimetableView() {
    const container = document.getElementById('timetable-view');
    if (!container) return;

    container.innerHTML = `
        <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
            <div class="col-md-4"><label class="form-label fw-bold">Exam</label><select id="tt-view-exam" class="form-select">${exams.map(ex=>`<option value="${ex.id}">${ex.name}</option>`).join('')}</select></div>
            <div class="col-md-4"><label class="form-label fw-bold">Class</label><select id="tt-view-class" class="form-select">${classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
        </div>
        <div class="d-flex justify-content-end mt-3">
    <button class="btn btn-outline-primary" onclick="window.printExamTimetable()">
        <i class="fa fa-print me-1"></i> Print Timetable
    </button>
</div>

        <div id="timetable-display-container"></div>
    `;

    const examSelect = document.getElementById('tt-view-exam');
    const classSelect = document.getElementById('tt-view-class');

    const displayTimetableAll = () => {
        const examId = examSelect.value;
        const classId = classSelect.value;
        if (examId && classId) {
            const classData = classes.find(c => c.id === classId);
            const divisions = ['A'];// classData ? classData.divisions : [];
            const schedules = examSchedules.filter(s => s.examId === examId && s.classId === classId);
            const displayContainer = document.getElementById('timetable-display-container');
            
            let html = '';
            divisions.forEach(division => {
                const divSchedules = schedules.filter(s => s.division === division)
                    .sort((a, b) => new Date(a.date) - new Date(b.date) || a.session.localeCompare(b.session));
                
                html += `<h4 class="mt-4">Timetable for ${classData.name} - ${division}</h4>`;
                if (divSchedules.length === 0) {
                    html += `<p class="text-muted">No schedule published for this division.</p>`;
                    return;
                }

                html += `<table class="table table-striped table-bordered">
                    <thead class="table-light"><tr><th>Date</th><th>Session</th><th>Subject</th></tr></thead>
                    <tbody>`;
                divSchedules.forEach(s => {
                    const subject = subjects.find(sub => sub.id === s.subjectId);
                    html += `<tr>
                        <td>${new Date(s.date).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</td>
                        <td>${s.session || 'N/A'}</td>
                        <td class="fw-bold">${subject ? subject.name : 'Unknown'}</td>
                    </tr>`;
                });
                html += `</tbody></table>`;
            });
            displayContainer.innerHTML = html;
        }
    };
    

    const displayTimetable = () => {
    const examId = examSelect.value;
    if (!examId) return;

    const displayContainer = document.getElementById('timetable-display-container');
    let html = '';

    classes.forEach(classData => {
        const divisions = ['A'];// classData.divisions || [];
        const schedules = examSchedules.filter(s => s.examId === examId && s.classId === classData.id);

        divisions.forEach(division => {
            const divSchedules = schedules
                .filter(s => s.division === division)
                .sort((a, b) => new Date(a.date) - new Date(b.date) || a.session.localeCompare(b.session));

            html += `<h4 class="mt-4">Timetable for ${classData.name} - ${division}</h4>`;

            if (divSchedules.length === 0) {
                html += `<p class="text-muted">No schedule published for this division.</p>`;
                return;
            }

            html += `<table class="table table-striped table-bordered">
                <thead class="table-light">
                    <tr><th>Date</th><th>Session</th><th>Subject</th></tr>
                </thead>
                <tbody>`;

            divSchedules.forEach(s => {
                const subject = subjects.find(sub => sub.id === s.subjectId);
                html += `<tr>
                    <td>${new Date(s.date).toLocaleDateString('en-GB', {
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                    })}</td>
                    <td>${s.session || 'N/A'}</td>
                    <td class="fw-bold">${subject ? subject.name : 'Unknown'}</td>
                </tr>`;
            });

            html += `</tbody></table>`;
        });
    });

    displayContainer.innerHTML = html || '<p class="text-muted">No schedules found.</p>';
};

    examSelect.addEventListener('change', displayTimetable);
    classSelect.addEventListener('change', displayTimetable);
    if (exams.length > 0 && classes.length > 0) displayTimetable();
}

/**
 * Renders the filters (Exam, Division) for the Consolidated Timetable view.
 */

function renderConsolidatedTimetableView() {
    const container = document.getElementById('consolidated-view');
    if (!container) return;

    const allDivisions = [...new Set(classes.flatMap(c => c.divisions))].sort();

    container.innerHTML = `
        <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
            <div class="col-md-4">
                <label class="form-label fw-bold">Select Exam</label>
                <select id="consolidated-exam" class="form-select">${exams.map(ex => `<option value="${ex.id}">${ex.name}</option>`).join('')}</select>
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold">Select Division to View</label>
                <select id="consolidated-division" class="form-select">
                    ${allDivisions.map(d => `<option value="${d}">${d}</option>`).join('')}
                </select>
            </div>
            
            <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-secondary w-100" onclick="window.printConsolidatedTimetable()">
                    <i class="fas fa-print me-2"></i>Print Timetable
                </button>
            </div>
        </div>
        <div id="consolidated-timetable-container" class="mt-4 table-responsive">
            </div>
    `;

    const examSelect = document.getElementById('consolidated-exam');
    const divisionSelect = document.getElementById('consolidated-division');

    const displayTable = () => {
        displayConsolidatedTimetable(examSelect.value, divisionSelect.value);
    };

    examSelect.addEventListener('change', displayTable);
    divisionSelect.addEventListener('change', displayTable);

    if (exams.length > 0 && allDivisions.length > 0) {
        displayTable();
    }
}
/**
 * Gathers data and prints the consolidated exam timetable.
 */
window.printConsolidatedTimetable = () => {
    const container = document.getElementById('consolidated-timetable-container');
    const examSelect = document.getElementById('consolidated-exam');
    const divisionSelect = document.getElementById('consolidated-division');

    // Check if there is content to print
    if (!container || !container.querySelector('table')) {
        showAlert('Please generate a timetable before printing.', 'warning');
        return;
    }

    const examName = examSelect.options[examSelect.selectedIndex].text;
    const division = divisionSelect.value;
    const reportTitle = "Consolidated Examination Timetable";
    const subTitle = `Exam: ${examName} | Division: ${division}`;

    // Create a professional header for the printout
    const headerHtml = `
        <div style='text-align: center; margin-bottom: 20px;'>
            ${schoolDetails.logoUrl ? `<img src="${schoolDetails.logoUrl}" alt="School Logo" style="max-height: 70px;">` : ''}
            <h3>${schoolDetails.name || 'School Name'}</h3>
            <h4>${reportTitle}</h4>
            <p>${subTitle}</p>
        </div>
    `;

    // Use your existing print utility
    printContentOfDiv('consolidated-timetable-container', reportTitle, {
        customHeaderHtml: headerHtml,
        pageSize: 'A4 landscape', // Landscape is better for wide tables
        extraCss: `
            table { font-size: 0.8rem !important; }
            th, td { padding: 4px 6px !important; }
        `
    });
};

/**
 * Gathers data and renders the consolidated timetable grid.
 * @param {string} examId The selected exam.
 * @param {string} division The selected division to display for all classes.
 */
function displayConsolidatedTimetable(examId, division) {
    const container = document.getElementById('consolidated-timetable-container');
    if (!examId || !division) {
        container.innerHTML = '<p class="text-muted p-5 text-center">Please select an exam and a division.</p>';
        return;
    }

    // 1. Filter schedules for the selected exam and division
    const relevantSchedules = examSchedules.filter(s => s.examId === examId && s.division === division);
    
    // 2. Get a sorted list of unique dates from these schedules
    const uniqueDates = [...new Set(relevantSchedules.map(s => s.date))].sort();

    // 3. Get all classes that actually have the selected division
    const classesWithDivision = classes.filter(c => c.divisions.includes(division));

    if (uniqueDates.length === 0 || classesWithDivision.length === 0) {
        container.innerHTML = `<p class="alert alert-info">No exams scheduled for Division '${division}' in this exam.</p>`;
        return;
    }

    // 4. Transform the data into an easy-to-use map for rendering: { classId: { date: { FN: "Subject", AN: "Subject" } } }
    const timetableMap = {};
    relevantSchedules.forEach(s => {
        if (!timetableMap[s.classId]) timetableMap[s.classId] = {};
        if (!timetableMap[s.classId][s.date]) timetableMap[s.classId][s.date] = {};
        const subjectName = subjects.find(sub => sub.id === s.subjectId)?.name || 'N/A';
        timetableMap[s.classId][s.date][s.session] = subjectName;
    });

    // 5. Build the HTML table
    let tableHTML = `<table class="table table-bordered table-sm text-center" style="font-size: 0.8rem;">
                        <thead class="table-light align-middle">
                            <tr>
                                <th rowspan="2">Class</th>`;
    
    // Header Row 1: Dates with Colspan
    uniqueDates.forEach(date => {
        tableHTML += `<th colspan="2">${new Date(date).toLocaleDateString('en-GB', {weekday: 'short', day: '2-digit', month: 'short'})}</th>`;
    });
    tableHTML += `</tr><tr>`;

    // Header Row 2: FN/AN for each date
    uniqueDates.forEach(() => {
        tableHTML += `<th>FN</th><th>AN</th>`;
    });
    tableHTML += `</tr></thead><tbody>`;

    // Body Rows: One row for each class
    classesWithDivision.forEach(classData => {
        tableHTML += `<tr><td class="fw-bold">${classData.name}</td>`;
        uniqueDates.forEach(date => {
            const fnSubject = timetableMap[classData.id]?.[date]?.FN || '-';
            const anSubject = timetableMap[classData.id]?.[date]?.AN || '-';
            tableHTML += `<td>${fnSubject}</td><td>${anSubject}</td>`;
        });
        tableHTML += `</tr>`;
    });

    tableHTML += `</tbody></table>`;
    container.innerHTML = tableHTML;
}

// --- RESULTS TAB OVERHAUL ---

async function renderResultsTab() {
  //await syncMarksDataForUser();
  await syncDataForUser();
    const container = document.getElementById('results');
    container.innerHTML = `
        <div class="d-flex justify-content-end align-items-center p-3 bg-light border rounded mb-3">
            <label class="form-label me-2 mb-0 fw-bold">Active Grading System:</label>
            <select id="shared-grading-system" class="form-select form-select-sm w-auto">
                <option value="type1">A+, A, B+, B...</option>
                <option value="type2">O, A, B, C...</option>
            </select>
        </div>

        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-ranklist" type="button">Class Rank List</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-reportcard" type="button">Student Report Card</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-exam-wise" type="button">Exam-wise Report</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-subject-wise" type="button">Subject-wise Analysis</button></li>
        </ul>
        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade" id="pills-ranklist" role="tabpanel"></div>
            <div class="tab-pane fade" id="pills-reportcard" role="tabpanel"></div>
            <div class="tab-pane fade show active" id="pills-exam-wise" role="tabpanel"></div>
            <div class="tab-pane fade" id="pills-subject-wise" role="tabpanel"></div>
        </div>`;
        
    renderExamWiseResultView();
    renderSubjectWiseResultView();
    renderRankListTab();
    renderReportCardTab();
}

// ----------------------------------------------------------------------------------
        // --- EXAM-WISE & SUBJECT-WISE RESULTS (ENHANCED) ---
        // ----------------------------------------------------------------------------------

        /**
         * Renders the UI for the "Exam-wise Report" tab, with dropdowns filtered for teachers.
         */
        function renderExamWiseResultView() {
            const container = document.getElementById('pills-exam-wise');
            let classOptions = '';

            // Filter classes for teachers, show all for admins
            if (currentUserRole === 'teacher') {
                const teacherAllocations = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id);
                const uniqueClassIds = [...new Set(teacherAllocations.map(a => a.classId))];
                classOptions = uniqueClassIds.map(classId => {
                    const c = classes.find(cls => cls.id === classId);
                    return c ? `<option value="${c.id}">${c.name}</option>` : '';
                }).join('');
            } else {
                classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }

            container.innerHTML = `
        <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
            <div class="col-md-3"><label class="form-label">Exam</label><select id="res-exam" class="form-select">${exams.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}</select></div>
            <div class="col-md-3"><label class="form-label">Class</label><select id="res-class" class="form-select">${classOptions}</select></div>
            <div class="col-md-3"><label class="form-label">Division</label><select id="res-division" class="form-select"></select></div>
            <div class="col-md-3">
                <label class="form-label">Sort By</label>
                <select id="ew-sort-by" class="form-select">
                    <option value="rank">Rank (Highest First)</option>
                    <option value="name">Alphabetical</option>
                </select>
            </div>
        </div>

        <div class="text-end my-3">
            <button id="print-exam-report-btn" class="btn btn-secondary" disabled>
                <i class="fas fa-print me-2"></i>Print Report
            </button>
        </div>

        <div id="printable-exam-report">
            
            <div id="exam-wise-results-container" class="table-responsive"></div>
            <div id="exam-wise-chart-container" class="mb-4" style="height: 300px;">
                 <canvas id="exam-wise-performance-canvas"></canvas>
            </div>
        </div>
        `;

    const examSelect = document.getElementById('res-exam');
    const classSelect = document.getElementById('res-class');
    const divisionSelect = document.getElementById('res-division');
    const sortBySelect = document.getElementById('ew-sort-by');
    const printBtn = document.getElementById('print-exam-report-btn');
    const resultsContainer = document.getElementById('exam-wise-results-container'); // Get reference to the results container

    const generateTable = () => {
        const examId = examSelect.value;
        const classId = classSelect.value;
        const division = divisionSelect.value;
        if (examId && classId && division) {

            // Create a unique key for this specific listener
    const listenerKey = `${classId}_${division}`;

    // --- NEW: If a listener for this specific query is already active, do nothing ---
    if (activeMarksListeners[listenerKey]) {
        // The data is already being synced in real-time. We just need to re-render the table.
        generateExamWiseResultsTable(examId, classId, division);
         printBtn.disabled = false; 
        return;
    }
            attachMarksListener(examId,classId, division);
            //generateExamWiseResultsTable(examId, classId, division);
            printBtn.disabled = false; // Enable print button after report generates
        } else {
            printBtn.disabled = false;
        }
    };
    
    // Attach event listeners
    [examSelect, classSelect, divisionSelect, sortBySelect].forEach(el => el.addEventListener('change', generateTable));
    
    printBtn.addEventListener('click', () => {
        const examName = examSelect.options[examSelect.selectedIndex].text;
        const className = classSelect.options[classSelect.selectedIndex].text;
        const divisionName = divisionSelect.value;
        const reportTitle = `${examName} - Results`;
        const reportSubtitle = `Class: ${className} - ${divisionName} (${activeFinancialYear})`;
        
        printReportWithChart('printable-exam-report', 'exam-wise-performance-canvas', reportTitle, reportSubtitle);
    });


            // This listener now correctly filters divisions based on the teacher's allocations
            classSelect.addEventListener('change', () => {
                const selectedClassId = classSelect.value;
                let divisionOptionsHTML = '';
                if (currentUserRole === 'teacher') {
                    const teacherAllocationsForClass = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id && cs.classId === selectedClassId);
                    const uniqueDivisions = [...new Set(teacherAllocationsForClass.map(a => a.division))];
                    divisionOptionsHTML = uniqueDivisions.map(d => `<option value="${d}">${d}</option>`).join('');
                } else {
                    const cls = classes.find(c => c.id === selectedClassId);
                    divisionOptionsHTML = cls ? cls.divisions.map(d => `<option value="${d}">${d}</option>`).join('') : '';
                }
                divisionSelect.innerHTML = divisionOptionsHTML;
                generateTable();
            });

            examSelect.addEventListener('change', generateTable);
            divisionSelect.addEventListener('change', generateTable);
            
            if (classSelect.options.length > 0) {
                classSelect.dispatchEvent(new Event('change'));
            } else {
                 container.querySelector('#exam-wise-results-container').innerHTML = `<p class="text-muted p-5 text-center">No classes allocated to this teacher.</p>`;
            }
            // --- NEW: Event listener for clicks on student names in the results table ---
    if (resultsContainer) {
        resultsContainer.addEventListener('click', (event) => {
            const studentLink = event.target.closest('.student-name-link'); // Find the closest link element
            if (studentLink) {
                event.preventDefault(); // Prevent default anchor link behavior
                const studentId = studentLink.dataset.id; // Get student ID from data-id attribute
                if (studentId) {
                   //  generateReportCardHTML(studentId, examSelect.value , 'rc-results-container');
                    document.getElementById('rc-results-container').innerHTML = generateReportCardHTML_Comparison(studentId, examSelect.value, 'rc-results-container')
           
                    // populateAndShowFullStudentModal(studentId); // Call your existing modal function
                }
            }
        });
    }
}
/**
 * Generates a printable report containing both a Chart.js canvas and HTML table content.
 * It converts the canvas to an image to ensure high-quality printing.
 *
 * @param {string} contentDivId - The ID of the div containing the HTML table/data to print.
 * @param {string} canvasId - The ID of the <canvas> element to include in the report.
 * @param {string} reportTitle - The main title for the printed report.
 * @param {string} reportSubtitle - The subtitle (e.g., class and exam details).
 */
function printReportWithChart(contentDivId, canvasId, reportTitle, reportSubtitle) {
    // --- 1. Get Elements ---
    const contentEl = document.getElementById(contentDivId);
    const canvasEl = document.getElementById(canvasId);

    if (!contentEl) {
        showAlert('Report content element could not be found.', 'danger');
        return;
    }
    if (!canvasEl) {
        showAlert('Report chart element could not be found.', 'danger');
        return;
    }

    // --- 2. Convert Canvas to High-Resolution Image Data URL ---
    // This ensures the chart prints clearly and not as a blurry image.
    let chartImageDataUrl = '';
    try {
        chartImageDataUrl = canvasEl.toDataURL('image/png', 4.0); // 1.0 quality for PNG
    } catch (e) {
        console.error("Error converting canvas to image:", e);
        showAlert("Could not process chart image for printing. It might be blank.", "warning");
    }

    // --- 3. Get Report Table HTML ---
    // We clone the part of the UI that contains the table to print.
    const tableHtmlContent = document.getElementById(contentDivId).innerHTML;

    // --- 4. Assemble Final Print HTML ---
    // --- 4. Assemble Final Print HTML ---
const printHtml = `
    <html>
        <head>
            <title>${reportTitle}</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { 
                    font-family: 'Inter', sans-serif; 
                    margin: 10px; 
                }
                @page { 
                    size: A4 landscape; 
                    margin: 0.5cm; 
                }
                @media print {
                    body { 
                        -webkit-print-color-adjust: exact !important; 
                        print-color-adjust: exact !important; 
                    }
                    /* Avoid breaking elements across pages */
                    .printable-chart, .table { 
                        page-break-inside: avoid; 
                    }
                    /* NEW: Add space after the header in print view */
                }
                .chart-container {
                   /* margin-top: 0.5rem;  Add space above the chart */
                    margin-bottom: 0.5rem;
                }
                .chart-image {
                    max-width: 100%;
                    height: auto;
                    border: 1px solid #eee;
                    padding: 5px;
                }
                table {
                    width: 100%;
                    font-size: 0.8rem;
                }
                    /* --- MODIFIED: Reduced padding for more space --- */
                    th, td {
                        padding: 2px !important; /* Reduced padding (e.g., 4px). Adjust as needed. */
                        vertical-align: middle;
                    }

            </style>
        </head>
        <body>
            <div class="report-header" style="text-align: center;">
                <h4>${schoolDetails.name || 'School Report'}</h4>
                <h5>${reportTitle}</h5>
                <p class="text-muted" style="margin-bottom: 0;">${reportSubtitle}</p>
            </div>

            <hr style="border-top: 1px solid #ccc;">

            <div class="table-container">
                ${tableHtmlContent}
            </div>
            
            ${chartImageDataUrl ? `
            <div class="chart-container">
                <img src="${chartImageDataUrl}" class="chart-image">
            </div>` : ''}
        </body>
    </html>
`;

    // --- 5. Open Print Dialog ---
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printHtml);
    printWindow.document.close();
    setTimeout(() => {
        printWindow.focus();
        printWindow.print();
       // printWindow.close();
    }, 500); // Wait for images and styles to load before printing
}

        /**
 * Main controller function for the Exam-wise Report.
 * It fetches filter values and orchestrates data processing and rendering.
 * @param {string} examId
 * @param {string} classId
 * @param {string} division
 */

async function generateExamWiseResultsTable(examId, classId, division) {
    const container = document.getElementById('exam-wise-results-container');
    if (!container) return; // Guard clause

    const schedulesForClass = examSchedules.filter(s => s.examId === examId && s.classId === classId && s.division === division);
    if (schedulesForClass.length === 0) {
        container.innerHTML = '<p class="text-muted p-5 text-center">Exam schedule not found for this selection.</p>';
        document.getElementById('exam-wise-chart-container').innerHTML = '<canvas id="exam-wise-performance-canvas"></canvas>';
        return;
    }

    // 1. Get configuration and filter data
    const gradingSystem = document.getElementById('shared-grading-system').value;
    const sortBy = document.getElementById('ew-sort-by').value;
    const studentsInClass = students.filter(s => s.classId === classId && s.division === division);
    const subjectHeaders = schedulesForClass.map(s => subjects.find(sub => sub.id === s.subjectId)).filter(Boolean);

    // 2. Process the raw data to get calculated results
    let resultsData = processExamResultsData(studentsInClass, schedulesForClass, marks, examId, gradingSystem);

    // 3. Sort the processed data
    resultsData.sort((a, b) => {
        if (sortBy === 'name') return a.studentName.localeCompare(b.studentName);
        if (a.finalStatus === 'PASS' && b.finalStatus === 'FAIL') return -1;
        if (a.finalStatus === 'FAIL' && b.finalStatus === 'PASS') return 1;
        return b.grandTotalMarks - a.grandTotalMarks;
    });

    // 4. Render the final table and chart
    container.innerHTML = renderExamResultsTable(resultsData, subjectHeaders,schedulesForClass);
    renderExamWisePerformanceChart(resultsData, gradingSystem, subjectHeaders);
}

/**
 * Processes raw data to calculate marks, totals, and grades for each student.
 * This version now includes the studentId in the results for reliable lookups.
 * @param {Array} studentsInClass
 * @param {Array} schedules
 * @param {object} marksObject
 * @param {string} examId
 * @param {string} gradingSystem
 * @returns {Array} A new array with calculated results for each student.
 */

/**
 * Processes raw data to calculate marks, totals, and individual grades for each student.
 * @param {Array} studentsInClass
 * @param {Array} schedules
 * @param {object} marksObject
 * @param {string} examId
 * @param {string} gradingSystem
 * @returns {Array} A new array with calculated results for each student.
 */
function processExamResultsData(studentsInClass, schedulesForClass, marksObject, examId, gradingSystem) {
    const subjectHeaders = schedulesForClass.map(s => subjects.find(sub => sub.id === s.subjectId)).filter(Boolean);

    return studentsInClass.map(student => {
        let grandTotalMarks = 0;
        let grandMaxMarks = 0;
        let finalStatus = 'PASS';
        let subjectResults = [];

        subjectHeaders.forEach(subject => {
            const schedule = schedulesForClass.find(s => s.subjectId === subject.id);
            const maxTE = schedule?.maxTE || 0;
            const maxCE = schedule?.maxCE || 0;
            const maxTotal = maxTE + maxCE;
            const markId = `${examId}_${student.id}_${subject.id}`;
            const mark = marksObject[markId];

            const te = mark?.te ?? 'N/A';
            const ce = mark?.ce ?? 'N/A';
            let total = 'N/A', pct = 'N/A', grade = 'N/A', teGrade = 'N/A', ceGrade = 'N/A';

            if (te !== 'AB' && te !== 'N/A' && ce !== 'AB' && ce !== 'N/A') {
                total = (Number(te) || 0) + (Number(ce) || 0);
                pct = maxTotal > 0 ? ((total / maxTotal) * 100).toFixed(1) : 0;
                
                // Calculate all three grades
                const gradeFunc = gradingSystem === 'type1' ? calculateGrade : calculateGradeType2;
                grade = gradeFunc(total, maxTotal);
                teGrade = gradeFunc(te, maxTE);
                ceGrade = gradeFunc(ce, maxCE);

                if (grade === 'E' || grade === 'F') finalStatus = 'FAIL';
                grandTotalMarks += total;
                grandMaxMarks += maxTotal;
            } else {
                finalStatus = 'FAIL';
                if (maxTotal > 0) grandMaxMarks += maxTotal;
            }

            subjectResults.push({ subjectId: subject.id, te, ce,maxTE,maxCE ,total, pct, grade, teGrade, ceGrade });
        });

        const grandPct = grandMaxMarks > 0 ? ((grandTotalMarks / grandMaxMarks) * 100) : 0;
        const gradeFunc = gradingSystem === 'type1' ? calculateGrade : calculateGradeType2;

        return {
            studentId: student.id,
            studentName: student.name,
            subjectResults,
            grandTotalMarks,
            grandMaxMarks,
            grandPct,
            finalStatus,
            overallGrade: gradeFunc(grandTotalMarks, grandMaxMarks)
        };
    });
}

/**
 * Renders the HTML table from the processed results data with cleaner headers.
 * @param {Array} resultsData - The processed data with calculated results.
 * @param {Array} subjectHeaders - The subject objects for table headers.
 * @returns {string} The complete HTML string for the results table.
 */
/**
 * Renders the HTML table from the processed results data with a simplified, compact layout.
 * @param {Array} resultsData - The processed data with calculated results.
 * @param {Array} subjectHeaders - The subject objects for table headers.
 * @param {Array} schedulesForClass - The schedule objects for the class.
 * @returns {string} The complete HTML string for the results table.
 */
function renderExamResultsTable(resultsData, subjectHeaders, schedulesForClass) {
    // --- Build Header ---
    let headerHTML = `<thead><tr><th rowspan="2" class="align-middle">Student</th>`;

    // Header Row 1: Subject Name + Max Marks
    subjectHeaders.forEach(subject => {
        const schedule = schedulesForClass.find(s => s.subjectId === subject.id);
        const maxTE = schedule?.maxTE || 0;
        const maxCE = schedule?.maxCE || 0;
        // --- MODIFIED: Colspan is now 3 ---
        headerHTML += `<th colspan="3" class="text-center">
                           ${subject.name}
                           <br>
                           <small class="text-muted fw-normal">(Max TE: ${maxTE}, Max CE: ${maxCE})</small>
                       </th>`;
    });
    headerHTML += `<th colspan="3" rowspan="2" class="text-center table-primary align-middle">Grand Total</th></tr>`;

    // --- MODIFIED: Header Row 2 now has fewer columns ---
    headerHTML += `<tr>`;
    subjectHeaders.forEach(() => {
        headerHTML += `<th>Marks (TE/CE)</th><th>Total / Grade</th><th>%</th>`;
    });
    headerHTML += `</tr></thead>`;

    // --- Build Body ---
    let bodyHTML = `<tbody>`;
    let rank = 1;
    resultsData.forEach(res => {
        const studentId = res.studentId;
        const currentRank = res.finalStatus === 'PASS' ? rank++ : '-';
        const rowClass = res.finalStatus === 'FAIL' ? 'table-danger' : '';
        
        bodyHTML += `<tr class="${rowClass}">
                        <td class="text-nowrap">
                            <a href="#" class="student-name-link fw-bold" data-id="${studentId}">${res.studentName}</a>
                        </td>`;

        // --- MODIFIED: Data Rows now have a compact structure ---
        res.subjectResults.forEach(subRes => {
            const gradeColor = (subRes.grade === 'E' || subRes.grade === 'F') ? 'text-danger fw-bold' : '';
            
            bodyHTML += `
                <td class="text-center">
                    ${subRes.te} / ${subRes.ce}
                    <br>
                    <small class="text-muted">(${subRes.teGrade} / ${subRes.ceGrade})</small>
                </td>
                <td class="text-center ${gradeColor}">
                    ${subRes.total}
                    <br>
                    <small>(${subRes.grade})</small>
                </td>
                <td class="text-center">${subRes.pct}%</td>
            `;
        });

        bodyHTML += `
            <td class="table-primary">${res.grandTotalMarks}/${res.grandMaxMarks}</td>
            <td class="table-primary">${res.grandPct.toFixed(2)}%</td>
            <td class="table-primary fw-bold">${res.finalStatus} (${currentRank})</td>
        </tr>`;
    });
    bodyHTML += `</tbody>`;

    return `<table class="table table-bordered table-hover table-sm">${headerHTML}${bodyHTML}</table>`;
}


/**
 * Renders a multi-dataset bar chart showing the grade distribution for each subject in an exam.
 * This version uses a reliable subjectId lookup to ensure data accuracy.
 * @param {Array} resultsData
 * @param {string} gradingSystem
 * @param {Array} subjects - An array of subject objects to be displayed in the chart.
 */
function renderExamWisePerformanceChart(resultsData, gradingSystem, subjects) {
    const canvas = document.getElementById('exam-wise-performance-canvas');
    if (!canvas) return;

    try {
        const existingChart = Chart.getChart(canvas);
        if (existingChart) existingChart.destroy();
    } catch (e) {}

    const colorPalette = [
        'rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(75, 192, 192, 0.7)',
        'rgba(255, 206, 86, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'
    ];
    const gradeScale = gradingSystem === 'type1' 
        ? ['A+', 'A', 'B+', 'B', 'C+', 'C', 'D', 'E', 'AB'] 
        : ['O', 'A', 'B', 'C', 'D', 'E', 'F', 'AB'];

    // Create a new dataset for each subject
    const datasets = subjects.map((subject, index) => {
        const gradeCounts = gradeScale.reduce((acc, grade) => ({ ...acc, [grade]: 0 }), {});

        // Go through each student's results
        resultsData.forEach(studentResult => {
            // --- MODIFIED: Find the result for the current subject BY ID, not by index ---
            const subjectResult = studentResult.subjectResults.find(sr => sr.subjectId === subject.id);
            
            if (subjectResult && gradeCounts[subjectResult.grade] !== undefined) {
                gradeCounts[subjectResult.grade]++;
            }
        });

        return {
            label: subject.name,
            data: Object.values(gradeCounts),
            backgroundColor: colorPalette[index % colorPalette.length],
        };
    });

    new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: {
            labels: gradeScale,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { stacked: false },
                y: { stacked: false, beginAtZero: true, ticks: { stepSize: 1 }, title: { display: true, text: 'Number of Students' } }
            },
            plugins: {
                title: { display: true, text: 'Grade Distribution by Subject' },
                tooltip: { mode: 'index', intersect: false }
            }
        }
    });
}
// =========================================================================
// --- ðŸ“ˆ EXAM RESULTS: SUBJECT-WISE ANALYSIS TAB ---
// =========================================================================

/**
 * Renders the UI for the "Subject-wise Analysis" tab with all filters and display options.
 */
function renderSubjectWiseResultView() {
    const container = document.getElementById('pills-subject-wise');
    let classOptions = '';

    if (currentUserRole === 'teacher') {
        const teacherAllocations = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id);
        const uniqueClassIds = [...new Set(teacherAllocations.map(a => a.classId))];
        classOptions = uniqueClassIds.map(classId => {
            const c = classes.find(cls => cls.id === classId);
            return c ? `<option value="${c.id}">${c.name}</option>` : '';
        }).join('');
    } else {
        classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    container.innerHTML = `
        <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
            <div class="col-md-3"><label class="form-label">Class</label><select id="sw-class" class="form-select">${classOptions}</select></div>
            <div class="col-md-2"><label class="form-label">Division</label><select id="sw-division" class="form-select"></select></div>
            <div class="col-md-3"><label class="form-label">Subject</label><select id="sw-subject" class="form-select"></select></div>
            <div class="col-md-4"><label class="form-label">Exams (select multiple)</label><select id="sw-exams" class="form-select" multiple style="height: 100px;">${exams.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}</select></div>
        </div>
        <div class="row g-3 align-items-center mb-3 p-3 bg-light rounded no-print">
            <div class="col-md-3"><label class="form-label">Grading System</label><select id="sw-grading-system" class="form-select form-select-sm"><option value="type1">A+, A, B+, B...</option><option value="type2">O, A, B, C...</option></select></div>
            <div class="col-md-3"><label class="form-label">Sort By</label><select id="sw-sort-by" class="form-select form-select-sm"><option value="name">Alphabetical (Name)</option><option value="admnno">Admission No.</option><option value="marks">Total Marks (Highest First)</option><option value="gender">Gender</option></select></div>
            <div class="col-md-3"><label class="form-label">Color Code Scores</label><select id="sw-color-code" class="form-select form-select-sm"><option value="none">None</option><option value="fail_only">Fail Only (Red)</option><option value="full">Full Spectrum</option></select></div>
            <div class="col-md-3"><label class="form-label">Display Mode</label><select id="sw-mark-type" class="form-select form-select-sm"><option value="total">Total</option><option value="te">TE Only</option><option value="ce">CE Only</option><option value="both">TE + CE</option></select></div>
        </div>
        <div class="text-end my-3 no-print">
            <button id="print-subject-report-btn" class="btn btn-secondary me-2"><i class="fas fa-print me-2"></i>Print Report</button>
        </div>
        <div id="subject-wise-results-container" class="table-responsive"></div>
        <div id="subject-wise-chart-container" class="mb-4" style="height: 300px;">
            <canvas id="subject-performance-canvas"></canvas>
        </div>
    `;

    const classSelect = document.getElementById('sw-class');
    const divisionSelect = document.getElementById('sw-division');
    const subjectSelect = document.getElementById('sw-subject');
    const examsSelect = document.getElementById('sw-exams');
    const printButton = document.getElementById('print-subject-report-btn');
    const resultsContainerElement = document.getElementById('subject-wise-results-container');

    const attachListeners = () => {
        [classSelect, divisionSelect, subjectSelect, examsSelect,
         document.getElementById('sw-grading-system'),
         document.getElementById('sw-sort-by'),
         document.getElementById('sw-color-code'),
         document.getElementById('sw-mark-type')
        ].forEach(el => {
            if (el) el.addEventListener('change', generateSubjectWiseTable);
        });
    };

    classSelect.addEventListener('change', () => {
        const selectedClassId = classSelect.value;
        let divisionOptionsHTML = '';
        if (currentUserRole === 'teacher') {
            const teacherAllocationsForClass = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id && cs.classId === selectedClassId);
            divisionOptionsHTML = [...new Set(teacherAllocationsForClass.map(a => a.division))].map(d => `<option value="${d}">${d}</option>`).join('');
        } else {
            const cls = classes.find(c => c.id === selectedClassId);
            divisionOptionsHTML = cls ? cls.divisions.map(d => `<option value="${d}">${d}</option>`).join('') : '';
        }
        divisionSelect.innerHTML = divisionOptionsHTML;
        divisionSelect.dispatchEvent(new Event('change'));
    });

    divisionSelect.addEventListener('change', () => {
        const classId = classSelect.value;
        const division = divisionSelect.value;
        const allocated = classroomSubjects.filter(cs => cs.classId === classId && cs.division === division);
        subjectSelect.innerHTML = allocated.map(a => {
            const subject = subjects.find(s => s.id === a.subjectId);
            return subject ? `<option value="${subject.id}">${subject.name}</option>` : '';
        }).join('');
        generateSubjectWiseTable();
    });

    resultsContainerElement.addEventListener('click', (event) => {
        const header = event.target.closest('.copy-column-header');
        if (header?.dataset.columnType) {
            copySubjectWiseColumnData(header.dataset.columnType);
        }
    });

    printButton.addEventListener('click', () => {
        const subjectName = subjectSelect.options[subjectSelect.selectedIndex]?.text || 'Subject';
        const className = classSelect.options[classSelect.selectedIndex]?.text || 'Class';
        const divisionName = divisionSelect.value || 'Division';
        const examNames = Array.from(examsSelect.selectedOptions).map(opt => opt.text).join(', ') || 'Exams';
        const reportTitle = `Subject-wise Analysis: ${subjectName}`;
        const subTitle = `Class: ${className} - ${divisionName} | Exams: ${examNames}`;
        const customHeader = `...`; // Your header HTML
        printContentOfDiv('pills-subject-wise', reportTitle, { /* print options */ });
    });

    attachListeners();
    if (classSelect.options.length > 0) {
        classSelect.dispatchEvent(new Event('change'));
    } else {
        container.innerHTML += `<p class="text-muted p-5 text-center">No classes or subjects allocated to this teacher.</p>`;
    }
}

/**
 * Main controller function that gathers filter values and orchestrates data processing and rendering.
 */
function generateSubjectWiseTable() {
    const container = document.getElementById('subject-wise-results-container');
    const chartContainer = document.getElementById('subject-wise-chart-container');
    if (!container || !chartContainer) return;

    const classId = document.getElementById('sw-class').value;
    const division = document.getElementById('sw-division').value;
    const subjectId = document.getElementById('sw-subject').value;
    const selectedExamIds = Array.from(document.getElementById('sw-exams').selectedOptions).map(opt => opt.value);
    const sortBy = document.getElementById('sw-sort-by').value;
    const displayMode = document.getElementById('sw-mark-type').value;
    const colorCodeSystem = document.getElementById('sw-color-code').value;
    const gradingSystem = document.getElementById('sw-grading-system').value;

    if (!classId || !division || !subjectId || selectedExamIds.length === 0) {
        container.innerHTML = '<p class="text-muted p-5 text-center">Please select a class, division, subject, and at least one exam.</p>';
        chartContainer.innerHTML = '<canvas id="subject-performance-canvas"></canvas>';
        return;
    }

    const studentsInClass = students.filter(s => s.classId === classId && s.division === division);
    const selectedExams = selectedExamIds.map(id => exams.find(e => e.id === id)).filter(Boolean);
    const results = processSubjectWiseResults(studentsInClass, selectedExams, subjectId, gradingSystem);

    if (sortBy === 'name') results.sort((a, b) => a.student.name.localeCompare(b.student.name));
    else if (sortBy === 'admnno') results.sort((a, b) => (a.student.admissionNumber || '').localeCompare(b.student.admissionNumber || '', undefined, { numeric: true }));
    else if (sortBy === 'gender') results.sort((a, b) => (a.student.gender || "").localeCompare(b.student.gender || ""));
    else results.sort((a, b) => b.totalSum - a.totalSum);
    
    results.forEach((res, i) => res.rank = i + 1);

    container.innerHTML = renderSubjectWiseTableHTML(results, selectedExams, displayMode, subjectId, colorCodeSystem);
    renderSubjectPerformanceChart(results, selectedExams, gradingSystem, subjectId);
}

/**
 * Generates the HTML for the subject-wise results table.
 */
function renderSubjectWiseTableHTML(results, selectedExams, displayMode, subjectId, colorSystem) {
    let headerRow1 = `<thead><tr><th rowspan="2" class="align-middle">Rank</th><th rowspan="2" class="align-middle copy-column-header" data-column-type="student-name">Name <i class="fas fa-copy copy-icon"></i></th><th rowspan="2" class="align-middle copy-column-header" data-column-type="admission-no">Admn No. <i class="fas fa-copy copy-icon"></i></th>`;
    selectedExams.forEach(exam => {
        const colspan = displayMode === 'both' ? 6 : 3;
        headerRow1 += `<th colspan="${colspan}" class="text-center">${exam.name}</th>`;
    });
    headerRow1 += `<th rowspan="2" class="align-middle copy-column-header" data-column-type="total-sum">Total <i class="fas fa-copy copy-icon"></i></th><th rowspan="2" class="align-middle copy-column-header" data-column-type="avg-percent">Overall % <i class="fas fa-copy copy-icon"></i></th></tr>`;

    let headerRow2 = `<tr>`;
    selectedExams.forEach(exam => {
        const schedule = examSchedules.find(s => s.examId === exam.id && s.subjectId === subjectId);
        const maxTE = schedule?.maxTE || 0, maxCE = schedule?.maxCE || 0, maxTotal = maxTE + maxCE;
        if (displayMode === 'te') headerRow2 += `<th class="copy-column-header" data-column-type="exam-${exam.id}-te">TE/${maxTE} <i class="fas fa-copy copy-icon"></i></th>`;
        else if (displayMode === 'ce') headerRow2 += `<th class="copy-column-header" data-column-type="exam-${exam.id}-ce">CE/${maxCE} <i class="fas fa-copy copy-icon"></i></th>`;
        else if (displayMode === 'total') headerRow2 += `<th class="copy-column-header" data-column-type="exam-${exam.id}-total">Total/${maxTotal} <i class="fas fa-copy copy-icon"></i></th>`;
        else if (displayMode === 'both') {
            headerRow2 += `<th class="copy-column-header" data-column-type="exam-${exam.id}-te">TE/${maxTE}</th><th class="copy-column-header" data-column-type="exam-${exam.id}-te-grade">Grd</th><th class="copy-column-header" data-column-type="exam-${exam.id}-ce">CE/${maxCE}</th><th class="copy-column-header" data-column-type="exam-${exam.id}-ce-grade">Grd</th><th class="copy-column-header" data-column-type="exam-${exam.id}-total">Total/${maxTotal}</th><th class="copy-column-header" data-column-type="exam-${exam.id}-total-grade">Grd</th>`;
        }
        headerRow2 += `<th class="copy-column-header" data-column-type="exam-${exam.id}-percent">%</th><th class="copy-column-header" data-column-type="exam-${exam.id}-grade">Grd</th>`;
    });
    headerRow2 += `</tr></thead>`;

    let bodyHTML = `<tbody>`;
    results.forEach(res => {
        bodyHTML += `<tr><td>${res.rank}</td><td class="text-nowrap">${res.student.name}</td><td>${res.student.admissionNumber || 'N/A'}</td>`;
        selectedExams.forEach(exam => {
            const data = res.markData[exam.id];
            if (data) {
                const schedule = examSchedules.find(s => s.examId === exam.id && s.subjectId === subjectId);
                const maxTE = schedule?.maxTE || 0, maxCE = schedule?.maxCE || 0, maxTotal = maxTE + maxCE;
                const teClass = getColorClass(data.te, maxTE, colorSystem), ceClass = getColorClass(data.ce, maxCE, colorSystem), totalClass = getColorClass(data.total, maxTotal, colorSystem), percentClass = getColorClass(data.percent, 100, colorSystem);
                const gradeClass = (data.grade === 'E' || data.grade === 'F' || data.grade === 'AB') ? 'text-danger fw-bold' : '';
                const teCeGradeClass = (data.teGrade === 'E' || data.teGrade === 'F' || data.ceGrade === 'E' || data.ceGrade === 'F') ? 'text-danger fw-bold' : '';
                if (displayMode === 'te') bodyHTML += `<td class="text-center ${teClass}">${data.te}</td>`;
                else if (displayMode === 'ce') bodyHTML += `<td class="text-center ${ceClass}">${data.ce}</td>`;
                else if (displayMode === 'total') bodyHTML += `<td class="text-center ${totalClass}">${data.total}</td>`;
                else if (displayMode === 'both') {
                    bodyHTML += `<td class="text-center ${teClass}">${data.te}</td><td class="text-center ${teCeGradeClass}">${data.teGrade}</td><td class="text-center ${ceClass}">${data.ce}</td><td class="text-center ${teCeGradeClass}">${data.ceGrade}</td><td class="text-center ${totalClass}">${data.total}</td><td class="text-center ${gradeClass}">${data.totalGrade}</td>`;
                }
                bodyHTML += `<td class="text-center ${percentClass}">${data.percent === 'AB' ? 'AB' : data.percent.toFixed(1)}%</td><td class="text-center ${gradeClass}">${data.grade}</td>`;
            } else {
                const colspan = displayMode === 'both' ? 8 : 3;
                bodyHTML += `<td colspan="${colspan}" class="text-muted text-center">N/A</td>`;
            }
        });
        bodyHTML += `<td class="fw-bold">${res.totalSum}</td><td class="fw-bold">${res.avgPercent.toFixed(1)}%</td></tr>`;
    });
    bodyHTML += `</tbody>`;
    return `<table id="subject-wise-data-table" class="table table-bordered table-sm">${headerRow1}${headerRow2}${bodyHTML}</table>`;
}

/**
 * Processes raw data from marks and schedules into a structured format for the subject-wise table.
 * (Corrected version with specific schedule lookup)
 */
function processSubjectWiseResults(studentsInClass, selectedExams, subjectId, gradingSystem) {
    return studentsInClass.map(student => {
        const markData = {};
        let totalSum = 0;
        let totalMax = 0;

        selectedExams.forEach(exam => {
            // --- FIX: The schedule lookup is now more specific, matching the student's class & division ---
            const schedule = examSchedules.find(s => 
                s.examId === exam.id && 
                s.subjectId === subjectId && 
                s.classId === student.classId && 
                s.division === student.division
            );

            const markId = `${exam.id}_${student.id}_${subjectId}`;
            const mark = marks[markId];

            if (schedule && mark) {
                const te = mark.te === 'AB' ? 'AB' : Number(mark.te || 0);
                const ce = mark.ce === 'AB' ? 'AB' : Number(mark.ce || 0);
                const total = (te === 'AB' || ce === 'AB') ? 'AB' : te + ce;
                const maxTE = schedule.maxTE || 0;
                const maxCE = schedule.maxCE || 0;
                const maxTotal = maxTE + maxCE;
                const percent = (total === 'AB' || maxTotal === 0) ? 'AB' : (total / maxTotal) * 100;
                const gradeFunc = gradingSystem === 'type1' ? calculateGrade : calculateGradeType2;
                
                markData[exam.id] = {
                    te, ce, total, percent, maxTE, maxCE, maxTotal,
                    grade: gradeFunc(total, maxTotal),
                    teGrade: gradeFunc(te, maxTE),
                    ceGrade: gradeFunc(ce, maxCE),
                    totalGrade: gradeFunc(total, maxTotal)
                };

                if (total !== 'AB') {
                    totalSum += total;
                    totalMax += maxTotal;
                }
            } else {
                markData[exam.id] = null; // Mark as null if no schedule or mark is found
            }
        });

        const avgPercent = totalMax > 0 ? (totalSum / totalMax) * 100 : 0;
        return { student, markData, totalSum, avgPercent };
    });
}

/**
 * Renders a bar chart comparing student grade distribution across multiple exams for a single subject.
 */
function renderSubjectPerformanceChart(resultsData, exams, gradingSystem, subjectId) {
    const canvas = document.getElementById('subject-performance-canvas');
    if (!canvas) return;
    try {
        const existingChart = Chart.getChart(canvas);
        if (existingChart) existingChart.destroy();
    } catch (e) {}

    const gradeScale = gradingSystem === 'type1' ? ['A+', 'A', 'B+', 'B', 'C+', 'C', 'D', 'E', 'AB'] : ['O', 'A', 'B', 'C', 'D', 'E', 'F', 'AB'];
    const datasets = exams.map((exam, index) => {
        const gradeCounts = Object.fromEntries(gradeScale.map(g => [g, 0]));
        resultsData.forEach(res => {
            const markInfo = res.markData[exam.id];
            if (markInfo && gradeCounts[markInfo.grade] !== undefined) {
                gradeCounts[markInfo.grade]++;
            }
        });
        return {
            label: exam.name,
            data: Object.values(gradeCounts),
            backgroundColor: ['rgba(54, 162, 235, 0.6)', 'rgba(255, 99, 132, 0.6)', 'rgba(75, 192, 192, 0.6)', 'rgba(255, 206, 86, 0.6)'][index % 4]
        };
    });

    new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: { labels: gradeScale, datasets: datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 }, title: { display: true, text: 'Number of Students' } } },
            plugins: { title: { display: true, text: 'Grade Distribution Analysis' } }
        }
    });
}

/**
 * Copies data from a specific column in the subject-wise results table to the clipboard.
 */
function copySubjectWiseColumnData(columnType) {
    const table = document.getElementById('subject-wise-data-table');
    if (!table) return showAlert('Report table not found.', 'danger');

    const rows = Array.from(table.querySelectorAll('tbody tr'));
    let dataToCopy = [];
    const fixedInitialColsCount = 3;

    rows.forEach(row => {
        let cellValue = '';
        if (columnType === 'student-name') cellValue = row.cells[1]?.textContent.trim() || '';
        else if (columnType === 'admission-no') cellValue = row.cells[2]?.textContent.trim() || '';
        else if (columnType === 'total-sum') cellValue = row.cells[row.cells.length - 2]?.textContent.trim() || '';
        else if (columnType === 'avg-percent') cellValue = row.cells[row.cells.length - 1]?.textContent.replace('%', '').trim() || '';
        else {
            const headerRow2Cells = Array.from(table.querySelectorAll('thead tr')[1].cells);
            const headerCellIndex = headerRow2Cells.findIndex(th => th.dataset.columnType === columnType);
            if (headerCellIndex !== -1) {
                const actualColumnIndexInBody = headerCellIndex + fixedInitialColsCount;
                cellValue = row.cells[actualColumnIndexInBody]?.textContent.trim() || '';
                if (columnType.includes('-percent')) cellValue = cellValue.replace('%', '');
            } else { return; }
        }
        dataToCopy.push(cellValue);
    });

    navigator.clipboard.writeText(dataToCopy.join('\n')).then(() => {
        showAlert('Column data copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy text:', err);
        showAlert('Failed to copy column data.', 'danger');
    });
}
        
        /**
         * New helper function to calculate an alternate grading scale.
         */
        function calculateGradeType2(score, maxScore) {
            if (score === 'AB') return 'Ab';
            if (maxScore === 0) return '-';
            const percentage = (score / maxScore) * 100;
            if (percentage >= 90) return 'O'; // Outstanding
            if (percentage >= 80) return 'A';
            if (percentage >= 70) return 'B';
            if (percentage >= 60) return 'C';
            if (percentage >= 50) return 'D';
            if (percentage >= 35) return 'E';
            return 'F'; // Fail
        }
        
        /**
         * New helper function to apply CSS classes for color coding.
         */
        function getColorClass(score, maxScore, colorSystem) {
            if (colorSystem === 'none' || score === 'AB' || maxScore === 0) return '';
            const percentage = (score / maxScore) * 100;
            if (percentage < 35) return 'text-danger fw-bold';
            if (colorSystem === 'full') {
                 if (percentage >= 90) return 'text-success fw-bold';
                 if (percentage >= 80) return 'text-primary';
            }
            return '';
        }

       // Enhanced Subject-Wise Result View with Separate TE, CE, Total, Grade, Rank, Graph, and Filters

/**
 * Generates and displays the detailed subject-wise results table and performance chart.
 * This version features a cleaner, two-row header for exam marks.
 */

 /**
 * Renders the "Add Exam" tab, now including an 'isActive' field on creation.
 */
function renderExamAddTab() {
    const container = document.getElementById('add-exam');
    container.innerHTML = `<div class="row"><div class="col-lg-5"><div class="card"><div class="card-header fw-bold">Add Exam Title</div><div class="card-body"><form id="add-exam-form" class="d-flex gap-2"><input id="exam-sector" class="form-control" placeholder="SECTOR , SCHOOL/MADRASSA" required><input id="exam-name" class="form-control" placeholder="E.G., QUARTERLY EXAM" required><button type="submit" class="btn btn-primary">Add</button></form></div></div></div><div class="col-lg-7"><div class="card"><div class="card-header fw-bold">Existing Exams</div><div class="card-body" id="exams-list"></div></div></div></div>`;
    
    document.getElementById('add-exam-form').addEventListener('submit', async e => { 
        e.preventDefault(); 
        const examName = document.getElementById('exam-name').value;
        const sector = document.getElementById('exam-sector').value;
        const examId = `2025-26${examName.replace(/\s+/g, '_').toUpperCase()}`; // Create a more robust ID

        if(examName && sector) {
            // Add the 'isActive' field, defaulting to true for new exams
            await setDoc(getDocRef('exams', examId), {
                id: examId,
                name: examName,
                sector: sector,
                isActive: true // New exams are active by default
            });
            e.target.reset(); 
            showAlert('Exam Added', 'success');
        }
    });
    
    renderExamsList();
}

/**
 * Renders the list of existing exams, now with an "Is Active" toggle switch.
 */
function renderExamsList() {
    const list = document.getElementById('exams-list');
    if (!list) return;

    // Sort exams to show active ones first
    const sortedExams = [...exams].sort((a, b) => (b.isActive || false) - (a.isActive || false));

    list.innerHTML = sortedExams.length > 0 ? 
        `<ul class="list-group list-group-flush">${sortedExams.map(e => `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>${e.name} <span class="badge bg-secondary">${e.sector}</span></span>
                <div class="d-flex align-items-center">
                    <div class="form-check form-switch me-3">
                        <input class="form-check-input" type="checkbox" role="switch" 
                               id="exam-toggle-${e.id}" ${e.isActive ? 'checked' : ''} 
                               onchange="window.toggleExamStatus('${e.id}', this.checked)">
                        <label class="form-check-label" for="exam-toggle-${e.id}">${e.isActive ? 'Active' : 'Inactive'}</label>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="window.handleDelete('exams', '${e.id}')">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </li>`).join('')}
        </ul>` : 
        `<p class="text-muted">No exams created.</p>`;
}

/**
 * NEW: Updates the 'isActive' status of an exam in Firestore.
 * @param {string} examId The ID of the exam to update.
 * @param {boolean} newStatus The new status (true for active, false for inactive).
 */
window.toggleExamStatus = async function(examId, newStatus) {
    try {
        const examRef = getDocRef('exams', examId);
        await updateDoc(examRef, { isActive: newStatus });
        showAlert(`Exam status updated to ${newStatus ? 'Active' : 'Inactive'}.`, 'success');
        // The real-time listener will automatically call renderExamsList() to refresh the UI.
    } catch (error) {
        console.error("Error updating exam status:", error);
        showAlert('Failed to update exam status.', 'danger');
    }
};
        
        

    function renderMarkEntryTab() {
    const container = document.getElementById('entry');
    let classOptions = '';

    // If the user is a teacher, populate classes based on their specific allocations.
    if (currentUserRole === 'teacher') {
        const teacherAllocations = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id);
        const uniqueClassIds = [...new Set(teacherAllocations.map(a => a.classId))];
        classOptions = uniqueClassIds.map(classId => {
            const c = classes.find(cls => cls.id === classId);
            return c ? `<option value="${c.id}">${c.name}</option>` : '';
        }).join('');
    } else {
        classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    container.innerHTML = `
        <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
            <div class="col-md-3"><label class="form-label">Exam</label><select id="mark-entry-exam" class="form-select">${exams.map(ex => `<option value="${ex.id}">${ex.name}</option>`).join('')}</select></div>
            <div class="col-md-3"><label class="form-label">Class</label><select id="mark-entry-class" class="form-select"><option value="">-- Select Class --</option>${classOptions}</select></div>
            <div class="col-md-3"><label class="form-label">Division</label><select id="mark-entry-division" class="form-select" disabled><option value="">-- Select Division --</option></select></div>
            <div class="col-md-3"><label class="form-label">Subject</label><select id="mark-entry-subject" class="form-select" disabled><option value="">-- Select Subject --</option></select></div>
        </div>
        <div id="mark-entry-sheet"></div>
        <div id="mark-entry-summary-container"></div>
    `;

    const examSelect = document.getElementById('mark-entry-exam');
    const classSelect = document.getElementById('mark-entry-class');
    const divisionSelect = document.getElementById('mark-entry-division');
    const subjectSelect = document.getElementById('mark-entry-subject');

    // --- NEW: Centralized controller for the view ---
    const updateMarkEntryView = () => {
        const examId = examSelect.value;
        const classId = classSelect.value;
        const division = divisionSelect.value;
        const subjectId = subjectSelect.value;

        // Clear both containers to prevent old content from lingering
        document.getElementById('mark-entry-sheet').innerHTML = '';
        document.getElementById('mark-entry-summary-container').innerHTML = '';
        
        // Decide what to render based on the current selections
        if (examId && classId && division && subjectId) {
            // All options selected: Load the mark entry sheet
            loadMarkEntrySheet(examId, classId, division, subjectId);
        } else if (examId && !classId) {
            // Only exam selected: Show the summary table
            renderMarkEntrySummaryTable(examId);
        } else {
             // Not enough options selected, show a placeholder
             document.getElementById('mark-entry-summary-container').innerHTML = '<p class="text-muted p-5 text-center">Select Exam, Class, and Division to see subjects, or just an Exam for a summary.</p>';
        }
    };

    // --- REFACTORED: This function now only populates subjects, then updates the view ---
    const populateSubjects = () => {
        const examId = examSelect.value;
        const classId = classSelect.value;
        const division = divisionSelect.value;
        
        subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
        subjectSelect.disabled = true;

        if (examId && classId && division) {
            let scheduledSubjects = examSchedules.filter(s => s.examId === examId && s.classId === classId && s.division === division);

            if (currentUserRole === 'teacher') {
                const teacherSubjectIds = classroomSubjects
                    .filter(cs => cs.teacherId === selectedUser.id && cs.classId === classId && cs.division === division)
                    .map(cs => cs.subjectId);
                scheduledSubjects = scheduledSubjects.filter(s => teacherSubjectIds.includes(s.subjectId));
            }
            
            if (scheduledSubjects.length > 0) {
                subjectSelect.innerHTML += scheduledSubjects.map(schedule => {
                    const subjectDetails = subjects.find(sub => sub.id === schedule.subjectId);
                    return subjectDetails ? `<option value="${subjectDetails.id}">${subjectDetails.name}</option>` : '';
                }).join('');
                subjectSelect.disabled = false;
            }
        }
        updateMarkEntryView(); // Call the controller to refresh the UI
    };
    
    // --- REFACTORED: A new function to handle both division and subject population ---
    const populateDivisionsAndSubjects = () => {
        const selectedClassId = classSelect.value;
        divisionSelect.innerHTML = '<option value="">-- Select Division --</option>';
        divisionSelect.disabled = true;

        if (selectedClassId) {
            let divisionOptionsHTML = '';
            if (currentUserRole === 'teacher') {
                const teacherAllocationsForClass = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id && cs.classId === selectedClassId);
                const uniqueDivisions = [...new Set(teacherAllocationsForClass.map(a => a.division))];
                divisionOptionsHTML = uniqueDivisions.map(d => `<option value="${d}">${d}</option>`).join('');
            } else {
                const cls = classes.find(c => c.id === selectedClassId);
                divisionOptionsHTML = cls ? cls.divisions.map(d => `<option value="${d}">${d}</option>`).join('') : '';
            }
            if(divisionOptionsHTML) {
                divisionSelect.innerHTML += divisionOptionsHTML;
                divisionSelect.disabled = false;
            }
        }
        populateSubjects(); // This will trigger the subject population and the view update
    };

    // --- REFACTORED: Event Listeners now call the new functions ---
    examSelect.addEventListener('change', populateSubjects);
    classSelect.addEventListener('change', populateDivisionsAndSubjects);
    divisionSelect.addEventListener('change', populateSubjects);
    subjectSelect.addEventListener('change', updateMarkEntryView);

    // Initial population and view setup on page load
    if (examSelect.options.length > 0) {
        examSelect.value = examSelect.options[0].value; // Auto-select the first exam
    }
    if (classSelect.options.length > 1) { // Check if there's more than the placeholder
        classSelect.value = classSelect.options[1].value; // Auto-select the first available class
    }
    
    // Dispatch a change event to kick off the whole process
    examSelect.dispatchEvent(new Event('change'));
    if (classSelect.value) {
        classSelect.dispatchEvent(new Event('change'));
    }
}

// =========================================================================
// --- âœï¸ MARK ENTRY MODULE (OPTIMIZED SAVE LOGIC) ---
// =========================================================================

async function loadMarkEntrySheet(examId, classId, division, subjectId) {
    const container = document.getElementById('mark-entry-sheet');
    if (!examId || !classId || !division || !subjectId) {
        container.innerHTML = `<div class="text-center p-5 text-muted">Please select all filters to enter marks.</div>`;
        return;
    }
    
    container.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary"></div><p class="mt-2">Loading student marks...</p></div>`;

    const schedule = examSchedules.find(s => s.examId === examId && s.classId === classId && s.division === division && s.subjectId === subjectId);
    if (!schedule) {
        container.innerHTML = '<div class="alert alert-danger">Could not find a valid exam schedule for this selection.</div>';
        return;
    }
    
    const maxTE = schedule.maxTE || 0;
    const maxCE = schedule.maxCE || 0;
    const studentsInClass = students
        .filter(s => s.classId === classId && s.division === division && s.status !== 'TC Issued' && s.status !== 'Graduated')
        .sort((a, b) => a.name.localeCompare(b.name));

    if (studentsInClass.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">No active students found in this class/division.</div>';
        return;
    }
    
    const marksForSheet = {};
    try {
        const q = query(getCollectionRef('marks'), 
            where('examId', '==', examId),
            where('classId', '==', classId),
            where('division', '==', division),
            where('subjectId', '==', subjectId)
        );
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach(doc => {
            const markData = doc.data();
            marksForSheet[markData.studentId] = markData;
        });
    } catch (error) {
        console.error("Error fetching marks directly:", error);
        showAlert('Could not fetch the latest marks. Data may be from cache.', 'danger');
        studentsInClass.forEach(student => {
            const markId = `${examId}_${student.id}_${subjectId}`;
            if (marks[markId]) {
                marksForSheet[student.id] = marks[markId];
            }
        });
    }
    
    const enteredStudents = studentsInClass.filter(student => marksForSheet[student.id]).map(s => s.name);
    const notEnteredStudents = studentsInClass.filter(student => !marksForSheet[student.id]).map(s => s.name);

    const summaryHTML = `
        <div class="card bg-light p-3 mb-4 border-0">
            <h6 class="fw-bold">Entry Status</h6>
            <div class="d-flex justify-content-around text-center mt-2">
                <div><h5 class="mb-0">${studentsInClass.length}</h5><small class="text-muted">Total Students</small></div>
                <div><h5 class="mb-0 text-success">${enteredStudents.length}</h5><small class="text-muted">Marks Entered</small></div>
                <div><h5 class="mb-0 text-danger">${notEnteredStudents.length}</h5><small class="text-muted">Pending</small></div>
            </div>
            ${notEnteredStudents.length > 0 ? `
            <div class="mt-3">
                <a class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" href="#pending-list-collapse" role="button">Show Pending Student List</a>
                <div class="collapse mt-2" id="pending-list-collapse">
                    <ul class="list-group list-group-flush small">${notEnteredStudents.map(name => `<li class="list-group-item py-1 bg-light">${name}</li>`).join('')}</ul>
                </div>
            </div>` : ''}
        </div>`;

    let tableHTML = `<div class="table-responsive"><table id="marks-table" class="table table-bordered">
        <thead class="table-light"><tr><th>Student Name</th><th>Admission No.</th><th>Theory / ${maxTE}</th><th>Internal / ${maxCE}</th></tr></thead><tbody>`;
    
    studentsInClass.forEach(student => {
        const mark = marksForSheet[student.id];
        const teValue = mark?.te === 'AB' ? 'AB' : (mark?.te ?? '');
        const ceValue = mark?.ce === 'AB' ? 'AB' : (mark?.ce ?? '');
        
        // --- MODIFICATION: Add data-original-value to track changes ---
        tableHTML += `<tr data-student-id="${student.id}">
            <td class="fw-bold">${student.name}</td><td>${student.admissionNumber}</td>
            <td><input type="text" name="te" class="form-control form-control-sm" value="${teValue}" data-max="${maxTE}" data-original-value="${teValue}"></td>
            <td><input type="text" name="ce" class="form-control form-control-sm" value="${ceValue}" data-max="${maxCE}" data-original-value="${ceValue}"></td>
        </tr>`;
    });
    
    tableHTML += `</tbody></table></div><div class="text-end mt-3"><button id="save-marks-btn" class="btn btn-success">Save Changes</button></div>`;
    
    container.innerHTML = summaryHTML + tableHTML;
    document.getElementById('mark-entry-summary-container').innerHTML = '';

    container.querySelectorAll('input[name="te"], input[name="ce"]').forEach(input => {
        if(input.value.toUpperCase() === 'AB') { input.classList.add('absent-mark'); }
        input.addEventListener('input', (e) => {
            e.target.classList.remove('absent-mark');
            if(e.target.value.toUpperCase() === 'AB') { e.target.classList.add('absent-mark'); return; }
            const maxValue = parseInt(e.target.dataset.max, 10);
            const currentValue = parseInt(e.target.value, 10);
            if (!isNaN(currentValue) && currentValue > maxValue) { e.target.value = ''; }
        });
    });
    document.getElementById('save-marks-btn').addEventListener('click', () => saveMarks(examId, classId, division, subjectId));
}

/**
 * Saves marks ONLY for the rows that have been changed by the user.
 */
async function saveMarks(examId, classId, division, subjectId) {
    const examSelect = document.getElementById('mark-entry-exam');
    examId=examSelect.value;

    const saveButton = document.getElementById('save-marks-btn');
    if (!saveButton) return;

    const originalButtonHtml = saveButton.innerHTML;
    saveButton.disabled = false;
    saveButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Saving...`;

    try {
        const batch = writeBatch(db);
        const markRows = document.querySelectorAll('#marks-table tbody tr');
        let changesFound = 0;

        markRows.forEach(row => {
            const studentId = row.dataset.studentId;
            const teInput = row.querySelector('input[name="te"]');
            const ceInput = row.querySelector('input[name="ce"]');

            const originalTE = teInput.dataset.originalValue;
            const currentTE = teInput.value.trim();
            const originalCE = ceInput.dataset.originalValue;
            const currentCE = ceInput.value.trim();

            // --- MODIFICATION: Check if the row has changed ---
            if (originalTE !== currentTE || originalCE !== currentCE) {
                // If both inputs are now empty, it means we are clearing the mark.
                // For now, we will treat this as a change to save.
                // A more advanced version could handle deletion.
                if (currentTE === '' && currentCE === '') {
                    // Decide if clearing marks should delete the document.
                    // For simplicity, we'll just skip saving if both are blank.
                    return; 
                }

                changesFound++;
                const te = currentTE.toUpperCase() === 'AB' ? 'AB' : (parseInt(currentTE) || 0);
                const ce = currentCE.toUpperCase() === 'AB' ? 'AB' : (parseInt(currentCE) || 0);
                
                const markId = `${examId}_${studentId}_${subjectId}`;
                const markRef = getDocRef('marks', markId);
                batch.set(markRef, { examId, classId, division, subjectId, studentId, te, ce, lastUpdated: serverTimestamp() });
            }
        });

        if (changesFound > 0) {
            await batch.commit();
            showAlert(`${changesFound} student mark(s) saved successfully!`, 'success');
            // Reload the sheet to refresh original values and stats
            loadMarkEntrySheet(examId, classId, division, subjectId); 
        } else {
            showAlert('No changes detected to save.', 'info');
        }

    } catch (error) {
        console.error("Error saving marks:", error);
        showAlert("Could not save marks. Please check the console.", "danger");
        saveButton.disabled = false;
        saveButton.innerHTML = originalButtonHtml;
    } finally {
        saveButton.disabled = false;
        saveButton.innerHTML = originalButtonHtml;
    }
}
        
/**
 * Renders a summary table of mark entry status for a given exam across all classes.
 * @param {string} examId The ID of the exam to summarize.
 */
// Global variable to hold the summary data and filter state
let currentSummaryData = [];
let showPendingOnly = false;

window.renderMarkEntrySummaryTable = (examId) => {
    const summaryContainer = document.getElementById('mark-entry-summary-container');
    if (!summaryContainer) return;

    if (!examId) {
        summaryContainer.innerHTML = '<p class="text-muted p-5 text-center">Select an exam to view the summary.</p>';
        return;
    }

    // --- Data Calculation Logic (remains the same) ---
    let fullSummaryData = [];
    const schedulesForExam = examSchedules.filter(s => s.examId === examId);

    schedulesForExam.forEach(schedule => {
        const { classId, division, subjectId } = schedule;
        const studentsInClass = students

Â  Â  .filter(s => s.classId === classId && s.division === division && s.status !== 'TC Issued')

Â  Â  .sort((a, b) => a.name.localeCompare(b.name));
const totalStudents = studentsInClass.length;

        if (totalStudents === 0) return;

        // Corrected logic to check the global 'marks' object
        let enteredCount = 0;
        studentsInClass.forEach(student => {
            const markId = `${examId}_${student.id}_${subjectId}`;
            if (marks[markId]) { // Check if a key exists in the marks object
                enteredCount++;
            }
        });

        const className = classes.find(c => c.id === classId)?.name || 'N/A';
        const subjectName = subjects.find(sub => sub.id === subjectId)?.name || 'N/A';

        fullSummaryData.push({
            className,
            division,
            subjectName,
            total: totalStudents,
            entered: enteredCount,
            pending: totalStudents - enteredCount
        });
    });

    fullSummaryData.sort((a,b) => (a.className + a.division + a.subjectName).localeCompare(b.className + b.division + a.subjectName));
    
    // Store the full data globally
    currentSummaryData = fullSummaryData;
    
    // Call the new rendering function
    renderFilteredSummaryTable(examId);
};

/**
 * 2. RENDERS the summary table based on the current filter state.
 */
const renderFilteredSummaryTable = (examId) => {
    const summaryContainer = document.getElementById('mark-entry-summary-container');
    if (!summaryContainer) return;
    
    let displayData = currentSummaryData;

    // --- APPLY THE FILTER ---
    if (showPendingOnly) {
        displayData = currentSummaryData.filter(row => row.pending > 0);
    }
    
    // --- GENERATE HTML with the new toggle button ---
    const tableHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Mark Entry Status for: <strong>${exams.find(e=>e.id===examId)?.name}</strong></h5>
           
        </div>
        <div id="mark-entry-summary-printable" class="table-responsive">
            <table class="table table-bordered table-hover table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Class</th>
                        <th>Subject</th>
                        <th class="text-center">Total Students</th>
                        <th class="text-center text-success">Entered</th>
                        <th class="text-center text-danger">Pending</th>
                        <th class="text-center" style="width: 20%;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${displayData.map(row => {
                        const percentage = row.total > 0 ? (row.entered / row.total) * 100 : 0;
                        const statusClass = percentage === 100 ? 'bg-success' : (percentage > 0 ? 'bg-warning' : 'bg-danger');
                        return `
                        <tr>
                            <td>${row.className} - ${row.division}</td>
                            <td>${row.subjectName}</td>
                            <td class="text-center">${row.total}</td>
                            <td class="text-center text-success">${row.entered}</td>
                            <td class="text-center text-danger">${row.pending}</td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar ${statusClass}" role="progressbar" style="width: ${percentage}%;" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">${percentage.toFixed(0)}%</div>
                                </div>
                            </td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
            ${displayData.length === 0 ? '<p class="text-muted text-center py-4">No pending entries for this exam.</p>' : ''}
        </div>
    `;
    
    summaryContainer.innerHTML = tableHTML;
    
};



const exportSummaryToPdf = async (examId) => {
    const { jsPDF } = window.jspdf;
    const input = document.getElementById('mark-entry-summary-printable');
    
    if (!input) {
        showAlert('Error: Summary table not found for export.', 'danger');
        return;
    }

    // Show a loading message
    const originalContent = input.innerHTML;
    input.innerHTML = '<div class="text-center my-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Generating PDF...</p></div>';

    try {
        const examName = exams.find(e => e.id === examId)?.name || 'Exam Summary';

        // Use html2canvas to convert the HTML table to an image
        const canvas = await html2canvas(input, {
            scale: 2, // Increase scale for better resolution
            useCORS: true,
            logging: false,
        });

        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' for units, 'a4' for page size
        
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 297; // A4 height in mm
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;

        let position = 0;

        // Add header
        pdf.setFontSize(18);
        pdf.text('Mark Entry Summary', 105, 15, null, null, 'center');
        pdf.setFontSize(12);
        pdf.text(`Exam: ${examName}`, 105, 25, null, null, 'center');
        pdf.line(15, 30, 195, 30); // Draw a line
        position = 35; // Start position for the image after the header

        // Add the image to the PDF
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= (pageHeight - position);

        // Handle multiple pages for long tables
        while (heightLeft > 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }

        pdf.save(`Mark_Entry_Summary_${examName.replace(/\s/g, '_')}.pdf`);
        showAlert('PDF export successful!', 'success');
        
    } catch (error) {
        console.error('PDF generation failed:', error);
        showAlert('Failed to generate PDF. Please try again.', 'danger');
    } finally {
        // Restore the original content of the container
        input.innerHTML = originalContent;
    }
};

        /**
 * Main controller for the Rank List tab.
 * It triggers the data loading and then calls the processing and rendering functions.
 * @param {HTMLElement} container - The DOM element to render the report into.
 */
function generateResultsTable(container) {
    const examId = document.getElementById('res-exam').value;
    const classId = document.getElementById('res-class').value;
    const division = document.getElementById('res-division').value;
    
    if (!examId || !classId || !division) { 
        container.innerHTML = `<p class="text-center p-5 text-muted">Please select all filters.</p>`; 
        return; 
    }
    
    // --- CORRECTED: Use the dynamic listener to fetch only the required marks ---
    // This will automatically trigger the report to re-render when data arrives.
    attachMarksListener(examId, classId, division);

    // Process and render the table with currently available data
    const studentsInClass = students

Â  Â  .filter(s => s.classId === classId && s.division === division && s.status !== 'TC Issued')

Â  Â  .sort((a, b) => a.name.localeCompare(b.name));
const schedulesForClass = examSchedules.filter(s => s.examId === examId && s.classId === classId && s.division === division);
    
    // The global 'marks' object will be used here
    let results = processRankListData(studentsInClass, schedulesForClass, marks, examId);
    
    // Sort results by total marks in descending order
    results.sort((a, b) => b.totalMark - a.totalMark);

    // Render the final HTML table
    container.innerHTML = renderRankListTable(results);
}


/**
 * Processes data to calculate totals and status for the rank list.
 * @returns {Array} An array of student result objects.
 */
function processRankListData(studentsInClass, schedulesForClass, marksObject, examId) {
    let results = [];
    studentsInClass.forEach(student => {
        let totalMark = 0, maxTotal = 0, status = 'PASS';
        
        schedulesForClass.forEach(schedule => {
            // --- FIXED: Direct object lookup for performance ---
            const markId = `${examId}_${student.id}_${schedule.subjectId}`;
            const mark = marksObject[markId];

            const te = mark?.te;
            const ce = mark?.ce;
            const subjectTotal = (te === 'AB' || ce === 'AB') ? 'AB' : (Number(te) || 0) + (Number(ce) || 0);
            
            // Determine fail status
            if (subjectTotal === 'AB' || (typeof subjectTotal === 'number' && (subjectTotal / (schedule.maxTE + schedule.maxCE) < 0.35))) {
                status = 'FAIL';
            }
            
            if (typeof subjectTotal === 'number') {
                totalMark += subjectTotal;
            }
            maxTotal += (schedule.maxTE || 0) + (schedule.maxCE || 0);
        });

        const percentage = maxTotal > 0 ? ((totalMark / maxTotal) * 100).toFixed(2) : 0;
        results.push({ student, totalMark, maxTotal, percentage, status });
    });
    return results;
}


/**
 * Renders the HTML for the rank list table, correctly handling ties.
 * @param {Array} sortedResults - The array of sorted student result objects.
 * @returns {string} The complete HTML string for the table.
 */
function renderRankListTable(sortedResults) {
    let tableHTML = `<div class="table-responsive"><table class="table table-bordered table-hover">
        <thead class="table-light"><tr><th>Rank</th><th>Name</th><th>Total</th><th>%</th><th>Result</th></tr></thead>
        <tbody>`;

    let lastMark = -1;
    let lastRank = 0;

    sortedResults.forEach((res, index) => {
        // --- NEW: Correctly handle rank ties ---
        let currentRank;
        if (res.status === 'FAIL') {
            currentRank = '-';
        } else {
            // If the current student's score is the same as the previous one, they get the same rank
            if (res.totalMark === lastMark) {
                currentRank = lastRank;
            } else {
                currentRank = index + 1;
                lastRank = currentRank;
            }
            lastMark = res.totalMark;
        }

        tableHTML += `
            <tr class="${res.status === 'FAIL' ? 'table-danger' : ''}">
                <td class="fw-bold">${currentRank}</td>
                <td>${res.student.name}</td>
                <td>${res.totalMark} / ${res.maxTotal}</td>
                <td>${res.percentage}%</td>
                <td class="fw-bold">${res.status === 'PASS' ? 'PASS' : 'FAIL'}</td>
            </tr>`;
    });

    tableHTML += `</tbody></table></div>`;
    return tableHTML;
}
  /**
 * Renders the enhanced Report Card tab with class filters, a student list,
 * a "Print All" button, and a new "Print This Card" button for individual reports.
 */
function renderReportCardTab() {
    const container = document.getElementById('pills-reportcard');
    if (!container) return;

    const classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

    container.innerHTML = `
        <div class="row g-3 no-print">
            <div class="col-md-3">
                <label for="rc-class-select" class="form-label">Class</label>
                <select id="rc-class-select" class="form-select">
                    <option value="">-- Select Class --</option>
                    ${classOptions}
                </select>
            </div>
            <div class="col-md-3">
                <label for="rc-division-select" class="form-label">Division</label>
                <select id="rc-division-select" class="form-select" disabled></select>
            </div>
            <div class="col-md-6">
                <label for="rc-exam-select" class="form-label">Exam(s) for Report</label>
                <select id="rc-exam-select" class="form-select" multiple size="3">
                    ${exams.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}
                </select>
                <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple exams for comparison.</small>
            </div>
        </div>
        <hr class="no-print">
        
        <div class="row">
            <div class="col-md-4 no-print">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Students in Class</h6>
                        <button id="rc-print-all-btn" class="btn btn-primary btn-sm" disabled>
                            <i class="fas fa-print me-2"></i>Print All
                        </button>
                    </div>
                    <div id="rc-student-list" class="list-group list-group-flush" style="max-height: 60vh; overflow-y: auto;">
                        <p class="p-3 text-muted">Select a class and division.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                 <div id="report-card-view-wrapper">
                    <div id="rc-header" class="d-flex justify-content-between align-items-center mb-3 no-print" style="display: none !important;">
                        <h5 id="rc-student-name-header" class="mb-0">Progress Report</h5>
                        <button id="rc-print-single-btn" class="btn btn-secondary btn-sm">
                            <i class="fas fa-print me-2"></i>Print This Card
                        </button>
                    </div>
                    <div id="rc-results-container">
                        <p class="text-center p-5 text-muted">Select a student from the list to view their report card.</p>
                    </div>
                 </div>
            </div>
        </div>
    `;

    // --- Get all necessary DOM elements ---
    const classSelect = document.getElementById('rc-class-select');
    const divisionSelect = document.getElementById('rc-division-select');
    const examSelect = document.getElementById('rc-exam-select');
    const studentListContainer = document.getElementById('rc-student-list');
    const resultsContainer = document.getElementById('rc-results-container');
    const printAllBtn = document.getElementById('rc-print-all-btn');
    const rcHeader = document.getElementById('rc-header');
    const rcStudentNameHeader = document.getElementById('rc-student-name-header');
    const printSingleBtn = document.getElementById('rc-print-single-btn');

    const updateStudentList = () => {
        const classId = classSelect.value;
        const division = divisionSelect.value;

        rcHeader.style.display = 'none'; // Hide single print header
        resultsContainer.innerHTML = `<p class="text-center p-5 text-muted">Select a student from the list.</p>`;
        printAllBtn.disabled = true;

        if (!classId || !division) {
            studentListContainer.innerHTML = `<p class="p-3 text-muted">Select a class and division.</p>`;
            return;
        }

       // const studentsInClass = students.filter(s => s.classId === classId && s.division === division).sort((a,b) => a.name.localeCompare(b.name));
        const studentsInClass = students.filter(s => s.classId === classId && s.division === division && s.status !== 'TC Issued').sort((a, b) => a.name.localeCompare(b.name));
        
        if (studentsInClass.length === 0) {
            studentListContainer.innerHTML = `<p class="p-3 text-muted">No students found.</p>`;
            return;
        }

        printAllBtn.disabled = false;
        studentListContainer.innerHTML = studentsInClass.map(s => `
            <a href="#" class="list-group-item list-group-item-action rc-student-link" data-student-id="${s.id}">
                ${s.name} <small class="text-muted">(${s.admissionNumber})</small>
            </a>`).join('');
    };

    // --- Attach Event Listeners ---
    classSelect.addEventListener('change', () => {
        const selectedClass = classes.find(c => c.id === classSelect.value);
        divisionSelect.innerHTML = '<option value="">-- Select Division --</option>';
        divisionSelect.disabled = !selectedClass;
        if (selectedClass) {
            divisionSelect.innerHTML += selectedClass.divisions.map(d => `<option value="${d}">${d}</option>`).join('');
        }
        updateStudentList();
    });

    divisionSelect.addEventListener('change', updateStudentList);

    studentListContainer.addEventListener('click', e => {
        e.preventDefault();
        const link = e.target.closest('.rc-student-link');
        if (link) {
            document.querySelectorAll('.rc-student-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            const studentId = link.dataset.studentId;
            const studentName = students.find(s=>s.id === studentId)?.name || 'Report';
            const examIds = Array.from(examSelect.selectedOptions).map(opt => opt.value);
            if (examIds.length === 0) {
                showAlert('Please select at least one exam.', 'warning');
                return;
            }
            resultsContainer.innerHTML = generateReportCardHTML_Comparison(studentId, examIds);
            // Show the header and print button for the selected student
            rcStudentNameHeader.textContent = `Report for ${studentName}`;
            rcHeader.style.display = 'flex';
        }
    });

    printSingleBtn.addEventListener('click', () => {
        const studentName = rcStudentNameHeader.textContent;
        printContentOfDiv('rc-results-container', studentName);
    });

    printAllBtn.addEventListener('click', () => {
        const classId = classSelect.value;
        const division = divisionSelect.value;
        const examIds = Array.from(examSelect.selectedOptions).map(opt => opt.value);
        if (!classId || !division || examIds.length === 0) {
            return showAlert('Please select a class, division, and at least one exam to print all.', 'warning');
        }
        printAllReportCards(classId, division, examIds);
    });

    // Handle student view
    if (currentUserRole === 'student') {
        classSelect.value = selectedUser.classId;
        classSelect.disabled = true;
        divisionSelect.innerHTML = `<option value="${selectedUser.division}">${selectedUser.division}</option>`;
        divisionSelect.disabled = true;
        examSelect.value = exams[0]?.id || '';
        studentListContainer.innerHTML = `<a href="#" class="list-group-item list-group-item-action rc-student-link active" data-student-id="${selectedUser.id}">${selectedUser.name}</a>`;
        generateReportCardHTML_Comparison(selectedUser.id, [examSelect.value], 'rc-results-container');
        rcHeader.style.display = 'flex'; // Show print button for student
        printAllBtn.style.display = 'none'; // Hide print all button for student
    }
}
/**
 * Generates a single, multi-page HTML document for all students in a class and prints it.
 * This version uses a temporary DOM element to ensure all images are loaded before printing.
 */
function printAllReportCards(classId, division, examIds) {
    showAlert('Preparing report cards for printing...', 'info');

    const studentsInClass = students.filter(s => s.classId === classId && s.division === division);
    if (studentsInClass.length === 0) {
        return showAlert('No students to print.', 'warning');
    }

    const tempPrintContainer = document.createElement('div');
    tempPrintContainer.id = 'temp-report-card-container';
    tempPrintContainer.style.display = 'none';
    document.body.appendChild(tempPrintContainer);

    try {
        let allCardsHtml = '';
        studentsInClass.forEach(student => {
            // --- MODIFIED: Directly get the HTML string from the function ---
            const cardHtml = generateReportCardHTML_Comparison(student.id, examIds,tempPrintContainer);
            allCardsHtml += `<div class="printable-card-page">${cardHtml}</div>`;
        });
        
        tempPrintContainer.innerHTML = allCardsHtml;
        const reportTitle = `Report Cards for ${classes.find(c=>c.id===classId).name} - ${division}`;
        
        printContentOfDiv('temp-report-card-container', reportTitle, {
            extraCss: `.printable-card-page { page-break-after: always; } .printable-card-page:last-child { page-break-after: avoid; }`
        });
    } finally {
        document.body.removeChild(tempPrintContainer);
    }
}


function renderRankListTab() {
            const container = document.getElementById('pills-ranklist');

            // Determine class options based on user role
            let classOptions = '';
            if (currentUserRole === 'teacher') {
                const teacherAllocations = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id);
                const uniqueClassIds = [...new Set(teacherAllocations.map(a => a.classId))];
                classOptions = uniqueClassIds.map(classId => {
                    const c = classes.find(cls => cls.id === classId);
                    return c ? `<option value="${c.id}">${c.name}</option>` : '';
                }).join('');
            } else { // For admin
                classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }

            container.innerHTML = `
                <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
                    <div class="col-md-4"><label class="form-label">Exam</label><select id="res-exam" class="form-select">${exams.map(e=>`<option value="${e.id}">${e.name}</option>`).join('')}</select></div>
                    <div class="col-md-4"><label class="form-label">Class</label><select id="res-class" class="form-select">${classOptions}</select></div>
                    <div class="col-md-4"><label class="form-label">Division</label><select id="res-division" class="form-select"></select></div>
                </div>
                <div id="results-table-container"></div>`;
            
            const examSelect = document.getElementById('res-exam');
            const classSelect = document.getElementById('res-class');
            const divisionSelect = document.getElementById('res-division');
            
            const loadTable = () => generateResultsTable(document.getElementById('results-table-container'));
            
            // This listener now correctly filters divisions based on the teacher's allocations
            classSelect.addEventListener('change', () => {
                const selectedClassId = classSelect.value;
                let divisionOptionsHTML = '';
                if (currentUserRole === 'teacher') {
                    const teacherAllocationsForClass = classroomSubjects.filter(cs => cs.teacherId === selectedUser.id && cs.classId === selectedClassId);
                    const uniqueDivisions = [...new Set(teacherAllocationsForClass.map(a => a.division))];
                    divisionOptionsHTML = uniqueDivisions.map(d => `<option value="${d}">${d}</option>`).join('');
                } else {
                    const cls = classes.find(c => c.id === selectedClassId);
                    divisionOptionsHTML = cls ? cls.divisions.map(d => `<option value="${d}">${d}</option>`).join('') : '';
                }
                divisionSelect.innerHTML = divisionOptionsHTML;
                loadTable(); // Load the table for the newly selected class/division
            });

            examSelect.addEventListener('change', loadTable);
            divisionSelect.addEventListener('change', loadTable);
            
            // Initial load for the first class in the list
            if (classSelect.options.length > 0) {
                 classSelect.dispatchEvent(new Event('change'));
            }
        }

    /**
 * Generates the HTML for a student's report card.
 * @param {string} studentId - The ID of the student.
 * @param {string} examId - The ID of the exam.
 * @param {string} containerId - The ID of the HTML element to render the report into.
 */
function generateReportCardHTML(studentId, examId, containerId) {
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Container with ID ${containerId} not found for report card.`);
        return;
    }

    const student = students.find(s => s.id === studentId);
    const exam = exams.find(e => e.id === examId);
    const studentClass = classes.find(c => c.id === student?.classId); // Defensive: student?.classId
    
    // Defensive checks for core data
    if (!student || !exam) {
        container.innerHTML = `<p class="alert alert-warning text-center">Student or Exam data not found for generating report card.</p>`;
        return;
    }

    // Filter schedules for this specific student's class and exam
    const schedules = examSchedules.filter(s =>
        s.examId === examId &&
        s.classId === student.classId &&
        s.division === student.division
    );

    // Call processExamResultsData (ensure it returns studentId and subjectId in subjectResults)
    // We pass [student] as an array, and take the first element of the result.
    const processedReportData = processExamResultsData([student], schedules, marks, examId, document.getElementById('shared-grading-system')?.value || 'type1');

    // Destructure the required properties from the first (and only) student's processed data
    const {
        studentId: processedStudentId, // Renaming to avoid conflict with outer studentId
        studentName,
        subjectResults,
        grandTotalMarks,
        grandMaxMarks,
        grandPct,
        finalStatus,
        overallGrade
    } = processedReportData[0] || {}; // Use default empty object if processedReportData[0] is undefined

    // If subjectResults is not available (e.g., marks still loading or no schedules)
    if (!subjectResults || subjectResults.length === 0) {
        container.innerHTML = `<div class="text-center p-5"><div class="spinner-border"></div><p class="mt-2">Loading marks or no subjects scheduled for this exam/class.</p></div>`;
        return;
    }

    // Get grading system safely
    const gradingSystem = document.getElementById('shared-grading-system')?.value || 'type1';
    
    // Construct photo URL: use thumbnail if photoDriveId exists, otherwise a placeholder
    const studentPhotoSrc = student.photoDriveId
        ? `https://drive.google.com/thumbnail?id=${student.photoDriveId}&sz=400`
        : 'https://placehold.co/150x200?text=No+Photo&font=roboto';


    container.innerHTML = `
    <div id="report-card-printable" class="p-4 border bg-white mx-auto" style="max-width: 210mm;">
        <div class="report-header text-center mb-4">
            ${schoolDetails.logoUrl ? `<img src="${schoolDetails.logoUrl}" alt="School Logo" style="max-height: 80px; margin-bottom: 1rem;">` : ''}
            <h3>${schoolDetails.address || 'School Name'}</h3>
            <p class="lead mb-0">${schoolDetails.name || 'School Address'}</p>
            <h5 class="mt-3">PROGRESS REPORT - ${exam.name.toUpperCase()}</h5>
        </div>

        <div class="row mb-4 align-items-center">
            <div class="col-md-8">
                <table class="table table-sm table-borderless">
                    <tbody>
                        <tr><th style="width: 150px;">Student Name</th><td>: ${student.name}</td></tr>
                        <tr><th>Admission No</th><td>: ${student.admissionNumber || 'N/A'}</td></tr>
                        <tr><th>Class</th><td>: ${studentClass?.name || 'N/A'} - ${student.division || 'N/A'}</td></tr>
                        <tr><th>Date of Birth</th><td>: ${new Date(student.dob).toLocaleDateString('en-GB') || 'N/A'}</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="col-md-3 text-center">
                <img src="${studentPhotoSrc}"
                     alt="Student Photo" class="img-thumbnail rounded-3 shadow-sm" style="width: 130px; height: 170px; object-fit: cover; border: 2px solid #ddd;">
            </div>
        </div>

        <table class="table table-bordered table-sm">
            <thead class="table-light text-center fs-6"><tr><th>SUBJECT</th><th>THEORY</th><th>INTERNAL</th><th>TOTAL</th><th>MAX</th><th>GRADE</th></tr></thead>
            <tbody>
                ${subjectResults.map(res => {
                    const subjectName = subjects.find(s => s.id === res.subjectId)?.name || 'N/A'; // Use subjectId directly
                    const totalGrade = gradingSystem === 'type1' ? calculateGrade(res.total, res.maxTE + res.maxCE) : calculateGradeType2(res.total, res.maxTE + res.maxCE);
                    
                    return `
                        <tr class="text-center">
                            <td class="text-start">${subjectName}</td>
                            <td class="text-center">${res.te}</td>
                            <td class="text-center">${res.ce}</td>
                            <td class="text-center">${res.total}</td>
                            <td class="text-center">${res.maxTE + res.maxCE}</td>
                            <td class="text-center">${totalGrade}</td>
                        </tr>`;
                }).join('')}
            </tbody>
            <tfoot class="fw-bold text-center">
                <tr>
                    <td colspan="2" class="text-end">GRAND TOTAL</td>
                    <td class="text-center">${grandTotalMarks}</td>
                    <td class="text-center">${grandMaxMarks}</td>
                    <td colspan="2"></td>
                </tr>
            </tfoot>
        </table>
        <div class="row mt-4 fw-bold text-center">
            <div class="col-6">Overall Percentage: <span class="fs-5">${grandPct?.toFixed(2) || '0.00'}%</span></div>
            <div class="col-6">Final Result: <span class="fs-5 text-${finalStatus === 'PASS' ? 'success':'danger'}">${finalStatus || 'N/A'}</span></div>
        </div>
        <div class="row mt-5 pt-5 text-center text-muted" style="font-size: 0.9rem;">
            <div class="col-6"><hr class="mx-auto w-50">Class Teacher</div>
            <div class="col-6"><hr class="mx-auto w-50">Principal</div>
        </div>
    </div>`;
}
/**
 * Generates and returns the HTML for a student's comparison report card.
 * This version includes a detailed summary and a new "Grand Total" row after the subjects.
 * @param {string} studentId - The ID of the student.
 * @param {string[]} examIds - An array of exam IDs to compare.
 * @returns {string} The complete HTML string for the report card, or an error message.
 */
function generateReportCardHTML_Comparison(studentId, examIds) {
    const student = students.find(s => s.id === studentId);
    if (!student) {
        console.error("Could not generate report card: Student not found for ID", studentId);
        return '<p class="alert alert-danger">Student data not found.</p>';
    }

    const studentClass = classes.find(c => c.id === student?.classId);
    const gradingSystem = document.getElementById('shared-grading-system')?.value || 'type1';
    const studentPhotoSrc = student.photoDriveId
        ? `https://drive.google.com/thumbnail?id=${student.photoDriveId}&sz=400`
        : 'https://placehold.co/150x200?text=No+Photo&font=roboto';

    const examsData = examIds.map(eId => {
        const exam = exams.find(e => e.id === eId);
        if (!exam) return null;

        const schedules = examSchedules.filter(s => s.examId === eId && s.classId === student.classId && s.division === student.division);
        const processedData = processExamResultsData([student], schedules, marks, eId, gradingSystem);
        const report = processedData[0] || {};

        const allStudentsInClass = students.filter(s => s.classId === student.classId && s.division === student.division && s.status !== 'TC Issued' && s.status !== 'Graduated').sort((a, b) => a.name.localeCompare(b.name));
        const allProcessed = processExamResultsData(allStudentsInClass, schedules, marks, eId, gradingSystem);
        allProcessed.sort((a, b) => b.grandTotalMarks - a.grandTotalMarks);
        const rank = allProcessed.findIndex(s => s.studentId === student.id) + 1;
        return { exam, report, rank };
    }).filter(Boolean);

    const allSubjectIds = [...new Set(examsData.flatMap(e => e.report.subjectResults?.map(r => r.subjectId) || []))];

    let headerRow1 = `<tr><th rowspan="2">Subject</th>`;
    let headerRow2 = ``;
    examsData.forEach(ed => {
        headerRow1 += `<th colspan="4" class="text-center">${ed.exam.name}</th>`;
        headerRow2 += `<th>TE/MaxTE</th><th>CE/MaxCE</th><th>Total/Max</th><th>Grade</th>`;
    });
    headerRow1 += `</tr>`;
    headerRow2 = `<tr>${headerRow2}</tr>`;

    let bodyRows = ``;
    allSubjectIds.forEach(subId => {
        const subjectName = subjects.find(s => s.id === subId)?.name || "N/A";
        let rowHtml = `<tr><td>${subjectName}</td>`;
        examsData.forEach(ed => {
            const res = ed.report.subjectResults?.find(r => r.subjectId === subId);
            if (res) {
                const totalMax = res.maxTE + res.maxCE;
                const totalGrade = gradingSystem === 'type1' 
                    ? calculateGrade(res.total, totalMax) 
                    : calculateGradeType2(res.total, totalMax);
                rowHtml += `
                    <td class="text-center">${res.te}/${res.maxTE} (${res.teGrade})</td>
                    <td class="text-center">${res.ce}/${res.maxCE} (${res.ceGrade})</td>
                    <td class="text-center">${res.total}/${totalMax}</td>
                    <td class="text-center">${totalGrade}</td>
                `;
            } else {
                rowHtml += `<td>-</td><td>-</td><td>-</td><td>-</td>`;
            }
        });
        rowHtml += `</tr>`;
        bodyRows += rowHtml;
    });

    // --- MODIFICATION IS HERE ---
    // A new row for the Grand Total is created.
    // This snippet replaces the previous 'grandTotalRow' block.
// It now correctly calculates the totals from the detailed subject results.

let grandTotalRow = `<tr class="table-light fw-bold"><th>Grand Total</th>`;
examsData.forEach(ed => {
    const subjectResults = ed.report.subjectResults || [];

    // Calculate TE and CE totals by iterating through the subject results
const totalTE = subjectResults.reduce((sum, res) => sum + (Number(res.te) || 0), 0);
const totalMaxTE = subjectResults.reduce((sum, res) => sum + (Number(res.maxTE) || 0), 0);
const totalCE = subjectResults.reduce((sum, res) => sum + (Number(res.ce) || 0), 0);
const totalMaxCE = subjectResults.reduce((sum, res) => sum + (Number(res.maxCE) || 0), 0);
    // Use pre-calculated grand totals if available, otherwise fall back to the new sums
    const grandTotal = ed.report.grandTotalMarks || (totalTE + totalCE);
    const grandMaxTotal = ed.report.grandTotalMaxMarks || (totalMaxTE + totalMaxCE);
    const overallGrade = ed.report.overallGrade || '-';

    // Calculate the grade for the TE total
    const teTotalGrade = gradingSystem === 'type1' 
        ? calculateGrade(totalTE, totalMaxTE) 
        : calculateGradeType2(totalTE, totalMaxTE);

    // Calculate the grade for the CE total
    const ceTotalGrade = gradingSystem === 'type1' 
        ? calculateGrade(totalCE, totalMaxCE) 
        : calculateGradeType2(totalCE, totalMaxCE);

    // Build the four distinct columns for the grand total row with the calculated data
    grandTotalRow += `
        <td class="text-center">${totalTE}/${totalMaxTE} (${teTotalGrade})</td>
        <td class="text-center">${totalCE}/${totalMaxCE} (${ceTotalGrade})</td>
        <td class="text-center">${grandTotal}/${grandMaxTotal}</td>
        <td class="text-center">${overallGrade}</td>
    `;
});
grandTotalRow += `</tr>`;

    let summaryRow = `<tr><th>Overall %</th>`;
    examsData.forEach(ed => { summaryRow += `<td colspan="4" class="text-center">${ed.report.grandPct?.toFixed(2) || "0"}%</td>`; });
    summaryRow += `</tr>`;

    let gradeRow = `<tr><th>Overall Grade</th>`;
    examsData.forEach(ed => { gradeRow += `<td colspan="4" class="text-center">${ed.report.overallGrade || "-"}</td>`; });
    gradeRow += `</tr>`;

    let resultRow = `<tr><th>Result</th>`;
    examsData.forEach(ed => {
        const status = ed.report.finalStatus || 'N/A';
        resultRow += `<td colspan="4" class="text-center text-${status === 'PASS' ? 'success' : 'danger'}">${status}</td>`;
    });
    resultRow += `</tr>`;

    let rankRow = `<tr><th>Rank</th>`;
    examsData.forEach(ed => { rankRow += `<td colspan="4" class="text-center">${ed.rank}</td>`; });
    rankRow += `</tr>`;

    let remark = "Performance is consistent.";
    if (examsData.length > 1) {
        const first = examsData[0].report.grandPct || 0;
        const last = examsData[examsData.length - 1].report.grandPct || 0;
        if (last > first) remark = "Excellent! Performance has improved.";
        else if (last < first) remark = "Performance has declined. Needs more effort.";
    }

    return `
    <div id="report-card-printable" class="p-2 border bg-white mx-auto" style="max-width: 100%;">
        <div class="report-header text-center mb-4">
            ${schoolDetails.logoUrl ? `<img src="${schoolDetails.logoUrl}" style="max-height: 80px; margin-bottom: 0.5rem;margin-top: -1rem;">` : ''}
            <h4>${schoolDetails.address.toUpperCase() || 'School Name'}</h4>
            <p>${schoolDetails.name || ''}</p>
            <h4>Progress Report Comparison</h4>
        </div>
        <div class="row mb-4 align-items-center">
            <div class="col-8">
                <table class="table table-sm table-borderless">
                    <tbody>
                        <tr><th style="width: 150px;">Student Name</th><td>: ${student.name}</td></tr>
                        <tr><th>Admission No</th><td>: ${student.admissionNumber || 'N/A'}</td></tr>
                        <tr><th>Class</th><td>: ${studentClass?.name || 'N/A'} - ${student.division || 'N/A'}</td></tr>
                        <tr><th>Date of Birth</th><td>: ${new Date(student.dob).toLocaleDateString('en-GB') || 'N/A'}</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="col-4 text-center">
                <img src="${studentPhotoSrc}" alt="Student Photo" class="img-thumbnail rounded-3 shadow-sm" style="width: 130px; height: 170px; object-fit: cover; border: 2px solid #ddd;">
            </div>
        </div>
        <table class="table table-bordered table-sm">
            <thead class="table-light text-center">${headerRow1}${headerRow2}</thead>
            <tbody>${bodyRows}${grandTotalRow}${summaryRow}${gradeRow}${resultRow}${rankRow}</tbody>
        </table>
        <div class="mt-2"><strong>Teacher's Remark:</strong> ${remark}</div>
        <div class="row mt-5 text-center text-muted" style="font-size: 0.9rem;">
            <div class="col-6"><hr class="mx-auto w-50">Class Teacher</div>
            <div class="col-6"><hr class="mx-auto w-50">Headmaster / Principal</div>
        </div>
    </div>`;
}

function generateReportCardHTML_Comparisonnew(studentId, examIds) {
    const student = students.find(s => s.id === studentId);
    if (!student) {
        console.error("Could not generate report card: Student not found for ID", studentId);
        return '<p class="alert alert-danger">Student data not found.</p>';
    }

    const studentClass = classes.find(c => c.id === student?.classId);
    const gradingSystem = document.getElementById('shared-grading-system')?.value || 'type1';
    const gradeFunc = gradingSystem === 'type1' ? calculateGrade : calculateGradeType2;
    const studentPhotoSrc = student.photoDriveId
        ? `https://drive.google.com/thumbnail?id=${student.photoDriveId}&sz=400`
        : 'https://placehold.co/150x200?text=No+Photo&font=roboto';

    const examsData = examIds.map(eId => {
        const exam = exams.find(e => e.id === eId);
        if (!exam) return null;

        const schedules = examSchedules.filter(s => s.examId === eId && s.classId === student.classId && s.division === student.division);
        const allStudentsInClass = students.filter(s => s.classId === student.classId && s.division === student.division && s.status !== 'TC Issued' && s.status !== 'Graduated').sort((a, b) => a.name.localeCompare(b.name));
        
        const allProcessed = processExamResultsData(allStudentsInClass, schedules, marks, eId, gradingSystem);

        allProcessed.forEach(procStudent => {
            let totalTE = 0, maxTE = 0, totalCE = 0, maxCE = 0;
            procStudent.subjectResults.forEach(res => {
                if (res.te !== 'AB' && res.te !== 'N/A') totalTE += Number(res.te);
                if (res.ce !== 'AB' && res.ce !== 'N/A') totalCE += Number(res.ce);
                maxTE += res.maxTE;
                maxCE += res.maxCE;
            });
            procStudent.grandTotalTE = totalTE;
            procStudent.grandMaxTE = maxTE;
            procStudent.grandTotalCE = totalCE;
            procStudent.grandMaxCE = maxCE;
        });

        const report = allProcessed.find(s => s.studentId === studentId) || {};

        allProcessed.sort((a, b) => b.grandTotalMarks - a.grandTotalMarks);
        const totalRank = (allProcessed.findIndex(s => s.studentId === studentId) + 1) || 0;
        allProcessed.sort((a, b) => b.grandTotalTE - a.grandTotalTE);
        const teRank = (allProcessed.findIndex(s => s.studentId === studentId) + 1) || 0;
        allProcessed.sort((a, b) => b.grandTotalCE - a.grandTotalCE);
        const ceRank = (allProcessed.findIndex(s => s.studentId === studentId) + 1) || 0;

        return { exam, report, totalRank, teRank, ceRank };
    }).filter(Boolean);

    const allSubjectIds = [...new Set(examsData.flatMap(e => e.report.subjectResults?.map(r => r.subjectId) || []))];

    let headerRow1 = `<tr><th rowspan="2">Subject</th>`;
    let headerRow2 = ``;
    examsData.forEach(ed => {
        headerRow1 += `<th colspan="4" class="text-center">${ed.exam.name}</th>`;
        headerRow2 += `<th>TE/MaxTE (Grade)</th><th>CE/MaxCE (Grade)</th><th>Total/Max</th><th>Grade</th>`;
    });
    headerRow1 += `</tr>`;
    headerRow2 = `<tr>${headerRow2}</tr>`;

    let bodyRows = ``;
    allSubjectIds.forEach(subId => {
        const subjectName = subjects.find(s => s.id === subId)?.name || "N/A";
        let rowHtml = `<tr><td>${subjectName}</td>`;
        examsData.forEach(ed => {
            const res = ed.report.subjectResults?.find(r => r.subjectId === subId);
            if (res) {
                const totalMax = res.maxTE + res.maxCE;
                const totalGrade = gradeFunc(res.total, totalMax);
                rowHtml += `
                    <td class="text-center">${res.te}/${res.maxTE} (${res.teGrade})</td>
                    <td class="text-center">${res.ce}/${res.maxCE} (${res.ceGrade})</td>
                    <td class="text-center">${res.total}/${totalMax}</td>
                    <td class="text-center">${totalGrade}</td>`;
            } else {
                rowHtml += `<td colspan="4" class="text-center">-</td>`;
            }
        });
        rowHtml += `</tr>`;
        bodyRows += rowHtml;
    });

    // --- NEW: Create the "Grand Total" row ---
    let grandTotalRow = `<tr class="fw-bold table-primary"><th>Grand Total</th>`;
    examsData.forEach(ed => {
        const totalMarks = ed.report.grandTotalMarks || 0;
        const maxMarks = ed.report.grandMaxMarks || 0;
        const overallGrade = ed.report.overallGrade || '-';
        grandTotalRow += `<td colspan="4" class="text-center">${totalMarks} / ${maxMarks} (${overallGrade})</td>`;
    });
    grandTotalRow += `</tr>`;
    
    // Create detailed summary rows
    let summaryRows = `<tr class="table-light"><th colspan="${1 + examsData.length * 4}" class="text-primary">PERFORMANCE SUMMARY</th></tr>`;
    summaryRows += `<tr><th>Overall %</th>`;
    examsData.forEach(ed => {
        const pctTE = ed.report.grandMaxTE > 0 ? (ed.report.grandTotalTE / ed.report.grandMaxTE * 100).toFixed(2) : 0;
        const pctCE = ed.report.grandMaxCE > 0 ? (ed.report.grandTotalCE / ed.report.grandMaxCE * 100).toFixed(2) : 0;
        summaryRows += `<td colspan="4" class="text-center">TE: ${pctTE}% | CE: ${pctCE}% | <strong>Total: ${ed.report.grandPct?.toFixed(2) || 0}%</strong></td>`;
    });
    summaryRows += `</tr>`;
    summaryRows += `<tr><th>Overall Grade</th>`;
    examsData.forEach(ed => {
        const gradeTE = gradeFunc(ed.report.grandTotalTE, ed.report.grandMaxTE);
        const gradeCE = gradeFunc(ed.report.grandTotalCE, ed.report.grandMaxCE);
        summaryRows += `<td colspan="4" class="text-center">TE: ${gradeTE} | CE: ${gradeCE} | <strong>Total: ${ed.report.overallGrade || "-"}</strong></td>`;
    });
    summaryRows += `</tr>`;
    summaryRows += `<tr><th>Result</th>`;
    examsData.forEach(ed => {
        const resultTE = (gradeFunc(ed.report.grandTotalTE, ed.report.grandMaxTE) === 'E' || gradeFunc(ed.report.grandTotalTE, ed.report.grandMaxTE) === 'F') ? 'FAIL' : 'PASS';
        const resultCE = (gradeFunc(ed.report.grandTotalCE, ed.report.grandMaxCE) === 'E' || gradeFunc(ed.report.grandTotalCE, ed.report.grandMaxCE) === 'F') ? 'FAIL' : 'PASS';
        const resultTotal = ed.report.finalStatus || 'N/A';
        summaryRows += `<td colspan="4" class="text-center text-${resultTotal === 'PASS' ? 'success' : 'danger'}">TE: ${resultTE} | CE: ${resultCE} | <strong>Total: ${resultTotal}</strong></td>`;
    });
    summaryRows += `</tr>`;
    summaryRows += `<tr><th>Rank</th>`;
    examsData.forEach(ed => {
        summaryRows += `<td colspan="4" class="text-center">TE: ${ed.teRank || '-'} | CE: ${ed.ceRank || '-'} | <strong>Total: ${ed.totalRank || '-'}</strong></td>`;
    });
    summaryRows += `</tr>`;

    let remark = "Performance is consistent.";
    if (examsData.length > 1) {
        const first = examsData[0].report.grandPct || 0;
        const last = examsData[examsData.length - 1].report.grandPct || 0;
        if (last > first) remark = "Excellent! Performance has improved.";
        else if (last < first) remark = "Performance has declined. Needs more effort.";
    }

    // --- FINAL HTML ASSEMBLY ---
    return `
    <div id="report-card-printable" class="p-2 border bg-white mx-auto" style="max-width: 100%;">
        <div class="report-header text-center mb-4">
            ${schoolDetails.logoUrl ? `<img src="${schoolDetails.logoUrl}" style="max-height: 80px; margin-bottom: 0.5rem;margin-top: -1rem;">` : ''}
            <h4>${schoolDetails.address.toUpperCase() || 'School Name'}</h4>
            <p>${schoolDetails.name || ''}</p>
            <h4>Progress Report Comparison</h4>
        </div>
        <div class="row mb-4 align-items-center">
            <div class="col-8">
                <table class="table table-sm table-borderless">
                    <tbody>
                        <tr><th style="width: 150px;">Student Name</th><td>: ${student.name}</td></tr>
                        <tr><th>Admission No</th><td>: ${student.admissionNumber || 'N/A'}</td></tr>
                        <tr><th>Class</th><td>: ${studentClass?.name || 'N/A'} - ${student.division || 'N/A'}</td></tr>
                        <tr><th>Date of Birth</th><td>: ${new Date(student.dob).toLocaleDateString('en-GB') || 'N/A'}</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="col-4 text-center">
                <img src="${studentPhotoSrc}" alt="Student Photo" class="img-thumbnail rounded-3 shadow-sm" style="width: 130px; height: 170px; object-fit: cover; border: 2px solid #ddd;">
            </div>
        </div>
        <table class="table table-bordered table-sm">
            <thead class="table-light text-center">${headerRow1}${headerRow2}</thead>
            
            <tbody>${bodyRows}${grandTotalRow}${summaryRows}</tbody>
            
        </table>
        <div class="mt-2"><strong>Teacher's Remark:</strong> ${remark}</div>
        <div class="row mt-5 text-center text-muted" style="font-size: 0.9rem;">
            <div class="col-6"><hr class="mx-auto w-50">Class Teacher</div>
            <div class="col-6"><hr class="mx-auto w-50">Headmaster / Principal</div>
        </div>
    </div>`;
}


function generateReportCardHTML_Comparisonold(studentId, examIds) {
    const student = students.find(s => s.id === studentId);
    if (!student) {
        console.error("Could not generate report card: Student not found for ID", studentId);
        return '<p class="alert alert-danger">Student data not found.</p>';
    }

    const studentClass = classes.find(c => c.id === student?.classId);
    const gradingSystem = document.getElementById('shared-grading-system')?.value || 'type1';
    const studentPhotoSrc = student.photoDriveId
        ? `https://drive.google.com/thumbnail?id=${student.photoDriveId}&sz=400`
        : 'https://placehold.co/150x200?text=No+Photo&font=roboto';

    const examsData = examIds.map(eId => {
        const exam = exams.find(e => e.id === eId);
        if (!exam) return null;

        const schedules = examSchedules.filter(s => s.examId === eId && s.classId === student.classId && s.division === student.division);
        const processedData = processExamResultsData([student], schedules, marks, eId, gradingSystem);
        const report = processedData[0] || {};

        const allStudentsInClass = students.filter(s => s.classId === student.classId && s.division === student.division && s.status !== 'TC Issued' && s.status !== 'Graduated').sort((a, b) => a.name.localeCompare(b.name));
        const allProcessed = processExamResultsData(allStudentsInClass, schedules, marks, eId, gradingSystem);
        allProcessed.sort((a, b) => b.grandTotalMarks - a.grandTotalMarks);
        const rank = allProcessed.findIndex(s => s.studentId === student.id) + 1;
        return { exam, report, rank };
    }).filter(Boolean);

    const allSubjectIds = [...new Set(examsData.flatMap(e => e.report.subjectResults?.map(r => r.subjectId) || []))];

    let headerRow1 = `<tr><th rowspan="2">Subject</th>`;
    let headerRow2 = ``;
    examsData.forEach(ed => {
        headerRow1 += `<th colspan="4" class="text-center">${ed.exam.name}</th>`;
        headerRow2 += `<th>TE/MaxTE</th><th>CE/MaxCE</th><th>Total/Max</th><th>Grade</th>`;
    });
    headerRow1 += `</tr>`;
    headerRow2 = `<tr>${headerRow2}</tr>`;

    let bodyRows = ``;
    allSubjectIds.forEach(subId => {
        const subjectName = subjects.find(s => s.id === subId)?.name || "N/A";
        let rowHtml = `<tr><td>${subjectName}</td>`;
        // This loop builds the main body of the marks table
examsData.forEach(ed => {
    const res = ed.report.subjectResults?.find(r => r.subjectId === subId);
    if (res) {
        const totalMax = res.maxTE + res.maxCE;

        // The grade for the total marks of the subject
        const totalGrade = gradingSystem === 'type1' 
            ? calculateGrade(res.total, totalMax) 
            : calculateGradeType2(res.total, totalMax);

        // --- MODIFICATION IS HERE ---
        // The individual grades for TE and CE are now included in brackets
        rowHtml += `
            <td class="text-center">${res.te}/${res.maxTE} (${res.teGrade})</td>
            <td class="text-center">${res.ce}/${res.maxCE} (${res.ceGrade})</td>
            <td class="text-center">${res.total}/${totalMax}</td>
            <td class="text-center">${totalGrade}</td>
        `;
    } else {
        // If no results, add empty cells
        rowHtml += `<td>-</td><td>-</td><td>-</td><td>-</td>`;
    }
});
        rowHtml += `</tr>`;
        bodyRows += rowHtml;
    });

    let summaryRow = `<tr><th>Overall %</th>`;
    examsData.forEach(ed => { summaryRow += `<td colspan="4" class="text-center">${ed.report.grandPct?.toFixed(2) || "0"}%</td>`; });
    summaryRow += `</tr>`;

    let gradeRow = `<tr><th>Overall Grade</th>`;
    examsData.forEach(ed => { gradeRow += `<td colspan="4" class="text-center">${ed.report.overallGrade || "-"}</td>`; });
    gradeRow += `</tr>`;

    let resultRow = `<tr><th>Result</th>`;
    examsData.forEach(ed => {
        const status = ed.report.finalStatus || 'N/A';
        resultRow += `<td colspan="4" class="text-center text-${status === 'PASS' ? 'success' : 'danger'}">${status}</td>`;
    });
    resultRow += `</tr>`;

    let rankRow = `<tr><th>Rank</th>`;
    examsData.forEach(ed => { rankRow += `<td colspan="4" class="text-center">${ed.rank}</td>`; });
    rankRow += `</tr>`;

    let remark = "Performance is consistent.";
    if (examsData.length > 1) {
        const first = examsData[0].report.grandPct || 0;
        const last = examsData[examsData.length - 1].report.grandPct || 0;
        if (last > first) remark = "Excellent! Performance has improved.";
        else if (last < first) remark = "Performance has declined. Needs more effort.";
    }

    return `
    <div id="report-card-printable" class="p-2 border bg-white mx-auto" style="max-width: 100%;">
        <div class="report-header text-center mb-4">
            ${schoolDetails.logoUrl ? `<img src="${schoolDetails.logoUrl}" style="max-height: 80px; margin-bottom: 0.5rem;margin-top: -1rem;">` : ''}
            <h4>${schoolDetails.address.toUpperCase() || 'School Name'}</h4>
            <p>${schoolDetails.name || ''}</p>
            <h4>Progress Report Comparison</h4>
        </div>
        <div class="row mb-4 align-items-center">
            <div class="col-8">
                <table class="table table-sm table-borderless">
                    <tbody>
                        <tr><th style="width: 150px;">Student Name</th><td>: ${student.name}</td></tr>
                        <tr><th>Admission No</th><td>: ${student.admissionNumber || 'N/A'}</td></tr>
                        <tr><th>Class</th><td>: ${studentClass?.name || 'N/A'} - ${student.division || 'N/A'}</td></tr>
                        <tr><th>Date of Birth</th><td>: ${new Date(student.dob).toLocaleDateString('en-GB') || 'N/A'}</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="col-4 text-center">
                <img src="${studentPhotoSrc}" alt="Student Photo" class="img-thumbnail rounded-3 shadow-sm" style="width: 130px; height: 170px; object-fit: cover; border: 2px solid #ddd;">
            </div>
        </div>
        <table class="table table-bordered table-sm">
            <thead class="table-light text-center">${headerRow1}${headerRow2}</thead>
            <tbody>${bodyRows}${summaryRow}${gradeRow}${resultRow}${rankRow}</tbody>
        </table>
        <div class="mt-2"><strong>Teacher's Remark:</strong> ${remark}</div>
        <div class="row mt-5 text-center text-muted" style="font-size: 0.9rem;">
            <div class="col-6"><hr class="mx-auto w-50">Class Teacher</div>
            <div class="col-6"><hr class="mx-auto w-50">Headmaster / Principal</div>
        </div>
    </div>`;
}

        function calculateGrade(score, maxScore) {
            if (score === 'AB') return 'AB';
            if (maxScore === 0) return '-';
            const percentage = (score / maxScore) * 100;
            if (percentage >= 90) return 'A+'; if (percentage >= 80) return 'A';
            if (percentage >= 70) return 'B+'; if (percentage >= 60) return 'B';
            if (percentage >= 50) return 'C+'; if (percentage >= 40) return 'C';
            if (percentage >= 30) return 'D';
            return 'E';
        }


        // --- ATTENDANCE MANAGEMENT ---
        window.renderAttendanceManagement = () => {
             mainContent.innerHTML = `<h1 class="h2 mb-4">Attendance Management</h1>
             <ul class="nav nav-tabs" id="attendanceTab" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#take-att" type="button">Take Attendance</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#class-report-att" type="button">Class Report</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#student-report-att" type="button">Student Report</button></li>
             </ul>
             <div class="tab-content card" id="attendanceTabContent">
                <div class="tab-pane fade show active p-4" id="take-att"></div>
                <div class="tab-pane fade p-4" id="class-report-att"></div>
                <div class="tab-pane fade p-4" id="student-report-att"></div>
             </div>`;
             renderTakeAttendanceTab();
             renderClassAttendanceReportTab();
             renderStudentAttendanceReportTab();
        };

        function renderTakeAttendanceTab(){
            const container = document.getElementById('take-att');
            let classOptions = '';
            if (currentUserRole === 'teacher' && selectedUser.classCharge) {
                const c = classes.find(cls => cls.id === selectedUser.classCharge.classId);
                if(c) classOptions = `<option value="${c.id}">${c.name}</option>`;
            } else {
                classOptions = classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
            }
            container.innerHTML = `<div class="row g-3 align-items-end border-bottom pb-3 mb-3">
                <div class="col-md-4"><label>Date</label><input type="date" id="att-date" value="${new Date().toISOString().slice(0,10)}" class="form-control"></div>
                <div class="col-md-4"><label>Class</label><select id="att-class" class="form-select">${classOptions}</select></div>
                <div class="col-md-4"><label>Division</label><select id="att-division" class="form-select"></select></div>
            </div>
            <div id="attendance-sheet"></div>`;
            const classSelect = document.getElementById('att-class'), divisionSelect = document.getElementById('att-division'), dateInput = document.getElementById('att-date');
            
            const loadSheet = () => {
                loadAttendanceSheet(dateInput.value, classSelect.value, divisionSelect.value);
            };

            classSelect.addEventListener('change', () => {
                const cls = classes.find(c => c.id === classSelect.value);
                divisionSelect.innerHTML = cls ? cls.divisions.map(d => `<option value="${d}">${d}</option>`).join('') : '';
                if(currentUserRole === 'teacher' && selectedUser.classCharge) { divisionSelect.value = selectedUser.classCharge.division; }
                loadSheet();
            });
            divisionSelect.addEventListener('change', loadSheet);
            dateInput.addEventListener('change', loadSheet);
            if(classes.length > 0) classSelect.dispatchEvent(new Event('change'));
        }
        // --- In your <script type="module"> block ---
// REPLACE your loadAttendanceSheet function with this new one

async function loadAttendanceSheet(date, classId, division) {
    const container = document.getElementById('attendance-sheet');
    if (!date || !classId || !division) {
        container.innerHTML = `<p class="text-center p-5 text-muted">Please select date, class, and division.</p>`;
        return;
    }

    const holiday = holidays.find(h => h.id === date);
    if (holiday) {
        container.innerHTML = `<div class="alert alert-info text-center">This day is a holiday: <strong>${holiday.narration}</strong>.</div>`;
        return;
    }

    const studentsInClass = students.filter(s => s.classId === classId && s.division === division && s.status !== 'TC Issued').sort((a, b) => a.name.localeCompare(b.name));
       if (studentsInClass.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">No students found.</div>';
        return;
    }

    const attendanceYearMonth = date.slice(0, 7);
    const day = parseInt(date.slice(8, 10)).toString();
    const classKey = `${classId}-${division}`;

    const attendanceDoc = await getDoc(getDocRef('attendance', attendanceYearMonth));
    
    // Get the exceptions for this specific class on this day, or an empty object if none exist
    const todaysExceptions = attendanceDoc.data()?.[day]?.[classKey]?.exceptions || {};

    let tableHTML = `<div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">${studentsInClass.length} Students</h6>
        <div>
            <button id="invert-selection" class="btn btn-sm btn-outline-secondary me-2">Invert Selection</button>
            <button id="mark-all-present" class="btn btn-sm btn-outline-success">Mark All Present</button>
        </div>
    </div>
    <div class="table-responsive"><table class="table table-bordered">
    <thead class="table-light"><tr><th>Name</th><th>Admission No.</th><th class="text-center">Forenoon (FN)</th><th class="text-center">Afternoon (AN)</th></tr></thead><tbody>`;
    

    studentsInClass.forEach(s => {
        // --- NEW LOGIC TO READ EXCEPTIONS ---
        const studentException = todaysExceptions[s.id];

        // Default to present, then override if an exception exists
        const isPresentFN = studentException ? studentException.FN : true;
        const isPresentAN = studentException ? studentException.AN : true;

        tableHTML += `<tr>
            <td class="fw-bold">${s.name}</td>
            <td>${s.admissionNumber}</td>
            <td class="text-center"><input type="checkbox" data-id="${s.id}" data-session="FN" class="form-check-input att-check" ${isPresentFN ? 'checked' : ''}></td>
            <td class="text-center"><input type="checkbox" data-id="${s.id}" data-session="AN" class="form-check-input att-check" ${isPresentAN ? 'checked' : ''}></td>
        </tr>`;
    });

    tableHTML += `</tbody></table></div><div class="text-end mt-3"><button id="save-att-btn" class="btn btn-primary">Save Attendance</button></div>`;
    container.innerHTML = tableHTML;
    
    // Attach listeners (your existing code for this is correct)
    document.getElementById('mark-all-present').addEventListener('click', () => document.querySelectorAll('.att-check').forEach(c => c.checked = true));
    document.getElementById('invert-selection').addEventListener('click', () => document.querySelectorAll('.att-check').forEach(c => c.checked = !c.checked));
    document.getElementById('save-att-btn').addEventListener('click', () => saveAttendance(date, classId, division));
}

        async function loadAttendanceSheetold(date, classId, division){
            const container = document.getElementById('attendance-sheet');
            if(!date || !classId || !division) { container.innerHTML = `<p class="text-center p-5 text-muted">Please select date, class, and division.</p>`; return; }
            
            // Check for holiday
            const holiday = holidays.find(h => h.id === date);
            if(holiday){
                container.innerHTML = `<div class="alert alert-info text-center">This day is declared as a holiday: <strong>${holiday.narration}</strong>. Attendance cannot be marked.</div>`;
                return;
            }

            const studentsInClass = students.filter(s => s.classId === classId && s.division === division && s.status !== 'TC Issued').sort((a, b) => a.name.localeCompare(b.name));
       if(studentsInClass.length === 0){ container.innerHTML = '<div class="alert alert-warning">No students found.</div>'; return; }
            const attendanceYearMonth = date.slice(0, 7);
            const day = parseInt(date.slice(8, 10)).toString();
            const attendanceDoc = await getDoc(getDocRef('attendance', attendanceYearMonth));
            const todaysAttendance = attendanceDoc.data()?.[day] || {};
            
           let tableHTML = `<div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">${studentsInClass.length} Students</h6>
        <div>
            <button id="invert-selection" class="btn btn-sm btn-outline-secondary me-2">Invert Selection</button>
            <button id="mark-all-present" class="btn btn-sm btn-outline-success">Mark All Present</button>
        </div>
    </div>
    <div class="table-responsive"><table class="table table-bordered">
    <thead class="table-light"><tr><th>Name</th><th>Admission No.</th><th class="text-center">Forenoon (FN)</th><th class="text-center">Afternoon (AN)</th></tr></thead><tbody>`;
    studentsInClass.forEach(s => {
                const studentAtt = todaysAttendance[s.id] || {FN: true, AN: true};
                tableHTML += `<tr><td class="fw-bold">${s.name}</td><td>${s.admissionNumber}</td>
                <td class="text-center"><input type="checkbox" data-id="${s.id}" data-session="FN" class="form-check-input att-check" ${studentAtt.FN ? 'checked' : ''}></td>
                <td class="text-center"><input type="checkbox" data-id="${s.id}" data-session="AN" class="form-check-input att-check" ${studentAtt.AN ? 'checked' : ''}></td></tr>`;
            });
            tableHTML += `</tbody></table></div><div class="text-end mt-3"><button id="save-att-btn" class="btn btn-primary">Save Attendance</button></div>`;
            container.innerHTML = tableHTML;
            document.getElementById('mark-all-present').addEventListener('click', () => document.querySelectorAll('.att-check').forEach(c => c.checked = true));
            document.getElementById('invert-selection').addEventListener('click', () => document.querySelectorAll('.att-check').forEach(c => c.checked = !c.checked));
            document.getElementById('save-att-btn').addEventListener('click', () => saveAttendance(date));
        }

        async function saveAttendanceold(date) {
            const attendanceYearMonth = date.slice(0, 7);
            const day = parseInt(date.slice(8, 10)).toString();
            const records = {};
            document.querySelectorAll('.att-check').forEach(c => {
                const id = c.dataset.id;
                if (!records[id]) records[id] = {};
                records[id][c.dataset.session] = c.checked;
            });
            try {
                await setDoc(getDocRef('attendance', attendanceYearMonth), { [day]: records }, { merge: true });
                showAlert('Attendance saved successfully!', 'success');
            } catch (error) { console.error("Error saving attendance: ", error); showAlert("Could not save attendance.", "danger");}
        }
       // --- In your <script type="module"> block ---

async function saveAttendance(date, classId, division) {
    const attendanceYearMonth = date.slice(0, 7);
    const day = parseInt(date.slice(8, 10)).toString();
    const classKey = `${classId}-${division}`;

    const exceptions = {};
    const allCheckboxes = document.querySelectorAll('.att-check');
    
    const studentChecks = {};
    allCheckboxes.forEach(cb => {
        const id = cb.dataset.id;
        if (!studentChecks[id]) studentChecks[id] = {};
        studentChecks[id][cb.dataset.session] = cb.checked;
    });

    for (const studentId in studentChecks) {
        const sessions = studentChecks[studentId];
        if (!sessions.FN || !sessions.AN) {
            exceptions[studentId] = {
                FN: sessions.FN || false,
                AN: sessions.AN || false
            };
        }
    }

    const attendanceDataForClass = {
        status: 'SUBMITTED',
        exceptions: exceptions
    };

    try {
        const docRef = getDocRef('attendance', attendanceYearMonth);

        // --- ðŸ‘‡ THIS IS THE CORRECTED LOGIC ðŸ‘‡ ---
        // Instead of creating a flat path, we create a nested object.
        const dataToSave = {
            [day]: { // The day is the top-level key
                [classKey]: attendanceDataForClass // The class is nested inside the day
            }
        };

        // setDoc with merge:true will correctly create or update this nested structure.
        await setDoc(docRef, dataToSave, { merge: true });

        showAlert('Attendance saved successfully!', 'success');
    } catch (error) {
        console.error("Error saving attendance: ", error);
        showAlert("Could not save attendance.", "danger");
    }
}

        function renderClassAttendanceReportTab(){ 
            const container = document.getElementById('class-report-att');
            container.innerHTML = `<div class="row g-3 align-items-end border-bottom pb-3 mb-3">
                    <div class="col-md-4"><label class="form-label">Month</label><input type="month" id="report-month" value="${new Date().toISOString().slice(0,7)}" class="form-control"></div>
                    <div class="col-md-4"><label class="form-label">Class</label><select id="report-class" class="form-select">${classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                    <div class="col-md-4"><label class="form-label">Division</label><select id="report-division" class="form-select"></select></div>
                </div>
                <div id="class-report-container" class="table-responsive"></div>`;
            
            const monthSelect = document.getElementById('report-month'), classSelect = document.getElementById('report-class'), divisionSelect = document.getElementById('report-division');
            
            const generateReport = () => generateClassAttendanceReport(monthSelect.value, classSelect.value, divisionSelect.value);
            
            classSelect.addEventListener('change', () => {
                const cls = classes.find(c => c.id === classSelect.value);
                divisionSelect.innerHTML = cls ? cls.divisions.map(d=>`<option>${d}</option>`).join('') : '';
                generateReport();
            });
            monthSelect.addEventListener('change', generateReport);
            divisionSelect.addEventListener('change', generateReport);
            if(classes.length > 0) classSelect.dispatchEvent(new Event('change'));
        }
        // --- In your <script type="module"> block ---

async function generateClassAttendanceReport(monthYear, classId, division) {
    const container = document.getElementById('class-report-container');
    if (!monthYear || !classId || !division) {
        container.innerHTML = '<p class="text-muted p-5 text-center">Please select all filters.</p>';
        return;
    }

    const studentsInClass = students.filter(s => s.classId === classId && s.division === division && s.status !== 'TC Issued').sort((a, b) => a.name.localeCompare(b.name));
       if (studentsInClass.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">No students found.</div>';
        return;
    }

    const monthDataDoc = await getDoc(getDocRef('attendance', monthYear));
    const monthData = monthDataDoc.data() || {};
    const classKey = `${classId}-${division}`;

    // --- NEW: Calculate Total Working Days correctly ---
    // A working day is a day where attendance status was "SUBMITTED" for this class.
    let totalWorkingDays = 0;
    const daysInMonth = new Date(monthYear.split('-')[0], monthYear.split('-')[1], 0).getDate();
    for (let i = 1; i <= daysInMonth; i++) {
        const dayStr = i.toString();
        if (monthData[dayStr]?.[classKey]?.status === 'SUBMITTED') {
            totalWorkingDays++;
        }
    }

    let gridTable = `<h5 class="mt-4">Monthly Grid</h5><table class="table table-bordered table-sm text-center" style="font-size: 0.75rem;"><thead class="table-light"><tr><th class="text-start">Student Name</th>`;
    for (let i = 1; i <= daysInMonth; i++) { gridTable += `<th>${i}</th>`; }
    gridTable += `</tr></thead><tbody>`;

    const summaryData = [];

    studentsInClass.forEach(student => {
        let present = 0, absentSessions = 0; // We'll count absent sessions (FN/AN)
        gridTable += `<tr><td class="fw-bold text-start">${student.name}</td>`;
        
        for (let i = 1; i <= daysInMonth; i++) {
            const dayStr = i.toString();
            const dateStr = `${monthYear}-${dayStr.padStart(2, '0')}`;
            const holiday = holidays.find(h => h.id === dateStr);
            let status;
            
            if (holiday) {
                status = { symbol: 'H', class: 'att-holiday', title: holiday.narration };
            } else {
                const dayClassData = monthData[dayStr]?.[classKey];
                
                // --- NEW: Logic to read exceptions ---
                if (dayClassData?.status === 'SUBMITTED') {
                    const studentException = dayClassData.exceptions?.[student.id];
                    // If no exception, student is present. Otherwise, use the exception data.
                    const record = studentException || { FN: true, AN: true };
                    status = calculateAttendanceStatus(record);

                    // Update stats
                    if (record.FN) present++;
                    if (record.AN) present++;
                    if (!record.FN) absentSessions++;
                    if (!record.AN) absentSessions++;
                } else {
                    status = { symbol: '', class: '' }; // Not a working day for this class
                }
            }
            gridTable += `<td class="${status.class}" title="${status.title || ''}">${status.symbol}</td>`;
        }
        gridTable += `</tr>`;
        summaryData.push({ name: student.name, presentSessions: present, absentSessions });
    });
    gridTable += '</tbody></table>';

    let summaryTable = `<h5 class="mt-4">Summary Report (Total Working Days: ${totalWorkingDays})</h5><table class="table table-striped table-bordered">
        <thead class="table-light"><tr><th>Student Name</th><th>Present Days</th><th>Absent Days</th><th>Total Present %</th></tr></thead><tbody>`;
    summaryData.forEach(data => {
        const totalPresentDays = data.presentSessions ;
        const totalAbsentDays = data.absentSessions;
        const percentage = totalWorkingDays > 0 ? ((totalPresentDays / totalWorkingDays) * 100).toFixed(1) : "0.0";
        summaryTable += `<tr><td>${data.name}</td><td>${totalPresentDays}</td><td>${totalAbsentDays}</td><td>${percentage}%</td></tr>`;
    });
    summaryTable += '</tbody></table>';

    container.innerHTML = summaryTable + gridTable;
}
        async function generateClassAttendanceReportold(monthYear, classId, division){
            const container = document.getElementById('class-report-container');
            if(!monthYear || !classId || !division){ container.innerHTML = '<p class="text-muted p-5 text-center">Please select all filters.</p>'; return; }

            const studentsInClass = students.filter(s => s.classId === classId && s.division === division && s.status !== 'TC Issued').sort((a, b) => a.name.localeCompare(b.name));
       if(studentsInClass.length === 0){ container.innerHTML = '<div class="alert alert-warning">No students found.</div>'; return; }
            
            const monthDataDoc = await getDoc(getDocRef('attendance', monthYear));
            const monthData = monthDataDoc.data() || {};
            const workingDays = Object.keys(monthData).filter(key => !isNaN(parseInt(key)));
            const totalWorkingDays = workingDays.length;
            const daysInMonth = new Date(monthYear.split('-')[0], monthYear.split('-')[1], 0).getDate();
            
            let gridTable = `<h5 class="mt-4">Monthly Grid</h5><table class="table table-bordered table-sm text-center" style="font-size: 0.75rem;"><thead class="table-light"><tr><th class="text-start">Student Name</th>`;
            for(let i=1; i<=daysInMonth; i++){ gridTable += `<th>${i}</th>`; }
            gridTable += `</tr></thead><tbody>`;

            let summaryData = [];

            studentsInClass.forEach(student => {
                let present = 0, absent = 0, half = 0;
                gridTable += `<tr><td class="fw-bold text-start">${student.name}</td>`;
                for(let i=1; i<=daysInMonth; i++){
                    const dayStr = i.toString();
                    const dateStr = `${monthYear}-${dayStr.padStart(2,'0')}`;
                    const holiday = holidays.find(h => h.id === dateStr);
                    let status;
                    if(holiday){
                        status = { symbol: 'H', class: 'att-holiday' };
                    } else {
                         const dayData = monthData[dayStr];
                        const studentRecord = dayData ? dayData[student.id] : null;
                        status = calculateAttendanceStatus(studentRecord);
                        if(workingDays.includes(dayStr)){
                            if(status.symbol === 'P') present++;
                            else if(status.symbol === 'AB') absent++;
                            else if(status.symbol === '/' || status.symbol === '\\') half++;
                        }
                    }
                    gridTable += `<td class="${status.class}" title="${holiday ? holiday.narration : ''}">${status.symbol}</td>`;
                }
                gridTable += `</tr>`;
                summaryData.push({name: student.name, present, absent, half});
            });
            gridTable += '</tbody></table>';

            let summaryTable = `<h5 class="mt-4">Summary Report (Total Working Days: ${totalWorkingDays})</h5><table class="table table-striped table-bordered">
                <thead class="table-light"><tr><th>Student Name</th><th>Present</th><th>Half-days</th><th>Absent</th><th>Total Present</th></tr></thead><tbody>`;
            summaryData.forEach(data => {
                const totalPresent = data.present + (data.half * 0.5);
                summaryTable += `<tr><td>${data.name}</td><td>${data.present}</td><td>${data.half}</td><td>${totalWorkingDays - totalPresent}</td><td>${totalPresent}</td></tr>`;
            });
            summaryTable += '</tbody></table>';

            container.innerHTML = summaryTable + gridTable;
        }

        function calculateAttendanceStatus(record) {
            if (!record) return { symbol: '', class: '' }; // Not a working day
            if (record.FN && record.AN) return { symbol: 'P', class: 'att-present' };
            if (record.FN && !record.AN) return { symbol: '/', class: 'att-half' };
            if (!record.FN && record.AN) return { symbol: '\\', class: 'att-half' };
            return { symbol: 'AB', class: 'att-absent' };
        }

        function renderStudentAttendanceReportTab(){
            const container = document.getElementById('student-report-att');
             container.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-6"><label class="form-label">Search Student (Name or Admn No.)</label><input type="text" id="stu-att-search" class="form-control" placeholder="Start typing..."><div id="stu-att-suggestions" class="position-relative"></div></div>
                    <div class="col-md-4"><label class="form-label">Month</label><input type="month" id="stu-att-month" value="${new Date().toISOString().slice(0,7)}" class="form-control"></div>
                </div><hr>
                <div id="student-calendar-container"></div>`;
            const searchInput = container.querySelector('#stu-att-search'), suggestionsBox = container.querySelector('#stu-att-suggestions'), monthSelect = container.querySelector('#stu-att-month');
            let selectedStudentId = null;

            const generateCalendar = () => {
                if(selectedStudentId && monthSelect.value) {
                    generateStudentCalendar(selectedStudentId, monthSelect.value, 'student-calendar-container');
                }
            };
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toUpperCase(); suggestionsBox.innerHTML = '';
                if (query.length < 2) return;
                const matchingStudents = students.filter(s => s.name.toUpperCase().includes(query) || String(s.admissionNumber||"").toUpperCase().includes(query)).slice(0, 5);
                suggestionsBox.innerHTML = `<div class="list-group position-absolute w-100" style="z-index:1000">${matchingStudents.map(s => `<a href="#" class="list-group-item list-group-item-action" data-id="${s.id}" data-name="${s.name} (${s.admissionNumber})">${s.name} - ${s.admissionNumber}</a>`).join('')}</div>`;
            });
            document.addEventListener('click', (e) => { if (!suggestionsBox.contains(e.target)) suggestionsBox.innerHTML = ''; });
            suggestionsBox.addEventListener('click', (e) => {
                if (e.target.matches('[data-id]')) {
                    e.preventDefault(); selectedStudentId = e.target.dataset.id; searchInput.value = e.target.dataset.name;
                    suggestionsBox.innerHTML = ''; generateCalendar();
                }
            });
            monthSelect.addEventListener('change', generateCalendar);
        }
        // --- In your <script type="module"> block ---

// In your <script type="module"> block

async function generateStudentCalendar(studentId, monthYear, containerId, isDashboard = false) {
    const container = document.getElementById(containerId);
    if (!studentId || !monthYear) {
        container.innerHTML = `<p class="text-muted p-5 text-center">Select student and month to view calendar.</p>`;
        return;
    }

    const student = students.find(s => s.id === studentId);
    if (!student) return;

    // --- ðŸ‘‡ CHANGE 1: Call getData with a simple string ID ---
    // The upgraded getData function is designed to handle this correctly.
    const monthData = await getData('attendance', monthYear) || {};
    
    const [year, month] = monthYear.split('-').map(Number);
    const classKey = `${student.classId}-${student.division}`;

    let stats = { present: 0, absent: 0, halfDay: 0, workingDays: 0 };
    
    // --- CHANGE 2: Loop correctly, skipping the 'id' property ---
    for (const day in monthData) {
        // This check prevents trying to process the 'id' field as a day of the month.
        if (isNaN(parseInt(day))) continue;

        const classData = monthData[day]?.[classKey];
        if (classData?.status === 'SUBMITTED') {
            stats.workingDays++;
            const studentException = classData.exceptions?.[studentId];
            const record = studentException || { FN: true, AN: true };

            if (record.FN && record.AN) stats.present++;
            else if (record.FN || record.AN) stats.halfDay++;
            else stats.absent++;
        }
    }

    // (The rest of your calendarHTML generation is correct)
    let calendarHTML = `
        <div class="p-2 border rounded-3 ${isDashboard ? '' : 'p-4'}">
            <div class="${isDashboard ? 'd-none' : 'd-md-flex justify-content-between align-items-md-center mb-4'}">
                <div>
                    <h5 class="fw-bold">${student.name}</h5>
                    <p class="text-muted mb-0">Attendance Report for ${new Date(year, month-1).toLocaleString('default', { month: 'long', year: 'numeric' })}</p>
                </div>
                <div class="d-flex flex-wrap gap-3 mt-2 mt-md-0 small">
                    <span class="d-flex align-items-center"><span class="d-inline-block rounded-circle me-2" style="width:12px; height:12px; background-color: #d1e7dd;"></span>Present: <strong>${stats.present}</strong></span>
                    <span class="d-flex align-items-center"><span class="d-inline-block rounded-circle me-2" style="width:12px; height:12px; background-color: #fff3cd;"></span>Half-day: <strong>${stats.halfDay}</strong></span>
                    <span class="d-flex align-items-center"><span class="d-inline-block rounded-circle me-2" style="width:12px; height:12px; background-color: #f8d7da;"></span>Absent: <strong>${stats.absent}</strong></span>
                    <span class="d-flex align-items-center"><span class="d-inline-block rounded-circle me-2" style="width:12px; height:12px; background-color: #e2e3e5;"></span>Holiday</span>
                </div>
            </div>

            <div class="calendar-grid text-center small fw-bold text-muted">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div class="calendar-grid text-center mt-1">`;
            const firstDayOfMonth = new Date(year, month - 1, 1).getDay();
            const daysInMonth = new Date(year, month, 0).getDate();

    for (let i = 0; i < firstDayOfMonth; i++) { calendarHTML += `<div></div>`; }

    for (let day = 1; day <= daysInMonth; day++) {
        const dayStr = day.toString();
        const dateStr = `${monthYear}-${dayStr.padStart(2, '0')}`;
        const holiday = holidays.find(h => h.id === dateStr);
        let status;
        
        if (holiday) {
            status = { symbol: 'H', class: 'att-holiday', title: holiday.narration };
        } else {
            const dayClassData = monthData[dayStr]?.[classKey];
            
            if (dayClassData?.status === 'SUBMITTED') {
                const studentException = dayClassData.exceptions?.[studentId];
                const record = studentException || { FN: true, AN: true };
                status = calculateAttendanceStatus(record);
            } else {
                status = { symbol: '', class: '' }; // Not a working day
            }
        }
        
        calendarHTML += `<div class="border rounded p-2 d-flex flex-column justify-content-between ${status.class || 'bg-light'}" style="min-height: 50px;" title="${status.title || ''}">
            <strong class="align-self-start small">${day}</strong>
            <span class="fs-5 fw-bold">${status.symbol || ''}</span>
        </div>`;
    }
    calendarHTML += `</div></div>`;
    container.innerHTML = calendarHTML;
}

        async function generateStudentCalendarold(studentId, monthYear, containerId, isDashboard = false){
            const container = document.getElementById(containerId);
            if(!studentId || !monthYear){ 
                container.innerHTML = `<p class="text-muted p-5 text-center">Select student and month to view calendar.</p>`;
                return;
            }
            
            const student = students.find(s => s.id === studentId);
            // const monthDataDoc = await getDoc(getDocRef('attendance', monthYear));
            // const monthData = monthDataDoc.data() || {};
            const monthData = await getData('attendance', monthYear);
            const [year, month] = monthYear.split('-').map(Number);
            const firstDayOfMonth = new Date(year, month - 1, 1).getDay();
            const daysInMonth = new Date(year, month, 0).getDate();
            
            let stats = { present: 0, absent: 0, halfDay: 0 };
            const workingDays = Object.keys(monthData).filter(key => !isNaN(parseInt(key)));
            workingDays.forEach(day => {
                const studentRecord = monthData[day]?.[studentId];
                if (studentRecord) {
                    if (studentRecord.FN && studentRecord.AN) { stats.present++; }
                    else if (studentRecord.FN || studentRecord.AN) { stats.halfDay++; }
                    else { stats.absent++; }
                } else {
                    stats.absent++;
                }
            });

            let calendarHTML = `
            <div class="p-2 border rounded-3 ${isDashboard ? '' : 'p-4'}">
                <div class="${isDashboard ? 'd-none' : 'd-md-flex justify-content-between align-items-md-center mb-4'}">
                    <div>
                        <h5 class="fw-bold">${student.name}</h5>
                        <p class="text-muted mb-0">Attendance Report for ${new Date(year, month-1).toLocaleString('default', { month: 'long', year: 'numeric' })}</p>
                    </div>
                    <div class="d-flex flex-wrap gap-3 mt-2 mt-md-0 small">
                        <span class="d-flex align-items-center"><span class="d-inline-block rounded-circle me-2" style="width:12px; height:12px; background-color: #d1e7dd;"></span>Present: <strong>${stats.present}</strong></span>
                        <span class="d-flex align-items-center"><span class="d-inline-block rounded-circle me-2" style="width:12px; height:12px; background-color: #fff3cd;"></span>Half-day: <strong>${stats.halfDay}</strong></span>
                        <span class="d-flex align-items-center"><span class="d-inline-block rounded-circle me-2" style="width:12px; height:12px; background-color: #f8d7da;"></span>Absent: <strong>${stats.absent}</strong></span>
                        <span class="d-flex align-items-center"><span class="d-inline-block rounded-circle me-2" style="width:12px; height:12px; background-color: #e2e3e5;"></span>Holiday</span>
                    </div>
                </div>

                <div class="calendar-grid text-center small fw-bold text-muted">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div class="calendar-grid text-center mt-1">`;
            
            for (let i = 0; i < firstDayOfMonth; i++) { calendarHTML += `<div></div>`; }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${monthYear}-${day.toString().padStart(2,'0')}`;
                const holiday = holidays.find(h => h.id === dateStr);
                let status;
                if(holiday){
                     status = { symbol: 'H', class: 'att-holiday', title: holiday.narration };
                } else {
                    const dayRecord = monthData[day.toString()] ? monthData[day.toString()][studentId] : null;
                    status = calculateAttendanceStatus(dayRecord);
                }
                
                calendarHTML += `<div class="border rounded p-2 d-flex flex-column justify-content-between ${status.class || 'bg-light'}" style="min-height: 50px;" title="${status.title || ''}">
                    <strong class="align-self-start small">${day}</strong>
                    <span class="fs-5 fw-bold">${status.symbol || ''}</span>
                </div>`;
            }
            calendarHTML += '</div></div>';
            container.innerHTML = calendarHTML;
        }

        // --- HOLIDAY MANAGEMENT ---
        window.renderHolidayManagement = () => {
             mainContent.innerHTML = `<h1 class="h2 mb-4">Holiday Management</h1><div class="row"><div class="col-lg-5"><div class="card shadow mb-4"><div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">Declare Holiday</h6></div><div class="card-body"><form id="holiday-form"><div class="mb-3"><label class="form-label">Date</label><input type="date" id="holiday-date" class="form-control" required></div><div class="mb-3"><label class="form-label">Narration / Reason</label><input type="text" id="holiday-narration" class="form-control" placeholder="E.g., Diwali" required></div><div class="d-flex justify-content-end"><button type="submit" class="btn btn-primary">Save Holiday</button></div></form></div></div></div><div class="col-lg-7"><div class="card shadow mb-4"><div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">Declared Holidays</h6></div><div class="card-body" id="holidays-list-container"></div></div></div></div>`;
            renderHolidaysList();
            document.getElementById('holiday-form').addEventListener('submit', async e => {
                e.preventDefault();
                const date = document.getElementById('holiday-date').value;
                const narration = document.getElementById('holiday-narration').value;
                if(date && narration){
                    await setDoc(getDocRef('holidays', date), {narration});
                    showAlert('Holiday saved successfully', 'success');
                    e.target.reset();
                } else {
                    showAlert('Please provide both date and narration.', 'danger');
                }
            });
        };

        function renderHolidaysList() {
            const container = document.getElementById('holidays-list-container');
            if(!container) return;
            const sortedHolidays = [...holidays].sort((a,b) => a.id.localeCompare(b.id));
            if(sortedHolidays.length === 0){
                container.innerHTML = '<p class="text-muted">No holidays declared yet.</p>';
                return;
            }
            container.innerHTML = `<ul class="list-group list-group-flush">${sortedHolidays.map(h => `<li class="list-group-item d-flex justify-content-between align-items-center">${new Date(h.id).toLocaleDateString('en-GB', {year: 'numeric', month: 'long', day: 'numeric'})} <span class="badge bg-info">${h.narration}</span><button class="btn btn-sm btn-outline-danger" onclick="window.handleDelete('holidays', '${h.id}')"><i class="fas fa-times"></i></button></li>`).join('')}</ul>`;
        }

        // --- STUDENT PORTAL ---
        window.renderMyResults = () => {
            mainContent.innerHTML = `<h1 class="h2 mb-4">My Results</h1><div class="card shadow"><div class="card-body">
                <div class="row mb-3 align-items-end"><div class="col-md-6"><label class="form-label">Select Exam</label><select id="my-res-exam" class="form-select">${exams.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}</select></div></div>
                <div id="my-results-container"></div>
            </div></div>`;
            const examSelect = document.getElementById('my-res-exam');
            const showMyReport = () => {
                if(selectedUser && examSelect.value) {
                    generateReportCardHTML(selectedUser.id, examSelect.value, 'my-results-container');
                }
            }
            examSelect.addEventListener('change', showMyReport);
            if(exams.length > 0) showMyReport();
        };

        window.renderMyAttendance = () => {
            const currentYear = new Date().getFullYear();
            const yearOptions = Array.from({length: 5}, (_, i) => `<option value="${currentYear - i}">${currentYear - i}</option>`).join('');
            const monthOptions = Array.from({length: 12}, (_, i) => `<option value="${i+1}">${new Date(0, i).toLocaleString('default', { month: 'long' })}</option>`).join('');

            mainContent.innerHTML = `<h1 class="h2 mb-4">My Attendance</h1><div class="card shadow"><div class="card-body">
                <div class="row g-3 align-items-end mb-4">
                    <div class="col-md-4"><label class="form-label">Year</label><select id="my-att-year" class="form-select">${yearOptions}</select></div>
                    <div class="col-md-4"><label class="form-label">Month</label><select id="my-att-month" class="form-select">${monthOptions}</select></div>
                </div>
                <div id="my-attendance-container"></div>
            </div></div>`;

            const yearSelect = document.getElementById('my-att-year');
            const monthSelect = document.getElementById('my-att-month');
            monthSelect.value = new Date().getMonth() + 1; // Default to current month

            const showMyCalendar = () => {
                const monthYear = `${yearSelect.value}-${monthSelect.value.padStart(2, '0')}`;
                generateStudentCalendar(selectedUser.id, monthYear, 'my-attendance-container');
            }
            yearSelect.addEventListener('change', showMyCalendar);
            monthSelect.addEventListener('change', showMyCalendar);
            showMyCalendar();
        };

// =================================================================================
// Main Function: Renders the entire Syllabus Tracker UI
// No changes here.
// =================================================================================
window.renderSyllabusTracker = () => {
    mainContent.innerHTML = `<h1 class="h2 mb-4">Syllabus Tracker</h1>
    <ul class="nav nav-tabs" id="syllabusTab" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#add-chapters" type="button">Add Chapters</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#create-syllabus" type="button">Create Syllabus</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#mark-completion" type="button">Mark Completion</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#syllabus-report" type="button">Report</button></li>
    </ul>
    <div class="tab-content card" id="syllabusTabContent">
        <div class="tab-pane fade show active p-4" id="add-chapters"></div>
        <div class="tab-pane fade p-4" id="create-syllabus"></div>
        <div class="tab-pane fade p-4" id="mark-completion"></div>
        <div class="tab-pane fade p-4" id="syllabus-report"></div>
    </div>`;

    if (!document.getElementById('completionModal')) {
        const modal = document.createElement('div');
        modal.innerHTML = `
        <div class="modal fade" id="completionModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="completionModalLabel">Mark Portion as Complete</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="completion-form">
                            <input type="hidden" id="completion-syllabus-id">
                            <input type="hidden" id="completion-chapter-no">
                            <input type="hidden" id="completion-topic">
                            <div class="mb-3">
                                <label class="form-label">Completion Date</label>
                                <input type="date" id="completion-date" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Periods Taken</label>
                                <input type="number" id="completion-periods" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Remarks</label>
                                <textarea id="completion-remarks" class="form-control"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="save-completion-btn">Save Completion</button>
                    </div>
                </div>
            </div>
        </div>`;
        document.body.appendChild(modal);
        completionModalInstance = new bootstrap.Modal(document.getElementById('completionModal'));
        document.getElementById('save-completion-btn').addEventListener('click', async () => {
            const syllabusId = document.getElementById('completion-syllabus-id').value;
            const chapterNo = document.getElementById('completion-chapter-no').value;
            const topic = document.getElementById('completion-topic').value;
            const date = document.getElementById('completion-date').value;
            const periods = document.getElementById('completion-periods').value;
            const remarks = document.getElementById('completion-remarks').value;

            const classSelect = document.getElementById('comp-class');
            const divisionSelect = document.getElementById('comp-division');
            const subjectSelect = document.getElementById('comp-subject');

            const classId = classSelect.value;
            const division = divisionSelect.value;
            const subjectId = subjectSelect.value;


            if (classId && division && subjectId && chapterNo && topic && date && periods) {
                const completionId = `${classId}_${division}_${subjectId}_${chapterNo}_${topic.replace(/\s+/g, '-')}`;

                await setDoc(getDocRef('syllabusCompletion', completionId), {
                    classId,
                    division,
                    subjectId,
                    chapterNo,
                    topic,
                    date,
                    periods: parseInt(periods),
                    remarks,
                    teacherId: selectedUser.id,
                    teacherName: selectedUser.name
                });
                showAlert('Completion status saved!', 'success');
                completionModalInstance.hide();
                document.getElementById('comp-subject').dispatchEvent(new Event('change'));
            } else {
                showAlert('Please fill all fields in the modal.', 'danger');
            }
        });
    }

    renderAddChapterTab();
    renderCreateSyllabusTab();
    renderMarkCompletionTab();
    renderSyllabusReportTab();
};

// =================================================================================
// Helper Functions
// No changes needed here.
// =================================================================================

window.openCompletionModal = (classId, subjectId, chapterNo, topic) => {
    document.getElementById('completion-form').reset();
    document.getElementById('completion-syllabus-id').value = `${classId}_${subjectId}_${chapterNo}`;
    document.getElementById('completion-chapter-no').value = chapterNo;
    document.getElementById('completion-topic').value = topic;
    document.getElementById('completion-date').value = new Date().toISOString().slice(0, 10);
    completionModalInstance.show();
};

window.revertCompletion = async (completionId) => {
    if (confirm("Are you sure you want to revert this topic to 'Pending'?")) {
        await deleteDoc(getDocRef('syllabusCompletion', completionId));
        showAlert('Completion status reverted.', 'success');
        document.getElementById('comp-subject').dispatchEvent(new Event('change'));
    }
};

function generateScopedDropdownOptions(type, selectedClassId = '',consider='') {
    // This function remains unchanged.
    let optionsHtml = '';
    let filteredItems = [];

    if (type === 'class') {
        if (currentUserRole === 'teacher' && selectedUser?.id) {
            const uniqueClassIds = [...new Set(teacherAssignedClasses.map(a => a.classId))];
            filteredItems = classes.filter(cls => uniqueClassIds.includes(cls.id));
        } else {
            filteredItems = classes;
        }
        filteredItems.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        optionsHtml = filteredItems.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

    } else if (type === 'division' && selectedClassId) {
        const cls = classes.find(c => c.id === selectedClassId);
        if (cls) {
            if (currentUserRole === 'teacher' && selectedUser?.id) {
                const uniqueDivisions = [...new Set(teacherAssignedClasses.filter(a => a.classId === selectedClassId).map(a => a.division))];
                if (consider==="ok") {
                    filteredItems = cls.divisions;
                } else {
                filteredItems = cls.divisions.filter(d => uniqueDivisions.includes(d));
                }
            } else {
                filteredItems = cls.divisions;
            }
            filteredItems.sort((a, b) => a.localeCompare(b));
            optionsHtml = filteredItems.map(d => `<option value="${d}">${d}</option>`).join('');
        }

    } else if (type === 'subject' && selectedClassId) {
        let relevantAllocations = classroomSubjects.filter(cs =>
            cs.classId === selectedClassId
        );
        if (currentUserRole === 'teacher' && selectedUser?.id) {
            relevantAllocations = relevantAllocations.filter(cs => cs.teacherId === selectedUser.id);
        }
        const uniqueSubjectIds = [...new Set(relevantAllocations.map(a => a.subjectId))];
        filteredItems = subjects.filter(sub => uniqueSubjectIds.includes(sub.id));
        filteredItems.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        optionsHtml = filteredItems.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    }
    return optionsHtml;
}

// =================================================================================
// TAB 1: Add Chapter
// No changes are needed here.
// =================================================================================
function renderAddChapterTab() {
    // This function remains unchanged.
    const container = document.getElementById('add-chapters');
    if (!container) return;
    const classOptions = generateScopedDropdownOptions('class');
    container.innerHTML = `<div class="row">
        <div class="col-lg-5">
            <div class="card">
                <div class="card-header fw-bold">Add New Chapter</div>
                <div class="card-body">
                    <form id="chapter-form">
                        <div class="mb-3"><label class="form-label">Class</label><select id="chapter-class" class="form-select"><option value="">-- Select Class --</option>${classOptions}</select></div>
                        <div class="mb-3"><label class="form-label">Subject</label><select id="chapter-subject" class="form-select"><option value="">-- Select Subject --</option></select></div>
                        <div class="mb-3">
                            <label class="form-label">Divisions (select one or more)</label>
                            <select id="chapter-divisions" class="form-select" multiple size="3"></select>
                            <div class="form-text text-muted">Select which divisions this chapter applies to.</div>
                        </div>
                        <hr>
                        <div class="mb-3"><label class="form-label">Chapter Number</label><input type="number" id="chapter-no" class="form-control" required></div>
                        <div class="mb-3"><label class="form-label">Chapter Name</label><input type="text" id="chapter-name" class="form-control" required></div>
                        <div class="d-flex justify-content-end"><button type="submit" class="btn btn-primary">Add Chapter</button></div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="card">
                <div class="card-header fw-bold">Existing Chapters</div>
                <div class="card-body" id="chapters-list-view">
                    <p class="text-muted text-center p-5">Select a class and subject to view chapters.</p>
                </div>
            </div>
        </div>
    </div>`;
    const classSelect = document.getElementById('chapter-class'),
        subjectSelect = document.getElementById('chapter-subject'),
        divisionsSelect = document.getElementById('chapter-divisions'),
        viewContainer = document.getElementById('chapters-list-view');
    const updateChapterView = () => {
        const classId = classSelect.value;
        const subjectId = subjectSelect.value;
        if (!classId || !subjectId) {
            viewContainer.innerHTML = `<p class="text-muted text-center p-5">Please select a class and subject.</p>`;
            return;
        }
        const chapterDocId = `${classId}_${subjectId}`;
        const chapterDoc = chapters.find(c => c.id === chapterDocId);
        if (chapterDoc && chapterDoc.chapters) {
            const chapterMap = chapterDoc.chapters;
            const sortedKeys = Object.keys(chapterMap).sort((a, b) => parseInt(a) - parseInt(b));
            let htmlContent = `<ul class="list-group list-group-flush">`;
            sortedKeys.forEach(key => {
                const chapterName = chapterMap[key];
                const appliesTo = chapterDoc.appliesToDivisions?.length ?
                    `<small class="d-block text-muted">Applies to: ${chapterDoc.appliesToDivisions.join(', ')}</small>` :
                    '<small class="d-block text-danger">No divisions selected!</small>';
                htmlContent += `<li class="list-group-item"><strong>Chapter ${key}:</strong> ${chapterName} ${appliesTo}</li>`;
            });
            htmlContent += `</ul>`;
            viewContainer.innerHTML = htmlContent;
        } else {
            viewContainer.innerHTML = `<p class="text-muted text-center p-5">No chapters found. Add one now.</p>`;
        }
    };
    const updateSubjectsAndDivisions = () => {
        const classId = classSelect.value;
        subjectSelect.innerHTML = `<option value="">-- Select Subject --</option>${generateScopedDropdownOptions('subject', classId)}`;
        divisionsSelect.innerHTML = `${generateScopedDropdownOptions('division', classId, 'ok')}`;
        divisionsSelect.disabled = !classId;
        if (subjectSelect.options.length === 1 && subjectSelect.options[0].value === "") {
             subjectSelect.innerHTML = '<option value="">No subjects allocated</option>';
        }
        updateChapterView();
    };
    classSelect.addEventListener('change', updateSubjectsAndDivisions);
    subjectSelect.addEventListener('change', updateChapterView);
    document.getElementById('chapter-form').addEventListener('submit', async e => {
        e.preventDefault();
        const classId = classSelect.value,
            subjectId = subjectSelect.value;
        const selectedDivisions = Array.from(divisionsSelect.selectedOptions).map(option => option.value);
        const chapterNo = document.getElementById('chapter-no').value;
        const chapterName = document.getElementById('chapter-name').value;
        if (!classId || !subjectId || selectedDivisions.length === 0 || !chapterNo || !chapterName) {
            showAlert('Please select class, subject, divisions, and fill all chapter details.', 'danger');
            return;
        }
        const chapterDocId = `${classId}_${subjectId}`;
        const docRef = getDocRef('chapters', chapterDocId);
        try {
            const existingDoc = await getDoc(docRef);
            let currentChapters = existingDoc.exists() ? existingDoc.data().chapters || {} : {};
            currentChapters[chapterNo] = chapterName;
            await setDoc(docRef, {
                id: chapterDocId,
                classId,
                subjectId,
                chapters: currentChapters,
                appliesToDivisions: selectedDivisions
            }, { merge: true });
            showAlert('Chapter added/updated successfully!', 'success');
            document.getElementById('chapter-no').value = '';
            document.getElementById('chapter-name').value = '';
            Array.from(divisionsSelect.options).forEach(option => option.selected = false);
            //await loadSyllabusData();
            updateChapterView();
            renderCreateSyllabusTab(); // This rebuilds the "Create Syllabus" tab with the new chapter


        } catch (error) {
            console.error("Error adding/updating chapter: ", error);
            showAlert('Failed to add/update chapter.', 'danger');
        }
    });
    if (classes.length > 0) updateSubjectsAndDivisions();
}


// =================================================================================
// TAB 2: Create Syllabus (HEAVILY MODIFIED)
// =================================================================================
function renderCreateSyllabusTab() {
    const container = document.getElementById('create-syllabus');
    if (!container) return;

    const classOptions = generateScopedDropdownOptions('class');

    container.innerHTML = `<div class="row">
        <div class="col-lg-5">
            <div class="card">
                <div class="card-header fw-bold">Define Syllabus Portions</div>
                <div class="card-body">
                    <form id="syllabus-form">
                        <div class="mb-3"><label class="form-label">Class</label><select id="syllabus-class" class="form-select"><option value="">-- Select Class --</option>${classOptions}</select></div>
                        <div class="mb-3"><label class="form-label">Subject</label><select id="syllabus-subject" class="form-select"><option value="">-- Select Subject --</option></select></div>
                        <div class="mb-3"><label class="form-label">Chapter</label><select id="syllabus-chapter" class="form-select"><option value="">-- Select Chapter --</option></select></div>
                        <div class="mb-3">
                            <label class="form-label">Divisions</label>
                            <select id="syllabus-divisions" class="form-select" multiple size="3"></select>
                        </div>
                        <hr>
                        <div id="syllabus-portions-container"></div>
                        <button type="button" id="add-portion-btn" class="btn btn-sm btn-outline-secondary mt-2"><i class="fas fa-plus me-2"></i>Add Portion</button>
                        <hr>
                        <div class="d-flex justify-content-end"><button type="submit" class="btn btn-primary">Save Syllabus</button></div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="card">
                <div class="card-header fw-bold">Current Syllabus for Chapter</div>
                <div class="card-body" id="current-syllabus-view">
                    <p class="text-muted text-center p-5">Select a class, subject, and chapter to view or add topics.</p>
                </div>
            </div>
        </div>
    </div>`;

    const classSelect = document.getElementById('syllabus-class'),
        subjectSelect = document.getElementById('syllabus-subject'),
        chapterSelect = document.getElementById('syllabus-chapter'),
        divisionsSelect = document.getElementById('syllabus-divisions'),
        portionsContainer = document.getElementById('syllabus-portions-container'),
        addPortionBtn = document.getElementById('add-portion-btn'),
        viewContainer = document.getElementById('current-syllabus-view');

    // EDIT: `addPortionRow` now includes a week dropdown.
    const addPortionRow = (portion = { targetMonth: '', targetWeek: 1, topics: [] }) => {
        const row = document.createElement('div');
        row.className = 'card mb-3 portion-row';
        row.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                     <label class="form-label mb-0 fw-bold">Portion Details</label>
                     <button type="button" class="btn-close" aria-label="Remove Portion"></button>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-7">
                        <label class="form-label small">Target Month</label>
                        <input type="month" class="form-control form-control-sm target-month-input" value="${portion.targetMonth}" required>
                    </div>
                    <div class="col-5">
                        <label class="form-label small">Target Week</label>
                        <select class="form-select form-select-sm target-week-input" required>
                            <option value="1">Week 1</option>
                            <option value="2">Week 2</option>
                            <option value="3">Week 3</option>
                            <option value="4">Week 4</option>
                        </select>
                    </div>
                </div>
                <label class="form-label small">Topics (one per line)</label>
                <textarea class="form-control form-control-sm topics-textarea" rows="4">${portion.topics.join('\n')}</textarea>
            </div>`;
        
        row.querySelector('.target-week-input').value = portion.targetWeek;
        row.querySelector('.btn-close').addEventListener('click', () => row.remove());
        portionsContainer.appendChild(row);
    };
    
    // EDIT: "Add Portion" button is now smarter.
    addPortionBtn.addEventListener('click', () => {
        const allPortions = portionsContainer.querySelectorAll('.portion-row');
        if (allPortions.length > 0) {
            const lastPortion = allPortions[allPortions.length - 1];
            const lastMonth = lastPortion.querySelector('.target-month-input').value;
            let lastWeek = parseInt(lastPortion.querySelector('.target-week-input').value);

            if (!lastMonth) { // If the last month is empty, just add a default row
                addPortionRow();
                return;
            }

            if (lastWeek < 4) {
                addPortionRow({ targetMonth: lastMonth, targetWeek: lastWeek + 1, topics: [] });
            } else { // Roll over to next month
                const lastMonthDate = new Date(lastMonth + '-02'); // Use day 2 to avoid timezone issues
                lastMonthDate.setMonth(lastMonthDate.getMonth() + 1);
                const nextMonth = lastMonthDate.toISOString().slice(0, 7);
                addPortionRow({ targetMonth: nextMonth, targetWeek: 1, topics: [] });
            }
        } else {
            // Add the very first row with current month
            const currentMonth = new Date().toISOString().slice(0, 7);
            addPortionRow({targetMonth: currentMonth, targetWeek: 1, topics: []});
        }
    });

    // EDIT: `updateSyllabusView` now handles week display.
    const updateSyllabusView = () => {
        const classId = classSelect.value,
            subjectId = subjectSelect.value,
            chapterNo = chapterSelect.value;
        
        portionsContainer.innerHTML = '';
        viewContainer.innerHTML = '';

        if (!classId || !subjectId || !chapterNo) {
            viewContainer.innerHTML = `<p class="text-muted text-center p-5">Please select all filters.</p>`;
            addPortionBtn.disabled = true;
            return;
        }

        addPortionBtn.disabled = false;
        const syllabusId = `${classId}_${subjectId}_${chapterNo}`;
        const syllabus = syllabuses.find(s => s.id === syllabusId);

        if (syllabus && Array.isArray(syllabus.portions) && syllabus.portions.length > 0) {
            syllabus.portions.sort((a, b) => (a.targetMonth + a.targetWeek).localeCompare(b.targetMonth + b.targetWeek));
            syllabus.portions.forEach(p => addPortionRow(p));

            let htmlContent = '';
            syllabus.portions.forEach(p => {
                const monthDate = new Date(p.targetMonth + '-02');
                const monthName = monthDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                htmlContent += `<h6 class="mt-3 fw-bold">Target: ${monthName} - Week ${p.targetWeek}</h6>`;
                htmlContent += `<ol class="list-group list-group-numbered">`;
                p.topics.forEach(t => { htmlContent += `<li class="list-group-item">${t}</li>`; });
                htmlContent += `</ol>`;
            });
            if (syllabus.appliesToDivisions?.length > 0) {
                 htmlContent += `<div class="mt-3 text-muted small border-top pt-2">Applies to divisions: <strong>${syllabus.appliesToDivisions.join(', ')}</strong></div>`;
            }
            viewContainer.innerHTML = htmlContent;

            Array.from(divisionsSelect.options).forEach(option => {
                option.selected = syllabus.appliesToDivisions?.includes(option.value);
            });

        } else {
            viewContainer.innerHTML = `<p class="text-muted text-center p-5">No syllabus found. Add portions now.</p>`;
            addPortionBtn.click(); // Add one empty row to start
        }
    };
    
    const updateChapters = () => {
        const classId = classSelect.value,
            subjectId = subjectSelect.value;
        chapterSelect.innerHTML = `<option value="">-- Select Chapter --</option>`;
        if (!classId || !subjectId) { updateSyllabusView(); return; }
        const chapterDoc = chapters.find(c => c.id === `${classId}_${subjectId}`);
        if (chapterDoc && chapterDoc.chapters) {
            const sortedKeys = Object.keys(chapterDoc.chapters).sort((a, b) => parseInt(a) - parseInt(b));
            chapterSelect.innerHTML += sortedKeys.map(key => `<option value="${key}">Ch ${key}: ${chapterDoc.chapters[key]}</option>`).join('');
        }
        updateSyllabusView();
    };

    const updateSubjectsAndDivisions = () => {
        const classId = classSelect.value;
        subjectSelect.innerHTML = `<option value="">-- Select Subject --</option>${generateScopedDropdownOptions('subject', classId)}`;
        divisionsSelect.innerHTML = `${generateScopedDropdownOptions('division', classId, 'ok')}`;
        divisionsSelect.disabled = !classId;
        if (subjectSelect.options.length === 1 && subjectSelect.options[0].value === "") {
             subjectSelect.innerHTML = '<option value="">No subjects allocated</option>';
        }
        updateChapters();
    };

    classSelect.addEventListener('change', updateSubjectsAndDivisions);
    subjectSelect.addEventListener('change', updateChapters);
    chapterSelect.addEventListener('change', updateSyllabusView);

    // EDIT: Form submission now saves the `targetWeek`.
    document.getElementById('syllabus-form').addEventListener('submit', async e => {
        e.preventDefault();
        const classId = classSelect.value,
            subjectId = subjectSelect.value,
            chapterNo = chapterSelect.value;
        const selectedDivisions = Array.from(divisionsSelect.selectedOptions).map(option => option.value);

        const portionRows = portionsContainer.querySelectorAll('.portion-row');
        const portions = [];
        let hasError = false;

        portionRows.forEach(row => {
            const targetMonth = row.querySelector('.target-month-input').value;
            const targetWeek = row.querySelector('.target-week-input').value;
            const topics = row.querySelector('.topics-textarea').value.split('\n').map(t => t.trim()).filter(Boolean);
            if (!targetMonth || !targetWeek || topics.length === 0) {
                hasError = true; return;
            }
            portions.push({ targetMonth, targetWeek: parseInt(targetWeek), topics });
        });

        if (hasError) {
             showAlert('Please ensure every portion has a target month, week, and at least one topic.', 'danger'); return;
        }
        if (!classId || !subjectId || !chapterNo || selectedDivisions.length === 0 || portions.length === 0) {
            showAlert('Please select all fields and add at least one valid portion.', 'danger'); return;
        }

        const syllabusId = `${classId}_${subjectId}_${chapterNo}`;
        await setDoc(getDocRef('syllabuses', syllabusId), {
            id: syllabusId, classId, subjectId, chapterNo, portions, appliesToDivisions: selectedDivisions
        });
        showAlert('Syllabus saved successfully!', 'success');
        //await loadSyllabusData();
        updateSyllabusView();
    });

    if (classes.length > 0) updateSubjectsAndDivisions();
}


// =================================================================================
// TAB 3: Mark Completion (MODIFIED)
// =================================================================================
function renderMarkCompletionTab() {
    const container = document.getElementById('mark-completion');
    if (!container) return;
    const classOptions = generateScopedDropdownOptions('class');
    container.innerHTML = `<div class="row g-3 align-items-end border-bottom pb-3 mb-3">
            <div class="col-md-4"><label class="form-label">Class</label><select id="comp-class" class="form-select"><option value="">-- Select Class --</option>${classOptions}</select></div>
            <div class="col-md-4"><label class="form-label">Division</label><select id="comp-division" class="form-select"><option value="">-- Select Division --</option></select></div>
            <div class="col-md-4"><label class="form-label">Subject</label><select id="comp-subject" class="form-select"><option value="">-- Select Subject --</option></select></div>
        </div>
        <div id="completion-list-view"></div>`;

    const classSelect = document.getElementById('comp-class'),
        divisionSelect = document.getElementById('comp-division'),
        subjectSelect = document.getElementById('comp-subject');

    // EDIT: Display logic now includes the week.
    const displayCompletionList = () => {
        const classId = classSelect.value, division = divisionSelect.value, subjectId = subjectSelect.value;
        const view = document.getElementById('completion-list-view');
        if (!classId || !division || !subjectId) {
            view.innerHTML = `<p class="text-muted text-center p-5">Please select a class, division, and subject.</p>`; return;
        }
        const chapterDoc = chapters.find(c => c.id === `${classId}_${subjectId}` && c.appliesToDivisions?.includes(division));
        if (!chapterDoc || !chapterDoc.chapters) {
            view.innerHTML = `<div class="alert alert-warning">No chapters are applicable to the selected division.</div>`; return;
        }
        const completions = syllabusCompletion.filter(c => c.classId === classId && c.division === division && c.subjectId === subjectId);
        const syllabusForSubject = syllabuses.filter(s => s.classId === classId && s.subjectId === subjectId && s.appliesToDivisions?.includes(division));
        let accordionHTML = '<div class="accordion">';
        const sortedChapterKeys = Object.keys(chapterDoc.chapters).sort((a, b) => parseInt(a) - parseInt(b));
        sortedChapterKeys.forEach((chapterNo) => {
            const chapterName = chapterDoc.chapters[chapterNo];
            const syllabusForChapter = syllabusForSubject.find(s => s.chapterNo === chapterNo);
            const portions = syllabusForChapter?.portions || [];
            accordionHTML += `<div class="accordion-item">
                <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${chapterNo}">Chapter ${chapterNo}: ${chapterName}</button></h2>
                <div id="collapse-${chapterNo}" class="accordion-collapse collapse"><div class="accordion-body">`;
            
            if (portions.length > 0) {
                 portions.sort((a,b) => (a.targetMonth + a.targetWeek).localeCompare(b.targetMonth + b.targetWeek)).forEach(portion => {
                    const monthDate = new Date(portion.targetMonth + '-02');
                    const monthName = monthDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                    accordionHTML += `<h6 class="mt-3 fw-bold text-primary">Target: ${monthName} - Week ${portion.targetWeek}</h6>`;
                    accordionHTML += `<ul class="list-group">`;
                    portion.topics.forEach(topic => {
                        const completion = completions.find(c => c.chapterNo === chapterNo && c.topic === topic);
                        if (completion) {
                            accordionHTML += `<li class="list-group-item list-group-item-success d-flex justify-content-between align-items-center">
                                <div><i class="fas fa-check-circle me-2"></i><strong>${topic}</strong>
                                    <small class="d-block text-muted">Completed on ${new Date(completion.date).toLocaleDateString()} by ${completion.teacherName} | Periods: ${completion.periods}</small>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="window.revertCompletion('${completion.id}')">Revert</button>
                            </li>`;
                        } else {
                            accordionHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                ${topic}
                                <button class="btn btn-sm btn-primary" onclick="window.openCompletionModal('${classId}', '${subjectId}', '${chapterNo}', '${topic}')">Mark Complete</button>
                            </li>`;
                        }
                    });
                     accordionHTML += `</ul>`;
                });
            } else {
                 accordionHTML += '<div class="text-muted">No syllabus portions defined for this chapter.</div>';
            }
            accordionHTML += `</div></div></div>`;
        });
        accordionHTML += '</div>';
        view.innerHTML = accordionHTML;
    };
    
    const updateSubjects = () => {
        const classId = classSelect.value;
        subjectSelect.innerHTML = `<option value="">-- Select Subject --</option>${generateScopedDropdownOptions('subject', classId)}`;
         if (subjectSelect.options.length === 1 && subjectSelect.options[0].value === "") {
             subjectSelect.innerHTML = '<option value="">No subjects allocated</option>';
        }
        displayCompletionList();
    };
    const updateDivisions = () => {
        const classId = classSelect.value;
        divisionSelect.innerHTML = `<option value="">-- Select Division --</option>${generateScopedDropdownOptions('division', classId)}`;
        updateSubjects();
    };
    classSelect.addEventListener('change', updateDivisions);
    divisionSelect.addEventListener('change', updateSubjects);
    subjectSelect.addEventListener('change', displayCompletionList);
    if (classes.length > 0) updateDivisions();
}


// =================================================================================
// TAB 4: Syllabus Report (HEAVILY MODIFIED)
// =================================================================================
function renderSyllabusReportTab() {
    const container = document.getElementById('syllabus-report');
    if (!container) return;

    // The main HTML structure with two report modes.
    container.innerHTML = `
        <ul class="nav nav-pills mb-3" id="report-mode-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pills-completion-tab" data-bs-toggle="pill" data-bs-target="#pills-completion" type="button" role="tab">Completion Status Report</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pills-plan-tab" data-bs-toggle="pill" data-bs-target="#pills-plan" type="button" role="tab">Printable Syllabus Plan</button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="pills-completion" role="tabpanel">
                <div class="card card-body">
                    <div class="row g-2 align-items-end border-bottom pb-3 mb-3">
                        <div class="col-md-2"><label class="form-label">Class</label><select id="report-class" class="form-select form-select-sm">${generateScopedDropdownOptions('class')}</select></div>
                        <div class="col-md-2"><label class="form-label">Division</label><select id="report-division" class="form-select form-select-sm"><option value="all">-- All --</option></select></div>
                        <div class="col-md-2"><label class="form-label">Subject</label><select id="report-subject" class="form-select form-select-sm"><option value="all">-- All --</option></select></div>
                        <div class="col-md-2"><label class="form-label">Month</label><input type="month" id="report-target-month" class="form-control form-control-sm"></div>
                        <div class="col-md-2"><label class="form-label">Week</label><select id="report-target-week" class="form-select form-select-sm"><option value="all">All</option><option value="1">W 1</option><option value="2">W 2</option><option value="3">W 3</option><option value="4">W 4</option><option value="5">W 5</option></select></div>
                        <div class="col-md-2"><label class="form-label">Status</label><select id="report-status-filter" class="form-select form-select-sm">
                            <option value="all">All</option>
                            <option value="completed">Completed</option>
                            <option value="pending">All Pending</option>
                            <option value="overdue">Overdue</option>
                            <option value="pending_current_week">This Week's Pending</option>
                        </select></div>
                        <div class="col-12 text-end mt-2">
                             <button id="print-completion-report-btn" class="btn btn-outline-secondary btn-sm"><i class="fas fa-print me-2"></i>Print Completion Report</button>
                        </div>
                    </div>
                    <div id="completion-report-view"><p class="text-muted text-center p-5">Select filters to generate the report.</p></div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-plan" role="tabpanel">
                 <div class="card card-body">
                    <div class="row g-2 align-items-end border-bottom pb-3 mb-3">
                        <div class="col-md-3"><label class="form-label">Select Class</label><select id="plan-class-select" class="form-select"><option value="">-- Select Class --</option>${generateScopedDropdownOptions('class')}</select></div>
                        <div class="col-md-3"><label class="form-label">Select Subjects</label><select id="plan-subject-select" class="form-select" multiple size="3" disabled></select></div>
                        <div class="col-md-3"><label class="form-label">Select Months</label><select id="plan-month-select" class="form-select" multiple size="3" disabled></select></div>
                        <div class="col-md-3 text-end">
                             <button id="print-plan-btn" class="btn btn-outline-secondary"><i class="fas fa-print me-2"></i>Print Syllabus Plan</button>
                        </div>
                    </div>
                    <div id="syllabus-plan-view"><p class="text-muted text-center p-5">Select a class to begin.</p></div>
                 </div>
            </div>
        </div>
    `;

    // --- LOGIC FOR COMPLETION STATUS REPORT (Unchanged) ---
    const classSelect = document.getElementById('report-class'),
        divisionSelect = document.getElementById('report-division'),
        subjectSelect = document.getElementById('report-subject'),
        targetMonthInput = document.getElementById('report-target-month'),
        targetWeekSelect = document.getElementById('report-target-week'),
        statusFilter = document.getElementById('report-status-filter'),
        printCompletionBtn = document.getElementById('print-completion-report-btn');

    const getWeekOfMonth = (date) => {
        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
        return Math.ceil((date.getDate() + firstDay) / 7);
    };

    const displayCompletionReport = () => { /* This function is unchanged from the previous version */ 
        const view = document.getElementById('completion-report-view');
        const classId = classSelect.value, division = divisionSelect.value, subjectId = subjectSelect.value;
        const targetMonth = targetMonthInput.value, targetWeek = targetWeekSelect.value, status = statusFilter.value;
        
        const now = new Date();
        const currentMonth = now.toISOString().slice(0, 7);
        const currentWeek = getWeekOfMonth(now);

        let reportRowsData = [];
        syllabuses.forEach(syl => {
            (syl.portions || []).forEach(portion => {
                (portion.topics || []).forEach(topic => {
                    const divisionsToReportOn = syl.appliesToDivisions || [];
                    divisionsToReportOn.forEach(div => {
                         const completion = syllabusCompletion.find(c => c.classId === syl.classId && c.division === div && c.subjectId === syl.subjectId && c.chapterNo === syl.chapterNo && c.topic === topic);
                         
                         let rowStatus = 'pending_future';
                         if (completion) {
                             rowStatus = 'completed';
                         } else {
                             if (portion.targetMonth < currentMonth || (portion.targetMonth === currentMonth && portion.targetWeek < currentWeek)) {
                                 rowStatus = 'overdue';
                             } else if (portion.targetMonth === currentMonth && portion.targetWeek === currentWeek) {
                                 rowStatus = 'pending_current_week';
                             }
                         }

                         reportRowsData.push({
                            classId: syl.classId, subjectId: syl.subjectId, division: div,
                            targetMonth: portion.targetMonth, targetWeek: portion.targetWeek,
                            chapterNo: syl.chapterNo, topic, completion, status: rowStatus
                         });
                    });
                });
            });
        });
        
        const filteredData = reportRowsData.filter(row => {
            if (classId && classId !== 'all' && row.classId !== classId) return false;
            if (division && division !== 'all' && row.division !== division) return false;
            if (subjectId && subjectId !== 'all' && row.subjectId !== subjectId) return false;
            if (targetMonth && row.targetMonth !== targetMonth) return false;
            if (targetWeek && targetWeek !== 'all' && row.targetWeek != targetWeek) return false;
            if (status !== 'all') {
                if (status === 'pending' && !['overdue', 'pending_current_week', 'pending_future'].includes(row.status)) return false;
                if (status !== 'pending' && row.status !== status) return false;
            }
            return true;
        });

        filteredData.sort((a, b) => (a.targetMonth + a.targetWeek).localeCompare(b.targetMonth + b.targetWeek));

        let reportHTML = `<div class="table-responsive"><table class="table table-bordered table-sm">
            <thead class="table-light"><tr><th>Target</th><th>Class</th><th>Div</th><th>Subject</th><th>Chapter</th><th>Topic</th><th>Status</th><th>Completed On</th></tr></thead><tbody>`;
        
        if (filteredData.length === 0) {
            reportHTML += `<tr><td colspan="8" class="text-center">No data matches your criteria.</td></tr>`;
        } else {
            filteredData.forEach(row => {
                const className = classes.find(c => c.id === row.classId)?.name || 'N/A';
                const subjectName = subjects.find(s => s.id === row.subjectId)?.name || 'N/A';
                const chapterName = chapters.find(c => c.id === `${row.classId}_${row.subjectId}`)?.chapters[row.chapterNo] || 'N/A';
                
                const statusColors = { completed: 'table-success', overdue: 'table-danger', pending_current_week: 'table-warning', pending_future: '' };
                const statusText = { completed: 'Completed', overdue: 'Overdue', pending_current_week: 'Pending (This Week)', pending_future: 'Pending' };

                reportHTML += `<tr class="${statusColors[row.status]}">
                    <td>${row.targetMonth}-W${row.targetWeek}</td>
                    <td>${className}</td><td>${row.division}</td><td>${subjectName}</td><td>Ch ${row.chapterNo}: ${chapterName}</td><td>${row.topic}</td>
                    <td>${statusText[row.status]}</td><td>${row.completion ? new Date(row.completion.date).toLocaleDateString() : 'N/A'}</td>
                </tr>`;
            });
        }
        reportHTML += `</tbody></table></div>`;
        view.innerHTML = reportHTML;
    };
    const updateSubjectsForReport = () => { const classId = classSelect.value; subjectSelect.innerHTML = `<option value="all">-- All Subjects --</option>${generateScopedDropdownOptions('subject', classId !== 'all' ? classId : '')}`; displayCompletionReport(); };
    const updateDivisionsForReport = () => { const classId = classSelect.value; divisionSelect.innerHTML = `<option value="all">-- All Divisions --</option>${generateScopedDropdownOptions('division', classId !== 'all' ? classId : '')}`; updateSubjectsForReport(); };
    classSelect.addEventListener('change', updateDivisionsForReport);
    [divisionSelect, subjectSelect, targetMonthInput, targetWeekSelect, statusFilter].forEach(el => el.addEventListener('change', displayCompletionReport));
    printCompletionBtn.addEventListener('click', () => printContentOfDiv('completion-report-view', 'Syllabus Completion Report'));


    // --- LOGIC FOR SYLLABUS PLAN VIEW (All New Logic) ---
    const planClassSelect = document.getElementById('plan-class-select');
    const planSubjectSelect = document.getElementById('plan-subject-select');
    const planMonthSelect = document.getElementById('plan-month-select');
    const printPlanBtn = document.getElementById('print-plan-btn');
    const planView = document.getElementById('syllabus-plan-view');

    const displaySyllabusPlan = () => {
        const classId = planClassSelect.value;
        const selectedSubjects = Array.from(planSubjectSelect.selectedOptions).map(opt => opt.value);
        const selectedMonths = Array.from(planMonthSelect.selectedOptions).map(opt => opt.value);

        if (!classId) {
            planView.innerHTML = `<p class="text-muted text-center p-5">Select a class to begin.</p>`;
            return;
        }

        const className = classes.find(c => c.id === classId)?.name || 'N/A';
        let syllabusesForClass = syllabuses.filter(s => s.classId === classId);

        // Filter by selected subjects if any are chosen
        if (selectedSubjects.length > 0) {
            syllabusesForClass = syllabusesForClass.filter(s => selectedSubjects.includes(s.subjectId));
        }
        
        const subjectsGroup = {};
        syllabusesForClass.forEach(syl => {
            const subjectInfo = subjects.find(s => s.id === syl.subjectId);
            if (!subjectInfo) return;

            if (!subjectsGroup[subjectInfo.name]) {
                subjectsGroup[subjectInfo.name] = { subjectId: syl.subjectId, portions: [] };
            }
            // Filter portions by selected months if any are chosen
            const filteredPortions = (syl.portions || []).filter(p => {
                const month = p.targetMonth.split('-')[1];
                return selectedMonths.length === 0 || selectedMonths.includes(month);
            });

            if (filteredPortions.length > 0) {
                 const chapterName = chapters.find(c => c.id === `${syl.classId}_${syl.subjectId}`)?.chapters[syl.chapterNo] || 'N/A';
                 subjectsGroup[subjectInfo.name].portions.push(...filteredPortions.map(p => ({...p, chapterNo: syl.chapterNo, chapterName})));
            }
        });

        let html = `<h3 class="text-center mb-4">Split-up Syllabus for Class: ${className}</h3>`;
        if (Object.keys(subjectsGroup).length === 0) {
            html += `<p class="alert alert-warning">No syllabus plan data found for the selected filters.</p>`;
            planView.innerHTML = html;
            return;
        }

        for (const subjectName of Object.keys(subjectsGroup).sort()) {
            const subjectId = subjectsGroup[subjectName].subjectId;
            
            // Find teachers for this subject in this class
            const teacherAssignments = classroomSubjects.filter(cs => cs.classId === classId && cs.subjectId === subjectId);
            const teacherIds = [...new Set(teacherAssignments.map(t => t.teacherId))];
            const teacherNames = teacherIds.map(id => teachers.find(u => u.id === id)?.name || 'Unknown').join(', ');

            html += `<div style="page-break-before: always;">
                        <div class="d-flex justify-content-between align-items-center">
                           <h4 class="mt-4">Subject: ${subjectName}</h4>
                           <h6 class="text-muted">Teacher(s): ${teacherNames}</h6>
                        </div>
                     </div>`;
            html += `<table class="table table-bordered table-sm">
                        <thead class="table-light"><tr><th style="width: 25%;">Target Period</th><th>Topics / Portions</th></tr></thead>
                        <tbody>`;

            const portionsByPeriod = {};
            subjectsGroup[subjectName].portions.forEach(p => {
                const periodKey = `${p.targetMonth}-W${p.targetWeek}`;
                if (!portionsByPeriod[periodKey]) portionsByPeriod[periodKey] = [];
                portionsByPeriod[periodKey].push(`<strong>Ch ${p.chapterNo} (${p.chapterName}):</strong><ul>${p.topics.map(t => `<li>${t}</li>`).join('')}</ul>`);
            });

            if(Object.keys(portionsByPeriod).length === 0){
                html += `<tr><td colspan="2" class="text-center text-muted">No portions scheduled for the selected months.</td></tr>`;
            } else {
                Object.keys(portionsByPeriod).sort().forEach(period => {
                    const [year, month] = period.split('-W')[0].split('-');
                    const week = period.split('-W')[1];
                    const monthName = new Date(year, month-1).toLocaleString('default', { month: 'short' });
                    html += `<tr><td>${year}-${monthName} / Week ${week}</td><td>${portionsByPeriod[period].join('')}</td></tr>`;
                });
            }
            html += `</tbody></table>`;
        }
        planView.innerHTML = html;
    };
    
    // Populate filters when class changes
    planClassSelect.addEventListener('change', () => {
        const classId = planClassSelect.value;
        
        // Populate Subjects
        const subjectsInClass = classroomSubjects.filter(cs => cs.classId === classId);
        const uniqueSubjectIds = [...new Set(subjectsInClass.map(cs => cs.subjectId))];
        const subjectOptions = subjects
            .filter(s => uniqueSubjectIds.includes(s.id))
            .map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        planSubjectSelect.innerHTML = subjectOptions;
        planSubjectSelect.disabled = !classId;

        // Populate Months
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        planMonthSelect.innerHTML = months.map((m, i) => `<option value="${String(i + 1).padStart(2, '0')}">${m}</option>`).join('');
        planMonthSelect.disabled = !classId;

        displaySyllabusPlan();
    });

    [planSubjectSelect, planMonthSelect].forEach(el => el.addEventListener('change', displaySyllabusPlan));
    printPlanBtn.addEventListener('click', () => printContentOfDiv('syllabus-plan-view', `Syllabus Plan for ${planClassSelect.options[planClassSelect.selectedIndex].text}`));


    // --- INITIALIZE THE REPORT TABS ---
    if (classes.length > 0) {
        // Init Completion Report
        targetMonthInput.value = new Date().toISOString().slice(0, 7);
        targetWeekSelect.value = getWeekOfMonth(new Date());
        updateDivisionsForReport();
        
        // Init Syllabus Plan (but don't display until user selects a class)
        planClassSelect.dispatchEvent(new Event('change'));
    }
}


window.renderFeeManagement = () => {
    const currentYear = new Date().getFullYear();
    const yearOptions = Array.from({ length: 5 }, (_, i) => {
        const year = currentYear - i;
        const fy = `${year}-${year + 1}`;
        return `<option value="${fy}" ${fy === activeFinancialYear ? 'selected' : ''}>${fy}</option>`;
    }).join('');

    mainContent.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">Fee Management</h1>
            <div>
                <label for="master-fy-selector" class="form-label me-2">Active Financial Year:</label>
                <select id="master-fy-selector" class="form-select d-inline-block w-auto">${yearOptions}</select>
            </div>
        </div>
        <ul class="nav nav-tabs" id="fee-main-tab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#fee-structure-tab" data-subtab="structure" type="button">Fee Structure</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fee-setup-tab" data-subtab="setup" type="button">Student Fee Setup</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fee-receipt-tab" data-subtab="receipt" type="button">Fee Receipt</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fee-reports-tab" data-subtab="reports" type="button">Reports</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fee-arrears-tab" data-subtab="arrears" type="button">Arrears Reconciliation</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fee-verification-tab" data-subtab="verifiation" type="button">Arrears FEE vERIFICATION </button></li>
            </ul>
        <div class="tab-content" id="fee-main-tab-content">
            <div class="tab-pane fade show active" id="fee-structure-tab" role="tabpanel"></div>
            <div class="tab-pane fade" id="fee-setup-tab" role="tabpanel"></div>
            <div class="tab-pane fade" id="fee-receipt-tab" role="tabpanel"></div>
            <div class="tab-pane fade" id="fee-reports-tab" role="tabpanel"></div>
            <div class="tab-pane fade" id="fee-arrears-tab" role="tabpanel"></div>
            <div class="tab-pane fade" id="fee-verification-tab" role="tabpanel"></div>
            </div>`;

    document.getElementById('master-fy-selector').addEventListener('change', (e) => {
        activeFinancialYear = e.target.value;
        attachFeeDataListeners(activeFinancialYear); // Assuming this function handles data listeners for the new FY
        const activeSubTab = document.querySelector('#fee-main-tab .nav-link.active').dataset.subtab;
        renderFeeSubTab(activeSubTab); // Re-render the current sub-tab with the new FY
    });

    document.querySelectorAll('#fee-main-tab .nav-link').forEach(tab => {
        tab.addEventListener('show.bs.tab', (event) => {
            renderFeeSubTab(event.target.dataset.subtab);
        });
    });

    renderFeeSubTab('structure'); // Default view
};

        function renderFeeSubTab(subtab) {
    // Clear edit state when switching tabs
    feeStructureToEdit = null;
    receiptToEdit = null;

    switch (subtab) {
        case 'structure':
            renderFeeStructureTab();
            break;
        case 'setup':
            renderStudentFeeSetupTab();
            break;
        case 'receipt':
            renderFeeReceiptTab();
            break;
        case 'reports':
            renderFeeReportsTab();
            break;
        // NEW CASE: Arrears Reconciliation
        case 'arrears':
            renderArrearsReconciliationTab(); // Call a new function to render the arrears tab content
            break;
        case 'verifiation':
            renderPaymentVerificationTab(); // Call a new function to render the arrears tab content
            break;
    }
}

        function renderFeeStructureTab() {
    const container = document.getElementById('fee-structure-tab');
    if (!container) return; // Add null check for container
    const isEditMode = feeStructureToEdit !== null;

    container.innerHTML = `
        <div class="card p-4 mt-3">
            <div class="row">
                <div class="col-lg-5">
                    <form id="fee-structure-form" class="card p-3">
                        <h5 class="fw-bold mb-3">${isEditMode ? 'Edit Fee Structure' : 'Add Fee Structure'}</h5>
                        <div class="mb-3">
                            <label class="form-label">Fee Head</label>
                            <select id="fs-head" class="form-select" ${isEditMode ? 'disabled' : ''}>
                                <option value="">-- Select --</option>
                                <option value="TUITION FEE" ${feeStructureToEdit?.feeHead === 'TUITION FEE' ? 'selected' : ''}>TUITION FEE</option>
                                <option value="VEHICLE FEE" ${feeStructureToEdit?.feeHead === 'VEHICLE FEE' ? 'selected' : ''}>VEHICLE FEE</option>
                                <option value="EXAM FEE" ${feeStructureToEdit?.feeHead === 'EXAM FEE' ? 'selected' : ''}>EXAM FEE</option>
                            </select>
                            <div class="invalid-feedback">Please select a fee head.</div>
                        </div>
                        <div id="fs-dynamic-container">
                            </div>
                        <div class="text-end mt-3">
                            ${isEditMode ? '<button type="button" id="cancel-fee-edit-btn" class="btn btn-secondary me-2">Cancel</button>' : ''}
                            <button type="submit" class="btn btn-primary">${isEditMode ? 'Update' : 'Save'}</button>
                        </div>
                    </form>
                </div>
                <div class="col-lg-7" id="fee-structures-list">
                    </div>
            </div>
        </div>`;

    attachFeeStructureFormListeners();
    renderFeeStructuresList(); // Render the list on the right
}
        
        function renderStudentFeeSetupTab() {
    const container = document.getElementById('fee-setup-tab');
    container.innerHTML = `
        <div class="card p-4 mt-3">
            <h4 class="mb-3">Student Annual Fee Setup</h4>
            <p class="text-muted">Generate or view the annual fee structure for students. The system auto-fills fees from the 'Fee Structure' tab. You can then make manual adjustments (e.g., for concessions) and save.</p>
            <div class="row g-3 align-items-end mb-4">
                <div class="col-md-4">
                    <label class="form-label">Class</label>
                    <select id="sfs-class" class="form-select">
                        <option value="">-- Select Class --</option>
                        ${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Division</label>
                    <select id="sfs-division" class="form-select" disabled>
                        <option value="">-- Select Division --</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button id="sfs-fetch-btn" class="btn btn-primary w-100">Fetch Students</button>
                </div>
            </div>
            <div id="sfs-status" class="mt-4 text-center text-muted"></div>

            <div id="sfs-table-container" class="mt-4">
                </div>

            <div class="mt-4 text-end">
                <button id="sfs-save-all-btn" class="btn btn-success" style="display:none;">Save All Student Setups</button>
            </div>
        </div>
    `;
    attachStudentFeeSetupListeners();
}

        // (In index.html script block)

function renderFeeReceiptTab() {
    const container = document.getElementById('fee-receipt-tab');
    container.innerHTML = `
        <div class="card p-4 mt-3">
            <h4 class="mb-3">Fee Receipt</h4>

            <ul class="nav nav-tabs" id="receiptEntryTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="single-receipt-tab" data-bs-toggle="tab" data-bs-target="#single-receipt-pane" type="button" role="tab" aria-controls="single-receipt-pane" aria-selected="true">Single Receipt</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="bulk-receipt-tab" data-bs-toggle="tab" data-bs-target="#bulk-receipt-pane" type="button" role="tab" aria-controls="bulk-receipt-pane" aria-selected="false">Bulk Receipt</button>
                </li>
            </ul>

            <div class="tab-content" id="receiptEntryTabsContent">
                <div class="tab-pane fade show active p-3" id="single-receipt-pane" role="tabpanel" aria-labelledby="single-receipt-tab">
                    </div>
                <div class="tab-pane fade p-3" id="bulk-receipt-pane" role="tabpanel" aria-labelledby="bulk-receipt-tab">
                    </div>
            </div>

            <hr>
            <h5 class="mb-3">Recent Receipts (${activeFinancialYear})</h5>
            <div id="recent-receipts-list"></div>
        </div>
    `;

    // Render the content for the initial active tab
    renderReceiptEntryForm(); // This is your existing single receipt logic
    renderBulkReceiptForm(); // Call the new bulk receipt form renderer

    // Attach listeners for tab switching
    document.getElementById('receiptEntryTabs').addEventListener('shown.bs.tab', function (event) {
        const targetPaneId = event.target.getAttribute('data-bs-target');
        if (targetPaneId === '#single-receipt-pane') {
            renderReceiptEntryForm();
        } else if (targetPaneId === '#bulk-receipt-pane') {
            renderBulkReceiptForm();
        }
    });

    renderRecentReceipts(); // Your existing function to show recent receipts
}

function renderRecentReceipts() {
    const container = document.getElementById('recent-receipts-list');
    if (!container) return;

    // Filter receipts for the active financial year
    const relevantReceipts = receipts.filter(r => r.financialYear === activeFinancialYear);

    if (relevantReceipts.length === 0) {
        container.innerHTML = '<p class="text-muted text-center p-3">No receipts found for this financial year.</p>';
        return;
    }

    // Sort by date (newest first)
    relevantReceipts.sort((a, b) => new Date(b.date) - new Date(a.date));

    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-sm">
                <thead>
                    <tr>
                        <th>Receipt No.</th>
                        <th>Date</th>
                        <th>Payer / Student</th>
                        <th>Amount</th>
                        <th>Mode</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${relevantReceipts.map(r => `
                        <tr>
                            <td>${r.receiptNo}</td>
                            <td>${new Date(r.date).toLocaleDateString()}</td>
                            <td>
                                ${r.isStudent ?
                                    `<span class="fw-bold">${students.find(s => s.id === r.studentId)?.name || r.payerName || 'Unknown Student'}</span><br>
                                     <small class="text-muted">${students.find(s => s.id === r.studentId)?.admissionNumber || 'N/A'}</small>`
                                    : r.payerName || 'N/A'
                                }
                            </td>
                            <td>â‚¹ ${r.totalAmount.toFixed(2)}</td>
                            <td>${r.paymentMode}</td>
                            <td><span class="badge bg-${r.isCancelled ? 'danger' : 'success'}">${r.isCancelled ? 'Cancelled' : 'Paid'}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1" onclick="handleEditReceipt('${r.receiptNo}')" title="Edit"><i class="fas fa-edit fa-xs"></i></button>
                                ${!r.isCancelled && currentUserRole === 'admin' ? `
                                <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="handleCancelReceipt('${r.receiptNo}')" title="Cancel Receipt"><i class="fas fa-ban fa-xs"></i></button>
                                ` : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// Add these helper functions (if they don't already exist or need modification)
window.handleEditReceipt = (receiptNo) => {
    receiptToEdit = receipts.find(r => r.receiptNo === receiptNo);
    if (receiptToEdit) {
        // Switch to single receipt tab and render the form
        const singleReceiptTab = document.getElementById('single-receipt-tab');
        if (singleReceiptTab) {
            new bootstrap.Tab(singleReceiptTab).show();
        }
        renderReceiptEntryForm(); // This will use `receiptToEdit` to pre-fill
    } else {
        showAlert('Receipt not found for editing.', 'danger');
    }
};

window.handleCancelReceipt = async (receiptNo) => {
    if (!confirm('Are you sure you want to cancel this receipt? This action will reduce the student\'s paid amount.')) {
        return;
    }
    try {
        const receiptRef = getFeeDocRef(activeFinancialYear, 'receipts', receiptNo);
        await updateDoc(receiptRef, { isCancelled: true });
        showAlert('Receipt cancelled successfully!', 'success');
        // Re-render recent receipts list (listener will handle data update)
        renderRecentReceipts();
    } catch (error) {
        console.error('Error cancelling receipt:', error);
        showAlert('Failed to cancel receipt.', 'danger');
    }
};


// Add this event listener inside your main script block

document.getElementById('pay-online-btn')?.addEventListener('click', () => {
    const setup = studentFeeSetups.find(sfs => sfs.id === selectedUser.id);
    const payments = receipts.filter(r => r.studentId === selectedUser.id && !r.isCancelled);
    const totalPaid = payments.reduce((sum, p) => sum + p.totalAmount, 0);
    const balance = setup ? (setup.totalPayable - totalPaid) : 0;

    document.getElementById('modal-balance-due').textContent = `â‚¹ ${balance.toFixed(2)}`;
    const amountInput = document.getElementById('payment-amount');
    amountInput.value = balance.toFixed(2);
const generateUniqueTransactionId = () => {
    // This should be as unique as possible, a timestamp plus a random number is a good client-side method.
    return `TXN${Date.now()}${Math.floor(Math.random() * 10000)}`;
};

  // This function goes inside the 'pay-online-btn' event listener
// This function goes inside the 'pay-online-btn' event listener
const generateQRCode = () => {
    const amountInput = document.getElementById('payment-amount');
    const amount = parseFloat(amountInput.value);
    const qrContainer = document.getElementById('qr-code-container');
    const upiLinkButton = document.getElementById('pay-with-upi-app-btn');
    const upiUriDisplay = document.getElementById('upi-uri-display');

    // **IMPROVEMENT**: If amount is invalid, show a message instead of a blank box.
    if (isNaN(amount) || amount <= 0) {
        qrContainer.innerHTML = '<p class="text-center text-muted" style="padding-top: 5rem;">Enter a valid amount to generate the QR Code.</p>';
        upiLinkButton.href = '#'; // Disable the mobile payment link
        upiLinkButton.classList.add('disabled'); // Add disabled style
        upiUriDisplay.textContent = 'UPI link will appear here.';
        return;
    }

    // If amount is valid, enable the button
    upiLinkButton.classList.remove('disabled');

    // **CRUCIAL CHANGE:** Use the verified Merchant UPI ID and Merchant Name
    const merchantUpiId = 'school.payments@icici'; // A new, verified merchant UPI ID
    const payeeName = 'St. Marys School';       // The official registered name
    
    const transactionRefId = generateUniqueTransactionId();
    const transactionNote = `Fee Payment for Admn No: ${selectedUser.admissionNumber}`;
    
    // **CRUCIAL CHANGE:** Use the official Merchant Category Code (MCC)
    const merchantCode = '8299'; // This is a real MCC for educational services.

    // The UPI deep link with all the correct, verified parameters
    //const upiURI = `upi://pay?pa=${merchantUpiId}&pn=${encodeURIComponent(payeeName)}&am=${amount.toFixed(2)}&cu=INR&tn=${encodeURIComponent(transactionNote)}&tr=${transactionRefId}&mc=${merchantCode}`;
const upiURI = "upi://pay?pa=9744405521@sbi&pn=Najmul%20Huda%20Sangham%20Orphanage%20Committee&mc=8211&tr=&tn=&am=&cu=INR&url=&mode=02&purpose=00&orgid=159002&sign=MEUCIQDB7Ng+eGLXexdeCM/d1S9mRTs/x1BeIl5jCnvByiKxFgIgRThcUDqeS5ktFwHwQzMCEe0sVQcpHaLGe+iJe6SElh8="
    // --- Update QR Code ---
    qrContainer.innerHTML = ''; // Clear previous content
    new QRCode(qrContainer, {
        text: upiURI,
        width: 220,
        height: 220,
    });
    upiUriDisplay.textContent = upiURI;

    // --- Update the Mobile Button Link ---
    upiLinkButton.href = upiURI;
};
    // Generate initial QR code and add listener for amount changes
    generateQRCode();
    amountInput.addEventListener('input', generateQRCode);
});

// Add this event listener inside your main script block

document.getElementById('confirm-payment-btn')?.addEventListener('click', async () => {
    const amount = parseFloat(document.getElementById('payment-amount').value);
    const transactionId = document.getElementById('upi-transaction-id').value.trim();

    if (!transactionId) {
        showAlert('Please enter the UPI Transaction ID (UTR) to confirm.', 'danger');
        return;
    }

    const paymentData = {
        studentId: selectedUser.id,
        studentName: selectedUser.name,
        classId: selectedUser.classId,
        division: selectedUser.division,
        amount: amount,
        transactionId: transactionId,
        submissionDate: new Date().toISOString(),
        financialYear: activeFinancialYear,
        status: 'pending' // Initial status
    };

    try {
        // The document ID will be the unique transaction ID
        await setDoc(getDocRef('pendingPayments', transactionId), paymentData);
        showAlert('Payment submitted for verification! It will reflect in your account once approved by the office.', 'success');
        bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
    } catch (error) {
        console.error("Error submitting payment for verification:", error);
        showAlert('Could not submit payment. Please try again.', 'danger');
    }
});

// Function to render the new verification tab
function renderPaymentVerificationTab() {
    const container = document.getElementById('fee-verification-tab'); // The new tab pane
    container.innerHTML = '<h5>Loading pending payments...</h5>';

    const pending = pendingPayments.filter(p => p.status === 'pending');

    if (pending.length === 0) {
        container.innerHTML = '<p class="text-muted p-4">No payments are pending for verification.</p>';
        return;
    }

    container.innerHTML = `
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Class</th>
                    <th>Amount</th>
                    <th>Transaction ID (UTR)</th>
                    <th>Submitted On</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${pending.map(p => `
                    <tr>
                        <td>${p.studentName}</td>
                        <td>${p.classId}-${p.division}</td>
                        <td>â‚¹ ${p.amount.toFixed(2)}</td>
                        <td>${p.transactionId}</td>
                        <td>${new Date(p.submissionDate).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="approvePayment('${p.transactionId}')">Approve</button>
                            <button class="btn btn-sm btn-danger" onclick="rejectPayment('${p.transactionId}')">Reject</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// Add `approvePayment` and `rejectPayment` functions globally
window.approvePayment = async (transactionId) => {
    // This is a complex action: 
    // 1. Get the pending payment data.
    // 2. Create a new document in the `receipts` collection.
    // 3. Update the `pendingPayments` document status to 'approved'.
    // This should be done in a Firestore transaction to ensure atomicity.
    showAlert(`Payment ${transactionId} approved. A new receipt has been generated.`, 'success');
    // (Full implementation requires writing the Firestore transaction logic)
};

window.rejectPayment = async (transactionId) => {
    // 1. Update the `pendingPayments` document status to 'rejected'.
    await updateDoc(getDocRef('pendingPayments', transactionId), { status: 'rejected' });
    showAlert(`Payment ${transactionId} has been rejected.`, 'warning');
};

        window.renderMyFees = () => {
    const setup = studentFeeSetups.find(sfs => sfs.id === selectedUser.id);
    const payments = receipts.filter(r => r.studentId === selectedUser.id && !r.isCancelled);
    let totalPaid = 0;
    payments.forEach(p => totalPaid += p.totalAmount);
    const balance = setup ? (setup.totalPayable - totalPaid) : 0;

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">My Fee Status (${activeFinancialYear})</h1>
        <div class="row">
           <div class="col-md-4"><div class="card text-white bg-primary mb-3"><div class="card-body"><h5 class="card-title">Total Payable</h5><p class="card-text fs-4 fw-bold">â‚¹ ${setup?.totalPayable.toFixed(2) || '0.00'}</p></div></div></div>
           <div class="col-md-4"><div class="card text-white bg-success mb-3"><div class="card-body"><h5 class="card-title">Total Paid</h5><p class="card-text fs-4 fw-bold">â‚¹ ${totalPaid.toFixed(2)}</p></div></div></div>
           <div class="col-md-4"><div class="card text-white bg-danger mb-3"><div class="card-body"><h5 class="card-title">Balance Due</h5><p class="card-text fs-4 fw-bold">â‚¹ ${balance.toFixed(2)}</p></div></div></div>
        </div>

        <div class="text-center mt-4">
            <button id="pay-online-btn" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#paymentModal">
                <i class="fas fa-qrcode me-2"></i>Pay Online via UPI
            </button>
        </div>

        <div class="card shadow mt-4">
           <div class="card-header fw-bold">Fee Breakdown</div>
           <div class="card-body">
               ${setup ? `
               <table class="table">
                   <tbody>
                       <tr><th>Arrears from Previous Year</th><td>â‚¹ ${setup.arrears?.toFixed(2) || '0.00'}</td></tr>
                       <tr><th>Tuition Fee (Term 1/2/3)</th><td>â‚¹ ${setup.tf1?.toFixed(2)} / ${setup.tf2?.toFixed(2)} / ${setup.tf3?.toFixed(2)}</td></tr>
                       <tr><th>Vehicle Fee (Term 1/2/3)</th><td>â‚¹ ${setup.vf1?.toFixed(2)} / ${setup.vf2?.toFixed(2)} / ${setup.vf3?.toFixed(2)}</td></tr>
                       <tr><th>Exam Fee</th><td>â‚¹ ${setup.examFee?.toFixed(2) || '0.00'}</td></tr>
                       <tr class="text-danger"><th>Concession</th><td>- â‚¹ ${setup.concession?.toFixed(2) || '0.00'}</td></tr>
                   </tbody>
               </table>` : '<p class="text-muted">Your fee structure has not been set up for this year.</p>'}
           </div>
        </div>
        <div class="card shadow mt-4">
           <div class="card-header fw-bold">Payment History</div>
           <div class="card-body">
                ${payments.length > 0 ? `
                   <table class="table table-striped">
                       <thead><tr><th>Receipt No</th><th>Date</th><th>Amount</th><th>Status</th></tr></thead>
                       <tbody>${payments.map(p => `<tr><td>${p.id}</td><td>${new Date(p.date).toLocaleDateString()}</td><td>â‚¹ ${p.totalAmount.toFixed(2)}</td><td><span class="badge bg-${p.isCancelled ? 'danger' : 'success'}">${p.isCancelled ? 'Cancelled' : 'Paid'}</span></td></tr>`).join('')}</tbody>
                   </table>
                ` : '<p class="text-muted">No payments recorded for this year.</p>'}
           </div>
        </div>
        `;

    // --- SOLUTION: ATTACH THE LISTENER AND DEFINE ITS FUNCTIONS HERE ---
    const payOnlineBtn = document.getElementById('pay-online-btn');
    if (payOnlineBtn) {
        payOnlineBtn.addEventListener('click', () => {
            const amountInput = document.getElementById('payment-amount');
            amountInput.value = balance.toFixed(2);
            document.getElementById('modal-balance-due').textContent = `â‚¹ ${balance.toFixed(2)}`;
const generateUniqueTransactionId = () => {
    // This should be as unique as possible, a timestamp plus a random number is a good client-side method.
    return `TXN${Date.now()}${Math.floor(Math.random() * 10000)}`;
};


            const generateQRCode = () => {
                const amount = parseFloat(amountInput.value);
                const qrContainer = document.getElementById('qr-code-container');
                const upiLinkButton = document.getElementById('pay-with-upi-app-btn');
                const upiUriDisplay = document.getElementById('upi-uri-display');

                if (isNaN(amount) || amount <= 0) {
                    qrContainer.innerHTML = '<p class="text-center text-muted" style="padding-top: 5rem;">Enter a valid amount to generate the QR Code.</p>';
                    if (upiLinkButton) {
                        upiLinkButton.href = '#';
                        upiLinkButton.classList.add('disabled');
                    }
                    upiUriDisplay.textContent = 'UPI link will appear here.';
                    return;
                }

                if (upiLinkButton) upiLinkButton.classList.remove('disabled');
                const transactionRefId = generateUniqueTransactionId();
                const transactionNote = `Fee Payment for Admn No: ${selectedUser.admissionNumber}`;
    
                // **CRUCIAL CHANGE:** Use the official Merchant Category Code (MCC)
                const merchantCode = '8299'; // This is a real MCC for educational services.

                //const transactionNote = `ADMN${selectedUser.admissionNumber}-PYMT-${Date.now()}`;
                //const upiURI = `upi://pay?pa=${schoolDetails.upiId}&pn=${encodeURIComponent(schoolDetails.upiPayeeName)}&am=${amount.toFixed(2)}&cu=INR&tn=${transactionNote}`;
                const upiURI = `upi://pay?pa=${schoolDetails.upiId}&pn=${encodeURIComponent(schoolDetails.upiPayeeName)}&am=${amount.toFixed(2)}&cu=INR&tn=${encodeURIComponent(transactionNote)}`; //&tr=${transactionRefId}&mc=${merchantCode}

                qrContainer.innerHTML = '';
                new QRCode(qrContainer, { text: upiURI, width: 220, height: 220 });
                upiUriDisplay.textContent = upiURI;
                if (upiLinkButton) upiLinkButton.href = upiURI;
            };

            generateQRCode(); // Generate initial QR code when modal opens
            amountInput.addEventListener('input', generateQRCode); // Update QR code on amount change
        });
    }
};

        function attachFeeStructureFormListeners() {
    const form = document.getElementById('fee-structure-form');
    if (!form) return;
    const headSelect = document.getElementById('fs-head');
    const dynamicContainer = document.getElementById('fs-dynamic-container');
    const isEditMode = feeStructureToEdit !== null;

    // Elements for dynamic fields (will be assigned after renderDynamicFields)
    let fsClassSelect, fsDivisionSelect, fsStageInput, fsTerm1Input, fsTerm2Input, fsTerm3Input, fsAmountInput;

    const renderDynamicFields = (head, dataToFill = {}) => {
        let html = '';
        if (head === 'TUITION FEE' || head === 'EXAM FEE') {
            // Class dropdown (single select)
            html += `<div class="mb-3">
                        <label class="form-label">Class</label>
                        <select id="fs-class" class="form-select" required>
                            <option value="">-- Select Class --</option>
                            ${classes.map(c => `<option value="${c.id}" ${dataToFill.classId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                        </select>
                        <div class="invalid-feedback">Please select a class.</div>
                    </div>`;

            // Divisions dropdown (MULTIPLE select)
            html += `<div class="mb-3">
                        <label class="form-label">Divisions <small>(Select one or more)</small></label>
                        <select id="fs-division" class="form-select" multiple required style="min-height: 100px;">
                            </select>
                        <div class="invalid-feedback">Please select at least one division.</div>
                    </div>`;

        } else if (head === 'VEHICLE FEE') {
            html += `<div class="mb-3">
                        <label class="form-label">Vehicle Stage</label>
                        <input id="fs-stage" class="form-control" placeholder="e.g., ROUTE 1" value="${dataToFill.stage || ''}" required>
                        <div class="invalid-feedback">Vehicle stage is required.</div>
                    </div>`;
        }
        
        if (head === 'TUITION FEE' || head === 'VEHICLE FEE') {
            html += `<div class="row">
                        <div class="col"><label class="form-label">Term 1</label><input type="number" id="fs-term1" class="form-control" value="${dataToFill.term1_amount || ''}" required></div>
                        <div class="col"><label class="form-label">Term 2</label><input type="number" id="fs-term2" class="form-control" value="${dataToFill.term2_amount || ''}" required></div>
                        <div class="col"><label class="form-label">Term 3</label><input type="number" id="fs-term3" class="form-control" value="${dataToFill.term3_amount || ''}" required></div>
                        <div class="invalid-feedback">Term amounts are required.</div>
                    </div>`;
        } else if (head === 'EXAM FEE') {
            html += `<div class="mb-3">
                        <label class="form-label">Annual Amount</label>
                        <input type="number" id="fs-amount" class="form-control" value="${dataToFill.amount || ''}" required>
                        <div class="invalid-feedback">Annual amount is required.</div>
                    </div>`;
        }
        dynamicContainer.innerHTML = html;

        // --- Get References to Newly Rendered Dynamic Elements ---
        fsClassSelect = document.getElementById('fs-class');
        fsDivisionSelect = document.getElementById('fs-division'); // This is the multiple select
        fsStageInput = document.getElementById('fs-stage');
        fsTerm1Input = document.getElementById('fs-term1');
        fsTerm2Input = document.getElementById('fs-term2');
        fsTerm3Input = document.getElementById('fs-term3');
        fsAmountInput = document.getElementById('fs-amount');

        // --- Attach Listener for Class Dropdown to Update Divisions ---
        if (fsClassSelect) {
            fsClassSelect.addEventListener('change', () => {
                const selectedClass = classes.find(c => c.id === fsClassSelect.value);
                fsDivisionSelect.innerHTML = ''; // Clear existing options

                if (selectedClass && selectedClass.divisions) {
                    selectedClass.divisions.map(d => {
                        const option = document.createElement('option');
                        option.value = d;
                        option.textContent = d;
                        // For edit mode, select the divisions that are part of this feeStructureToEdit
                        if (isEditMode && feeStructureToEdit.divisions && feeStructureToEdit.divisions.includes(d)) {
                            option.selected = true;
                        }
                        fsDivisionSelect.appendChild(option);
                    });
                }
            });
            // Trigger change event to populate divisions initially (if class is pre-selected in edit mode)
            fsClassSelect.dispatchEvent(new Event('change'));
        }
    };

    // --- PRE-FILL LOGIC FOR EDIT MODE ---
    if (isEditMode) {
        headSelect.value = feeStructureToEdit.feeHead;
        headSelect.disabled = true; // Disable fee head in edit mode as it's part of the ID
        renderDynamicFields(feeStructureToEdit.feeHead, feeStructureToEdit);
    } else {
        form.reset(); // Clear form for new entry
        dynamicContainer.innerHTML = ''; // Clear dynamic fields
        headSelect.disabled = false; // Enable fee head for new entry
    }

    headSelect.addEventListener('change', () => renderDynamicFields(headSelect.value));

    // --- Cancel Edit Button Listener ---
    const cancelEditBtn = document.getElementById('cancel-fee-edit-btn');
    if (cancelEditBtn) {
        cancelEditBtn.addEventListener('click', () => {
            feeStructureToEdit = null; // Clear edit state
            renderFeeStructureTab(); // Re-render to switch to Add mode
        });
    }

    // --- Form Submission Logic ---
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonHtml = submitButton.innerHTML;

        // Client-side validation
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            showAlert('Please fill in all required fields.', 'warning');
            return;
        }
        form.classList.add('was-validated'); // Apply validation styles even if valid

        submitButton.disabled = true;
        submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...`;

        try {
            const feeHead = headSelect.value; // Always get from the (possibly disabled) dropdown for current context
            const batch = writeBatch(db); // Use batch for multiple division saves

            let structuresToSave = []; // Array to hold all structure objects to save
            let affectedDocIds = new Set(); // Keep track of all doc IDs involved in the update

            if (feeHead === 'TUITION FEE' || feeHead === 'EXAM FEE') {
                const classId = fsClassSelect.value;
                const selectedDivisions = Array.from(fsDivisionSelect.selectedOptions).map(option => option.value);

                if (selectedDivisions.length === 0) {
                    showAlert('Please select at least one division.', 'warning');
                    return; // Stop submission
                }

                // Prepare data for each selected division
                selectedDivisions.forEach(division => {
                    const docId = `${feeHead.replace(' ', '_')}_${classId}_${division}`;
                    affectedDocIds.add(docId); // Add this docId to set
                    
                    let structureData = { 
                        financialYear: activeFinancialYear, 
                        feeHead, 
                        appliesTo: 'CLASS', 
                        classId, 
                        division // Store individual division here
                    };

                    if (feeHead === 'TUITION FEE') {
                        structureData = { ...structureData, term: 'TERM_BASED', 
                                          term1_amount: parseFloat(fsTerm1Input.value) || 0, 
                                          term2_amount: parseFloat(fsTerm2Input.value) || 0, 
                                          term3_amount: parseFloat(fsTerm3Input.value) || 0 };
                    } else { // EXAM FEE
                        structureData = { ...structureData, term: 'ANNUAL', 
                                          amount: parseFloat(fsAmountInput.value) || 0 };
                    }
                    structuresToSave.push({ id: docId, data: structureData });
                });

                // --- Handle Deletion of Unselected Divisions in Edit Mode ---
                if (isEditMode) {
                    const originalClassId = feeStructureToEdit.classId;
                    const originalDivisions = feeStructureToEdit.divisions || []; // Original divisions for this feeHead/classId
                    
                    // Filter out existing structures for this feeHead/classId that are NOT in the newly selected divisions
                    const structuresToDelete = feeStructures.filter(s =>
                        s.financialYear === activeFinancialYear &&
                        s.feeHead === feeHead &&
                        s.classId === originalClassId &&
                        s.division && // Ensure it has a division
                        !selectedDivisions.includes(s.division) // If this original division is NOT among the newly selected
                    );

                    structuresToDelete.forEach(s => {
                        batch.delete(getFeeDocRef(activeFinancialYear, 'feeStructures', s.id));
                        affectedDocIds.delete(s.id); // Remove from affected if deleted
                    });
                }


            } else if (feeHead === 'VEHICLE FEE') {
                const stage = fsStageInput.value;
                if (!stage) { showAlert('Please enter a vehicle stage.', 'danger'); return; }

                const docId = `VEHICLE_FEE_${stage.replace(/\s+/g, '_')}`;
                affectedDocIds.add(docId); // Add this docId to set

                let structureData = { 
                    financialYear: activeFinancialYear, 
                    feeHead, 
                    appliesTo: 'VEHICLE', 
                    stage, 
                    term: 'TERM_BASED', 
                    term1_amount: parseFloat(fsTerm1Input.value) || 0, 
                    term2_amount: parseFloat(fsTerm2Input.value) || 0, 
                    term3_amount: parseFloat(fsTerm3Input.value) || 0 
                };
                structuresToSave.push({ id: docId, data: structureData });

                // If in edit mode, and vehicle fee structure ID changed (unlikely but possible if stage changes)
                // This scenario might need manual old doc deletion or more complex ID management.
                // For now, it will simply set a new document and leave the old one if stage ID changes.
                // If stage is part of the ID and stage is editable, it's generally better to prevent editing ID part.
                // Or: if editing, check if original ID is different from new generated one, delete old if so.
                // For simplicity, current logic just updates/creates at new ID.
            }

            // Perform batch writes for all prepared structures
            structuresToSave.forEach(s => {
                batch.set(getFeeDocRef(activeFinancialYear, 'feeStructures', s.id), s.data);
            });

            await batch.commit();
            showAlert('Fee structure saved successfully!', 'success');
            
            feeStructureToEdit = null; // Clear edit state
            form.reset(); // Reset form
            form.classList.remove('was-validated'); // Clear validation styles
            dynamicContainer.innerHTML = ''; // Clear dynamic fields
            headSelect.disabled = false; // Re-enable fee head dropdown
            headSelect.value = ''; // Reset fee head dropdown
            
        } catch (error) {
            console.error("Error saving fee structure:", error);
            showAlert('Failed to save fee structure. Please try again.', 'danger');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonHtml;
        }
    });
}

        function renderFeeStructuresList() {
    const container = document.getElementById('fee-structures-list');
    if (!container) return;
    
    // Sort fee structures for consistent display
    const sortedFeeStructures = [...feeStructures].sort((a,b) => {
        const headA = a.feeHead || '';
        const headB = b.feeHead || '';
        const classA = classes.find(c => c.id === a.classId)?.name || '';
        const classB = classes.find(c => c.id === b.classId)?.name || '';
        
        // Primary sort by Fee Head
        if (headA !== headB) return headA.localeCompare(headB);
        // Secondary sort by Class Name
        if (classA !== classB) return classA.localeCompare(classB);
        // Tertiary sort by Division (if applicable)
        if (a.division && b.division) return a.division.localeCompare(b.division);
        // Fallback for stage if it's vehicle fee
        if (a.stage && b.stage) return a.stage.localeCompare(b.stage);
        return 0;
    });


    if (sortedFeeStructures.length === 0) {
        container.innerHTML = `<p class="text-muted text-center p-5">No fee structures defined for ${activeFinancialYear}.</p>`;
        return;
    }

    container.innerHTML = `<h5 class="mb-3">Existing Structures for ${activeFinancialYear}</h5>
        <ul class="list-group">
            ${sortedFeeStructures.map(s => {
                let details = '';
                let amountsHtml = '';

                if (s.appliesTo === 'CLASS') {
                    // Display class and division for class-based fees
                    details = `Class: ${classes.find(c => c.id === s.classId)?.name || 'N/A'} - Div: ${s.division || 'N/A'}`;
                } else if (s.appliesTo === 'VEHICLE') {
                    details = `Stage: ${s.stage}`;
                }

                if (s.term === 'TERM_BASED') {
                    amountsHtml = `
                        <p class="mb-0 text-sm text-muted">
                            Term 1: â‚¹${(s.term1_amount || 0).toFixed(2)} | 
                            Term 2: â‚¹${(s.term2_amount || 0).toFixed(2)} | 
                            Term 3: â‚¹${(s.term3_amount || 0).toFixed(2)}
                        </p>`;
                } else if (s.term === 'ANNUAL') {
                    amountsHtml = `<p class="mb-0 text-sm text-muted">Annual Amount: â‚¹${(s.amount || 0).toFixed(2)}</p>`;
                }

                return `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0"><strong>${s.feeHead}</strong> <small class="text-muted">(${details})</small></h6>
                            ${amountsHtml}
                        </div>
                        <div>
                            <button onclick="window.handleEditFeeStructure('${s.id}')" class="btn btn-sm btn-outline-primary me-2" title="Edit Fee Structure">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="window.handleDeleteFeeStructure('${s.id}')" class="btn btn-sm btn-outline-danger" title="Delete Fee Structure">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </li>`;
            }).join('')}
        </ul>`;
}

// Assume feeStructures global array contains documents like:
// { id: 'TUITION_FEE_CLASSX_A', feeHead: 'TUITION FEE', classId: 'CLASSX', division: 'A', ...amounts }
// { id: 'TUITION_FEE_CLASSX_B', feeHead: 'TUITION FEE', classId: 'CLASSX', division: 'B', ...amounts }

window.handleEditFeeStructure = (id) => {
    const selectedFeeStructure = feeStructures.find(fs => fs.id === id);
    if (selectedFeeStructure) {
        // When editing a class-division specific fee, we need to find ALL associated divisions
        // that share the same feeHead, financialYear, and classId.
        let relevantStructures = [];
        if (selectedFeeStructure.appliesTo === 'CLASS') {
            relevantStructures = feeStructures.filter(fs =>
                fs.financialYear === selectedFeeStructure.financialYear &&
                fs.feeHead === selectedFeeStructure.feeHead &&
                fs.classId === selectedFeeStructure.classId
            );
        } else { // For VEHICLE type, it's just the one selected
            relevantStructures = [selectedFeeStructure];
        }

        // Create a temporary object for editing that contains all relevant divisions
        feeStructureToEdit = {
            ...selectedFeeStructure, // Copy original properties
            // Add an array of all divisions for this class/fee head combination
            divisions: relevantStructures
                        .filter(s => s.division) // Only include items that actually have a division
                        .map(s => s.division)
        };

        renderFeeStructureTab(); // Re-render the form with pre-filled data
    } else {
        showAlert('Fee structure not found for editing.', 'danger');
        console.warn('Fee structure not found for editing:', id);
    }
};

/**
 * Deletes a fee structure from Firestore.
 * @param {string} id - The ID of the fee structure to delete.
 */
window.handleDeleteFeeStructure = async (id) => {
    if (confirm("Are you sure you want to delete this fee structure? This action cannot be undone.")) {
        try {
            // Use getFeeDocRef with the correct financial year and collection name
            await deleteDoc(getFeeDocRef(activeFinancialYear, 'feeStructures', id));
            showAlert('Fee structure deleted successfully.', 'success');
            // The real-time listener should automatically re-render the list.
        } catch (error) {
            console.error('Error deleting fee structure:', error);
            showAlert('Failed to delete fee structure. Please try again.', 'danger');
        }
    }
};


        async function attachStudentFeeSetupListeners() {
    const sfsClassSelect = document.getElementById('sfs-class');
    const sfsDivisionSelect = document.getElementById('sfs-division');
    const sfsFetchBtn = document.getElementById('sfs-fetch-btn');
    const sfsStatusDiv = document.getElementById('sfs-status');
    const sfsTableContainer = document.getElementById('sfs-table-container');
    const sfsSaveAllBtn = document.getElementById('sfs-save-all-btn');

    // Populate Divisions based on Class selection
    sfsClassSelect.addEventListener('change', () => {
        const selectedClassId = sfsClassSelect.value;
        sfsDivisionSelect.innerHTML = '<option value="">-- Select Division --</option>';
        sfsDivisionSelect.disabled = true;
        if (selectedClassId) {
            const selectedClass = classes.find(c => c.id === selectedClassId);
            if (selectedClass && selectedClass.divisions) {
                selectedClass.divisions.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d;
                    option.textContent = d;
                    sfsDivisionSelect.appendChild(option);
                });
                sfsDivisionSelect.disabled = false;
            }
        }
    });

    // --- Fetch Students and Render Table ---
    sfsFetchBtn.addEventListener('click', async () => {
        const classId = sfsClassSelect.value;
        const division = sfsDivisionSelect.value;

        if (!classId) {
            showAlert('Please select a Class to fetch students.', 'warning');
            return;
        }

        sfsStatusDiv.textContent = 'Fetching students...';
        sfsTableContainer.innerHTML = ''; // Clear previous table
        sfsSaveAllBtn.style.display = 'none'; // Hide bulk save button initially

        try {
            // Fetch students based on filters
            let filteredStudents = students.filter(s => s.classId === classId);
            if (division) {
                filteredStudents = filteredStudents.filter(s => s.division === division);
            }

            if (filteredStudents.length === 0) {
                sfsStatusDiv.textContent = 'No students found for the selected criteria.';
                return;
            }

            sfsStatusDiv.textContent = `Found ${filteredStudents.length} students. Generating fee setup table...`;

            // Fetch the general fee structure rules (e.g., from 'feeStructures' collection)
            // This is crucial for auto-filling
            const feeStructureRules = feeStructures;// getFeeStructureRules(activeFinancialYear); 
            // This 'getFeeStructureRules' would fetch documents from your 'feeStructures' collection
            // It should return an array or map of rules: [{ feeHead: 'TUITION FEE', classId: 'CLASS_10', division: 'A', term1_amount: 4000 }, ...]

            let tableHtml = `
                <table id="sfs-table" class="table table-bordered table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Admission No.</th>
                            <th>Class - Div</th>
                            <th>Arrears</th>
                            <th>Admission Fee</th>
                            <th>tutionT1</th><th>tutionT2</th><th>tutionT3</th>
                            <th>vehicleV1</th><th>vehicleV2</th><th>vehicleV3</th>
                            <th>Exam</th>
                            <th>Concession</th>
                            <th>Total Payable</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const student of filteredStudents) {
                // Get existing fee setup for this student for the activeFinancialYear
                // This comes from the embedded data in the student document
                const existingFeeSetup = student.feeDetails?.[activeFinancialYear] || {};

                // Auto-fill based on general fee structure rules
                let autoFilledFees = {};
                // Find relevant rules for this student's class, division, and vehicle stage
                const relevantRules = feeStructureRules.filter(rule => 
                    (rule.appliesTo === 'CLASS' && rule.classId === student.classId && rule.division === student.division) ||
                    (rule.appliesTo === 'VEHICLE' && rule.stage === student.vehicleStage)
                );
                console.log('releventrulse',relevantRules);
                // Initialize with existing values or 0
                autoFilledFees = {
                    arrears: existingFeeSetup.arrears || 0, // This should come from arrears reconciliation or carried forward
                    admissionFee: existingFeeSetup.admissionFee || 0,
                    tf1: existingFeeSetup.tf1 || 0, tf2: existingFeeSetup.tf2 || 0, tf3: existingFeeSetup.tf3 || 0,
                    vf1: existingFeeSetup.vf1 || 0, vf2: existingFeeSetup.vf2 || 0, vf3: existingFeeSetup.vf3 || 0,
                    examFee: existingFeeSetup.examFee || 0,
                    concession: existingFeeSetup.concession || 0,
                    totalPayable: existingFeeSetup.totalPayable || 0 // Will be recalculated by save functions
                };

                // Apply rules, prioritizing existing data if available
                relevantRules.forEach(rule => {
                    if (rule.feeHead === 'TUITION FEE') {
                        autoFilledFees.tf1 = existingFeeSetup.tf1 !== undefined ? existingFeeSetup.tf1 : rule.term1_amount || 0;
                        autoFilledFees.tf2 = existingFeeSetup.tf2 !== undefined ? existingFeeSetup.tf2 : rule.term2_amount || 0;
                        autoFilledFees.tf3 = existingFeeSetup.tf3 !== undefined ? existingFeeSetup.tf3 : rule.term3_amount || 0;
                    } else if (rule.feeHead === 'VEHICLE FEE') {
                        autoFilledFees.vf1 = existingFeeSetup.vf1 !== undefined ? existingFeeSetup.vf1 : rule.term1_amount || 0;
                        autoFilledFees.vf2 = existingFeeSetup.vf2 !== undefined ? existingFeeSetup.vf2 : rule.term2_amount || 0;
                        autoFilledFees.vf3 = existingFeeSetup.vf3 !== undefined ? existingFeeSetup.vf3 : rule.term3_amount || 0;
                    } else if (rule.feeHead === 'EXAM FEE') {
                        autoFilledFees.examFee = existingFeeSetup.examFee !== undefined ? existingFeeSetup.examFee : rule.amount || 0;
                    }
                    // You might need to add other fee heads like 'Admission Fee' here if they are part of rules
                });

                // Calculate initial total payable for display (will be recalculated on save)
                let rowTotalPayable = (autoFilledFees.arrears || 0) +
                                      (autoFilledFees.admissionFee || 0) +
                                      (autoFilledFees.tf1 || 0) + (autoFilledFees.tf2 || 0) + (autoFilledFees.tf3 || 0) +
                                      (autoFilledFees.vf1 || 0) + (autoFilledFees.vf2 || 0) + (autoFilledFees.vf3 || 0) +
                                      (autoFilledFees.examFee || 0) - (autoFilledFees.concession || 0);


                tableHtml += `
                    <tr data-student-id="${student.id}">
                        <td>${student.name}</td>
                        <td>${student.admissionNumber}</td>
                        <td>${student.classId} - ${student.division}</td>
                        <td><input type="number" class="form-control sfs-input sfs-arrears" data-fee="arrears" value="${autoFilledFees.arrears.toFixed(2)}" disabled></td>
                        <td><input type="number" class="form-control sfs-input sfs-admissionFee" data-fee="admissionFee" value="${autoFilledFees.admissionFee.toFixed(2)}" disabled></td>
                        <td><input type="number" class="form-control sfs-input sfs-tf1" data-fee="tf1" value="${autoFilledFees.tf1.toFixed(2)}" disabled></td>
                        <td><input type="number" class="form-control sfs-input sfs-tf2" data-fee="tf2" value="${autoFilledFees.tf2.toFixed(2)}" disabled></td>
                        <td><input type="number" class="form-control sfs-input sfs-tf3" data-fee="tf3" value="${autoFilledFees.tf3.toFixed(2)}" disabled></td>
                        <td><input type="number" class="form-control sfs-input sfs-vf1" data-fee="vf1" value="${autoFilledFees.vf1.toFixed(2)}" disabled></td>
                        <td><input type="number" class="form-control sfs-input sfs-vf2" data-fee="vf2" value="${autoFilledFees.vf2.toFixed(2)}" disabled></td>
                        <td><input type="number" class="form-control sfs-input sfs-vf3" data-fee="vf3" value="${autoFilledFees.vf3.toFixed(2)}" disabled></td>
                        <td><input type="number" class="form-control sfs-input sfs-examFee" data-fee="examFee" value="${autoFilledFees.examFee.toFixed(2)}" disabled></td>
                        <td><input type="number" class="form-control sfs-input sfs-concession" data-fee="concession" value="${autoFilledFees.concession.toFixed(2)}" disabled></td>
                        <td class="sfs-total-payable">${rowTotalPayable.toFixed(2)}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary sfs-edit-btn">Edit</button>
                            <button type="button" class="btn btn-sm btn-success sfs-save-btn d-none">Save</button>
                            <button type="button" class="btn btn-sm btn-secondary sfs-cancel-btn d-none">Cancel</button>
                        </td>
                    </tr>
                `;
            }

            tableHtml += `</tbody></table>`;
            sfsTableContainer.innerHTML = tableHtml;
            sfsStatusDiv.textContent = ''; // Clear status

            // **Attach the per-row listeners after the table is rendered**
            attachFeeSetupTableListeners(activeFinancialYear); // Pass activeFinancialYear
            sfsSaveAllBtn.style.display = 'block'; // Show bulk save button if desired

        } catch (error) {
            console.error("Error fetching students or rendering fee setup table:", error);
            sfsStatusDiv.textContent = 'Error loading data. Please try again.';
            showAlert('Error loading student fee data.', 'danger');
        }
    });

    // Function to fetch general fee structure rules (placeholder)
    // You need to implement this based on how your 'feeStructures' collection is set up
    async function getFeeStructureRules(financialYear) {
        try {
            const rulesCollectionRef = collection(db, `/artifacts/${appId}/public/data/feeStructures`);
            const q = query(rulesCollectionRef, where("financialYear", "==", financialYear));
            const querySnapshot = await getDocs(q);
            return querySnapshot.docs.map(doc => doc.data());
        } catch (error) {
            console.error("Error fetching fee structure rules:", error);
            return []; // Return empty array on error
        }
    }

    // You might also want to attach the `saveAllFeeSetups` listener here if you want to keep that functionality
    sfsSaveAllBtn.addEventListener('click', async () => {
        // Your existing saveAllFeeSetups logic (updated to use the student.feeDetails embedding)
        // Ensure this function (saveAllFeeSetups) is defined and available
        await saveAllFeeSetups(activeFinancialYear);
        // After bulk save, re-render the current view to reflect changes and reset buttons
        // Triggering the fetch button again is a simple way to refresh the entire table
        sfsFetchBtn.click();
    });
}
    
        // 2. This function fetches data and renders the editable fee table
// 2. This function fetches data and renders the editable fee table
async function generateAndDisplayFeeSetup(fy, classId, division) {
    const container = document.getElementById('sfs-status');
    container.innerHTML = '<p class="text-center text-gray-500"><i class="fas fa-spinner fa-spin"></i> Fetching student data and calculating fees...</p>';
console.log(students);
    const studentsInClass = students.filter(s => s.classId === classId && s.division === division && s.status !== 'TC Issued').sort((a, b) => a.name.localeCompare(b.name));
       if (studentsInClass.length === 0) {
        container.innerHTML = '<p class="text-center text-red-500">No students found in this class.</p>';
        return;
    }

    // Prepare a data structure to hold the final fee setup for each student
    const studentFeeData = studentsInClass.map(student => {
        // First, check if a setup already exists for this student this year
        let savedSetup = studentFeeSetups.find(sfs => sfs.id === student.id);

        if (savedSetup) {
            // If it exists, use the saved data, but ensure student object is also passed
            return { student, ...savedSetup };
        } else {
            // If not, calculate the default fees from the Fee Structure
            // Find tuition fee for the class
            const tuitionFeeStructures = feeStructures.filter(fs =>
                fs.financialYear === fy &&
                fs.feeHead === 'TUITION FEE' &&
                fs.classId === classId &&
                // IMPORTANT: Filter by student's division also if tuition fee is division-specific
                (fs.division === undefined || fs.division === null || fs.division === student.division) // Handle general class fees or division-specific
            );
            // Assuming tuition fee is either per class OR per class-division.
            // If multiple divisions are allowed for tuition fee structures, this needs careful aggregation.
            // For now, let's assume one tuition fee structure per class-division if division is specified,
            // or one per class if division is not specified.
            const tutionFee = tuitionFeeStructures.find(fs => fs.classId === classId && (fs.division === student.division || fs.division === undefined || fs.division === null));

            // Find vehicle fee based on student's vehicleStage
            const vehicleFee = feeStructures.find(fs =>
                fs.financialYear === fy &&
                fs.feeHead === 'VEHICLE FEE' &&
                fs.stage === student.vehicleStage // Assumes student has a 'vehicleStage' property
            );
            
            // Find exam fee for the class (or class-division)
            const examFeeStructures = feeStructures.filter(fs =>
                fs.financialYear === fy &&
                fs.feeHead === 'EXAM FEE' &&
                fs.classId === classId &&
                (fs.division === undefined || fs.division === null || fs.division === student.division)
            );
            const examFee = examFeeStructures.find(fs => fs.classId === classId && (fs.division === student.division || fs.division === undefined || fs.division === null));

            // Special rule for orphans
            const isOrphan = student.isOrphan || false; // Assuming 'isOrphan' property on student object

            return {
                student, // Pass the student object itself
                arrears: 0, // Default to 0 for new setups
                tf1: isOrphan ? 0 : (tutionFee?.term1_amount || 0),
                tf2: isOrphan ? 0 : (tutionFee?.term2_amount || 0),
                tf3: isOrphan ? 0 : (tutionFee?.term3_amount || 0),
                vf1: isOrphan ? 0 : (vehicleFee?.term1_amount || 0),
                vf2: isOrphan ? 0 : (vehicleFee?.term2_amount || 0),
                vf3: isOrphan ? 0 : (vehicleFee?.term3_amount || 0),
                examFee: isOrphan ? 0 : (examFee?.amount || 0), // Exam fee is annual
                concession: 0, // Default to 0 for new setups
            };
        }
    });

    // Render the editable table
    // Updated table headers to include "Vehicle Stage"
    let tableHTML = `
        <p class="text-sm my-4">Found ${studentFeeData.length} students. Review the calculated fees below and make any necessary adjustments.</p>
        <div class="overflow-x-auto">
            <table id="sfs-table" class="w-full text-xs whitespace-nowrap table table-bordered table-striped">
                <thead><tr class="bg-gray-100">
                    <th class="p-2 text-left">Student Name</th>
                    <th>Vehicle Stage</th> <th>Arrears</th>
                    <th>TF1</th><th>TF2</th><th>TF3</th>
                    <th>VF1</th><th>VF2</th><th>VF3</th>
                    <th>Exam Fee</th><th>Concession</th>
                    <th class="font-bold">Total Payable</th>
                </tr></thead>
                <tbody>`;
    
    studentFeeData.forEach(data => {
        // Calculate total dynamically for display
        const total = (data.arrears + data.tf1 + data.tf2 + data.tf3 + data.vf1 + data.vf2 + data.vf3 + data.examFee) - data.concession;
        
        tableHTML += `
            <tr class="border-t" data-student-id="${data.student.id}">
                <td class="p-2 font-medium">${data.student.name}</td>
                <td>${data.student.vehicleStage || 'N/A'}</td> <td><input type="number" class="w-20 p-1 border rounded sfs-input form-control-sm" data-fee="arrears" value="${(data.arrears || 0).toFixed(2)}"></td>
                <td><input type="number" class="w-20 p-1 border rounded sfs-input form-control-sm" data-fee="tf1" value="${(data.tf1 || 0).toFixed(2)}"></td>
                <td><input type="number" class="w-20 p-1 border rounded sfs-input form-control-sm" data-fee="tf2" value="${(data.tf2 || 0).toFixed(2)}"></td>
                <td><input type="number" class="w-20 p-1 border rounded sfs-input form-control-sm" data-fee="tf3" value="${(data.tf3 || 0).toFixed(2)}"></td>
                <td><input type="number" class="w-20 p-1 border rounded sfs-input form-control-sm" data-fee="vf1" value="${(data.vf1 || 0).toFixed(2)}"></td>
                <td><input type="number" class="w-20 p-1 border rounded sfs-input form-control-sm" data-fee="vf2" value="${(data.vf2 || 0).toFixed(2)}"></td>
                <td><input type="number" class="w-20 p-1 border rounded sfs-input form-control-sm" data-fee="vf3" value="${(data.vf3 || 0).toFixed(2)}"></td>
                <td><input type="number" class="w-20 p-1 border rounded sfs-input form-control-sm" data-fee="examFee" value="${(data.examFee || 0).toFixed(2)}"></td>
                <td><input type="number" class="w-20 p-1 border rounded sfs-input text-danger form-control-sm" data-fee="concession" value="${(data.concession || 0).toFixed(2)}"></td>
                <td class="p-2 font-bold text-right align-middle">â‚¹ ${total.toFixed(2)}</td>
            </tr>`;
    });

    tableHTML += `</tbody></table></div><div class="text-center mt-6"><button id="sfs-save-all-btn" class="btn btn-success">Save Setups for All ${studentFeeData.length} Students</button></div>`;
    container.innerHTML = tableHTML;
    
    // Attach listener to the save button
    document.getElementById('sfs-save-all-btn').addEventListener('click', () => saveAllFeeSetups(fy));

    // Optional: Add event listener for input changes to update "Total Payable" column dynamically
    // This requires a more complex setup using event delegation and recalculating the row total.
    // For simplicity, we'll keep it as is, and the total will be recalculated on save.
    // If you want live total update, you'd add:
    document.getElementById('sfs-table').addEventListener('input', (e) => {
        if (e.target.classList.contains('sfs-input')) {
            const row = e.target.closest('tr');
            const inputs = row.querySelectorAll('.sfs-input');
            let rowTotal = 0;
            let rowConcession = 0;
            inputs.forEach(input => {
                const amount = parseFloat(input.value) || 0;
                if (input.dataset.fee === 'concession') {
                    rowConcession = amount;
                } else {
                    rowTotal += amount;
                }
            });
            row.querySelector('.font-bold').textContent = `â‚¹ ${(rowTotal - rowConcession).toFixed(2)}`;
        }
    });
}
// 3. This function reads the editable table and saves all data in a single batch
async function saveAllFeeSetups(fy) {
    const saveButton = document.getElementById('sfs-save-all-btn');
    saveButton.disabled = true; saveButton.innerHTML = 'Saving...';

    const batch = writeBatch(db);
    const studentRows = document.querySelectorAll('#sfs-table tbody tr');

    studentRows.forEach(row => {
        const studentId = row.dataset.studentId;
        const studentDocRef = getFeeDocRef(fy, 'studentFeeSetups', studentId);

        const feeData = { studentId, financialYear: fy };
        let totalPayable = 0;
        const inputs = row.querySelectorAll('.sfs-input');
        
        inputs.forEach(input => {
            const feeType = input.dataset.fee;
            const amount = parseFloat(input.value) || 0;
            feeData[feeType] = amount;
            if (feeType !== 'concession') {
                totalPayable += amount;
            }
        });
        feeData.totalPayable = totalPayable - feeData.concession;

        batch.set(studentDocRef, feeData);
    });

    try {
        await batch.commit();
        alert(`Fee setup for ${studentRows.length} students has been saved successfully!`);
    } catch (error) {
        console.error("Error saving fee setups: ", error);
        alert("An error occurred. Please check the console.");
    } finally {
        saveButton.disabled = false; saveButton.innerHTML = `Save Setups for All ${studentRows.length} Students`;
    }
}

// --- New function to save a single student's fee setup ---
async function saveIndividualStudentFeeSetup(studentId, fy, rowElement) {
    const saveButton = rowElement.querySelector('.sfs-save-btn');
    const originalButtonHtml = saveButton.innerHTML;
    saveButton.disabled = true;
    saveButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...`;

    try {
        const studentDocRef = doc(db, `/artifacts/${appId}/public/data/students`, studentId);

        const feeDataForYear = { financialYear: fy };
        let totalPayable = 0;
        const inputs = rowElement.querySelectorAll('.sfs-input');

        inputs.forEach(input => {
            const feeType = input.dataset.fee;
            const amount = parseFloat(input.value) || 0;
            feeDataForYear[feeType] = amount;
            if (feeType !== 'concession') { // Assuming concession reduces payable
                totalPayable += amount;
            }
        });
        feeDataForYear.totalPayable = totalPayable - (feeDataForYear.concession || 0);
        feeDataForYear.timestamp = serverTimestamp(); // Add a timestamp for when this year's fee setup was last saved/updated

        await updateDoc(studentDocRef, {
            [`feeDetails.${fy}`]: feeDataForYear // This will set/overwrite the object for the given financial year
        });

        showAlert(`Fee setup for ${studentId} saved successfully!`, 'success');

        // After successful save, disable inputs and switch buttons
        rowElement.querySelectorAll('.sfs-input').forEach(input => input.disabled = true);
        rowElement.querySelector('.sfs-edit-btn').classList.remove('d-none');
        rowElement.querySelector('.sfs-save-btn').classList.add('d-none');
        rowElement.querySelector('.sfs-cancel-btn').classList.add('d-none');

    } catch (error) {
        console.error("Error saving individual student fee setup: ", error);
        showAlert('Failed to save fee setup. Please try again.', 'danger');
    } finally {
        saveButton.disabled = false;
        saveButton.innerHTML = originalButtonHtml;
    }
}

// --- Function to attach all event listeners for the table ---
function attachFeeSetupTableListeners(fy) {
    const tableBody = document.querySelector('#sfs-table tbody');
    if (!tableBody) return;

    tableBody.addEventListener('click', async (e) => {
        const target = e.target;
        const row = target.closest('tr'); // Get the parent row

        if (!row) return; // Not a click on a table row element

        const studentId = row.dataset.studentId;
        const inputs = row.querySelectorAll('.sfs-input');
        const editBtn = row.querySelector('.sfs-edit-btn');
        const saveBtn = row.querySelector('.sfs-save-btn');
        const cancelBtn = row.querySelector('.sfs-cancel-btn');

        if (target.classList.contains('sfs-edit-btn')) {
            // Store original values for cancel functionality
            const originalValues = {};
            inputs.forEach(input => {
                input.disabled = false;
                originalValues[input.dataset.fee] = input.value;
            });
            row.dataset.originalValues = JSON.stringify(originalValues); // Store on row

            editBtn.classList.add('d-none'); // Hide edit
            saveBtn.classList.remove('d-none'); // Show save
            cancelBtn.classList.remove('d-none'); // Show cancel

        } else if (target.classList.contains('sfs-save-btn')) {
            // Save button clicked for this student
            await saveIndividualStudentFeeSetup(studentId, fy, row);
            
        } else if (target.classList.contains('sfs-cancel-btn')) {
            // Cancel button clicked
            const originalValues = JSON.parse(row.dataset.originalValues || '{}');
            inputs.forEach(input => {
                input.value = originalValues[input.dataset.fee] || '';
                input.disabled = true;
            });

            editBtn.classList.remove('d-none'); // Show edit
            saveBtn.classList.add('d-none'); // Hide save
            cancelBtn.classList.add('d-none'); // Hide cancel
            row.removeAttribute('data-original-values'); // Clean up
        }
    });

    // You can keep your existing saveAllFeeSetups for a global save button if you still want it.
    // Make sure to call attachFeeSetupTableListeners(activeFinancialYear) when the table is loaded/rendered.
}

// Example usage:
// When your fee setup tab is activated and the table is rendered, call:
// attachFeeSetupTableListeners(activeFinancialYear);
let currentStudentPendingFees =[];
// Replace your existing renderReceiptEntryForm function with this one
async function renderReceiptEntryForm() {
    const container = document.getElementById('single-receipt-pane');
    const isEditMode = receiptToEdit !== null;

    const now = new Date();
    // Ensure activeFinancialYear is used or derived correctly
    const currentFY = activeFinancialYear || (now.getMonth() >= 3 ? `${now.getFullYear()}-${now.getFullYear() + 1}` : `${now.getFullYear() - 1}-${now.getFullYear()}`);

    // Get the highest receipt number for the current FY from existing receipts to generate the next one
    const fyReceipts = receipts.filter(r => r.financialYear === currentFY);
    let maxReceiptNum = 0;
    fyReceipts.forEach(r => {
        const numPart = parseInt(r.receiptNo.split('-')[1], 10);
        if (numPart > maxReceiptNum) {
            maxReceiptNum = numPart;
        }
    });
    const nextReceiptNum = `R${currentFY.slice(2,4)}${currentFY.slice(7,9)}-${(maxReceiptNum + 1).toString().padStart(4, '0')}`;


    const currentReceipt = receiptToEdit || { receiptNo: nextReceiptNum, date: new Date().toISOString().slice(0,10), isStudent: true, paymentMode: 'CASH', items: [{head: '', amount: ''}] };

    container.innerHTML = `
        <h4 class="fw-semibold mb-4">${isEditMode ? `Edit Receipt: ${currentReceipt.receiptNo}` : 'New Fee Receipt'}</h4>
        <form id="receipt-form">

            <div class="row g-3 p-3 border rounded mb-4">
                <div class="col-md-3">
                    <label for="receipt-no" class="form-label">Receipt No.</label>
                    <input type="text" id="receipt-no" value="${currentReceipt.receiptNo}" readonly class="form-control-plaintext">
                </div>
                <div class="col-md-3">
                    <label for="receipt-date" class="form-label">Date</label>
                    <input type="date" id="receipt-date" value="${currentReceipt.date}" class="form-control">
                </div>
                <div class="col-md-3">
                    <label for="financial-year" class="form-label">Financial Year</label>
                    <input type="text" id="financial-year" value="${currentFY}" readonly class="form-control-plaintext">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <div class="form-check form-switch mb-1">
                        <input class="form-check-input" type="checkbox" role="switch" id="is-student-check" ${currentReceipt.isStudent ? 'checked' : ''}>
                        <label class="form-check-label" for="is-student-check">Is a Student?</label>
                    </div>
                </div>
            </div>

            <div id="payer-details" class="row g-3 p-3 border rounded mb-4">
                </div>

            <div class="p-3 border rounded mb-4">
                <h5 class="fw-semibold mb-3">Fee Items</h5>
                <div id="fee-items-container" class="vstack gap-2">
                    </div>
                <button type="button" id="add-fee-item-btn" class="btn btn-sm btn-outline-primary mt-3">
                    <i class="fas fa-plus me-1"></i>Add Another Item
                </button>
            </div>

            <div class="row g-3 p-3 border rounded">
                <div class="col-md-4">
                    <label for="payment-mode" class="form-label">Payment Mode</label>
                    <select id="payment-mode" class="form-select">
                        <option value="CASH" ${currentReceipt.paymentMode === 'CASH' ? 'selected' : ''}>CASH</option>
                        <option value="BANK" ${currentReceipt.paymentMode === 'BANK' ? 'selected' : ''}>BANK</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="total-amount" class="form-label">Total Amount</label>
                    <input type="text" id="total-amount" readonly class="form-control-plaintext fs-4 fw-bold" value="${currentReceipt.totalAmount?.toFixed(2) || '0.00'}">
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center pt-4 mt-3">
                <div>
                    ${isEditMode && currentUserRole === 'admin' ? `<button type="button" id="cancel-receipt-btn" class="btn btn-danger">Cancel Receipt</button>` : ''}
                </div>
                <div>
                    <button type="submit" class="btn btn-primary btn-lg">${isEditMode ? 'Update Receipt' : 'Save Receipt'}</button>
                </div>
            </div>
        </form>
    `;

    // --- Attach all listeners and logic for the form ---
    const isStudentCheck = document.getElementById('is-student-check');
    const payerDetailsContainer = document.getElementById('payer-details');
    const feeItemsContainer = document.getElementById('fee-items-container');
    const addFeeItemBtn = document.getElementById('add-fee-item-btn');
    const totalAmountInput = document.getElementById('total-amount'); // This is the READONLY total
    const form = document.getElementById('receipt-form');

    // NEW: Total amount paid input for distribution
    let totalAmountPaidForDistributionInput = null; // Will be assigned dynamically

    // Function to render payer details section based on checkbox
    const renderPayerDetails = async () => {
        if (isStudentCheck.checked) {
            payerDetailsContainer.innerHTML = `
                <div class="col-md-4">
                    <label for="admn-no-search" class="form-label">Admission No.</label>
                    <input type="text" id="admn-no-search" class="form-control" placeholder="Enter Admn No...">
                    <input type="hidden" id="selected-student-id">
                </div>
                <div class="col-md-4">
                    <label for="total-amount-paid-for-dist" class="form-label">Total Amount Paid</label>
                    <input type="number" id="total-amount-paid-for-dist" class="form-control" value="0" min="0">
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <h6 class="card-title mb-1" id="student-name-display"></h6>
                            <p class="card-text text-sm mb-0" id="student-info-display"></p>
                            <p class="card-text text-sm mb-0 mt-1" id="student-fee-summary"></p>
                        </div>
                    </div>
                </div>`;

            totalAmountPaidForDistributionInput = document.getElementById('total-amount-paid-for-dist');

            // Handle Admn No. search for student details and fee setup
            document.getElementById('admn-no-search').addEventListener('change', async (e) => {
                const admnNo = e.target.value;
                const student = students.find(s => s.admissionNumber === admnNo);
                const studentNameDisplay = document.getElementById('student-name-display');
                const studentInfoDisplay = document.getElementById('student-info-display');
                const selectedStudentIdInput = document.getElementById('selected-student-id');
                const studentFeeSummary = document.getElementById('student-fee-summary');

                // Clear previous info
                studentNameDisplay.textContent = '';
                studentInfoDisplay.textContent = '';
                selectedStudentIdInput.value = '';
                studentFeeSummary.textContent = '';
                feeItemsContainer.innerHTML = ''; // Clear existing fee items when student changes

                if (student) {
                    studentNameDisplay.textContent = student.name;
                    studentInfoDisplay.innerHTML = `Class: ${classes.find(c => c.id === student.classId)?.name}-${student.division}`;
                    selectedStudentIdInput.value = student.id;

                    // Fetch and calculate pending fees for this student
                    const pendingFees = await getStudentPendingFees(student.id, currentFY);
                    window.currentStudentPendingFees = pendingFees; // Store in global variable

                    const totalBalance = Object.values(pendingFees).reduce((sum, val) => sum + (val > 0 ? val : 0), 0);
                    const paidSoFar = receipts.filter(r => r.studentId === student.id && !r.isCancelled && r.financialYear === currentFY).reduce((sum, p) => sum + p.totalAmount, 0);

                    studentFeeSummary.innerHTML = `<strong>Balance:</strong> â‚¹ ${totalBalance.toFixed(2)}<br><strong>Paid YTD:</strong> â‚¹ ${paidSoFar.toFixed(2)}`;


                    // Dynamically add fee item rows based on pending fees
                    renderFeeItemsForStudent(pendingFees, feeItemsContainer, isEditMode ? currentReceipt.items : []);

                    // If in edit mode, and it's a student receipt, pre-fill total amount and distribute
                    if (isEditMode && currentReceipt.isStudent && currentReceipt.studentId === student.id) {
                         totalAmountPaidForDistributionInput.value = currentReceipt.totalAmount.toFixed(2);
                         distributeSinglePayment(totalAmountPaidForDistributionInput); // Distribute initial amount
                    } else {
                        // For new receipts, set initial total to full balance or 0
                        totalAmountPaidForDistributionInput.value = totalBalance.toFixed(2);
                        distributeSinglePayment(totalAmountPaidForDistributionInput); // Distribute initial amount
                    }

                } else {
                    studentNameDisplay.textContent = 'Student not found.';
                    showAlert('Student not found with this Admission Number.', 'warning');
                }
                updateTotal();
            });

            // Listener for the new total amount paid input
            totalAmountPaidForDistributionInput.addEventListener('input', (e) => {
                distributeSinglePayment(e.target);
            });

            // If in edit mode and it's a student receipt, trigger search for the student
            if (isEditMode && currentReceipt.isStudent && currentReceipt.studentId) {
                const studentForEdit = students.find(s => s.id === currentReceipt.studentId);
                if (studentForEdit) {
                    document.getElementById('admn-no-search').value = studentForEdit.admissionNumber;
                    document.getElementById('admn-no-search').dispatchEvent(new Event('change')); // Trigger change
                }
            }

        } else { // Not a student
            payerDetailsContainer.innerHTML = `
                <div class="col-md-6">
                    <label for="other-payer-name" class="form-label">Paid By (Name)</label>
                    <input type="text" id="other-payer-name" class="form-control" placeholder="Enter name..." value="${currentReceipt.isStudent ? '' : currentReceipt.payerName || ''}">
                </div>
                <div class="col-md-6">
                    <label for="other-payer-details" class="form-label">Details (Optional)</label>
                    <input type="text" id="other-payer-details" class="form-control" placeholder="e.g., Contact Info">
                </div>
            `;
            // For non-student, currentReceipt.items will be rendered directly
            feeItemsContainer.innerHTML = '';
            currentReceipt.items.forEach(item => addFeeItemRow(item, false)); // Pass false for isStudent
        }
    };

    // Helper to render fee items for a student
    const renderFeeItemsForStudent = (pendingFees, container, existingItems = []) => {
        container.innerHTML = ''; // Clear container

        // Order of fee heads for display
        const displayOrder = [
            'ARREARS', 'ADMISSION FEE',
            'TUITION FEE (T1)', 'TUITION FEE (T2)', 'TUITION FEE (T3)',
            'VEHICLE FEE (T1)', 'VEHICLE FEE (T2)', 'VEHICLE FEE (T3)',
            'EXAM FEE', 'MISC', 'CONCESSION'
        ];

        displayOrder.forEach(head => {
            let amount = pendingFees[head] || 0;
            let readonly = 'readonly'; // Most are readonly and filled by distribution
            let displayAmount = amount.toFixed(2); // Default display
            let valueToSet = amount;

            // In edit mode, if this head existed in the original receipt, use its amount
            if (isEditMode && existingItems.length > 0) {
                const existingItem = existingItems.find(item => item.head === head);
                if (existingItem) {
                    displayAmount = existingItem.amount.toFixed(2);
                    valueToSet = existingItem.amount;
                }
            }

            // Concession can be manually adjusted. It typically reduces the total payable.
            // When displaying, if the setup has a positive concession, we show it as negative to imply deduction.
            // If it's an amount being paid (like in a receipt item), it should be positive.
            if (head === 'CONCESSION') {
                 readonly = ''; // Make concession editable
                 // If it's a new entry and we are showing pending concession from setup, show as negative
                 // In edit mode, existingItems[head] would be the amount *applied* as concession, which should be positive in the receipt item.
                 if (!isEditMode && pendingFees['CONCESSION'] > 0) { // If there's an unapplied concession
                    valueToSet = pendingFees['CONCESSION']; // Use the positive concession amount from setup
                 } else if (isEditMode && existingItems.find(item => item.head === head)) {
                     // In edit mode, if concession was paid in this receipt, its amount is positive
                     valueToSet = existingItems.find(item => item.head === head).amount;
                 } else {
                     valueToSet = 0; // Default to 0 if no concession applies or no existing payment
                 }
                 displayAmount = valueToSet.toFixed(2); // Display as positive
            } else if (amount < 0 && head !== 'CONCESSION') { // If a head is overpaid, show 0 as balance for now
                displayAmount = '0.00';
                valueToSet = 0;
            }


            const row = document.createElement('div');
            row.className = 'row g-2 align-items-center mb-1';
            row.innerHTML = `
                <div class="col-md-5">
                    <label class="form-label small mb-0">${head}</label>
                </div>
                <div class="col-md-6">
                    <input type="number" class="form-control form-control-sm fee-amount-input"
                           data-head="${head}" value="${valueToSet.toFixed(2)}" ${readonly}>
                </div>
                <div class="col-md-1 d-flex justify-content-end align-items-center">
                    <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn d-none">&times;</button>
                </div>
            `;
            container.appendChild(row);
        });

        // Add an "Other" option for miscellaneous items if needed (not auto-distributed)
        if (!displayOrder.includes('MISC')) { // Only add if MISC isn't in main list for some reason
             addFeeItemRow({ head: 'MISC', amount: 0 }, true); // Treat as a removable row
        }
    };


    // Function to add a new fee item row (for non-student entries primarily, or for custom fees)
    const addFeeItemRow = (item = { head: '', amount: '' }, isRemovable = true) => {
        const row = document.createElement('div');
        row.className = 'row g-2 align-items-center mb-1';

        // Filter out heads that are already specifically covered in renderFeeItemsForStudent
        const studentSpecificHeads = [
            'ARREARS', 'ADMISSION FEE',
            'TUITION FEE (T1)', 'TUITION FEE (T2)', 'TUITION FEE (T3)',
            'VEHICLE FEE (T1)', 'VEHICLE FEE (T2)', 'VEHICLE FEE (T3)',
            'EXAM FEE'
        ];
        const selectableHeads = ['MISC', 'CONCESSION'].concat(
            availableFeeHeads.filter(head => !studentSpecificHeads.includes(head))
        ).sort();


        row.innerHTML = `
            <div class="col-md-5">
                <select class="form-select form-select-sm fee-head-select">
                    <option value="">-- SELECT HEAD --</option>
                    ${selectableHeads
                        .map(head => `<option value="${head}" ${item.head === head ? 'selected' : ''}>${head}</option>`).join('')}
                </select>
            </div>
            <div class="col-md-6">
                <input type="number" class="form-control form-control-sm fee-amount-input" value="${item.amount}">
            </div>
            <div class="col-md-1 d-flex justify-content-end align-items-center">
                ${isRemovable ? `<button type="button" class="btn btn-sm btn-outline-danger remove-item-btn">&times;</button>` : ''}
            </div>
        `;
        feeItemsContainer.appendChild(row);
    };

    // Function to update the readonly total amount
    const updateTotal = () => {
        let total = 0;
        document.querySelectorAll('#fee-items-container .fee-amount-input').forEach(input => {
            const amount = parseFloat(input.value) || 0;
            const head = input.dataset.head || input.closest('.row').querySelector('.fee-head-select')?.value; // Get head from data-head or select
            if (head === 'CONCESSION') {
                 total -= amount; // Deduct concession from total
            } else {
                 total += amount;
            }
        });
        totalAmountInput.value = total.toFixed(2);
    };


    async function getStudentPendingFees(studentId, currentFinancialYear) {
    const student = students.find(s => s.id === studentId); // await getStudentsData(studentId); // Get the student document
    console.log(student);
    if (!student || !student.feeDetails) {;
        console.warn(`No fee setup found for student ${studentId}.`);
        return {};
    }

    let totalHistoricalFeesDue = 0;
    let totalHistoricalPaymentsMade = 0;

    // 1. Calculate historical arrears from ALL prior years
    const financialYears = Object.keys(student.feeDetails).sort(); // Get all FYs and sort them
    for (const fy of financialYears) {
        // Stop when we reach the current financial year
        if (fy === currentFinancialYear) break;

        const feeSetupForYear = student.feeDetails[fy];
        if (feeSetupForYear) {
            totalHistoricalFeesDue += (feeSetupForYear.arrears || 0) +
                                      (feeSetupForYear.admissionFee || 0) +
                                      (feeSetupForYear.tf1 || 0) + (feeSetupForYear.tf2 || 0) + (feeSetupForYear.tf3 || 0) +
                                      (feeSetupForYear.vf1 || 0) + (feeSetupForYear.vf2 || 0) + (feeSetupForYear.vf3 || 0) +
                                      (feeSetupForYear.examFee || 0) - (feeSetupForYear.concession || 0);
        }
    }

    // Now, get all receipts for prior years for this student
    const historicalReceipts = receipts.filter(r => 
        r.studentId === studentId && 
        !r.isCancelled &&
        Object.keys(student.feeDetails).filter(fy => fy < currentFinancialYear).includes(r.financialYear) // Only receipts from prior years
    );

    historicalReceipts.forEach(payment => {
        totalHistoricalPaymentsMade += payment.totalAmount; // Assuming totalAmount reflects all items including concession logic
    });
    
    // The "arrears" for the current year is the net outstanding from previous years
    let calculatedArrearsFromHistory = Math.max(0, totalHistoricalFeesDue - totalHistoricalPaymentsMade); // Arrears cannot be negative

    // 2. Now calculate pending for the current financial year
    const currentYearFeeSetup = student.feeDetails[currentFinancialYear] || {};
    const currentYearPayments = receipts.filter(r => 
        r.studentId === studentId && 
        r.financialYear === currentFinancialYear && 
        !r.isCancelled
    );

    let pendingCurrentYear = {
        'ARREARS': calculatedArrearsFromHistory, // This is the dynamically calculated arrears!
        'ADMISSION FEE': currentYearFeeSetup.admissionFee || 0,
        'TUITION FEE (T1)': currentYearFeeSetup.tf1 || 0,
        'TUITION FEE (T2)': currentYearFeeSetup.tf2 || 0,
        'TUITION FEE (T3)': currentYearFeeSetup.tf3 || 0,
        'VEHICLE FEE (T1)': currentYearFeeSetup.vf1 || 0,
        'VEHICLE FEE (T2)': currentYearFeeSetup.vf2 || 0,
        'VEHICLE FEE (T3)': currentYearFeeSetup.vf3 || 0,
        'EXAM FEE': currentYearFeeSetup.examFee || 0,
        'MISC': currentYearFeeSetup.misc || 0, // Ensure misc is part of setup if it can be a defined fee
        'CONCESSION': currentYearFeeSetup.concession || 0 // Total concession for this year
    };

    // Subtract payments for the current year
    currentYearPayments.forEach(payment => {
        payment.items.forEach(item => {
            if (pendingCurrentYear[item.head] !== undefined) {
                if (item.head === 'CONCESSION') {
                    // Adjust pending concession if a portion was applied
                    pendingCurrentYear[item.head] -= item.amount;
                } else {
                    pendingCurrentYear[item.head] -= item.amount;
                }
            } else if (item.head === 'MISC' && pendingCurrentYear['MISC'] !== undefined) {
                // If MISC is a general head, ensure it's handled, even if not explicitly in setup
                pendingCurrentYear['MISC'] -= item.amount;
            }
        });
    });

    // Ensure no pending amount is negative (unless it's concession, which might indicate over-discount)
    for (const head in pendingCurrentYear) {
        if (head !== 'CONCESSION' && pendingCurrentYear[head] < 0) {
            pendingCurrentYear[head] = 0;
        }
    }

    return pendingCurrentYear;
}

// Assuming this function is called when saving student's fee setup
async function saveFeeStructure(studentId, financialYear, feeData) {
    try {
        const studentRef = doc(db, `/artifacts/${appId}/public/data/students`, studentId);

        // Prepare the nested update path
        const updatePath = `feeDetails.${financialYear}`;

        // Ensure totalPayable is calculated and included in feeData
        // (Assuming feeData object contains tf1, vf1, etc.)
        const calculatedTotalPayable = (feeData.arrears || 0) +
                                       (feeData.admissionFee || 0) +
                                       (feeData.tf1 || 0) + (feeData.tf2 || 0) + (feeData.tf3 || 0) +
                                       (feeData.vf1 || 0) + (feeData.vf2 || 0) + (feeData.vf3 || 0) +
                                       (feeData.examFee || 0) - (feeData.concession || 0);

        const feeDetailsForYear = {
            ...feeData, // Contains arrears, tf1, vf1, examFee, concession, admissionFee etc.
            totalPayable: calculatedTotalPayable,
            timestamp: serverTimestamp() // To track when this fee structure was set
        };

        // Use updateDoc to add/update the nested financial year object
        await updateDoc(studentRef, {
            [updatePath]: feeDetailsForYear // Firestore allows dot notation for nested fields
        });

        showAlert('Fee structure saved successfully!', 'success');
        // You'll need to re-render the appropriate view or update local data if necessary
    } catch (error) {
        console.error("Error saving fee structure:", error);
        showAlert('Failed to save fee structure. Please try again.', 'danger');
    }
}

    // Function to distribute payment for single receipt entry
    function distributeSinglePayment(totalAmountInputEl) {
        let amountToDistribute = parseFloat(totalAmountInputEl.value) || 0;

        // Get pendingFees from the global variable
        let pendingFees = window.currentStudentPendingFees || {};

        // Define payment order (customize this based on your school's priority)
        const paymentOrder = [
            'ARREARS', 'ADMISSION FEE',
            'TUITION FEE (T1)', 'VEHICLE FEE (T1)',
            'TUITION FEE (T2)', 'VEHICLE FEE (T2)',
            'TUITION FEE (T3)', 'VEHICLE FEE (T3)',
            'EXAM FEE', 'MISC'
        ];

        // Clear all amount inputs in fee items container first
        document.querySelectorAll('#fee-items-container .fee-amount-input').forEach(input => {
            input.value = '0.00';
        });

        // Handle concession first (if student has an unapplied concession amount)
        let unappliedConcession = pendingFees['CONCESSION'] || 0;
        const concessionInput = document.querySelector('#fee-items-container .fee-amount-input[data-head="CONCESSION"]');
        if (concessionInput) {
            if (unappliedConcession > 0) { // If there's an actual unapplied discount
                let actualConcessionToApply = Math.min(amountToDistribute, unappliedConcession);
                concessionInput.value = actualConcessionToApply.toFixed(2); // Display as positive (amount applied)
                amountToDistribute -= actualConcessionToApply; // Reduce amount to distribute by concession
            } else {
                concessionInput.value = '0.00'; // No concession to apply
            }
        }

        // Distribute the remaining amount to other heads
        for (const head of paymentOrder) {
            if (amountToDistribute <= 0) break;

            const input = document.querySelector(`#fee-items-container .fee-amount-input[data-head="${head}"]`);
            if (!input) continue;

            const pendingForThisHead = pendingFees[head] || 0;

            if (pendingForThisHead > 0) { // Only pay if there's a positive balance due
                const amountToPay = Math.min(amountToDistribute, pendingForThisHead);
                input.value = amountToPay.toFixed(2);
                amountToDistribute -= amountToPay;
            }
        }

        // If there's still a positive amountToDistribute, put it into MISC
        if (amountToDistribute > 0) {
            const miscInput = document.querySelector('#fee-items-container .fee-amount-input[data-head="MISC"]');
            if (miscInput) {
                miscInput.value = (parseFloat(miscInput.value) + amountToDistribute).toFixed(2);
            } else {
                // If MISC input doesn't exist, and there's remaining balance, add a new row
                // This scenario should be rare for students if MISC is always there, but good for robustness
                addFeeItemRow({ head: 'MISC', amount: amountToDistribute }, true);
            }
        }
        updateTotal(); // Re-calculate readonly total
    }


    // Attach event listeners
    isStudentCheck.addEventListener('change', renderPayerDetails);
    addFeeItemBtn.addEventListener('click', () => addFeeItemRow({head: '', amount: ''}, true));
    feeItemsContainer.addEventListener('input', updateTotal); // Manual input for non-student rows
    feeItemsContainer.addEventListener('change', updateTotal); // For dropdowns in fee items
    feeItemsContainer.addEventListener('click', (e) => {
        if (e.target.closest('.remove-item-btn')) {
            e.target.closest('.row').remove();
            updateTotal();
        }
    });

    // Initial setup:
    renderPayerDetails(); // This will initially render student/other details based on checkbox

    // If in edit mode, and it's not a student receipt, pre-populate items as general inputs
    if (isEditMode && !currentReceipt.isStudent) {
        feeItemsContainer.innerHTML = ''; // Clear default single empty row
        currentReceipt.items.forEach(item => addFeeItemRow(item, true)); // True for removable
        updateTotal();
    }
    // For student receipts in edit mode, student search listener handles the initial distribution

    // Form submission logic
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonHtml = submitButton.innerHTML;
        submitButton.disabled = true;
        submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...`;

        const receiptNo = document.getElementById('receipt-no').value;
        const isStudent = document.getElementById('is-student-check').checked;
        let studentId = null;
        let payerName = '';

        if (isStudent) {
            studentId = document.getElementById('selected-student-id').value;
            payerName = document.getElementById('student-name-display').textContent; // Use content directly
            if (!studentId || payerName.trim() === 'Student not found.' || payerName.trim() === '') {
                showAlert('Please select a valid student.', 'danger');
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonHtml;
                return;
            }
        } else {
            payerName = document.getElementById('other-payer-name')?.value || '';
            if (payerName.trim() === '') {
                showAlert('Please enter payer name.', 'danger');
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonHtml;
                return;
            }
        }

        const items = [];
        document.querySelectorAll('#fee-items-container .fee-amount-input').forEach(input => {
            const head = input.dataset.head || input.closest('.row').querySelector('.fee-head-select')?.value;
            const amount = parseFloat(input.value) || 0;
            if (head && amount !== 0) { // Only add if head is selected and amount is not zero
                items.push({ head, amount });
            }
        });

        const totalAmount = parseFloat(document.getElementById('total-amount').value);
        if (totalAmount <= 0 && items.length === 0) {
            showAlert('Total amount cannot be zero or negative, or no fee items entered.', 'danger');
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonHtml;
            return;
        }

        const receiptData = {
            receiptNo,
            date: document.getElementById('receipt-date').value,
            financialYear: document.getElementById('financial-year').value,
            isStudent: isStudent,
            payerName: payerName,
            studentId: studentId,
            items: items,
            totalAmount: totalAmount,
            paymentMode: document.getElementById('payment-mode').value,
            isCancelled: receiptToEdit?.isCancelled || false,
            timestamp: serverTimestamp()
        };

        try {
            await setDoc(getFeeDocRef(receiptData.financialYear, 'receipts', receiptNo), receiptData);
            showAlert('Receipt saved successfully!', 'success');
            receiptToEdit = null;
            renderFeeSubTab('receipt');
        } catch (error) {
            console.error('Error saving receipt:', error);
            showAlert('Failed to save receipt.', 'danger');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonHtml;
        }
    });
}
       
function renderFeeReportsTab() {
    const container = document.getElementById('fee-reports-tab');
    const classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

    container.innerHTML = `
        <div class="card p-4 mt-3">
            <h4 class="mb-3">Student Fee Report</h4>
            <p class="text-muted">Select a class, division, and term to generate a detailed fee report for <strong>${activeFinancialYear}</strong>.</p>
            <div class="row g-3 align-items-end mb-4">
                <div class="col-md-3">
                    <label for="fr-class" class="form-label">Class</label>
                    <select id="fr-class" class="form-select"><option value="">-- Select --</option>${classOptions}</select>
                </div>
                <div class="col-md-3">
                    <label for="fr-division" class="form-label">Division</label>
                    <select id="fr-division" class="form-select" disabled><option value="">--</option></select>
                </div>
                <div class="col-md-3">
                    <label for="fr-term" class="form-label">Term</label>
                    <select id="fr-term" class="form-select">
                        <option value="T1">Up to Term 1</option>
                        <option value="T2">Up to Term 2</option>
                        <option value="T3">Up to Term 3</option>
                        <option value="FY" selected>Full Year</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button id="fr-generate-btn" class="btn btn-primary w-100">Generate Report</button>
                </div>
            </div>
            <div id="fr-report-container" class="mt-4"></div>
        </div>`;
    
    attachFeeReportsListeners();
}


// Replace your existing attachFeeReportsListeners function with this one
function attachFeeReportsListeners() {
    const classSelect = document.getElementById('fr-class');
    const divisionSelect = document.getElementById('fr-division');
    const generateBtn = document.getElementById('fr-generate-btn');
    const reportContainer = document.getElementById('fr-report-container');

    // Populate divisions when a class is selected
    classSelect.addEventListener('change', () => {
        const selectedClass = classes.find(c => c.id === classSelect.value);
        divisionSelect.innerHTML = '<option value="">-- Select --</option>';
        if (selectedClass) {
            divisionSelect.disabled = false;
            divisionSelect.innerHTML += selectedClass.divisions.map(d => `<option value="${d}">${d}</option>`).join('');
        } else {
            divisionSelect.disabled = true;
        }
    });

    // Generate the report on button click
    generateBtn.addEventListener('click', () => {
        const classId = classSelect.value;
        const division = divisionSelect.value;
        const term = document.getElementById('fr-term').value;
        if (classId && division) { // Term is always selected
            generateAndDisplayFeeReport(classId, division, term, 'fr-report-container');
        } else {
            showAlert('Please select a class and division.', 'warning');
        }
    });

    // Use event delegation for dynamically created buttons and links in the report
    reportContainer.addEventListener('click', (e) => {
        const studentLink = e.target.closest('.student-details-link');
        const whatsAppBtn = e.target.closest('.whatsapp-btn'); // Check for WhatsApp button directly

        if (studentLink) {
            e.preventDefault();
            const studentId = studentLink.dataset.studentid;
            populateAndShowStudentModal(studentId);
        }

        if (whatsAppBtn) {
            e.preventDefault();
           whatsappFee(e); // Call the function directly
        }
    });
}

function whatsappFee(e) {
    const whatsAppBtn = e.target.closest('.whatsapp-btn');
    if (whatsAppBtn) {
        const studentName = whatsAppBtn.dataset.name;
        const balance = whatsAppBtn.dataset.balance;
        const termname = whatsAppBtn.dataset.termname;
        
        const payable = whatsAppBtn.dataset.payable; // <-- Reads data-payable
        const paid = whatsAppBtn.dataset.paid;       // <-- Reads data-paid
        const whatsAppNumber = whatsAppBtn.dataset.whatsapp;
        const schoolName = schoolDetails.name || 'School Name';

        const message = `Dear Parent/Student,
This is a friendly reminder regarding the fee payment for ${studentName} for the academic year ${activeFinancialYear}.

Fee Details of ${termname}:
- Total Payable: â‚¹ ${payable}
- Amount Paid: â‚¹ ${paid}
- *Balance Due: â‚¹ ${balance}*

Kindly clear the outstanding balance at your earliest convenience.
Thank you,
${schoolName}`;

        // Attempt to copy to clipboard
        navigator.clipboard.writeText(message).then(() => {
            showAlert('Message copied to clipboard! You can now paste it into WhatsApp.', 'info');
        }).catch(err => {
            console.error('Failed to copy message: ', err);
            showAlert('Failed to copy message to clipboard. Please copy manually.', 'warning');
        });

        // Open WhatsApp link (optional: you might want to only open if copy succeeds, or always)
        const encodedMessage = encodeURIComponent(message);
        const whatsappUrl = `https://wa.me/${whatsAppNumber}?text=${encodedMessage}`;
        window.open(whatsappUrl, '_blank');
    }
}
function generateAndDisplayFeeReport(classId, division, term,containerId){
    const reportContainer = document.getElementById(containerId); // MODIFIED
    if (!reportContainer) return; // Add a safety check

    reportContainer.innerHTML = `<div class="text-center text-muted"><div class="spinner-border" role="status"></div><p class="mt-2">Generating report...</p></div>`;


    //const reportContainer = document.getElementById('fr-report-container');
    reportContainer.innerHTML = `<div class="text-center text-muted"><div class="spinner-border" role="status"></div><p class="mt-2">Generating report...</p></div>`;

    const studentsInClass = students.filter(s => s.classId === classId && s.division === division && s.status !== 'TC Issued').sort((a, b) => a.name.localeCompare(b.name));
       if (studentsInClass.length === 0) {
        reportContainer.innerHTML = '<div class="alert alert-warning">No students found for this selection.</div>';
        return;
    }

    const reportData = studentsInClass.map(student => {
        const setup = studentFeeSetups.find(sfs => sfs.id === student.id);
        const payments = receipts.filter(r => r.studentId === student.id && !r.isCancelled);
        const totalPaid = payments.reduce((sum, p) => sum + p.totalAmount, 0);

        let termPayable = 0;
        let termFees = { arrears: 0, tf: 0, vf: 0, examFee: 0 };
        let termname = term==='T1'?'UP TO TERM 1':term==='T2'?'UP TO TERM 2':'UP TO YEAR';

        if (setup) {
            termFees.arrears = setup.arrears || 0;
            // Calculate payable amount cumulatively based on the selected term
            if (term === 'T1' || term === 'T2' || term === 'T3' || term === 'FY') {
                termPayable += (setup.arrears || 0) + (setup.tf1 || 0) + (setup.vf1 || 0) + (setup.examFee || 0);
                termFees.tf += setup.tf1 || 0;
                termFees.vf += setup.vf1 || 0;
                termFees.examFee += setup.examFee || 0;
                
            }
            if (term === 'T2' || term === 'T3' || term === 'FY') {
                termPayable += (setup.tf2 || 0) + (setup.vf2 || 0);
                termFees.tf += setup.tf2 || 0;
                termFees.vf += setup.vf2 || 0;
            }
            if (term === 'T3' || term === 'FY') {
                termPayable += (setup.tf3 || 0) + (setup.vf3 || 0);
                termFees.tf += setup.tf3 || 0;
                termFees.vf += setup.vf3 || 0;
            }
            if (term === 'FY') termPayable = setup.totalPayable;
        }

        return {
            ...student,
            termPayable: termPayable,
            totalPaid :totalPaid,
            termname: termname,
            balance: termPayable - totalPaid,
            termFees // Store term-wise breakdown for the main table
        };
    });
    console.log(reportData);
    displayFeeReport(reportData, containerId); // MODIFIED

}

/**
 * Renders the calculated fee report data into an HTML table with more detail.
 * @param {Array<object>} reportData Array of student objects with their fee details.
 */
function displayFeeReport(reportData, containerId) {
    const reportContainer = document.getElementById(containerId); // MODIFIED
    if (!reportContainer) return; // Add a safety check


    const tableRows = reportData.map(student => {
        const balance = student.balance;
        let balanceBadgeColor = balance <= 0 ? 'success' : 'danger';
        const whatsAppButton = (balance > 0 && student.whatsappNo) ?
    `<button class="btn btn-sm btn-success whatsapp-btn"
        data-balance="${balance.toFixed(2)}"
        data-name="${student.name}"
        data-termname="${student.termname}"
        data-whatsapp="${student.whatsappNo}"
        data-payable="${student.termPayable.toFixed(2)}"
        data-paid="${student.totalPaid.toFixed(2)}"> 
        <i class="fab fa-whatsapp"></i>
    </button>` : '';
        return `
            <tr>
                <td><a href="#" class="fw-bold student-details-link" data-studentid="${student.id}">${student.name}</a></td>
                <td>${student.admissionNumber}</td>
                <td>${student.termFees.arrears.toFixed(2)}</td>
                <td>${student.termFees.tf.toFixed(2)}</td>
                <td>${student.termFees.vf.toFixed(2)}</td>
                <td>${student.termFees.examFee.toFixed(2)}</td>
                <td class="fw-bold">${student.termPayable.toFixed(2)}</td>
                <td>${student.totalPaid.toFixed(2)}</td>
                <td><span class="badge bg-${balanceBadgeColor} p-2">â‚¹ ${balance.toFixed(2)}</span></td>
                <td>${whatsAppButton}</td>
            </tr>`;
    }).join('');

    reportContainer.innerHTML = `
        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover" style="font-size: 0.85rem;">
                <thead class="table-light">
                    <tr>
                        <th>Student Name</th><th>Admn No.</th><th>Arrears</th><th>Tuition Fee</th>
                        <th>Vehicle Fee</th><th>Exam Fee</th><th>Total Payable</th><th>Total Paid</th><th>Balance</th><th>Action</th>
                    </tr>
                </thead>
                <tbody>${tableRows}</tbody>
            </table>
        </div>`;
}

// This function calculates the *true* arrears for a student for the given 'targetFinancialYear'
// by summing up all fees and subtracting all payments from *all years prior* to the targetFY.
async function calculateTrueHistoricalArrears(studentId, targetFinancialYear) {
    const student = await getStudentsData(studentId);
    if (!student || !student.feeDetails) {
        return 0; // No fee details, so no arrears
    }

    let totalFeesDueFromPriorYears = 0;
    let totalPaymentsMadeTowardsPriorYears = 0;

    // Get all financial years for which this student has fee setups, sorted chronologically
    const allFinancialYears = Object.keys(student.feeDetails).sort();

    for (const fy of allFinancialYears) {
        // Only consider financial years *before* the targetFinancialYear
        if (fy >= targetFinancialYear) {
            break; // Stop if we reach or pass the target year
        }

        const feeSetupForYear = student.feeDetails[fy];
        if (feeSetupForYear) {
            // Sum up all original payable amounts for this prior year
            totalFeesDueFromPriorYears += (feeSetupForYear.arrears || 0); // Note: Initial arrears of a year are part of its payable
            totalFeesDueFromPriorYears += (feeSetupForYear.admissionFee || 0);
            totalFeesDueFromPriorYears += (feeSetupForYear.tf1 || 0) + (feeSetupForYear.tf2 || 0) + (feeSetupForYear.tf3 || 0);
            totalFeesDueFromPriorYears += (feeSetupForYear.vf1 || 0) + (feeSetupForYear.vf1 || 0) + (feeSetupForYear.vf3 || 0);
            totalFeesDueFromPriorYears += (feeSetupForYear.examFee || 0);
            totalFeesDueFromPriorYears -= (feeSetupForYear.concession || 0); // Concession reduces payable
        }
    }

    // Sum up all payments made for prior years
    // Ensure 'receipts' global array is up-to-date (from onSnapshot/IndexedDB)
    const paymentsForPriorYears = receipts.filter(r =>
        r.studentId === studentId &&
        !r.isCancelled && // Only consider non-cancelled receipts
        allFinancialYears.some(fy => fy < targetFinancialYear && fy === r.financialYear)
    );

    paymentsForPriorYears.forEach(payment => {
        totalPaymentsMadeTowardsPriorYears += payment.totalAmount;
    });

    // The true historical arrears is the net outstanding from all prior years
    return Math.max(0, totalFeesDueFromPriorYears - totalPaymentsMadeTowardsPriorYears);
}

function renderArrearsReconciliationTab() {
    const container = document.getElementById('fee-arrears-tab'); // Get the specific tab content div
    if (!container) return; // Ensure the container exists

    // Populate the content of the Arrears Reconciliation tab
    container.innerHTML = `
        <div class="card p-4 mt-3">
            <h4 class="mb-3">Arrears Reconciliation Tool</h4>
            <p class="text-muted">This tool helps identify and correct discrepancies between calculated historical arrears (total outstanding from all prior years) and the 'Arrears' amount set for the current financial year (${activeFinancialYear}).</p>
            <div id="arrears-reconciliation-content">
                <p class="text-center text-muted">Click the 'Load Reconciliation Data' button below to perform the audit.</p>
                <button id="load-arrears-reconciliation-btn" class="btn btn-primary w-100 mt-3">Load Reconciliation Data</button>
                <div id="arrears-reconciliation-results" class="mt-4">
                    </div>
            </div>
        </div>
    `;

    // Attach event listener for the 'Load Reconciliation Data' button
    const loadBtn = document.getElementById('load-arrears-reconciliation-btn');
    if (loadBtn) {
        // Use an anonymous function to ensure activeFinancialYear is captured correctly
        loadBtn.addEventListener('click', async () => {
            const resultsDiv = document.getElementById('arrears-reconciliation-results');
            resultsDiv.innerHTML = '<p class="text-center text-muted"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading reconciliation data. This may take a moment...</p>';
            loadBtn.disabled = true; // Disable button while loading

            try {
                // Call the main function to render the actual reconciliation table
                await renderArrearsReconciliationTable(activeFinancialYear);
            } finally {
                loadBtn.disabled = false; // Re-enable button
            }
        });
    }
}
async function updateStudentArrearsInFeeDetails(studentId, financialYear, newArrearsAmount) {
    try {
        const studentRef = doc(db, `/artifacts/${appId}/public/data/students`, studentId);
        const updatePath = `feeDetails.${financialYear}.arrears`;

        // Use updateDoc to set the specific arrears field
        await updateDoc(studentRef, {
            [updatePath]: newArrearsAmount
        });
        showAlert(`Arrears for ${studentId} updated to ${newArrearsAmount.toFixed(2)}`, 'success');

        // IMPORTANT: Re-sync students data if it's not immediately reactive
        // Your onSnapshot for students should handle this, but if not,
        // you might want to manually trigger a refresh of the global 'students' array
        // or ensure the UI is refreshed after this operation.
        // For simplicity, calling renderArrearsReconciliationTable will re-fetch data.

    } catch (error) {
        console.error("Error updating student arrears:", error);
        showAlert('Failed to update arrears. Please try again.', 'danger');
    }
}
window.renderArrearsReconciliationTable =async (financialYearToAudit)=>{
    const tableBody = document.getElementById('arrears-reconciliation-table-body'); // Create this in your HTML
    if (!tableBody) return;
    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading...</td></tr>';

    const allStudents = await getStudentsData(); // Get all students
    let tableHtml = '';

    for (const student of allStudents) {
        const calculatedArrears = await calculateTrueHistoricalArrears(student.id, financialYearToAudit);
        
        // Get the 'ARREARS' amount currently stored in the student's feeDetails for the target FY
        const currentStoredArrears = student.feeDetails?.[financialYearToAudit]?.arrears || 0;

        const mismatch = calculatedArrears - currentStoredArrears;
        const status = mismatch === 0 ? 'Matched' : 'Mismatched';
        const rowClass = mismatch === 0 ? 'table-success' : 'table-danger'; // Highlight mismatches

        tableHtml += `
            <tr class="${rowClass}" data-student-id="${student.id}" data-calculated-arrears="${calculatedArrears}">
                <td><input type="checkbox" class="arrears-select-checkbox" ${mismatch === 0 ? 'disabled' : ''}></td>
                <td>${student.name}</td>
                <td>${student.admissionNumber}</td>
                <td>${student.classId || ''} - ${student.division || ''}</td>
                <td>${calculatedArrears.toFixed(2)}</td>
                <td>${currentStoredArrears.toFixed(2)}</td>
                <td>${mismatch.toFixed(2)}</td>
                <td>${status}</td>
                <td>
                    ${mismatch !== 0 ? `<button class="btn btn-sm btn-primary update-arrears-btn" data-student-id="${student.id}">Update</button>` : ''}
                </td>
            </tr>
        `;
    }
    tableBody.innerHTML = tableHtml;

    // Attach listeners for individual update buttons (or a bulk update button)
    document.querySelectorAll('.update-arrears-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
            const studentIdToUpdate = e.target.dataset.studentId;
            const row = e.target.closest('tr');
            const calculated = parseFloat(row.dataset.calculatedArrears);
            await updateStudentArrearsInFeeDetails(studentIdToUpdate, financialYearToAudit, calculated);
            // Re-render the table or just update the row after successful update
            renderArrearsReconciliationTable(financialYearToAudit); // Re-render whole table for simplicity
        });
    });

    // Listener for "Update All Mismatches" / "Update Selected" buttons
    // ... (implement logic to iterate selected checkboxes or all mismatched rows)
}

window.renderTeacherFeeDetails = () => {
    const mainContent = document.getElementById('main-content'); // Or your main container

    // Find the class name from the classId stored in classCharge
    const className = classes.find(c => c.id === selectedUser.classCharge.classId)?.name || 'Unknown Class';
    const assignedClassText = `${className} - ${selectedUser.classCharge.division}`;

    mainContent.innerHTML = `
        <div class="card p-4 mt-3">
            <h4 class="mb-3">Student Fee Details</h4>
            
            <!-- Display the teacher's assigned class as static text -->
            <div class="mb-3">
                <label class="form-label">Your Assigned Class:</label>
                <p class="fs-5 fw-bold text-primary">${assignedClassText}</p>
            </div>
            
            <p class="text-muted">Select a term to view the fee status for your students for the year <strong>${activeFinancialYear}</strong>.</p>
            
            <div class="row g-3 align-items-end mb-4">
                <div class="col-md-6">
                    <label for="teacher-term" class="form-label">Term</label>
                    <select id="teacher-term" class="form-select">
                        <option value="T1">Up to Term 1</option>
                        <option value="T2">Up to Term 2</option>
                        <option value="T3">Up to Term 3</option>
                        <option value="FY" selected>Full Year</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <button id="teacher-generate-btn" class="btn btn-primary w-100">View Fee Details</button>
                </div>
            </div>
            <div id="teacher-report-container" class="mt-4">
                <!-- The fee report will be rendered here -->
            </div>
        </div>`;
    
    // Pass the teacher object to the listener setup function
    attachTeacherFeeListeners(selectedUser);
};


// Replace your existing attachTeacherFeeListeners function with this one
function attachTeacherFeeListeners(currentTeacher) {
    const generateBtn = document.getElementById('teacher-generate-btn');
    const reportContainer = document.getElementById('teacher-report-container');

    generateBtn.addEventListener('click', () => {
        const termSelector = document.getElementById('teacher-term');
        const term = termSelector.value;

        // Get classId and division directly from the teacher object
        const classId = currentTeacher.classCharge.classId;
        const division = currentTeacher.classCharge.division;

        // Call the REUSABLE report generator with the teacher's container ID
        generateAndDisplayFeeReport(classId, division, term, 'teacher-report-container');
    });

    // Event delegation for the modal and WhatsApp buttons remains the same
    reportContainer.addEventListener('click', (e) => {
        const studentLink = e.target.closest('.student-details-link');
        if (studentLink) {
            e.preventDefault();
            const studentId = studentLink.dataset.studentid;
            populateAndShowStudentModal(studentId);
        }

        const whatsAppBtn = e.target.closest('.whatsapp-btn'); // Check for WhatsApp button directly
        if (whatsAppBtn) {
            whatsappFee(e); // Call the function directly
        }
    });
}


/**
 * Populates the student detail modal with fee structure and payment history, then shows it.
 * @param {string} studentId The ID of the student to show details for.
 */
function populateAndShowStudentModal(studentId) {
    const student = students.find(s => s.id === studentId);
    const setup = studentFeeSetups.find(sfs => sfs.id === studentId);
    const payments = receipts.filter(r => r.studentId === studentId && !r.isCancelled).sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (!student) return;

    // --- Fee Structure Tab Content ---
    const structureHTML = setup ? `
        <table class="table table-sm">
            <tbody>
                <tr><th>Arrears</th><td>â‚¹ ${setup.arrears?.toFixed(2) || '0.00'}</td></tr>
                <tr><th>Tuition Fee (T1/T2/T3)</th><td>â‚¹ ${setup.tf1?.toFixed(2)} / ${setup.tf2?.toFixed(2)} / ${setup.tf3?.toFixed(2)}</td></tr>
                <tr><th>Vehicle Fee (T1/T2/T3)</th><td>â‚¹ ${setup.vf1?.toFixed(2)} / ${setup.vf2?.toFixed(2)} / ${setup.vf3?.toFixed(2)}</td></tr>
                <tr><th>Exam Fee</th><td>â‚¹ ${setup.examFee?.toFixed(2) || '0.00'}</td></tr>
                <tr class="text-danger"><th>Concession</th><td>- â‚¹ ${setup.concession?.toFixed(2) || '0.00'}</td></tr>
                <tr class="fw-bold bg-light"><th>Total Payable Annually</th><td>â‚¹ ${setup.totalPayable?.toFixed(2) || '0.00'}</td></tr>
            </tbody>
        </table>` : '<p class="text-muted">Fee setup not found for this student.</p>';

    // --- Payment History Tab Content ---
    const paymentsHTML = payments.length > 0 ? `
        <table class="table table-sm table-striped">
            <thead><tr><th>Receipt No</th><th>Date</th><th class="text-end">Amount</th></tr></thead>
            <tbody>
                ${payments.map(p => `<tr><td>${p.id}</td><td>${new Date(p.date).toLocaleDateString()}</td><td class="text-end">â‚¹ ${p.totalAmount.toFixed(2)}</td></tr>`).join('')}
            </tbody>
        </table>` : '<p class="text-muted">No payments recorded.</p>';

    // --- Final Modal Body HTML with Tabs ---
    const modalBody = document.getElementById('studentDetailModalBody');
    modalBody.innerHTML = `
        <ul class="nav nav-tabs" id="studentFeeTabs" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" id="structure-tab" data-bs-toggle="tab" data-bs-target="#structure-content" type="button">Fee Structure</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments-content" type="button">Payment History</button></li>
        </ul>
        <div class="tab-content pt-3">
            <div class="tab-pane fade show active" id="structure-content">${structureHTML}</div>
            <div class="tab-pane fade" id="payments-content">${paymentsHTML}</div>
        </div>`;
    
    document.getElementById('studentDetailModalLabel').textContent = `Fee Details for: ${student.name}`;
    const studentModal = new bootstrap.Modal(document.getElementById('studentDetailModal'));
    studentModal.show();
}

// Global array to store fee heads for dropdowns
let availableFeeHeads = []; // This should be populated from your feeStructures, maybe once on module load.
                             // For now, hardcode, but ideally fetch unique fee heads from feeStructures.
                             // Example: feeStructures.map(fs => fs.feeHead).filter((v,i,a) => a.indexOf(v) === i)

async function renderBulkReceiptForm() {
    const container = document.getElementById('bulk-receipt-pane');
    if (!container) return;

    const now = new Date();
    const currentFY = now.getMonth() >= 3 ? `${now.getFullYear()}-${now.getFullYear() + 1}` : `${now.getFullYear() - 1}-${now.getFullYear()}`;

    let availableFeeHeads = [...new Set(feeStructures.map(fs => fs.feeHead))];
    if (!availableFeeHeads.includes('MISC')) {
        availableFeeHeads.push('MISC');
    }
    // Add fixed student heads if not already dynamically pulled (ensure they are always options)
    const fixedStudentHeads = ['ADMISSION FEE', 'ARREARS', 'TUITION FEE (T1)', 'TUITION FEE (T2)', 'TUITION FEE (T3)', 'VEHICLE FEE (T1)', 'VEHICLE FEE (T2)', 'VEHICLE FEE (T3)', 'EXAM FEE', 'CONCESSION'];
    fixedStudentHeads.forEach(head => {
        if (!availableFeeHeads.includes(head)) {
            availableFeeHeads.push(head);
        }
    });

    availableFeeHeads.sort(); // Sort all unique heads alphabetically

    // Store the order of all fee heads for consistent table column generation
    const allStudentFeeHeadsOrder = [
        'ADMISSION FEE', 'ARREARS',
        'TUITION FEE (T1)', 'TUITION FEE (T2)', 'TUITION FEE (T3)',
        'VEHICLE FEE (T1)', 'VEHICLE FEE (T2)', 'VEHICLE FEE (T3)',
        'EXAM FEE', 'MISC', 'CONCESSION'
    ];


    container.innerHTML = `
        <h4 class="fw-semibold mb-4">Bulk Fee Receipt Entry</h4>
        <div class="row g-3 p-3 border rounded mb-4">
            <div class="col-md-6">
                <label for="bulk-receipt-date" class="form-label">Date for all receipts</label>
                <input type="date" id="bulk-receipt-date" class="form-control" value="${new Date().toISOString().slice(0, 10)}">
            </div>
            <div class="col-md-6">
                <label for="bulk-financial-year" class="form-label">Financial Year</label>
                <input type="text" id="bulk-financial-year" value="${currentFY}" readonly class="form-control-plaintext">
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <label class="form-label mb-0 me-2">Entry Type:</label>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="bulkEntryType" id="bulk-type-student" value="student" checked>
                    <label class="form-check-label" for="bulk-type-student">By Student (Fee Heads based on setup)</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="bulkEntryType" id="bulk-type-other" value="other">
                    <label class="form-check-label" for="bulk-type-other">Other (Dynamic Fee Heads)</label>
                </div>
            </div>
            <button id="add-bulk-row-btn" class="btn btn-outline-primary"><i class="fas fa-plus me-2"></i>Add Row</button>
        </div>

        <div class="ui-card mb-4" id="fee-head-selector-card">
            <h5 class="section-header">Select Fee Heads for Display</h5>
            <div class="row row-cols-md-4 row-cols-lg-6 g-2" id="fee-head-checkboxes">
                ${availableFeeHeads.map(head => `
                    <div class="col">
                        <div class="form-check">
                            <input class="form-check-input fee-head-checkbox" type="checkbox" value="${head}" id="head-${head.replace(/\s/g, '-')}" checked>
                            <label class="form-check-label" for="head-${head.replace(/\s/g, '-')}" style="white-space: nowrap;">${head}</label>
                        </div>
                    </div>
                `).join('')}
            </div>
            <div class="text-end mt-3">
                <button class="btn btn-sm btn-outline-secondary" id="select-all-heads-btn">Select All</button>
                <button class="btn btn-sm btn-outline-secondary" id="deselect-all-heads-btn">Deselect All</button>
            </div>
        </div>
        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
            <form id="bulk-receipt-form">
                <table class="table table-bordered table-striped table-sm text-nowrap">
                    <thead id="bulk-receipt-table-head">
                        </thead>
                    <tbody id="bulk-receipt-table-body">
                        </tbody>
                </table>
                <p id="bulk-table-empty-message" class="text-muted text-center p-3">Click "Add Row" to start adding receipts.</p>
            </form>
        </div>

        <div class="text-end mt-4">
            <button id="save-bulk-receipts-btn" class="btn btn-primary btn-lg">
                <i class="fas fa-save me-2"></i>Save All Bulk Receipts
            </button>
        </div>
    `;

    const bulkTypeStudentRadio = document.getElementById('bulk-type-student');
    const bulkTypeOtherRadio = document.getElementById('bulk-type-other');
    const addBulkRowBtn = document.getElementById('add-bulk-row-btn');
    const bulkReceiptTableHead = document.getElementById('bulk-receipt-table-head');
    const bulkReceiptTableBody = document.getElementById('bulk-receipt-table-body');
    const bulkTableEmptyMessage = document.getElementById('bulk-table-empty-message');
    const saveBulkReceiptsBtn = document.getElementById('save-bulk-receipts-btn');
    const feeHeadCheckboxesContainer = document.getElementById('fee-head-checkboxes');
    const selectAllHeadsBtn = document.getElementById('select-all-heads-btn');
    const deselectAllHeadsBtn = document.getElementById('deselect-all-heads-btn');
    const feeHeadSelectorCard = document.getElementById('fee-head-selector-card');

    // Function to get currently selected heads
    const getSelectedFeeHeads = () => {
        return Array.from(feeHeadCheckboxesContainer.querySelectorAll('.fee-head-checkbox:checked')).map(cb => cb.value);
    };

    // Function to update table headers and add initial row
    const updateTableStructure = () => {
        const isStudentEntry = bulkTypeStudentRadio.checked;
        const selectedHeads = getSelectedFeeHeads();
        
        // Hide/Show selector card based on type (student entries have fixed heads)
        if (isStudentEntry) {
            feeHeadSelectorCard.classList.add('d-none');
            // For student entry, we will use allStudentFeeHeadsOrder for column generation
            generateBulkReceiptTableHeaders(isStudentEntry, bulkReceiptTableHead, allStudentFeeHeadsOrder);
        } else {
            feeHeadSelectorCard.classList.remove('d-none');
            generateBulkReceiptTableHeaders(isStudentEntry, bulkReceiptTableHead, selectedHeads);
        }

        bulkReceiptTableBody.innerHTML = ''; // Clear existing rows
        bulkTableEmptyMessage.style.display = 'block'; // Show message until a row is added
    };

    // Event listeners for entry type change
    bulkTypeStudentRadio.addEventListener('change', updateTableStructure);
    bulkTypeOtherRadio.addEventListener('change', updateTableStructure);

    // Event listener for fee head checkboxes
    feeHeadCheckboxesContainer.addEventListener('change', (e) => {
        if (e.target.classList.contains('fee-head-checkbox')) {
            updateTableStructure(); // Re-render table when head selection changes
        }
    });

    // Select/Deselect All buttons
    selectAllHeadsBtn.addEventListener('click', () => {
        feeHeadCheckboxesContainer.querySelectorAll('.fee-head-checkbox').forEach(cb => cb.checked = true);
        updateTableStructure();
    });
    deselectAllHeadsBtn.addEventListener('click', () => {
        feeHeadCheckboxesContainer.querySelectorAll('.fee-head-checkbox').forEach(cb => cb.checked = false);
        updateTableStructure();
    });
    //let bulkReceiptRowCounter = 0;
    const fyReceipts = receipts.filter(r => r.financialYear === currentFY);
    let maxReceiptNum = 0;
    fyReceipts.forEach(r => {
        const numPart = parseInt(r.receiptNo.split('-')[1], 10);
        if (numPart > maxReceiptNum) {
            maxReceiptNum = numPart;
        }
    });
    


    updateTableStructure(); // Initial table setup

    addBulkRowBtn.addEventListener('click', () => {
        bulkTableEmptyMessage.style.display = 'none';
        maxReceiptNum++
        const nextReceiptNum = `R${currentFY.slice(2,4)}${currentFY.slice(7,9)}-${(maxReceiptNum + 1).toString().padStart(4, '0')}`;

        addBulkReceiptRow(bulkReceiptTableBody, bulkTypeStudentRadio.checked, getSelectedFeeHeads(),nextReceiptNum);
    });

    // ... (rest of the event listeners and save button logic as before) ...
    // Make sure the event listener for 'input' on bulkReceiptTableBody is re-attached
    // or properly delegated to handle dynamic inputs. It already is in previous snippets.
    bulkReceiptTableBody.addEventListener('input', (e) => {
        if (e.target.classList.contains('fee-amount-input')) {
            updateBulkRowTotal(e.target.closest('tr'));
        }
        if (e.target.classList.contains('student-search-input')) {
            handleBulkStudentSearch(e.target);
        }
        if (e.target.classList.contains('total-amount-paid-input')) {
            // Only distribute for student rows
            if (bulkTypeStudentRadio.checked) {
                distributePayment(e.target.closest('tr'));
            } else {
                // For 'other' rows, the total amount paid IS the fee-amount-input, so just update row total
                updateBulkRowTotal(e.target.closest('tr'));
            }
        }
    });
    // For payment mode change, no action needed on change, just read on save.
    bulkReceiptTableBody.addEventListener('change', (e) => {});


    saveBulkReceiptsBtn.addEventListener('click', async () => {
        await saveBulkReceipts();
    });
}
// Helper to generate table headers
// Global array to store the fixed order of student fee heads for display/distribution logic
// This ensures consistent column order for student entry regardless of what's selected in the checkboxes
const allStudentFeeHeadsOrder = [
    'ADMISSION FEE', 'ARREARS',
    'TUITION FEE (T1)', 'TUITION FEE (T2)', 'TUITION FEE (T3)',
    'VEHICLE FEE (T1)', 'VEHICLE FEE (T2)', 'VEHICLE FEE (T3)',
    'EXAM FEE', 'MISC', 'CONCESSION' // Concession typically last or near end for clarity
];

function generateBulkReceiptTableHeaders(isStudentEntry, theadElement, selectedHeadsForDisplay) {
    let headersHTML = `<tr>
        <th>Action</th>
        <th>Receipt No.</th>
        `;

    if (isStudentEntry) {
        // For student entries, always use the predefined fixed order
        headersHTML += `
            <th>Admn No. / Student</th>
            <th>Class / Details</th>
            <th>Total Amount Paid</th>`;
        
        allStudentFeeHeadsOrder.forEach(head => { // Iterate through fixed order
            headersHTML += `<th>${head}</th>`;
        });

        headersHTML += `<th>Row Total</th>
                        <th>Payment Mode</th>`;
    } else {
        // For 'Other' entries, use dynamically selected heads
        headersHTML += `
            <th>Payer Details</th>`;
        selectedHeadsForDisplay.forEach(head => {
            headersHTML += `<th>${head}</th>`;
        });
        headersHTML += `<th>Row Total</th>
                        <th>Payment Mode</th>`;
    }
    headersHTML += `</tr>`;
    theadElement.innerHTML = headersHTML;
}

// Helper to add a new row
function addBulkReceiptRow(tbodyElement, isStudentEntry, selectedHeadsForNewRow,recno) {
   
   
    const row = document.createElement('tr');
    if (isStudentEntry) {
        // For student entries, dynamically create inputs for all fixed fee heads
        let feeInputsHTML = '';
        allStudentFeeHeadsOrder.forEach(head => { // Use the fixed order for inputs
            const readonlyAttr = head === 'CONCESSION' ? '' : ''; // Make concession editable if needed, others readonly
            feeInputsHTML += `<td><input type="number" class="form-control form-control-sm fee-amount-input" data-head="${head}" value="0" ${readonlyAttr}></td>`;
        });

        row.innerHTML = `
            <td><button type="button" class="btn btn-sm btn-outline-danger remove-bulk-row-btn">&times;</button></td>
            <td><span class="text-muted small">${recno}</span></td>
            <td>
                <input type="text" class="form-control form-control-sm student-search-input" placeholder="Admn No.">
                <small class="text-muted student-name-display"></small>
                <input type="hidden" class="student-id-input">
            </td>
            <td><small class="text-muted student-class-display"></small></td>
            <td><input type="number" class="form-control form-control-sm total-amount-paid-input" value="0" min="0"></td>
            ${feeInputsHTML} <td class="fw-bold total-row-amount">â‚¹ 0.00</td>
            <td>
                <select class="form-select form-select-sm payment-mode-select">
                    <option value="CASH">CASH</option>
                    <option value="BANK">BANK</option>
                </select>
            </td>
        `;
    } else {
        // For 'Other' entries, create inputs only for selected heads
        let dynamicInputsHTML = '';
        selectedHeadsForNewRow.forEach(head => {
            dynamicInputsHTML += `<td><input type="number" class="form-control form-control-sm fee-amount-input" data-head="${head}" value="0"></td>`;
        });

        row.innerHTML = `
            <td><button type="button" class="btn btn-sm btn-outline-danger remove-bulk-row-btn">&times;</button></td>
            <td><input type="text" class="form-control form-control-sm payer-name-input" placeholder="Payer Name"></td>
            ${dynamicInputsHTML}
            <td class="fw-bold total-row-amount">â‚¹ 0.00</td>
            <td>
                <select class="form-select form-select-sm payment-mode-select">
                    <option value="CASH">CASH</option>
                    <option value="BANK">BANK</option>
                </select>
            </td>
        `;
    }
    tbodyElement.appendChild(row);

    // Attach listener for the remove button
    row.querySelector('.remove-bulk-row-btn').addEventListener('click', () => {
        row.remove();
        if (tbodyElement.children.length === 0) {
            document.getElementById('bulk-table-empty-message').style.display = 'block';
        }
    });

}

// Helper to handle student search in bulk table
function handleBulkStudentSearch(inputElement) {
    const row = inputElement.closest('tr');
    const studentNameDisplay = row.querySelector('.student-name-display');
    const studentClassDisplay = row.querySelector('.student-class-display');
    const studentIdInput = row.querySelector('.student-id-input');
    const admnNo = inputElement.value.trim();

    const student = students.find(s => s.admissionNumber === admnNo);

    if (student) {
        studentNameDisplay.textContent = student.name;
        studentClassDisplay.textContent = `${classes.find(c => c.id === student.classId)?.name}-${student.division}`;
        studentIdInput.value = student.id;

        // Auto-fill relevant fees if a fee setup exists for the student
        const studentFeeSetup = studentFeeSetups.find(sfs => sfs.id === student.id);
        if (studentFeeSetup) {
            row.querySelectorAll('.fee-amount-input').forEach(input => {
                const head = input.dataset.head;
                // Map your setup fields to the table columns
                let amount = 0;
                if (head === 'ARREARS') amount = studentFeeSetup.arrears || 0;
                else if (head === 'TUITION FEE (T1)') amount = studentFeeSetup.tf1 || 0;
                else if (head === 'TUITION FEE (T2)') amount = studentFeeSetup.tf2 || 0;
                else if (head === 'TUITION FEE (T3)') amount = studentFeeSetup.tf3 || 0;
                else if (head === 'VEHICLE FEE (T1)') amount = studentFeeSetup.vf1 || 0;
                else if (head === 'VEHICLE FEE (T2)') amount = studentFeeSetup.vf2 || 0;
                else if (head === 'VEHICLE FEE (T3)') amount = studentFeeSetup.vf3 || 0;
                else if (head === 'EXAM FEE') amount = studentFeeSetup.examFee || 0;
                else if (head === 'CONCESSION') amount = -(studentFeeSetup.concession || 0); // Concession is subtracted, so store as negative for sum
                // For 'ADMISSION FEE' or 'MISC', leave as 0 unless you have a default
                
                input.value = amount.toFixed(2);
            });
        }
    } else {
        studentNameDisplay.textContent = 'Student not found.';
        studentClassDisplay.textContent = '';
        studentIdInput.value = '';
        row.querySelectorAll('.fee-amount-input').forEach(input => input.value = '0.00'); // Clear amounts if student not found
    }
    updateBulkRowTotal(row);
}

// Helper to update total for a single row in bulk table
function updateBulkRowTotal(row) {
    let total = 0;
    row.querySelectorAll('.fee-amount-input').forEach(input => {
        const amount = parseFloat(input.value) || 0;
        const head = input.dataset.head;
        if (head === 'CONCESSION') { // Deduct concession from total
            total -= amount;
        } else {
            total += amount;
        }
    });
    row.querySelector('.total-row-amount').textContent = `â‚¹ ${total.toFixed(2)}`;
}

// Function to save all bulk receipts
async function saveBulkReceipts() {
    const bulkReceiptTableBody = document.getElementById('bulk-receipt-table-body');
    const bulkReceiptDate = document.getElementById('bulk-receipt-date').value;
    const bulkFinancialYear = document.getElementById('bulk-financial-year').value;
    const isStudentEntry = document.getElementById('bulk-type-student').checked;

    const saveButton = document.getElementById('save-bulk-receipts-btn');
    const originalButtonHtml = saveButton.innerHTML;
    saveButton.disabled = true;
    saveButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...`;

    if (!bulkReceiptDate) {
        showAlert('Please select a date for the receipts.', 'danger');
        saveButton.disabled = false;
        saveButton.innerHTML = originalButtonHtml;
        return;
    }

    const rows = Array.from(bulkReceiptTableBody.children);
    if (rows.length === 0) {
        showAlert('No receipt entries to save.', 'warning');
        saveButton.disabled = false;
        saveButton.innerHTML = originalButtonHtml;
        return;
    }

    const batch = writeBatch(db);
    let receiptsSavedCount = 0;

    // To get the latest sequence number robustly:
    let maxExistingNum = 0;
    try {
        const q = query(collection(db, `/artifacts/${appId}/public/data/feeData/${bulkFinancialYear}/receipts`), orderBy("receiptNo", "desc"), limit(1));
        const lastReceiptSnapshot = await getDocs(q);
        if (!lastReceiptSnapshot.empty) {
            const lastReceiptNo = lastReceiptSnapshot.docs[0].data().receiptNo;
            maxExistingNum = parseInt(lastReceiptNo.split('-')[1], 10);
        }
    } catch (e) {
        console.warn("Could not get latest receipt number from Firestore, falling back to local array.", e);
        maxExistingNum = receipts.filter(r => r.financialYear === bulkFinancialYear && r.receiptNo.startsWith(`R${bulkFinancialYear.slice(2,4)}${bulkFinancialYear.slice(7,9)}`))
                                 .reduce((max, r) => {
                                     const numPart = parseInt(r.receiptNo.split('-')[1], 10);
                                     return numPart > max ? numPart : max;
                                 }, 0);
    }

    for (const row of rows) {
        const totalAmountText = row.querySelector('.total-row-amount').textContent;
        const totalAmount = parseFloat(totalAmountText.replace('â‚¹ ', '')) || 0;

        if (totalAmount <= 0) {
            console.warn('Skipping row with zero or negative total amount:', row);
            continue;
        }

        const items = [];
        let payerName = '';
        let studentId = null;
        const paymentMode = row.querySelector('.payment-mode-select').value;

        if (isStudentEntry) {
            studentId = row.querySelector('.student-id-input').value;
            payerName = row.querySelector('.student-name-display').textContent;
            if (!studentId || payerName === 'Student not found.' || payerName.trim() === '') {
                showAlert(`One or more student rows do not have a valid student selected. Skipping row.`, 'danger');
                continue;
            }
        } else {
            payerName = row.querySelector('.payer-name-input').value.trim();
            if (!payerName) {
                showAlert('One or more "Other" rows do not have a payer name. Skipping row.', 'danger');
                continue;
            }
        }

        row.querySelectorAll('.fee-amount-input').forEach(input => {
            const head = input.dataset.head;
            const amount = parseFloat(input.value) || 0;
            if (amount !== 0) {
                items.push({ head, amount });
            }
        });

        // Generate the receipt number for THIS receipt in the batch
        const receiptNo = `${`R${bulkFinancialYear.slice(2,4)}${bulkFinancialYear.slice(7,9)}`}-${(maxExistingNum + receiptsSavedCount + 1).toString().padStart(4, '0')}`;


        const receiptData = {
            receiptNo,
            date: bulkReceiptDate,
            financialYear: bulkFinancialYear,
            isStudent: isStudentEntry,
            payerName,
            studentId: isStudentEntry ? studentId : null,
            items,
            totalAmount,
            paymentMode,
            isCancelled: false,
            timestamp: serverTimestamp()
        };

        batch.set(getFeeDocRef(bulkFinancialYear, 'receipts', receiptNo), receiptData);
        receiptsSavedCount++;
    }

    if (receiptsSavedCount === 0) {
        showAlert('No valid receipts were found in the table to save.', 'info');
        saveButton.disabled = false;
        saveButton.innerHTML = originalButtonHtml;
        return;
    }

    try {
        await batch.commit();
        showAlert(`Successfully saved ${receiptsSavedCount} bulk receipts!`, 'success');
        renderBulkReceiptForm();
    } catch (error) {
        console.error("Error saving bulk receipts:", error);
        showAlert('Failed to save bulk receipts. See console for details.', 'danger');
    } finally {
        saveButton.disabled = false;
        saveButton.innerHTML = originalButtonHtml;
    }
}
function distributePayment(row) {
    const totalAmountPaidInput = row.querySelector('.total-amount-paid-input');
    let amountToDistribute = parseFloat(totalAmountPaidInput.value) || 0;

    const pendingFeesString = row.dataset.pendingFees;
    let pendingFees = {};
    try {
        pendingFees = JSON.parse(pendingFeesString || '{}');
    } catch (e) {
        console.error("Error parsing pendingFees from dataset:", e);
        return;
    }

    // Define a payment order for fee heads (prioritize overdue, then terms)
    // You can customize this order based on your school's policy
    const paymentOrder = [
        'ARREARS',
        'ADMISSION FEE',
        'TUITION FEE (T1)', 'VEHICLE FEE (T1)', // Term 1 priority
        'TUITION FEE (T2)', 'VEHICLE FEE (T2)', // Term 2 priority
        'TUITION FEE (T3)', 'VEHICLE FEE (T3)', // Term 3 priority
        'EXAM FEE',
        'MISC' // General items last, if applicable
    ];

    // Clear current inputs (except concession, which is different)
    row.querySelectorAll('.fee-amount-input:not([data-head="CONCESSION"])').forEach(input => input.value = '0.00');

    // First, apply any existing concessions from the setup.
    // If the concession is positive (an amount given), we consider it "paid" from the totalAmountPaid initially.
    let appliedConcession = 0;
    if (pendingFees['CONCESSION'] > 0) {
        // Only apply up to the amount paid, and up to the concession itself
        appliedConcession = Math.min(amountToDistribute, pendingFees['CONCESSION']);
        row.querySelector('.fee-amount-input[data-head="CONCESSION"]').value = (-appliedConcession).toFixed(2); // Display as negative
        amountToDistribute -= appliedConcession;
    } else {
         row.querySelector('.fee-amount-input[data-head="CONCESSION"]').value = '0.00';
    }


    // Distribute the remaining amount across pending heads
    for (const head of paymentOrder) {
        if (amountToDistribute <= 0) break; // No more amount to distribute

        const input = row.querySelector(`.fee-amount-input[data-head="${head}"]`);
        if (!input) continue; // Skip if this head's input doesn't exist

        let pendingForThisHead = pendingFees[head] || 0;

        if (pendingForThisHead > 0) {
            const amountToPay = Math.min(amountToDistribute, pendingForThisHead);
            input.value = amountToPay.toFixed(2);
            amountToDistribute -= amountToPay;
        }
    }

    // If there's still a positive amountToDistribute, put it into MISC
    if (amountToDistribute > 0) {
        const miscInput = row.querySelector('.fee-amount-input[data-head="MISC"]');
        if (miscInput) {
            miscInput.value = (parseFloat(miscInput.value) + amountToDistribute).toFixed(2);
        }
    }

    updateBulkRowTotal(row); // Update the row's displayed total
}

// --- GLOBAL STATE ---

/**
 * The form currently being edited or created.
 * @type {object | null}
 */

// --- CORE RENDERING FUNCTIONS ---

/**
 * Renders the main form management interface for administrators.
 * Displays a table of all created forms with options to create, edit, toggle status, and view responses.
 */
window.renderFormManagement = () => {
    formToEdit = null; // Ensure formToEdit is reset for a fresh start
    const mainContent = document.getElementById('main-content');
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }

    const tableRows = forms.map(form => `
        <tr>
            <td>${form.title}</td>
            <td>${form.target}</td>
            <td>${form.classId || 'All'}</td>
            <td>${form.division || 'All'}</td>
            <td>
                <span class="badge bg-${form.isActive ? 'success' : 'secondary'}">
                    ${form.isActive ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-primary me-1" data-form-id="${form.id}" data-action="edit">Edit</button>
                <button class="btn btn-sm btn-warning" data-form-id="${form.id}" data-action="toggle-status">${form.isActive ? 'Deactivate' : 'Activate'}</button>
                <button class="btn btn-sm btn-outline-info" data-form-id="${form.id}" data-action="view-responses">Responses</button>
            </td>
        </tr>
    `).join('');

    const content = `
        <h1 class="h2 mb-4">Form Management</h1>
        <div class="text-end mb-3">
            <button class="btn btn-primary" id="create-new-form-btn">+ Create New Form</button>
        </div>
        ${forms.length ? `
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Target</th>
                            <th>Class</th>
                            <th>Division</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            </div>
        ` : '<p class="text-muted">No forms available.</p>'}
    `;

    mainContent.innerHTML = content;

    // Attach event listeners
    document.getElementById('create-new-form-btn')?.addEventListener('click', window.startNewForm);
    mainContent.addEventListener('click', (e) => {
        const target = e.target;
        const formId = target.dataset.formId;
        if (!formId) return;

        const action = target.dataset.action;
        if (action === 'edit') window.editForm(formId);
        if (action === 'toggle-status') window.toggleFormStatus(formId);
        if (action === 'view-responses') window.viewFormResponses(formId);
    });
};
/**
 * Renders the form builder interface for creating or editing a form.
 */
function renderFormBuilder() {
    // Ensure formToEdit is an object with default properties if it's null (for new forms)
    // or use the existing formToEdit if editing.
    formToEdit = formToEdit || { title: '', target: 'student', classId: '', division: '', fields: [], isActive: true };
    const isEdit = !!formToEdit.id;
    const form = formToEdit; // Now 'form' is guaranteed to have the structure

    const mainContent = document.getElementById('main-content'); // Ensure mainContent is defined here
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }

    // Main HTML structure for the form builder
    mainContent.innerHTML = `
        <h1 class="h2 mb-4">${isEdit ? 'Edit Form' : 'Create Form'}</h1>
        <form id="form-builder">
            <div class="mb-3">
                <label class="form-label">Form Title</label>
                <input class="form-control" id="form-title" value="${form.title}" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Target</label>
                <select class="form-select" id="form-target">
                    <option value="student" ${form.target === 'student' ? 'selected' : ''}>Students</option>
                    <option value="teacher" ${form.target === 'teacher' ? 'selected' : ''}>Teachers</option>
                    <option value="classwise" ${form.target === 'classwise' ? 'selected' : ''}>Class-wise (Teacher fills for students)</option>
                
                </select>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <label class="form-label">Class</label>
                    <select class="form-select" id="form-class">
                        <option value="">--All--</option>
                        ${classes.map(c => `<option value="${c.id}" ${form.classId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                    </select>
                </div>
                <div class="col">
                    <label class="form-label">Division</label>
                    <input class="form-control" id="form-division" value="${form.division || ''}" placeholder="e.g., A">
                </div>
            </div>
            <div class="mb-3">
                <h5>Fields</h5>
                <div id="field-list"></div>
                <button type="button" class="btn btn-outline-primary mt-2" id="add-field-btn">Add Field</button>
            </div>
            <button type="submit" class="btn btn-success">${isEdit ? 'Update' : 'Create'} Form</button>
        </form>
    `;

    const fieldListContainer = document.getElementById('field-list');
    if (!fieldListContainer) {
        console.error('Field list container not found!');
        return;
    }

    // Initial render of the fields
    renderFieldList(form.fields);

    // --- SINGLE EVENT LISTENER SETUP ---
    // This listener is attached ONCE to the container and handles all clicks inside it.
    fieldListContainer.addEventListener('click', (e) => {
        const target = e.target;
        const action = target.dataset.action;
        if (!action) return;

        const fieldIndex = parseInt(target.dataset.fieldIndex, 10);
        // Validate fieldIndex
        if (isNaN(fieldIndex) || fieldIndex < 0 || fieldIndex >= formToEdit.fields.length) {
            console.warn('Invalid field index for action:', action, fieldIndex);
            return;
        }
        
        switch (action) {
            case 'remove-field':
                formToEdit.fields.splice(fieldIndex, 1);
                break;
            case 'add-condition':
                // Ensure conditions array exists before pushing
                if (!formToEdit.fields[fieldIndex].conditions) {
                    formToEdit.fields[fieldIndex].conditions = [];
                }
                formToEdit.fields[fieldIndex].conditions.push({ field: '', value: '' });
                break;
            case 'remove-condition':
                const conditionIndex = parseInt(target.dataset.conditionIndex, 10);
                // Validate conditionIndex
                if (isNaN(conditionIndex) || conditionIndex < 0 || !formToEdit.fields[fieldIndex].conditions || conditionIndex >= formToEdit.fields[fieldIndex].conditions.length) {
                    console.warn('Invalid condition index for action:', action, conditionIndex);
                    return;
                }
                formToEdit.fields[fieldIndex].conditions.splice(conditionIndex, 1);
                break;
            default:
                return; // Do nothing if the action is unknown
        }
        
        // Re-render the list to show the change
        renderFieldList(formToEdit.fields);
    });
    
    // Listener for input/select changes
    fieldListContainer.addEventListener('change', (e) => {
        const target = e.target;
        const { fieldIndex, key, conditionIndex } = target.dataset;
        if (fieldIndex === undefined || key === undefined) return;

        const value = target.type === 'checkbox' ? target.checked : target.value;
        const index = parseInt(fieldIndex, 10);

        if (isNaN(index) || index < 0 || index >= formToEdit.fields.length) {
            console.warn('Invalid field index for change event:', index);
            return;
        }

        if (conditionIndex !== undefined) {
            const condIdx = parseInt(conditionIndex, 10);
            if (isNaN(condIdx) || condIdx < 0 || !formToEdit.fields[index].conditions || condIdx >= formToEdit.fields[index].conditions.length) {
                console.warn('Invalid condition index for change event:', condIdx);
                return;
            }
            formToEdit.fields[index].conditions[condIdx][key] = value;
        } else {
            formToEdit.fields[index][key] = key === 'options' ? value.split(',').map(s => s.trim()) : value;
        }

        // If the field type was changed, we must re-render to show/hide the 'options' input
        if (key === 'type') {
            renderFieldList(formToEdit.fields);
        }
    });

    // Listener for the main "Add Field" button
    document.getElementById('add-field-btn')?.addEventListener('click', () => {
        formToEdit.fields.push({ label: '', type: 'text', required: false, conditions: [] });
        renderFieldList(formToEdit.fields);
    });

    // Listener for the form submission
    document.getElementById('form-builder')?.addEventListener('submit', handleFormSave);
}
/**
 * Renders the list of fields. This function is now simpler and only handles rendering.
 * @param {Array<object>} fields - The array of form fields.
 */
function renderFieldList(fields) {
    const container = document.getElementById('field-list');
    if (container) {
        // Ensure fields is an array before mapping
        container.innerHTML = (Array.isArray(fields) ? fields : []).map((field, index) => renderField(field, index, fields)).join('');
    } else {
        console.error('Field list container not found for rendering fields!');
    }
}
/**
 * Renders a single field card in the form builder, now with an optional "Column Header" for amount fields.
 */
function renderField(field, index, allFields) {
    const fieldTypes = ['text', 'checkbox', 'dropdown', 'multiselect', 'date', 'amount'];
    const typeOptions = fieldTypes.map(type => `<option value="${type}" ${field.type === type ? 'selected' : ''}>${type.charAt(0).toUpperCase() + type.slice(1)}</option>`).join('');

    const currentField = { 
        label: field.label || '', 
        type: field.type || 'text', 
        options: Array.isArray(field.options) ? field.options : [], 
        helper: field.helper || '', 
        placeholder: field.placeholder || '', 
        required: !!field.required,
        totalHeader: field.totalHeader || '', // <-- NEW: Add totalHeader property
        conditions: Array.isArray(field.conditions) ? field.conditions : [] 
    };

    // HTML for the optional column header input, shown only for 'amount' type
    const totalHeaderInputHtml = currentField.type === 'amount' 
        ? `<div class="mb-2">
               <label>Column Header for Totaling (Optional)</label>
               <input class="form-control" data-field-index="${index}" data-key="totalHeader" value="${currentField.totalHeader}" placeholder="e.g., Travel Expenses">
               <small class="form-text text-muted">Amounts with the same header will be summed up.</small>
           </div>`
        : '';

    return `
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-2"><label>Label</label><input class="form-control" data-field-index="${index}" data-key="label" value="${currentField.label}"></div>
                    <div class="col-md-6 mb-2"><label>Type</label><select class="form-select" data-field-index="${index}" data-key="type">${typeOptions}</select></div>
                </div>
                ${['dropdown','multiselect'].includes(currentField.type) ? `<div class="mb-2"><label>Options (comma separated)</label><input class="form-control" data-field-index="${index}" data-key="options" value="${currentField.options.join(', ')}"></div>` : ''}
                ${totalHeaderInputHtml}
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label>Helper Text</label>
                        <input class="form-control" data-field-index="${index}" data-key="helper" value="${currentField.helper}">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label>Placeholder</label>
                        <input class="form-control" data-field-index="${index}" data-key="placeholder" value="${currentField.placeholder}">
                    </div>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" data-field-index="${index}" data-key="required" ${currentField.required ? 'checked' : ''}>
                    <label class="form-check-label">Required</label>
                </div>
                <div class="mt-3 border-top pt-2">
                    <label class="form-label">Conditional Display</label>
                    <div id="conditions_${index}">${renderConditions(currentField, index, allFields)}</div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-action="add-condition" data-field-index="${index}">+ Add Condition</button>
                    ${currentField.conditions.length ? `<div class="text-muted small mt-1"><i class="fa fa-eye"></i> Shown if all conditions match</div>` : ''}
                </div>
                <button class="btn btn-sm btn-outline-danger mt-3" data-action="remove-field" data-field-index="${index}">Remove Field</button>
            </div>
        </div>
    `;
}

/**
 * Renders the conditional logic inputs for a field.
 * @param {object} field - The field object.
 * @param {number} fieldIndex - The index of the field.
 * @param {Array<object>} allFields - All fields in the form.
 * @returns {string} The HTML for the conditions.
 */
function renderConditions(field, fieldIndex, allFields) {
    // Ensure field.conditions is an array before iterating
    const conditions = Array.isArray(field.conditions) ? field.conditions : [];

    // Filter out the current field itself from the list of fields to depend on
    const availableFieldsForConditions = allFields.filter((_, i) => i !== fieldIndex);

    return conditions.map((cond, condIndex) => `
        <div class="row g-2 align-items-center mb-2">
            <div class="col">
                <select class="form-select" data-field-index="${fieldIndex}" data-condition-index="${condIndex}" data-key="field">
                    <option value="">-- Select Field --</option>
                    ${availableFieldsForConditions.map(opt => `<option value="${opt.label}" ${opt.label === cond.field ? 'selected' : ''}>${opt.label}</option>`).join('')}
                </select>
            </div>
            <div class="col"><input class="form-control" placeholder="Value" data-field-index="${fieldIndex}" data-condition-index="${condIndex}" data-key="value" value="${cond.value || ''}"></div>
            <div class="col-auto"><button class="btn btn-sm btn-outline-danger" data-action="remove-condition" data-field-index="${fieldIndex}" data-condition-index="${condIndex}">Ã—</button></div>
        </div>
    `).join('');
}/**
 * Initializes a new form object and renders the form builder.
 */
window.startNewForm = () => {
    formToEdit = { title: '', target: 'student', classId: '', division: '', fields: [], isActive: true };
    renderFormBuilder();
};/**
 * Finds a form by ID and renders the form builder for editing.
 * @param {string} id - The ID of the form to edit.
 */
window.editForm = (id) => {
    const form = forms.find(f => f.id === id);
    if (form) {
        // Deep copy to avoid direct mutation of the global 'forms' array
        formToEdit = JSON.parse(JSON.stringify(form)); 
        renderFormBuilder();
    } else {
        showAlert('Form not found for editing.', 'danger');
        console.warn('Form not found for editing:', id);
    }
};/**
 * Toggles the active status of a form.
 * @param {string} id - The ID of the form.
 */
window.toggleFormStatus = async (id) => {
    const form = forms.find(f => f.id === id);
    if (form) {
        try {
            await setDoc(getDocRef('forms', id), { ...form, isActive: !form.isActive });
            showAlert(`Form ${form.isActive ? 'deactivated' : 'activated'} successfully.`, 'success');
            // The UI is expected to update via real-time listeners.
            // If not, you would call renderFormManagement() here.
        } catch (error) {
            console.error('Failed to toggle form status:', error);
            showAlert('Failed to update form status. Please try again.', 'danger');
        }
    } else {
        showAlert('Form not found for status toggle.', 'danger');
        console.warn('Form not found for status toggle:', id);
    }
};/**
 * Handles the saving or updating of a form from the form builder.
 * @param {Event} e - The form submission event.
 */
async function handleFormSave(e) {
    e.preventDefault();
    
    const titleInput = document.getElementById('form-title');
    const title = titleInput ? titleInput.value.trim() : '';

    if (!title) {
        showAlert('Form title is required.', 'warning');
        if (titleInput) titleInput.focus();
        return;
    }

    const formTargetEl = document.getElementById('form-target');
    const formClassEl = document.getElementById('form-class');
    const formDivisionEl = document.getElementById('form-division');

    const id = formToEdit.id || `form_${Date.now()}`;
    const data = {
        id,
        title,
        target: formTargetEl ? formTargetEl.value : 'student', // Default if element not found
        classId: formClassEl ? formClassEl.value : '',
        division: formDivisionEl ? formDivisionEl.value.trim() : '',
        fields: formToEdit.fields,
        isActive: formToEdit.isActive,
    };

    try {
        await setDoc(getDocRef('forms', id), data);
        showAlert('Form saved successfully!', 'success');
        formToEdit = null; // Clear the edit state
        renderFormManagement(); // Go back to the form management view
    } catch (error) {
        console.error('Error saving form:', error);
        showAlert('An error occurred while saving the form. Please try again.', 'danger');
    }
}/**
 * Displays all responses for a specific form.
 * @param {string} formId - The ID of the form.
 */
/**
 * Displays all responses for a specific form with filters for class and division.
 * @param {string} formId - The ID of the form.
 */
/**
 * Displays all responses for a specific form with filters for class and division,
 * a dynamic total row for amount fields, and a filtered print option.
 * @param {string} formId - The ID of the form.
 */
window.viewFormResponses = (formId) => {
    const form = forms.find(f => f.id === formId);
    if (!form) {
        showAlert('Form not found.', 'danger');
        return;
    }

    const mainContent = document.getElementById('main-content');
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }
    
    const classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Responses: ${form.title}</h1>
        
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="response-class-filter" class="form-label">Filter by Class</label>
                        <select id="response-class-filter" class="form-select">
                            <option value="">All Classes</option>
                            ${classOptions}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="response-division-filter" class="form-label">Filter by Division</label>
                        <select id="response-division-filter" class="form-select" disabled>
                            <option value="">All Divisions</option>
                        </select>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group">
                             <button id="export-responses-csv-btn" class="btn btn-success"><i class="fas fa-file-csv me-2"></i>Export CSV</button>
                             <button id="export-responses-pdf-btn" class="btn btn-danger"><i class="fas fa-file-pdf me-2"></i>Export PDF</button>
                             <button id="print-filtered-responses-btn" class="btn btn-secondary"><i class="fas fa-print me-2"></i>Print Filtered</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped" id="form-responses-table">
                <thead></thead>
                <tbody></tbody>
                <tfoot></tfoot>
            </table>
        </div>
        <div class="mt-3 text-end">
            <button class="btn btn-secondary" onclick="renderFormManagement()">Back to Forms</button>
        </div>
    `;

    const classFilter = document.getElementById('response-class-filter');
    const divisionFilter = document.getElementById('response-division-filter');
    const table = document.getElementById('form-responses-table');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    const tfoot = table.querySelector('tfoot');

    const renderTable = () => {
        const selectedClassId = classFilter.value;
        const selectedDivision = divisionFilter.value;

        let filteredResponses = formResponses.filter(r => r.formId === formId);

        if (selectedClassId) {
            const studentIdsInClass = students.filter(s => s.classId === selectedClassId).map(s => s.id);
            filteredResponses = filteredResponses.filter(r => studentIdsInClass.includes(r.userId));
        }
        if (selectedDivision) {
            const studentIdsInDivision = students.filter(s => s.classId === selectedClassId && s.division === selectedDivision).map(s => s.id);
            filteredResponses = filteredResponses.filter(r => studentIdsInDivision.includes(r.userId));
        }

        const headers = ['User ID', 'User Name', ...form.fields.map(f => f.label), 'Status'];
        thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

        if (filteredResponses.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center">No responses match your filters.</td></tr>`;
            tfoot.innerHTML = ''; // Clear footer if no data
            return;
        }

        tbody.innerHTML = filteredResponses.map(r => {
            const user = students.find(s => s.id === r.userId) || teachers.find(t => t.id === r.userId);
            const userName = user ? user.name : 'Unknown User';
            const valuesHtml = form.fields.map(f => {
                const key = f.label.replace(/\s+/g, '_').toLowerCase();
                const value = r.values[key];
                return `<td>${value !== undefined && value !== null ? value : 'â€”'}</td>`;
            }).join('');
            return `<tr><td>${r.userId}</td><td>${userName}</td>${valuesHtml}<td><span class="badge bg-info">${r.status || 'N/A'}</span></td></tr>`;
        }).join('');

        // --- NEW: Calculate and Render Totals Row ---
        const amountFields = form.fields.filter(f => f.type === 'amount');
        if (amountFields.length > 0) {
            const totalCells = form.fields.map(field => {
                if (field.type === 'amount') {
                    const key = field.label.replace(/\s+/g, '_').toLowerCase();
                    const total = filteredResponses.reduce((sum, r) => sum + (parseFloat(r.values[key]) || 0), 0);
                    return `<td class="fw-bold">â‚¹ ${total.toFixed(2)}</td>`;
                }
                return '<td></td>';
            }).join('');
            tfoot.innerHTML = `<tr class="table-light"><th colspan="2" class="text-end">Total</th>${totalCells}<th></th></tr>`;
        } else {
            tfoot.innerHTML = ''; // Ensure footer is empty if no amount fields
        }
    };

    classFilter.addEventListener('change', () => {
        const selectedClass = classes.find(c => c.id === classFilter.value);
        divisionFilter.innerHTML = '<option value="">All Divisions</option>';
        if (selectedClass) {
            divisionFilter.disabled = false;
            divisionFilter.innerHTML += selectedClass.divisions.map(d => `<option value="${d}">${d}</option>`).join('');
        } else {
            divisionFilter.disabled = true;
        }
        renderTable();
    });

    divisionFilter.addEventListener('change', renderTable);
    
    // Attach export and print listeners
    document.getElementById('export-responses-csv-btn').addEventListener('click', () => downloadFormResponsesCSV(form.id, classFilter.value, divisionFilter.value));
    document.getElementById('export-responses-pdf-btn').addEventListener('click', () => downloadStudentSubmissionsPDF(form.id));
    document.getElementById('print-filtered-responses-btn').addEventListener('click', () => {
        const tableHtml = document.getElementById('form-responses-table').outerHTML;
        const className = classFilter.options[classFilter.selectedIndex]?.text || 'All Classes';
        const divisionName = divisionFilter.options[divisionFilter.selectedIndex]?.text || 'All Divisions';
        
        const reportTitle = `${form.title}`;
        const subTitle = `by: ${className} - ${divisionName}`;
const customHeaderHtml = `
        <div style="text-align: center; margin-bottom: 20px;">
            ${schoolDetails.logoUrl ? `<img src="${schoolDetails.logoUrl}" alt="School Logo" style="max-height: 80px;">` : ''}
            <h3>${schoolDetails.name || 'School Name'}</h3>
            <h5>${reportTitle}</h5>
            <h4 class="text-muted">${subTitle}</h4>

        </div>
    `;
        printReport({
            contentHtml: `<div class="printable-report">${tableHtml}</div>`,
            title: form.title,
            reportHeader: { title: reportTitle, subTitle: subTitle },
            customHeaderHtml: customHeaderHtml
        });
    });

    renderTable();
};

/**
 * Generates a standardized HTML header for all printable reports.
 * @param {object} headerInfo - An object containing the title and subtitle for the report.
 * @param {string} headerInfo.title - The main title of the report.
 * @param {string} headerInfo.subTitle - The subtitle, typically showing the filter conditions.
 * @returns {string} The complete HTML string for the report header.
 */
function generateReportHeaderHTML(headerInfo) {
    const { title, subTitle } = headerInfo;

    // This layout uses a side-by-side logo and school name, as requested previously.
    return `
        <div class="report-header mb-4">
            <div class="row align-items-center">
                <div class="col-2 text-start">
                    ${schoolDetails.logoUrl ? `<img src="${schoolDetails.logoUrl}" style="max-height: 80px;">` : ''}
                </div>
                <div class="col-10 text-center">
                    <h3>${schoolDetails.name || 'School Report'}</h3>
                    <p class="mb-0">${schoolDetails.address || ''}</p>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <h4>${title || 'Report'}</h4>
                ${subTitle ? `<p class="text-muted">${subTitle}</p>` : ''}
            </div>
        </div>
    `;
}
// --- TEACHER-SPECIFIC VIEWS ---
/**
 * Renders the dashboard for teachers to see forms they need to fill
 * and to review submissions from students in their class.
 */
/**
 * Renders an interactive dashboard for teachers to see their personal forms
 * and select a class form to view student submissions on-demand.
 */
window.renderTeacherForms = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }

    if (!selectedUser || !selectedUser.classCharge) {
        mainContent.innerHTML = '<p class="text-danger">Error: Teacher class information not available.</p>';
        return;
    }

    const { classId, division } = selectedUser.classCharge;
    
    // Get forms targeted to the teacher's class
    const studentForms = forms.filter(f => 
        f.target === 'student' && 
        f.isActive &&
        (!f.classId || f.classId === classId) && 
        (!f.division || f.division === division)
    );

    // --- NEW: Create dropdown options from the filtered forms ---
    const formOptions = studentForms.map(form => `<option value="${form.id}">${form.title}</option>`).join('');

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Teacher Dashboard</h1>
        
        <div class="card shadow-sm mb-4">
            <div class="card-header fw-bold">My Personal Forms</div>
            <div class="card-body" id="teacher-personal-forms">
                </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header fw-bold">Student Submissions</div>
            <div class="card-body">
                <p class="text-muted">Select a form to view the submission status and details for students in your class.</p>
                <div class="row">
                    <div class="col-md-8">
                        <select id="student-form-selector" class="form-select">
                            <option value="">-- Select a Student Form to Review --</option>
                            ${formOptions}
                        </select>
                    </div>
                </div>
                <hr>
                <div id="student-submission-table-container" class="mt-3">
                    </div>
            </div>
        </div>
    `;

    // Render personal forms into its dedicated container
    renderMyForms(document.getElementById('teacher-personal-forms'));

    // --- NEW: Add event listener for the form selector dropdown ---
    const formSelector = document.getElementById('student-form-selector');
    const tableContainer = document.getElementById('student-submission-table-container');

    formSelector.addEventListener('change', () => {
        const selectedFormId = formSelector.value;
        if (!selectedFormId) {
            tableContainer.innerHTML = ''; // Clear the container if no form is selected
            return;
        }

        const selectedForm = studentForms.find(form => form.id === selectedFormId);
        if (selectedForm) {
            // Get active students for this class
            const studentsInClass = students.filter(s => s.classId === classId && s.division === division && s.status !== 'Inactive' && s.status !== 'Graduated').sort((a, b) => a.name.localeCompare(b.name));
            // Render the detailed table for the selected form
            tableContainer.innerHTML = renderStudentSubmissionTable(selectedForm, studentsInClass);
        }
    });
};


window.renderTeacherclasswiseForms = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }

    if (!selectedUser || !selectedUser.classCharge) {
        mainContent.innerHTML = '<p class="alert alert-danger">Error: Teacher class information not available.</p>';
        return;
    }

    const { classId, division } = selectedUser.classCharge;
    const teacherClassName = classes.find(c => c.id === classId)?.name || `Class ${classId}`;

    // Filter forms that are specifically targeted as 'classwise' AND active
    // And match the teacher's class/division or are for 'All' classes/divisions.
    const classForms = forms.filter(f =>
        f.target === 'classwise' && // Assuming a new 'classwise' target type for these forms
        f.isActive &&
        (!f.classId || f.classId === classId) &&
        (!f.division || f.division === division)
    );

    // Initial render of the dashboard structure
    mainContent.innerHTML = `
        <h1 class="h2 mb-4">ðŸ“‹ Classwise Forms for ${teacherClassName} - ${division}</h1>
        <div class="mb-4 d-flex align-items-center gap-2">
            <label for="class-form-selector" class="form-label mb-0 fw-bold">Select Form:</label>
            <select class="form-select w-auto" id="class-form-selector">
                <option value="">-- Choose a form to review --</option>
                ${classForms.map(f => `<option value="${f.id}">${f.title}</option>`).join('')}
            </select>
        </div>
        <div id="class-form-response-table">
            <p class="text-muted">Please select a form from the dropdown to view and manage student data.</p>
        </div>
    `;

    // Event listener for form selection dropdown
    document.getElementById('class-form-selector')?.addEventListener('change', e => {
        const formId = e.target.value;
        if (!formId) {
            document.getElementById('class-form-response-table').innerHTML = '<p class="text-muted">Please select a form from the dropdown to view and manage student data.</p>';
            return;
        }

        const selectedForm = classForms.find(f => f.id === formId);
        if (!selectedForm) {
            showAlert('Selected form not found.', 'danger');
            return;
        }

        // Render the detailed table for the selected form
        renderClassFormSubmissionTable(selectedForm, classId, division);
    });
};

// --- New Helper Function for Conditional Field Display in Teacher View ---
/**
 * Determines if a field's input should be enabled/disabled in the teacher's classwise view
 * based on its conditional logic and the student's current (or submitted) values.
 * @param {object} field - The field configuration object.
 * @param {object} studentValues - The current/submitted values for the student for this form.
 * @param {Array<object>} allFormFields - All fields in the form config.
 * @returns {boolean} True if the field should be enabled, false if disabled.
 */
window.shouldShowFieldForTeacherView = (field, studentValues, allFormFields) => {
    // If no conditions, or conditions array is empty, always show/enable
    if (!field.conditions || field.conditions.length === 0) {
        return true;
    }

    // Check if ALL conditions are met based on the student's current values
    return field.conditions.every(cond => {
        const conditionField = allFormFields.find(f => f.label === cond.field);
        if (!conditionField) {
            // If the field this condition depends on doesn't exist, treat as not met or handle as error
            console.warn(`Condition field "${cond.field}" not found for "${field.label}".`);
            return false;
        }
        const normalizedConditionLabel = conditionField.label.replace(/\s+/g, '_').toLowerCase();
        const actualValue = studentValues[normalizedConditionLabel];
        
        // Convert actualValue to string for consistent comparison if needed
        const actualValueString = (actualValue !== undefined && actualValue !== null) ? String(actualValue) : '';

        // Compare actual value (from student's response) with the required condition value
        return actualValueString === String(cond.value || ''); // Ensure both are strings for comparison
    });
};


// --- New Function to Render the Detailed Submission Table for Teachers ---
/**
 * Renders the detailed table of student submissions for a selected form.
 * @param {object} form - The selected form object.
 * @param {string} classId - The class ID the teacher is viewing.
 * @param {string} division - The division the teacher is viewing.
 */
/**
 * Renders the data entry table for a class-wise form, including a dynamic total row 
 * and correctly rendering 'amount' fields.
 */
/**
 * Renders the data entry table for a class-wise form, now with mobile-friendly adjustments
 * and corrected column alignment.
 */
function renderClassFormSubmissionTable(form, classId, division) {
    const studentsInClass = students
        .filter(s => s.classId === classId && s.division === division && s.status !== 'TC Issued' && s.status !== 'Graduated')
        .sort((a, b) => a.name.localeCompare(b.name));
        
    const tableContainer = document.getElementById('class-form-response-table');
    if (!tableContainer) {
        console.error('Table response container not found!');
        return;
    }

    const amountFields = form.fields.filter(f => f.type === 'amount');
    const columnTotals = {}; 

    // --- CORRECTION: Removed 'ID' from the visible headers ---
    const headers = ['Name', 'Admission No.', ...form.fields.map(f => f.label), 'Comment'];
    
    const rows = studentsInClass.map(stu => {
        const response = formResponses.find(r => r.formId === form.id && r.userId === stu.id);
        const values = response?.values || {};

        // --- CORRECTION: Removed the hidden <td> for the ID to fix column alignment ---
        const studentDataCells = `
            <td>${stu.name || 'N/A'}</td>
            <td>${stu.admissionNumber || 'N/A'}</td>`;

        const formFieldInputCells = form.fields.map(f => {
            const fieldName = f.label.replace(/\s+/g, '_').toLowerCase();
            const fieldValue = values[fieldName] ?? '';

            if (f.type === 'amount') {
                columnTotals[fieldName] = (columnTotals[fieldName] || 0) + (parseFloat(fieldValue) || 0);
            }

            const shouldBeEnabled = window.shouldShowFieldForTeacherView(f, values, form.fields);
            const disabledAttr = shouldBeEnabled ? '' : 'disabled';
            let inputHtml = '';
            
            switch (f.type) {
                case 'checkbox':
                    const isChecked = fieldValue === true || fieldValue === 'true';
                    inputHtml = `<div class="form-check d-flex justify-content-center"><input class="form-check-input" type="checkbox" data-field-name="${fieldName}" data-student-id="${stu.id}" ${isChecked ? 'checked' : ''} data-original-value="${isChecked}" ${disabledAttr}></div>`;
                    break;
                case 'dropdown':
                    const options = (f.options || []).map(o => `<option value="${o}" ${o === fieldValue ? 'selected' : ''}>${o}</option>`).join('');
                    inputHtml = `<select class="form-select form-select-sm" data-field-name="${fieldName}" data-student-id="${stu.id}" data-original-value="${fieldValue}" ${disabledAttr}><option value="">â€”</option>${options}</select>`;
                    break;
                case 'amount':
                    inputHtml = `<input type="number" class="form-control form-control-sm amount-input" value="${fieldValue}" data-field-name="${fieldName}" data-student-id="${stu.id}" data-original-value="${fieldValue}" ${disabledAttr} step="0.01">`;
                    break;
                default:
                    const inputType = f.type === 'date' ? 'date' : 'text';
                    inputHtml = `<input type="${inputType}" class="form-control form-control-sm" value="${fieldValue}" data-field-name="${fieldName}" data-student-id="${stu.id}" data-original-value="${fieldValue}" ${disabledAttr}>`;
                    break;
            }
            return `<td>${inputHtml}</td>`;
        }).join('');

        const teacherComment = response?.teacherComment || '';
        const commentInputHtml = `<input type="text" class="form-control form-control-sm" data-field-name="teacherComment" data-student-id="${stu.id}" value="${teacherComment}" data-original-value="${teacherComment}">`;

        return `<tr>${studentDataCells}${formFieldInputCells}<td>${commentInputHtml}</td></tr>`;
    }).join('');

    let tfootHtml = '';
    if (amountFields.length > 0) {
        const totalCells = form.fields.map(field => {
            const fieldName = field.label.replace(/\s+/g, '_').toLowerCase();
            if (field.type === 'amount') {
                const total = columnTotals[fieldName] || 0;
                return `<td class="text-center fw-bold" data-total-for="${fieldName}">â‚¹ ${total.toFixed(2)}</td>`;
            }
            return '<td></td>';
        }).join('');
        
        // --- CORRECTION: Changed colspan from 1 to 2 to cover both "Name" and "Admission No." ---
        tfootHtml = `<tfoot id="form-totals-foot-${form.id}"><tr class="table-light"><th colspan="2" class="text-end">Total</th>${totalCells}<th></th></tr></tfoot>`;
    }

    const tableHtml = `
        <form id="classwise-form-${form.id}">
            <div class="card shadow-sm">
                <div class="card-header fw-bold bg-light d-flex justify-content-between align-items-center flex-wrap">
                    <span>${form.title}</span>
                    <div class="btn-group mt-2 mt-md-0">
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="window.downloadFormResponsesCSV('${form.id}', '${classId}', '${division}')"><i class="fa fa-download me-1"></i> CSV</button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="window.downloadStudentSubmissionsPDF('${form.id}')"><i class="fas fa-file-pdf me-1"></i>PDF</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="window.printStudentSubmissions('${form.id}')"><i class="fas fa-print me-1"></i>Print</button>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                        <table class="table table-sm table-bordered align-middle">
                            <thead class="table-light sticky-top" style="top: 0; z-index: 1;"><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                            <tbody>${rows.length ? rows : `<tr><td colspan="${headers.length}" class="text-center">No students found.</td></tr>`}</tbody>
                            ${tfootHtml}
                        </table>
                    </div>
                    <div class="text-end mt-3"><button type="submit" class="btn btn-success" id="save-classwise-data-btn-${form.id}"><i class="fa fa-save me-1"></i> Save Changes</button></div>
                </div>
            </div>
        </form>`;

    tableContainer.innerHTML = tableHtml;

    const formElement = document.getElementById(`classwise-form-${form.id}`);
    if (formElement && amountFields.length > 0) {
        formElement.addEventListener('input', (event) => {
            if (event.target.classList.contains('amount-input')) {
                const updatedFieldName = event.target.dataset.fieldName;
                let columnTotal = 0;
                formElement.querySelectorAll(`input.amount-input[data-field-name="${updatedFieldName}"]`).forEach(input => {
                    columnTotal += parseFloat(input.value) || 0;
                });
                const totalCell = document.querySelector(`#form-totals-foot-${form.id} [data-total-for="${updatedFieldName}"]`);
                if (totalCell) {
                    totalCell.textContent = `â‚¹ ${columnTotal.toFixed(2)}`;
                }
            }
        });
    }

    document.getElementById(`save-classwise-data-btn-${form.id}`)?.addEventListener('click', async (e) => {
        e.preventDefault();
        await window.saveTeacherClasswiseForm(form, studentsInClass);
    });
}

// --- New Function for Batch Saving Teacher-Edited Student Form Data ---
/**
 * Saves all changes made by the teacher in the classwise submission table.
 * This includes updates to student form field values and teacher comments.
 * @param {object} form - The form object being edited.
 * @param {Array<object>} studentsInClass - Array of student objects in the teacher's class.
 */
/**
 * Saves all changes made by the teacher in the classwise submission table.
 * This version efficiently saves only the rows that have been edited.
 * @param {object} form - The form object being edited.
 * @param {Array<object>} studentsInClass - Array of student objects in the teacher's class.
 */
window.saveTeacherClasswiseForm = async (form, studentsInClass) => {
    const saveButton = document.getElementById(`save-classwise-data-btn-${form.id}`);
    const originalButtonHtml = saveButton ? saveButton.innerHTML : '<i class="fa fa-save me-1"></i> Save All Changes';

    if (saveButton) {
        saveButton.disabled = true;
        saveButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...`;
    }

    try {
        const batch = writeBatch(db); // Use a batch for efficient updates
        const formEl = document.getElementById(`classwise-form-${form.id}`);
        let changesFound = 0;

        for (const student of studentsInClass) {
            let hasChanged = false;
            let existingResponse = formResponses.find(r => r.formId === form.id && r.userId === student.id);
            let currentValues = existingResponse ? { ...existingResponse.values } : {};

            // 1. Check form fields for any changes
            for (const field of form.fields) {
                const fieldName = field.label.replace(/\s+/g, '_').toLowerCase();
                const inputElement = formEl.querySelector(`[data-field-name="${fieldName}"][data-student-id="${student.id}"]`);
                
                if (inputElement) {
                    const originalValue = inputElement.dataset.originalValue;
                    let newValue;
                    
                    if (inputElement.type === 'checkbox') {
                        newValue = String(inputElement.checked); // Compare as strings
                    } else if (inputElement.multiple) {
                        newValue = JSON.stringify(Array.from(inputElement.selectedOptions).map(opt => opt.value));
                    } else {
                        newValue = inputElement.value;
                    }

                    if (newValue !== originalValue) {
                        hasChanged = true;
                    }
                    // Always update the value in our data object
                    currentValues[fieldName] = (inputElement.type === 'checkbox') ? inputElement.checked : inputElement.value;
                }
            }

            // 2. Check teacher comment for any changes
            const commentInput = formEl.querySelector(`[data-field-name="teacherComment"][data-student-id="${student.id}"]`);
            let newComment = existingResponse?.teacherComment || '';
            if (commentInput) {
                if (commentInput.value !== commentInput.dataset.originalValue) {
                    hasChanged = true;
                }
                newComment = commentInput.value;
            }

            // 3. If any change was detected, add this student's data to the batch
            if (hasChanged) {
                changesFound++;
                const responseId = `${form.id}_${student.id}`;
                const responseRef = getDocRef('formResponses', responseId);
                const responseData = {
                    id: responseId,
                    formId: form.id,
                    userId: student.id,
                    values: currentValues,
                    status: existingResponse?.status || 'submitted',
                    timestamp: existingResponse?.timestamp || new Date().toISOString(),
                    teacherComment: newComment,
                    submittedBy: selectedUser.id // Track who made the change
                };
                batch.set(responseRef, responseData, { merge: true });
            }
        }

        // 4. Commit the batch if there were changes
        if (changesFound > 0) {
            await batch.commit();
            showAlert(`${changesFound} student record(s) were updated successfully!`, 'success');
        } else {
            showAlert('No changes were detected to save.', 'info');
        }

    } catch (error) {
        console.error('Error during batch save:', error);
        showAlert('An error occurred during batch save. Please try again.', 'danger');
    } finally {
        if (saveButton) {
            saveButton.disabled = false;
            saveButton.innerHTML = originalButtonHtml;
        }
        // Re-render the table to update the "original-value" attributes for the next save
        renderClassFormSubmissionTable(form, form.classId || studentsInClass[0].classId, studentsInClass[0].division);
    }
};


// --- Update CSV Export to be class-specific ---
// Assuming downloadFormResponsesCSV is meant to be flexible
window.downloadFormResponsesCSV = (formId, classId = null, division = null) => {
    const form = forms.find(f => f.id === formId);
    if (!form) {
        showAlert('Form not found for CSV export.', 'danger');
        return;
    }

    let filteredResponses = formResponses.filter(r => r.formId === formId);
    let targetStudents = students;

    if (classId && division) {
        targetStudents = students.filter(s => s.classId === classId && s.division === division);
        const studentIdsInClass = new Set(targetStudents.map(s => s.id));
        filteredResponses = filteredResponses.filter(r => studentIdsInClass.has(r.userId));
    }

    const headers = ['User ID', 'User Name', 'Admission No.', ...form.fields.map(f => f.label), 'Teacher Comment', 'Student Reply'];
    const rows = filteredResponses.map(r => {
        const user = targetStudents.find(s => s.id === r.userId) || teachers.find(t => t.id === r.userId);
        const userName = user ? user.name : 'Unknown User';
        const userAdnumber = user?.adnumber || ''; // Assuming adnumber
        const teacherComment = r.teacherComment || '';
        const studentReply = r.studentReply || '';

        const fieldValues = form.fields.map(f => {
            const key = f.label.replace(/\s+/g, '_').toLowerCase();
            const value = r.values[key];
            if (Array.isArray(value)) {
                return value.join(';');
            }
            return value !== undefined && value !== null ? String(value) : '';
        });

        const rowData = [
            r.userId,
            userName,
            userAdnumber,
            ...fieldValues,
            teacherComment,
            studentReply
        ];
        
        return rowData.map(val => `"${String(val).replace(/"/g, '""')}"`).join(',');
    });

    const csvContent = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    let fileName = `${form.title.replace(/\s+/g, '_')}`;
    if (classId && division) {
        const className = classes.find(c => c.id === classId)?.name || classId;
        fileName += `_${className}_${division}`;
    }
    fileName += `_responses_${new Date().toISOString().slice(0,10)}.csv`;

    link.download = fileName;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
};
// --- STUDENT-SPECIFIC VIEWS ---
/**
 * Renders a table of student submissions for a specific form, including Export to PDF button.
 * @param {object} form - The form object.
 * @param {Array<object>} studentsInClass - The list of students in the teacher's class.
 * @returns {string} The HTML string for the submission table.
 */
function renderStudentSubmissionTable(form, studentsInClass) {
    // Collect all field labels for headers
    const headers = ['Student ID', 'Name', ...form.fields.map(f => f.label), 'Teacher Comment', 'Student Reply'];

    const rows = studentsInClass.map(student => {
        const response = formResponses.find(r => r.formId === form.id && r.userId === student.id);
        
        const values = form.fields.map(f => {
            const normalizedLabel = f.label.replace(/\s+/g, '_').toLowerCase();
            const value = response?.values?.[normalizedLabel];
            return `<td>${value !== undefined && value !== null ? value : 'â€”'}</td>`;
        }).join('');

        return `
            <tr>
                <td>${student.id}</td>
                <td>${student.name}</td>
                ${values}
                <td>
                    <input type="text" class="form-control form-control-sm"
                            id="comment_${student.id}_${form.id}"
                            value="${response?.teacherComment || ''}"
                            onblur="window.updateTeacherComment('${form.id}', '${student.id}', this.value)">
                </td>
                <td>
                    ${response?.studentReply ? `<i class='fa fa-reply me-1 text-info'></i> ${response.studentReply}` : 'â€”'}
                </td>
            </tr>
        `;
    }).join('');

    return `
        <div class="card mb-4">
            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                <span>${form.title}</span>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-success" onclick="window.finalizeForm('${form.id}')">Finalize All</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="window.downloadFormResponsesCSV('${form.id}')">
                        <i class="fas fa-file-csv me-1"></i>CSV
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="window.downloadStudentSubmissionsPDF('${form.id}')">
                        <i class="fas fa-file-pdf me-1"></i>PDF
                    </button>
                    

                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                        <tbody>${rows.length ? rows : `<tr><td colspan="${headers.length}" class="text-center">No student responses for this form.</td></tr>`}</tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}
/**
 * Generates and downloads a professional PDF of student submissions for a specific form,
 * using jsPDF-autoTable for a perfectly centered header.
 * @param {string} formId - The ID of the form to export.
 */
window.downloadStudentSubmissionsPDF = (formId) => {
    const form = forms.find(f => f.id === formId);
    if (!form) return showAlert('Form not found for PDF export.', 'danger');

    const { classId, division } = selectedUser.classCharge;
    const studentsInClass = students.filter(s => s.classId === classId && s.division === division && s.status !== 'TC Issued' && s.status !== 'Graduated');
    const formResponsesForClass = formResponses.filter(r => r.formId === formId && studentsInClass.some(s => s.id === r.userId));

    if (formResponsesForClass.length === 0) {
        return showAlert('No submitted data to export for this class.', 'info');
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'landscape',
        unit: 'pt',
        format: 'a4'
    });
    
    // --- 1. Prepare Header Content ---
    const headerTitle = schoolDetails.name || 'School Report';
    const headerSubtitle = schoolDetails.address || '';
    const formTitle = form.title;
    const classTitle = `Submissions from Class: ${classes.find(c=>c.id === classId).name} - ${division}`;

    // --- 2. Generate the Header using autoTable ---
    doc.autoTable({
        startY: 60, // Start below the logo
        body: [
            [{ content: headerTitle, styles: { halign: 'center', fontSize: 18, fontStyle: 'bold' } }],
            [{ content: headerSubtitle, styles: { halign: 'center', fontSize: 10 } }],
            [{ content: formTitle, styles: { halign: 'center', fontSize: 14, fontStyle: 'bold' } }],
            [{ content: classTitle, styles: { halign: 'center', fontSize: 10 } }]
        ],
        theme: 'plain', // This makes the table borderless
        didDrawPage: function (data) {
            // Add the logo in the didDrawPage hook to ensure it's placed correctly
            if (schoolDetails.logoUrl) {
                try {
                    const logoWidth = 60;
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const logoX = (pageWidth - logoWidth) / 2; // Center the logo
                    doc.addImage(schoolDetails.logoUrl, 'PNG', logoX, 20, logoWidth, 60);
                } catch (e) { console.warn("Could not add school logo to PDF.", e); }
            }
        }
    });

    // --- 3. Prepare Main Table Content (same as before) ---
    const amountFields = form.fields.filter(f => f.type === 'amount');
    const columnTotals = {};
    const head = [['Sl. No.', 'Admn No.', 'Student Name', ...form.fields.map(f => f.label), 'Teacher Comment']];
    const body = formResponsesForClass.map((r, index) => {
        const student = students.find(s => s.id === r.userId);
        const values = form.fields.map(f => {
            const key = f.label.replace(/\s+/g, '_').toLowerCase();
            const value = r.values[key];
            if (f.type === 'amount') {
                columnTotals[key] = (columnTotals[key] || 0) + (parseFloat(value) || 0);
            }
            if (typeof value === 'boolean') return value ? 'Yes' : 'No';
            return value !== undefined && value !== null ? String(value) : '';
        });
        return [index + 1, student?.admissionNumber || 'N/A', student?.name || r.userId, ...values, r.teacherComment || ''];
    });

    let foot = [];
    if (amountFields.length > 0) {
        const footerRow = ['', '', 'Total', ...form.fields.map(f => {
            if (f.type === 'amount') {
                const key = f.label.replace(/\s+/g, '_').toLowerCase();
                return `Rs. ${(columnTotals[key] || 0).toFixed(2)}`;
            }
            return '';
        }), ''];
        foot.push(footerRow);
    }

    // --- 4. Generate the Main Data Table ---
    doc.autoTable({
        head: head,
        body: body,
        foot: foot,
        startY: doc.lastAutoTable.finalY + 10, // Start right after the header table
        theme: 'grid',
        headStyles: { fillColor: [22, 160, 133], textColor: 255 },
        footStyles: { fillColor: [241, 196, 15], fontStyle: 'bold', textColor: 44 },
        styles: { fontSize: 8, cellPadding: 2 },
        columnStyles: { 2: { fontStyle: 'bold' } }
    });

    doc.save(`${form.title.replace(/\s+/g, '_')}_Submissions.pdf`);
}

/**
 * Generates a print-friendly HTML report of student submissions and opens the print dialog.
 * @param {string} formId - The ID of the form to print.
 */
/**
 * Generates a print-friendly HTML report of student submissions with a side-by-side header layout.
 * @param {string} formId - The ID of the form to print.
 */
window.printStudentSubmissions = (formId) => {
    const form = forms.find(f => f.id === formId);
    if (!form) return showAlert('Form not found for printing.', 'danger');

    const { classId, division } = selectedUser.classCharge;
    const studentsInClass = students.filter(s => s.classId === classId && s.division === division && s.status !== 'TC Issued' && s.status !== 'Graduated');
    const formResponsesForClass = formResponses.filter(r => r.formId === formId && studentsInClass.some(s => s.id === r.userId));

    if (formResponsesForClass.length === 0) {
        return showAlert('No submitted data to print for this class.', 'info');
    }

    const amountFields = form.fields.filter(f => f.type === 'amount');
    const columnTotals = {};

    // --- 1. Prepare Table Content ---
    const headers = ['Sl. No.', 'Admn No.', 'Student Name', ...form.fields.map(f => f.label), 'Teacher Comment'];
    const bodyRows = formResponsesForClass.map((r, index) => {
        const student = students.find(s => s.id === r.userId);
        const values = form.fields.map(f => {
            const key = f.label.replace(/\s+/g, '_').toLowerCase();
            const value = r.values[key];
            if (f.type === 'amount') {
                columnTotals[key] = (columnTotals[key] || 0) + (parseFloat(value) || 0);
            }
            if (typeof value === 'boolean') return value ? 'Yes' : 'No';
            return value !== undefined && value !== null ? String(value) : '';
        }).join('</td><td class="text-center">');
        
        return `<tr>
                    <td class="text-center">${index + 1}</td>
                    <td class="text-center">${student?.admissionNumber || 'N/A'}</td>
                    <td>${student?.name || r.userId}</td>
                    <td class="text-center">${values}</td>
                    <td>${r.teacherComment || ''}</td>
                </tr>`;
    }).join('');

    let footerRow = '';
    if (amountFields.length > 0) {
        const totalCells = form.fields.map(f => {
            if (f.type === 'amount') {
                const key = f.label.replace(/\s+/g, '_').toLowerCase();
                return `<strong>Rs. ${(columnTotals[key] || 0).toFixed(2)}</strong>`;
            }
            return '';
        }).join('</td><td>');
        footerRow = `<tfoot><tr class="table-light"><td colspan="3" class="text-end"><strong>Total</strong></td><td>${totalCells}</td><td></td></tr></tfoot>`;
    }

    // --- 2. Assemble the Full HTML for Printing ---
    const className = classes.find(c => c.id === classId)?.name || '';
    const reportTitle = `${form.title}`;
    const subTitle = `Class: ${className} - ${division}`;

    // --- MODIFIED: New header layout with logo on the left ---
    const contentHtml = `
        <div class="printable-report">
            <div class="report-header mb-4">
                <div class="row align-items-center">
                    <div class="col-2 text-start">
                        ${schoolDetails.logoUrl ? `<img src="${schoolDetails.logoUrl}" style="max-height: 80px;">` : ''}
                    </div>
                    <div class="col-10 text-center">
                        <h3>${schoolDetails.name || 'School Report'}</h3>
                        <p class="mb-0">${schoolDetails.address || ''}</p>
                    </div>
                </div>
                <hr>
                <div class="text-center">
                    <h4>${reportTitle}</h4>
                    <p>${subTitle}</p>
                </div>
            </div>
            <table class="table table-bordered table-sm">
                <thead><tr><th>${headers.join('</th><th>')}</th></tr></thead>
                <tbody>${bodyRows}</tbody>
                ${footerRow}
            </table>
        </div>
    `;

    // --- 3. Use the Generic Print Utility ---
    printReport({
        contentHtml: contentHtml,
        title: form.title.replace(/\s+/g, '_'),
        extraCss: `table { font-size: 10pt; }` // Optional: smaller font for printing
    });
};
/**
 * Updates the teacher's comment on a student's form response.
 * @param {string} formId
 * @param {string} studentId
 * @param {string} comment
 */
window.updateTeacherComment = async (formId, studentId, comment) => {
    const response = formResponses.find(r => r.formId === formId && r.userId === studentId);
    if (response) {
        try {
            await setDoc(getDocRef('formResponses', response.id), { ...response, teacherComment: comment });
            showAlert('Comment saved.', 'success');
        } catch (error) {
            console.error('Failed to update teacher comment:', error);
            showAlert('Failed to save comment. Please try again.', 'danger');
        }
    } else {
        console.warn(`Response not found for formId: ${formId}, studentId: ${studentId}`);
        // Optionally, showAlert('Response not found to add comment.', 'warning');
    }
};
/**
 * Finalizes all submitted responses for a form, preventing further edits.
 * @param {string} formId
 */
window.finalizeForm = async (formId) => {
    if (!confirm('Are you sure you want to finalize all submissions for this form? This action cannot be undone.')) return;

    const responsesToFinalize = formResponses.filter(r => r.formId === formId && r.status === 'submitted');
    
    if (responsesToFinalize.length === 0) {
        showAlert('No submitted responses to finalize for this form.', 'info');
        return;
    }

    const updatePromises = responsesToFinalize.map(r => 
        setDoc(getDocRef('formResponses', r.id), { ...r, status: 'finalized' })
    );

    try {
        await Promise.all(updatePromises);
        showAlert('Form finalized successfully. Students can no longer edit their responses.', 'success');
        // UI should update via real-time listeners.
    } catch (error) {
        console.error('Failed to finalize form responses:', error);
        showAlert('An error occurred during finalization. Please try again.', 'danger');
    }
};
// --- STUDENT/USER FORM FILLING & VIEWING ---

/**
 * Renders forms for the current user (student or teacher) to fill out or view.
 * @param {HTMLElement} [container=mainContent] - The container to render the content into.
 *//**
 * Renders forms for the current user (student or teacher) to fill out or view.
 * @param {HTMLElement} [container=mainContent] - The container to render the content into.
 */
window.renderMyForms = (container = document.getElementById('main-content')) => {
    if (!container) {
        console.error('Container element not found for renderMyForms!');
        return;
    }

    if (!selectedUser || !currentUserRole) {
        container.innerHTML = '<p class="text-danger">Error: User information not available.</p>';
        return;
    }

    const userForms = forms.filter(f => {
        if (f.target !== currentUserRole) return false;
        if (currentUserRole === 'student') {
            const classMatch = !f.classId || f.classId === selectedUser.classId;
            const divisionMatch = !f.division || f.division === selectedUser.division;
            return classMatch && divisionMatch;
        }
        // For teachers, if target is 'teacher', it applies to all teachers by default
        return true;
    });

    const categorizeForms = (formsList) => {
        const submitted = [], notSubmitted = [];
        formsList.forEach(form => {
            const hasResponse = formResponses.some(r => r.formId === form.id && r.userId === selectedUser.id);
            (hasResponse ? submitted : notSubmitted).push(form);
        });
        return { submitted, notSubmitted };
    };

    // Filter by isActive status first
    const activeForms = userForms.filter(f => f.isActive);
    const closedForms = userForms.filter(f => !f.isActive);

    const { submitted: activeSubmitted, notSubmitted: activeNotSubmitted } = categorizeForms(activeForms);
    const { submitted: closedSubmitted, notSubmitted: closedNotSubmitted } = categorizeForms(closedForms);

    const renderCategory = (title, icon, formsList) => {
        if (!formsList.length) return ''; // Only render if there are forms in the category
        return `
            <h4 class="mt-4"><i class="fa ${icon} me-1"></i> ${title}</h4>
            ${formsList.map(renderFormCardForUser).join('')}
        `;
    };

    container.innerHTML = `
        <h1 class="h2 mb-4">My Forms</h1>
        ${renderCategory('Active - To Do', 'fa-pencil-alt', activeNotSubmitted)}
        ${renderCategory('Active - Submitted', 'fa-check-circle', activeSubmitted)}
        ${renderCategory('Closed - Submitted', 'fa-folder', closedSubmitted)}
        ${renderCategory('Closed - Incomplete', 'fa-folder-open', closedNotSubmitted)}
        ${!userForms.length ? '<p class="text-muted">No forms found.</p>' : ''}
    `;

    // After rendering, initialize conditional logic for any forms rendered as submittable
    activeNotSubmitted.forEach(form => initializeConditionalForm(form));
    // If you allow editing submitted forms, you might also need to initialize them here.
};/**
 * Renders a single form card for the current user.
 * It can be a submittable form or a view of a submitted response.
 * @param {object} form - The form object.
 * @returns {string} The HTML for the form card.
 */
function renderFormCardForUser(form) {
    const response = formResponses.find(r => r.formId === form.id && r.userId === selectedUser.id);
    const isSubmitted = !!response;
    const isFinalized = response?.status === 'finalized';

    let statusBadge;
    if (!form.isActive) {
        statusBadge = '<span class="badge bg-light text-dark"><i class="fa fa-ban me-1"></i> Closed</span>';
    } else if (isFinalized) {
        statusBadge = '<span class="badge bg-secondary"><i class="fa fa-lock me-1"></i> Finalized</span>';
    } else if (isSubmitted) {
        statusBadge = '<span class="badge bg-info"><i class="fa fa-check me-1"></i> Submitted</span>';
    } else {
        statusBadge = '<span class="badge bg-success"><i class="fa fa-pencil-alt me-1"></i> Active</span>';
    }

    const cardBody = isSubmitted
        ? renderSubmittedFormView(form, response)
        : renderSubmittableForm(form);

    return `
        <div class="card mb-3">
            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                ${form.title}
                ${statusBadge}
            </div>
            <div class="card-body">${cardBody}</div>
        </div>
    `;
}/**
 * Renders the view for a form that has already been submitted.
 * @param {object} form - The form object.
 * @param {object} response - The user's response object.
 * @returns {string} HTML content for the card body.
 */
/**
 * Renders the fields for a form that the user can fill and submit.
 * @param {object} form - The form object.
 * @returns {string} HTML content for the card body.
 */
/**
 * Renders the fields for a form, now including a structured total section with column subtotals.
 */
function renderSubmittableForm(form) {
    if (!form.isActive) {
        return '<p class="text-muted">This form is closed and no longer accepting responses.</p>';
    }

    const fieldsHtml = form.fields.map(field => renderFormInputField(field)).join('');
    
    // --- NEW: Find all unique column headers defined in the form fields ---
    const totalHeaders = [...new Set(form.fields
        .filter(f => f.type === 'amount' && f.totalHeader)
        .map(f => f.totalHeader))];

    // --- NEW: Generate the HTML for the totals section ---
    let totalsHtml = '';
    if (totalHeaders.length > 0) {
        totalsHtml += `<h5 class="mt-4">Summary</h5>`;
        totalHeaders.forEach(header => {
            const headerId = header.replace(/\s+/g, '-').toLowerCase();
            totalsHtml += `
                <div class="d-flex justify-content-between align-items-center pt-2">
                    <span class="text-muted">${header}:</span>
                    <span class="fw-bold">â‚¹ <span id="subtotal-${form.id}-${headerId}">0.00</span></span>
                </div>`;
        });
        // Add the Grand Total line
        totalsHtml += `<div class="d-flex justify-content-between align-items-center pt-3 mt-2 border-top">
                           <h5 class="mb-0">Grand Total:</h5>
                           <h4 class="mb-0 fw-bold text-primary">â‚¹ <span id="cumulative-total-${form.id}">0.00</span></h4>
                       </div>`;
    }

    return `
        <form id="form-submit-${form.id}" novalidate>
            ${fieldsHtml}
            <div id="total-container-${form.id}">${totalsHtml}</div>
            <div class="mt-4">
                <button type="submit" class="btn btn-primary"><i class="fa fa-paper-plane me-1"></i> Submit</button>
            </div>
        </form>
    `;
}

function renderSubmittedFormView(form, response) {
    const isFinalized = response.status === 'finalized';

    const fieldList = form.fields.map(field => {
        const normalizedLabel = field.label.replace(/\s+/g, '_').toLowerCase();
        const value = response.values[normalizedLabel];
        return `<li class="list-group-item"><strong>${field.label}:</strong> ${value !== undefined && value !== null ? value : '<em>Not provided</em>'}</li>`;
    }).join('');

    return `
        <ul class="list-group list-group-flush mb-3">${fieldList}</ul>
        ${response.teacherComment ? `<p class="mb-2"><i class="fa fa-comment-dots text-muted me-1"></i><strong>Teacher's Comment:</strong> ${response.teacherComment}</p>` : ''}
        ${!isFinalized && form.isActive ? `<button class="btn btn-warning" onclick="window.editMyForm('${form.id}')"><i class="fa fa-edit me-1"></i> Edit Response</button>` : ''}
        ${response.studentReply ? `<p class="mt-2"><i class="fa fa-reply text-muted me-1"></i><strong>Your Reply:</strong> ${response.studentReply}</p>` : ''}
        ${isFinalized && currentUserRole === 'student' ? `<p class="text-info mt-2"><i class="fa fa-info-circle me-1"></i> This form has been finalized and can no longer be edited.</p>` : ''}
    `;


}

/**
 * Attaches the conditional logic and event listeners to a submittable form
 * that has already been rendered to the page.
 * @param {object} form - The configuration object for the form to initialize.
 */
function initializeConditionalForm(form) {
    const formId = `form-submit-${form.id}`;
    const formEl = document.getElementById(formId);

    // If the form element doesn't exist on the page, do nothing.
    if (!formEl) {
        console.warn(`Form element with ID ${formId} not found. Conditional logic not initialized.`);
        return;
    }

    /**
     * Checks all conditional fields and toggles their visibility.
     */
    const updateVisibility = () => {
        // Get all current values from the form's inputs.
        const currentValues = {};
        form.fields.forEach(f => {
            const inputName = f.label.replace(/\s+/g, '_').toLowerCase();
            const inputEl = formEl.elements[inputName];
            if (inputEl) {
                // For checkbox, value is its checked state. For others, it's the trimmed value.
                currentValues[f.label] = inputEl.type === 'checkbox' ? inputEl.checked.toString() : inputEl.value.trim();
            }
        });

        // Loop through each field to check if its conditions are met.
        form.fields.forEach(fieldToCheck => {
            const containerId = `container_${fieldToCheck.label.replace(/\s+/g, '_').toLowerCase()}`;
            const fieldContainer = document.getElementById(containerId);
            if (!fieldContainer) {
                console.warn(`Container for field "${fieldToCheck.label}" not found. Cannot apply conditional logic.`);
                return;
            }

            let shouldShow = true;
            if (fieldToCheck.conditions && fieldToCheck.conditions.length > 0) {
                // All conditions must be true for the field to show
                shouldShow = fieldToCheck.conditions.every(cond => {
                    // Check if the actual value matches the condition's required value.
                    // Important: The value from currentValues[cond.field] should match cond.value exactly.
                    return currentValues[cond.field] === cond.value;
                });
            }

            // Toggle the display property.
            fieldContainer.style.display = shouldShow ? 'block' : 'none';

            // If a field becomes hidden, clear its value to avoid submitting hidden data
            // unless specifically required by design. This example clears it.
            if (!shouldShow) {
                const inputName = fieldToCheck.label.replace(/\s+/g, '_').toLowerCase();
                const inputEl = formEl.elements[inputName];
                if (inputEl) {
                    if (inputEl.type === 'checkbox') {
                        inputEl.checked = false;
                    } else {
                        inputEl.value = '';
                    }
                }
            }
        });
    };

    // Add a single 'change' event listener to the form to handle all interactions.
    // 'input' event might be better for text fields if real-time update is desired.
    formEl.addEventListener('change', updateVisibility);

    // Call it once immediately to set the correct initial visibility of all fields.
    updateVisibility();
    
    // --- MODIFIED: Advanced Cumulative Total Calculation Logic ---
    const amountFields = formEl.querySelectorAll('.amount-field');
    const grandTotalDisplay = document.getElementById(`cumulative-total-${form.id}`);

    if (amountFields.length > 0) {
        const updateTotal = () => {
            let grandTotal = 0;
            const subTotals = {}; // To store totals for each column header

            // Loop through each amount field to calculate sums
            amountFields.forEach(input => {
                // Only calculate if the field is currently visible
                if (input.closest('div[id^="container_"]').style.display !== 'none') {
                    const amount = parseFloat(input.value) || 0;
                    grandTotal += amount;

                    const header = input.dataset.totalHeader;
                    if (header) { // If it belongs to a column
                        subTotals[header] = (subTotals[header] || 0) + amount;
                    }
                }
            });

            // Update the grand total display
            if (grandTotalDisplay) {
                grandTotalDisplay.textContent = grandTotal.toFixed(2);
            }

            // Update all the sub-total displays
            for (const header in subTotals) {
                const headerId = header.replace(/\s+/g, '-').toLowerCase();
                const subTotalEl = document.getElementById(`subtotal-${form.id}-${headerId}`);
                if (subTotalEl) {
                    subTotalEl.textContent = subTotals[header].toFixed(2);
                }
            }
        };

        formEl.addEventListener('input', (event) => {
            if (event.target.classList.contains('amount-field')) {
                updateTotal();
            }
        });

        // Update totals when conditional visibility changes
        formEl.addEventListener('change', updateTotal);

        // Initial calculation on load
        updateTotal();
    }


    formEl.addEventListener('submit', (event) => {
        // We pass both the event and the form's configuration object
        handleFormSubmission(event, form);
    });
}
   /**
 * Handles the submission of a dynamic form.
 * It gathers and validates data only from visible fields before saving.
 * @param {Event} event - The form's submit event object.
 * @param {object} formConfig - The configuration object for the submitted form.
 */
window.editMyForm = (formId) => {
    const form = forms.find(f => f.id === formId);
    const response = formResponses.find(r => r.formId === formId && r.userId === selectedUser.id);
    if (!form || !response) return;

    mainContent.innerHTML = `<h1 class="h2 mb-4">Edit Form - ${form.title}</h1>
        <form id="edit-form-fields">
            ${form.fields.map(f => {
                const name = f.label.replace(/\s+/g, '_').toLowerCase();
                const val = response.values[name];
                if (f.type === 'text') {
                    return `<div class="mb-2"><label>${f.label}</label><input class="form-control" id="${name}" value="${val || ''}"></div>`;
                } else if (f.type === 'dropdown') {
                    return `<div class="mb-2"><label>${f.label}</label><select class="form-select" id="${name}"><option value="">Select</option><option${val === 'Option 1' ? ' selected' : ''}>Option 1</option><option${val === 'Option 2' ? ' selected' : ''}>Option 2</option></select></div>`;
                } else if (f.type === 'checkbox') {
                    return `<div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="${name}" ${val ? 'checked' : ''}>
                                <label class="form-check-label" for="${name}">${f.label}</label>
                            </div>`;
                }
                return '';
            }).join('')}
            <button type="submit" class="btn btn-success">Update</button>
        </form>`;

    document.getElementById('edit-form-fields').addEventListener('submit', async e => {
        e.preventDefault();
        const values = {};
        for (const f of form.fields) {
            const name = f.label.replace(/\s+/g, '_').toLowerCase();
            const el = document.getElementById(name);
            values[name] = f.type === 'checkbox' ? el?.checked || false : el?.value?.trim() || '';
        }
        await setDoc(getDocRef('formResponses', response.id), { ...response, values });
        showAlert('Form updated successfully', 'success');
        renderMyForms();
    });
};
async function handleFormSubmission(event, formConfig) {
    // 1. Prevent the default browser action (reloading the page)
    event.preventDefault();
    
    const formEl = event.target;
    const submitButton = formEl.querySelector('button[type="submit"]');
    const originalButtonHtml = submitButton.innerHTML;

    // Disable button to prevent multiple submissions
    if (submitButton) {
        submitButton.disabled = true;
        submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...`;
    }

    try {
        const values = {};
        let isValid = true;

        // 2. Loop through the fields DEFINED IN THE CONFIG to check for visibility and value
        for (const field of formConfig.fields) {
            const containerId = `container_${field.label.replace(/\s+/g, '_').toLowerCase()}`;
            const container = document.getElementById(containerId);
            
            // If the field's container is not visible, skip it
            if (!container || container.style.display === 'none') {
                continue; // Skip processing hidden fields
            }

            // The field is visible, so get its value
            const inputName = field.label.replace(/\s+/g, '_').toLowerCase();
            const inputEl = formEl.elements[inputName];
            
            if (!inputEl) {
                console.warn(`Input element for field "${field.label}" not found.`);
                continue; // Skip if input element is missing
            }

            let value;
            if (inputEl.type === 'checkbox') {
                value = inputEl.checked;
            } else if (inputEl.type === 'radio') {
                // For radio buttons, you might need to iterate over all radios with the same name
                // This example assumes a single input element for simplicity for now.
                value = inputEl.value.trim();
            } else if (inputEl.tagName === 'SELECT' && inputEl.multiple) {
                value = Array.from(inputEl.selectedOptions).map(option => option.value);
            } else {
                value = inputEl.value.trim();
            }

            // 3. Validate the visible field if it's required
            if (field.required && (value === '' || value === false || (Array.isArray(value) && value.length === 0))) {
                showAlert(`Please fill out the required field: ${field.label}`, 'warning');
                isValid = false;
                break; // Stop validation on first error
            }
            
            values[inputName] = value;
        }

        if (!isValid) {
            // Re-enable button and stop the submission if validation failed
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonHtml;
            }
            return; 
        }

        // 4. Construct the response object and save it
        // Assumes 'selectedUser' is globally available and valid
        if (!selectedUser || !selectedUser.id) {
            showAlert('User information is missing. Cannot submit form.', 'danger');
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonHtml;
            }
            return;
        }

        const responseData = {
            id: `${formConfig.id}_${selectedUser.id}`, 
            formId: formConfig.id,
            userId: selectedUser.id,
            values: values,
            status: 'submitted', // Or 'draft' if you have a save draft feature
            timestamp: new Date().toISOString(),
        };

        // Assumes 'setDoc' and 'getDocRef' are Firebase functions available globally
        await setDoc(getDocRef('formResponses', responseData.id), responseData);
        
        showAlert('Form submitted successfully!', 'success');
        
        // Refresh the UI to show the form has moved to the "Submitted" category
        window.renderMyForms();

    } catch (error) {
        console.error("Form submission failed:", error);
        showAlert('An error occurred during submission. Please try again.', 'danger');
    } finally {
        // Always re-enable button and restore its original content
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonHtml;
        }
    }
}

/**
 * Renders a single input field for a form.
 * @param {object} field - The field configuration object.
 * @returns {string} The HTML string for the input field.
 */

/**
 * Renders a single input field for a form.
 * Now handles the new 'amount' type.
 */
function renderFormInputField(field) {
    const name = field.label.replace(/\s+/g, '_').toLowerCase();
    const required = field.required ? 'required' : '';
    const helper = field.helper ? `<small class="form-text text-muted">${field.helper}</small>` : '';
    const hasConditions = field.conditions && field.conditions.length > 0;
    const initialStyle = hasConditions ? 'display:none;' : '';
    
    let fieldHtml = '';
    switch (field.type) {
        // --- NEW CASE for amount fields ---
        case 'amount':
            fieldHtml = `
                <div class="mb-3">
                    <label for="${name}" class="form-label">${field.label}</label>
                    <input type="number" class="form-control amount-field" name="${name}" id="${name}" placeholder="${field.placeholder || '0.00'}" min="0" step="0.01" ${required}>
                    ${helper}
                </div>`;
            break;
        case 'checkbox':
            fieldHtml = `<div class="form-check mb-3"><input class="form-check-input" name="${name}" type="checkbox" id="${name}" ${required}><label class="form-check-label" for="${name}">${field.label}</label>${helper}</div>`;
            break;
        case 'dropdown':
            const options = (field.options || []).map(o => `<option value="${o}">${o}</option>`).join('');
            fieldHtml = `<div class="mb-3"><label for="${name}" class="form-label">${field.label}</label><select class="form-select" name="${name}" id="${name}" ${required}><option value="">-- Select --</option>${options}</select>${helper}</div>`;
            break;
        default:
            fieldHtml = `<div class="mb-3"><label for="${name}" class="form-label">${field.label}</label><input type="text" class="form-control" name="${name}" id="${name}" placeholder="${field.placeholder || ''}" ${required}>${helper}</div>`;
            break;
    }

    return `<div id="container_${name}" style="${initialStyle}">${fieldHtml}</div>`;
}



// --- UTILITY & HELPER FUNCTIONS ---

/**
 * Downloads form responses as a CSV file.
 * @param {string} formId - The ID of the form.
 */
window.downloadFormResponsesCSV = (formId) => {
    const form = forms.find(f => f.id === formId);
    if (!form) return;

    const responses = formResponses.filter(r => r.formId === formId);
    const headers = ['User ID', 'User Name', ...form.fields.map(f => f.label)];
    const rows = responses.map(r => {
        const user = students.find(s => s.id === r.userId) || teachers.find(t => t.id === r.userId);
        const rowData = [
            r.userId,
            user ? user.name : 'Unknown User',
            ...form.fields.map(f => r.values[f.label.replace(/\s+/g, '_').toLowerCase()] || '')
        ];
        return rowData.map(val => `"${String(val).replace(/"/g, '""')}"`).join(',');
    });

    const csvContent = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${form.title.replace(/\s+/g, '_')}_responses.csv`;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

/**
 * Renders a generic bulk import tool for uploading CSV data to Firestore collections.
 * Supports 'students' and 'teachers' collections.
 */
// --- BULK IMPORT MODULE (CORRECTED) ---

// Global variable to hold the parsed and potentially edited records
let currentBulkImportRecords = [];

/**
 * Renders a generic bulk import tool for uploading CSV data to Firestore collections.
 */
window.renderBulkImportTool = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) {
        console.error('Main content element not found!');
        return;
    }

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Bulk Data Import (CSV)</h1>
        <div class="card shadow mb-4">
            <div class="card-body">
                <p class="text-muted">Upload a CSV file to bulk add/update data.</p>
                <div class="alert alert-info" role="alert">
                    <strong>Important CSV Format:</strong>
                    <ul>
                        <li>**Students/Teachers:** Your CSV MUST have a column named **'id'** (case-insensitive). Existing documents with the same 'id' will be overwritten.</li>
                        <li>**Subject Allocations:** Do NOT include an 'id' column. It will be generated automatically. Required columns are: **classId, division, subjectId, teacherId, weeklyHour**.</li>
                        <li>For teachers, use dot notation for nested fields: **classCharge.classId** and **classCharge.division**.</li>
                    </ul>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label for="collection-select" class="form-label">Select Collection</label>
                        <select id="collection-select" class="form-select" required>
                            <option value="">-- Choose Collection --</option>
                            <option value="students">Students</option>
                            <option value="teachers">Teachers</option>
                            <option value="classroomSubjects">Subject Allocations</option>
                            <option value="books">library Records</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="csv-file-input" class="form-label">Upload CSV File</label>
                        <input type="file" id="csv-file-input" class="form-control" accept=".csv" required>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <button id="process-csv-btn" class="btn btn-primary btn-lg">
                        <i class="fas fa-file-import me-2"></i>Process CSV
                    </button>
                </div>

                <div id="upload-status-messages" class="mt-4"></div>
                
                <div id="editable-data-preview" class="mt-5 d-none">
                    <h4 class="mb-3">Review & Edit Data:</h4>
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table id="bulk-import-table" class="table table-bordered table-striped table-sm text-nowrap">
                            <thead class="table-light"></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-end mt-4">
                        <button id="cancel-review-btn" class="btn btn-secondary me-2">Cancel Review</button>
                        <button id="final-upload-btn" class="btn btn-success btn-lg">
                            <i class="fas fa-upload me-2"></i>Final Upload
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    const collectionSelect = document.getElementById('collection-select');
    const csvFileInput = document.getElementById('csv-file-input');
    const processCsvBtn = document.getElementById('process-csv-btn');
    const statusMessagesDiv = document.getElementById('upload-status-messages');
    const editableDataPreviewDiv = document.getElementById('editable-data-preview');
    const bulkImportTableHead = document.querySelector('#bulk-import-table thead');
    const bulkImportTableBody = document.querySelector('#bulk-import-table tbody');
    const finalUploadBtn = document.getElementById('final-upload-btn');
    const cancelReviewBtn = document.getElementById('cancel-review-btn');

    processCsvBtn.addEventListener('click', async () => {
        const collectionName = collectionSelect.value;
        const file = csvFileInput.files[0];

        if (!collectionName || !file) {
            showAlert('Please select a collection and a CSV file.', 'danger');
            return;
        }

        statusMessagesDiv.innerHTML = '';
        editableDataPreviewDiv.classList.add('d-none');
        processCsvBtn.disabled = true;
        processCsvBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Processing...`;

        const reader = new FileReader();
        reader.onload = async (e) => {
            const csvText = e.target.result;
            const parseResult = parseCSVForPreview(csvText, collectionName); 
            currentBulkImportRecords = parseResult.records;
            
            if (parseResult.errors.length > 0) {
                statusMessagesDiv.innerHTML = `<div class="alert alert-warning"><strong>Parsing Warnings:</strong><ul>${parseResult.errors.map(err => `<li>${err}</li>`).join('')}</ul></div>`;
            }

            if (currentBulkImportRecords.length > 0) {
                renderEditableTable(currentBulkImportRecords, bulkImportTableHead, bulkImportTableBody, collectionName);
                editableDataPreviewDiv.classList.remove('d-none');
                showAlert(`CSV processed! ${currentBulkImportRecords.length} records ready for review.`, 'success');
            } else {
                 showAlert('No valid records found to import.', 'danger');
            }
            processCsvBtn.disabled = false;
            processCsvBtn.innerHTML = `<i class="fas fa-file-import me-2"></i>Process CSV`;
        };
        reader.readAsText(file);
    });

    finalUploadBtn.addEventListener('click', async () => {
        const collectionName = collectionSelect.value;
        const recordsToUpload = readDataFromEditableTable(bulkImportTableHead, bulkImportTableBody, collectionName);

        if (recordsToUpload.length > 0) {
            await performFinalUpload(collectionName, recordsToUpload, statusMessagesDiv);
        } else {
            showAlert('No valid records to upload.', 'danger');
        }
    });

    cancelReviewBtn.addEventListener('click', () => {
        currentBulkImportRecords = [];
        editableDataPreviewDiv.classList.add('d-none');
        statusMessagesDiv.innerHTML = '';
        csvFileInput.value = '';
        collectionSelect.value = '';
        showAlert('Review cancelled.', 'info');
    });
};

/**
 * Parses CSV text into records, performs initial validation, and returns records with errors.
 */
function parseCSVForPreview(csvText, collectionName) {
    const lines = csvText.trim().split('\n');
    const records = [];
    const errors = [];
    if (lines.length <= 1) {
        errors.push('CSV file is empty or only contains headers.');
        return { records, errors };
    }

    const headers = lines[0].split(',').map(h => h.trim());
    
    if (collectionName !== 'classroomSubjects' && headers.indexOf('id') === -1) {
        errors.push(`CSV for '${collectionName}' must contain an "id" column.`);
        return { records, errors };
    }

    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        if (values.length !== headers.length) {
            errors.push(`Row ${i + 1}: Column count mismatch. Skipping.`);
            continue;
        }
        const record = { __rowIndex: i + 1 };
        headers.forEach((header, index) => {
            record[header] = values[index].trim();
        });
        records.push(record);
    }
    return { records, errors };
}

/**
 * Renders the parsed records into an editable HTML table for review.
 */
function renderEditableTable(records, theadElement, tbodyElement, collectionName) {
    const headers = Object.keys(records[0]).filter(key => !key.startsWith('__'));
    theadElement.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
    tbodyElement.innerHTML = records.map((record, rowIndex) => `
        <tr data-row-index="${rowIndex}">
            ${headers.map(header => `<td><input type="text" class="form-control form-control-sm editable-input" data-header="${header}" value="${record[header]}"></td>`).join('')}
        </tr>
    `).join('');
}

/**
 * Reads data directly from the editable table, performs final validation, and prepares for upload.
 */
function readDataFromEditableTable(theadElement, tbodyElement, collectionName) {
    const headers = Array.from(theadElement.querySelectorAll('th')).map(th => th.textContent.trim());
    const recordsToUpload = [];

    Array.from(tbodyElement.querySelectorAll('tr')).forEach(row => {
        const record = {};
        
        Array.from(row.querySelectorAll('.editable-input')).forEach((input, inputIndex) => {
            const header = headers[inputIndex];
            const value = input.value.trim();
            
            if (header.includes('.')) {
                const parts = header.split('.');
                const mainKey = parts[0] === 'classcharge' ? 'classCharge' : parts[0];
                const subKey = parts[1] === 'classid' ? 'classId' : parts[1];
                if (!record[mainKey]) record[mainKey] = {};
                record[mainKey][subKey] = value;
            } else {
                record[header] = value;
            }
        });
        recordsToUpload.push(record);
    });
    return recordsToUpload;
}

/**
 * Performs the final batch upload of records to Firestore.
 */
async function performFinalUpload(collectionName, recordsToUpload, statusDiv) {
    const finalUploadBtn = document.getElementById('final-upload-btn');
    finalUploadBtn.disabled = true;
    finalUploadBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Uploading...`;
    statusDiv.innerHTML = `<p class="text-info">Uploading ${recordsToUpload.length} records...</p>`;

    const batch = writeBatch(db);
    recordsToUpload.forEach(record => {
        let docId;
        let dataToSave = { ...record };

        if (collectionName === 'classroomSubjects') {
            docId = `${record.classId}_${record.division}_${record.subjectId}_${record.teacherId}`;
            dataToSave.id = docId;
            // Ensure weeklyHour is a number
            dataToSave.weeklyHour = parseInt(dataToSave.weeklyhour) || 0;
            delete dataToSave.weeklyhour; // remove lowercase version
        } else {
            docId = record.id;
        }
        
        if (docId) {
            const docRef = getDocRef(collectionName, docId);
            batch.set(docRef, dataToSave);
        }
    });

    try {
        await batch.commit();
        statusDiv.innerHTML = `<div class="alert alert-success">Successfully uploaded ${recordsToUpload.length} records.</div>`;
        showAlert('Bulk upload complete!', 'success');
        document.getElementById('editable-data-preview').classList.add('d-none');
    } catch (error) {
        console.error("Firestore batch commit failed:", error);
        statusDiv.innerHTML = `<div class="alert alert-danger">Failed to commit changes. Check console for details.</div>`;
        showAlert('Batch upload failed.', 'danger');
    } finally {
        finalUploadBtn.disabled = false;
        finalUploadBtn.innerHTML = `<i class="fas fa-upload me-2"></i>Final Upload`;
    }
}


async function uploadPhotoToDrive(photoBlob, studentId, subfolderName = 'studentPhotos-2025') { // <--- ADD subfolderName with default
    var subfolderName = "studentPhotos-2025";
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = async () => {
            const base64Image = reader.result;
            const formData = new FormData();
            formData.append('photoData', base64Image.split(',')[1]);
            formData.append('studentId', studentId);
            formData.append('subfolderName', subfolderName); // <--- ADD subfolderName to formData

            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyFVRUjvnf3dj5uh0m6BCAiPCWHdmyxV9HvTjEfTB29LWAy7kC5vk96qPDFqwz1JlOK/exec';

            try {
                const response = await fetch(`${SCRIPT_URL}?action=uploadStudentPhotoOnly`, {
                    method: 'POST',
                    body: formData,
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                if (result.success) {
                    resolve(result);
                } else {
                    reject(new Error(result.error || 'Unknown error during Drive upload.'));
                }
            } catch (error) {
                console.error('Error during Drive upload fetch:', error);
                reject(error);
            }
        };
        reader.onerror = (error) => {
            console.error('FileReader error:', error);
            reject(error);
        };
        reader.readAsDataURL(photoBlob);
    });
}

// =========================================================================
// --- ðŸ“Š ADVANCED REPORT GENERATOR (COMPLETE REFACTORED MODULE) ---
// =========================================================================

// --- 1. MAIN UI RENDERING ---

/**
 * Creates the HTML structure for the entire redesigned report generator module.
 * @returns {string} The complete HTML string for the module.
 */
const getReportsModuleHtml = () => `
    <style>
        #selected-fields-list .list-group-item { cursor: grab; background-color: #fff; }
        #selected-fields-list .list-group-item:active { cursor: grabbing; }
        #available-fields-list .list-group-item { cursor: pointer; }
        #available-fields-list .list-group-item:hover { background-color: #f8f9fa; }
        .field-actions { visibility: hidden; }
        .list-group-item:hover .field-actions { visibility: visible; }
        .table-wrap th, .table-wrap td { white-space: normal !important; word-break: break-word; }
        .table-no-wrap th, .table-no-wrap td { white-space: nowrap !important; }
    </style>
    
    <h1 class="h2 mb-4">Advanced Report Generator</h1>
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-body">
                    <div class="row border-bottom pb-3 mb-3">
                        <div class="col-md-6"><label for="report-name" class="form-label fw-bold">1. Report Name</label><input type="text" id="report-name" class="form-control" placeholder="e.g., Student Contact List"></div>
                        <div class="col-md-6"><label for="report-collection-select" class="form-label fw-bold">2. Primary Data Source</label><select id="report-collection-select" class="form-select"><option value="">-- Choose --</option><option value="students">Students</option><option value="teachers">Teachers</option><option value="classes">Classes</option></select></div>
                    </div>

                    <div id="report-config-section" class="d-none">
                        <h5 class="mb-3">3. Build Your Report</h5>
                        <div class="row">
                            <div class="col-md-5">
                                <label class="form-label">Available Fields (Click to add)</label>
                                <div id="available-fields-list" class="list-group border rounded" style="max-height: 250px; overflow-y: auto;"></div>
                            </div>
                            <div class="col-md-7">
                                <label class="form-label">Selected Fields (Drag to reorder)</label>
                                <div id="selected-fields-list" class="list-group list-group-flush p-2 border rounded bg-light" style="max-height: 250px; overflow-y: auto;"></div>
                                <div class="mt-2">
                                     <button id="add-custom-field-btn" class="btn btn-sm btn-outline-secondary"><i class="fas fa-calculator"></i> Custom</button>
                                        <button id="add-related-field-btn" class="btn btn-sm btn-outline-info"><i class="fas fa-link"></i> Related</button>
                                    </div>
                            </div>
                        </div>

                        <div id="demo-table-section" class="mt-4">
                            <hr><h6 class="mb-2 text-muted">Live Column Preview</h6>
                            <div id="demo-table-container" class="table-responsive"></div>
                        </div>

                        <hr>
                        <div id="report-filters-container" class="mt-3"></div>
                        <div class="text-center mt-4"><button id="generate-report-btn" class="btn btn-primary btn-lg">Generate Final Report</button></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow"><div class="card-header fw-bold">Saved Reports</div><div id="saved-reports-list" class="list-group list-group-flush"></div></div>
        </div>
    </div>

    <div id="report-output-section" class="mt-4 d-none"></div>
    
    ${createCustomFieldModal()}
    ${createRelatedFieldModal()}
`;

/**
 * Main render function for the module.
 */
window.renderReportsModule = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) return;
    mainContent.innerHTML = getReportsModuleHtml();
    renderSavedReports();
    attachReportsModuleListeners();
};


// --- 2. EVENT LISTENERS ---

/**
 * Attaches all necessary event listeners for the reports module.
 */
function attachReportsModuleListeners() {
    // Main listeners
    document.getElementById('report-collection-select')?.addEventListener('change', (e) => {
        currentLoadedReport = null; // Reset state when starting a new report
        const collectionName = e.target.value;
        document.getElementById('report-config-section')?.classList.toggle('d-none', !collectionName);
        document.getElementById('report-output-section')?.classList.add('d-none');
        if (collectionName) {
            renderReportFilters(collectionName);
            renderReportFieldSelector(collectionName);
            renderDemoTable();
        }
    });


    document.getElementById('generate-report-btn')?.addEventListener('click', generateAndRenderReport);
    document.getElementById('add-custom-field-btn')?.addEventListener('click', () => showAddCustomFieldModal());
    document.getElementById('add-related-field-btn')?.addEventListener('click', () => showAddRelatedFieldModal());
    
    // Event delegation for dynamically added buttons in the output card
    document.getElementById('report-output-section')?.addEventListener('click', (e) => {
        if (e.target.id === 'save-report-config-btn') saveReportConfiguration(false); // false = Save as New
        if (e.target.id === 'update-report-config-btn') saveReportConfiguration(true); // true = Update
        if (e.target.id === 'save-as-new-report-btn') saveReportConfiguration(false); // false = Save as New
        if (e.target.id === 'print-report-btn') printGeneratedReport();
        if (e.target.id === 'csv-export-btn') downloadReportCSV();
    });


    // Two-Column Field Selection Logic
    const availableFieldsList = document.getElementById('available-fields-list');
    const selectedFieldsList = document.getElementById('selected-fields-list');
// Click to move a field from "Available" to "Selected"
    availableFieldsList?.addEventListener('click', e => {
        const item = e.target.closest('.list-group-item');
        if (item) {
            item.remove();
            addReportFieldToList(item.dataset.fieldName, false, true, null, selectedFieldsList, true);
            renderDemoTable();
        }
    });

    // --- MODIFIED: Listen for any 'input' or 'change' in the selected fields list ---
    selectedFieldsList?.addEventListener('input', e => {
        // This covers text inputs like width
        if (e.target.matches('[data-field-width-for]')) {
            renderDemoTable();
        }
    });
    
    selectedFieldsList?.addEventListener('change', e => {
        // This covers selects, color pickers, and checkboxes
        if (e.target.matches('[data-style-key]')) {
            renderDemoTable();
        }
    });

    
    selectedFieldsList?.addEventListener('input', e => {
        if (e.target.matches('[data-field-width-for]')) {
            renderDemoTable();
        }
    });
// --- FIX: Correctly handle the delete button click ---
    selectedFieldsList?.addEventListener('click', e => {
        const deleteBtn = e.target.closest('.delete-field-btn');
        if (deleteBtn) {
            const item = deleteBtn.closest('.list-group-item');
            const fieldName = item.dataset.fieldName;
            
            item.remove(); // Remove from selected list
            
            // Add back to the "Available" list
            addReportFieldToList(fieldName, false, false, null, availableFieldsList, false);
            
            // Re-sort the available list alphabetically
            const availableItems = Array.from(availableFieldsList.children);
            availableItems.sort((a, b) => a.dataset.fieldName.localeCompare(b.dataset.fieldName));
            availableItems.forEach(item => availableFieldsList.appendChild(item));

            renderDemoTable(); // Update preview
        }
    });

    // Drag-and-drop logic for reordering selected fields
    if (selectedFieldsList) {
        let draggedItem = null;
        selectedFieldsList.addEventListener('dragstart', (e) => {
            draggedItem = e.target.closest('.list-group-item');
            if(draggedItem) setTimeout(() => draggedItem.style.opacity = '0.5', 0);
        });
        selectedFieldsList.addEventListener('dragend', () => {
            if (draggedItem) {
                draggedItem.style.opacity = '1';
                draggedItem = null;
                renderDemoTable();
            }
        });
        selectedFieldsList.addEventListener('dragover', (e) => {
            e.preventDefault();
            if(!draggedItem) return;
            const afterElement = getDragAfterElement(selectedFieldsList, e.clientY);
            if (afterElement == null) {
                selectedFieldsList.appendChild(draggedItem);
            } else {
                selectedFieldsList.insertBefore(draggedItem, afterElement);
            }
        });
    }
}

/**
 * Attaches event listeners specifically for the saved reports list.
 */
function attachSavedReportsListeners() {
    const savedReportsList = document.getElementById('saved-reports-list');
    if (!savedReportsList) return;

    savedReportsList.addEventListener('click', (e) => {
        const loadBtn = e.target.closest('.load-report-btn');
        const deleteBtn = e.target.closest('.delete-report-btn');

        if (loadBtn) {
            e.preventDefault();
            const report = reports.find(r => r.id === loadBtn.dataset.reportId);
            if (report) loadReportSettings(report);
        } else if (deleteBtn) {
            if (confirm('Are you sure you want to delete this report configuration?')) {
                deleteReport(deleteBtn.dataset.reportId);
            }
        }
    });
}


// --- 3. UI RENDERING & MANIPULATION ---

/**
 * Renders the list of saved reports and attaches listeners.
 */
let currentLoadedReport = null; // Tracks the currently loaded report for Save/Update logic
function renderSavedReports() {
    const container = document.getElementById('saved-reports-list');
    if (!container) return;
    if (!reports || reports.length === 0) {
        container.innerHTML = '<p class="text-muted p-3">No saved reports.</p>';
        return;
    }
    container.innerHTML = reports.map(report => `
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <a href="#" class="text-decoration-none text-dark flex-grow-1 load-report-btn" data-report-id="${report.id}">
                <h6 class="mb-1">${report.name}</h6>
                <small class="text-capitalize text-muted">${report.collection}</small>
            </a>
            <button class="btn btn-sm btn-outline-danger delete-report-btn" data-report-id="${report.id}" title="Delete Report"><i class="fas fa-trash-alt"></i></button>
        </div>
    `).join('');
    attachSavedReportsListeners();
}

/**
 * Renders filter and layout options based on the selected collection.
 */
function renderReportFilters(collectionName) {
    const filtersContainer = document.getElementById('report-filters-container');
    if (!filtersContainer) return;

    let filterHtml = `
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="report-text-wrap" checked>
            <label class="form-check-label" for="report-text-wrap">Enable Text Wrapping</label>
        </div>`;

    if (collectionName === 'students') {
        filterHtml += `
            <div>
                <label class="form-label">Filter by Class</label>
                <select id="report-filter-class" class="form-select">
                    <option value="all">-- All Classes (Grouped) --</option>
                    ${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                </select>
            </div>
            <div>
                <label class="form-label">Filter by Division</label>
                <select id="report-filter-division" class="form-select" disabled>
                    <option value="all">-- All Divisions --</option>
                </select>
            </div>`;
    }
    filtersContainer.innerHTML = filterHtml;

    const classFilter = document.getElementById('report-filter-class');
    if (classFilter) {
        classFilter.addEventListener('change', (e) => {
            const divisionSelect = document.getElementById('report-filter-division');
            const selectedClass = classes.find(c => c.id === e.target.value);
            if (divisionSelect) {
                divisionSelect.innerHTML = '<option value="all">-- All Divisions --</option>';
                if (selectedClass) {
                    divisionSelect.disabled = false;
                    divisionSelect.innerHTML += selectedClass.divisions.map(d => `<option value="${d}">${d}</option>`).join('');
                } else {
                    divisionSelect.disabled = true;
                }
            }
        });
    }
}
// =========================================================================
// --- ðŸ“Š ADVANCED REPORT GENERATOR (HELPER FUNCTIONS) ---
// =========================================================================

// --- 3. UI RENDERING & MANIPULATION ---

/**
 * Renders the "Available" and "Selected" field lists when a data source is chosen.
 */
function renderReportFieldSelector(collectionName, savedFields = []) {
    const availableFieldsContainer = document.getElementById('available-fields-list');
    const selectedFieldsContainer = document.getElementById('selected-fields-list');
    
    availableFieldsContainer.innerHTML = '';
    selectedFieldsContainer.innerHTML = '';

    // Add the locked "Sl. No." field to the selected list first
    addReportFieldToList('Sl. No.', false, true, null, selectedFieldsContainer, true);

    let baseFields = [];
    if (collectionName === 'students' && students.length > 0) baseFields = Object.keys(students[0]);
    else if (collectionName === 'teachers' && teachers.length > 0) baseFields = Object.keys(teachers[0]);
    else if (collectionName === 'classes' && classes.length > 0) baseFields = Object.keys(classes[0]);
    
    baseFields = baseFields.filter(k => !k.startsWith('__') && !['fees', 'promotionHistory'].includes(k)).sort();

    if (savedFields.length > 0) {
        const savedFieldNames = new Set(savedFields.map(f => f.name));
        savedFields.forEach(sf => {
            if (sf.name !== 'Sl. No.') {
                addReportFieldToList(sf.name, sf.isCustom, true, sf.customInfo, selectedFieldsContainer, true);
            }
        });
        baseFields.filter(f => !savedFieldNames.has(f)).forEach(field => {
            addReportFieldToList(field, false, false, null, availableFieldsContainer, false);
        });
    } else {
        baseFields.forEach(field => {
            addReportFieldToList(field, false, false, null, availableFieldsContainer, false);
        });
    }
}

/**
 * Adds a field to the "Selected Fields" list with a full set of styling controls.
 */
function addReportFieldToList(fieldName, isCustom, isSelected, customInfo, container, includeActions) {
    if (!container || typeof container.appendChild !== 'function') {
        console.error("Cannot add field: The target container is not a valid DOM element.", container);
        return;
    }
    
    const item = document.createElement('div');
    const isLocked = fieldName === 'Sl. No.';
    item.className = `list-group-item ${isLocked ? 'locked' : ''}`;
    item.dataset.fieldName = fieldName;
    item.dataset.isCustom = isCustom;
    if (customInfo) {
        item.dataset.customInfo = JSON.stringify(customInfo);
    }

    if (includeActions) {
        item.draggable = !isLocked;
        const badge = isCustom ? '<span class="badge bg-warning text-dark ms-2">Custom</span>' : '';
        const fieldIdSafe = fieldName.replace(/[^a-zA-Z0-9]/g, '_');

        item.innerHTML = `
            <div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>${fieldName}${badge}</span>
                    <div class="field-actions">
                        ${!isLocked ? `<button class="btn btn-sm btn-outline-danger py-0 px-1 delete-field-btn" title="Remove"><i class="fas fa-times fa-xs"></i></button>` : ''}
                        <i class="fas fa-grip-vertical text-muted ms-2"></i>
                    </div>
                </div>
                <div class="row gx-2 gy-1 mt-2">
                    <div class="col-6">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">W:</span>
                            <input type="text" class="form-control" placeholder="auto" id="width-input-${fieldIdSafe}" data-field-width-for="${fieldName}">
                        </div>
                    </div>
                    <div class="col-6">
                        <select class="form-select form-select-sm" data-style-key="textAlign">
                            <option value="left">Align Left</option>
                            <option value="center">Align Center</option>
                            <option value="right">Align Right</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">Color</span>
                            <input type="color" class="form-control form-control-color" value="#000000" data-style-key="color">
                        </div>
                    </div>
                    <div class="col-6 d-flex align-items-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" data-style-key="fontWeight" id="bold-check-${fieldIdSafe}">
                            <label class="form-check-label" for="bold-check-${fieldIdSafe}">Bold</label>
                        </div>
                    </div>
                </div>
            </div>`;
    } else {
        item.innerHTML = `<span>${fieldName}</span>`;
    }
    
    container.appendChild(item);
}
/**
 * Renders a simple one-row table to preview column arrangement and widths.
 */
/**
 * Renders a simple, resizable one-row table to preview column arrangement and widths.
 */
function renderDemoTable() {
    const container = document.getElementById('demo-table-container');
    if (!container) return;
    const config = getReportConfiguration();
    if (!config) return;
    const selectedFields = config.fields.filter(f => f.isSelected);

    if (selectedFields.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Add fields to see a preview.</p>';
        return;
    }

    const tableHTML = `
        <table id="demo-report-table" class="table table-bordered table-sm">
            <thead>
                <tr>
                    ${selectedFields.map(h => {
                        const style = h.styles || {};
                        return `<th style="width: ${style.width}; text-align: ${style.textAlign}; color: ${style.color}; font-weight: ${style.fontWeight};" 
                                    data-field-name="${h.name}">
                                    ${h.name}
                                </th>`;
                    }).join('')}
                </tr>
            </thead>
            <tbody>
                <tr>
                    ${selectedFields.map(h => {
                        const style = h.styles || {};
                        return `<td style="text-align: ${style.textAlign}; color: ${style.color}; font-weight: ${style.fontWeight};">Sample Data</td>`;
                    }).join('')}
                </tr>
            </tbody>
        </table>`;
    
    container.innerHTML = tableHTML;
    const demoTable = document.getElementById('demo-report-table');
    if (demoTable) {
        makeTableResizable(demoTable);
    }
}

function createReportTable(headers, data, config) {
    let tableHTML = `<table class="table table-bordered table-striped table-sm">`;
    
    tableHTML += `<thead><tr>${headers.map(h => {
        const style = h.styles || {};
        return `<th style="width: ${style.width}; text-align: ${style.textAlign}; color: ${style.color}; font-weight: ${style.fontWeight};">${h.name}</th>`;
    }).join('')}</tr></thead>`;
    
    tableHTML += '<tbody>';
    data.forEach(row => {
        tableHTML += '<tr>';
        headers.forEach(header => {
            const style = header.styles || {};
            const value = getNestedValue(row, header.name);
            tableHTML += `<td style="text-align: ${style.textAlign}; color: ${style.color}; font-weight: ${style.fontWeight};">${value}</td>`;
        });
        tableHTML += '</tr>';
    });
    tableHTML += '</tbody></table>';
    return tableHTML;
}


// --- 4. DATA HANDLING & CONFIGURATION ---

/**
 * The core data processing function.
 */
async function getReportData(collectionName, config) {
    let sourceData = [];
    if (collectionName === 'students') sourceData = students;
    else if (collectionName === 'teachers') sourceData = teachers;
    else if (collectionName === 'classes') sourceData = classes;

    let data = JSON.parse(JSON.stringify(sourceData));
    
    // 1. Apply primary filters first
    if (config.filters.classId && config.filters.classId !== 'all') {
        data = data.filter(item => item.classId === config.filters.classId);
        if (config.filters.division && config.filters.division !== 'all') {
            data = data.filter(item => item.division === config.filters.division);
        }
    }

    // --- FIX: This is the corrected logic for joining related data ---
    if (config.relatedFields && config.relatedFields.length > 0) {
        const allCollections = { students, teachers, classes };
        
        // Loop through each item in our primary dataset (e.g., each student)
        for (const item of data) {
            // For each item, process all the "related fields" defined in the config
            for (const relatedField of config.relatedFields) {
                const step = relatedField.steps[0];
                const localValue = getNestedValue(item, step.localKey);
                
                // Find the matching record in the other collection
                if (localValue !== undefined && localValue !== null) {
                    const relatedCollectionData = allCollections[step.relatedCollection] || [];
                    const match = relatedCollectionData.find(relItem => 
                        String(getNestedValue(relItem, step.foreignKey)) === String(localValue)
                    );

                    // If a match is found, join the requested fields and add it to our item
                    if (match) {
                        item[relatedField.alias] = step.returnFields
                            .map(fieldName => getNestedValue(match, fieldName))
                            .join(relatedField.joinWith);
                    } else {
                        item[relatedField.alias] = 'N/A'; // Default value if no match found
                    }
                } else {
                    item[relatedField.alias] = 'N/A';
                }
            }
        }
    }

    // 2. Process derived, custom, and serial number fields on the final dataset
    data.forEach((item, index) => {
        item['Sl. No.'] = index + 1;

        if (collectionName === 'students') {
            const className = classes.find(c => c.id === item.classId)?.name;
            item.fullClassName = className ? `${className} - ${item.division}` : 'N/A';
        }
        
        config.customFields.forEach(cf => {
            try {
                const formula = cf.formula.replace(/\{\{([^{}]+)\}\}/g, (match, fieldName) => {
                    const val = getNestedValue(item, fieldName.trim());
                    return typeof val === 'number' ? val : 0;
                });
                item[cf.alias] = new Function(`return ${formula}`)();
            } catch (e) {
                item[cf.alias] = 'Error';
            }
        });
    });

    return data;
}


/**
 * Gathers the current report configuration from the UI.
 */
/**
 * Gathers the current report configuration from all UI elements, including column widths,
 * alignment, color, and font weight.
 * @returns {object|null} The report configuration object or null if essential UI elements are missing.
 */
function getReportConfiguration() {
    // 1. Get references to all the main configuration elements
    const reportNameEl = document.getElementById('report-name');
    const collectionSelectEl = document.getElementById('report-collection-select');
    const classFilterEl = document.getElementById('report-filter-class');
    const divisionFilterEl = document.getElementById('report-filter-division');

    if (!reportNameEl || !collectionSelectEl) {
        console.error("Cannot get report configuration: Essential UI elements are missing.");
        return null;
    }

    // 2. Map over each field in the "Selected Fields" list to gather its specific settings
    const fields = Array.from(document.querySelectorAll('#selected-fields-list .list-group-item')).map(item => {
        const fieldName = item.dataset.fieldName;
        
        // Gather all style values from the controls within the field item
        const styles = {
            width: item.querySelector(`[data-field-width-for="${fieldName}"]`)?.value.trim() || 'auto',
            textAlign: item.querySelector('[data-style-key="textAlign"]')?.value || 'left',
            color: item.querySelector('[data-style-key="color"]')?.value || '#000000',
            fontWeight: item.querySelector('[data-style-key="fontWeight"]')?.checked ? 'bold' : 'normal'
        };

        return {
            name: fieldName,
            isSelected: true, // All items in this list are considered selected
            isCustom: item.dataset.isCustom === 'true',
            customInfo: JSON.parse(item.dataset.customInfo || 'null'),
            relatedInfo: JSON.parse(item.dataset.relatedInfo || 'null'), // <-- Correctly capture related info
            styles: styles // Attach the styles object to the field configuration
        };
    });

    // 3. Assemble and return the complete configuration object
    return {
        name: reportNameEl.value,
        collection: collectionSelectEl.value,
        textWrap: document.getElementById('report-text-wrap')?.checked || false,
        fields: fields,
        customFields: fields.filter(f => f.customInfo).map(f => f.customInfo),
        relatedFields: fields.filter(f => f.relatedInfo).map(f => f.relatedInfo),
   
        filters: {
            classId: classFilterEl ? classFilterEl.value : null,
            division: divisionFilterEl ? divisionFilterEl.value : null
        }
        
    };
}

/**
 * Loads a saved report's configuration into the UI.
 */
function loadReportSettings(report) {
    currentLoadedReport = report; // Set the global state to the loaded report
    
    document.getElementById('report-name').value = report.name;
    const collectionSelect = document.getElementById('report-collection-select');
    collectionSelect.value = report.collection;
    collectionSelect.dispatchEvent(new Event('change'));


    setTimeout(() => {
        renderReportFieldSelector(report.collection, report.fields);
        if (document.getElementById('report-text-wrap')) {
            document.getElementById('report-text-wrap').checked = report.textWrap;
        }
        if (report.filters) {
            const classFilter = document.getElementById('report-filter-class');
            if (classFilter) {
                classFilter.value = report.filters.classId || 'all';
                classFilter.dispatchEvent(new Event('change'));
                setTimeout(() => {
                    const divisionFilter = document.getElementById('report-filter-division');
                    if (divisionFilter) {
                        divisionFilter.value = report.filters.division || 'all';
                    }
                }, 50);
            }
        }
        renderDemoTable();
        showAlert(`Loaded settings for report: ${report.name}`, 'info');
    }, 100);
}

/**
 * Saves the current report configuration to Firestore.
 */
async function saveReportConfiguration(isUpdate = false) {
    const config = getReportConfiguration();
    if (!config || !config.name) {
        return showAlert('Please enter a report name before saving.', 'warning');
    }

    if (isUpdate && currentLoadedReport) {
        // --- UPDATE LOGIC ---
        config.id = currentLoadedReport.id; // Use the existing ID
    } else {
        // --- SAVE AS NEW LOGIC ---
        config.id = config.name.replace(/\s+/g, '_').toLowerCase() + `_${Date.now()}`;
    }

    try {
        await setDoc(getDocRef('reports', config.id), config);
        showAlert(`Report '${config.name}' was ${isUpdate ? 'updated' : 'saved'} successfully.`, 'success');
        
        // After saving, the current state is now this saved report
        currentLoadedReport = config; 
        // Re-render the output to show the "Update" and "Save as New" buttons
        generateAndRenderReport();

    } catch (error) {
        console.error("Error saving report settings:", error);
        showAlert('Failed to save report configuration.', 'danger');
    }
}

// =========================================================================
// --- ðŸ“Š ADVANCED REPORT GENERATOR (RELATED FIELDS MODULE) ---
// =========================================================================

/**
 * Creates the HTML structure for the redesigned "Related Field" modal.
 * @returns {string} The HTML string for the modal.
 */
function createRelatedFieldModal() {
    return `
        <div class="modal fade" id="relatedFieldModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add/Edit Related Field</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Step 1: Link Collections</h6>
                                <p class="card-text text-muted small">Create a link between your primary data source and another collection.</p>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Match Field From <strong class="primary-collection-name-span"></strong></label>
                                        <select id="modal-local-key" class="form-select"></select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">With Field From <strong class="related-collection-name-span"></strong></label>
                                        <select id="modal-foreign-key" class="form-select"></select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Step 2: Select Data to Display</h6>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Related Collection</label>
                                        <select id="modal-related-collection" class="form-select"></select>
                                    </div>
                                    <div class="col-md-8">
                                        <label class="form-label">Field(s) to Display</label>
                                        <div id="modal-return-fields-container" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">New Field Name (Alias)</label>
                                        <input type="text" id="modal-alias" class="form-control" placeholder="e.g., Class Teacher Name">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Join Fields With (Optional)</label>
                                        <input type="text" id="modal-join-with" class="form-control" placeholder="e.g., ' - ' or ', '">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="modal-add-field-btn" class="btn btn-primary">Save Field</button>
                    </div>
                </div>
            </div>
        </div>`;
}

/**
 * Shows and populates the modal for adding or editing a related field.
 */
function showAddRelatedFieldModal(fieldInfo = null) {
    const isEditMode = fieldInfo !== null;
    const primaryCollection = document.getElementById('report-collection-select').value;
    if (!primaryCollection) {
        return showAlert('Please select a primary data source first.', 'warning');
    }

    const allCollections = { students, teachers, classes };
    const relatedCollectionSelect = document.getElementById('modal-related-collection');
    const localKeySelect = document.getElementById('modal-local-key');
    const foreignKeySelect = document.getElementById('modal-foreign-key');
    const returnFieldsContainer = document.getElementById('modal-return-fields-container');
    const aliasInput = document.getElementById('modal-alias');
    const joinWithInput = document.getElementById('modal-join-with');

    // Helper to populate dropdowns with keys from a collection
    const populateKeys = (selectEl, collectionName) => {
        const sample = allCollections[collectionName]?.[0];
        if (selectEl) {
            selectEl.innerHTML = sample ? Object.keys(sample).filter(k => !k.startsWith('__')).map(k => `<option value="${k}">${k}</option>`).join('') : '';
        }
    };

    // Helper to populate the checkbox list of fields to return
    const populateReturnFields = (containerEl, collectionName) => {
        const sample = allCollections[collectionName]?.[0];
        if (containerEl) {
            containerEl.innerHTML = sample ? Object.keys(sample).filter(k => !k.startsWith('__')).map(k => `
                <div class="form-check"><input class="form-check-input" type="checkbox" value="${k}" id="return_field_${k}"><label class="form-check-label" for="return_field_${k}">${k}</label></div>
            `).join('') : '';
        }
    };
    
    // Initial population
    document.querySelectorAll('.primary-collection-name-span').forEach(span => { span.textContent = primaryCollection; });
    relatedCollectionSelect.innerHTML = Object.keys(allCollections).filter(c => c !== primaryCollection).map(c => `<option value="${c}">${c}</option>`).join('');
    populateKeys(localKeySelect, primaryCollection);

    // Function to update dependent dropdowns when "Related Collection" changes
    const updateRelatedFields = () => {
        const relatedCollection = relatedCollectionSelect.value;
        document.querySelectorAll('.related-collection-name-span').forEach(span => { span.textContent = relatedCollection; });
        populateKeys(foreignKeySelect, relatedCollection);
        populateReturnFields(returnFieldsContainer, relatedCollection);
    };
    
    relatedCollectionSelect.addEventListener('change', updateRelatedFields);
    updateRelatedFields(); // Call once to initialize

    // Pre-fill the form if in edit mode
    if (isEditMode && fieldInfo.relatedInfo) {
        const info = fieldInfo.relatedInfo;
        const step = info.steps[0];
        aliasInput.value = info.alias;
        joinWithInput.value = info.joinWith;
        relatedCollectionSelect.value = step.relatedCollection;
        updateRelatedFields(); // Update dropdowns before setting values
        localKeySelect.value = step.localKey;
        foreignKeySelect.value = step.foreignKey;
        step.returnFields.forEach(rf => {
            const checkbox = returnFieldsContainer.querySelector(`input[value="${rf}"]`);
            if (checkbox) checkbox.checked = true;
        });
    } else {
        // Reset form for "add new" mode
        aliasInput.value = '';
        joinWithInput.value = '';
    }

    const modal = new bootstrap.Modal(document.getElementById('relatedFieldModal'));
    
    // Save button logic
    document.getElementById('modal-add-field-btn').onclick = () => {
        const returnFields = Array.from(returnFieldsContainer.querySelectorAll('input:checked')).map(cb => cb.value);
        if (returnFields.length === 0) {
            return showAlert('Please select at least one field to display.', 'danger');
        }
        const relatedInfo = {
            alias: aliasInput.value.trim(),
            joinWith: joinWithInput.value.trim() || ' ',
            steps: [{
                relatedCollection: relatedCollectionSelect.value,
                localKey: localKeySelect.value,
                foreignKey: foreignKeySelect.value,
                returnFields: returnFields
            }]
        };
        if (!relatedInfo.alias) {
            return showAlert('Please provide a name (alias) for the new field.', 'danger');
        }

        if (isEditMode) {
            // Update the existing field item in the list
            const item = fieldInfo.element;
            item.dataset.fieldName = relatedInfo.alias;
            item.dataset.relatedInfo = JSON.stringify(relatedInfo);
            // Update the visible label (assuming a structure for it)
            item.querySelector('span').textContent = relatedInfo.alias;
        } else {
            // Add a new field item to the 'Selected Fields' list
            addReportFieldToList(relatedInfo.alias, false, true, relatedInfo, document.getElementById('selected-fields-list'), true);
        }
        modal.hide();
        renderDemoTable(); // Refresh the preview
    };

    modal.show();
}


/**
 * Deletes a saved report configuration from Firestore.
 */
async function deleteReport(reportId) {
    try {
        await deleteDoc(getDocRef('reports', reportId));
        showAlert('Report configuration deleted.', 'success');
    } catch (error) {
        showAlert('Failed to delete report.', 'danger');
    }
}


// --- 5. EXPORT & PRINTING ---
/**
 * Gathers settings, gets data, and renders the final report output in the UI.
 */
/**
 * Gathers settings, gets data, and renders the report output.
 * (Corrected to prevent 'null' reference errors).
 */
async function generateAndRenderReport() {
    const outputSection = document.getElementById('report-output-section');
    const reportName = document.getElementById('report-name')?.value || 'Generated Report';
    
    // Determine which save buttons to show based on whether a report is loaded
    let saveButtonHtml = '';
    if (currentLoadedReport) {
        saveButtonHtml = `
            <div class="btn-group">
                <button id="update-report-config-btn" class="btn btn-success"><i class="fas fa-save me-2"></i>Update Current Report</button>
                <button id="save-as-new-report-btn" class="btn btn-outline-success"><i class="fas fa-plus me-2"></i>Save as New Copy</button>
            </div>
        `;
    } else {
        saveButtonHtml = `<button id="save-report-config-btn" class="btn btn-success"><i class="fas fa-save me-2"></i>Save Configuration</button>`;
    }

    // Build the output card structure with the correct buttons
    outputSection.innerHTML = `
        <div class="card shadow">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                    <h3 id="report-output-title" class="h4 mb-0"></h3>
                    <div class="btn-toolbar">
                        ${saveButtonHtml}
                        <button id="print-report-btn" class="btn btn-secondary mx-2"><i class="fas fa-print me-2"></i>Print</button>
                        <button id="csv-export-btn" class="btn btn-primary"><i class="fas fa-file-csv me-2"></i>CSV</button>
                    </div>
                </div>
                <div id="report-content-container" class="table-responsive"></div>
            </div>
        </div>`;
    
    const contentContainer = document.getElementById('report-content-container');
    const reportTitleEl = document.getElementById('report-output-title');

    outputSection.classList.remove('d-none');
    reportTitleEl.textContent = reportName;
    contentContainer.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary"></div><p class="mt-2">Generating report...</p></div>`;

    const config = getReportConfiguration();
    if (!config) {
        contentContainer.innerHTML = '<p class="text-danger">Could not generate report due to missing configuration.</p>';
        return;
    }
    
    const data = await getReportData(config.collection, config);
    renderReportOutput(data, config);
}


/**
 * Renders the final report content (table, cards, etc.) and makes the table resizable.
 * This function is called by generateAndRenderReport after the data has been fetched.
 */
function renderReportOutput(data, config) {
    const contentContainer = document.getElementById('report-content-container');
    if (!contentContainer) return;

    // Store the raw data on the element so other functions (like CSV export) can access it.
    contentContainer.dataset.reportData = JSON.stringify(data);
    
    const selectedFields = config.fields.filter(f => f.isSelected);

    if (data.length === 0) {
        contentContainer.innerHTML = '<p class="text-center text-muted">No data found matching the criteria.</p>';
        return;
    }

    // Helper function to render a single group of data (e.g., one division's table).
    const renderGroup = (groupData, title) => {
        let html = title ? `<h4 class="mt-4">${title}</h4>` : '';
        html += createReportTable(selectedFields, groupData, config); // Assuming table layout for simplicity
        return html;
    };

    // If grouping by class and division, render a separate table for each group.
    if (config.collection === 'students' && config.filters.classId && config.filters.classId !== 'all' && config.filters.division === 'all') {
        let fullReportHtml = '';
        const selectedClass = classes.find(c => c.id === config.filters.classId);
        if (selectedClass) {
            selectedClass.divisions.forEach(div => {
                const divisionData = data.filter(s => s.division === div);
                if (divisionData.length > 0) {
                    const groupTitle = `${selectedClass.name} - ${div}`;
                    fullReportHtml += `<div class="printable-group">${renderGroup(divisionData, groupTitle)}</div>`;
                }
            });
        }
        contentContainer.innerHTML = fullReportHtml;
    } else {
        // Otherwise, render a single table for all the data.
        contentContainer.innerHTML = renderGroup(data, '');
    }

    // Make the columns of the newly created table resizable.
    const reportTable = document.getElementById('generated-report-table');
    if (reportTable) {
        makeTableResizable(reportTable);
    }
}
/**
 * Makes table headers resizable and syncs the new width back to the configuration UI.
 */
function makeTableResizable(table) {
    const headers = table.querySelectorAll('th');
    headers.forEach(header => {
        const resizer = document.createElement('div');
        resizer.style.position = 'absolute';
        resizer.style.top = '0';
        resizer.style.right = '0';
        resizer.style.width = '5px';
        resizer.style.height = '100%';
        resizer.style.cursor = 'col-resize';
        resizer.style.userSelect = 'none';
        header.style.position = 'relative';
        header.appendChild(resizer);

        resizer.addEventListener('mousedown', (e) => {
            let x = e.clientX;
            let w = header.offsetWidth;

            const onMouseMove = (moveEvent) => {
                const dx = moveEvent.clientX - x;
                header.style.width = `${w + dx}px`;
            };

            const onMouseUp = () => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);

                // --- THIS IS THE FIX ---
                // When resizing is done, update the corresponding input box in the builder.
                const fieldName = header.dataset.fieldName;
                if (fieldName) {
                    const fieldIdSafe = fieldName.replace(/[^a-zA-Z0-9]/g, '_');
                    const widthInput = document.getElementById(`width-input-${fieldIdSafe}`);
                    if (widthInput) {
                        widthInput.value = header.style.width;
                    }
                }
            };

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });
    });
}
/**
 * Generates and prints a professional, multi-page report.
 */
function printGeneratedReport() {
    const config = getReportConfiguration();
    if (!config) return;
    const reportData = JSON.parse(document.getElementById('report-content-container').dataset.reportData || '[]');
    if (reportData.length === 0) return showAlert('No data to print.', 'info');
    
    let fullHtmlOutput = '';
    const selectedFields = config.fields.filter(f => f.isSelected);

    if (config.collection === 'students' && config.filters.classId && config.filters.classId !== 'all') {
        const selectedClass = classes.find(c => c.id === config.filters.classId);
        const divisionsToPrint = (config.filters.division === 'all') ? selectedClass.divisions.sort() : [config.filters.division];
        
        divisionsToPrint.forEach(div => {
            const groupData = reportData.filter(s => s.division === div);
            if (groupData.length > 0) {
                const headerInfo = {
                    title: config.name,
                    subTitle: `Class: ${selectedClass.name} - ${div}`
                };
                fullHtmlOutput += `<div class="printable-page">${generateReportHeaderHTML(headerInfo)}${createReportTable(selectedFields, groupData, config)}</div>`;
            }
        });
    } else {
        const headerInfo = { title: config.name, subTitle: `Data Source: ${config.collection}` };
        fullHtmlOutput = `<div class="printable-page">${generateReportHeaderHTML(headerInfo)}${createReportTable(selectedFields, reportData, config)}</div>`;
    }

    if (!fullHtmlOutput) return showAlert('No data matched the criteria for printing.', 'info');

    printReport({
        contentHtml: fullHtmlOutput,
        title: config.name.replace(/\s+/g, '_'),
        extraCss: `.printable-page { page-break-after: always; } .printable-page:last-child { page-break-after: avoid; } table { font-size: 9pt; }`
    });
}
// =========================================================================
// --- ðŸ“Š ADVANCED REPORT GENERATOR (HELPER FUNCTIONS) ---
// =========================================================================

// --- 5. EXPORT & PRINTING ---

/**
 * Downloads the current report data as a CSV file.
 */
function downloadReportCSV() {
    const config = getReportConfiguration();
    const dataContainer = document.getElementById('report-content-container');
    if (!config || !dataContainer.dataset.reportData) {
        showAlert('No report data available to download.', 'warning');
        return;
    }

    const data = JSON.parse(dataContainer.dataset.reportData);
    const headers = config.fields.filter(f => f.isSelected);
    const headerRow = headers.map(h => h.name).join(',');

    const rows = data.map(row => {
        return headers.map(header => {
            const value = getNestedValue(row, header.name);
            const stringValue = String(value).replace(/"/g, '""'); // Escape double quotes
            return `"${stringValue}"`;
        }).join(',');
    });

    const csvContent = [headerRow, ...rows].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `${config.name.replace(/\s+/g, '_')}_report.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}


// --- 6. MODALS & HELPERS ---

/**
 * Shows and populates the modal for adding a new custom calculated field.
 */
function showAddCustomFieldModal() {
    const aliasInput = document.getElementById('custom-field-alias');
    const formulaInput = document.getElementById('custom-field-formula');
    const placeholdersContainer = document.getElementById('custom-field-placeholders');
    
    // Gather all currently available fields for use as placeholders
    const availableFields = Array.from(document.querySelectorAll('#available-fields-list .list-group-item, #selected-fields-list .list-group-item'))
        .map(item => item.dataset.fieldName);
        
    if (placeholdersContainer) {
        placeholdersContainer.innerHTML = [...new Set(availableFields)].sort().map(f => `<span class="badge bg-light text-dark">{{${f}}}</span>`).join(' ');
    }

    aliasInput.value = '';
    formulaInput.value = '';

    const modal = new bootstrap.Modal(document.getElementById('customFieldModal'));

    // Use .onclick to ensure only one listener is active at a time
    document.getElementById('modal-add-custom-btn').onclick = () => {
        const customInfo = {
            alias: aliasInput.value.trim(),
            formula: formulaInput.value.trim()
        };
        if (!customInfo.alias || !customInfo.formula) {
            return showAlert('Please provide an alias and a formula.', 'danger');
        }
        
        const selectedFieldsContainer = document.getElementById('selected-fields-list');
        addReportFieldToList(customInfo.alias, true, true, customInfo, selectedFieldsContainer, true);
        renderDemoTable(); // Update the preview table
        
        modal.hide();
    };

    modal.show();
}

/**
 * Creates the HTML for the custom field modal.
 */
function createCustomFieldModal() {
    return `
        <div class="modal fade" id="customFieldModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Custom Calculated Field</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">New Field Name (Alias)</label>
                            <input type="text" id="custom-field-alias" class="form-control" placeholder="e.g., totalScore">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Formula</label>
                            <input type="text" id="custom-field-formula" class="form-control" placeholder="e.g., {{fieldA}} + {{fieldB}}">
                            <small class="text-muted">Use placeholders for fields. Only basic math (+, -, *, /) is supported.</small>
                        </div>
                        <div>
                            <small class="text-muted">Available Placeholders:</small>
                            <div id="custom-field-placeholders" class="d-flex flex-wrap gap-1 mt-1"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="modal-add-custom-btn" class="btn btn-primary">Save Custom Field</button>
                    </div>
                </div>
            </div>
        </div>`;
}

/**
 * Helper function for drag-and-drop functionality.
 */
function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.list-group-item:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

/**
 * Helper to safely access nested property values from an object using a dot-notation string.
 */
/**
 * Helper function to safely access a nested property value from an object using a dot-notation string.
 * Example: getNestedValue({ student: { name: 'Alice' } }, 'student.name') returns 'Alice'
 * @param {object} obj - The object to query.
 * @param {string} path - The dot-separated path to the value (e.g., 'student.name').
 * @returns {*} The value found at the specified path, or an empty string if any part of the path is not found.
 */
function getNestedValue(obj, path) {
    // If the object or path is invalid, return an empty string immediately.
    if (!obj || typeof path !== 'string') {
        return '';
    }

    // Split the path into individual keys and navigate through the object.
    const value = path.split('.').reduce((currentObject, key) => {
        // If the current object is valid, move to the next key; otherwise, return undefined.
        return currentObject ? currentObject[key] : undefined;
    }, obj);

    // Return the final value, or an empty string if the value is null or undefined.
    return value !== undefined && value !== null ? value : '';
}
// --- VEHICLE MANAGEMENT & NOTIFICATION MODULE (ENHANCED) ---
// --- VEHICLE MANAGEMENT & NOTIFICATION MODULE (PERFECTED) ---

let previousNotificationCount = 0; // To track new notifications for sound alert

/**
 * The main function to gather all notifications from different sources and update the UI.
 */
function updateAllNotifications() {
    const vehicleNotifications = getVehicleExpiryNotifications();
    const formNotifications = getPendingFormNotifications();
    const libraryNotifications = getLibraryDueNotifications(); 

    const allNotifications = [...vehicleNotifications, ...formNotifications ,...libraryNotifications];
    
    // Play a sound if the number of notifications has increased
    if (allNotifications.length > previousNotificationCount) {
        // Use Tone.js to play a simple synth note without external files
        try {
            const synth = new Tone.Synth().toDestination();
            synth.triggerAttackRelease("C5", "8n");
        } catch(e) {
            console.warn("Tone.js not available for notification sound.", e);
        }
    }
    previousNotificationCount = allNotifications.length;

    renderNotifications(allNotifications);
    updateSidebarBadges(allNotifications);
}

/**
 * Checks all vehicle documents for upcoming expiries.
 * @returns {Array<object>} An array of vehicle notification objects.
 */
function getVehicleExpiryNotifications() {
    const notifications = [];
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const thirtyDaysFromNow = new Date();
    thirtyDaysFromNow.setDate(today.getDate() + 30);

    (vehicles || []).forEach(vehicle => {
        const checkExpiry = (dateStr, docName) => {
            if (!dateStr) return;
            const expiryDate = new Date(dateStr);
            if (expiryDate <= thirtyDaysFromNow) {
                const timeDiff = expiryDate.getTime() - today.getTime();
                const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24));
                notifications.push({
                    type: 'vehicle',
                    id: `vehicle_${vehicle.id}_${docName}`,
                    title: vehicle.id,
                    docName: docName,
                    daysRemaining: daysRemaining,
                    expiryDate: expiryDate.toLocaleDateString('en-GB'),
                    targetView: 'vehicle-mgt'
                });
            }
        };

        checkExpiry(vehicle.taxExpiry, 'Tax');
        checkExpiry(vehicle.permitExpiry, 'Permit');
        checkExpiry(vehicle.insuranceExpiry, 'Insurance');
        checkExpiry(vehicle.fitnessExpiry, 'Fitness');
        checkExpiry(vehicle.pollutionExpiry, 'Pollution');
        checkExpiry(vehicle.gpsExpiry, 'GPS');
    });
    return notifications;
}

/**
 * Checks for active forms that the current user has not yet submitted.
 * @returns {Array<object>} An array of form notification objects.
 */
function getPendingFormNotifications() {
    if (!currentUserRole || !selectedUser) return [];

    const notifications = [];
    
    const applicableForms = (forms || []).filter(f => {
        if (!f.isActive) return false;
        if (f.target !== currentUserRole) return false;
        if (currentUserRole === 'student') {
            const classMatch = !f.classId || f.classId === selectedUser.classId;
            const divisionMatch = !f.division || f.division === selectedUser.division;
            return classMatch && divisionMatch;
        }
        return true;
    });

    applicableForms.forEach(form => {
        const hasResponded = (formResponses || []).some(r => r.formId === form.id && r.userId === selectedUser.id);
        if (!hasResponded) {
            let targetView = 'forms';
            if (currentUserRole === 'teacher') targetView = 'teacher-forms';
            
            notifications.push({
                type: 'form',
                id: `form_${form.id}`,
                title: form.title,
                text: 'A new form requires your attention.',
                targetView: targetView
            });
        }
    });

    return notifications;
}

/**
 * Renders all notifications in the dropdown menu and updates the main badge.
 * @param {Array<object>} notifications - An array of notification objects.
 */
function renderNotifications(notifications) {
    const notificationList = document.getElementById('notification-list');
    const notificationBadge = document.getElementById('notification-badge');
    if (!notificationList || !notificationBadge) return;

    if (notifications.length > 0) {
        notificationBadge.textContent = notifications.length;
        notificationBadge.classList.remove('d-none');
        
        notifications.sort((a, b) => (a.daysRemaining || 999) - (b.daysRemaining || 999));

        notificationList.innerHTML = notifications.map(n => {
            if (n.type === 'vehicle') {
                let daysText;
                if (n.daysRemaining < 0) daysText = `<span class="text-danger fw-bold">${n.docName} renewal was due ${Math.abs(n.daysRemaining)} days ago.</span>`;
                else if (n.daysRemaining === 0) daysText = `<span class="text-danger fw-bold">${n.docName} renewal is due today.</span>`;
                else daysText = `<span>${n.docName} renewal due in ${n.daysRemaining} days.</span>`;
                
                return `<li><a class="dropdown-item" href="#" onclick="event.preventDefault(); navigateTo('${n.targetView}');"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1 fw-bold">${n.title}</h6><small class="text-muted">${n.expiryDate}</small></div><p class="mb-0 small">${daysText}</p></a></li>`;
            } 
            else if (n.type === 'form') {
                 return `<li><a class="dropdown-item" href="#" onclick="event.preventDefault(); navigateTo('${n.targetView}');"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1 fw-bold">${n.title}</h6><small class="text-primary">New Form</small></div><p class="mb-0 small text-muted">${n.text}</p></a></li>`;
            }
            return '';
        }).join('') + '<li><hr class="dropdown-divider"></li><li><a id="clear-all-notifications" class="dropdown-item text-center text-muted small" href="#">Clear all</a></li>';
    
        document.getElementById('clear-all-notifications').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            notificationList.innerHTML = '<li><p class="p-3 text-center text-muted mb-0">No new notifications.</p></li>';
            notificationBadge.classList.add('d-none');
            previousNotificationCount = 0;
            updateSidebarBadges([]); // Clear sidebar badges as well
        });

    } else {
        notificationBadge.classList.add('d-none');
        notificationList.innerHTML = '<li><p class="p-3 text-center text-muted mb-0">No new notifications.</p></li>';
    }
}

/**
 * Updates notification badges on the sidebar navigation items.
 * @param {Array<object>} allNotifications - The combined list of all notifications.
 */
function updateSidebarBadges(allNotifications) {
    const vehicleNotifications = allNotifications.filter(n => n.type === 'vehicle').length;
    const formNotifications = allNotifications.filter(n => n.type === 'form').length;

    const updateBadge = (navItemId, count) => {
        const navItem = document.getElementById(navItemId);
        if (navItem) {
            const existingBadge = navItem.querySelector('.badge');
            if (existingBadge) existingBadge.remove();
            
            if (count > 0) {
                navItem.classList.add('d-flex', 'justify-content-between', 'align-items-center');
                navItem.insertAdjacentHTML('beforeend', `<span class="badge bg-danger rounded-pill">${count}</span>`);
            } else {
                navItem.classList.remove('d-flex', 'justify-content-between', 'align-items-center');
            }
        }
    };
    
    updateBadge('nav-vehicle-mgt', vehicleNotifications);
    if (currentUserRole === 'student') updateBadge('nav-forms', formNotifications);
    else if (currentUserRole === 'teacher') updateBadge('nav-teacher-forms', formNotifications);
}

/**
 * Manually toggles the notification dropdown visibility.
 * This provides a more robust solution than relying only on Bootstrap's data attributes.
 * @param {Event} event - The click event.
 */
window.toggleNotificationDropdown = (event) => {
    const menu = document.getElementById('notification-list');
    if (menu) {
        // This uses Bootstrap's built-in component instance to toggle
        const dropdown = new bootstrap.Dropdown(document.getElementById('notificationBell'));
        dropdown.toggle();
    }
    event.stopPropagation();
};


// Add a global click listener to hide the notification dropdown when clicking outside
window.addEventListener('click', function(event) {
    const notificationBell = document.getElementById('notificationBell');
    const notificationList = document.getElementById('notification-list');

    // If the bell or list doesn't exist, do nothing
    if (!notificationBell || !notificationList) {
        return;
    }

    // Check if the dropdown is open and the click is outside the bell button
    // The .contains check ensures that clicks inside the bell icon don't close the dropdown
    if (notificationList.classList.contains('show') && !notificationBell.contains(event.target)) {
        const dropdownInstance = bootstrap.Dropdown.getInstance(notificationBell);
        if (dropdownInstance) {
            dropdownInstance.hide();
        }
    }
});


/**
 * Renders the admin interface for managing vehicles and their documents.
 */
window.renderVehicleManagement = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) return;

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Vehicle Management</h1>
        <div class="row">
            <div class="col-lg-4">
                <div class="card shadow mb-4">
                    <div class="card-header py-3"><h6 id="vehicle-form-title" class="m-0 fw-bold text-primary">Add New Vehicle</h6></div>
                    <div class="card-body">
                        <form id="vehicle-form">
                            <div class="mb-3">
                                <label class="form-label">Registration Number</label>
                                <input id="vehicle-reg-no" class="form-control" placeholder="e.g., KL-55-AB-1234" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Vehicle Type</label>
                                <select id="vehicle-type" class="form-select">
                                    <option value="Bus">Bus</option>
                                    <option value="Van">Van</option>
                                    <option value="Cruiser">Cruiser</option>
                                    <option value="Jeep">Jeep</option>
                                    <option value="Car">Car</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Registration Date</label>
                                <input type="date" id="vehicle-reg-date" class="form-control">
                            </div>
                            <hr>
                            <h6 class="fw-bold mb-3">Document Expiry Dates</h6>
                            <div class="row g-3">
                                <div class="col-6"><label class="form-label">Tax</label><input type="date" id="vehicle-tax" class="form-control"></div>
                                <div class="col-6"><label class="form-label">Permit</label><input type="date" id="vehicle-permit" class="form-control"></div>
                                <div class="col-6"><label class="form-label">Insurance</label><input type="date" id="vehicle-insurance" class="form-control"></div>
                                <div class="col-6"><label class="form-label">Fitness</label><input type="date" id="vehicle-fitness" class="form-control"></div>
                                <div class="col-6"><label class="form-label">Pollution</label><input type="date" id="vehicle-pollution" class="form-control"></div>
                                <div class="col-6"><label class="form-label">GPS</label><input type="date" id="vehicle-gps" class="form-control"></div>
                            </div>
                            <div class="d-flex justify-content-end gap-2 mt-4">
                                <button type="button" id="cancel-vehicle-edit-btn" class="btn btn-secondary d-none">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Vehicle</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="card shadow mb-4">
                    <div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">Registered Vehicles</h6></div>
                    <div class="card-body" id="vehicles-list-container"></div>
                </div>
            </div>
        </div>
    `;

    renderVehiclesList();
    attachVehicleFormListeners();
};

/**
 * Renders the list of all registered vehicles with expiry highlighting.
 */
/**
 * A helper function to determine the highlighting class, status text, and priority
 * for a vehicle document based on its expiry date and importance.
 * @param {string} dateStr - The expiry date of the document.
 * @param {string} docKey - The key for the document type (e.g., 'taxExpiry').
 * @returns {object} An object containing className, statusText, and a numeric priority.
 */
function getExpiryDetails(dateStr, docKey) {
    // 1. Define the importance of each document
    const documentImportance = {
        critical: ['taxExpiry', 'fitnessExpiry', 'insuranceExpiry','pollutionExpiry','permitExpiry','gpsExpiry'],
        warning: ['permitExpiry', 'pollutionExpiry'],
        info: ['gpsExpiry']
    };

    if (!dateStr) return { className: '', statusText: 'Not set', priority: 0 };

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const expiryDate = new Date(dateStr);
    const thirtyDaysFromNow = new Date();
    thirtyDaysFromNow.setDate(today.getDate() + 30);

    const timeDiff = expiryDate.getTime() - today.getTime();
    const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24));

    let status = { className: '', statusText: `Expires on ${expiryDate.toLocaleDateString('en-GB')}`, priority: 0 };

    // 2. Determine status based on dates
    if (expiryDate < today) {
        status.statusText = `Expired ${Math.abs(daysRemaining)} days ago`;
        // Expired items get the highest priority
        if (documentImportance.critical.includes(docKey)) {
            status.className = 'bg-danger text-white';
            status.priority = 100;
        } else {
            status.className = 'table-danger';
            status.priority = 90;
        }
    } else if (expiryDate <= thirtyDaysFromNow) {
        status.statusText = `Expires in ${daysRemaining} days`;
        // Expiring items get medium priority
        if (documentImportance.critical.includes(docKey)) {
            status.className = 'bg-warning text-dark';
            status.priority = 80;
        } else {
            status.className = 'table-warning';
            status.priority = 70;
        }
    }

    return status;
}


/**
 * Renders the list of all registered vehicles with prioritized highlighting for rows and cells.
 */
function renderVehiclesList() {
    const container = document.getElementById('vehicles-list-container');
    if (!container) return;

    if (!vehicles || vehicles.length === 0) {
        container.innerHTML = '<p class="text-muted">No vehicles have been registered.</p>';
        return;
    }

    const formatDate = (dateStr) => dateStr ? new Date(dateStr).toLocaleDateString('en-GB') : 'N/A';

    let tableHTML = `
        <div class="table-responsive">
            <table class="table table-bordered table-sm" style="font-size: 0.85rem;">
                <thead class="table-light">
                    <tr>
                        <th>Reg. No</th><th>Type</th><th>Tax</th><th>Insurance</th><th>Fitness</th><th>Permit</th><th>Pollution</th><th>GPS</th><th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;

    vehicles.forEach(v => {
        const docKeys = ['taxExpiry', 'insuranceExpiry', 'fitnessExpiry', 'permitExpiry', 'pollutionExpiry', 'gpsExpiry'];
        
        // 1. Determine the highest priority issue for the entire row
        let rowHighlightPriority = 0;
        let rowHighlightClass = '';

        docKeys.forEach(key => {
            const details = getExpiryDetails(v[key], key);
            if (details.priority > rowHighlightPriority) {
                rowHighlightPriority = details.priority;
                // Use a lighter version for the row highlight
                if (details.className.includes('danger')) rowHighlightClass = 'table-danger';
                else if (details.className.includes('warning')) rowHighlightClass = 'table-warning';
            }
        });

        tableHTML += `<tr class="${rowHighlightClass}">
                        <td class="fw-bold">${v.id}</td>
                        <td>${v.type}</td>`;

        // 2. Generate each cell with its specific highlight and tooltip
        docKeys.forEach(key => {
            const details = getExpiryDetails(v[key], key);
            tableHTML += `<td class="${details.className}" title="${details.statusText}">${formatDate(v[key])}</td>`;
        });
        
        tableHTML += `<td>
                        <button class="btn btn-sm btn-outline-primary py-0 px-1" onclick="window.editVehicle('${v.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="window.handleDelete('vehicles', '${v.id}')"><i class="fas fa-trash"></i></button>
                      </td>
                    </tr>`;
    });

    tableHTML += '</tbody></table></div>';
    container.innerHTML = tableHTML;
}
/**
 * Attaches listeners to the vehicle form for saving and editing.
 */
function attachVehicleFormListeners() {
    const form = document.getElementById('vehicle-form');
    const regNoInput = document.getElementById('vehicle-reg-no');
    const cancelBtn = document.getElementById('cancel-vehicle-edit-btn');
    const formTitle = document.getElementById('vehicle-form-title');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const regNo = regNoInput.value.toUpperCase().replace(/\s+/g, '');
        if (!regNo) {
            showAlert('Registration Number is required.', 'danger');
            return;
        }

        const vehicleData = {
            id: regNo,
            type: document.getElementById('vehicle-type').value,
            regDate: document.getElementById('vehicle-reg-date').value,
            taxExpiry: document.getElementById('vehicle-tax').value,
            permitExpiry: document.getElementById('vehicle-permit').value,
            insuranceExpiry: document.getElementById('vehicle-insurance').value,
            fitnessExpiry: document.getElementById('vehicle-fitness').value,
            pollutionExpiry: document.getElementById('vehicle-pollution').value,
            gpsExpiry: document.getElementById('vehicle-gps').value,
        };

        try {
            await setDoc(getDocRef('vehicles', regNo), vehicleData);
            showAlert(`Vehicle '${regNo}' saved successfully.`, 'success');
            form.reset();
            regNoInput.readOnly = false;
            cancelBtn.classList.add('d-none');
            formTitle.textContent = 'Add New Vehicle';
        } catch (error) {
            console.error("Error saving vehicle:", error);
            showAlert('Failed to save vehicle data.', 'danger');
        }
    });

    cancelBtn.addEventListener('click', () => {
        form.reset();
        regNoInput.readOnly = false;
        cancelBtn.classList.add('d-none');
        formTitle.textContent = 'Add New Vehicle';
    });
}

/**
 * Populates the form with data for editing a vehicle.
 * @param {string} regNo - The registration number of the vehicle to edit.
 */
window.editVehicle = (regNo) => {
    const vehicle = vehicles.find(v => v.id === regNo);
    if (!vehicle) return;

    document.getElementById('vehicle-form-title').textContent = `Edit Vehicle: ${regNo}`;
    document.getElementById('vehicle-reg-no').value = vehicle.id;
    document.getElementById('vehicle-reg-no').readOnly = true;
    document.getElementById('vehicle-type').value = vehicle.type;
    document.getElementById('vehicle-reg-date').value = vehicle.regDate;
    document.getElementById('vehicle-tax').value = vehicle.taxExpiry;
    document.getElementById('vehicle-permit').value = vehicle.permitExpiry;
    document.getElementById('vehicle-insurance').value = vehicle.insuranceExpiry;
    document.getElementById('vehicle-fitness').value = vehicle.fitnessExpiry;
    document.getElementById('vehicle-pollution').value = vehicle.pollutionExpiry;
    document.getElementById('vehicle-gps').value = vehicle.gpsExpiry;

    document.getElementById('cancel-vehicle-edit-btn').classList.remove('d-none');
};



function checkVehicleExpiriesAndNotify() { /// not part of the notifications
    const notificationList = document.getElementById('notification-list');
    const notificationBadge = document.getElementById('notification-badge');
    if (!notificationList || !notificationBadge) return;

    const notifications = [];
    const today = new Date();
    const thirtyDaysFromNow = new Date();
    thirtyDaysFromNow.setDate(today.getDate() + 30);

    vehicles.forEach(vehicle => {
        const checkExpiry = (dateStr, docName) => {
            if (!dateStr) return;
            const expiryDate = new Date(dateStr);
            if (expiryDate <= thirtyDaysFromNow) {
                const timeDiff = expiryDate.getTime() - today.getTime();
                const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24));
                notifications.push({
                    vehicleReg: vehicle.id,
                    docName: docName,
                    daysRemaining: daysRemaining,
                    expiryDate: expiryDate.toLocaleDateString('en-GB')
                });
            }
        };

        checkExpiry(vehicle.taxExpiry, 'Tax');
        checkExpiry(vehicle.permitExpiry, 'Permit');
        checkExpiry(vehicle.insuranceExpiry, 'Insurance');
        checkExpiry(vehicle.fitnessExpiry, 'Fitness');
        checkExpiry(vehicle.pollutionExpiry, 'Pollution');
        checkExpiry(vehicle.gpsExpiry, 'GPS');
    });

    renderNotifications(notifications);
}

function getLibraryDueNotifications() {
    if (currentUserRole !== 'student' || !selectedUser) return [];
    const notifications = [];
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const twoDaysFromNow = new Date();
    twoDaysFromNow.setDate(today.getDate() + 2);

    const myIssuedBooks = bookIssuances.filter(item =>
        item.studentId === selectedUser.id && item.status === 'Issued'
    );

    myIssuedBooks.forEach(book => {
        const dueDate = new Date(book.dueDate);
        if (dueDate <= twoDaysFromNow) {
            const timeDiff = dueDate.getTime() - today.getTime();
            const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            notifications.push({
                type: 'library',
                id: `library_${book.id}`,
                title: `Return Book: ${book.bookTitle}`,
                text: daysRemaining < 0 ? `Overdue by ${Math.abs(daysRemaining)} day(s).` : `Due in ${daysRemaining} day(s).`,
                targetView: 'my-library'
            });
        }
    });
    return notifications;
}
// ===================================================================================
// --- ðŸ“š LIBRARY MANAGEMENT MODULE ---
// This file contains all the JavaScript functions for the Library Management Module,
// including Issue/Return, Book Inventory, Class Allotment, and Reporting.
//
// Assumed Global Variables:
// - `db`: Firestore database instance.
// - `mainContent`: The main DOM element to render content into.
// - `currentUserRole`: String representing the role of the logged-in user (e.g., 'admin').
// - `selectedUser`: Object containing details of the logged-in user.
// - `classes`: Array of class objects.
// - `students`: Array of student objects.
// - `books`: Array of book objects.
// - `bookIssuances`: Array of book issuance records.
// - `showAlert`: A global function to display alerts to the user.
// - `getDocRef`, `setDoc`, `updateDoc`, `writeBatch`, etc.: Firestore helper functions.
// ===================================================================================

let bookToEdit = null;
// ===================================================================================
// --- MODULE INITIALIZATION ---
// ===================================================================================

/**
 * Main renderer for the entire Library Management interface.
 * It performs an access check and sets up the navigation tabs.
 */
window.renderLibraryManagement = () => {
    // Access check: Allow only for Admins or teachers with the 'librarian' role.
    const hasAccess = currentUserRole === 'admin' || (currentUserRole === 'teacher' && selectedUser.roles?.includes('librarian'));

    if (!hasAccess) {
        mainContent.innerHTML = `
            <div class="alert alert-danger">
                <h4>Access Denied</h4>
                <p>You do not have permission to access this module.</p>
            </div>`;
        return;
    }

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Library Management</h1>
        <ul class="nav nav-tabs" id="libraryTab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#issue-return" type="button">Issue / Return</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#book-allotment" type="button">Allot to Class</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#inventory" type="button">Book Inventory</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#reports" type="button">Reports</button></li>
        </ul>
        <div class="tab-content card" id="libraryTabContent">
            <div class="tab-pane fade show active p-4" id="issue-return" role="tabpanel"></div>
            <div class="tab-pane fade p-4" id="book-allotment" role="tabpanel"></div>
            <div class="tab-pane fade p-4" id="inventory" role="tabpanel"></div>
            <div class="tab-pane fade p-4" id="reports" role="tabpanel"></div>
        </div>
    `;

    // Render the content for each tab
    renderIssueReturnTab();
    renderBookAllotmentModule();
    renderInventoryTab();
    renderLibraryReportsTab();
};

// ===================================================================================
// --- ðŸ“š BOOK ALLOTMENT TO CLASS MODULE ---
// ===================================================================================

/**
 * Renders the primary UI for the "Allot Books to Class" tab.
 */
function renderBookAllotmentModule() {
    const container = document.getElementById('book-allotment');
    if (!container) return;

    const classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

    container.innerHTML = `
        <div class="row g-4">
            <div class="col-lg-7" id="allotment-entry-container">
                <div class="ui-card h-100">
                    <h5 class="section-header">Allot Books to a Class</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Select Class</label>
                            <select id="allot-class-select" class="form-select"><option value="">-- Select --</option>${classOptions}</select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Select Division</label>
                            <select id="allot-division-select" class="form-select" disabled><option>-- Select Class --</option></select>
                        </div>
                    </div>
                    <hr>
                    <div id="book-allotment-table-container">
                         <p class="text-muted text-center p-4">Please select a class and division.</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-5">
                <div id="class-allotment-list-container" class="ui-card h-100">
                   <p class="text-muted text-center p-4">Select a class and division to view allotments.</p>
                </div>
            </div>
        </div>
    `;

    // Attach event listeners for class and division dropdowns
    const classSelect = document.getElementById('allot-class-select');
    const divisionSelect = document.getElementById('allot-division-select');

    classSelect.addEventListener('change', () => {
        const classId = classSelect.value;
        const classData = classes.find(c => c.id === classId);

        divisionSelect.innerHTML = '<option value="">-- Select --</option>'; // Reset
        if (classData) {
            classData.divisions.forEach(d => divisionSelect.innerHTML += `<option value="${d}">${d}</option>`);
            divisionSelect.disabled = false;
        } else {
            divisionSelect.disabled = true;
        }
        // Trigger change to update the table and list
        divisionSelect.dispatchEvent(new Event('change'));
    });

    divisionSelect.addEventListener('change', () => {
        const classId = classSelect.value;
        const division = divisionSelect.value;
        displayAllotmentTable(classId, division);
        displayClassAllotments(classId, division);
    });
}

/**
 * Renders the table for adding books to a class allotment.
 * @param {string} classId - The ID of the selected class.
 * @param {string} division - The selected division.
 */
function displayAllotmentTable(classId, division) {
    const container = document.getElementById('book-allotment-table-container');
    if (!classId || !division) {
        container.innerHTML = '<p class="text-muted text-center p-4">Please select a class and division.</p>';
        return;
    }

    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-sm" id="allotment-entry-table">
                <thead>
                    <tr>
                        <th style="width: 25%;">Book ID</th>
                        <th>Book Title</th>
                        <th style="width: 15%;">Quantity</th>
                        <th style="width: 5%;"></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="mt-2">
            <button id="add-allotment-row-btn" class="btn btn-sm btn-outline-primary"><i class="fas fa-plus me-1"></i>Add Row</button>
        </div>
        <hr>
        <div class="d-grid">
            <button id="save-allotment-btn" class="btn btn-success">Save Allotment to Class</button>
        </div>
    `;

    const tableBody = container.querySelector('#allotment-entry-table tbody');

    const addRow = () => {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td><input type="text" class="form-control form-control-sm book-id-input" placeholder="Enter Book ID..."></td>
            <td class="book-title-cell text-muted">...</td>
            <td><input type="number" class="form-control form-control-sm" value="1" min="1"></td>
            <td><button class="btn btn-xs btn-outline-danger remove-allotment-row-btn">&times;</button></td>
        `;
        tableBody.appendChild(newRow);
        newRow.querySelector('.book-id-input').focus();
    };

    addRow(); // Add the first row automatically

    // Use event delegation for dynamic rows
    container.addEventListener('input', e => {
        if (e.target.classList.contains('book-id-input')) {
            const currentRow = e.target.closest('tr');
            const bookId = e.target.value.trim().toUpperCase();
            const titleCell = currentRow.querySelector('.book-title-cell');
            const qtyInput = currentRow.querySelector('input[type="number"]');

            // Reset row state
            titleCell.textContent = '...';
            titleCell.className = 'book-title-cell text-muted';
            delete currentRow.dataset.bookId;

            if (!bookId) return;

            // Duplicate check
            const isDuplicate = Array.from(tableBody.querySelectorAll('tr'))
                .some(row => row !== currentRow && row.dataset.bookId === bookId);

            if (isDuplicate) {
                titleCell.textContent = 'Book already in list!';
                titleCell.classList.replace('text-muted', 'text-danger');
                e.target.value = '';
                return;
            }

            const book = books.find(b => b.id === bookId);
            if (book) {
                titleCell.textContent = book.title;
                titleCell.classList.remove('text-muted');
                qtyInput.max = book.availableCopies;
                currentRow.dataset.bookId = book.id;
            } else {
                titleCell.textContent = 'Book not found!';
                titleCell.classList.replace('text-muted', 'text-danger');
            }
        }
    });

    container.addEventListener('click', e => {
        if (e.target.id === 'add-allotment-row-btn') {
            addRow();
        }
        if (e.target.classList.contains('remove-allotment-row-btn')) {
            e.target.closest('tr').remove();
        }
        if (e.target.id === 'save-allotment-btn') {
            const validRows = Array.from(tableBody.querySelectorAll('tr')).filter(row => row.dataset.bookId);
            if (validRows.length === 0) {
                return showAlert('No valid books to allot.', 'info');
            }
            const allotmentData = validRows.map(row => ({
                bookId: row.dataset.bookId,
                quantity: parseInt(row.querySelector('input[type="number"]').value, 10)
            }));
            saveClassAllotment(classId, division, allotmentData);
        }
    });
}

/**
 * Displays the list of books already allotted to the selected class division.
 * @param {string} classId - The ID of the selected class.
 * @param {string} division - The selected division.
 */
function displayClassAllotments(classId, division) {
    const container = document.getElementById('class-allotment-list-container');
    if (!classId || !division) {
        container.innerHTML = '<p class="text-muted text-center p-4">Select a class and division to view allotments.</p>';
        return;
    }

    const allottedBooks = books.filter(b => b.allottedClassId === classId && b.allottedDivision === division);
    const className = classes.find(c => c.id === classId)?.name || classId;

    // --- UPDATED HEADER ---
    // Now includes a button group for CSV and PDF downloads.
    const header = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="section-header mb-0">Allotments for ${className} - ${division}</h5>
            ${allottedBooks.length > 0 ? `
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-success" onclick="downloadAllotmentCSV('${classId}', '${division}')">
                    <i class="fas fa-file-csv me-1"></i>CSV
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="downloadAllotmentPDF('${classId}', '${division}')">
                    <i class="fas fa-file-pdf me-1"></i>PDF
                </button>
            </div>` : ''}
        </div>`;

    if (allottedBooks.length === 0) {
        container.innerHTML = header + '<p class="text-muted text-center p-4">No books have been allotted to this class yet.</p>';
        return;
    }

    container.innerHTML = `
        ${header}
        <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
            ${allottedBooks.map(book => {
                const isIssued = bookIssuances.some(i => i.bookId === book.id && i.status === 'Issued');
                const buttonHtml = isIssued ?
                    '<span class="badge bg-warning">Issued</span>' :
                    `<button class="btn btn-xs btn-outline-secondary" onclick="returnBookToLibrary('${book.id}', '${classId}', '${division}')">Return to Library</button>`;
                return `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${book.title} (ID: ${book.id})</span>
                        ${buttonHtml}
                    </div>`;
            }).join('')}
        </div>
    `;
}
/**
 * Generates and downloads a CSV file for books allotted to a specific class.
 * @param {string} classId The ID of the class.
 * @param {string} division The division of the class.
 */
window.downloadAllotmentCSV = (classId, division) => {
    const allottedBooks = books.filter(b => b.allottedClassId === classId && b.allottedDivision === division);
    if (allottedBooks.length === 0) {
        return showAlert('No data to export.', 'info');
    }

    const headers = ['Book ID', 'Title', 'Author', 'Status'];
    const rows = allottedBooks.map(book => {
        const status = bookIssuances.some(i => i.bookId === book.id && i.status === 'Issued') ? 'Issued' : 'In Class Library';
        const rowData = [book.id, book.title, book.author, status];
        // Escape commas and quotes for CSV format
        return rowData.map(val => `"${String(val).replace(/"/g, '""')}"`).join(',');
    });

    const csvContent = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `allotment_${classId}-${division}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

/**
 * Generates and downloads a PDF file for books allotted to a specific class.
 * REQUIRES jsPDF and jsPDF-AutoTable libraries to be included in the project.
 * @param {string} classId The ID of the class.
 * @param {string} division The division of the class.
 */
window.downloadAllotmentPDF = (classId, division) => {
    const allottedBooks = books.filter(b => b.allottedClassId === classId && b.allottedDivision === division);
    if (allottedBooks.length === 0) {
        return showAlert('No data to export.', 'info');
    }

    // Ensure the jspdf library is loaded
    if (typeof window.jspdf === 'undefined') {
        return showAlert('PDF generation library is not loaded.', 'danger');
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const className = classes.find(c => c.id === classId)?.name || classId;

    // Document Header
    doc.setFontSize(18);
    doc.text(`Allotted Books for ${className} - ${division}`, 14, 22);
    doc.setFontSize(11);
    doc.setTextColor(100);
    doc.text(`Report generated on: ${new Date().toLocaleDateString()}`, 14, 29);

    // Table Data
    const tableHead = [['Book ID', 'Title', 'Author', 'Status']];
    const tableBody = allottedBooks.map(book => {
        const status = bookIssuances.some(i => i.bookId === book.id && i.status === 'Issued') ? 'Issued' : 'In Class Library';
        return [book.id, book.title, book.author, status];
    });

    // Generate Table
    doc.autoTable({
        startY: 35,
        head: tableHead,
        body: tableBody,
        theme: 'striped',
        headStyles: { fillColor: [22, 160, 133] } // A nice teal color
    });

    // Save the PDF
    doc.save(`allotment_${classId}-${division}.pdf`);
};

/**
 * Saves the class allotment data to Firestore and updates book documents.
 * @param {string} classId - The ID of the class receiving the allotment.
 * @param {string} division - The division receiving the allotment.
 * @param {Array<object>} allotmentItems - An array of objects with { bookId, quantity }.
 */
async function saveClassAllotment(classId, division, allotmentItems) {
    const batch = writeBatch(db);
    const className = classes.find(c => c.id === classId)?.name || classId;

    // Process each book in the allotment
    for (const item of allotmentItems) {
        const book = books.find(b => b.id === item.bookId);
        if (book && item.quantity > 0 && item.quantity <= book.availableCopies) {
            const bookRef = getDocRef('books', item.bookId);
            const newAvailableCount = book.availableCopies - item.quantity;

            batch.update(bookRef, {
                availableCopies: newAvailableCount,
                allottedClassId: classId,
                allottedDivision: division
            });
        }
    }

    try {
        await batch.commit();
        showAlert(`Successfully allotted books to ${className} - ${division}.`, 'success');
        // Refresh the UI to show the new state
        displayAllotmentTable(classId, division);
        displayClassAllotments(classId, division);
    } catch (error) {
        console.error("Error saving allotment:", error);
        showAlert('Failed to save the allotment. Please check quantities and try again.', 'danger');
    }
}

/**
 * Returns a single allotted book back to the main library, making it available for general issuance.
 * @param {string} bookId - The ID of the book to return.
 * @param {string} classId - The current class ID for UI refresh.
 * @param {string} division - The current division for UI refresh.
 */
window.returnBookToLibrary = async function(bookId, classId, division) {
    if (!confirm("Are you sure you want to return this book to the main library?")) return;

    const bookRef = getDocRef('books', bookId);
    const book = books.find(b => b.id === bookId);
    if (!book) {
        return showAlert("Book not found.", "danger");
    }

    // This logic assumes the entire stock of a book title is allotted to one class.
    // The number of copies to make available again is the difference between total and available.
    const copiesToReturn = book.totalCopies - book.availableCopies;

    try {
        await updateDoc(bookRef, {
            allottedClassId: null,
            allottedDivision: null,
            availableCopies: book.availableCopies + copiesToReturn // Restore available copies
        });
        showAlert("Book returned to main library.", "success");
        // Refresh the allotment list
        displayClassAllotments(classId, division);
    } catch (error) {
        console.error("Error returning book to library:", error);
        showAlert("Failed to return book.", "danger");
    }
}

// ===================================================================================
// --- ðŸ“š BOOK INVENTORY MODULE ---
// ===================================================================================

/**
 * Renders the Book Inventory tab, including the add/edit form and the book list.
 */
function renderInventoryTab() {
    const container = document.getElementById('inventory');
    if (!container) return;

    const isEditMode = bookToEdit !== null;
    const classOptions = classes.map(c => `<option value="${c.id}" ${bookToEdit?.allottedClassId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');

    container.innerHTML = `
        <div class="row">
            <div class="col-lg-5">
                <form id="book-form" class="card p-3">
                    <h5 class="fw-bold mb-3">${isEditMode ? `Edit Book: ${bookToEdit.title}` : 'Add New Book'}</h5>
                    <div class="mb-3">
                        <label class="form-label">Book ID (Unique for each copy)</label>
                        <input type="text" id="book-id" class="form-control" value="${bookToEdit?.id || ''}" ${isEditMode ? 'readonly' : ''} placeholder="e.g., HB-SC-01">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" id="book-title" class="form-control" value="${bookToEdit?.title || ''}">
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6"><label class="form-label">Author</label><input type="text" id="book-author" class="form-control" value="${bookToEdit?.author || ''}"></div>
                        <div class="col-md-6"><label class="form-label">Publisher</label><input type="text" id="book-publisher" class="form-control" value="${bookToEdit?.publisher || ''}"></div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6"><label class="form-label">Genre</label><input type="text" id="book-genre" class="form-control" value="${bookToEdit?.genre || ''}"></div>
                         <div class="col-md-6"><label class="form-label">Publish Year</label><input type="number" id="book-publishYear" class="form-control" value="${bookToEdit?.publishYear || ''}"></div>
                    </div>
                    <hr>
                    <h6 class="text-muted">Assignment</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Assign to</label>
                            <select id="allot-class-select" class="form-select">
                                <option value="">-- Main Library --</option>
                                ${classOptions}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Division</label>
                            <select id="allot-division-select" class="form-select" ${!isEditMode || !bookToEdit.allottedClassId ? 'disabled' : ''}></select>
                        </div>
                    </div>
                    <div class="text-end mt-4">
                        ${isEditMode ? `<button type="button" class="btn btn-secondary me-2" onclick="clearBookEdit()">Cancel</button>`: ''}
                        <button type="submit" class="btn btn-primary">${isEditMode ? 'Update Book' : 'Add Book'}</button>
                    </div>
                </form>
            </div>
            <div class="col-lg-7" id="book-inventory-list-container"></div>
        </div>
    `;
    renderBookInventoryList();
    attachInventoryFormListeners();
}

/**
 * Attaches event listeners to the book inventory form.
 */
function attachInventoryFormListeners() {
    const form = document.getElementById('book-form');
    const classSelect = document.getElementById('allot-class-select');
    const divisionSelect = document.getElementById('allot-division-select');

    // Function to populate division dropdown
    const updateDivisions = () => {
        const classId = classSelect.value;
        divisionSelect.innerHTML = '';
        const classData = classes.find(c => c.id === classId);
        if (classData) {
            classData.divisions.forEach(d => divisionSelect.innerHTML += `<option value="${d}">${d}</option>`);
            divisionSelect.disabled = false;
        } else {
            divisionSelect.disabled = true;
        }
    };

    classSelect.addEventListener('change', updateDivisions);

    // If editing a book, pre-populate the division dropdown
    if (bookToEdit && bookToEdit.allottedClassId) {
        updateDivisions();
        divisionSelect.value = bookToEdit.allottedDivision;
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('book-id').value.trim().toUpperCase();
        if (!id) return showAlert('Book ID is required', 'danger');

        const isIssued = bookToEdit && bookToEdit.status === 'Issued';
        if (isIssued && bookToEdit.allottedClassId !== classSelect.value) {
            return showAlert('Cannot change the assignment of a book that is currently issued.', 'danger');
        }

        const bookData = {
            id,
            title: document.getElementById('book-title').value.trim(),
            author: document.getElementById('book-author').value.trim(),
            publisher: document.getElementById('book-publisher').value.trim(),
            genre: document.getElementById('book-genre').value.trim(),
            publishYear: parseInt(document.getElementById('book-publishYear').value, 10) || null,
            allottedClassId: classSelect.value || null,
            allottedDivision: classSelect.value ? divisionSelect.value : null,
            status: bookToEdit?.status || 'Available' // Preserve status on edit, default to 'Available' on add
        };

        await setDoc(getDocRef('books', id), bookData, { merge: true });
        showAlert(`Book '${bookData.title}' saved successfully!`, 'success');
        clearBookEdit();
    });
}

/**
 * Renders the filterable list of all books in the inventory.
 */
function renderBookInventoryList() {
    const container = document.getElementById('book-inventory-list-container');
    if (!container) return;

    container.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">All Books</h5>
            <button class="btn btn-sm btn-success" onclick="downloadBookInventoryCSV()">
                <i class="fas fa-file-csv me-1"></i> Download CSV
            </button>
        </div>
        <div class="mb-3">
            <input type="text" id="book-search-input" class="form-control" placeholder="Search by ID, title, author...">
        </div>
        <div id="book-list-table-container" class="table-responsive"></div>
    `;

    document.getElementById('book-search-input').addEventListener('input', applyBookFiltersAndRender);
    applyBookFiltersAndRender();
}

/**
 * Applies search filters and renders the final book list table.
 */
function applyBookFiltersAndRender() {
    const tableContainer = document.getElementById('book-list-table-container');
    const searchTerm = document.getElementById('book-search-input')?.value.toLowerCase() || '';

    const filteredBooks = books.filter(book => {
        if (!searchTerm) return true;
        return (
            book.id.toLowerCase().includes(searchTerm) ||
            book.title.toLowerCase().includes(searchTerm) ||
            book.author.toLowerCase().includes(searchTerm)
        );
    });

    if (filteredBooks.length === 0) {
        tableContainer.innerHTML = `<p class="text-muted text-center p-4">No books match your search.</p>`;
        return;
    }

    tableContainer.innerHTML = `
        <table class="table table-striped table-sm" id="book-inventory-table">
            <thead><tr><th>ID</th><th>Title</th><th>Author</th><th>Assignment</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody>
                ${filteredBooks.map(b => {
                    let assignment = 'Main Library';
                    if (b.allottedClassId) {
                        const className = classes.find(c => c.id === b.allottedClassId)?.name || 'N/A';
                        assignment = `${className} - ${b.allottedDivision}`;
                    }

                    let statusBadge;
                    switch (b.status) {
                        case 'Issued':
                            statusBadge = '<span class="badge bg-warning">Issued</span>';
                            break;
                        case 'Available':
                            statusBadge = '<span class="badge bg-success">Available</span>';
                            break;
                        default:
                            statusBadge = `<span class="badge bg-secondary">${b.status || 'Unknown'}</span>`;
                    }

                    return `
                        <tr>
                            <td>${b.id}</td>
                            <td>${b.title}</td>
                            <td>${b.author}</td>
                            <td>${assignment}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary py-0 px-1" onclick="editBook('${b.id}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="handleDelete('books', '${b.id}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                }).join('')}
            </tbody>
        </table>`;
}


/**
 * Sets the form to edit a specific book.
 * @param {string} bookId - The ID of the book to edit.
 */
window.editBook = (bookId) => {
    bookToEdit = books.find(b => b.id === bookId);
    if (bookToEdit) {
        renderInventoryTab();
    }
};

/**
 * Clears the book edit state and re-renders the inventory form for adding a new book.
 */
window.clearBookEdit = () => {
    bookToEdit = null;
    renderInventoryTab();
};

/**
 * Downloads the currently visible book inventory data as a CSV file.
 */
window.downloadBookInventoryCSV = function() {
    const table = document.getElementById('book-inventory-table');
    if (!table) return showAlert('No data to download.', 'warning');

    const headers = Array.from(table.querySelectorAll('thead th'))
        .filter(th => th.textContent !== 'Actions') // Exclude actions column
        .map(th => `"${th.textContent}"`).join(',');

    const rows = Array.from(table.querySelectorAll('tbody tr')).map(row => {
        return Array.from(row.querySelectorAll('td'))
            .slice(0, -1) // Exclude actions cell
            .map(td => `"${td.textContent.replace(/"/g, '""')}"`).join(',');
    });

    const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].join('\r\n');
    const link = document.createElement('a');
    link.setAttribute('href', encodeURI(csvContent));
    link.setAttribute('download', 'book_inventory.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};


// ===================================================================================
// --- ðŸ“š ISSUE / RETURN MODULE ---
// ===================================================================================

/**
 * Renders the Issue/Return tab UI.
 */
function renderIssueReturnTab() {
    const container = document.getElementById('issue-return');
    const studentOptions = students.map(s => `<option value="${s.id}">${s.name} (${s.admissionNumber})</option>`).join('');
    const bookOptions = books.filter(b => b.availableCopies > 0 && !b.allottedClassId)
        .map(b => `<option value="${b.id}">${b.title} by ${b.author}</option>`).join('');

    container.innerHTML = `
        <div class="row">
            <div class="col-md-6 border-end">
                <h5 class="fw-bold mb-3">Issue a Book</h5>
                <div class="mb-3">
                    <label class="form-label">Search Student</label>
                    <input type="text" id="issue-student-search" class="form-control" list="student-list-options" placeholder="Type to search by ID or Name...">
                    <datalist id="student-list-options">${studentOptions}</datalist>
                </div>
                <div id="issue-student-info" class="p-3 bg-light rounded mb-3" style="min-height: 80px;">Select a student...</div>
                <div class="mb-3">
                    <label class="form-label">Search Book (Only un-allotted books shown)</label>
                    <input type="text" id="issue-book-search" class="form-control" list="book-list-options" placeholder="Type to search by ID or Title...">
                    <datalist id="book-list-options">${bookOptions}</datalist>
                </div>
                <div id="issue-book-info" class="p-3 bg-light rounded mb-3" style="min-height: 80px;">Select a book...</div>
                <div class="text-end">
                    <button id="issue-book-btn" class="btn btn-primary" disabled>Issue Book</button>
                </div>
            </div>
            <div class="col-md-6">
                <h5 class="fw-bold mb-3">Process a Return</h5>
                <div id="return-books-list"><p class="text-muted">Search for a student to see their issued books.</p></div>
            </div>
        </div>
    `;
    attachIssueReturnListeners();
}

/**
 * Attaches event listeners for the issue/return functionality.
 * This version ensures a book's status is 'Available' and prevents duplicate title issuance.
 */
function attachIssueReturnListeners() {
    const studentSearch = document.getElementById('issue-student-search');
    const bookSearch = document.getElementById('issue-book-search');
    const studentInfo = document.getElementById('issue-student-info');
    const bookInfo = document.getElementById('issue-book-info');
    const issueBtn = document.getElementById('issue-book-btn');
    const returnList = document.getElementById('return-books-list');

    let selectedStudent = null;
    let selectedBook = null;

    /**
     * Validates all conditions before enabling the 'Issue Book' button.
     */
    const validateIssue = () => {
        // Reset state and disable button by default
        issueBtn.disabled = true;
        bookInfo.innerHTML = `<strong>Title:</strong> ${selectedBook?.title || '...'}<br><strong>ID:</strong> ${selectedBook?.id || '...'}`;
        studentInfo.innerHTML = `<strong>Name:</strong> ${selectedStudent?.name || '...'}<br><strong>Class:</strong> ${selectedStudent ? getStudentClassName(selectedStudent.classId, selectedStudent.division) : '...'}`;

        if (!selectedStudent || !selectedBook) return;

        // --- VALIDATION CHECKS ---

        // 1. Check if the book's status is 'Available'.
        if (selectedBook.status !== 'Available') {
            bookInfo.innerHTML += `<p class="text-danger small mt-1 mb-0">This book is not available (Status: ${selectedBook.status}).</p>`;
            return;
        }
        
        const currentlyIssued = bookIssuances.filter(i => i.studentId === selectedStudent.id && i.status === 'Issued');

        // 2. NEW: Check if the student already has this book title issued.
        const hasTitleAlready = currentlyIssued.some(issuedBook => issuedBook.bookTitle === selectedBook.title);
        if (hasTitleAlready) {
            bookInfo.innerHTML += '<p class="text-danger small mt-1 mb-0">Student already has this title issued.</p>';
            return;
        }

        // 3. Check if the student has reached the overall borrow limit.
        if (currentlyIssued.length >= 2) {
            studentInfo.innerHTML += '<p class="text-danger small mt-1 mb-0">Student has reached the borrow limit (2 books).</p>';
            return;
        }

        // 4. Check if a class-allotted book is being issued to a student from the correct class.
        if (selectedBook.allottedClassId && (selectedBook.allottedClassId !== selectedStudent.classId || selectedBook.allottedDivision !== selectedStudent.division)) {
            const className = classes.find(c => c.id === selectedBook.allottedClassId)?.name || 'N/A';
            bookInfo.innerHTML += `<p class="text-warning small mt-1 mb-0">This book is assigned to ${className} - ${selectedBook.allottedDivision} and cannot be issued to this student.</p>`;
            return;
        }

        // If all checks pass, enable the button
        issueBtn.disabled = false;
    };

    studentSearch.addEventListener('input', () => {
        selectedStudent = students.find(s => s.id === studentSearch.value);
        if (selectedStudent) {
            const studentBooks = bookIssuances.filter(i => i.studentId === selectedStudent.id && i.status === 'Issued');
            returnList.innerHTML = studentBooks.length === 0 ? '<p class="text-muted">Student has no issued books.</p>' :
                `<ul class="list-group">${studentBooks.map(b => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>${b.bookTitle} (${b.bookId})<br><small>Due: ${new Date(b.dueDate).toLocaleDateString()}</small></div>
                        <button class="btn btn-sm btn-success" onclick="returnBook('${b.id}')">Return</button>
                    </li>`).join('')}
                </ul>`;
        } else {
            returnList.innerHTML = '<p class="text-muted">Search for a student to see their issued books.</p>';
        }
        validateIssue();
    });

    bookSearch.addEventListener('input', () => {
        selectedBook = books.find(b => b.id === bookSearch.value);
        validateIssue();
    });

    issueBtn.addEventListener('click', async () => {
        if (!selectedStudent || !selectedBook || issueBtn.disabled) return;

        const today = new Date();
        const dueDate = new Date();
        dueDate.setDate(today.getDate() + 15); // Due in 15 days

        const issuanceData = {
            bookId: selectedBook.id,
            bookTitle: selectedBook.title,
            studentId: selectedStudent.id,
            studentName: selectedStudent.name,
            issueDate: today.toISOString().slice(0, 10),
            dueDate: dueDate.toISOString().slice(0, 10),
            status: 'Issued',
            issuedByUserId: selectedUser.id,
            issuedByUserName: selectedUser.name,
        };

        const bookRef = getDocRef('books', selectedBook.id);
        const issuanceRef = doc(collection(db, `/artifacts/${appId}/public/data/bookIssuances`));
        const batch = writeBatch(db);

        batch.set(issuanceRef, issuanceData);
        batch.update(bookRef, { status: 'Issued' });
        await batch.commit();

        showAlert('Book issued successfully!', 'success');
        studentSearch.value = '';
        bookSearch.value = '';
        studentSearch.dispatchEvent(new Event('input')); // Trigger update to clear everything
    });
}

/**
 * Processes the return of a book.
 * @param {string} issuanceId - The ID of the bookIssuances document.
 */
window.returnBook = async (issuanceId) => {
    const issuance = bookIssuances.find(i => i.id === issuanceId);
    if (!issuance) return;

    const book = books.find(b => b.id === issuance.bookId);
    if (!book) return showAlert('Cannot process return: original book not found.', 'danger');

    const issuanceRef = getDocRef('bookIssuances', issuanceId);
    const bookRef = getDocRef('books', issuance.bookId);
    const batch = writeBatch(db);

    const returnData = {
        status: 'Returned',
        returnDate: new Date().toISOString().slice(0, 10),
        returnedByUserId: selectedUser.id,
        returnedByUserName: selectedUser.name
    };

    batch.update(issuanceRef, returnData);
    batch.update(bookRef, { availableCopies: book.availableCopies + 1 });
    await batch.commit();

    showAlert('Book returned successfully!', 'success');
    document.getElementById('issue-student-search').dispatchEvent(new Event('input')); // Refresh UI
};


// ===================================================================================
// --- ðŸ“š REPORTS MODULE ---
// ===================================================================================

/**
 * Renders the Reports tab with filters and a sortable table of issued books.
 */
function renderLibraryReportsTab() {
    const container = document.getElementById('reports');
    if (!container) return;

    container.innerHTML = `
        <h5 class="fw-bold mb-3">Issued Books Report</h5>
        <div class="row g-3 align-items-end border-bottom pb-3 mb-3">
            <div class="col-md-4">
                <label for="report-filter-class" class="form-label">Filter by Class</label>
                <select id="report-filter-class" class="form-select form-select-sm">
                    <option value="">-- All Classes --</option>
                    ${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                </select>
            </div>
            <div class="col-md-4">
                <label for="report-filter-division" class="form-label">Filter by Division</label>
                <select id="report-filter-division" class="form-select form-select-sm" disabled>
                    <option value="">-- All --</option>
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button id="download-report-csv" class="btn btn-success w-100">
                    <i class="fas fa-download me-2"></i>Download CSV
                </button>
            </div>
        </div>
        <div class="form-check my-3">
            <input class="form-check-input" type="checkbox" id="overdue-filter-checkbox">
            <label class="form-check-label" for="overdue-filter-checkbox">Show only overdue books</label>
        </div>
        <div id="report-table-content"></div>
    `;

    // Attach listeners and render the initial report table
    const classFilter = document.getElementById('report-filter-class');
    const divisionFilter = document.getElementById('report-filter-division');

    classFilter.addEventListener('change', () => {
        const selectedClass = classes.find(c => c.id === classFilter.value);
        divisionFilter.innerHTML = '<option value="">-- All --</option>';
        divisionFilter.disabled = !selectedClass;
        if (selectedClass) {
            divisionFilter.innerHTML += selectedClass.divisions.map(d => `<option value="${d}">${d}</option>`).join('');
        }
        updateLibraryReport();
    });

    divisionFilter.addEventListener('change', updateLibraryReport);
    document.getElementById('overdue-filter-checkbox').addEventListener('change', updateLibraryReport);
    document.getElementById('download-report-csv').addEventListener('click', downloadLibraryReportCSV);

    updateLibraryReport(); // Initial render
}

/**
 * Filters, sorts, and renders the library report table based on UI controls.
 */
function updateLibraryReport() {
    const reportContent = document.getElementById('report-table-content');
    const selectedClassId = document.getElementById('report-filter-class').value;
    const selectedDivision = document.getElementById('report-filter-division').value;
    const showOnlyOverdue = document.getElementById('overdue-filter-checkbox').checked;

    let reportData = bookIssuances.filter(item => item.status === 'Issued');

    if (selectedClassId) {
        const studentIdsInClass = students
            .filter(s => s.classId === selectedClassId && (!selectedDivision || s.division === selectedDivision))
            .map(s => s.id);
        reportData = reportData.filter(item => studentIdsInClass.includes(item.studentId));
    }

    if (showOnlyOverdue) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        reportData = reportData.filter(item => new Date(item.dueDate) < today);
    }

    reportData.sort((a, b) => {
        const valA = a[libraryReportSort.column] || '';
        const valB = b[libraryReportSort.column] || '';
        const comparison = valA.localeCompare(valB, undefined, { numeric: true });
        return libraryReportSort.direction === 'asc' ? comparison : -comparison;
    });

    currentLibraryReportData = [...reportData]; // Store for CSV export

    const getSortIcon = (column) => {
        if (libraryReportSort.column !== column) return '<i class="fas fa-sort fa-xs text-muted ms-1"></i>';
        return libraryReportSort.direction === 'asc' ?
            '<i class="fas fa-sort-up text-primary ms-1"></i>' :
            '<i class="fas fa-sort-down text-primary ms-1"></i>';
    };

    if (reportData.length === 0) {
        reportContent.innerHTML = '<p class="text-muted">No records match the current filters.</p>';
        return;
    }

    reportContent.innerHTML = `
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th onclick="handleReportSort('studentName')" style="cursor: pointer;">Student Name ${getSortIcon('studentName')}</th>
                        <th onclick="handleReportSort('bookTitle')" style="cursor: pointer;">Book Title ${getSortIcon('bookTitle')}</th>
                        <th onclick="handleReportSort('issueDate')" style="cursor: pointer;">Issue Date ${getSortIcon('issueDate')}</th>
                        <th onclick="handleReportSort('dueDate')" style="cursor: pointer;">Due Date ${getSortIcon('dueDate')}</th>
                    </tr>
                </thead>
                <tbody>
                    ${reportData.map(item => {
                        const isOverdue = new Date(item.dueDate) < new Date();
                        return `
                        <tr class="${isOverdue ? 'table-danger' : ''}">
                            <td>${item.studentName}</td>
                            <td>${item.bookTitle}</td>
                            <td>${new Date(item.issueDate).toLocaleDateString()}</td>
                            <td>${new Date(item.dueDate).toLocaleDateString()}</td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>`;
}

/**
 * Handles clicks on report table headers to update the sorting state.
 * @param {string} column - The name of the column to sort by.
 */
window.handleReportSort = (column) => {
    if (libraryReportSort.column === column) {
        libraryReportSort.direction = libraryReportSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        libraryReportSort.column = column;
        libraryReportSort.direction = 'asc';
    }
    updateLibraryReport(); // Re-render the table with new sorting
};

/**
 * Downloads the currently filtered and sorted library report data as a CSV file.
 */
window.downloadLibraryReportCSV = () => {
    if (currentLibraryReportData.length === 0) {
        return showAlert('No data to export.', 'info');
    }

    const headers = ['Student Name', 'Admission No', 'Class', 'Book Title', 'Issue Date', 'Due Date', 'Days Overdue'];
    const rows = currentLibraryReportData.map(item => {
        const student = students.find(s => s.id === item.studentId);
        const className = student ? getStudentClassName(student.classId, student.division) : 'N/A';

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const dueDate = new Date(item.dueDate);
        const timeDiff = today.getTime() - dueDate.getTime();
        const daysOverdue = timeDiff > 0 ? Math.floor(timeDiff / (1000 * 3600 * 24)) : 0;

        const rowData = [
            item.studentName,
            student?.admissionNumber || 'N/A',
            className,
            item.bookTitle,
            new Date(item.issueDate).toLocaleDateString(),
            new Date(item.dueDate).toLocaleDateString(),
            daysOverdue
        ];
        return rowData.map(val => `"${String(val).replace(/"/g, '""')}"`).join(',');
    });

    const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows].join('\r\n');
    const link = document.createElement('a');
    link.setAttribute('href', encodeURI(csvContent));
    link.setAttribute('download', `library_report_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};


// ===================================================================================
// --- ðŸ‘¤ STUDENT & TEACHER VIEWS ---
// ===================================================================================

/**
 * Renders the library view for the currently logged-in student.
 */
window.renderMyLibrary = () => {
    const issued = bookIssuances.filter(item => item.studentId === selectedUser.id && item.status === 'Issued');
    const history = bookIssuances.filter(item => item.studentId === selectedUser.id && item.status === 'Returned');

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">My Library</h1>
        <div class="card shadow mb-4">
            <div class="card-header fw-bold text-primary">Currently Issued Books</div>
            <div class="card-body">
                ${issued.length === 0 ? '<p class="text-muted">You have no books currently issued.</p>' : `
                <ul class="list-group list-group-flush">
                    ${issued.map(item => `<li class="list-group-item"><strong>${item.bookTitle}</strong><br><small class="text-muted">Issued: ${new Date(item.issueDate).toLocaleDateString()} | Due: ${new Date(item.dueDate).toLocaleDateString()}</small></li>`).join('')}
                </ul>`}
            </div>
        </div>
        <div class="card shadow">
            <div class="card-header fw-bold">My Reading History</div>
            <div class="card-body">
                 ${history.length === 0 ? '<p class="text-muted">No returned books in your history.</p>' : `
                <ul class="list-group list-group-flush">
                    ${history.map(item => `<li class="list-group-item"><strong>${item.bookTitle}</strong><br><small class="text-muted">Returned on: ${new Date(item.returnDate).toLocaleDateString()}</small></li>`).join('')}
                </ul>`}
            </div>
        </div>
    `;
};

/**
 * Renders the library status view for a class teacher.
 */
window.renderTeacherLibraryStatus = () => {
    if (!selectedUser.classCharge) {
        mainContent.innerHTML = `<h1 class="h2 mb-4">Library Status</h1><p class="text-warning">You are not assigned as a class teacher to view this page.</p>`;
        return;
    }
    const { classId, division } = selectedUser.classCharge;
    //const studentsInClass = students.filter(s => s.classId === classId && s.division === division);
    const studentsInClass = students.filter(s => s.classId === classId && s.division === division && s.status !== 'TC Issued').sort((a, b) => a.name.localeCompare(b.name));

    const studentIds = studentsInClass.map(s => s.id);
    const issuedToClass = bookIssuances.filter(item => studentIds.includes(item.studentId) && item.status === 'Issued');

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Library Status for Your Class</h1>
        <div class="card shadow">
            <div class="card-body table-responsive">
                <table class="table">
                    <thead><tr><th>Student Name</th><th>Book Title</th><th>Due Date</th></tr></thead>
                    <tbody>
                        ${studentsInClass.map(student => {
                            const book = issuedToClass.find(b => b.studentId === student.id);
                            return `
                                <tr>
                                    <td>${student.name}</td>
                                    ${book ? `<td>${book.bookTitle}</td><td>${new Date(book.dueDate).toLocaleDateString()}</td>` : '<td colspan="2" class="text-muted">No book issued</td>'}
                                </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
};


// =========================================================================
// --- ðŸ† FEST MANAGEMENT MODULE (FINAL & COMPLETE VERSION) ---
// =========================================================================

// -------------------------------------------------------------------------
// --- 1. STATE & MAIN RENDERERS ---
// -------------------------------------------------------------------------

const state = {
    festToEdit: null,
    houseToEdit: null,
    groupToEdit:null,
    eventToEdit: null,
    registrationToEdit: null,
    groupBuilderMembers: [], 
    managingFest: null, // This holds the entire fest object being managed.
};

/**
 * Main entry point for the module.
 * Shows the fest selection screen or the management dashboard.
 */
window.renderFestManagement = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) return;

    const hasAccess = currentUserRole === 'admin' || (selectedUser.roles && selectedUser.roles.includes('festmgr'));
    if (!hasAccess) {
        mainContent.innerHTML = `<div class="alert alert-danger"><h4><i class="fas fa-exclamation-triangle me-2"></i>Access Denied</h4><p>You do not have permission to access this module.</p></div>`;
        return;
    }

    if (!state.managingFest) {
        renderFestSelectionScreen();
    } else {
        // UPDATED: Added a new tab for Data Entry Links
        mainContent.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2 fw-bold mb-0">Managing: <span class="text-primary">${state.managingFest.name}</span></h1>
                <button class="btn btn-sm btn-outline-secondary" onclick="window.unselectFest()">
                    <i class="fas fa-arrow-left me-2"></i>Change Fest
                </button>
            </div>

            <ul class="nav nav-tabs" id="festMgtTab" role="tablist">
                <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#fest-dashboard" type="button"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fest-setup" type="button"><i class="fas fa-cogs me-2"></i>Setup</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fest-events" type="button"><i class="fas fa-calendar-check me-2"></i>Events</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fest-participants" type="button"><i class="fas fa-users-cog me-2"></i>Participants</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fest-scoring" type="button"><i class="fas fa-clipboard-list me-2"></i>Scoring</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fest-reports" type="button"><i class="fas fa-print me-2"></i>Reports</button></li>
                <!-- NEW TAB ADDED HERE -->
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fest-data-entry" type="button"><i class="fas fa-link me-2"></i>Data Entry Links</button></li>
            </ul>
            <div class="tab-content card" id="festMgtTabContent">
                <div class="tab-pane fade show active p-4" id="fest-dashboard" role="tabpanel"></div>
                <div class="tab-pane fade p-4" id="fest-setup" role="tabpanel"></div>
                <div class="tab-pane fade p-4" id="fest-events" role="tabpanel"></div>
                <div class="tab-pane fade p-4" id="fest-participants" role="tabpanel"></div>
                <div class="tab-pane fade p-4" id="fest-scoring" role="tabpanel"></div>
                <div class="tab-pane fade p-4" id="fest-reports" role="tabpanel"></div>
                <!-- NEW TAB CONTENT DIV ADDED HERE -->
                <div class="tab-pane fade p-4" id="fest-data-entry" role="tabpanel"></div>
            </div>
        `;

        // Render content for each tab
        renderFestDashboardTab();
        renderFestSetupTab();
        renderFestEventsTab();
        renderFestParticipantsTab();
        renderFestScoringTab();
        renderFestReportsTab();
        renderFestDataEntryLinksTab(); // Render the new tab
    }
};

// =========================================================================
// --- ðŸ† NEW: DATA ENTRY LINKS MODULE ---
// Add all the following new functions to your script.
// =========================================================================

/**
 * Renders the "Data Entry Links" tab for the Fest Manager.
 */
function renderFestDataEntryLinksTab() {
    const container = document.getElementById('fest-data-entry');
    if (!container || !state.managingFest) return;

    const housePasswords = state.managingFest.housePasswords || {};

    container.innerHTML = `
        <h5 class="section-header"><i class="fas fa-key me-2"></i>Manage Data Entry Access</h5>
        <p class="text-muted">Set a password for each house to grant them access to a simplified participant entry page for this fest. Share the generated link with the house captain.</p>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>House</th>
                        <th>Set Password</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${festHouses.map(house => `
                        <tr data-house-id="${house.id}">
                            <td class="align-middle">
                                <span class="color-dot-display" style="background-color:${house.color};"></span>
                                <strong>${house.name}</strong>
                            </td>
                            <td>
                                <div class="input-group">
                                    <input type="text" class="form-control house-password-input" placeholder="Enter password..." value="${housePasswords[house.id] || ''}">
                                    <button class="btn btn-outline-primary" onclick="window.saveHousePassword('${state.managingFest.id}', '${house.id}')">Save</button>
                                </div>
                            </td>
                            <td>
                                <button class="btn btn-secondary" onclick="window.copyShareableLink('${state.managingFest.id}', '${house.id}')" ${!housePasswords[house.id] ? 'disabled' : ''}>
                                    <i class="fas fa-copy me-2"></i>Copy Link
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

/**
 * Saves the password for a specific house for the current fest.
 * @param {string} festId - The ID of the fest.
 * @param {string} houseId - The ID of the house.
 */
window.saveHousePassword = async (festId, houseId) => {
    const row = document.querySelector(`tr[data-house-id="${houseId}"]`);
    const passwordInput = row.querySelector('.house-password-input');
    const password = passwordInput.value.trim();

    if (!password) {
        return showAlert('Password cannot be empty.', 'danger');
    }

    const festRef = getDocRef('fests', festId);
    const updatedPasswords = {
        ...state.managingFest.housePasswords,
        [houseId]: password
    };

    try {
        await updateDoc(festRef, { housePasswords: updatedPasswords });
        // Update local state to match
        state.managingFest.housePasswords = updatedPasswords;
        showAlert('Password saved successfully!', 'success');
        renderFestDataEntryLinksTab(); // Re-render to enable the copy button
    } catch (error) {
        console.error("Error saving house password:", error);
        showAlert('Failed to save password.', 'danger');
    }
};

/**
 * Generates and copies the unique shareable link to the clipboard.
 * @param {string} festId - The ID of the fest.
 * @param {string} houseId - The ID of the house.
 */
window.copyShareableLink = (festId, houseId) => {
    const baseUrl = window.location.href.split('#')[0];
    const shareableLink = `${baseUrl}#fest-entry?fest=${festId}&house=${houseId}`;
    
    navigator.clipboard.writeText(shareableLink).then(() => {
        showAlert('Shareable link copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy link: ', err);
        showAlert('Could not copy link. Please copy it manually.', 'danger');
        prompt("Copy this link manually:", shareableLink);
    });
};

/**
 * Checks the URL hash on page load to see if we are in data entry mode.
 * THIS FUNCTION SHOULD BE CALLED AT THE VERY BEGINNING OF YOUR SCRIPT,
 * RIGHT AFTER FIREBASE IS INITIALIZED, BUT BEFORE THE MAIN LOGIN SCREEN IS SHOWN.
 */
window.checkForDataEntryMode = async () => {
    if (window.location.hash.startsWith('#fest-entry')) {
        const params = new URLSearchParams(window.location.hash.split('?')[1]);
        const festId = params.get('fest');
        const houseId = params.get('house');

        if (festId && houseId) {
            // ---> EDITED LOGIC: FETCH DIRECTLY FROM FIREBASE <---
            try {
                // Fetch the necessary data directly from Firestore
                const festDoc = await getDoc(getDocRef('fests', festId));
                const houseDoc = await getDoc(getDocRef('festHouses', houseId));


                if (!festDoc.exists() || !houseDoc.exists()) {
                    document.body.innerHTML = `<div class="alert alert-danger m-5">Error: Invalid Fest or House ID provided in the link.</div>`;
                    return true; // Stop normal app execution
                }

                const festData = { id: festDoc.id, ...festDoc.data() };
                const houseData = { id: houseDoc.id, ...houseDoc.data() };

                // Hide the main app and show the special data entry login page
                document.getElementById('app-container').style.display = 'none';
                renderFestEntryLoginPage(festData, houseData); // Pass the fetched data
                return true; // Indicate that we are in data entry mode

            } catch (error) {
                console.error("Error fetching data for entry mode:", error);
                document.body.innerHTML = `<div class="alert alert-danger m-5">Could not load data entry page. Please check your connection.</div>`;
                return true; // Stop normal app execution
            }
        }
    }
    return false; // Not in data entry mode, proceed with normal app startup
};


/**
 * Renders the special login page for house data entry.
 * @param {object} festData - The full fest object from Firestore.
 * @param {object} houseData - The full house object from Firestore.
 */
function renderFestEntryLoginPage(festData, houseData) {
            const entryLoginDiv = document.createElement('div');
            entryLoginDiv.id = 'fest-entry-login-screen';
            entryLoginDiv.className = 'vh-100 d-flex align-items-center justify-content-center bg-light';
            
            const festName = festData.name || 'the Fest';
            const houseName = houseData.name || 'your House';

            entryLoginDiv.innerHTML = `
                <div class="card shadow-lg" style="width: 100%; max-width: 420px;">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <i class="fas fa-trophy fa-3x text-warning"></i>
                            <h1 class="mt-3 h3 fw-bold">Participant Entry</h1>
                            <p class="text-muted">For ${houseName} in ${festName}</p>
                        </div>
                        <form id="fest-entry-login-form">
                            <div class="mb-3">
                                <label class="form-label">House Password</label>
                                <!-- âœ… FIX: Added autocomplete attribute -->
                                <input type="password" id="fest-entry-password" class="form-control" required autocomplete="current-password">
                            </div>
                            <div class="d-grid mt-4">
                                <button type="submit" class="btn btn-primary btn-lg">Login</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(entryLoginDiv);

            document.getElementById('fest-entry-login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                handleFestEntryLogin(festData.id, houseData.id);
            });
        }

        /**
         * Handles the login attempt for the data entry page.
         * âœ… FIX: This function now fetches all necessary data AFTER a successful login.
         * @param {string} festId - The ID of the fest.
         * @param {string} houseId - The ID of the house.
         */
async function handleFestEntryLogin(festId, houseId) {
    const enteredPassword = document.getElementById('fest-entry-password').value;
    
    try {
        const festDoc = await getDoc(getDocRef('fests', festId));
        if (!festDoc.exists()) {
            showAlert('Fest data could not be found.', 'danger');
            return;
        }
        const fest = { id: festDoc.id, ...festDoc.data() };


        if (fest && fest.housePasswords && fest.housePasswords[houseId] === enteredPassword) {
            showAlert('Login successful! Loading live data...', 'success');
            
            const initialLoadPromises = [];

            // âœ… MODIFICATION: Listen to the main 'fests' collection separately
            const festsPromise = new Promise(resolve => {
                onSnapshot(getCollectionRef('fests'), (snapshot) => {
                    fests = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    
                    // Find the currently managed fest from the updated data
                    const currentFest = fests.find(f => f.id === festId);
                    const houseData = festHouses.find(h => h.id === houseId);

                    // If the dashboard is already visible, re-render it with the new fest data
                    if (document.getElementById('house-registration-view')) {
                        renderHouseDataEntryDashboard(currentFest, houseData);
                    }
                    resolve(); 
                });
            });
            initialLoadPromises.push(festsPromise);

            // Set up listeners for other general collections (these don't need to trigger a re-render)
            const otherCollections = ['classes', 'festHouses', 'festEvents', 'festRegistrations','festGroups'];
            otherCollections.forEach(name => {
                const promise = new Promise(resolve => {
                    onSnapshot(getCollectionRef(name), (snapshot) => {
                        const fetchedData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        switch (name) {
                            case 'classes': classes = fetchedData; break;
                            case 'festHouses': festHouses = fetchedData; break;
                            case 'festEvents': festEvents = fetchedData; break;
                            case 'festGroups': festGroups = fetchedData; break;
                            case 'festRegistrations': festRegistrations = fetchedData; break;
                        }
                        resolve(); 
                    });
                });
                initialLoadPromises.push(promise);
            });

            // Set up a specific, filtered listener for students of the logged-in house
            const studentsPromise = new Promise(resolve => {
                const studentsQuery = query(getCollectionRef('students'), where("houseId", "==", houseId));
                onSnapshot(studentsQuery, (snapshot) => {
                    students = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    resolve();
                });
            });
            initialLoadPromises.push(studentsPromise);
            
            await Promise.all(initialLoadPromises);

            const loginScreen = document.getElementById('fest-entry-login-screen');
            if (loginScreen) {
                loginScreen.remove();
            }
            document.getElementById('app-container').style.display = 'block';
            
            // Initial render after all data is loaded
            const houseData = festHouses.find(h => h.id === houseId);
            renderHouseDataEntryDashboard(fest, houseData);
        } else {
            showAlert('Incorrect password. Please try again.', 'danger');
        }
    } catch (error) {
        console.error("Error during fest entry login:", error);
        showAlert('An error occurred during login. Please check your connection.', 'danger');
    }
}       
/**
         * Renders the simplified dashboard for the house captain.
         * âœ… FIX: This function now receives the full house object to prevent the error.
         * @param {object} fest - The full fest object.
         * @param {object} house - The full house object.
         */
        function renderHouseDataEntryDashboard(fest, house) {
            const appContainer = document.getElementById('app-container');
            
            // âœ… FIX: The 'house' object is now passed directly, so no .find() is needed.
            // This prevents the "Cannot read properties of undefined (reading 'color')" error.
            if (!house) {
                appContainer.innerHTML = `<div class="alert alert-danger m-5">Error: House data could not be loaded.</div>`;
                return;
            }

            appContainer.innerHTML = `
                <main class="container-fluid p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h1 class="h2 mb-0">
                            <span class="color-dot-display" style="background-color:${house.color};"></span>
                            ${house.name} - Participant Dashboard
                        </h1>
                        <span class="badge bg-primary fs-6">${fest.name}</span>
                    </div>
                    <div id="house-registration-view"></div>
                </main>
            `;
            
            renderHouseParticipantRegistration(fest, house.id);
        }


/**
 * Renders the participant registration dashboard for a specific house,
 * with search, tabs, and checks for registration status.
 * @param {object} fest - The full fest object.
 * @param {string} houseId - The ID of the house.
 */
/**
 * Renders the participant registration dashboard for a specific house,
 * with search, tabs, and filters for event type (On-Stage/Off-Stage).
 * @param {object} fest - The full fest object.
 * @param {string} houseId - The ID of the house.
 */
/**
 * Renders the House Captain's dashboard with three tabs:
 * 1. Register Participants (for individual students)
 * 2. Group Management (for creating and editing groups)
 * 3. View Registrations (for viewing all entries)
 * @param {object} fest - The full fest object.
 * @param {string} houseId - The ID of the house.
 */
function renderHouseParticipantRegistration(fest, houseId) {
    state.managingFest = fest; // Ensure the global state is set for modals
    const container = document.getElementById('house-registration-view');
    const studentsInHouse = students.filter(s => s.houseId === houseId);
    const eventsForFest = festEvents.filter(e => e.festId === fest.id);

    const isRegistrationOpen = fest.registrationOpen === true;

    // --- NEW: Get unique categories and classes for the filters ---
    const uniqueCategories = [...new Set(eventsForFest.map(e => e.category))].sort();
    const uniqueClasses = [...new Map(studentsInHouse.map(s => [s.classId, { id: s.classId, name: getStudentClassName(s.classId) }])).values()]
        .sort((a, b) => a.name.localeCompare(b.name));

    // --- MODIFIED HTML: Added new filters for category and class ---
    container.innerHTML = `
        <div class="ui-card">
            <ul class="nav nav-pills mb-3" id="house-entry-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="register-tab" data-bs-toggle="tab" data-bs-target="#register-pane" type="button" role="tab">
                        <i class="fas fa-user-plus me-2"></i>Register Participants (Solo)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups-pane" type="button" role="tab">
                        <i class="fas fa-users me-2"></i>Group Management
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="view-registrations-tab" data-bs-toggle="tab" data-bs-target="#view-pane" type="button" role="tab">
                        <i class="fas fa-list-alt me-2"></i>View Registrations
                    </button>
                </li>
            </ul>
            <div class="tab-content" id="house-entry-tabs-content">
                <div class="tab-pane fade show active" id="register-pane" role="tabpanel">
                    ${!isRegistrationOpen ? `
                        <div class="alert alert-warning">
                            <i class="fas fa-lock me-2"></i> Registration for this fest is currently closed.
                        </div>
                    ` : ''}
                    <div class="row mb-3 g-2">
                        <div class="col-md-5">
                            <input type="text" id="house-student-search" class="form-control" placeholder="Search students by name or admission no...">
                        </div>
                        <div class="col-md-4">
                             <select id="house-reg-category-filter" class="form-select">
                                <option value="all">All Categories</option>
                                ${uniqueCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="house-reg-class-filter" class="form-select">
                                <option value="all">All Classes</option>
                                ${uniqueClasses.map(cls => `<option value="${cls.id}">${cls.name||""}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm" id="house-reg-table">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Registered Events</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="text-end mt-3">
                        <button class="d-none btn btn-success" id="save-house-regs-btn" ${!isRegistrationOpen ? 'disabled' : ''}>Save All Registrations</button>
                    </div>
                </div>
                <div class="tab-pane fade" id="groups-pane" role="tabpanel">
                    </div>
                <div class="tab-pane fade" id="view-pane" role="tabpanel">
                    <div class="row mb-3 align-items-end">
                        <div class="col-md-4">
                            <label for="house-event-type-filter" class="form-label">Filter by Type</label>
                            <select id="house-event-type-filter" class="form-select">
                                <option value="all">All Types</option>
                                <option value="onStage">On-Stage</option>
                                <option value="offStage">Off-Stage</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label for="house-event-filter" class="form-label">Filter by Event</label>
                            <select id="house-event-filter" class="form-select">
                                <option value="all">All Events</option>
                            </select>
                        </div>
                        <div class="col-md-3 text-end">
                            <button class="btn btn-danger" id="download-house-report-pdf-btn">
                                <i class="fas fa-file-pdf me-2"></i>Download PDF
                            </button>
                        </div>
                    </div>
                    <div id="house-registered-list"></div>
                </div>
            </div>
        </div>
    `;

    // --- MODIFIED HELPER FUNCTION: Renders table rows with the updated "Manage" button ---
const renderTableRows = (searchTerm = '', category = 'all', classId = 'all') => {
    const tableBody = container.querySelector('#house-reg-table tbody');
    const registrationsInHouse = festRegistrations.filter(r => r.festId === fest.id && r.houseId === houseId);

    let filteredStudents = studentsInHouse;

    // Apply filters
    if (searchTerm) {
        const lowerCaseSearch = searchTerm.toLowerCase();
        filteredStudents = filteredStudents.filter(s =>
            s.name.toLowerCase().includes(lowerCaseSearch) ||
            String(s.admissionNumber || "").toLowerCase().includes(lowerCaseSearch)
        );
    }
    if (classId !== 'all') {
        filteredStudents = filteredStudents.filter(s => s.classId === classId);
    }
    if (category !== 'all') {
        filteredStudents = filteredStudents.filter(student => {
            const registration = registrationsInHouse.find(r => r.studentId === student.id);
            if (!registration || !registration.events.length) return false;
            // Check if the student is in any event that matches the selected category
            return registration.events.some(eventId => {
                const event = eventsForFest.find(e => e.id === eventId);
                return event && event.category === category;
            });
        });
    }
    
    if (filteredStudents.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">No students match the current filters.</td></tr>`;
        return;
    }

    tableBody.innerHTML = filteredStudents.map(student => {
        const registration = registrationsInHouse.find(r => r.studentId === student.id);
        const registeredEventIds = registration?.events || [];
        
        // --- NEW: Added event count for the badge ---
        const eventCount = registeredEventIds.length;
        
        // Generate HTML for displaying event names as badges
        const eventsHtml = registeredEventIds.length > 0
            ? registeredEventIds.map(eventId => {
                const event = eventsForFest.find(e => e.id === eventId);
                return `<span class="badge bg-light text-dark me-1">${event ? event.name : 'Unknown Event'}</span>`;
            }).join('')
            : `<small class="text-muted">No events registered</small>`;

        // --- MODIFIED: The returned <tr> now includes your requested button style ---
        return `
                <tr data-studentid="${student.id}" data-events="${registeredEventIds.join(',') || ''}">
                    <td>
                        ${student.name}
                        <br>
                        <small class="text-muted">Adm: ${student.admissionNumber} | ${getStudentClassName(student.classId, student.division)}</small>
                    </td>
                    <td>${eventsHtml}</td>
                    <td class="text-end">
                         <button class="btn btn-sm btn-outline-secondary manage-events-btn" ${!isRegistrationOpen ? 'disabled' : ''} title="Manage this student's events">
                            <i class="fas fa-edit me-1"></i> Manage
                            <span class="badge bg-primary rounded-pill event-count-badge ms-2 event-count">${eventCount}</span>
                         </button>
                         <button class="d-none btn btn-sm btn-outline-success save-single-reg-btn ms-2" title="Save this student's registration" ${!isRegistrationOpen ? 'disabled' : ''}>
                            <i class="fas fa-save"></i>
                         </button>
                    </td>
                </tr>`;
        }).join('');
};
    
    // --- HELPER FUNCTION TO RENDER THE "VIEW" PANE CONTENT (Unchanged) ---
    const renderViewPaneContent = (filterType = 'all', filterEventId = 'all') => {
        // This function's internal logic remains the same as the previous version.
        const listContainer = document.getElementById('house-registered-list');
        const registrationsInHouse = festRegistrations.filter(r => r.festId === fest.id && r.houseId === houseId);
        let eventsToDisplay = festEvents.filter(e => e.festId === fest.id);
        if (filterType !== 'all') { eventsToDisplay = eventsToDisplay.filter(e => (e.type || 'onStage') === filterType); }
        if (filterEventId !== 'all') { eventsToDisplay = eventsToDisplay.filter(e => e.id === filterEventId); }
        eventsToDisplay.sort((a, b) => a.name.localeCompare(b.name));
        if (registrationsInHouse.length === 0 && filterEventId === 'all') { listContainer.innerHTML = '<p class="text-muted">No participants have been registered from your house yet.</p>'; return; }
        let content = ''; let foundAnyParticipants = false;
        eventsToDisplay.forEach(event => {
            let participantsContent = ''; let participantCount = 0;
            if (event.isGroupEvent) {
                const participatingGroups = [];
                const groupsInHouse = festGroups.filter(g => g.festId === fest.id && g.houseId === houseId);
                groupsInHouse.forEach(group => {
                    const isParticipating = group.members.some(member => registrationsInHouse.some(reg => reg.studentId === member.studentId && reg.events.includes(event.id)));
                    if (isParticipating) participatingGroups.push(group);
                });
                participantCount = participatingGroups.length;
                if (participantCount > 0) {
                    foundAnyParticipants = true;
                    participatingGroups.sort((a,b) => a.name.localeCompare(b.name));
                    participantsContent = participatingGroups.map(group => {
                        const membersHtml = group.members.map(member => {
                            const student = students.find(s => s.id === member.studentId);
                            return `<li>${student.name} <small class="text-muted">(${getStudentClassName(student?.classId, student?.division)})</small></li>`;
                        }).join('');
                        return `<li class="list-group-item"><strong>${group.name}</strong> (Group)<ul class="list-unstyled ps-3 pt-1 small">${membersHtml}</ul></li>`;
                    }).join('');
                }
            } else { // Solo Event
                const participants = registrationsInHouse.filter(r => r.events.includes(event.id));
                participantCount = participants.length;
                if (participantCount > 0) {
                    foundAnyParticipants = true;
                    participants.sort((a, b) => (a.chestNo || a.studentName).localeCompare(b.chestNo || b.studentName));
                    participantsContent = participants.map(p => {
                        const student = students.find(s => s.id === p.studentId);
                        return `<li class="list-group-item d-flex justify-content-between align-items-center"><span><strong>${p.chestNo || 'N/A'}:</strong> ${p.studentName}<small class="text-muted ms-2">(${getStudentClassName(student?.classId, student?.division)})</small></span>${isRegistrationOpen ? `<button class="btn btn-sm btn-outline-primary py-0 px-2" onclick="window.editParticipantFromReport('${p.studentId}')"><i class="fas fa-edit"></i> Edit</button>` : ''}</li>`;
                    }).join('');
                }
            }
            if (participantCount > 0) { content += `<div class="d-flex justify-content-between align-items-center mt-3"><h6 class="text-primary mb-0">${event.name} (${event.category})</h6><span class="badge bg-secondary rounded-pill">${participantCount} ${event.isGroupEvent ? 'Group(s)' : 'Participant(s)'}</span></div><ul class="list-group mt-2">${participantsContent}</ul>`; }
        });
        if (foundAnyParticipants) { listContainer.innerHTML = content; } 
        else { listContainer.innerHTML = '<p class="text-muted">No participants registered for the selected event(s).</p>'; }
    };

    // --- MODIFIED EVENT LISTENERS: Now handle the new filters ---
    const searchInput = document.getElementById('house-student-search');
    const categoryFilter = document.getElementById('house-reg-category-filter');
    const classFilter = document.getElementById('house-reg-class-filter');
    
    const applyFilters = () => {
        renderTableRows(searchInput.value, categoryFilter.value, classFilter.value);
    };

    searchInput.addEventListener('input', applyFilters);
    categoryFilter.addEventListener('change', applyFilters);
    classFilter.addEventListener('change', applyFilters);
    
    // --- Unchanged Event Listeners ---
    const regTableBody = container.querySelector('#house-reg-table tbody');
    regTableBody.addEventListener('click', (e) => {
        const manageBtn = e.target.closest('.manage-events-btn');
        const saveBtn = e.target.closest('.save-single-reg-btn');
        if (manageBtn) openEventSelectionModal(manageBtn.closest('tr'));
        if (saveBtn) saveSingleHouseRegistration(fest.id, houseId, saveBtn.closest('tr'));
    });
    document.getElementById('save-house-regs-btn').addEventListener('click', () => { saveHouseRegistrationsFromEntryPage(fest.id, houseId); });
    const typeFilter = document.getElementById('house-event-type-filter');
    const eventFilter = document.getElementById('house-event-filter');
    typeFilter.addEventListener('change', () => {
        const selectedType = typeFilter.value;
        let filteredEvents = eventsForFest;
        if (selectedType !== 'all') { filteredEvents = eventsForFest.filter(e => (e.type || 'onStage') === selectedType); }
        eventFilter.innerHTML = `<option value="all">All Events</option>` + filteredEvents.map(e => `<option value="${e.id}">${e.name} (${e.category})</option>`).join('');
        renderViewPaneContent(selectedType, 'all');
    });
    eventFilter.addEventListener('change', () => { renderViewPaneContent(typeFilter.value, eventFilter.value); });
    document.getElementById('download-house-report-pdf-btn').addEventListener('click', () => { downloadHouseReportPDF(fest, houseId); });

    // --- RENDER THE NEW GROUP MANAGEMENT TAB ---
    renderHouseGroupManagementTab(fest, houseId, isRegistrationOpen);
    
    // --- INITIAL RENDERS ---
    renderTableRows(); // Initial render with default filter values
    typeFilter.dispatchEvent(new Event('change'));
}

/**
 * NEW: Renders the content for the "Group Management" tab with a Refresh button.
 */
function renderHouseGroupManagementTab(fest, houseId, isRegistrationOpen) {
    const container = document.getElementById('groups-pane');
    if (!container) return;

    container.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="section-header mb-0">Manage Your House's Groups</h5>
            <div>
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="displayHouseGroupsList('${fest}', '${houseId}', ${isRegistrationOpen})">
                    <i class="fas fa-sync-alt me-1"></i>Refresh List
                </button>
                <button class="btn btn-primary" onclick="openGroupBuilderModal(null, '${fest.id}', '${houseId}')" ${!isRegistrationOpen ? 'disabled' : ''}>
                    <i class="fas fa-plus me-2"></i>Create New Group
                </button>
            </div>
        </div>
        <div id="house-groups-list-container"></div>
    `;
    // Call the function to populate the list
    displayHouseGroupsList(fest, houseId, isRegistrationOpen);
}
/**
 * NEW: Removes a student from a group, un-registers them from the group's events,
 * and then refreshes the UI automatically.
 * @param {string} groupId - The ID of the group.
 * @param {string} studentId - The ID of the student to remove.
 */
window.removeStudentFromGroup = async (groupId, studentId) => {
    if (!confirm('Are you sure you want to remove this student from the group? This will also un-register them from all of this group\'s events.')) return;

    const group = festGroups.find(g => g.id === groupId);
    if (!group) return showAlert('Group not found.', 'danger');

    // --- 1. Prepare Data for Update ---

    // Create the new list of members without the removed student
    const updatedMembers = group.members.filter(m => m.studentId !== studentId);

    // Find all unique group events this group was registered for
    const groupEventIds = new Set();
    group.members.forEach(member => {
        const reg = festRegistrations.find(r => r.studentId === member.studentId && r.festId === group.festId);
        reg?.events.forEach(eventId => {
            const event = festEvents.find(e => e.id === eventId);
            if (event?.isGroupEvent) {
                groupEventIds.add(eventId);
            }
        });
    });

    const batch = writeBatch(db);

    // --- 2. Update the Database ---

    // Update the group document with the new member list
    const groupRef = getDocRef('festGroups', groupId);
    batch.update(groupRef, { members: updatedMembers });

    // Find the removed student's registration and remove them from the group events
    const studentRegRef = getDocRef('festRegistrations', `${group.festId}_${studentId}`);
    const studentReg = festRegistrations.find(r => r.id === `${group.festId}_${studentId}`);
    if (studentReg) {
        // Keep the student's solo events, but remove the group events
        const updatedEvents = studentReg.events.filter(eventId => !groupEventIds.has(eventId));
        batch.update(studentRegRef, { events: updatedEvents });
    }

    try {
        await batch.commit();
        showAlert('Student removed from group successfully.', 'success');
        
        // --- 3. Refresh the UI ---
        // This is the "auto-update" part. We just re-run the function that draws the list.
        const fest = state.managingFest;
        const isRegistrationOpen = fest.registrationOpen === true;
        displayHouseGroupsList(fest, group.houseId, isRegistrationOpen);

    } catch (error) {
        console.error("Error removing student from group:", error);
        showAlert('Failed to remove student.', 'danger');
    }
};

/**
 * Displays the list of existing groups for the house using a collapsible accordion layout.
 * This is called by the "Group Management" tab in the house captain's view.
 * @param {object} fest - The full fest object.
 * @param {string} houseId - The ID of the current house.
 * @param {boolean} isRegistrationOpen - The registration status of the fest.
 */
window. displayHouseGroupsList=(fest, houseId, isRegistrationOpen)=> {
    const container = document.getElementById('house-groups-list-container');
    fest = state.managingFest;
    // --- DEBUGGING LOG --- Let's check the parameters being used for filtering
    console.log("Refreshing group list with Fest ID:", fest.id, "and House ID:", houseId);
    console.log(festGroups);
    const groupsInHouse = festGroups.filter(g => g.festId === fest.id && g.houseId === houseId).sort((a,b) => a.name.localeCompare(b.name));

    if (groupsInHouse.length === 0) {
        container.innerHTML = '<p class="text-muted text-center p-4">No groups have been created for this house yet. Click "Create New Group" to start.</p>';
        return;
    }

    container.innerHTML = `<div class="accordion accordion-flush" id="house-groups-accordion">${groupsInHouse.map(group => {
        const groupEventIds = new Set();
        group.members.forEach(member => {
            const reg = festRegistrations.find(r => r.studentId === member.studentId && r.festId === fest.id);
            reg?.events.forEach(eventId => {
                const event = festEvents.find(e => e.id === eventId);
                if (event?.isGroupEvent) { groupEventIds.add(event.name); }
            });
        });
        const registeredEvents = Array.from(groupEventIds);

        return `
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${group.id}">
                    ${group.name} 
                    <span class="badge bg-primary ms-2">${group.members?.length || 0} members</span>
                </button>
            </h2>
            <div id="collapse-${group.id}" class="accordion-collapse collapse" data-bs-parent="#house-groups-accordion">
                <div class="accordion-body">
                    <p class="small mb-2">
                        <strong>Registered for:</strong> 
                        ${registeredEvents.length > 0 ? registeredEvents.map(name => `<span class="badge bg-secondary me-1">${name}</span>`).join('') : '<span class="text-muted">No group events yet.</span>'}
                    </p>
                    <ul class="list-group list-group-flush">
                        ${group.members?.map(member => {
                            const student = students.find(s => s.id === member.studentId);
                            return `<li class="list-group-item py-1 d-flex justify-content-between align-items-center">
                                <span>
                                    ${student?.name || 'Unknown'} 
                                    <small class="text-muted">(${getStudentClassName(student?.classId, student?.division)})</small> - 
                                    <span class="badge bg-light text-dark">${member.role}</span>
                                </span>
                                <button class="btn btn-xs btn-outline-danger py-0 px-2" onclick="removeStudentFromGroup('${group.id}', '${member.studentId}')" ${!isRegistrationOpen ? 'disabled' : ''} title="Remove Member">&times;</button>
                            </li>`;
                        }).join('') || '<li>No members yet.</li>'}
                    </ul>
                    
                    <div class="text-end border-top pt-2 mt-2">
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="window.openGroupBuilderModal('${group.id}', '${fest.id}', '${houseId}')" ${!isRegistrationOpen ? 'disabled' : ''}>
                            <i class="fas fa-edit me-1"></i>Manage Group
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="window.deleteHouseGroupAndRefresh('${group.id}')" ${!isRegistrationOpen ? 'disabled' : ''}>
                            Delete Group
                        </button>
                    </div>
                </div>
            </div>
        </div>`;
    }).join('')}</div>`;
}
/**
 * NEW: A dedicated function to delete a group and refresh the UI correctly.
 */
window.deleteHouseGroupAndRefresh = async (groupId) => {
    const group = festGroups.find(g => g.id === groupId);
    if (!group) return;

    if (confirm(`Are you sure you want to delete the group "${group.name}"?`)) {
        try {
            await deleteDoc(getDocRef('festGroups', groupId));
            showAlert('Group deleted successfully.', 'success');
            
            // This is the refresh part. It redraws the group management tab.
            const fest = state.managingFest;
            const isRegistrationOpen = fest.registrationOpen === true;
            renderHouseGroupManagementTab(fest, group.houseId, isRegistrationOpen);

        } catch (error) {
            console.error("Error deleting group:", error);
            showAlert('Failed to delete group.', 'danger');
        }
    }
}
/**
 * Renders the list of registered participants for the house, filtered by event.
 * This version correctly handles both SOLO and GROUP events, sorting them alphabetically,
 * and listing all members for group entries.
 * @param {string} [filterEventId='all'] - The ID of the event to filter by, or 'all'.
 */
function renderHouseRegisteredList(filterEventId = 'all') {
    const listContainer = document.getElementById('house-registered-list');
    const fest = state.managingFest;
    // This line is a bit complex but gets the house ID from the page's H1 title. It's kept from your original code.
    const houseId = festHouses.find(h => h.name === document.querySelector('#house-registration-view h1 .badge').textContent.split(' - ')[0])?.id;
    
    if (!fest || !houseId) {
        listContainer.innerHTML = '<p class="text-danger">Could not identify the current house or fest.</p>';
        return;
    }

    const registrationsInHouse = festRegistrations.filter(r => r.festId === fest.id && r.houseId === houseId);
    const isRegistrationOpen = fest.registrationOpen === true;

    // 1. Get and alphabetically sort the events to display.
    const eventsToDisplay = (filterEventId === 'all') 
        ? festEvents.filter(e => e.festId === fest.id).sort((a, b) => a.name.localeCompare(b.name))
        : festEvents.filter(e => e.id === filterEventId);

    if (registrationsInHouse.length === 0 && filterEventId === 'all') {
        listContainer.innerHTML = '<p class="text-muted">No participants have been registered from your house yet.</p>';
        return;
    }

    let content = '';
    let foundAnyParticipants = false;

    eventsToDisplay.forEach(event => {
        let participantsContent = '';
        let participantCount = 0;

        // 2. Check if the event is a group event or a solo event.
        if (event.isGroupEvent) {
            // --- LOGIC FOR GROUP EVENTS ---
            const participatingGroups = [];
            const groupsInHouse = festGroups.filter(g => g.festId === fest.id && g.houseId === houseId);
            
            // Find which groups from this house are registered for this event.
            groupsInHouse.forEach(group => {
                const isParticipating = group.members.some(member =>
                    registrationsInHouse.some(reg => reg.studentId === member.studentId && reg.events.includes(event.id))
                );
                if (isParticipating) {
                    participatingGroups.push(group);
                }
            });
            
            participantCount = participatingGroups.length;

            if (participantCount > 0) {
                foundAnyParticipants = true;
                // Sort groups alphabetically by name
                participatingGroups.sort((a,b) => a.name.localeCompare(b.name));

                participantsContent = participatingGroups.map(group => {
                    // Create a nested list of members with their class info
                    const membersHtml = group.members.map(member => {
                        const student = students.find(s => s.id === member.studentId);
                        return `<li>${student.name} <small class="text-muted">(${getStudentClassName(student?.classId, student?.division)})</small></li>`;
                    }).join('');

                    return `
                        <li class="list-group-item">
                            <strong>${group.name}</strong> (Group)
                            <ul class="list-unstyled ps-3 pt-1 small">
                                ${membersHtml}
                            </ul>
                        </li>
                    `;
                }).join('');
            }

        } else {
            // --- LOGIC FOR SOLO EVENTS (Your original logic, slightly refined) ---
            const participants = registrationsInHouse.filter(r => r.events.includes(event.id));
            participantCount = participants.length;

            if (participantCount > 0) {
                foundAnyParticipants = true;
                // Sort participants by chest number or name
                participants.sort((a, b) => (a.chestNo || a.studentName).localeCompare(b.chestNo || b.studentName));
                
                participantsContent = participants.map(p => {
                    const student = students.find(s => s.id === p.studentId);
                    return `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <strong>${p.chestNo || 'N/A'}:</strong> ${p.studentName}
                                <small class="text-muted ms-2">(${getStudentClassName(student?.classId, student?.division)})</small>
                            </span>
                            ${isRegistrationOpen ? `
                                <button class="btn btn-sm btn-outline-primary py-0 px-2" onclick="window.editParticipantFromReport('${p.studentId}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            ` : ''}
                        </li>
                    `;
                }).join('');
            }
        }
        
        // 3. Render the event card only if there are participants for it.
        if (participantCount > 0) {
             content += `
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <h6 class="text-primary mb-0">${event.name} (${event.category})</h6>
                    <span class="badge bg-secondary rounded-pill">${participantCount} ${event.isGroupEvent ? 'Group(s)' : 'Participant(s)'}</span>
                </div>
                <ul class="list-group mt-2">
                    ${participantsContent}
                </ul>
            `;
        }
    });
    
    // 4. Set the final HTML content.
    if (foundAnyParticipants) {
        listContainer.innerHTML = content;
    } else {
        listContainer.innerHTML = '<p class="text-muted">No participants registered for the selected event(s).</p>';
    }
}

/**
 * NEW HELPER FUNCTION: Finds a student in the registration tab and opens the event modal for them.
 * This allows editing directly from the "View Registrations" report.
 * @param {string} studentId - The ID of the student to edit.
 */
window.editParticipantFromReport = (studentId) => {
    // 1. Switch back to the "Register Participants" tab
    const registerTabButton = document.getElementById('register-tab');
    if (registerTabButton) {
        new bootstrap.Tab(registerTabButton).show();
    }

    // 2. Find the student's row in the registration table
    const registrationTable = document.getElementById('house-reg-table');
    const studentRow = registrationTable.querySelector(`tr[data-studentid="${studentId}"]`);

    if (studentRow) {
        // 3. Scroll to the student's row and open the modal
        studentRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Highlight the row briefly to give user context
        studentRow.style.backgroundColor = '#d1e7dd';
        setTimeout(() => {
            studentRow.style.backgroundColor = '';
        }, 2000);

        // 4. Trigger the "Manage Events" button click to open the modal
        const manageButton = studentRow.querySelector('.manage-events-btn');
        if (manageButton) {
            manageButton.click();
        }
    } else {
        showAlert('Could not find the student in the registration list. Try clearing the search filter.', 'warning');
    }
};
/**
 * Saves a single student's registration from the house entry page.
 * @param {string} festId - The ID of the fest.
 * @param {string} houseId - The ID of the house.
 * @param {HTMLElement} tableRow - The <tr> element of the student to save.
 */
async function saveSingleHouseRegistration(festId, houseId, tableRow) {
    const studentId = tableRow.dataset.studentid;
    const eventIds = tableRow.dataset.events ? tableRow.dataset.events.split(',') : [];
    const student = students.find(s => s.id === studentId);
    const saveButton = tableRow.querySelector('.save-single-reg-btn');

    if (!student) {
        showAlert('Could not find student to save.', 'danger');
        return;
    }

    saveButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
    saveButton.disabled = true;

    const regId = `${festId}_${studentId}`;
    const regData = {
        id: regId, festId, studentId,
        studentName: student.name, houseId, events: eventIds,
        chestNo: festRegistrations.find(r => r.id === regId)?.chestNo || null
    };

    try {
        await setDoc(getDocRef('festRegistrations', regId), regData);
        saveButton.innerHTML = `<i class="fas fa-check"></i>`; // Show success icon
        setTimeout(() => {
            saveButton.innerHTML = `<i class="fas fa-save"></i>`; // Revert after a delay
            saveButton.disabled = false;
        }, 2000);
    } catch (error) {
        showAlert('Error saving registration.', 'danger');
        saveButton.innerHTML = `<i class="fas fa-save"></i>`; // Revert on error
        saveButton.disabled = false;
    }
}

/**
 * Generates and downloads a PDF report for the house's filtered participants.
 * @param {object} fest - The full fest object.
 * @param {string} houseId - The ID of the house.
 */
/**
 * Generates and downloads a PDF report for the house's filtered participants,
 * now correctly creating a multi-table document.
 * @param {object} fest - The full fest object.
 * @param {string} houseId - The ID of the house.
 */
function downloadHouseReportPDF(fest, houseId) {
    // 1. Get the same filtered data as the view
    const filterEventId = document.getElementById('house-event-filter').value;
    const registrationsInHouse = festRegistrations.filter(r => r.festId === fest.id && r.houseId === houseId);
    
    let participantsToDisplay = registrationsInHouse;
    if (filterEventId !== 'all') {
        participantsToDisplay = registrationsInHouse.filter(r => r.events.includes(filterEventId));
    }

    if (participantsToDisplay.length === 0) {
        showAlert('No report data to download.', 'warning');
        return;
    }

    const house = festHouses.find(h => h.id === houseId);
    const reportTitle = `${house.name} - Participant List`;
    const subTitle = `Fest: ${fest.name}`;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // --- Add Main Header ---
    doc.setFontSize(18);
    doc.text(reportTitle, 14, 22);
    doc.setFontSize(12);
    doc.text(subTitle, 14, 29);
    let startY = 35; // Initial Y position for the first table

    // --- 2. Loop through events and create a table for each one ---
    const eventsToDisplay = (filterEventId === 'all') 
        ? festEvents.filter(e => e.festId === fest.id).sort((a, b) => a.name.localeCompare(b.name))
        : festEvents.filter(e => e.id === filterEventId);

    eventsToDisplay.forEach(event => {
        const participantsInEvent = participantsToDisplay.filter(r => r.events.includes(event.id));
        
        if (participantsInEvent.length > 0) {
            // Add a header for the event
            doc.setFontSize(14);
            doc.setTextColor(60); // Dark gray
            doc.text(`${event.name} (${event.category})`, 14, startY);
            startY += 7;

            // Prepare table data for this event
            const head = [['Chest No.', 'Admission No.', 'Name', 'Class']];
            const body = participantsInEvent.map(p => {
                const student = students.find(s => s.id === p.studentId);
                return [
                    p.chestNo || 'N/A',
                    student?.admissionNumber || 'N/A',
                    p.studentName,
                    getStudentClassName(student?.classId, student?.division)
                ];
            });

            // Create the table
            doc.autoTable({
                head: head,
                body: body,
                startY: startY,
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185] } // Blue header
            });

            // Update the startY for the next table, adding a margin
            startY = doc.autoTable.previous.finalY + 15;
        }
    });

    doc.save(`${house.name}_Participants.pdf`);
}
/**
 * A specific save function for the house data entry page.
 * @param {string} festId - The ID of the fest.
 * @param {string} houseId - The ID of the house.
 */
async function saveHouseRegistrationsFromEntryPage(festId, houseId) {
    const rows = document.querySelectorAll('#house-reg-table tbody tr');
    const batch = writeBatch(db);
    let validCount = 0;

    rows.forEach(row => {
        const studentId = row.dataset.studentid;
        const eventIds = row.dataset.events ? row.dataset.events.split(',') : [];
        const student = students.find(s => s.id === studentId);

        if (student) {
            const regId = `${festId}_${studentId}`;
            const regData = {
                id: regId, festId, studentId,
                studentName: student.name, houseId, events: eventIds,
                chestNo: festRegistrations.find(r => r.id === regId)?.chestNo || null
            };
            batch.set(getDocRef('festRegistrations', regId), regData);
            validCount++;
        }
    });

    if (validCount > 0) {
        try {
            await batch.commit();
            showAlert('Your registrations have been saved successfully!', 'success');
        } catch (error) {
            showAlert('An error occurred while saving.', 'danger');
        }
    } else {
        showAlert('No participants to save.', 'info');
    }
}
function renderGroupCard(group, fest) {
    const captain = group.members.find(m => m.role === 'Captain');
    const captainName = students.find(s => s.id === captain?.studentId)?.name || 'N/A';
    const registeredEvents = [...new Set(
        festRegistrations.filter(r => group.members.some(m => m.studentId === r.studentId))
                         .flatMap(r => r.events)
                         .map(eventId => festEvents.find(e => e.id === eventId && e.isGroupEvent))
                         .filter(Boolean)
                         .map(e => e.name)
    )];

    return `
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="card-title">${group.name}</h6>
                        <p class="card-subtitle mb-2 text-muted small">Captain: ${captainName}</p>
                        <p class="card-text small"><strong>Members:</strong> ${group.members.length}</p>
                        <p class="card-text small"><strong>Registered for:</strong> 
                            ${registeredEvents.length > 0 ? registeredEvents.map(name => `<span class="badge bg-secondary me-1">${name}</span>`).join('') : '<span class="text-muted">No group events yet.</span>'}
                        </p>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="openGroupBuilderModal('${group.id}', '${fest.id}', '${group.houseId}')"><i class="fas fa-users-cog me-1"></i> Manage Members</button>
                        <button class="btn btn-sm btn-outline-primary" onclick="openGroupEventRegistrationModal('${group.id}', '${fest.id}')"><i class="fas fa-calendar-check me-1"></i> Register for Events</button>
                    </div>
                </div>
            </div>
        </div>`;
}

/**
 * Opens a modal window to create/edit a group, with live student search
 * and a category filter for event registration.
 * @param {string|null} groupId - The ID of the group to edit, or null to create a new one.
 * @param {string} festId - The ID of the active fest.
 * @param {string} houseId - The ID of the house this group belongs to.
 */
/**
 * Opens a modal window to create/edit a group, allowing students to be in multiple groups.
 * @param {string|null} groupId - The ID of the group to edit, or null to create a new one.
 * @param {string} festId - The ID of the active fest.
 * @param {string} houseId - The ID of the house this group belongs to.
 */
/**
 * Opens a modal window to create/edit a group with a new, more intuitive
 * click-to-add and remove interface for member selection.
 */
/**
 * Opens a modal window to create/edit a group, now with category filters for both students and events.
 * @param {string|null} groupId - The ID of the group to edit, or null to create a new one.
 * @param {string} festId - The ID of the active fest.
 * @param {string} houseId - The ID of the house this group belongs to.
 */
window. openGroupBuilderModal=(groupId, festId, houseId)=> {
    const isEditMode = groupId !== null;
    const group = isEditMode ? festGroups.find(g => g.id === groupId) : null;
    const fest = fests.find(f => f.id === festId);
    
    // --- 1. Prepare Data for the Modal ---
    const studentsInHouse = students.filter(s => s.houseId === houseId);
    const categoryOptions = ['General', ...(fest.settings?.categories?.map(c => c.name) || [])]
        .map(cat => `<option value="${cat}">${cat}</option>`).join('');

    // --- 2. Create the Modal UI ---
    const modal = showModal({
        title: isEditMode ? `Edit Group: ${group.name}` : 'Create New Group',
        body: `
            <div class="row">
                <div class="col-md-5 border-end">
                    <h6 class="mb-3">1. Select Members from Your House</h6>
                    
                    <div class="mb-2">
                        <label for="group-student-category-filter" class="form-label">Filter by Category</label>
                        <select id="group-student-category-filter" class="form-select">
                            <option value="all">All Students in House</option>
                            ${categoryOptions}
                        </select>
                    </div>
                    
                    <input type="text" id="group-member-search" class="form-control mb-2" placeholder="Search by name or admn no...">
                    <div id="group-student-list-container" class="list-group" style="max-height: 350px; overflow-y: auto;">
                        </div>
                </div>
                <div class="col-md-7">
                    <h6 class="mb-3">2. Name Group & Assign Roles</h6>
                    <div class="mb-3"><label class="form-label">Group Name</label><input type="text" id="group-builder-name" class="form-control" value="${group?.name || ''}"></div>
                    <p class="form-label">Selected Members (<span id="group-builder-count">0</span>)</p>
                    <ul id="group-builder-list" class="list-group mb-3" style="max-height: 150px; overflow-y: auto;"></ul>
                    
                    <h6 class="mb-3">3. Assign to Group Events</h6>
                    <div class="mb-2"><label for="group-event-category-filter" class="form-label">Filter Events by Category</label><select id="group-event-category-filter" class="form-select"><option value="all">All</option>${categoryOptions}</select></div>
                    <select id="group-events-select" class="form-select" multiple size="4"></select>
                </div>
            </div>
        `,
        footer: `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                 <button type="button" id="group-builder-save-btn" class="btn btn-primary">${isEditMode ? 'Update Group' : 'Create & Register Group'}</button>`
    });

    // --- 3. Get References to Dynamic Elements ---
    const searchInput = document.getElementById('group-member-search');
    const studentCategoryFilter = document.getElementById('group-student-category-filter');
    const studentListContainer = document.getElementById('group-student-list-container');
    const saveButton = document.getElementById('group-builder-save-btn');
    const eventCategoryFilter = document.getElementById('group-event-category-filter');
    const eventsSelect = document.getElementById('group-events-select');
    
    let selectedStudentIds = new Set(group?.members.map(m => m.studentId) || []);

    // --- 4. Define Helper Functions for the Modal ---

    const updateBuilderUI = () => {
        const builderList = document.getElementById('group-builder-list');
        document.getElementById('group-builder-count').textContent = selectedStudentIds.size;

        if (selectedStudentIds.size === 0) {
            builderList.innerHTML = '<li class="list-group-item text-muted">Click a student from the left to add them.</li>';
            return;
        }
        builderList.innerHTML = Array.from(selectedStudentIds).map(studentId => {
            const student = students.find(s => s.id === studentId);
            const className = getStudentClassName(student.classId, student.division); // Helper to get full class name
            const currentMember = group?.members.find(m => m.studentId === studentId);
            return `
                <li class="list-group-item d-flex justify-content-between align-items-center py-1">
                    <span>${student.name}( ${className})</span>
                    <div>
                        <select class="form-select form-select-sm d-inline-block w-auto me-2 group-member-role" data-studentid="${student.id}">
                            <option value="Member" ${currentMember?.role === 'Member' ? 'selected' : ''}>Member</option>
                            <option value="Captain" ${currentMember?.role === 'Captain' ? 'selected' : ''}>Captain</option>
                        </select>
                        <button class="btn btn-sm btn-outline-danger py-0 px-1 remove-member-btn" data-student-id="${student.id}">&times;</button>
                    </div>
                </li>`;
        }).join('');
    };
    
    const updateEventList = () => {
        const selectedCategory = studentCategoryFilter.value;
        const groupEvents = festEvents.filter(e => e.festId === festId && e.isGroupEvent && (selectedCategory === 'all' || e.category === selectedCategory));
        const firstMemberReg = festRegistrations.find(r => r.studentId === group?.members[0]?.studentId);
        const registeredEventIds = new Set(firstMemberReg?.events || []);
        eventsSelect.innerHTML = groupEvents.map(e => `<option value="${e.id}" ${registeredEventIds.has(e.id) ? 'selected' : ''}>${e.name}</option>`).join('') || '<option disabled>No events in category.</option>';
    };
    const renderStudentList = () => {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedStudentCategory = studentCategoryFilter.value;
        const studentsInOtherGroups = new Set(festGroups.filter(g => g.festId === festId && g.id !== groupId).flatMap(g => g.members.map(m => m.studentId)));
        
        let filteredStudents = studentsInHouse;

        // Apply category filter first
        if (selectedStudentCategory !== 'all') {
            filteredStudents = filteredStudents.filter(s => getStudentCategory(s) === selectedStudentCategory);
        }

        // Then apply search filter
        if (searchTerm) {
            filteredStudents = filteredStudents.filter(s => s.name.toLowerCase().includes(searchTerm) || String(s.admissionNumber || "").toLowerCase().includes(searchTerm));
        }

        studentListContainer.innerHTML = filteredStudents
    .filter(s => !selectedStudentIds.has(s.id)) // Exclude already selected students
    .map(student => {
        const isDisabled = studentsInOtherGroups.has(student.id);
        const className = getStudentClassName(student.classId, student.division); // Helper to get full class name

        return `
            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-2 ${isDisabled ? 'disabled' : ''}" data-student-id="${student.id}">
                <div>
                    <strong>${student.name}</strong>
                    <small class="text-muted d-block">${className} | Admn No: ${student.admissionNumber || 'N/A'}</small>
                </div>
                ${isDisabled ? '<span class="badge bg-secondary ms-2">In another group</span>' : ''}
            </a>`;
    }).join('');

};

    // --- 5. Attach Listeners and Make Initial Calls ---
    
    // Add student
    studentListContainer.addEventListener('click', e => {
        e.preventDefault();
        const link = e.target.closest('.list-group-item');
        if (link && !link.classList.contains('disabled')) {
            selectedStudentIds.add(link.dataset.studentId);
            renderStudentList();
            updateBuilderUI();
        }
    });

    // Remove student
    document.getElementById('group-builder-list').addEventListener('click', e => {
        const button = e.target.closest('.remove-member-btn');
        if (button) {
            selectedStudentIds.delete(button.dataset.studentId);
            renderStudentList();
            updateBuilderUI();
        }
    });
    
    searchInput.addEventListener('input', renderStudentList);
    studentCategoryFilter.addEventListener('change', renderStudentList);
    eventCategoryFilter.addEventListener('change', updateEventList);
    saveButton.addEventListener('click', () => saveGroupFromBuilder(groupId, festId, houseId, document.getElementById('dynamic-app-modal')));
    
    renderStudentList();
    updateBuilderUI();
    updateEventList();
}
window. openGroupBuilderModaloldt=(groupId, festId, houseId)=> {
    const isEditMode = groupId !== null;
    const group = isEditMode ? festGroups.find(g => g.id === groupId) : null;
    const fest = fests.find(f => f.id === festId);
    
    // Get all students in the house to start with
    const studentsInHouse = students.filter(s => s.houseId === houseId);
    const categoryOptions = ['General', ...(fest.settings?.categories?.map(c => c.name) || [])]
        .map(cat => `<option value="${cat}">${cat}</option>`).join('');

    const modal = showModal({
        title: isEditMode ? `Edit Group: ${group.name}` : 'Create New Group',
        body: `
            <div class="row">
                <div class="col-md-5 border-end">
                    <h6 class="mb-3">1. Available Students (Click to add)</h6>
                    <input type="text" id="group-member-search" class="form-control mb-2" placeholder="Search by name or admn no...">
                    <div id="group-available-list" class="list-group" style="max-height: 350px; overflow-y: auto;">
                        </div>
                </div>
                <div class="col-md-7">
                    <h6 class="mb-3">2. Group Details</h6>
                    <div class="mb-3"><label class="form-label">Group Name</label><input type="text" id="group-builder-name" class="form-control" value="${group?.name || ''}"></div>
                    <p class="form-label">Selected Members (<span id="group-builder-count">0</span>)</p>
                    <ul id="group-builder-list" class="list-group mb-3" style="max-height: 150px; overflow-y: auto;"></ul>
                    
                    <h6 class="mb-3">3. Assign to Group Events</h6>
                    <div class="mb-2"><label for="group-event-category-filter" class="form-label">Filter by Category</label><select id="group-event-category-filter" class="form-select"><option value="all">All</option>${categoryOptions}</select></div>
                    <select id="group-events-select" class="form-select" multiple size="4"></select>
                </div>
            </div>
        `,
        footer: `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                 <button type="button" id="group-builder-save-btn" class="btn btn-primary">${isEditMode ? 'Update Group' : 'Create & Register Group'}</button>`
    });

    // --- Get References to Dynamic Elements ---
    const searchInput = document.getElementById('group-member-search');
    const availableList = document.getElementById('group-available-list');
    const selectedList = document.getElementById('group-builder-list');
    const saveButton = document.getElementById('group-builder-save-btn');
    const categoryFilter = document.getElementById('group-event-category-filter');
    const eventsSelect = document.getElementById('group-events-select');
    
    let selectedStudentIds = new Set(group?.members.map(m => m.studentId) || []);

    // --- Define Helper Functions for the Modal ---

    const renderLists = () => {
        const searchTerm = searchInput.value.toLowerCase();
        
        // Render Available Students
        availableList.innerHTML = studentsInHouse
            .filter(s => !selectedStudentIds.has(s.id) && (s.name.toLowerCase().includes(searchTerm) || String(s.admissionNumber).includes(searchTerm)))
            .map(student => `<a href="#" class="list-group-item list-group-item-action py-2" data-student-id="${student.id}">${student.name}</a>`)
            .join('');

        // Render Selected Students
        document.getElementById('group-builder-count').textContent = selectedStudentIds.size;
        if (selectedStudentIds.size === 0) {
            selectedList.innerHTML = '<li class="list-group-item text-muted">Click a student from the left to add them.</li>';
        } else {
            selectedList.innerHTML = Array.from(selectedStudentIds).map(studentId => {
                const student = students.find(s => s.id === studentId);
                const currentMember = group?.members.find(m => m.studentId === studentId);
                return `
                    <li class="list-group-item d-flex justify-content-between align-items-center py-1">
                        <span>${student.name}</span>
                        <div>
                            <select class="form-select form-select-sm d-inline-block w-auto me-2 group-member-role" data-studentid="${student.id}">
                                <option value="Member" ${currentMember?.role === 'Member' ? 'selected' : ''}>Member</option>
                                <option value="Captain" ${currentMember?.role === 'Captain' ? 'selected' : ''}>Captain</option>
                            </select>
                            <button class="btn btn-sm btn-outline-danger py-0 px-1 remove-member-btn" data-student-id="${student.id}">&times;</button>
                        </div>
                    </li>`;
            }).join('');
        }
    };

    const updateEventList = () => {
        const selectedCategory = categoryFilter.value;
        const groupEvents = festEvents.filter(e => e.festId === festId && e.isGroupEvent && (selectedCategory === 'all' || e.category === selectedCategory));
        const firstMemberReg = festRegistrations.find(r => r.studentId === group?.members[0]?.studentId);
        const registeredEventIds = new Set(firstMemberReg?.events || []);
        eventsSelect.innerHTML = groupEvents.map(e => `<option value="${e.id}" ${registeredEventIds.has(e.id) ? 'selected' : ''}>${e.name}</option>`).join('') || '<option disabled>No events in category.</option>';
    };

    // --- Attach Listeners and Make Initial Calls ---
    
    // Add student
    availableList.addEventListener('click', e => {
        e.preventDefault();
        const link = e.target.closest('.list-group-item');
        if (link) {
            selectedStudentIds.add(link.dataset.studentId);
            renderLists();
        }
    });

    // Remove student
    selectedList.addEventListener('click', e => {
        const button = e.target.closest('.remove-member-btn');
        if (button) {
            selectedStudentIds.delete(button.dataset.studentId);
            renderLists();
        }
    });
    
    searchInput.addEventListener('input', renderLists);
    categoryFilter.addEventListener('change', updateEventList);
    saveButton.addEventListener('click', () => saveGroupFromBuilder(groupId, festId, houseId, modal));
    
    renderLists();
    updateEventList();
}

/**
 * Handles the logic for saving a group and registering its members for events.
 * This version now correctly refreshes the group list on success.
 */
async function saveGroupFromBuilder(groupId, festId, houseId, modal) {
    const isEditMode = groupId !== null;
    const groupName = document.getElementById('group-builder-name').value.trim();
    const memberElements = document.querySelectorAll('#group-builder-list .group-member-role');
    const selectedGroupEventIds = Array.from(document.getElementById('group-events-select').selectedOptions).map(opt => opt.value);
    
    // 1. Validate the input
    if (!groupName) return showAlert('Please enter a group name.', 'warning');
    if (memberElements.length === 0) return showAlert('Please select at least one member.', 'warning');
    const hasCaptain = Array.from(memberElements).some(el => el.value === 'Captain');
    if (!hasCaptain) return showAlert('Each group must have one Captain.', 'warning');
    if (selectedGroupEventIds.length === 0) return showAlert('Please select at least one group event.', 'warning');

    // 2. Prepare the data for saving
    const members = Array.from(memberElements).map(el => ({ studentId: el.dataset.studentid, role: el.value }));
    const newGroupId = isEditMode ? groupId : `GRP_${Date.now()}`;
    const groupData = { id: newGroupId, name: groupName, festId, houseId, members };

    const batch = writeBatch(db);
    
    // Action A: Save the group document itself
    batch.set(getDocRef('festGroups', newGroupId), groupData);

    // Action B: Update the registration for each group member
    for (const member of members) {
        const student = students.find(s => s.id === member.studentId);
        if (!student) continue;
        
        const regId = `${festId}_${student.id}`;
        const existingReg = festRegistrations.find(r => r.id === regId);
        
        const soloEvents = existingReg?.events.filter(id => !festEvents.find(e => e.id === id)?.isGroupEvent) || [];
        const newEvents = [...new Set([...soloEvents, ...selectedGroupEventIds])];

        const registrationData = {
            id: regId, festId, studentId: student.id, studentName: student.name, 
            houseId: houseId, events: newEvents,
            chestNo: existingReg?.chestNo || null
        };
        batch.set(getDocRef('festRegistrations', regId), registrationData, { merge: true });
    }

    // 3. Commit the changes and update the UI
    try {
        await batch.commit();
        showAlert(`Group '${groupName}' was ${isEditMode ? 'updated' : 'created'} successfully!`, 'success');
        
        // --- THIS IS THE FIX ---
        // After saving, we re-render the entire registration pane to ensure all parts
        // of the UI (especially the group list) are up-to-date.
        const fest = state.managingFest;
        const studentsInHouse = students.filter(s => s.houseId === houseId);
        const isRegistrationOpen = fest.registrationOpen === true;
        renderRegisterPane(fest, houseId, studentsInHouse, isRegistrationOpen);
        
        bootstrap.Modal.getInstance(modal).hide();
        
    } catch (error) {
        console.error("Error saving group:", error);
        showAlert('Failed to save group.', 'danger');
    }
}
/**
 * Creates and displays a generic Bootstrap 5 modal dynamically.
 * @param {object} options - An object containing the modal's content.
 * @param {string} options.title - The text to display in the modal header.
 * @param {string} options.body - The HTML content for the modal's body.
 * @param {string} options.footer - The HTML for the buttons in the modal's footer.
 * @param {string} [options.size='modal-lg'] - The Bootstrap size class (e.g., 'modal-sm', 'modal-xl').
 * @returns {HTMLElement} The modal DOM element.
 */
function showModal({ title, body, footer, size = 'modal-lg' }) {
    // 1. Remove any existing modals to prevent conflicts
    const existingModal = document.getElementById('dynamic-app-modal');
    if (existingModal) {
        existingModal.remove();
    }

    // 2. Create the modal's HTML structure from scratch
    const modalHtml = `
        <div class="modal fade" id="dynamic-app-modal" tabindex="-1" aria-labelledby="dynamicModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered ${size}">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="dynamicModalLabel">${title}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        ${body}
                    </div>
                    <div class="modal-footer">
                        ${footer}
                    </div>
                </div>
            </div>
        </div>
    `;

    // 3. Add the new modal HTML to the document
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modalElement = document.getElementById('dynamic-app-modal');
    
    // 4. Create and show the Bootstrap modal instance
    const bsModal = new bootstrap.Modal(modalElement);
    
    // 5. Add an event listener to automatically remove the modal from the DOM after it's hidden
    modalElement.addEventListener('hidden.bs.modal', () => {
        modalElement.remove();
    });

    bsModal.show();
    
    // 6. Return the modal element so other functions can interact with it if needed
    return modalElement;
}

/**
 * Handles the logic for saving a group from the builder modal.
 */
async function saveGroupFromBuilderOLD(groupId, festId, houseId, modal) {
    const isEditMode = groupId !== null;
    const groupName = document.getElementById('group-builder-name').value.trim();
    const memberElements = document.querySelectorAll('#group-builder-list .group-member-role');
    
    if (!groupName) return showAlert('Please enter a group name.', 'warning');
    if (memberElements.length === 0) return showAlert('Please select at least one member.', 'warning');
    const hasCaptain = Array.from(memberElements).some(el => el.value === 'Captain');
    if (!hasCaptain) return showAlert('Each group must have one Captain.', 'warning');

    const members = Array.from(memberElements).map(el => ({
        studentId: el.dataset.studentid,
        role: el.value
    }));
    
    const newGroupId = isEditMode ? groupId : `GRP_${Date.now()}`;
    const groupData = { id: newGroupId, name: groupName, festId, houseId, members };

    try {
        await setDoc(getDocRef('festGroups', newGroupId), groupData);
        showAlert(`Group '${groupName}' was ${isEditMode ? 'updated' : 'created'} successfully!`, 'success');
        bootstrap.Modal.getInstance(modal).hide();
    } catch (error) {
        console.error("Error saving group:", error);
        showAlert('Failed to save group.', 'danger');
    }
}

/**
 * Renders the initial screen to choose a fest.
 */
/**
 * Renders the initial screen to choose a fest, now with an inline form to create a new one.
 */
function renderFestSelectionScreen() {
    const mainContent = document.getElementById('main-content');
    mainContent.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2 fw-bold mb-0">Fest Management</h1>
            <button id="toggle-fest-form-btn" class="btn btn-primary" onclick="window.toggleNewFestForm()">
                <i class="fas fa-plus me-2"></i>Create New Fest / Meet
            </button>
        </div>

        <div id="new-fest-form-container" class="ui-card p-4 mb-4 d-none">
            <h5 id="fest-form-title" class="section-header">Create New Fest / Sports Meet</h5>
            <form id="add-fest-form">
                <div class="row g-3 align-items-end">
                    <div class="col-md-5">
                        <label for="new-fest-name" class="form-label">Name</label>
                        <input type="text" id="new-fest-name" class="form-control" placeholder="e.g., Annual Sports Meet 2025" required>
                    </div>
                    <div class="col-md-4">
                        <label for="new-fest-type" class="form-label">Type</label>
                        <select id="new-fest-type" class="form-select" required>
                            <option value="Arts">Arts Fest</option>
                            <option value="Sports">Sports Meet</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-grid">
                        <button type="button" id="save-new-fest-btn" class="btn btn-success">Save Fest</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="ui-card p-4">
            <h5 class="section-header"><i class="fas fa-trophy me-2"></i>Select a Fest to Manage</h5>
            <p class="text-muted">Choose a fest to configure its settings, events, participants, and scoring.</p>
            ${fests.length === 0 ? `<div class="alert alert-warning">No fests have been created yet. Click the button above to add one.</div>` : ''}
            
            <div class="row g-3 mt-3">
                ${fests.map(fest => `
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 fest-selection-card shadow-sm">
                            <div class="card-body text-center d-flex flex-column">
                                <i class="fas ${fest.eventType === 'Sports' ? 'fa-running' : 'fa-paint-brush'} fa-3x text-primary mb-3"></i>
                                <h5 class="card-title">${fest.name}</h5>
                                <p class="card-subtitle mb-2 text-muted">${fest.eventType}</p>
                                <div class="mt-auto">
                                    <button class="btn btn-primary" onclick="window.selectFestToManage('${fest.id}')">
                                        <i class="fas fa-cog me-2"></i>Manage
                                    </button>
                                    ${currentUserRole === 'admin' ? `
                                    <button class="btn btn-outline-secondary ms-2" onclick="window.editFestDetails('${fest.id}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

window.toggleNewFestForm = () => {
    const formContainer = document.getElementById('new-fest-form-container');
    const toggleBtn = document.getElementById('toggle-fest-form-btn');
    const formTitle = document.getElementById('fest-form-title');
    const saveBtn = document.getElementById('save-new-fest-btn');

    const isVisible = !formContainer.classList.contains('d-none');

    if (isVisible) {
        // If form is visible, hide it and reset everything
        formContainer.classList.add('d-none');
        toggleBtn.innerHTML = `<i class="fas fa-plus me-2"></i>Create New Fest / Meet`;
        toggleBtn.classList.replace('btn-secondary', 'btn-primary');
        
        // Reset form to "Create" mode
        state.festToEdit = null;
        formTitle.textContent = 'Create New Fest / Sports Meet';
        saveBtn.textContent = 'Save Fest';
        document.getElementById('add-fest-form').reset();

    } else {
        // If form is hidden, show it
        formContainer.classList.remove('d-none');
        toggleBtn.innerHTML = `<i class="fas fa-times me-2"></i>Cancel`;
        toggleBtn.classList.replace('btn-primary', 'btn-secondary');
        document.getElementById('new-fest-name').focus();
    }
};

/**
 * Loads a fest's data into the inline form for editing.
 * @param {string} festId The ID of the fest to edit.
 */
window.editFestDetails = (festId) => {
    const fest = fests.find(f => f.id === festId);
    if (!fest) {
        return showAlert('Could not find the fest to edit.', 'danger');
    }

    state.festToEdit = fest; // Set the fest being edited in the global state

    // Get form elements
    const formContainer = document.getElementById('new-fest-form-container');
    const toggleBtn = document.getElementById('toggle-fest-form-btn');
    const formTitle = document.getElementById('fest-form-title');
    const nameInput = document.getElementById('new-fest-name');
    const typeSelect = document.getElementById('new-fest-type');
    const saveBtn = document.getElementById('save-new-fest-btn');

    // Update form content for editing
    formTitle.textContent = `Edit: ${fest.name}`;
    nameInput.value = fest.name;
    typeSelect.value = fest.eventType;
    saveBtn.textContent = 'Update Changes';
    
    // Show the form if it's hidden
    if (formContainer.classList.contains('d-none')) {
        toggleNewFestForm();
    }

    // Scroll the form into view
    formContainer.scrollIntoView({ behavior: 'smooth' });
};

// Main event listener for the save button (handles both create and update)
document.addEventListener('click', async (e) => {
    if (e.target && e.target.id === 'save-new-fest-btn') {
        const nameInput = document.getElementById('new-fest-name');
        const typeSelect = document.getElementById('new-fest-type');
        const name = nameInput.value.trim();
        const eventType = typeSelect.value;

        if (!name) {
            return showAlert('Please enter a name for the fest/meet.', 'danger');
        }
        
        const isEditing = state.festToEdit !== null;
        const id = isEditing ? state.festToEdit.id : `${name.replace(/\s+/g, '_').toUpperCase()}_${Date.now()}`;
        const settings = isEditing ? state.festToEdit.settings : { /* default settings */ };

        const festData = {
            id: id,
            name: name,
            eventType: eventType,
            registrationOpen: isEditing ? state.festToEdit.registrationOpen : true, 
            settings: settings
        };

        try {
            await setDoc(getDocRef('fests', id), festData);
            showAlert(`'${name}' was ${isEditing ? 'updated' : 'created'} successfully!`, 'success');
            
            // Hide the form and reset the state
            toggleNewFestForm();

        } catch (error) {
            console.error("Error saving fest:", error);
            showAlert('Failed to save the fest. Please try again.', 'danger');
        }
    }
});







/**
 * Renders the main tabbed interface for the selected fest.
 */
function renderSelectedFestDashboard() {
    const mainContent = document.getElementById('main-content');
    if (!state.managingFest) return;

    mainContent.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2 fw-bold mb-0">Managing: <span class="text-primary">${state.managingFest.name}</span></h1>
            <button class="btn btn-sm btn-outline-secondary" onclick="window.unselectFest()">
                <i class="fas fa-arrow-left me-2"></i>Change Fest
            </button>
        </div>

        <ul class="nav nav-tabs" id="festMgtTab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#fest-dashboard" type="button"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fest-setup" type="button"><i class="fas fa-cogs me-2"></i>Setup</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fest-events" type="button"><i class="fas fa-calendar-check me-2"></i>Events</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fest-participants" type="button"><i class="fas fa-users-cog me-2"></i>Participants</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fest-scoring" type="button"><i class="fas fa-clipboard-list me-2"></i>Scoring</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#fest-reports" type="button"><i class="fas fa-print me-2"></i>Reports</button></li>
        </ul>
        <div class="tab-content card" id="festMgtTabContent">
            <div class="tab-pane fade show active p-4" id="fest-dashboard" role="tabpanel"></div>
            <div class="tab-pane fade p-4" id="fest-setup" role="tabpanel"></div>
            <div class="tab-pane fade p-4" id="fest-events" role="tabpanel"></div>
            <div class="tab-pane fade p-4" id="fest-participants" role="tabpanel"></div>
            <div class="tab-pane fade p-4" id="fest-scoring" role="tabpanel"></div>
            <div class="tab-pane fade p-4" id="fest-reports" role="tabpanel"></div>
        </div>
    `;

    // Render content for each tab
    renderFestDashboardTab();
    renderFestSetupTab();
    renderFestEventsTab();
    renderFestParticipantsTab();
    renderFestScoringTab();
    renderFestReportsTab();
}

// -------------------------------------------------------------------------
// --- 2. DASHBOARD TAB ---
// -------------------------------------------------------------------------

function renderFestDashboardTab() {
    const container = document.getElementById('fest-dashboard');
    if (!container || !state.managingFest) return;

    const festId = state.managingFest.id;
    const participantsCount = festRegistrations?.filter(r => r.festId === festId).length||0;
    const eventsForFest = festEvents?.filter(e => e.festId === festId)||[];
    const eventsCount = eventsForFest.length;
    const resultsEnteredCount = festResults?.filter(r => r.festId === festId).length||0;
    const resultsProgress = eventsCount > 0 ? Math.round((resultsEnteredCount / eventsCount) * 100) : 0;
    const housesCount = festHouses.length;

    container.innerHTML = `
        <h5 class="section-header">Fest Overview</h5>
        <div class="row g-4">
            <div class="col-md-6 col-xl-3"><div class="ui-card-stat h-100"><div class="stat-icon bg-primary"><i class="fas fa-users"></i></div><div class="stat-info"><div class="stat-number">${participantsCount}</div><div class="stat-label">Total Participants</div></div></div></div>
            <div class="col-md-6 col-xl-3"><div class="ui-card-stat h-100"><div class="stat-icon bg-info"><i class="fas fa-calendar-alt"></i></div><div class="stat-info"><div class="stat-number">${eventsCount}</div><div class="stat-label">Total Events</div></div></div></div>
            <div class="col-md-6 col-xl-3"><div class="ui-card-stat h-100"><div class="stat-icon bg-success"><i class="fas fa-flag-checkered"></i></div><div class="stat-info"><div class="stat-number">${housesCount}</div><div class="stat-label">Competing Houses</div></div></div></div>
            <div class="col-md-6 col-xl-3"><div class="ui-card-stat h-100"><div class="stat-icon bg-warning"><i class="fas fa-clipboard-check"></i></div><div class="stat-info"><div class="stat-number">${resultsProgress}%</div><div class="stat-label">Results Entered</div></div></div></div>
        </div>
        <hr class="my-4">
        <div class="row g-4">
            <div class="col-lg-7"><div class="ui-card h-100"><h5 class="section-header">Live House Standings</h5><div id="dashboard-house-rankings"></div></div></div>
            <div class="col-lg-5"><div class="ui-card h-100"><h5 class="section-header">Quick Actions</h5><div class="d-grid gap-3">
                <button class="btn btn-outline-primary" onclick="document.querySelector('[data-bs-target=\\'#fest-events\\']').click()"><i class="fas fa-plus-circle me-2"></i>Add or Manage Events</button>
                <button class="btn btn-outline-primary" onclick="document.querySelector('[data-bs-target=\\'#fest-participants\\']').click()"><i class="fas fa-user-plus me-2"></i>Register a Participant</button>
                <button class="btn btn-outline-primary" onclick="document.querySelector('[data-bs-target=\\'#fest-scoring\\']').click()"><i class="fas fa-marker me-2"></i>Enter Event Scores</button>
            </div></div></div>
        </div>
    `;
    renderDashboardHouseRankings(festId);
}

function renderDashboardHouseRankings(festId) {
    const container = document.getElementById('dashboard-house-rankings');
    if (!container) return;
    const { housePoints } = calculateFinalResults(festId);
    const sortedHouses = Object.entries(housePoints).sort(([, a], [, b]) => b - a);
    if (sortedHouses.length === 0 || sortedHouses.every(h => h[1] === 0)) {
        container.innerHTML = '<p class="text-muted">No points awarded yet.</p>';
        return;
    }
    const maxPoints = sortedHouses[0][1] || 1;
    container.innerHTML = sortedHouses.map(([houseId, points]) => {
        const house = festHouses.find(h => h.id === houseId);
        const percentage = (points / maxPoints) * 100;
        return `<div class="mb-3"><div class="d-flex justify-content-between"><strong>${house?.name || 'Unknown'}</strong><span>${points} pts</span></div><div class="progress" style="height: 10px;"><div class="progress-bar" role="progressbar" style="width: ${percentage}%; background-color:${house?.color || '#6c757d'};"></div></div></div>`;
    }).join('');
}

// -------------------------------------------------------------------------
// --- 3. SETUP TAB ---
// -------------------------------------------------------------------------

function renderFestSetupTab() {
    const container = document.getElementById('fest-setup');
    if (!container || !state.managingFest) return;
    const activeSettings = state.managingFest.settings || { maxEventsPerStudent: 3, houseEventLimits: { solo: 2, group: 1 }, categories: [] };
    container.innerHTML = `
        <div class="row g-4">
            <div class="col-lg-5">
                <div class="ui-card h-100">
                    <h5 class="section-header"><i class="fas fa-flag-checkered me-2"></i>Manage Houses</h5>
                    <p class="text-muted small">Houses are available globally across all fests.</p>
                    <form id="house-form" class="mb-4">
                        <div class="mb-3"><label class="form-label">House ID</label><input type="text" id="house-id" class="form-control" placeholder="e.g., RED" value="${state.houseToEdit?.id || ''}" ${state.houseToEdit ? 'readonly' : ''}></div>
                        <div class="mb-3"><label class="form-label">House Name</label><input type="text" id="house-name" class="form-control" placeholder="e.g., Red Racers" value="${state.houseToEdit?.name || ''}"></div>
                        <div class="mb-3"><label class="form-label">House Color</label><input type="color" id="house-color" class="form-control form-control-color" value="${state.houseToEdit?.color || '#FF0000'}" title="Choose color"></div>
                        <div class="text-end">
                            ${state.houseToEdit ? `<button type="button" class="btn btn-secondary me-2" onclick="clearHouseEdit()">Cancel</button>` : ''}
                            <button type="submit" class="btn btn-primary">${state.houseToEdit ? 'Update' : 'Add'} House</button>
                        </div>
                    </form>
                    <hr><h6 class="mt-4">Existing Houses</h6><div id="houses-list"></div>
                </div>
            </div>
            <div class="col-lg-7"><div class="ui-card h-100"><div id="fest-settings-wrapper"></div></div></div>
        </div>
    `;
    renderHousesList();
    renderFestSpecificSettings(activeSettings);
    attachSetupTabListeners();
}

/**
 * Renders the fest-specific settings form with type-based limits and the new registration status toggle.
 */
function renderFestSpecificSettings(settings) {
    const wrapper = document.getElementById('fest-settings-wrapper');
    if (!wrapper) return;

    // Default values for all settings to prevent errors if they are not yet saved.
    const defaults = {
        maxOnStageSoloEvents: 2, maxOnStageGroupEvents: 2,
        maxOffStageSoloEvents: 1, maxOffStageGroupEvents: 1,
        houseEventLimits: {
            onStage: { solo: 2, group: 1 },
            offStage: { solo: 2, group: 1 }
        },
        categories: [],
        registrationOpen: true // Default to open
    };
    
    // Deep merge settings to avoid errors
    const s = { ...defaults, ...settings };
    s.houseEventLimits = { ...defaults.houseEventLimits, ...settings.houseEventLimits };
    s.houseEventLimits.onStage = { ...defaults.houseEventLimits.onStage, ...settings.houseEventLimits?.onStage };
    s.houseEventLimits.offStage = { ...defaults.houseEventLimits.offStage, ...settings.houseEventLimits?.offStage };

    const categoryRows = s.categories?.map(cat => `
        <tr data-name="${cat.name}" data-type="${cat.type}" data-criteria="${cat.type === 'age' ? cat.criteria : cat.criteria.join(',') }">
            <td>${cat.name}</td><td><span class="badge bg-info">${cat.type === 'age' ? 'Age-wise' : 'Class-wise'}</span></td>
            <td>${cat.type === 'age' ? `Born after ${cat.criteria}`: cat.criteria.map(cid => classes.find(c => c.id === cid)?.name || 'Unknown').join(', ')}</td>
            <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger py-0 px-2 remove-cat-row-btn">&times;</button></td>
        </tr>`).join('') || '';

    // âœ… MODIFIED: Added the Registration Status section
    wrapper.innerHTML = `
        <h5 class="section-header"><i class="fas fa-cogs me-2"></i>Settings for: <span class="text-primary">${state.managingFest.name}</span></h5>
        
        <!-- âœ… NEW: Registration Status Toggle -->
        <div class="card card-body mb-3 bg-light border-primary">
            <label class="form-label fw-bold">Registration Status</label>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="fest-registration-status" ${state.managingFest.registrationOpen ? 'checked' : ''}>
                <label class="form-check-label" for="fest-registration-status">
                    ${state.managingFest.registrationOpen ? 'Registration is OPEN' : 'Registration is CLOSED'}
                </label>
            </div>
            <p class="small text-muted mt-1">When closed, house captains cannot add or edit participants.</p>
        </div>
        
        <!-- Student Registration Limits -->
        <div class="card card-body mb-3">
            <label class="form-label fw-bold">Student Registration Limits</label>
            <p class="small text-muted">Max number of events a single student can participate in.</p>
            <div class="row">
                <div class="col-md-6 border-end">
                    <label class="form-label small fw-bold text-primary">On-Stage</label>
                    <div class="row g-2">
                        <div class="col"><label class="form-label small">Solo Events</label><input type="number" id="max-onstage-solo" class="form-control form-control-sm" value="${s.maxOnStageSoloEvents}"></div>
                        <div class="col"><label class="form-label small">Group Events</label><input type="number" id="max-onstage-group" class="form-control form-control-sm" value="${s.maxOnStageGroupEvents}"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label small fw-bold text-primary">Off-Stage</label>
                    <div class="row g-2">
                        <div class="col"><label class="form-label small">Solo Events</label><input type="number" id="max-offstage-solo" class="form-control form-control-sm" value="${s.maxOffStageSoloEvents}"></div>
                        <div class="col"><label class="form-label small">Group Events</label><input type="number" id="max-offstage-group" class="form-control form-control-sm" value="${s.maxOffStageGroupEvents}"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- House Participation Limits -->
        <div class="card card-body mb-3">
            <label class="form-label fw-bold">House Participation Limits</label>
            <p class="small text-muted">Max number of participants a House can field for any single event.</p>
            <div class="row">
                <div class="col-md-6 border-end">
                    <label class="form-label small fw-bold text-primary">On-Stage</label>
                    <div class="row g-2">
                        <div class="col"><label class="form-label small">Solo Participants</label><input type="number" id="limit-onstage-solo-house" class="form-control form-control-sm" value="${s.houseEventLimits.onStage.solo}"></div>
                        <div class="col"><label class="form-label small">Group Participants</label><input type="number" id="limit-onstage-group-house" class="form-control form-control-sm" value="${s.houseEventLimits.onStage.group}"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label small fw-bold text-primary">Off-Stage</label>
                    <div class="row g-2">
                        <div class="col"><label class="form-label small">Solo Participants</label><input type="number" id="limit-offstage-solo-house" class="form-control form-control-sm" value="${s.houseEventLimits.offStage.solo}"></div>
                        <div class="col"><label class="form-label small">Group Participants</label><input type="number" id="limit-offstage-group-house" class="form-control form-control-sm" value="${s.houseEventLimits.offStage.group}"></div>
                    </div>
                </div>
            </div>
        </div>
        <hr>

        <!-- Category Management -->
        <label class="form-label fw-bold">Categories for this Fest</label>
        <div class="table-responsive"><table id="category-table" class="table table-sm"><thead><tr><th>Name</th><th>Type</th><th>Criteria</th><th></th></tr></thead><tbody>${categoryRows}</tbody></table></div>
        <button type="button" id="add-category-btn" class="btn btn-sm btn-outline-secondary mt-2"><i class="fas fa-plus me-1"></i>Add Category</button>
        <div id="new-category-form" class="p-3 bg-light rounded mt-3 d-none">
            <div class="row g-3">
                <div class="col-md-3"><label>Name</label><input type="text" id="new-cat-name" class="form-control"></div>
                <div class="col-md-3"><label>Type</label><select id="new-cat-type" class="form-select"><option value="age">Age-wise</option><option value="class">Class-wise</option></select></div>
                <div class="col-md-4" id="cat-criteria-cell"><label>Born After Date</label><input type="date" class="form-control" id="new-cat-criteria-age"></div>
                <div class="col-md-2 d-grid align-self-end"><button type="button" id="save-new-cat-btn" class="btn btn-sm btn-primary">Add to Table</button></div>
            </div>
        </div>
        <div class="text-end mt-4"><button id="save-fest-settings" class="btn btn-success" onclick="saveAllFestSettings()">Save Settings for ${state.managingFest.name}</button></div>`;
}

/**
 * Saves all fest-specific settings from the form to Firestore.
 */
async function saveAllFestSettings() {
    if (!state.managingFest) return;

    // âœ… MODIFIED: Read the new registration status and save it along with other settings.
    const registrationOpen = document.getElementById('fest-registration-status').checked;

    const newSettings = {
        maxOnStageSoloEvents: parseInt(document.getElementById('max-onstage-solo').value) || 0,
        maxOnStageGroupEvents: parseInt(document.getElementById('max-onstage-group').value) || 0,
        maxOffStageSoloEvents: parseInt(document.getElementById('max-offstage-solo').value) || 0,
        maxOffStageGroupEvents: parseInt(document.getElementById('max-offstage-group').value) || 0,
        houseEventLimits: {
            onStage: {
                solo: parseInt(document.getElementById('limit-onstage-solo-house').value) || 0,
                group: parseInt(document.getElementById('limit-onstage-group-house').value) || 0,
            },
            offStage: {
                solo: parseInt(document.getElementById('limit-offstage-solo-house').value) || 0,
                group: parseInt(document.getElementById('limit-offstage-group-house').value) || 0,
            }
        },
        categories: Array.from(document.querySelectorAll('#category-table tbody tr')).map(row => ({
            name: row.dataset.name,
            type: row.dataset.type,
            criteria: row.dataset.type === 'age' ? row.dataset.criteria : row.dataset.criteria.split(','),
        })),
    };

    try {
        const festRef = getDocRef('fests', state.managingFest.id);
        // âœ… MODIFIED: Update both the 'settings' object and the 'registrationOpen' field.
        await updateDoc(festRef, { 
            settings: newSettings,
            registrationOpen: registrationOpen 
        });

        showAlert(`Settings for '${state.managingFest.name}' saved successfully.`, 'success');
        
        // Update the local state to match what was saved.
        state.managingFest.settings = newSettings;
        state.managingFest.registrationOpen = registrationOpen;

        // Re-render the tab to reflect the new status label
        renderFestSetupTab();
        // Check if the Participants tab is currently the active one in the UI.
        const participantsTabPane = document.getElementById('fest-participants');
        if (participantsTabPane && participantsTabPane.classList.contains('active')) {
            // If it is, re-render it immediately to disable/enable its controls.
            renderFestParticipantsTab();
        }

    } catch (error) {
        console.error("Error saving fest settings:", error);
        showAlert('Failed to save settings.', 'danger');
    }
}

function renderHousesList() {
    const container = document.getElementById('houses-list');
    if (!container) return;
    
    if (festHouses.length === 0) {
        container.innerHTML = '<p class="text-muted text-center p-3">No houses created yet.</p>';
        return;
    }

    const sortedHouses = [...festHouses].sort((a, b) => a.name.localeCompare(b.name));
    container.innerHTML = `
    <div class="table-responsive">
        <table class="table table-hover table-sm">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Color</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                ${sortedHouses.map(house => `
                <tr>
                    <td><strong>${house.id}</strong></td>
                    <td>${house.name}</td>
                    <td><span class="color-dot-display" style="background-color:${house.color};"></span> ${house.color}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1" onclick="editHouse('${house.id}')" title="Edit"><i class="fas fa-edit fa-xs"></i></button>
                        <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="deleteFestItem('festHouses', '${house.id}', 'renderFestSetupTab')" title="Delete"><i class="fas fa-trash fa-xs"></i></button>
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>
    </div>`;
}

function attachSetupTabListeners() {

    

    // Fest form submission
    document.getElementById('fest-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('fest-id').value.trim().toUpperCase();
        const name = document.getElementById('fest-name').value.trim();
        const registrationOpen = document.getElementById('fest-reg-status').checked;

        if (!id || !name) {
            return showAlert('Fest ID and Name are required.', 'danger');
        }

        const festData = { id, name, registrationOpen };
        try {
            await setDoc(getDocRef('fests', id), festData, { merge: true });
            showAlert(`Fest '${name}' saved successfully.`, 'success');
            clearFestEdit(); // This will clear the form and re-render
        } catch (error) {
            console.error("Error saving fest:", error);
            showAlert('Failed to save fest. See console for details.', 'danger');
        }
    });

    // House form submission
    document.getElementById('house-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('house-id').value.trim().toUpperCase();
        const name = document.getElementById('house-name').value.trim();
        const color = document.getElementById('house-color').value;
        if (!id || !name) { return showAlert('House ID and Name are required.', 'danger'); }

        try {
            await setDoc(getDocRef('festHouses', id), { id, name, color }, { merge: true });
            showAlert(`House '${name}' saved successfully.`, 'success');
            clearHouseEdit(); // This will clear the form and re-render
        } catch (error) {
            console.error("Error saving house:", error);
            showAlert('Failed to save house. See console for details.', 'danger');
        }
    });
    // NEW: Listener for category type change
    document.getElementById('new-cat-type')?.addEventListener('change', e => {
        const uiContainer = document.getElementById('cat-type-specific-ui');
        if (e.target.value === 'age') {
            uiContainer.innerHTML = `<label>Born On or After Date</label><input type="date" id="new-cat-date" class="form-control">`;
        } else {
            uiContainer.innerHTML = `<label>Select Classes</label><select id="new-cat-classes" class="form-select" multiple size="4">${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select>`;
        }
    });

    const settingsWrapper = document.getElementById('fest-settings-wrapper');
    if (!settingsWrapper) return;

    // --- Main Event Handler for the Settings/Category Section ---
    settingsWrapper.addEventListener('click', (e) => {
        // Toggles the visibility of the "Add New Category" form
        if (e.target.id === 'add-category-btn') {
            document.getElementById('new-category-form').classList.toggle('d-none');
        }

        // Removes a category row from the table (client-side)
        if (e.target.classList.contains('remove-cat-row-btn')) {
            e.target.closest('tr').remove();
        }

        // Adds the newly defined category to the table (client-side)
        if (e.target.id === 'save-new-cat-btn') {
            const nameInput = document.getElementById('new-cat-name');
            const typeSelect = document.getElementById('new-cat-type');
            
            const name = nameInput.value.trim();
            const type = typeSelect.value;

            if (!name) {
                return showAlert('Category Name is required.', 'danger');
            }

            let criteria, criteriaDisplay;
            if (type === 'age') {
                const ageInput = document.getElementById('new-cat-criteria-age');
                if (!ageInput.value) return showAlert('"Born After Date" is required for age-wise categories.', 'danger');
                criteria = ageInput.value;
                criteriaDisplay = `Born after ${criteria}`;
            } else {
                const classSelect = document.getElementById('new-cat-criteria-class');
                criteria = Array.from(classSelect.selectedOptions).map(opt => opt.value);
                if (criteria.length === 0) return showAlert('At least one class must be selected for class-wise categories.', 'danger');
                criteriaDisplay = criteria.map(cid => classes.find(c => c.id === cid)?.name || 'Unknown').join(', ');
            }

            // Create and append the new table row
            const tableBody = document.querySelector('#category-table tbody');
            const newRow = document.createElement('tr');
            newRow.dataset.name = name;
            newRow.dataset.type = type;
            newRow.dataset.criteria = criteria;

            newRow.innerHTML = `
                <td>${name}</td>
                <td><span class="badge bg-info">${type === 'age' ? 'Age-wise' : 'Class-wise'}</span></td>
                <td>${criteriaDisplay}</td>
                <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger py-0 px-2 remove-cat-row-btn">&times;</button></td>
            `;
            tableBody.appendChild(newRow);

            // Reset and hide the form
            nameInput.value = '';
            document.getElementById('new-category-form').classList.add('d-none');
        }

        // Main Save Button for ALL settings for the selected fest
        if (e.target.id === 'save-fest-settings') {
            saveAllFestSettings(); 
        }
    });

    // Handles dynamic UI change when category type is selected
    settingsWrapper.addEventListener('change', e => {
        if (e.target.id === 'new-cat-type') {
            const cell = document.getElementById('cat-criteria-cell');
            if (e.target.value === 'age') {
                cell.innerHTML = `<label>Born After Date</label><input type="date" class="form-control" id="new-cat-criteria-age">`;
            } else {
                cell.innerHTML = `<label>Select Classes</label><select id="new-cat-criteria-class" class="form-select" multiple size="3">${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select>`;
            }
        }
    });

    // Add new age category row
    document.getElementById('add-age-category')?.addEventListener('click', () => {
        document.querySelector('#age-category-table tbody')?.insertAdjacentHTML('beforeend', `
            <tr>
                <td><input type="text" class="form-control form-control-sm age-cat-name" placeholder="e.g., Sub-Juniors"></td>
                <td><input type="date" class="form-control form-control-sm age-cat-date"></td>
                <td><button type="button" class="btn btn-sm btn-outline-danger py-0 px-2 remove-cat-row-btn">&times;</button></td>
            </tr>`);
    });
    // NEW: Listener to remove a category from the table
    document.getElementById('category-table')?.addEventListener('click', e => {
        if (e.target.classList.contains('remove-cat-row-btn')) {
            e.target.closest('tr').remove();
        }
    });

    
    // Remove age category row (delegated listener)
    document.getElementById('age-category-table')?.addEventListener('click', e => {
        if (e.target.classList.contains('remove-cat-row-btn')) {
            e.target.closest('tr').remove();
        }
    });

    // Save all global and age settings
    document.getElementById('save-fest-settings')?.addEventListener('click', async () => {
        // const newSettings = {
        //     maxEventsPerStudent: parseInt(document.getElementById('max-events').value) || 3,
        //     houseEventLimits: {
        //         solo: parseInt(document.getElementById('limit-solo').value) || 2,
        //         group: parseInt(document.getElementById('limit-group').value) || 1,
        //     },
        //     ageCategories: [],
        //     categories: []
        

        //};
        saveAllFestSettings();
        
        document.querySelectorAll('#age-category-table tbody tr').forEach(row => {
            const name = row.querySelector('.age-cat-name')?.value.trim();
            const bornAfterDate = row.querySelector('.age-cat-date')?.value;
            if (name && bornAfterDate) {
                newSettings.ageCategories.push({ name, bornAfterDate });
            }
        });
        
        // Sort categories by date to ensure correct logic later
        newSettings.ageCategories.sort((a,b) => new Date(b.bornAfterDate) - new Date(a.bornAfterDate));

        try {
            await setDoc(getDocRef('festSettings', 'main'), newSettings);
            showAlert('Global settings saved successfully.', 'success');
        } catch (error) {
            console.error("Error saving global settings:", error);
            showAlert('Failed to save settings. See console for details.', 'danger');
        }
    });
}


// -------------------------------------------------------------------------
// --- 4. EVENTS TAB ---
// -------------------------------------------------------------------------

function renderFestEventsTab() {
    const container = document.getElementById('fest-events');
    if (!container || !state.managingFest) {
        container.innerHTML = `<div class="text-center p-5"><i class="fas fa-arrow-left fa-3x text-primary mb-3"></i><h5>No Fest Selected</h5><p class="text-muted">Please select a fest from the "Setup" tab to manage events.</p></div>`;
        return;
    }

    const categoriesForFest = ['General', ...(state.managingFest.settings?.categories?.map(c => c.name) || [])];
    const categoryOptions = categoriesForFest.map(c => `<option value="${c}" ${state.eventToEdit?.categories?.includes(c) ? 'selected' : ''}>${c}</option>`).join('');

    container.innerHTML = `
    <div class="row g-4">
        <div class="col-lg-5">
            <div class="ui-card h-100">
                <h5 class="section-header"><i class="fas fa-calendar-plus me-2"></i>${state.eventToEdit ? 'Edit Event' : 'Add New Event'}</h5>
                <p class="small text-muted">For Fest: <strong>${state.managingFest.name}</strong></p>
                <form id="event-form">
                    <div class="mb-3">
                        <label class="form-label">Event Name (without gender)</label>
                        <input type="text" id="event-name" class="form-control" value="${state.eventToEdit?.name || ''}" placeholder="e.g., Elocution">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Assign to Categories</label>
                        <select id="event-categories" class="form-select" multiple size="4">${categoryOptions}</select>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-4"><label class="form-label d-block">Mode</label>
                            <div class="form-check"><input type="checkbox" id="event-is-group" class="form-check-input" ${state.eventToEdit?.isGroupEvent ? 'checked' : ''}><label class="form-check-label" for="event-is-group">Group Event</label></div>
                        </div>
                        <div class="col-md-4"><label class="form-label d-block">Type</label>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="eventType" value="onStage" ${state.eventToEdit?.type !== 'offStage' ? 'checked' : ''}><label>On-Stage</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="eventType" value="offStage" ${state.eventToEdit?.type === 'offStage' ? 'checked' : ''}><label>Off-Stage</label></div>
                        </div>
                        <div class="col-md-4"><label class="form-label d-block">Gender Scope</label>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="eventGender" value="Male"><label>Boys</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="eventGender" value="Female"><label>Girls</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="eventGender" value="Both"><label>Both</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="eventGender" value="Common" checked><label>Common</label></div>
                        </div>
                    </div>
                    <div class="text-end">
                        ${state.eventToEdit ? `<button type="button" class="btn btn-secondary me-2" onclick="window.clearEventEdit()">Cancel</button>` : ''}
                        <button type="submit" class="btn btn-primary">${state.eventToEdit ? 'Update Event' : 'Save Event'}</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="ui-card h-100">
                <h5 class="section-header"><i class="fas fa-tasks me-2"></i>Events in ${state.managingFest.name}</h5>
                <div id="events-list"></div>
            </div>
        </div>
    </div>`;
    
    renderEventsList();
    attachEventsTabListeners();
}

/**
 * Attaches event listeners and handles the logic for creating/updating events.
 */
function attachEventsTabListeners() {
    document.getElementById('event-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('event-name').value.trim();
        if (!name) return showAlert('Event Name is required.', 'danger');

        const selectedCategories = Array.from(document.getElementById('event-categories').selectedOptions).map(option => option.value);
        if (selectedCategories.length === 0) return showAlert('Please select at least one category.', 'danger');

        const isGroupEvent = document.getElementById('event-is-group').checked;
        const type = document.querySelector('input[name="eventType"]:checked')?.value;
        const genderSelection = document.querySelector('input[name="eventGender"]:checked')?.value;
        
        const festId = state.managingFest.id;
        const baseEventId = state.eventToEdit?.baseEventId || `EVT_${Date.now()}`;
        
        if (state.eventToEdit) { // Safety check for existing registrations
            const oldEventIds = festEvents.filter(event => event.baseEventId === state.eventToEdit.baseEventId).map(event => event.id);
            if (festRegistrations?.some(reg => reg.festId === festId && reg.events.some(eventId => oldEventIds.includes(eventId)))) {
                showAlert('Cannot edit event with existing participants.', 'danger');
                return;
            }
        }

        const batch = writeBatch(db);

        // If editing, remove all old versions of this event
        if (state.eventToEdit) {
            festEvents.filter(event => event.baseEventId === state.eventToEdit.baseEventId)
                      .forEach(oldEvent => batch.delete(getDocRef('festEvents', oldEvent.id)));
        }
        
        const gendersToCreate = genderSelection === 'Both' ? ['Male', 'Female'] : [genderSelection];

        selectedCategories.forEach(category => {
            gendersToCreate.forEach(gender => {
                let eventNameWithGender = name;
                if (gender === 'Male') eventNameWithGender = `${name} (Boys)`;
                if (gender === 'Female') eventNameWithGender = `${name} (Girls)`;
                
                const uniqueId = `${baseEventId}_${category.replace(/\s+/g, '_')}_${gender}`;
                const eventData = {
                    id: uniqueId, baseEventId, festId, 
                    name: eventNameWithGender, // Use the new name
                    category, isGroupEvent, type,
                    gender: gender // Store specific gender
                };
                batch.set(getDocRef('festEvents', uniqueId), eventData);
            });
        });

        try {
            await batch.commit();
            showAlert(`Event '${name}' was saved successfully.`, 'success');
            clearEventEdit();
        } catch (error) {
            console.error("Error saving event(s): ", error);
            showAlert('Failed to save event.', 'danger');
        }
    });
}

/**
 * Renders the list of all individual events with their gender-specific names.
 */
function renderEventsList() {
    const container = document.getElementById('events-list');
    if (!container || !state.managingFest) return;

    const selectedCategory = document.getElementById('event-category-filter')?.value || 'all';
    const selectedType = document.getElementById('event-type-filter')?.value || 'all';

    let eventsForFest = festEvents.filter(e => e.festId === state.managingFest.id);

    if (selectedType !== 'all') {
        eventsForFest = eventsForFest.filter(e => (e.type || 'onStage') === selectedType);
    }
    if (selectedCategory !== 'all') {
        eventsForFest = eventsForFest.filter(e => e.category === selectedCategory);
    }
    
    // Sort by name (which now includes gender), then by category
    eventsForFest.sort((a, b) => {
        const nameCompare = a.name.localeCompare(b.name);
        if (nameCompare !== 0) return nameCompare;
        return a.category.localeCompare(b.category);
    });

    const allCategoriesForFest = [...new Set(festEvents.filter(e => e.festId === state.managingFest.id).map(e => e.category))].sort();
    const categoryOptions = allCategoriesForFest.map(c => `<option value="${c}" ${selectedCategory === c ? 'selected' : ''}>${c}</option>`).join('');

    container.innerHTML = `
        <div class="row g-2 mb-3 border-bottom pb-3">
            <div class="col-md-6"><label for="event-category-filter" class="form-label">Filter by Category</label><select id="event-category-filter" class="form-select"><option value="all">All Categories</option>${categoryOptions}</select></div>
            <div class="col-md-6"><label for="event-type-filter" class="form-label">Filter by Type</label><select id="event-type-filter" class="form-select"><option value="all">All</option><option value="onStage">On-Stage</option><option value="offStage">Off-Stage</option></select></div>
        </div>
        <div id="events-list-container" style="max-height: 65vh; overflow-y: auto;"></div>
    `;

    const listContainer = document.getElementById('events-list-container');

    if (eventsForFest.length === 0) {
        listContainer.innerHTML = '<p class="text-muted text-center p-5">No events match filters.</p>';
    } else {
        listContainer.innerHTML = `<div class="table-responsive"><table class="table table-sm table-hover">
            <thead><tr><th>Event Name</th><th>Category</th><th>Type</th><th>Mode</th><th class="text-end">Actions</th></tr></thead>
            <tbody>
                ${eventsForFest.map(event => `
                    <tr>
                        <td><strong>${event.name}</strong></td>
                        <td>${event.category}</td>
                        <td>${event.type === 'offStage' ? 'Off-Stage' : 'On-Stage'}</td>
                        <td><span class="badge bg-info">${event.isGroupEvent ? 'Group' : 'Solo'}</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1" onclick="window.editEventGroup('${event.baseEventId}')"><i class="fas fa-edit fa-xs"></i></button>
                            <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="window.deleteEventGroup('${event.baseEventId}')"><i class="fas fa-trash fa-xs"></i></button>
                        </td>
                    </tr>`).join('')}
            </tbody>
        </table></div>`;
    }

    document.getElementById('event-category-filter').addEventListener('change', renderEventsList);
    document.getElementById('event-type-filter').addEventListener('change', renderEventsList);
}

// --- 4. UPDATED HELPER & DELETE FUNCTIONS ---

/**
 * Prepares the form to edit an entire event group.
 * @param {string} baseEventId The shared ID for the event group.
 */
/**
 * Prepares the form to edit an entire event group.
 * It finds all events sharing a baseEventId, extracts their common properties
 * (name, type, gender, etc.), and sets the state to pre-fill the edit form.
 *
 * @param {string} baseEventId The shared ID for the event group.
 */
window.editEventGroup = (baseEventId) => {
    // --- FIX: Filter by the correct 'baseEventId' property ---
    const eventGroup = festEvents.filter(e => e.baseEventId === baseEventId);

    if (eventGroup.length === 0) {
        console.error(`No events found for baseEventId: ${baseEventId}`);
        return; // Exit if no events are part of this group
    }

    const baseEvent = eventGroup[0]; // Use the first event as a template
    const categories = [...new Set(eventGroup.map(e => e.category))];
    const genders = new Set(eventGroup.map(e => e.gender));

    // --- ENHANCEMENT: Determine the correct gender setting for the form ---
    let genderSetting;
    if (genders.has('Male') && genders.has('Female')) {
        genderSetting = 'Both';
    } else if (genders.has('Male')) {
        genderSetting = 'Male';
    } else if (genders.has('Female')) {
        genderSetting = 'Female';
    } else {
        genderSetting = 'Common';
    }
    
    // --- ENHANCEMENT: Remove gender suffix from the name for editing ---
    const eventNameForEdit = baseEvent.name.replace(/\s\((Boys|Girls)\)$/, '').trim();

    // Set the state with all the necessary info to populate the form
    state.eventToEdit = {
        baseEventId: baseEvent.baseEventId,
        name: eventNameForEdit, // Use the cleaned name
        isGroupEvent: baseEvent.isGroupEvent,
        type: baseEvent.type,
        categories: categories,
        gender: genderSetting // Set the determined gender
    };

    // Re-render the tab, which will now use the 'state.eventToEdit' object to pre-fill the form
    renderFestEventsTab();
};

window.clearEventEdit = () => {
    state.eventToEdit = null;
    renderFestEventsTab();
};

/**
 * Deletes an entire group of events based on their shared baseEventId.
 * @param {string} collectionName The Firestore collection name ('festEvents').
 *- * @param {string} baseEventId The shared ID for the event group.
 */
window.deleteEventGroup = async (collectionName, baseEventId) => {
    const eventsToDelete = festEvents.filter(e => e.id === baseEventId);

    // --- ADDED: Safety Check ---
    // This guard clause prevents the error if the event group is not found.
    if (eventsToDelete.length === 0) {
        console.error(`Attempted to delete event group with baseEventId "${baseEventId}", but it was not found.`);
        showAlert('Could not find the event to delete. It may have already been removed.', 'warning');
        return; // Stop the function here
    }

    // The rest of the function now runs only if events were found.
    const eventName = eventsToDelete[0].name;
    if (!confirm(`Are you sure you want to delete the event "${eventName}" from all its categories? This cannot be undone.`)) {
        return;
    }

    const batch = writeBatch(db);
    eventsToDelete.forEach(event => {
        batch.delete(getDocRef(collectionName, event.id));
    });

    try {
        await batch.commit();
        showAlert(`Event group "${eventName}" was deleted successfully.`, 'success');
        
        // If the deleted event was being edited, clear the form.
        if (state.eventToEdit?.baseEventId === baseEventId) {
             clearEventEdit();
        }
        renderEventsList()
    } catch (error) {
        console.error("Error deleting event group:", error);
        showAlert('Failed to delete event group.', 'danger');
    }
};

// -------------------------------------------------------------------------
// --- 5. PARTICIPANTS TAB (CONSOLIDATED) ---
// -------------------------------------------------------------------------
function renderFestParticipantsTab() {
    const container = document.getElementById('fest-participants');
    if (!container || !state.managingFest) return;

    // Get the current registration status.
    const isRegistrationOpen = state.managingFest.registrationOpen === true;

    // âœ… ALWAYS render the tab structure for consistency.
    container.innerHTML = `
        <p class="text-muted">Manage all participant-related tasks for <strong>${state.managingFest.name}</strong> from one place.</p>
        
        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-registration" type="button"><i class="fas fa-user-plus me-2"></i>Registration</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-house" type="button"><i class="fas fa-sitemap me-2"></i>House Allocation</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-chest" type="button"><i class="fas fa-id-badge me-2"></i>Chest Numbers</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-groups" type="button"><i class="fas fa-users me-2"></i>Groups</button></li>
        </ul>
        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="pills-registration" role="tabpanel"></div>
            <div class="tab-pane fade" id="pills-house" role="tabpanel"></div>
            <div class="tab-pane fade" id="pills-chest" role="tabpanel"></div>
            <div class="tab-pane fade" id="pills-groups" role="tabpanel"></div>
        </div>
    `;
    
    // Now, let the sub-tab renderers handle the registration status individually.
    renderParticipantRegistrationSection(isRegistrationOpen);
    renderParticipantHouseSection(); // House allocation should always be available.
    renderParticipantChestSection(); // Chest numbers should always be available.
    renderParticipantGroupsSection(isRegistrationOpen);
}





function attachMainParticipantListeners() {
   // const festFilter = document.getElementById('participant-fest-filter');
    const festFilter = state.managingFest.id;// Automatically set
            
    const renderSubViews = () => {
        const festId = festFilter;
        if (!festId) return;
        renderBulkRegistrationView(festId);
        renderParticipantListView(festId);
    };
    renderSubViews();
    // Initial render
    if (fests.length > 0) {
        renderSubViews();
    }
}


// --- A. BULK REGISTRATION SUB-VIEW ---

function renderBulkRegistrationView(festId) {
    const container = document.getElementById('bulk-registration-view');
    container.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="text-muted">Use this table to quickly add or update participants.</h6>
            <button class=" btn btn-success" id="save-all-regs-btn"><i class="fas fa-save me-2"></i>Save All Changes</button>
        </div>
        <div class="table-responsive mt-3">
            <table class="table table-sm" id="bulk-reg-table">
                <thead class="table-light">
                    <tr>
                        <th style="width: 15%;">Admission No.</th>
                        <th>Stdent Details</th>
                        <th style="width: 25%;">Events</th>
                        <th style="width: 5%;"></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn btn-outline-primary mt-2" id="add-reg-row-btn"><i class="fas fa-plus me-1"></i>Add Participant Row</button>
        
    </div>

    `;
    // Re-attach listeners specifically for this view
    attachBulkRegistrationListeners(festId);
    // Load existing registrations into the table
   // loadRegistrationsIntoTable(festId); 
}
/**
 * Attaches event listeners for the new bulk registration table.
 */
function attachBulkParticipantsTabListeners() {
    //const festFilter = document.getElementById('bulk-reg-fest-filter');
    const addRowBtn = document.getElementById('add-reg-row-btn');
    const tableBody = document.querySelector('#bulk-reg-table tbody');
    const saveAllBtn = document.getElementById('save-all-regs-btn');

    // Load existing registrations when fest changes
    //festFilter.addEventListener('change', () => loadRegistrationsIntoTable(festFilter.value));
    
    // Add a new empty row
    addRowBtn.addEventListener('click', () => addParticipantRow());

    // Main event handler for the table using event delegation
    tableBody.addEventListener('change', async (e) => {
        if (e.target.classList.contains('admn-no-input')) {
            await handleStudentLookup(e.target);
        }
    });
    
    tableBody.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-reg-row-btn')) {
            e.target.closest('tr').remove();
        }
        if (e.target.classList.contains('manage-events-btn')) {
            openEventSelectionModal(e.target.closest('tr'));
        }
    });

    // Handle the main save button
    saveAllBtn.addEventListener('click', () => saveAllRegistrations(festFilter.value));

    // Initial load
    if (fests.length > 0) {
       // loadRegistrationsIntoTable(festFilter.value);
       addParticipantRow();
    }
}

/**
 * Adds a new, empty row to the bulk registration table.
 */
function addParticipantRow(reg = null) {
    const tableBody = document.querySelector('#bulk-reg-table tbody');
    const newRow = document.createElement('tr');
    const student = reg ? students.find(s => s.id === reg.studentId) : null;
    const houseOptions = festHouses.map(h => `<option value="${h.id}" ${reg?.houseId === h.id ? 'selected' : ''}>${h.name}</option>`).join('');
    
    newRow.dataset.studentid = student?.id || '';
    newRow.dataset.events = reg?.events.join(',') || '';
     // --- NEW: Generate the list of event name badges ---
    const eventBadgesHTML = reg?.events.map(id => {
        const event = festEvents.find(e => e.id === id);
        return event ? `<span class="badge bg-secondary me-1 mb-1">${event.name}</span>` : '';
    }).join('') || '<span class="text-muted small">No events selected</span>';

    
    newRow.innerHTML = `
        <td><input type="text" class="form-control form-control-sm admn-no-input" value="${student?.admissionNumber || ''}"></td>
        <td class="student-name-cell">${student?.name || '<span class="text-muted">...</span>'}</td>
        <td class="student-class-cell">${student ? getStudentClassName(student.classId, student.division) : ''}</td>
        <td><select class="form-select form-select-sm house-select" ${student?.house ? 'disabled' : ''}>${houseOptions}</select></td>
        <td class="events-cell">
            <button class="btn btn-sm btn-outline-secondary manage-events-btn" disabled>Manage Events</button>
            <span class="event-count ms-2 badge bg-primary">${reg?.events.length || 0} selected</span>
            ${eventBadgesHTML}
        </td>
        <td><button class="btn btn-sm btn-outline-danger py-0 px-2 remove-reg-row-btn">&times;</button></td>
    `;
    tableBody.appendChild(newRow);
}

/**
 * Handles fetching student details and populating the consolidated details cell.
 * @param {HTMLElement} inputElement The input field for the admission number.
 */
async function handleStudentLookup(inputElement) {
    const admnNo = inputElement.value.trim();
    const row = inputElement.closest('tr');
    if (!admnNo) return; // Do nothing if empty

    const student = students.find(s => String(s.admissionNumber||"").toLowerCase() === admnNo.toLowerCase());
    const festId = state.managingFest.id;// document.getElementById('bulk-reg-fest-filter').value;
    
    // Reset row
    row.dataset.studentid = '';
    row.dataset.events = '';
    row.querySelector('.student-name-cell').innerHTML = '<span class="text-warning">...</span>';
    row.querySelector('.student-class-cell').textContent = '';
    row.querySelector('.manage-events-btn').disabled = true;
    row.querySelector('.event-count').textContent = '0 selected';

    if (student) {
        row.dataset.studentid = student.id;
        row.querySelector('.student-name-cell').textContent = student.name;
        row.querySelector('.student-class-cell').textContent = getStudentClassName(student.classId, student.division);
        row.querySelector('.manage-events-btn').disabled = false;
        
        const houseSelect = row.querySelector('.house-select');
        if (student.house) {
            houseSelect.value = student.house;
            houseSelect.disabled = true;
        } else {
            houseSelect.disabled = false;
        }

        // Check for existing registration for this student in this fest
        const existingReg = festRegistrations.find(r => r.festId === festId && r.studentId === student.id);
        if(existingReg) {
            row.dataset.events = existingReg.events.join(',');
            row.querySelector('.event-count').textContent = `${existingReg.events.length} selected`;
            if(existingReg.houseId) houseSelect.value = existingReg.houseId;
        }
    } else {
        row.querySelector('.student-name-cell').innerHTML = '<span class="text-danger">Not Found</span>';
    }
}


/**
 * Opens a modal to select events, with live UI updates for highlighting,
 * event counts, and direct saving to the database.
 * @param {HTMLElement} row The table row (<tr>) element.
 */
/**
 * Opens a modal to select SOLO events for a student, with live UI updates,
 * direct saving, and a clean, focused interface.
 * @param {HTMLElement} row The table row (<tr>) element.
 */
function openEventSelectionModal(row) {
    const studentId = row.dataset.studentid;
    if (!studentId) return showAlert('Please find a valid student first by entering their Admission No.', 'warning');
    
    const student = students.find(s => s.id === studentId);
    if (!state.managingFest) {
        return showAlert('Error: No fest is currently being managed. Please go to the Setup tab.', 'danger');
    }

    const festId = state.managingFest.id;
    const studentCategory = getStudentCategory(student);
    const currentlySelected = row.dataset.events ? row.dataset.events.split(',') : [];

    // The limits for group events are no longer needed here
    const maxOnStageSolo = state.managingFest.settings.maxOnStageSoloEvents || 2;
    const maxOffStageSolo = state.managingFest.settings.maxOffStageSoloEvents || 1;

    // --- MODIFICATION: The filters now ONLY include solo events (!e.isGroupEvent) ---
    const onStageEvents = festEvents.filter(e => 
        e.festId === festId && 
        !e.isGroupEvent && // <-- Only solo events
        (e.category === 'General' || e.category === studentCategory) && 
        e.type !== 'offStage' && 
        (!e.gender || e.gender === 'Common' || ((student.gender === 'M'||student.gender === 'Male') && e.gender === 'Male') || ((student.gender === 'F'||student.gender === 'Female') && e.gender === 'Female'))
    );

    const offStageEvents = festEvents.filter(e => 
        e.festId === festId && 
        !e.isGroupEvent && // <-- Only solo events
        (e.category === 'General' || e.category === studentCategory) && 
        e.type === 'offStage' && 
        (!e.gender || e.gender === 'Common' || ((student.gender === 'M'||student.gender === 'Male') && e.gender === 'Male') || ((student.gender === 'F'||student.gender === 'Female') && e.gender === 'Female'))
    );

    const modalTitle = document.getElementById('event-modal-title');
    const modalBody = document.getElementById('event-modal-body');
    const saveBtn = document.getElementById('event-modal-save-btn');
    
    modalTitle.textContent = `Select Solo Events for ${student.name}`;

    // --- MODIFICATION: Simplified UI text ---
    modalBody.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <p class="mb-0">
                    <strong>Category:</strong> <span class="badge bg-info">${studentCategory}</span> | 
                    <strong>House:</strong> <span class="badge bg-primary">${student.houseId || 'N/A'}</span>
                </p>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="event-type-toggle">
                <label class="form-check-label" for="event-type-toggle" id="event-type-label">On-Stage Events</label>
            </div>
        </div>
        <p class="mb-2"><small>Limits: On-Stage (Solo: ${maxOnStageSolo}) | Off-Stage (Solo: ${maxOffStageSolo})</small></p>
        
        <div id="selection-summary" class="mb-2">
            <strong>Selected: </strong>
            <span id="selection-count-display" class="badge rounded-pill bg-dark" data-bs-toggle="tooltip" data-bs-placement="top" title="No events selected">
            </span>
        </div>
        <hr class="my-2">
        
        <div style="max-height: 400px; overflow-y: auto;">
            <div id="onstage-events-container" class="row g-3">
                ${onStageEvents.map(event => {
                    const eventId = `event-modal-${event.id}`;
                    return `
                    <div class="col-md-6">
                        <div class="form-check p-2">
                            <input class="form-check-input event-modal-checkbox" data-event-type="onStage" data-event-mode="solo" type="checkbox" value="${event.id}" id="${eventId}" ${currentlySelected.includes(event.id) ? 'checked' : ''}>
                            <label class="form-check-label" for="${eventId}">${event.name}</label>
                        </div>
                    </div>`;
                }).join('') || '<p class="text-muted p-3">No On-Stage solo events available.</p>'}
            </div>
            <div id="offstage-events-container" class="row g-3" style="display: none;">
                ${offStageEvents.map(event => {
                    const eventId = `event-modal-${event.id}`;
                    return `
                    <div class="col-md-6">
                        <div class="form-check p-2">
                            <input class="form-check-input event-modal-checkbox" data-event-type="offStage" data-event-mode="solo" type="checkbox" value="${event.id}" id="${eventId}" ${currentlySelected.includes(event.id) ? 'checked' : ''}>
                            <label class="form-check-label" for="${eventId}">${event.name}</label>
                        </div>
                    </div>`;
                }).join('') || '<p class="text-muted p-3">No Off-Stage solo events available.</p>'}
            </div>
        </div>
    `;

    const toggle = document.getElementById('event-type-toggle');
    const toggleLabel = document.getElementById('event-type-label');
    const onStageContainer = document.getElementById('onstage-events-container');
    const offStageContainer = document.getElementById('offstage-events-container');

    toggle.addEventListener('change', () => {
        if (toggle.checked) {
            toggleLabel.textContent = 'Off-Stage Events';
            onStageContainer.style.display = 'none';
            offStageContainer.style.display = 'flex';
        } else {
            toggleLabel.textContent = 'On-Stage Events';
            onStageContainer.style.display = 'flex';
            offStageContainer.style.display = 'none';
        }
    });

    const checkboxes = modalBody.querySelectorAll('.event-modal-checkbox');
    const countDisplay = document.getElementById('selection-count-display');
    const countTooltip = new bootstrap.Tooltip(countDisplay);

    const updateSelectionCount = () => {
        const checkedBoxes = Array.from(modalBody.querySelectorAll('.event-modal-checkbox:checked'));
        let onStageCount = 0;
        let offStageCount = 0;
        const selectedEventNames = [];

        checkedBoxes.forEach(cb => {
            if (cb.dataset.eventType === 'onStage') onStageCount++;
            else if (cb.dataset.eventType === 'offStage') offStageCount++;
            const event = festEvents.find(e => e.id === cb.value);
            if (event) selectedEventNames.push(event.name);
        });

        countDisplay.textContent = `On-Stage: ${onStageCount} | Off-Stage: ${offStageCount}`;
        const tooltipTitle = selectedEventNames.length > 0 ? selectedEventNames.join(', ') : 'No events selected';
        countDisplay.setAttribute('data-bs-original-title', tooltipTitle);
        countTooltip.setContent({ '.tooltip-inner': tooltipTitle });
        
        const selectedEventIds = checkedBoxes.map(cb => cb.value);
        row.dataset.events = selectedEventIds.join(',');
        row.querySelector('.event-count').textContent = selectedEventIds.length;
    };

    const checkLimit = () => {
        const counts = { onStage: 0, offStage: 0 };
        checkboxes.forEach(cb => {
            if (cb.checked) { counts[cb.dataset.eventType]++; }
        });
        
        const limits = { onStage: maxOnStageSolo, offStage: maxOffStageSolo };

        checkboxes.forEach(cb => {
            const parentDiv = cb.closest('.form-check');
            parentDiv.classList.toggle('event-selected', cb.checked);
            if (!cb.checked) {
                const type = cb.dataset.eventType;
                cb.disabled = counts[type] >= limits[type];
            }
        });
        
        updateSelectionCount();
    };
    checkboxes.forEach(cb => cb.addEventListener('change', checkLimit));
    checkLimit();

    const eventModal = new bootstrap.Modal(document.getElementById('eventSelectionModal'));

    saveBtn.onclick = async () => {
        const selectedSoloEventIds = Array.from(modalBody.querySelectorAll('.event-modal-checkbox:checked')).map(cb => cb.value);
        const houseId = student.houseId;
        const regId = `${festId}_${studentId}`;
        const existingReg = festRegistrations.find(r => r.id === regId);

        // Get existing GROUP events to preserve them
        const existingGroupEvents = existingReg?.events.filter(id => festEvents.find(e => e.id === id)?.isGroupEvent) || [];
        
        // Combine preserved group events with the newly selected solo events
        const newEvents = [...new Set([...existingGroupEvents, ...selectedSoloEventIds])];

        const registrationData = {
            id: regId, festId, studentId, studentName: student.name,
            houseId: houseId, events: newEvents,
            chestNo: existingReg?.chestNo || null
        };

        saveBtn.disabled = true;
        saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Saving...`;
        
        try {
            await setDoc(getDocRef('festRegistrations', regId), registrationData);
            showAlert('Registration saved successfully!', 'success');
            eventModal.hide();
        } catch (error) {
            console.error("Error saving registration from modal:", error);
            showAlert('Failed to save registration. Please try again.', 'danger');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = `Confirm Events`;
        }
    };

    eventModal.show();
}
/**
 * Loads all existing registrations for a fest into the bulk table.
 * @param {string} festId The ID of the fest.
 */
function loadRegistrationsIntoTable(festId) {
    const tableBody = document.querySelector('#bulk-reg-table tbody');
    tableBody.innerHTML = ''; // Clear existing rows
    const registrationsForFest = festRegistrations.filter(r => r.festId === festId);
    if(registrationsForFest.length > 0) {
        registrationsForFest.forEach(reg => addParticipantRow(reg));
    } else {
        // Add one empty row to start with
        addParticipantRow();
    }
}

/**
 * Reads all rows from the table and saves them to Firestore in a single batch.
 * @param {string} festId The ID of the fest.
 */
async function saveAllRegistrations(festId) {
    const rows = document.querySelectorAll('#bulk-reg-table tbody tr');
    if (rows.length === 0) return showAlert('There are no participants to save.', 'info');
    
    if (!confirm(`This will save or update all ${rows.length} participants for this fest. Continue?`)) return;

    const batch = writeBatch(db);
    let validRegistrations = 0;

    rows.forEach(row => {
        const studentId = row.dataset.studentid;
        const houseId = row.querySelector('.house-select').value;
        const eventIds = row.dataset.events ? row.dataset.events.split(',') : [];

        if (studentId && houseId) {
            const student = students.find(s => s.id === studentId);
            const regId = `${festId}_${studentId}`;
            const regData = {
                id: regId,
                festId,
                studentId,
                studentName: student.name,
                houseId,
                events: eventIds,
                chestNo: festRegistrations.find(r => r.id === regId)?.chestNo || null // Preserve chest number
            };
            batch.set(getDocRef('festRegistrations', regId), regData);
            validRegistrations++;
        }
    });

    if(validRegistrations === 0) return showAlert('No valid participant rows to save.', 'warning');

    try {
        await batch.commit();
        showAlert(`${validRegistrations} registrations were saved successfully!`, 'success');
        // The Firestore listener will automatically update the data, no need to manually reload.
    } catch (error) {
        console.error("Error saving bulk registrations:", error);
        showAlert('An error occurred while saving. Please check the console.', 'danger');
    }
}
function attachBulkRegistrationListeners() {
    const addRowBtn = document.getElementById('add-reg-row-btn');
    const tableBody = document.querySelector('#bulk-reg-table tbody');
    const saveAllBtn = document.getElementById('save-all-regs-btn');

    // Add a new empty row to the table
    addRowBtn?.addEventListener('click', () => addParticipantRow());

    // Use event delegation for interactions within the dynamic table
    tableBody?.addEventListener('change', async (e) => {
        if (e.target.classList.contains('admn-no-input')) {
            await handleStudentLookup(e.target);
        }
    });
    
    tableBody?.addEventListener('click', (e) => {
        const targetButton = e.target.closest('button');
        if (!targetButton) return;

        if (targetButton.classList.contains('remove-reg-row-btn')) {
            targetButton.closest('tr').remove();
        }
        if (targetButton.classList.contains('manage-events-btn')) {
            openEventSelectionModal(targetButton.closest('tr'));
        }
    });

    // Handle the main save button
    saveAllBtn?.addEventListener('click', () => {
        if (state.managingFest) {
            saveAllRegistrations(state.managingFest.id);
        } else {
            showAlert('Please select a fest from the Setup tab first.', 'danger');
        }
    });

    // Initial load of participants for the currently managed fest
    if (state.managingFest) {
       // loadRegistrationsIntoTable(state.managingFest.id);
    } else {
        tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted p-5">Please select a fest from the "Setup" tab to begin registration.</td></tr>`;
    }
}

function renderParticipantListView(festId) {
    const container = document.getElementById('participant-list-view');
    const eventsForFest = festEvents.filter(e => e.festId === festId);

    container.innerHTML = `
        <div class="ui-card-light p-3">
            <div class="row g-3 align-items-center">
                <div class="col-md-3"><select id="view-class-filter" class="form-select form-select-sm"><option value="">All Classes</option>${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                <div class="col-md-3"><select id="view-house-filter" class="form-select form-select-sm"><option value="">All Houses</option>${festHouses.map(h => `<option value="${h.id}">${h.name}</option>`).join('')}</select></div>
                <div class="col-md-3"><select id="view-event-filter" class="form-select form-select-sm"><option value="">All Events</option>${eventsForFest.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}</select></div>
                <div class="col-md-3"><input type="text" id="view-search-input" class="form-control form-control-sm" placeholder="Search Name/Chest No..."></div>
            </div>
        </div>
        <div class="d-flex justify-content-end align-items-center my-3">
             <button id="delete-selected-btn" class="btn btn-sm btn-danger me-2" disabled><i class="fas fa-trash-alt me-1"></i>Delete Selected</button>
             <div class="btn-group">
                <button id="download-csv-btn" class="btn btn-sm btn-outline-success"><i class="fas fa-file-csv me-1"></i>CSV</button>
                <button id="download-pdf-btn" class="btn btn-sm btn-outline-danger"><i class="fas fa-file-pdf me-1"></i>PDF</button>
             </div>
        </div>
        <div id="participant-list-table-container" class="table-responsive"></div>
    `;
    attachParticipantListViewListeners(festId);
    applyFiltersAndRenderParticipantList(festId); // Initial render
}

/**
 * Attaches listeners for the "View Participants" sub-tab.
 */
function attachParticipantListViewListeners(festId) {
    const filters = ['view-class-filter', 'view-house-filter', 'view-event-filter', 'view-search-input'];
    filters.forEach(id => {
        document.getElementById(id).addEventListener('input', () => applyFiltersAndRenderParticipantList(festId));
    });

    const container = document.getElementById('participant-list-table-container');
    container.addEventListener('change', e => {
        if (e.target.id === 'select-all-participants') {
            container.querySelectorAll('.participant-select-check').forEach(cb => cb.checked = e.target.checked);
        }
        const anyChecked = container.querySelectorAll('.participant-select-check:checked').length > 0;
        document.getElementById('delete-selected-btn').disabled = !anyChecked;
    });

    document.getElementById('delete-selected-btn').addEventListener('click', () => {
        const selectedIds = Array.from(container.querySelectorAll('.participant-select-check:checked')).map(cb => cb.value);
        if (selectedIds.length > 0) {
            deleteMultipleRegistrations(selectedIds);
        }
    });

    // Attach download listeners
    // ...
}
/**
 * Applies all active filters and renders the final participant list table.
 */
function applyFiltersAndRenderParticipantList(festId) {
    const container = document.getElementById('participant-list-table-container');
    let participants = festRegistrations.filter(r => r.festId === festId);

    // Apply filters
    const classId = document.getElementById('view-class-filter').value;
    const houseId = document.getElementById('view-house-filter').value;
    const eventId = document.getElementById('view-event-filter').value;
    const searchTerm = document.getElementById('view-search-input').value.toLowerCase();

    if (classId) {
        const studentIds = students.filter(s => s.classId === classId).map(s => s.id);
        participants = participants.filter(p => studentIds.includes(p.studentId));
    }
    if (houseId) {
        participants = participants.filter(p => p.houseId === houseId);
    }
    if (eventId) {
        participants = participants.filter(p => p.events.includes(eventId));
    }
    if (searchTerm) {
        participants = participants.filter(p => 
            p.studentName.toLowerCase().includes(searchTerm) ||
            p.chestNo?.toLowerCase().includes(searchTerm)
        );
    }

    // Store for download
    window.filteredParticipantList = participants;

    // Render table
    container.innerHTML = `
        <table class="table table-sm table-hover">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-participants"></th>
                    <th>Chest No.</th>
                    <th>Student Details</th>
                    <th>House</th>
                    <th>Events</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                ${participants.map(reg => {
                    const student = students.find(s => s.id === reg.studentId);
                    const house = festHouses.find(h => h.id === reg.houseId);
                    return `
                    <tr>
                        <td><input type="checkbox" class="form-check-input participant-select-check" value="${reg.id}"></td>
                        <td><strong>${reg.chestNo || 'N/A'}</strong></td>
                        <td>${reg.studentName}<br><small class="text-muted">${getStudentClassName(student?.classId, student?.division)}</small><br><small class="text-muted">${student.admissionNumber}</small></td>
                        <td style="color:${house?.color};">â— ${house?.name || ''}</td>
                        <td><span class="badge bg-secondary">${reg.events.length} Events</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary py-0 px-1" onclick="openEditRegistrationModal('${reg.id}')"><i class="fas fa-edit"></i></button>
                        </td>
                    </tr>`;
                }).join('')}
            </tbody>
        </table>
        <p class="text-muted small">${participants.length} participants found.</p>
    `;
}

/**
 * Deletes multiple registrations in a single batch operation.
 * @param {string[]} registrationIds Array of registration document IDs to delete.
 */
async function deleteMultipleRegistrations(registrationIds) {
    if (!confirm(`Are you sure you want to permanently delete ${registrationIds.length} selected participant(s)? This cannot be undone.`)) return;

    const batch = writeBatch(db);
    registrationIds.forEach(id => {
        batch.delete(getDocRef('festRegistrations', id));
    });

    try {
        await batch.commit();
        showAlert(`${registrationIds.length} registrations deleted successfully.`, 'success');
        // The Firestore listener will automatically trigger a re-render.
    } catch (error) {
        console.error("Error deleting multiple registrations:", error);
        showAlert('Failed to delete registrations.', 'danger');
    }
}

/**
 * Renders the "Groups" sub-tab with House and Search filters.
 * @param {boolean} isRegistrationOpen - The registration status of the fest.
 */
function renderParticipantGroupsSection(isRegistrationOpen) {
    // --- NEW: Reset the group builder state when the tab is rendered ---
    state.groupBuilderMembers = [];

    const container = document.getElementById('pills-groups');
    if (!container || !state.managingFest) return;
    
    // ... The rest of this function's HTML remains the same as before ...
    const groupEventsForFest = festEvents.filter(e => e.festId === state.managingFest.id && e.isGroupEvent)
        .sort((a, b) => a.name.localeCompare(b.name));
    const groupEventOptions = groupEventsForFest.map(e => `<option value="${e.id}">${e.name} (${e.category})</option>`).join('');
    const houseOptions = festHouses.map(h => `<option value="${h.id}">${h.name}</option>`).join('');

    container.innerHTML = `
        <div class="row g-4">
            <div class="col-lg-7">
                <div class="ui-card h-100">
                    <h5 class="section-header"><i class="fas fa-user-check me-2"></i>1. Select Students for Group</h5>
                    <div class="row g-3">
                        <div class="col-md-6"><label class="form-label">Filter by House</label><select id="group-house-filter" class="form-select"><option value="">-- Select House --</option>${houseOptions}</select></div>
                        <div class="col-md-6"><label class="form-label">Search Students in House</label><input type="text" id="group-student-search" class="form-control" placeholder="Type name or admn no..."></div>
                    </div><hr>
                    <div id="student-selection-list" style="max-height: 500px; overflow-y: auto;">
                        <p class="text-muted p-5 text-center">Select a house to see its members.</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="ui-card h-100">
                    <h5 class="section-header"><i class="fas fa-users me-2"></i>2. Define Group & Events</h5>
                    <div id="group-builder-container" class="p-3 bg-light rounded">
                        <div class="mb-3"><label class="form-label fw-bold">Group Name</label><input type="text" id="new-group-name" class="form-control" placeholder="e.g., Senior Dance Team"></div>
                        <div class="mb-3"><label for="group-events-select" class="form-label fw-bold">Assign to Event(s)</label><select id="group-events-select" class="form-select" multiple size="4">${groupEventOptions || '<option disabled>No group events created yet.</option>'}</select><small class="form-text text-muted">Hold Ctrl/Cmd to select multiple events.</small></div>
                        <h6>Selected Members (<span id="group-builder-count">0</span>)</h6>
                        <ul id="group-builder-list" class="list-group" style="max-height: 200px; overflow-y: auto;"><li class="list-group-item text-muted">Select students from the left...</li></ul>
                        <div class="d-grid mt-3"><button id="save-group-btn" class="btn btn-primary" ${!isRegistrationOpen ? 'disabled' : ''}>${!isRegistrationOpen ? 'Registration Closed' : 'Create Group & Register'}</button></div>
                    </div><hr>
                    <h6>Existing Groups</h6>
                    <div id="groups-summary-list"></div>
                </div>
            </div>
        </div>
    `;
    attachGroupsTabListeners();
    renderGroupSummary(state.managingFest.id);
}


/**
 * Attaches event listeners for the Groups tab, including the Save button.
 */
function attachGroupsTabListeners() {
    const houseFilter = document.getElementById('group-house-filter');
    const searchInput = document.getElementById('group-student-search');
    const studentListContainer = document.getElementById('student-selection-list');
    const saveGroupBtn = document.getElementById('save-group-btn'); // This is the button in question
    
    // Listeners for the filters
    houseFilter?.addEventListener('change', () => renderGroupStudentList(state.managingFest.id, houseFilter.value));
    searchInput?.addEventListener('input', () => renderGroupStudentList(state.managingFest.id, houseFilter.value));

    // Listener for selecting/deselecting students
    studentListContainer?.addEventListener('change', e => {
        if (e.target.classList.contains('student-group-checkbox')) {
            const studentId = e.target.value;
            if (e.target.checked) {
                if (!state.groupBuilderMembers.includes(studentId)) {
                    state.groupBuilderMembers.push(studentId);
                }
            } else {
                state.groupBuilderMembers = state.groupBuilderMembers.filter(id => id !== studentId);
            }
            updateGroupBuilderUI();
        }
    });

    // --- THIS IS THE LOGIC FOR THE SAVE BUTTON ---
    saveGroupBtn?.addEventListener('click', async () => {
        // 1. Gather all data from the form
        const groupName = document.getElementById('new-group-name').value.trim();
        const memberElements = document.querySelectorAll('#group-builder-list .group-member-role');
        const selectedEventIds = Array.from(document.getElementById('group-events-select').selectedOptions).map(opt => opt.value);

        // 2. Validate the input
        if (!groupName) return showAlert('Please enter a group name.', 'warning');
        if (memberElements.length === 0) return showAlert('Please select at least one student.', 'warning');
        if (selectedEventIds.length === 0) return showAlert('Please select at least one group event.', 'warning');
        const hasCaptain = Array.from(memberElements).some(el => el.value === 'Captain');
        if (!hasCaptain) return showAlert('Each group must have one Captain.', 'warning');
        
        // 3. Prepare the data object for saving
        const members = Array.from(memberElements).map(el => ({ studentId: el.dataset.studentid, role: el.value }));
        const isEditing = state.groupToEdit !== null;
        const groupId = isEditing ? state.groupToEdit.id : `GRP_${Date.now()}`;
        const groupData = { id: groupId, name: groupName, festId: state.managingFest.id, members: members };

        // 4. Use a batch write to save everything at once
        const batch = writeBatch(db);
        // Action A: Save the group document itself
        batch.set(getDocRef('festGroups', groupData.id), groupData);

        // Action B: Create or update the registration for each group member
        for (const member of members) {
            const student = students.find(s => s.id === member.studentId);
            if (!student) continue;
            const regId = `${state.managingFest.id}_${student.id}`;
            const regRef = getDocRef('festRegistrations', regId);
            const existingReg = festRegistrations.find(r => r.id === regId);
            let currentEvents = new Set(existingReg?.events || []);
            if (isEditing) {
                // If editing, remove old events to handle changes
                state.groupToEdit.events?.forEach(eventId => currentEvents.delete(eventId));
            }
            selectedEventIds.forEach(eventId => currentEvents.add(eventId));
            const registrationData = { id: regId, festId: state.managingFest.id, studentId: student.id, studentName: student.name, houseId: existingReg?.houseId || student.houseId || null, chestNo: existingReg?.chestNo || null, events: Array.from(currentEvents) };
            batch.set(regRef, registrationData);
        }

        // 5. Commit the changes and provide feedback
        try {
            await batch.commit();
            showAlert(`Group '${groupName}' was ${isEditing ? 'updated' : 'created'} successfully!`, 'success');
            clearGroupEditState();
            renderGroupSummary(state.managingFest.id);
        } catch (error) {
            console.error("Error saving group:", error);
            showAlert('Failed to save group changes.', 'danger');
        }
    });
}

/**
 * Renders the list of students, checking them based on the new state variable.
 */
function renderGroupStudentList(festId, houseId) {
    const container = document.getElementById('student-selection-list');
    const saveGroupBtn = document.getElementById('save-group-btn');
    const searchInput = document.getElementById('group-student-search');
    if (!container || !saveGroupBtn || !searchInput) return;

    const searchTerm = searchInput.value.toLowerCase();

    if (!houseId) {
        container.innerHTML = '<p class="text-muted p-5 text-center">Please select a house.</p>';
        return;
    }
    
    const studentsInHouse = students.filter(s => {
        const houseMatch = s.houseId === houseId;
        const searchMatch = !searchTerm || s.name.toLowerCase().includes(searchTerm) || String(s.admissionNumber || "").toLowerCase().includes(searchTerm);
        return houseMatch && searchMatch;
    });

    if (studentsInHouse.length === 0) {
        container.innerHTML = '<p class="text-muted p-5 text-center">No students found matching your criteria.</p>';
        return;
    }
    
    const studentsInAnyGroup = new Map();
    festGroups.filter(g => g.festId === festId).forEach(group => {
        group.members.forEach(member => {
            studentsInAnyGroup.set(member.studentId, group.name);
        });
    });

    container.innerHTML = `<ul class="list-group list-group-flush">${studentsInHouse.map(student => {
        const groupName = studentsInAnyGroup.get(student.id);
        const isInGroup = !!groupName;
        // MODIFIED: Check against the state array to see if the box should be checked
        const isSelected = state.groupBuilderMembers.includes(student.id);
        
        const disabledAttr = isInGroup && !isSelected ? 'disabled' : '';
        const labelClass = isInGroup && !isSelected ? 'text-muted' : '';
        const groupBadge = isInGroup ? `<span class="badge bg-secondary ms-2">${groupName}</span>` : '';

        return `<li class="list-group-item">
            <div class="form-check">
                <input class="form-check-input student-group-checkbox" type="checkbox" 
                       value="${student.id}" id="student-check-${student.id}" 
                       ${isSelected ? 'checked' : ''} ${disabledAttr}>
                <label class="form-check-label ${labelClass}" for="student-check-${student.id}">
                    ${student.name} ${groupBadge}
                </label>
            </div>
        </li>`;
    }).join('')}</ul>`;
}

/**
 * Updates the Group Builder UI based on the state.groupBuilderMembers array.
 */
function updateGroupBuilderUI() {
    const builderList = document.getElementById('group-builder-list');
    const builderCount = document.getElementById('group-builder-count');
    
    // MODIFIED: Builds the list from our state array, NOT from the checkboxes
    builderCount.textContent = state.groupBuilderMembers.length;
    if (state.groupBuilderMembers.length === 0) {
        builderList.innerHTML = '<li class="list-group-item text-muted">Select students from the left...</li>';
        return;
    }

    builderList.innerHTML = state.groupBuilderMembers.map(studentId => {
        const student = students.find(s => s.id === studentId);
        return `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>${student.name}</span>
                <select class="form-select form-select-sm w-auto group-member-role" data-studentid="${student.id}">
                    <option value="Member">Member</option>
                    <option value="Captain">Captain</option>
                    <option value="Accompanist">Accompanist</option>
                </select>
            </li>`;
    }).join('');

    builderList.addEventListener('change', e => {
        if (e.target.classList.contains('group-member-role') && e.target.value === 'Captain') {
            builderList.querySelectorAll('.group-member-role').forEach(select => {
                if (select !== e.target) { select.value = 'Member'; }
            });
        }
    });
}

function renderGroupSummary(festId) {
    const container = document.getElementById('groups-summary-list');
    const groupsForFest = festGroups.filter(g => g.festId === festId);
    
    if (groupsForFest.length === 0) {
        container.innerHTML = '<p class="text-muted p-3 text-center">No groups created for this fest yet.</p>';
        return;
    }

    container.innerHTML = `<div class="accordion accordion-flush" id="groups-accordion">${groupsForFest.map(group => `
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${group.id}">
                    ${group.name} 
                    <span class="badge bg-primary ms-2">${group.members?.length || 0} members</span>
                </button>
            </h2>
            <div id="collapse-${group.id}" class="accordion-collapse collapse" data-bs-parent="#groups-accordion">
                <div class="accordion-body">
                    <ul class="list-unstyled">${group.members?.map(member => {
                        const student = students.find(s => s.id === member.studentId);
                        return `<li class="d-flex justify-content-between align-items-center mb-1">
                            <span>${student?.name || 'Unknown'} <small class="text-muted">(${member.role})</small></span>
                            <button class="btn btn-xs btn-outline-danger py-0" onclick="removeStudentFromGroup('${group.id}', '${member.studentId}')">&times;</button>
                        </li>`;
                    }).join('') || '<li>No members yet.</li>'}</ul>
                    
                    <div class="text-end border-top pt-2 mt-2">
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="window.loadGroupForEditing('${group.id}')">
                            <i class="fas fa-edit me-1"></i>Edit Group
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteFestItem('festGroups', '${group.id}', 'renderParticipantGroupsSection')">
                            Delete Group
                        </button>
                    </div>
                </div>
            </div>
        </div>`).join('')}</div>`;
}
// Add 'groupToEdit' to your global state object
// state.groupToEdit = null;

/**
 * Loads an existing group's data into the group builder UI for editing.
 * @param {string} groupId The ID of the group to edit.
 */
window.loadGroupForEditing = (groupId) => {
    const group = festGroups.find(g => g.id === groupId);
    if (!group) {
        return showAlert('Could not find the group to edit.', 'danger');
    }

    // 1. Set the global state to indicate we are in "edit mode"
    state.groupToEdit = group;

    // 2. Get references to all the UI elements in the group builder
    const groupNameInput = document.getElementById('new-group-name');
    const eventsSelect = document.getElementById('group-events-select');
    const saveBtn = document.getElementById('save-group-btn');
    const studentCheckboxes = document.querySelectorAll('#student-selection-list .student-group-checkbox');

    // 3. Populate the form fields with the group's data
    groupNameInput.value = group.name;

    // Select the events the group is registered for
    Array.from(eventsSelect.options).forEach(option => {
        option.selected = group.events.includes(option.value);
    });

    // Uncheck all students first, then check the ones that are members of this group
    studentCheckboxes.forEach(cb => {
        cb.checked = group.members.some(m => m.studentId === cb.value);
    });
    
    // 4. Update the "Selected Members" list UI and set their roles
    updateGroupBuilderUI(); // This populates the list with selected students
    
    // Now, set the roles for each member in the newly populated list
    const roleSelects = document.querySelectorAll('#group-builder-list .group-member-role');
    roleSelects.forEach(select => {
        const studentId = select.dataset.studentid;
        const member = group.members.find(m => m.studentId === studentId);
        if (member) {
            select.value = member.role;
        }
    });
    
    // 5. Update the save button's text and add a "Cancel" button
    saveBtn.textContent = 'Update Group';
    if (!document.getElementById('cancel-group-edit-btn')) {
        const cancelBtn = `<button type="button" id="cancel-group-edit-btn" class="btn btn-secondary ms-2" onclick="window.clearGroupEditState()">Cancel</button>`;
        saveBtn.insertAdjacentHTML('afterend', cancelBtn);
    }
    
    // Scroll to the top of the group builder for a better user experience
    groupNameInput.focus();
    showAlert(`Now editing: ${group.name}`, 'info');
};

/**
 * Clears the edit state and resets the group builder form to "create new" mode.
 */
window.clearGroupEditState = () => {
    state.groupToEdit = null;
    
    // Reset form fields
    document.getElementById('new-group-name').value = '';
    document.getElementById('group-events-select').selectedIndex = -1;
    document.querySelectorAll('#student-selection-list .student-group-checkbox:checked').forEach(cb => cb.checked = false);
    
    // Update UI elements
    updateGroupBuilderUI();
    document.getElementById('save-group-btn').textContent = 'Create Group & Register';
    document.getElementById('cancel-group-edit-btn')?.remove(); // Safely remove cancel button
};

function renderGroupSelector(festId) {
    const groupSelect = document.getElementById('group-select');
    const groupsForFest = festGroups.filter(g => g.festId === festId);
    if (groupsForFest.length > 0) {
        groupSelect.innerHTML = `<option value="">-- Select a group --</option>${groupsForFest.map(g => `<option value="${g.id}">${g.name}</option>`).join('')}`;
        groupSelect.disabled = false;
    } else {
        groupSelect.innerHTML = `<option value="">-- No Groups Yet --</option>`;
        groupSelect.disabled = true;
    }
}

/**
 * Removes a student from a group, un-registers them from the group's events,
 * and then refreshes the UI automatically.
 * @param {string} groupId - The ID of the group.
 * @param {string} studentId - The ID of the student to remove.
 */
window.removeStudentFromGroup = async (groupId, studentId) => {
    if (!confirm('Are you sure you want to remove this student from the group? This will also un-register them from all of this group\'s events.')) return;

    const group = festGroups.find(g => g.id === groupId);
    if (!group) return showAlert('Group not found.', 'danger');

    // --- 1. Correctly filter the members array, which contains objects, not just IDs ---
    const updatedMembers = group.members.filter(member => member.studentId !== studentId);

    // --- 2. Find all unique group events this group was registered for ---
    // This is needed to correctly un-register the removed student.
    const groupEventIds = new Set();
    group.members.forEach(member => {
        const reg = festRegistrations.find(r => r.studentId === member.studentId && r.festId === group.festId);
        reg?.events.forEach(eventId => {
            const event = festEvents.find(e => e.id === eventId);
            if (event?.isGroupEvent) {
                groupEventIds.add(eventId);
            }
        });
    });

    const batch = writeBatch(db);

    // --- 3. Update the group document with the new, smaller member list ---
    const groupRef = getDocRef('festGroups', groupId);
    batch.update(groupRef, { members: updatedMembers });

    // --- 4. Update the removed student's registration to un-register them from the group events ---
    const studentRegRef = getDocRef('festRegistrations', `${group.festId}_${studentId}`);
    const studentReg = festRegistrations.find(r => r.id === `${group.festId}_${studentId}`);
    if (studentReg) {
        // Keep the student's solo events, but remove the group events
        const updatedEvents = studentReg.events.filter(eventId => !groupEventIds.has(eventId));
        batch.update(studentRegRef, { events: updatedEvents });
    }

    try {
        await batch.commit();
        showAlert('Student removed from group successfully.', 'success');
        
        // --- 5. Correctly refresh the UI by calling the right function ---
        // This is the "auto-update" part. It redraws the list you are currently viewing.
        const fest = state.managingFest;
        const isRegistrationOpen = fest.registrationOpen === true;
        displayHouseGroupsList(fest, group.houseId, isRegistrationOpen);

    } catch (error) {
        console.error("Error removing student from group:", error);
        showAlert('Failed to remove student.', 'danger');
    }
};

// =========================================================================
// --- 6.3 PARTICIPANTS SUB-TAB: CHEST NUMBERS ---
// =========================================================================

/**
 * Renders the "Chest Numbers" sub-tab.
 */
/**
 * Renders the "Chest Numbers" sub-tab with both bulk and manual entry controls.
 */
function renderParticipantChestSection() {
    const container = document.getElementById('pills-chest');
    if (!container || !state.managingFest) return;
    
    const festOptions = fests.map(f => `<option value="${f.id}" ${f.id === state.managingFest.id ? 'selected' : ''}>${f.name}</option>`).join('');
    const houseOptions = festHouses.map(h => `<option value="${h.id}">${h.name}</option>`).join('');

    container.innerHTML = `
        <div class="ui-card mb-4">
            <h5 class="section-header"><i class="fas fa-id-badge me-2"></i>Generate Chest Numbers for ${state.managingFest.name}</h5>
            <p class="small text-muted">Use this section for bulk operations. Manual edits can be done in the table below.</p>
            <div class="row g-3 align-items-end">
                <div class="col-md-2"><label class="form-label">Fest</label><select id="chest-fest-filter" class="form-select" disabled>${festOptions}</select></div>
                <div class="col-md-3"><label class="form-label">Filter by House</label><select id="chest-house-filter" class="form-select"><option value="">All Houses</option>${houseOptions}</select></div>
                <div class="col-md-2"><label class="form-label">Prefix</label><input type="text" id="chest-prefix" class="form-control" placeholder="e.g., A"></div>
                <div class="col-md-2"><label class="form-label">Start Number</label><input type="number" id="chest-start-no" class="form-control" value="101" min="1"></div>
                <div class="col-md-3 d-grid">
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="window.generateChestNumbers()"><i class="fas fa-cogs me-1"></i>Generate for Empty</button>
                        <button class="btn btn-danger" onclick="window.clearAllChestNumbers()"><i class="fas fa-trash-alt me-1"></i>Clear All</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="chest-number-table-container" class="ui-card"></div>
    `;

    attachChestNumberListeners();
    renderChestNumberTable();
}

/**
 * Attaches event listeners for the Chest Number filters and the interactive table.
 */
function attachChestNumberListeners() {
    document.getElementById('chest-house-filter').addEventListener('change', renderChestNumberTable);
    
    // Use event delegation for the dynamic table
    const tableContainer = document.getElementById('chest-number-table-container');
    tableContainer.addEventListener('click', (e) => {
        const target = e.target;
        if (target.classList.contains('save-single-chest-btn')) {
            const input = target.closest('tr').querySelector('.chest-no-input');
            const regId = target.closest('tr').dataset.regId;
            saveSingleChestNumber(regId, input);
        }
        if (target.classList.contains('suggest-next-btn')) {
            const input = target.closest('tr').querySelector('.chest-no-input');
            suggestNextChestNumber(input);
        }
    });
}

/**
 * Renders the interactive table for viewing and editing chest numbers.
 */
function renderChestNumberTable() {
    const container = document.getElementById('chest-number-table-container');
    const festId = state.managingFest.id;
    const houseId = document.getElementById('chest-house-filter').value;

    let registrations = festRegistrations.filter(r => r.festId === festId && (!houseId || r.houseId === houseId))
        .sort((a,b) => (a.studentName || '').localeCompare(b.studentName || ''));
    
    container.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="section-header mb-0"><i class="fas fa-list-ol me-2"></i>Participants (${registrations.length})</h5>
            <div>
                <button class="btn btn-sm btn-success me-2" onclick="window.downloadChestNumbersCSV()"><i class="fas fa-file-csv me-1"></i>Export CSV</button>
                <button class="btn btn-sm btn-danger" onclick="window.downloadChestNumbersPDF()"><i class="fas fa-file-pdf me-1"></i>Export PDF</button>
            </div>
        </div>
        <div class="table-responsive mt-3">
            <table class="table table-sm table-hover" id="chest-number-table">
                <thead><tr><th>Student Name</th><th>House</th><th style="width: 25%;">Chest No.</th><th style="width: 15%;" class="text-end">Actions</th></tr></thead>
                <tbody>
                    ${registrations.map(reg => {
                        const student = students.find(s => s.id === reg.studentId);
                        const house = festHouses.find(h => h.id === reg.houseId);
                        const hasChestNo = reg.chestNo && reg.chestNo !== 'N/A';
                        
                        return `
                            <tr data-reg-id="${reg.id}">
                                <td>${student?.name || 'Unknown'}</td>
                                <td>${house?.name || 'N/A'}</td>
                                <td>
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control chest-no-input" value="${reg.chestNo || ''}" placeholder="Not assigned">
                                        ${!hasChestNo ? `<button class="btn btn-outline-secondary suggest-next-btn" type="button">Next</button>` : ''}
                                    </div>
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-success save-single-chest-btn">Save</button>
                                </td>
                            </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>`;
}
/**
 * Generates and downloads a detailed PDF participant list with chest numbers,
 * class details, and a list of registered events.
 */
window.downloadChestNumbersPDF = function() {
    // 1. Get the current filters from the UI
    const festId = state.managingFest.id;
    const houseId = document.getElementById('chest-house-filter').value;
    const fest = state.managingFest;

    // 2. Filter the list of registrations based on the selected filters
    let registrations = festRegistrations.filter(r => r.festId === festId && (!houseId || r.houseId === houseId));

    if (registrations.length === 0) {
        return showAlert('No participants found for the selected filters to export.', 'info');
    }

    // Sort the list by chest number for an organized report
    registrations.sort((a, b) => {
        // Handle cases where chest numbers might be null or not purely numeric
        const numA = parseInt(String(a.chestNo || '0').replace(/\D/g, ''), 10);
        const numB = parseInt(String(b.chestNo || '0').replace(/\D/g, ''), 10);
        return numA - numB;
    });

    // 3. Prepare the data for each row in the PDF table
    const body = registrations.map((reg, index) => {
        const student = students.find(s => s.id === reg.studentId);
        
        // Column 1: Serial Number
        const slNo = index + 1;
        
        // Column 2: Admission Number
        const admnNo = student?.admissionNumber || 'N/A';
        
        // Column 3: Chest Number
        const chestNo = reg.chestNo || 'N/A';
        
        // Column 4: Name with Class
        const nameAndClass = `${student?.name || 'Unknown'} (${getStudentClassName(student?.classId, student?.division)})`;
        
        // Column 5: Comma-separated list of program items (events)
        const programItems = reg.events
            .map(eventId => festEvents.find(e => e.id === eventId)?.name)
            .filter(Boolean) // Removes any undefined events if they were deleted
            .join(', ');

        return [slNo, admnNo, chestNo, nameAndClass, programItems];
    });

    // 4. Configure the PDF document
    const { jsPDF } = window.jspdf;
    // Use landscape ('l') orientation to give more space for the events column
    const doc = new jsPDF('l', 'mm', 'a4'); 

    const reportTitle = `Participant List - ${fest.name}`;
    const subTitle = houseId ? `House: ${festHouses.find(h => h.id === houseId)?.name}` : 'All Houses';
    
    // Add a professional header
    doc.setFontSize(18);
    doc.text(reportTitle, doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });
    doc.setFontSize(12);
    doc.text(subTitle, doc.internal.pageSize.getWidth() / 2, 29, { align: 'center' });

    // 5. Define the table headers
    const head = [['Sl. No.', 'Admn No.', 'Chest No.', 'Name & Class', 'Registered Events']];

    // 6. Generate the table using the autoTable plugin
    doc.autoTable({
        head: head,
        body: body,
        startY: 35, // Start the table below the header
        theme: 'grid',
        headStyles: { fillColor: [41, 128, 185] }, // A nice blue header
        columnStyles: {
            0: { cellWidth: 15 },    // Sl. No.
            1: { cellWidth: 25 },    // Admn No.
            2: { cellWidth: 25 },    // Chest No.
            3: { cellWidth: 60 },    // Name & Class
            4: { cellWidth: 'auto' } // Let the Events column take the remaining space
        }
    });

    // 7. Save the generated PDF
    doc.save(`Participant_List_${fest.name}.pdf`);
}

/**
 * Generates and downloads a detailed CSV participant list with chest numbers,
 * class details, and a list of registered events.
 */
window.downloadChestNumbersCSV = function() {
    // 1. Get the current filters from the UI
    const festId = state.managingFest.id;
    const houseId = document.getElementById('chest-house-filter').value;
    const fest = state.managingFest;

    // 2. Filter the list of registrations based on the selected filters
    let registrations = festRegistrations.filter(r => r.festId === festId && (!houseId || r.houseId === houseId));

    if (registrations.length === 0) {
        return showAlert('No participants found for the selected filters to export.', 'info');
    }

    // Sort the list by chest number for an organized report
    registrations.sort((a, b) => {
        const numA = parseInt(String(a.chestNo || '0').replace(/\D/g, ''), 10);
        const numB = parseInt(String(b.chestNo || '0').replace(/\D/g, ''), 10);
        return numA - numB;
    });

    // 3. Define the CSV headers
    const headers = ['Sl. No.', 'Admission Number', 'Chest Number', 'Name & Class', 'Registered Events'];
    const csvRows = [headers.join(',')]; // Start the CSV content with the header row

    // 4. Create a data row for each participant
    registrations.forEach((reg, index) => {
        const student = students.find(s => s.id === reg.studentId);
        
        const slNo = index + 1;
        const admnNo = student?.admissionNumber || 'N/A';
        const chestNo = reg.chestNo || 'N/A';
        const nameAndClass = `${student?.name || 'Unknown'} (${getStudentClassName(student?.classId, student?.division)})`;
        
        // Join the event names with a comma and space for the "Registered Events" column
        const programItems = reg.events
            .map(eventId => festEvents.find(e => e.id === eventId)?.name)
            .filter(Boolean) // Removes any null/undefined events
            .join(', ');

        const rowData = [slNo, admnNo, chestNo, nameAndClass, programItems];
        
        // Format each cell value to be CSV-safe (wrap in quotes, escape existing quotes)
        const formattedRow = rowData.map(val => `"${String(val).replace(/"/g, '""')}"`).join(',');
        csvRows.push(formattedRow);
    });

    // 5. Create a Blob from the CSV content and trigger the download
    const csvContent = csvRows.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");

    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `Participant_List_${fest.name}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
/**
 * MODIFIED: Now only assigns numbers to participants who DO NOT have one.
 */
window.generateChestNumbers = async function() {
    const festId = state.managingFest.id;
    const houseId = document.getElementById('chest-house-filter').value;
    const prefix = document.getElementById('chest-prefix').value.trim().toUpperCase();
    let currentNumber = parseInt(document.getElementById('chest-start-no').value);

    if (isNaN(currentNumber)) return showAlert('Please enter a valid start number.', 'danger');
    
    // --- MODIFICATION: Only select participants WITHOUT a chest number ---
    const participantsToUpdate = festRegistrations.filter(r => r.festId === festId && (!houseId || r.houseId === houseId) && !r.chestNo);
    
    if (participantsToUpdate.length === 0) return showAlert('No participants are missing a chest number.', 'info');
    if (!confirm(`This will assign new chest numbers to ${participantsToUpdate.length} students. Continue?`)) return;

    const batch = writeBatch(db);
    participantsToUpdate.sort((a,b) => a.studentName.localeCompare(b.studentName)); // Sort for consistent numbering
    
    participantsToUpdate.forEach(reg => {
        const chestNo = `${prefix}${currentNumber++}`;
        const regRef = getDocRef('festRegistrations', reg.id);
        batch.update(regRef, { chestNo: chestNo });
    });

    try {
        await batch.commit();
        showAlert('Chest numbers assigned to remaining participants successfully!', 'success');
        renderChestNumberTable();
    } catch(error) {
        console.error("Error generating chest numbers:", error);
        showAlert('Failed to generate chest numbers.', 'danger');
    }
}

/**
 * NEW: Clears all chest numbers for the selected filters.
 */
window.clearAllChestNumbers = async function() {
    const festId = state.managingFest.id;
    const houseId = document.getElementById('chest-house-filter').value;
    
    const participantsToClear = festRegistrations.filter(r => r.festId === festId && (!houseId || r.houseId === houseId) && r.chestNo);
    if (participantsToClear.length === 0) return showAlert('No chest numbers to clear for this filter.', 'info');
    if (!confirm(`DANGER: This will clear chest numbers for ${participantsToClear.length} students. Are you sure?`)) return;

    const batch = writeBatch(db);
    participantsToClear.forEach(reg => {
        const regRef = getDocRef('festRegistrations', reg.id);
        batch.update(regRef, { chestNo: null });
    });
    
    try {
        await batch.commit();
        showAlert('All chest numbers for the selected filter have been cleared.', 'success');
        renderChestNumberTable();
    } catch(error) {
        console.error("Error clearing chest numbers:", error);
        showAlert('Failed to clear chest numbers.', 'danger');
    }
}

/**
 * NEW: Saves the chest number for a single student.
 */
window.saveSingleChestNumber = async function(regId, inputElement) {
    const newChestNo = inputElement.value.trim().toUpperCase() || null; // Save as null if empty
    const regRef = getDocRef('festRegistrations', regId);
    try {
        await updateDoc(regRef, { chestNo: newChestNo });
        // Give visual feedback
        inputElement.classList.add('is-valid');
        setTimeout(() => inputElement.classList.remove('is-valid'), 2000);
    } catch (error) {
        showAlert('Failed to save chest number.', 'danger');
        inputElement.classList.add('is-invalid');
    }
}

/**
 * NEW: Calculates and suggests the next available chest number based on a specific prefix.
 */
window.suggestNextChestNumber = function(inputElement) {
    const festId = state.managingFest.id;
    const prefix = document.getElementById('chest-prefix').value.trim().toUpperCase();

    // 1. Filter registrations for this fest that have a chest number AND start with the current prefix.
    const relevantRegistrations = festRegistrations.filter(r => 
        r.festId === festId && 
        r.chestNo && 
        r.chestNo.startsWith(prefix)
    );

    // 2. Find the highest number among these relevant registrations.
    const maxNum = relevantRegistrations.reduce((max, r) => {
        // 3. Remove the prefix to get the numeric part of the string.
        const numStr = r.chestNo.substring(prefix.length);
        const numPart = parseInt(numStr, 10);
        
        // 4. Compare and find the max.
        return !isNaN(numPart) && numPart > max ? numPart : max;
    }, 0); // Start with a max of 0. If no matching prefixes found, it will start from 1.

    // 5. The next number is the highest found + 1.
    const nextNum = maxNum + 1;

    // 6. Set the input field's value with the prefix and the new number.
    inputElement.value = `${prefix}${nextNum}`;
}

/**
 * Renders the "Registration" sub-tab, disabling controls if registration is closed.
 * @param {boolean} isRegistrationOpen - The registration status of the current fest.
 */
/**
 * Renders the "Registration" sub-tab with a modern, filterable, accordion-based UI.
 * @param {boolean} isRegistrationOpen - The registration status of the current fest.
 */
/**
 * Renders the "Registration" sub-tab with an improved UI including house filter and quick find.
 * @param {boolean} isRegistrationOpen - The registration status of the current fest.
 */
function renderParticipantRegistrationSection(isRegistrationOpen) {
    const container = document.getElementById('pills-registration');
    if (!container) return;

    const classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    // NEW: House options for the filter
    const houseOptions = festHouses.map(h => `<option value="${h.id}">${h.name}</option>`).join('');

    container.innerHTML = `
        <div class="ui-card mb-4">
            <h5 class="section-header"><i class="fas fa-search me-2"></i>Quick Find by Admission Number</h5>
            <p class="small text-muted">Instantly find a student by their admission number, bypassing other filters.</p>
            <div class="input-group">
                <input type="text" id="reg-admn-no-lookup" class="form-control" placeholder="Enter Admission No...">
                <button class="btn btn-primary" id="find-student-by-admn-btn">Find Student</button>
            </div>
        </div>
        
        <div class="ui-card mb-4">
            <h5 class="section-header"><i class="fas fa-filter me-2"></i>Filter Student List</h5>
            
            ${!isRegistrationOpen ? `
                <div class="alert alert-warning">
                    <i class="fas fa-lock me-2"></i>Registration is closed. You can view participants but cannot make changes.
                </div>
            ` : ''}
            
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Filter by Class</label>
                    <select id="reg-class-filter" class="form-select">
                        <option value="">All Classes</option>
                        ${classOptions}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Filter by Division</label>
                    <select id="reg-division-filter" class="form-select" disabled>
                        <option value="">All Divisions</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Filter by House</label>
                    <select id="reg-house-filter" class="form-select">
                        <option value="">All Houses</option>
                        ${houseOptions}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Search by Name</label>
                    <input type="text" id="reg-search-input" class="form-control" placeholder="Filter by name...">
                </div>
            </div>
        </div>

        <div id="participant-registration-list" class="ui-card">
            <p class="text-muted p-5 text-center">Please select a class and division to load the student list.</p>
        </div>
    `;
    
    attachRegistrationListeners(isRegistrationOpen);
}
/**
 * Attaches event listeners for the new registration UI filters and buttons.
 * @param {boolean} isRegistrationOpen - The registration status of the fest.
 */
function attachRegistrationListeners(isRegistrationOpen) {
    const classFilter = document.getElementById('reg-class-filter');
    const divisionFilter = document.getElementById('reg-division-filter');
    const houseFilter = document.getElementById('reg-house-filter'); // New
    const searchInput = document.getElementById('reg-search-input');
    const findByAdmnBtn = document.getElementById('find-student-by-admn-btn'); // New

    // Populate divisions when class changes
    classFilter.addEventListener('change', () => {
        const classId = classFilter.value;
        divisionFilter.innerHTML = '<option value="">All Divisions</option>';
        if (classId) {
            const classData = classes.find(c => c.id === classId);
            if (classData?.divisions) {
                divisionFilter.innerHTML += classData.divisions.map(d => `<option value="${d}">${d}</option>`).join('');
                divisionFilter.disabled = false;
            }
        } else {
            divisionFilter.disabled = true;
        }
        renderParticipantListForRegistration(isRegistrationOpen);
    });

    // Add listeners to all filters
    divisionFilter.addEventListener('change', () => renderParticipantListForRegistration(isRegistrationOpen));
    houseFilter.addEventListener('change', () => renderParticipantListForRegistration(isRegistrationOpen));
    searchInput.addEventListener('input', () => renderParticipantListForRegistration(isRegistrationOpen));

    // Listener for the Quick Find button
    findByAdmnBtn.addEventListener('click', () => {
        const admnNo = document.getElementById('reg-admn-no-lookup').value.trim();
        if (!admnNo) {
            return showAlert('Please enter an Admission Number to find.', 'warning');
        }
        const student = students.find(s => s.admissionNumber === admnNo);

        if (student) {
            // If student found, render the list with ONLY that student
            renderParticipantListForRegistration(isRegistrationOpen, [student]);
        } else {
            showAlert(`No student found with Admission Number: ${admnNo}`, 'danger');
        }
    });
}

/**
 * Renders the accordion list of students based on the current filter values.
 * @param {boolean} isRegistrationOpen - The registration status of the fest.
 */
function renderParticipantRegistrationSectionold(isRegistrationOpen) {
    const container = document.getElementById('pills-registration');
    if (!container) return;

    const classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

    container.innerHTML = `
        <div class="ui-card mb-4">
            <h5 class="section-header"><i class="fas fa-filter me-2"></i>Filter Participants</h5>
            
            ${!isRegistrationOpen ? `
                <div class="alert alert-warning small p-2">
                    <i class="fas fa-lock me-2"></i>Registration is closed. Adding and editing participants is disabled.
                </div>
            ` : ''}
            <div id="bulk-registration-view"></div>
            <div id="participant-list-view"></div>
            
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Filter by Class</label>
                    <select id="participant-class-filter" class="form-select">
                        <option value="">All Classes</option>
                        ${classOptions}
                    </select>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Search by Name / Admn No.</label>
                    <input type="text" id="participant-search-input" class="form-control" placeholder="Start typing...">
                </div>
                <div class="col-md-3 d-grid">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registrationModal" ${!isRegistrationOpen ? 'disabled' : ''}>
                        <i class="fas fa-user-plus me-2"></i>Register New Participant
                    </button>
                </div>
            </div>
        </div>
        <div id="participants-table-container" class="ui-card"></div>
        `;
    
    // The table rendering function also needs the status to disable edit buttons
    //renderParticipantsTable(isRegistrationOpen); 
    attachMainParticipantListeners();
    // The listener function might also need the status for save actions
    attachParticipantsTabListeners(isRegistrationOpen);
}

/**
 * Renders the accordion list of students. Can either use filters or a provided student list.
 * @param {boolean} isRegistrationOpen - The registration status of the fest.
 * @param {Array|null} [studentList=null] - An optional, pre-filtered list of students to display.
 */
function renderParticipantListForRegistration22(isRegistrationOpen, studentList = null) {
    const container = document.getElementById('participant-registration-list');
    let studentsToDisplay;

    if (studentList) {
        // If a specific list is provided (from Quick Find), use it
        studentsToDisplay = studentList;
    } else {
        // Otherwise, use the filters to build the list
        const classId = document.getElementById('reg-class-filter').value;
        const division = document.getElementById('reg-division-filter').value;
        const houseId = document.getElementById('reg-house-filter').value;
        const searchTerm = document.getElementById('reg-search-input').value.toLowerCase();

        if (!classId && !houseId && !searchTerm) {
             container.innerHTML = '<p class="text-muted p-5 text-center">Use the filters or Quick Find to display students.</p>';
             return;
        }

        studentsToDisplay = students.filter(s => {
            const classMatch = !classId || s.classId === classId;
            const divisionMatch = !division || s.division === division;
            const houseMatch = !houseId || s.houseId === houseId;
            const searchMatch = !searchTerm || s.name.toLowerCase().includes(searchTerm);
            return classMatch && divisionMatch && houseMatch && searchMatch;
        });
    }

    if (studentsToDisplay.length === 0) {
        container.innerHTML = '<p class="text-muted p-5 text-center">No students found matching your criteria.</p>';
        return;
    }

    // Build the accordion HTML (this logic is the same as before)
    container.innerHTML = `<div class="accordion" id="student-reg-accordion">
        ${studentsToDisplay.map(student => {
            const registration = festRegistrations.find(r => r.festId === state.managingFest.id && r.studentId === student.id);
            const eventCount = registration?.events.length || 0;
            const house = festHouses.find(h => h.id === (registration?.houseId || student.houseId));
            return `
                <div class="accordion-item" id="student-item-${student.id}">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${student.id}">
                            <div class="d-flex w-100 justify-content-between align-items-center pe-3">
                                <span><strong>${student.name}</strong><small class="text-muted ms-2">(${student.admissionNumber})</small></span>
                                <span>
                                    ${house ? `<span class="badge me-3" style="background-color:${house.color}; color:white;">${house.name}</span>` : ''}
                                    <span class="badge bg-primary rounded-pill event-count-badge">${eventCount} Events</span>
                                </span>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse-${student.id}" class="accordion-collapse collapse" data-bs-parent="#student-reg-accordion">
                        <div class="accordion-body">
                            ${generateEventSelectionCheckboxes(student, isRegistrationOpen)}
                        </div>
                    </div>
                </div>
            `;
        }).join('')}
    </div>`;

    // If this was a quick find, add a "Clear" button
    if (studentList) {
        const clearButton = `<div class="text-center mt-3"><button class="btn btn-secondary" onclick="renderParticipantListForRegistration(${isRegistrationOpen})">Clear Search & Show Filtered List</button></div>`;
        container.insertAdjacentHTML('beforeend', clearButton);
    }
    
}

/**
 * Generates an interactive UI for SOLO event selection with real-time validation.
 * This is a robust version with added safety checks and alphabetical sorting.
 * @param {object} student - The student object.
 * @param {boolean} isRegistrationOpen - The registration status of the fest.
 * @returns {string} The HTML for the form within the accordion body.
 */
/**
 * Generates an interactive UI for SOLO event selection with real-time validation,
 * including alphabetical sorting and a corrected gender filter.
 * @param {object} student - The student object.
 * @param {boolean} isRegistrationOpen - The registration status of the fest.
 * @returns {string} The HTML for the form within the accordion body.
 */
function generateEventSelectionCheckboxes(student, isRegistrationOpen) {
    // Get the currently managed fest from the global state
    const fest = state.managingFest;
    const studentCategory = getStudentCategory(student);

    // Find the student's existing registration to know which events are already selected
    const existingReg = festRegistrations.find(r => r.festId === fest.id && r.studentId === student.id);
    const registeredEventIds = existingReg?.events || [];
    const houseId = existingReg?.houseId || student.houseId;

    // Safety Check 1: Ensure the student is assigned to a house
    if (!houseId) {
        return `<div class="alert alert-warning">This student has not been assigned to a house. Please use the "House Allocation" tab first.</div>`;
    }

    // Safety Check 2: Ensure fest settings are loaded
    if (!fest.settings) {
         return `<div class="alert alert-danger">Fest settings are not configured. Please visit the Setup tab.</div>`;
    }
    const settings = fest.settings;

    // --- 1. Get SOLO Limits from Fest Settings ---
    const studentLimits = {
        onStage: { solo: settings.maxOnStageSoloEvents || 2 },
        offStage: { solo: settings.maxOffStageSoloEvents || 1 }
    };
    const houseLimits = {
        onStage: { solo: settings.houseEventLimits?.onStage?.solo || 2 },
        offStage: { solo: settings.houseEventLimits?.offStage?.solo || 2 }
    };

    // --- 2. Filter for Eligible SOLO Events and Sort Alphabetically ---
    // --- MODIFICATION: Added the gender check to this filter ---
    const eligibleEvents = festEvents.filter(e =>
        e.festId === fest.id &&
        (e.category === 'General' || e.category === studentCategory) &&
        // This is the corrected gender check
        (!e.gender || e.gender === 'Common' || (student.gender === 'M' && e.gender === 'Male') || (student.gender === 'F' && e.gender === 'Female'))
    );
    
    const onStageSoloEvents = eligibleEvents
        .filter(e => e.type !== 'offStage' && !e.isGroupEvent)
        .sort((a, b) => a.name.localeCompare(b.name));

    const offStageSoloEvents = eligibleEvents
        .filter(e => e.type === 'offStage' && !e.isGroupEvent)
        .sort((a, b) => a.name.localeCompare(b.name));

    // --- 3. Count Student's Current SOLO Selections ---
    const studentSelections = { onStage: { solo: 0 }, offStage: { solo: 0 } };
    registeredEventIds.forEach(id => {
        const ev = eligibleEvents.find(e => e.id === id);
        if (ev && !ev.isGroupEvent) {
            const type = ev.type || 'onStage';
            studentSelections[type].solo++;
        }
    });

    // --- 4. Render a Simplified Selection Summary for SOLO events ---
    const summaryHtml = `
        <div class="p-2 mb-3 border rounded bg-white">
            <h6 class="small text-muted mb-2">STUDENT SOLO EVENT LIMITS</h6>
            <div class="row g-2 small">
                <div class="col-6">On-Stage Solo: <strong id="count-onStage-solo-${student.id}">${studentSelections.onStage.solo} / ${studentLimits.onStage.solo}</strong></div>
                <div class="col-6">Off-Stage Solo: <strong id="count-offStage-solo-${student.id}">${studentSelections.offStage.solo} / ${studentLimits.offStage.solo}</strong></div>
            </div>
        </div>
    `;

    // --- 5. Helper Function to Create Checkbox Lists ---
    const createCheckboxList = (events) => {
        if (events.length === 0) return `<p class="text-muted col-12">No solo events available for this student.</p>`;
        
        return events.map(event => {
            let disabled = !isRegistrationOpen;
            let reason = isRegistrationOpen ? '' : 'Registration is closed.';
            const studentEventType = event.type || 'onStage';

            if (studentSelections[studentEventType].solo >= studentLimits[studentEventType].solo && !registeredEventIds.includes(event.id)) {
                disabled = true;
                reason = `Student's limit for solo ${studentEventType} events reached.`;
            }

            const houseRegs = festRegistrations.filter(r => r.houseId === houseId && r.events.includes(event.id));
            const houseCount = houseRegs.length;
            const houseEventLimit = houseLimits[studentEventType].solo;
            if (houseCount >= houseEventLimit && !registeredEventIds.includes(event.id)) {
                disabled = true;
                reason = `House limit (${houseEventLimit}) for this event reached.`;
            }
            
            const totalRegs = festRegistrations.filter(r => r.events.includes(event.id));
            if (event.maxParticipants > 0 && totalRegs.length >= event.maxParticipants && !registeredEventIds.includes(event.id)) {
                disabled = true;
                reason = `Event is full (${event.maxParticipants} participants).`;
            }
            
            const houseCountDisplay = `(${houseCount}/${houseEventLimit})`;

            return `
                <div class="col-12 col-md-6">
                    <div class="form-check" title="${reason}">
                        <input class="form-check-input event-checkbox" type="checkbox" value="${event.id}" 
                               id="event-${student.id}-${event.id}" 
                               ${registeredEventIds.includes(event.id) ? 'checked' : ''} ${disabled ? 'disabled' : ''}>
                        <label class="form-check-label ${disabled ? 'text-muted' : ''}" for="event-${student.id}-${event.id}">
                            ${event.name} <span class="badge bg-light text-dark">${houseCountDisplay}</span>
                        </label>
                    </div>
                </div>`;
        }).join('');
    };

    // --- 6. Assemble the Final HTML for the accordion body ---
    return `
        <div class="p-3 bg-light rounded" id="event-selection-area-${student.id}">
            ${summaryHtml}
            <div class="d-flex justify-content-center mb-3">
                <div class="btn-group">
                    <button class="btn btn-sm btn-primary active" id="btn-onstage-${student.id}" onclick="toggleEventTypeView('${student.id}', 'onStage')">On-Stage</button>
                    <button class="btn btn-sm btn-primary" id="btn-offstage-${student.id}" onclick="toggleEventTypeView('${student.id}', 'offStage')">Off-Stage</button>
                </div>
            </div>
            <div id="onstage-container-${student.id}">
                <h6 class="text-primary">On-Stage Solo Events</h6>
                <div class="row g-2">${createCheckboxList(onStageSoloEvents)}</div>
            </div>
            <div id="offstage-container-${student.id}" style="display:none;">
                <h6 class="text-primary">Off-Stage Solo Events</h6>
                <div class="row g-2">${createCheckboxList(offStageSoloEvents)}</div>
            </div>
            <div class="text-end mt-3 border-top pt-3">
                <button class="btn btn-success" onclick="saveSingleStudentRegistration('${student.id}', '${fest.id}')" ${!isRegistrationOpen ? 'disabled' : ''}>
                    Save Changes for ${student.name}
                </button>
            </div>
        </div>
    `;
}
/**
 * Attaches live validation listeners to the event checkboxes for a single student.
 * This function makes the counters and disabled states update instantly.
 * @param {HTMLElement} accordionBody - The accordion body element containing the form.
 * @param {object} student - The student object.
 * @param {object} fest - The current fest object.
 */
function attachLiveValidationListeners(accordionBody, student, fest) {
    const checkboxes = accordionBody.querySelectorAll('.event-checkbox');
    if (checkboxes.length === 0) return;

    const settings = fest.settings || {};
    const studentLimits = {
        onStage: { solo: settings.maxOnStageSoloEvents || 2, group: settings.maxOnStageGroupEvents || 2 },
        offStage: { solo: settings.maxOffStageSoloEvents || 1, group: settings.maxOffStageGroupEvents || 1 }
    };

    const updateUI = () => {
        // 1. Recalculate current selections based on CHECKED BOXES
        const studentSelections = { onStage: { solo: 0, group: 0 }, offStage: { solo: 0, group: 0 } };
        const eligibleEvents = festEvents.filter(e => e.festId === fest.id);
        
        accordionBody.querySelectorAll('.event-checkbox:checked').forEach(cb => {
            const ev = eligibleEvents.find(e => e.id === cb.value);
            if (ev) {
                const type = ev.type || 'onStage';
                const mode = ev.isGroupEvent ? 'group' : 'solo';
                studentSelections[type][mode]++;
            }
        });

        // 2. Update the summary text
        document.getElementById(`count-onStage-solo-${student.id}`).textContent = `${studentSelections.onStage.solo} / ${studentLimits.onStage.solo}`;
        document.getElementById(`count-onStage-group-${student.id}`).textContent = `${studentSelections.onStage.group} / ${studentLimits.onStage.group}`;
        document.getElementById(`count-offStage-solo-${student.id}`).textContent = `${studentSelections.offStage.solo} / ${studentLimits.offStage.solo}`;
        document.getElementById(`count-offStage-group-${student.id}`).textContent = `${studentSelections.offStage.group} / ${studentLimits.offStage.group}`;

        // 3. Re-evaluate and disable/enable all other checkboxes
        checkboxes.forEach(cb => {
            if (!cb.checked) { // Only check limits for the boxes that are NOT checked
                const event = eligibleEvents.find(e => e.id === cb.value);
                const eventType = event.type || 'onStage';
                const eventMode = event.isGroupEvent ? 'group' : 'solo';
                
                // If the student's personal limit for this category is reached, disable the checkbox
                if (studentSelections[eventType][eventMode] >= studentLimits[eventType][eventMode]) {
                    cb.disabled = true;
                } else {
                    // Re-enable it if the count goes down (but don't re-enable if it was disabled for other reasons like house limit)
                    const houseLimitReached = cb.closest('.form-check').title.includes('House limit');
                    const eventFull = cb.closest('.form-check').title.includes('Event is full');
                    if (!houseLimitReached && !eventFull) {
                        cb.disabled = false;
                    }
                }
            }
        });
    };

    // Attach the listener to every checkbox in this student's panel
    checkboxes.forEach(cb => cb.addEventListener('change', updateUI));
}

// Replace your renderParticipantListForRegistration with this version
window.renderParticipantListForRegistration = (isRegistrationOpen, studentList = null) => {
    const container = document.getElementById('participant-registration-list');
    let studentsToDisplay;

    // ... (the existing logic to filter students is the same) ...
    if (studentList) {
        studentsToDisplay = studentList;
    } else {
        const classId = document.getElementById('reg-class-filter').value;
        const division = document.getElementById('reg-division-filter').value;
        const houseId = document.getElementById('reg-house-filter').value;
        const searchTerm = document.getElementById('reg-search-input').value.toLowerCase();
        if (!classId && !houseId && !searchTerm) {
             container.innerHTML = '<p class="text-muted p-5 text-center">Use the filters or Quick Find to display students.</p>';
             return;
        }
        studentsToDisplay = students.filter(s => {
            const classMatch = !classId || s.classId === classId;
            const divisionMatch = !division || s.division === division;
            const houseMatch = !houseId || s.houseId === houseId;
            const searchMatch = !searchTerm || s.name.toLowerCase().includes(searchTerm);
            return classMatch && divisionMatch && houseMatch && searchMatch;
        });
    }

    if (studentsToDisplay.length === 0) {
        container.innerHTML = '<p class="text-muted p-5 text-center">No students found matching your criteria.</p>';
        return;
    }

    // Build the accordion HTML (this logic is the same)
    container.innerHTML = `<div class="accordion" id="student-reg-accordion">
        ${studentsToDisplay.map(student => {
            const registration = festRegistrations.find(r => r.festId === state.managingFest.id && r.studentId === student.id);
            const eventCount = registration?.events.length || 0;
            const house = festHouses.find(h => h.id === (registration?.houseId || student.houseId));
            return `<div class="accordion-item" id="student-item-${student.id}"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${student.id}"><div class="d-flex w-100 justify-content-between align-items-center pe-3">                <span>
                    <strong>${student.name}</strong>
                    <small class="text-muted ms-2">(${student.admissionNumber} | ${getStudentClassName(student.classId, student.division)})</small>
                </span>
<span>${house ? `<span class="badge me-3" style="background-color:${house.color}; color:white;">${house.name}</span>` : ''}<span class="badge bg-primary rounded-pill event-count-badge">${eventCount} Events</span></span></div></button></h2><div id="collapse-${student.id}" class="accordion-collapse collapse" data-bs-parent="#student-reg-accordion"><div class="accordion-body">${generateEventSelectionCheckboxes(student, isRegistrationOpen)}</div></div></div>`;
        }).join('')}
    </div>`;

    // --- NEW: Attach the live listeners after the HTML is rendered ---
    studentsToDisplay.forEach(student => {
        const accordionBody = document.querySelector(`#collapse-${student.id} .accordion-body`);
        if (accordionBody) {
            attachLiveValidationListeners(accordionBody, student, state.managingFest);
        }
    });

    if (studentList) {
        const clearButton = `<div class="text-center mt-3"><button class="btn btn-secondary" onclick="renderParticipantListForRegistration(${isRegistrationOpen})">Clear Search & Show Filtered List</button></div>`;
        container.insertAdjacentHTML('beforeend', clearButton);
    }
}

/**
 * NEW: Helper function to toggle the view between On-Stage and Off-Stage events.
 * @param {string} studentId - The student ID, used to make element IDs unique.
 * @param {string} typeToShow - 'onStage' or 'offStage'.
 */
window.toggleEventTypeView = (studentId, typeToShow) => {
    const onStageContainer = document.getElementById(`onstage-container-${studentId}`);
    const offStageContainer = document.getElementById(`offstage-container-${studentId}`);
    const onStageBtn = document.getElementById(`btn-onstage-${studentId}`);
    const offStageBtn = document.getElementById(`btn-offstage-${studentId}`);

    if (typeToShow === 'onStage') {
        onStageContainer.style.display = 'block';
        offStageContainer.style.display = 'none';
        onStageBtn.classList.add('active');
        offStageBtn.classList.remove('active');
    } else {
        onStageContainer.style.display = 'none';
        offStageContainer.style.display = 'block';
        onStageBtn.classList.remove('active');
        offStageBtn.classList.add('active');
    }
}

/**
 * Saves (creates or updates) the registration for a single student.
 * @param {string} studentId - The ID of the student.
 * @param {string} festId - The ID of the fest.
 */
window.saveSingleStudentRegistration = async(studentId, festId)=> {
    const studentAccordion = document.getElementById(`student-item-${studentId}`);
    if (!studentAccordion) return;

    const student = students.find(s => s.id === studentId);
    const selectedEventIds = Array.from(studentAccordion.querySelectorAll('.event-checkbox:checked')).map(cb => cb.value);

    const regId = `${festId}_${studentId}`;
    const existingReg = festRegistrations.find(r => r.id === regId);

    const registrationData = {
        id: regId,
        festId: festId,
        studentId: student.id,
        studentName: student.name,
        houseId: existingReg?.houseId || student.houseId || null,
        chestNo: existingReg?.chestNo || null,
        events: selectedEventIds
    };

    try {
        await setDoc(getDocRef('festRegistrations', regId), registrationData);
        showAlert(`Registration updated for ${student.name}.`, 'success');
        
        // Update the event count badge on the accordion header
        const badge = studentAccordion.querySelector('.event-count-badge');
        if (badge) {
            badge.textContent = `${selectedEventIds.length} Events`;
        }

    } catch (error) {
        console.error("Error saving registration:", error);
        showAlert(`Failed to save for ${student.name}.`, 'danger');
    }
}
/**
 * Renders the event selection modal with corrected filtering and smart disabling logic.
 * @param {string} festId The ID of the fest.
 * @param {object} student The student object.
 * @param {object|null} existingReg The existing registration data if editing.
 */
/**
 * Renders an advanced event selection modal with On-Stage/Off-Stage toggling and granular limits.
 * @param {string} festId - The ID of the fest.
 * @param {object} student - The student object.
 * @param {object|null} existingReg - The existing registration object, if editing.
 */
function renderEventsInModal(festId, student, existingReg = null) {
    const containerId = existingReg ? 'edit-form-content' : 'reg-modal-form-body';
    const container = document.getElementById(containerId);
    if (!container) return;

    const fest = fests.find(f => f.id === festId);
    if (!fest?.settings) {
        container.innerHTML = `<p class="text-danger">Fest settings are not available. Cannot load events.</p>`;
        return;
    }

    // --- 1. Get Granular Settings and Data ---
    const studentCategory = getStudentCategory(student, fest.settings.categories);
    const registeredEventIds = existingReg?.events || [];
    const houseId = existingReg?.houseId || student.houseId || '';

    // Get detailed limits from fest settings, with sensible defaults
    const maxOnStageSolo = fest.settings.maxOnStageSoloEvents || 2;
    const maxOnStageGroup = fest.settings.maxOnStageGroupEvents || 2;
    const maxOffStageSolo = fest.settings.maxOffStageSoloEvents || 1;
    const maxOffStageGroup = fest.settings.maxOffStageGroupEvents || 1;

    // Separate events into On-Stage and Off-Stage lists
    const allEligibleEvents = festEvents.filter(e => e.festId === festId && (e.category === 'General' || e.category === studentCategory));
    const onStageEvents = allEligibleEvents.filter(e => e.type !== 'offStage');
    const offStageEvents = allEligibleEvents.filter(e => e.type === 'offStage');

    // --- 2. Render the Advanced Modal HTML ---
    container.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <p class="mb-0"><strong>Category:</strong> <span class="badge bg-info">${studentCategory}</span></p>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="event-type-toggle">
                <label class="form-check-label" for="event-type-toggle" id="event-type-label">On-Stage Events</label>
            </div>
        </div>
        <p class="mb-2"><small class="text-muted">Limits: On-Stage (Solo: ${maxOnStageSolo}, Group: ${maxOnStageGroup}) | Off-Stage (Solo: ${maxOffStageSolo}, Group: ${maxOffStageGroup})</small></p>
        
        <div class="mb-2">
            <strong>Selected: </strong>
            <span id="selection-count-display" class="badge rounded-pill bg-dark" data-bs-toggle="tooltip" title="No events selected"></span>
        </div>
        <hr class="my-2">
        
        <div style="max-height: 350px; overflow-y: auto;">
            <div id="onstage-events-container" class="row g-3">
                ${onStageEvents.map(event => `
                    <div class="col-md-6"><div class="form-check">
                        <input class="form-check-input event-modal-checkbox" data-event-type="onStage" data-event-mode="${event.isGroupEvent ? 'group' : 'solo'}" type="checkbox" value="${event.id}" ${registeredEventIds.includes(event.id) ? 'checked' : ''}>
                        <label class="form-check-label">${event.name} (${event.isGroupEvent ? 'Group' : 'Solo'})</label>
                    </div></div>
                `).join('') || '<p class="text-muted p-3">No On-Stage events available for this category.</p>'}
            </div>
            <div id="offstage-events-container" class="row g-3" style="display: none;">
                ${offStageEvents.map(event => `
                    <div class="col-md-6"><div class="form-check">
                        <input class="form-check-input event-modal-checkbox" data-event-type="offStage" data-event-mode="${event.isGroupEvent ? 'group' : 'solo'}" type="checkbox" value="${event.id}" ${registeredEventIds.includes(event.id) ? 'checked' : ''}>
                        <label class="form-check-label">${event.name} (${event.isGroupEvent ? 'Group' : 'Solo'})</label>
                    </div></div>
                `).join('') || '<p class="text-muted p-3">No Off-Stage events available for this category.</p>'}
            </div>
        </div>
    `;

    // --- 3. Attach Listeners and Logic for the Modal ---
    const toggle = document.getElementById('event-type-toggle');
    const onStageContainer = document.getElementById('onstage-events-container');
    const offStageContainer = document.getElementById('offstage-events-container');

    toggle.addEventListener('change', () => {
        const isOffStage = toggle.checked;
        document.getElementById('event-type-label').textContent = isOffStage ? 'Off-Stage Events' : 'On-Stage Events';
        onStageContainer.style.display = isOffStage ? 'none' : 'flex';
        offStageContainer.style.display = isOffStage ? 'flex' : 'none';
    });

    const checkboxes = container.querySelectorAll('.event-modal-checkbox');
    const countDisplay = document.getElementById('selection-count-display');
    const countTooltip = new bootstrap.Tooltip(countDisplay);

    const updateSelectionCount = () => {
        const checkedBoxes = container.querySelectorAll('.event-modal-checkbox:checked');
        let onStageCount = 0, offStageCount = 0;
        const selectedEventNames = [];
        checkedBoxes.forEach(cb => {
            if (cb.dataset.eventType === 'onStage') onStageCount++;
            if (cb.dataset.eventType === 'offStage') offStageCount++;
            selectedEventNames.push(festEvents.find(e => e.id === cb.value)?.name || '');
        });
        countDisplay.textContent = `${onStageCount} On-Stage, ${offStageCount} Off-Stage`;
        const tooltipTitle = selectedEventNames.length > 0 ? selectedEventNames.join(', ') : 'No events selected';
        countDisplay.setAttribute('data-bs-original-title', tooltipTitle);
        countTooltip.setContent({ '.tooltip-inner': tooltipTitle });
    };

    const checkLimits = () => {
        const counts = { onStage: { solo: 0, group: 0 }, offStage: { solo: 0, group: 0 } };
        checkboxes.forEach(cb => {
            if (cb.checked) { counts[cb.dataset.eventType][cb.dataset.eventMode]++; }
        });
        const limits = { onStage: { solo: maxOnStageSolo, group: maxOnStageGroup }, offStage: { solo: maxOffStageSolo, group: maxOffStageGroup } };
        checkboxes.forEach(cb => {
            if (!cb.checked) {
                const type = cb.dataset.eventType;
                const mode = cb.dataset.eventMode;
                cb.disabled = counts[type][mode] >= limits[type][mode];
            }
        });
        updateSelectionCount();
    };

    checkboxes.forEach(cb => cb.addEventListener('change', checkLimits));
    checkLimits(); // Initial call to set disabled states correctly
}

/**
 * Determines a student's category based on the currently managed fest's settings.
 * This version correctly reads the 'criteria' property and is safer.
 * @param {object} student The student object to categorize.
 * @returns {string} The name of the category the student belongs to.
 */
function getStudentCategory(student) {
    // ADDED: A safer guard clause to prevent crashes.
    // It checks the entire path and also if the categories array is empty.
    if (!student || !state.managingFest?.settings?.categories || state.managingFest.settings.categories.length === 0) {
        return 'General';
    }

    const dob = new Date(student.dob);
    
    // Create a copy to sort without changing the original data.
    const sortedCategories = [...state.managingFest.settings.categories].sort((a, b) => {
        if (a.type === 'class' && b.type !== 'class') return -1;
        if (a.type !== 'class' && b.type === 'class') return 1;
        // CHANGED: Use the correct 'criteria' property for sorting.
        if (a.type === 'age' && b.type === 'age') return new Date(b.criteria) - new Date(a.criteria);
        return 0;
    });

    for (const category of sortedCategories) {
        // CHANGED: Check 'category.criteria' instead of 'category.classes'.
        if (category.type === 'class' && category.criteria.includes(student.classId)) {
            return category.name;
        }
        // CHANGED: Check 'category.criteria' instead of 'category.bornAfterDate'.
        if (category.type === 'age' && dob >= new Date(category.criteria)) {
            return category.name;
        }
    }
    
    // If no specific category matches, return 'General'.
    return 'General';
}

window.openEditRegistrationModal = (registrationId) => {
    const registration = festRegistrations.find(r => r.id === registrationId);
    if (!registration) return showAlert('Could not find registration to edit.', 'danger');
    const student = students.find(s => s.id === registration.studentId);
    if (!student) return showAlert('Could not find student for this registration.', 'danger');
    state.registrationToEdit = registration;
    const modalBody = document.getElementById('edit-modal-body');
    modalBody.innerHTML = `<p><strong>Editing for:</strong> ${student.name} (${student.admissionNumber})</p><div id="edit-form-content"></div>`;
    renderEventsInModal(registration.festId, student, registration);
    document.getElementById('edit-modal-save-btn').onclick = saveEditedRegistration;
    document.getElementById('edit-modal-delete-btn').onclick = deleteRegistration;
    const editModal = new bootstrap.Modal(document.getElementById('editRegistrationModal'));
    editModal.show();
}

/**
 * Saves the changes from the edit registration modal to Firestore.
 * Ensures the modal is hidden on both success and failure.
 */
/**
 * Saves the changes for a single registration from the edit modal.
 * âœ… REVISED: This function now reconstructs the entire registration object
 * to be consistent with the robust logic in saveAllRegistrations.
 */
async function saveEditedRegistration() {
    if (!state.registrationToEdit) return;

    const modalInstance = bootstrap.Modal.getInstance(document.getElementById('editRegistrationModal'));
    
    // --- 1. Get all necessary data ---
    
    // Get IDs from the state
    const regId = state.registrationToEdit.id;
    const festId = state.registrationToEdit.festId;
    const studentId = state.registrationToEdit.studentId;
    
    // Get the full student object to ensure the name is current
    const student = students.find(s => s.id === studentId);
    if (!student) {
        showAlert('Could not find the student associated with this registration.', 'danger');
        return;
    }

    // Get the updated values from the modal's UI
    const houseId = document.getElementById('reg-modal-house')?.value;
    const selectedEvents = Array.from(
        document.querySelectorAll('#edit-form-content .event-modal-checkbox:checked')
    ).map(cb => cb.value);

    // --- 2. Build the complete registration data object ---
    // This now mirrors the structure in saveAllRegistrations
    const registrationData = {
        id: regId,
        festId: festId,
        studentId: studentId,
        studentName: student.name,
        houseId: houseId,
        events: selectedEvents,
        chestNo: state.registrationToEdit.chestNo || null // Explicitly preserve the chest number
    };

    // --- 3. Save the document to Firestore ---
    try {
        await setDoc(getDocRef('festRegistrations', regId), registrationData);
        showAlert('Registration updated successfully!', 'success-toast');
    } catch (error) {
        console.error("Error updating registration:", error);
        showAlert('Failed to update registration.', 'danger');
    } finally {
        // This block ensures the modal always closes and the state is cleared
        if (modalInstance) modalInstance.hide();
        state.registrationToEdit = null;
    }
}


async function deleteRegistration() {
    if (!state.registrationToEdit) return;
    if (confirm('Are you sure you want to delete this entire registration? This cannot be undone.')) {
        try {
            await deleteDoc(getDocRef('festRegistrations', state.registrationToEdit.id));
            showAlert('Registration deleted successfully.', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editRegistrationModal')).hide();
            state.registrationToEdit = null;
        } catch (error) {
            console.error("Error deleting registration:", error);
            showAlert('Failed to delete registration.', 'danger');
        }
    }
}
function attachParticipantsTabListeners() {
    // Filters (The fest filter listener is removed)
    // document.getElementById('participant-class-filter')?.addEventListener('change', renderParticipantsTable);
    // document.getElementById('participant-search-input')?.addEventListener('input', renderParticipantsTable);

    // Student search in modal
    document.getElementById('reg-modal-student-search')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const admnNo = e.target.value.trim();
            const student = students.find(s => String(s.admissionNumber||"").toLowerCase() === admnNo.toLowerCase());
            const infoDiv = document.getElementById('reg-modal-student-info');
            const formBody = document.getElementById('reg-modal-form-body');
            const saveBtn = document.getElementById('reg-modal-save-btn');

            if (student && infoDiv && formBody && saveBtn) {
                // *** KEY CHANGE HERE ***
                // Get the festId from the global state, not from a dropdown.
                const festId = state.managingFest.id; 
                
                const existingReg = festRegistrations.find(r => r.festId === festId && r.studentId === student.id);
                if (existingReg) {
                    infoDiv.innerHTML = `<span class="text-danger"><strong>${student.name}</strong> is already registered for this fest. Please edit their registration from the main table.</span>`;
                    formBody.classList.add('d-none');
                    saveBtn.disabled = true;
                } else {
                    infoDiv.innerHTML = `<strong>${student.name}</strong> | Class: ${getStudentClassName(student.classId, student.division)} | DOB: ${student.dob}`;
                    renderEventsInModal(festId, student);
                    formBody.classList.remove('d-none');
                    saveBtn.disabled = false;
                }
                infoDiv.classList.remove('d-none');
            } else if (infoDiv && formBody && saveBtn) {
                infoDiv.innerHTML = `<span class="text-danger">No student found with Admn No: ${admnNo}</span>`;
                infoDiv.classList.remove('d-none');
                formBody.classList.add('d-none');
                saveBtn.disabled = true;
            }
        }
    });
    
    // Save new registration
    document.getElementById('reg-modal-save-btn')?.addEventListener('click', async () => {
        const admnNo = document.getElementById('reg-modal-student-search').value.trim();
        const student = students.find(s => String(s.admissionNumber||"").toLowerCase() === admnNo.toLowerCase());
        
        // *** KEY CHANGE HERE ***
        const festId = state.managingFest.id; 
        
        const houseId = document.getElementById('reg-modal-house')?.value;
        const selectedEvents = Array.from(document.querySelectorAll('#reg-modal-form-body .event-checkbox:checked')).map(cb => cb.value);

        if (!student || !houseId || !festId) {
            return showAlert('A valid student, fest, and house are required.', 'danger');
        }

        const regId = `${festId}_${student.id}`;
        const regData = {
            id: regId, festId, studentId: student.id,
            studentName: student.name, houseId, events: selectedEvents
        };

        try {
            await setDoc(getDocRef('festRegistrations', regId), regData);
            showAlert('Registration saved successfully!', 'success');
            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('registrationModal'));
            if (modalInstance) modalInstance.hide();
            // The Firestore listener will auto-update and re-render the table
        } catch (error) {
            console.error("Error saving registration:", error);
            showAlert('Failed to save registration.', 'danger');
        }
    });

    // Reset modal on close
    document.getElementById('registrationModal')?.addEventListener('hidden.bs.modal', () => {
        document.getElementById('reg-modal-student-search').value = '';
        document.getElementById('reg-modal-student-info').classList.add('d-none');
        document.getElementById('reg-modal-form-body').classList.add('d-none');
        document.getElementById('reg-modal-save-btn').disabled = true;
    });
}

/**
 * Renders the filterable table of registered participants for the active fest.
 */
function renderParticipantsTable() {
    const container = document.getElementById('participants-table-container');
    if (!container || !state.managingFest) {
        // If no fest is selected, show a clear message.
        container.innerHTML = `<p class="text-muted text-center p-5">Select a fest from the "Setup" tab to view participants.</p>`;
        return;
    }

    const classFilter = document.getElementById('participant-class-filter');
    const searchInput = document.getElementById('participant-search-input');
    if (!classFilter || !searchInput) return;

    const festId = state.managingFest.id;
    const classId = classFilter.value;
    const searchTerm = searchInput.value.toLowerCase();

    let registrations = festRegistrations.filter(r => r.festId === festId);

    if (classId) {
        const studentIdsInClass = students.filter(s => s.classId === classId).map(s => s.id);
        registrations = registrations.filter(r => studentIdsInClass.includes(r.studentId));
    }

    if (searchTerm) {
        registrations = registrations.filter(r => {
            const student = students.find(s => s.id === r.studentId);
            return student && (
                student.name.toLowerCase().includes(searchTerm) || 
                String(student.admissionNumber || "").toLowerCase().includes(searchTerm)
            );
        });
    }

    if (registrations.length === 0) {
        container.innerHTML = `<h5 class="section-header"><i class="fas fa-users me-2"></i>Registered Participants (0)</h5><p class="text-muted text-center p-5">No participants found for the selected filters.</p>`;
        return;
    }

    // --- COMPLETED TABLE RENDERING LOGIC ---
    const tableRows = registrations.map(reg => {
        const student = students.find(s => s.id === reg.studentId);
        const house = festHouses.find(h => h.id === reg.houseId);
        return `
            <tr>
                <td><strong>${reg.chestNo || 'N/A'}</strong></td>
                <td>
                    ${reg.studentName}
                    <br><small class="text-muted">${getStudentClassName(student?.classId, student?.division)}</small>
                </td>
                <td style="color:${house?.color};">â— ${house?.name || 'N/A'}</td>
                <td><span class="badge bg-secondary">${reg.events.length} Events</span></td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-primary" onclick="window.openEventSelectionModal('${reg.id}')">
                        <i class="fas fa-edit me-1"></i>Edit
                    </button>
                </td>
            </tr>`;
    }).join('');

    container.innerHTML = `
        <h5 class="section-header"><i class="fas fa-users me-2"></i>Registered Participants (${registrations.length})</h5>
        <div class="table-responsive">
            <table class="table table-sm table-striped table-hover">
                <thead>
                    <tr>
                        <th>Chest No.</th>
                        <th>Student Name</th>
                        <th>House</th>
                        <th>Events</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>${tableRows}</tbody>
            </table>
        </div>
    `;
}

/**
 * Renders the "House Allocation" sub-tab within the main Participants tab.
 * This is the function that creates the 'house-alloc-class-filter' element.
 */
function renderParticipantHouseSection() {
    const container = document.getElementById('pills-house');
    if (!container) return;

    const classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

    container.innerHTML = `
        <div class="ui-card mb-4">
            <h5 class="section-header"><i class="fas fa-filter me-2"></i>Filter Students</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Filter by Class</label>
                    <select id="house-alloc-class-filter" class="form-select">
                        <option value="">All Classes</option>
                        ${classOptions}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Filter by Division</label>
                    <select id="house-alloc-division-filter" class="form-select" disabled>
                        <option value="">All Divisions</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Search by Name / Admn No.</label>
                    <input type="text" id="house-alloc-search-input" class="form-control" placeholder="Start typing...">
                </div>
            </div>
        </div>
        <div id="house-allocation-table-container" class="ui-card">
            </div>
    `;

    // Now that the HTML exists, we can safely attach listeners and render the table.
    attachHouseAllocationListeners();
    renderHouseAllocationTable();
}

/**
 * Attaches event listeners for the House Allocation filters.
 * This is the function you provided, and it is correct.
 */
function attachHouseAllocationListeners() {
    const classFilter = document.getElementById('house-alloc-class-filter');
    const divisionFilter = document.getElementById('house-alloc-division-filter');
    const searchInput = document.getElementById('house-alloc-search-input');

    classFilter.addEventListener('change', () => {
        const classId = classFilter.value;
        divisionFilter.innerHTML = '<option value="">All Divisions</option>';
        if (classId) {
            const classData = classes.find(c => c.id === classId);
            if (classData && classData.divisions) {
                classData.divisions.forEach(d => divisionFilter.innerHTML += `<option value="${d}">${d}</option>`);
            }
            divisionFilter.disabled = false;
        } else {
            divisionFilter.disabled = true;
        }
        renderHouseAllocationTable();
    });

    divisionFilter.addEventListener('change', renderHouseAllocationTable);
    searchInput.addEventListener('input', renderHouseAllocationTable);
}


/**
 * Saves all pending house allocations from the table using a Firestore batch write.
 */
window.saveHouseAllocations = async function() {
    const rowsToUpdate = Array.from(document.querySelectorAll('#house-allocation-table .house-assign-select')).filter(select => select.value);
    if (rowsToUpdate.length === 0) {
        return showAlert('No new house assignments to save.', 'info');
    }
    if (!confirm(`Are you sure you want to save ${rowsToUpdate.length} house assignment(s)?`)) {
        return;
    }

    const batch = writeBatch(db);
    rowsToUpdate.forEach(select => {
        const studentId = select.closest('tr').dataset.studentId;
        const houseId = select.value;
        const studentRef = getDocRef('students', studentId);
        batch.update(studentRef, { houseId: houseId });
    });

    try {
        await batch.commit();
        showAlert('House assignments saved successfully!', 'success');
        // The Firestore listener will automatically update the local 'students' array.
        // We just need to re-render the table to clear the dropdowns and show the new "Current House".
        renderHouseAllocationTable();
    } catch (error) {
        console.error("Error saving house assignments: ", error);
        showAlert('Failed to save assignments. See console for details.', 'danger');
    }
}
/**
 * Renders the table of students for house allocation based on filters.
 */
/**
 * Renders the table of students for house allocation, now with a summary dashboard.
 */
function renderHouseAllocationTable() {
    const container = document.getElementById('house-allocation-table-container');
    if (!container) return;

    // --- 1. Calculate Overall House Counts & Category Breakdown ---
    const houseSummary = {};

    // Initialize the summary object for all known houses and an 'Unassigned' category
    festHouses.forEach(house => {
        houseSummary[house.id] = { total: 0, categories: {}, name: house.name, color: house.color };
    });
    houseSummary['UNASSIGNED'] = { total: 0, categories: {}, name: 'Unassigned', color: '#6c757d' };

    // A simple helper to categorize students based on their class name for the summary
    const getStudentSchoolCategory = (student) => {
        if (!student.classId) return 'Unknown';
        const className = classes.find(c => c.id === student.classId)?.name || '';
        if (className.includes('HS') || className.includes('11') || className.includes('12')) return 'High School';
        if (className.includes('UP') || className.includes('6') || className.includes('7') || className.includes('8')) return 'Middle School';
        return 'Primary';
    };

    // Populate the summary by iterating through ALL students
    students.forEach(s => {
        const houseId = s.houseId || 'UNASSIGNED';
        const category = getStudentSchoolCategory(s);
        
        if (houseSummary[houseId]) {
            houseSummary[houseId].total++;
            houseSummary[houseId].categories[category] = (houseSummary[houseId].categories[category] || 0) + 1;
        }
    });

    // --- 2. Generate HTML for the Summary Dashboard ---
    const summaryHtml = `
        <h5 class="section-header mb-3"><i class="fas fa-chart-pie me-2"></i>Overall House Distribution</h5>
        <div class="row g-3 mb-4">
            ${Object.values(houseSummary).map(summary => `
                <div class="col-md-6 col-lg-3">
                    <div class="ui-card-stat h-100">
                        <div class="stat-icon" style="background-color: ${summary.color};"><i class="fas fa-home"></i></div>
                        <div class="stat-info">
                            <div class="stat-number">${summary.total}</div>
                            <div class="stat-label">${summary.name}</div>
                            <div class="stat-breakdown">
                                ${Object.entries(summary.categories).map(([cat, count]) => `
                                    <span class="badge bg-light text-dark">${cat}: ${count}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
        <hr class="my-4">
    `;

    // --- 3. Filter Students for the Detailed Table (Your existing logic) ---
    const classId = document.getElementById('house-alloc-class-filter').value;
    const division = document.getElementById('house-alloc-division-filter').value;
    const searchTerm = document.getElementById('house-alloc-search-input').value.toLowerCase();

    let filteredStudents = students.filter(s => {
        const classMatch = !classId || s.classId === classId;
        const divisionMatch = !division || s.division === division;
        const searchMatch = !searchTerm || s.name.toLowerCase().includes(searchTerm) || String(s.admissionNumber||"").toLowerCase().includes(searchTerm);
        return classMatch && divisionMatch && searchMatch;
    });

    const houseOptions = festHouses.map(h => `<option value="${h.id}">${h.name}</option>`).join('');

    // --- 4. Render the Complete UI ---
    container.innerHTML = `
        ${summaryHtml}
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="section-header mb-0"><i class="fas fa-users me-2"></i>Filtered Students (${filteredStudents.length})</h5>
            <div>
                <button class="btn btn-sm btn-success me-2" onclick="window.downloadHouseAllocationCSV()"><i class="fas fa-file-csv me-1"></i>Export CSV</button>
                <button class="btn btn-sm btn-danger" onclick="window.downloadHouseAllocationPDF()"><i class="fas fa-file-pdf me-1"></i>Export PDF</button>
            </div>
        </div>
        <div class="table-responsive mt-3">
            <table class="table table-sm table-striped" id="house-allocation-table">
                <thead><tr><th>Student Name</th><th>Class</th><th>Current House</th><th>Assign New House</th></tr></thead>
                <tbody>
                    ${filteredStudents.map(s => `
                        <tr data-student-id="${s.id}">
                            <td>${s.name}<br><small class="text-muted">${s.admissionNumber}</small></td>
                            <td>${getStudentClassName(s.classId, s.division)}</td>
                            <td>${festHouses.find(h => h.id === s.houseId)?.name || '<span class="text-muted">Not Assigned</span>'}</td>
                            <td><select class="form-select form-select-sm house-assign-select"><option value="">-- Select --</option>${houseOptions}</select></td>
                        </tr>`).join('')}
                </tbody>
            </table>
        </div>
        <div class="text-end mt-3 border-top pt-3">
            <button class="btn btn-primary" onclick="window.saveHouseAllocations()">Save All Changes</button>
        </div>
    `;
}
/**
 * Downloads the currently filtered house allocation data as a CSV file.
 */
window.downloadHouseAllocationCSV = function() {
    // 1. Get the same filtered list of students as the table
    const classId = document.getElementById('house-alloc-class-filter').value;
    const division = document.getElementById('house-alloc-division-filter').value;
    const searchTerm = document.getElementById('house-alloc-search-input').value.toLowerCase();

    let filteredStudents = students.filter(s => {
        const classMatch = !classId || s.classId === classId;
        const divisionMatch = !division || s.division === division;
        const searchMatch = !searchTerm || s.name.toLowerCase().includes(searchTerm) || String(s.admissionNumber || "").toLowerCase().includes(searchTerm);
        return classMatch && divisionMatch && searchMatch;
    });

    if (filteredStudents.length === 0) {
        return showAlert('No data to export.', 'info');
    }

    // 2. Define CSV headers and create CSV rows
    const headers = ['Admission Number', 'Student Name', 'Class', 'Current House'];
    const csvRows = [headers.join(',')]; // Start with the header row

    filteredStudents.forEach(s => {
        const studentClass = getStudentClassName(s.classId, s.division);
        const houseName = festHouses.find(h => h.id === s.houseId)?.name || 'Not Assigned';
        
        // Escape commas in names by wrapping the value in double quotes
        const studentName = `"${s.name}"`; 

        const row = [s.admissionNumber, studentName, studentClass, houseName];
        csvRows.push(row.join(','));
    });

    // 3. Create a Blob and trigger the download
    const csvContent = csvRows.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        const today = new Date().toISOString().slice(0, 10);
        link.setAttribute('href', url);
        link.setAttribute('download', `house_allocation_${today}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

/**
 * Downloads the currently filtered house allocation data as a PDF file.
 * Requires the jsPDF and jsPDF-AutoTable libraries to be included in your HTML.
 */
window.downloadHouseAllocationPDF = function() {
    // 1. Check if the jsPDF library is available
    const { jsPDF } = window.jspdf;
    if (typeof jsPDF === 'undefined' || typeof jsPDF.API.autoTable === 'undefined') {
        console.error("jsPDF or jsPDF-AutoTable is not loaded. Please include the required scripts in your HTML.");
        return showAlert('Could not generate PDF. Library not found.', 'danger');
    }

    // 2. Get the same filtered list of students
    const classId = document.getElementById('house-alloc-class-filter').value;
    const division = document.getElementById('house-alloc-division-filter').value;
    const searchTerm = document.getElementById('house-alloc-search-input').value.toLowerCase();

    let filteredStudents = students.filter(s => {
        const classMatch = !classId || s.classId === classId;
        const divisionMatch = !division || s.division === division;
        const searchMatch = !searchTerm || s.name.toLowerCase().includes(searchTerm) || String(s.admissionNumber || "").toLowerCase().includes(searchTerm);
        return classMatch && divisionMatch && searchMatch;
    });

    if (filteredStudents.length === 0) {
        return showAlert('No data to export.', 'info');
    }

    // 3. Prepare data for the PDF table
    const head = [['Admission No.', 'Student Name', 'Class', 'House']];
    const body = filteredStudents.map(s => [
        s.admissionNumber,
        s.name,
        getStudentClassName(s.classId, s.division),
        festHouses.find(h => h.id === s.houseId)?.name || 'Not Assigned'
    ]);

    // 4. Create the PDF document
    //const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Add title
    doc.setFontSize(18);
    doc.text('Student House Allocation', 14, 22);
    
    // Add table using autoTable plugin
    doc.autoTable({
        head: head,
        body: body,
        startY: 30, // Start table below the title
        theme: 'grid', // 'striped', 'grid', or 'plain'
        styles: { fontSize: 9 },
        headStyles: { fillColor: [22, 160, 133] } // Dark cyan color for header
    });
    
    // 5. Save the PDF
    const today = new Date().toISOString().slice(0, 10);
    doc.save(`house_allocation_${today}.pdf`);
}
/**
 * Saves all pending house allocations from the table.
 */
window.saveHouseAllocations = async function() {
    const rowsToUpdate = Array.from(document.querySelectorAll('#house-allocation-table .house-assign-select')).filter(select => select.value);
    if (rowsToUpdate.length === 0) return showAlert('No new house assignments to save.', 'info');
    if (!confirm(`Are you sure you want to save ${rowsToUpdate.length} house assignment(s)?`)) return;

    const batch = writeBatch(db);
    rowsToUpdate.forEach(select => {
        const studentId = select.closest('tr').dataset.studentId;
        const houseId = select.value;
        const studentRef = getDocRef('students', studentId);
        batch.update(studentRef, { houseId: houseId });
    });

    await batch.commit();
    showAlert('House assignments saved successfully!', 'success');
}
// --- All sub-tab functions (`renderParticipantRegistrationSection`, `renderParticipantHouseSection`, etc.) go here as provided in the last response ---


// -------------------------------------------------------------------------
// --- 6. SCORING & RESULTS TAB ---
// -------------------------------------------------------------------------
// =========================================================================
// --- ðŸ† FEST MANAGEMENT: SCORING TAB (ENHANCED WITH FILTERS) ---
// =========================================================================

/**
 * Renders the Scoring tab with new filters for Category.
 */
function renderFestScoringTab() {
    const container = document.getElementById('fest-scoring');
    if (!container || !state.managingFest) return;
    
    // Get unique categories for the filter dropdown
    const categoriesForFest = ['General', ...(state.managingFest.settings?.categories?.map(c => c.name) || [])];
    const categoryOptions = categoriesForFest.map(c => `<option value="${c}">${c}</option>`).join('');

    container.innerHTML = `
        <div class="ui-card">
            <h5 class="section-header"><i class="fas fa-marker me-2"></i> Enter Scores for ${state.managingFest.name}</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label">1. Filter by Category</label>
                    <select id="scoring-category-filter" class="form-select">
                        <option value="all">All Categories</option>
                        ${categoryOptions}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">2. Select Event to Score</label>
                    <select id="scoring-event-select" class="form-select" disabled>
                        <option>-- Select Category --</option>
                    </select>
                </div>
            </div>
        </div>
        <div id="scoring-sheet-container" class="mt-4 ui-card">
             <p class="text-muted p-4 text-center">Please select an event to enter scores.</p>
        </div>
    `;
    attachScoringTabListeners();
}

/**
 * Attaches event listeners for the Scoring tab filters.
 */
function attachScoringTabListeners() {
    const categoryFilter = document.getElementById('scoring-category-filter');
    const eventSelect = document.getElementById('scoring-event-select');

    // When the category changes, update the list of available events
    categoryFilter.addEventListener('change', () => {
        const selectedCategory = categoryFilter.value;
        let eventsToDisplay = festEvents.filter(e => e.festId === state.managingFest.id);
        
        if (selectedCategory !== 'all') {
            eventsToDisplay = eventsToDisplay.filter(e => e.category === selectedCategory);
        }
        
        eventsToDisplay.sort((a, b) => a.name.localeCompare(b.name));

        if (eventsToDisplay.length > 0) {
            eventSelect.innerHTML = `<option value="">-- Select an event --</option>` + 
                eventsToDisplay.map(e => `<option value="${e.id}">${e.name} (${e.gender === 'Male' ? 'Boys' : 'Girls'})</option>`).join('');
            eventSelect.disabled = false;
        } else {
            eventSelect.innerHTML = '<option>-- No events in this category --</option>';
            eventSelect.disabled = true;
        }
        // Clear the scoring sheet when the filter changes
        document.getElementById('scoring-sheet-container').innerHTML = `<p class="text-muted p-4 text-center">Please select an event to enter scores.</p>`;
    });

    // When an event is selected, render the scoring sheet
    eventSelect.addEventListener('change', () => {
        const eventId = eventSelect.value;
        if (eventId) {
            renderScoringSheet(state.managingFest.id, eventId);
        }
    });

    // Initial population of event list
    categoryFilter.dispatchEvent(new Event('change'));
}

/**
 * Renders the score entry sheet, adapting for Solo or Group events.
 * @param {string} festId - The ID of the fest.
 * @param {string} eventId - The ID of the specific event.
 */
function renderScoringSheet(festId, eventId) {
    const container = document.getElementById('scoring-sheet-container');
    const event = festEvents.find(e => e.id === eventId);
    
    if (!container || !event) {
        container.innerHTML = `<p class="alert alert-danger">Error: Could not load event details.</p>`;
        return;
    }

    const existingResult = festResults.find(r => r.id === `${festId}_${eventId}`);
    let tableBodyHtml = '';
    let headerHtml = '';

    if (event.isGroupEvent) {
        headerHtml = `<th>Group / Captain</th><th>House</th><th>Points Awarded</th>`;
        const participatingGroups = festGroups.filter(group => 
            group.festId === festId &&
            group.members.some(member => 
                festRegistrations.some(reg => 
                    reg.studentId === member.studentId && reg.events.includes(eventId)
                )
            )
        );

        if (participatingGroups.length === 0) {
           container.innerHTML = `<p class="alert alert-warning">No groups are registered for this event.</p>`;
           return;
        }

        tableBodyHtml = participatingGroups.map(group => {
            const captain = group.members.find(m => m.role === 'Captain');
            const captainName = students.find(s => s.id === captain?.studentId)?.name || 'N/A';
            const captainRegistration = festRegistrations.find(r => r.studentId === captain?.studentId);
            const house = festHouses.find(h => h.id === captainRegistration?.houseId);
            const savedPoints = existingResult?.results.find(res => res.groupId === group.id)?.points || '';

            return `
                <tr data-groupid="${group.id}">
                    <td><strong>${group.name}</strong><br><small class="text-muted">Captain: ${captainName}</small></td>
                    <td><span class="color-dot-display me-2" style="background-color:${house?.color || '#ccc'};"></span>${house?.name || 'N/A'}</td>
                    <td><input type="number" class="form-control form-control-sm score-points-input" value="${savedPoints}" min="0" placeholder="0"></td>
                </tr>`;
        }).join('');

    } else { // Solo Event Logic
        headerHtml = `<th>Participant (Chest No.)</th><th>House</th><th>Points Awarded</th>`;
        const participants = festRegistrations.filter(r => r.festId === festId && r.events.includes(eventId));
        
        if (participants.length === 0) {
            container.innerHTML = `<p class="alert alert-warning">No participants are registered for this event.</p>`;
            return;
        }
        
        tableBodyHtml = participants.map(p => {
            const house = festHouses.find(h => h.id === p.houseId);
            const savedPoints = existingResult?.results.find(res => res.studentId === p.studentId)?.points || '';
            return `
                <tr data-studentid="${p.studentId}">
                    <td>${p.studentName} (${p.chestNo || 'N/A'})</td>
                    <td><span class="color-dot-display me-2" style="background-color:${house?.color || '#ccc'};"></span>${house?.name || 'N/A'}</td>
                    <td><input type="number" class="form-control form-control-sm score-points-input" value="${savedPoints}" min="0" placeholder="0"></td>
                </tr>`;
        }).join('');
    }

    container.innerHTML = `
        <h5 class="section-header"><i class="fas fa-clipboard-check me-2"></i> Score Entry: ${event.name} (${event.category} - ${event.gender === 'Male' ? 'Boys' : 'Girls'})</h5>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light"><tr>${headerHtml}</tr></thead>
                <tbody>${tableBodyHtml}</tbody>
            </table>
        </div>
        <div class="text-end mt-3 border-top pt-3">
            <button class="btn btn-success" onclick="window.saveEventScores('${festId}', '${eventId}', ${event.isGroupEvent})">
                <i class="fas fa-save me-2"></i>Save Scores
            </button>
        </div>
    `;
}

window.saveEventScores = async (festId, eventId, isGroupEvent) => {
    const resultsWithPoints = [];
    const selector = isGroupEvent ? '#scoring-sheet-container tr[data-groupid]' : '#scoring-sheet-container tr[data-studentid]';

    document.querySelectorAll(selector).forEach(row => {
        const id = isGroupEvent ? row.dataset.groupid : row.dataset.studentid;
        const pointsInput = row.querySelector('.score-points-input');
        const points = parseInt(pointsInput.value, 10) || 0;

        if (points > 0) {
            const entry = isGroupEvent ? { groupId: id, points } : { studentId: id, points };
            resultsWithPoints.push(entry);
        }
    });

    resultsWithPoints.sort((a, b) => b.points - a.points);

    const finalResults = resultsWithPoints.map((result, index, arr) => {
        const position = (index > 0 && result.points === arr[index - 1].points)
            ? finalResults[index - 1].position
            : index + 1;
        return { ...result, position };
    });

    const resultId = `${festId}_${eventId}`;
    const resultData = { id: resultId, festId, eventId, results: finalResults };

    try {
        await setDoc(getDocRef('festResults', resultId), resultData);
        showAlert('Scores saved successfully!', 'success');
        if(document.getElementById('fest-dashboard')) {
            renderFestDashboardTab();
        }
    } catch (error) {
        console.error("Error saving scores:", error);
        showAlert('Failed to save scores. See console for details.', 'danger');
    }
};




// -------------------------------------------------------------------------
// --- 7. REPORTS TAB ---
// -------------------------------------------------------------------------
/**
 * Renders a clean, card-based interface for generating all fest-related reports.
 */
/**
 * Renders a clean, card-based interface for generating all fest-related reports.
 * This version has an improved UI layout for better clarity and usability.
 */
function renderFestReportsTab() {
    const container = document.getElementById('fest-reports');
    if (!container) return;

    // Show a message if no fest is being managed
    if (!state.managingFest) {
        container.innerHTML = `
            <div class="text-center p-5">
                <i class="fas fa-arrow-left fa-3x text-primary mb-3"></i>
                <h5>No Fest Selected</h5>
                <p class="text-muted">Please select a fest from the "Setup" tab to generate reports.</p>
            </div>`;
        return;
    }

    // Prepare options for the dropdowns
    const categoryOptions = state.managingFest.settings?.categories?.map(c => `<option value="${c.name}">${c.name}</option>`).join('') || '';
    const houseOptions = festHouses.map(h => `<option value="${h.id}">${h.name}</option>`).join('');
    const eventOptions = festEvents.filter(e => e.festId === state.managingFest.id)
        .sort((a, b) => a.name.localeCompare(b.name))
        .map(e => `<option value="${e.id}">${e.name} (${e.category})</option>`).join('');

    container.innerHTML = `
        <h5 class="section-header"><i class="fas fa-print me-2"></i>Generate Reports for ${state.managingFest.name}</h5>
        <p class="text-muted">Generate and print various reports for the currently selected fest.</p>
        
        <div class="row g-4 mt-2">

            <!-- Card 1: Participant Entry Sheet -->
            <div class="col-12">
                <div class="ui-card">
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                            <i class="fas fa-clipboard-list fa-lg"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">Participant Entry Sheet</h6>
                            <p class="small text-muted mb-0">A master sheet for officials. Filter by category, house, and event type for roll calls.</p>
                        </div>
                    </div>
                    <hr>
                    <div class="row g-2 align-items-end">
                        <div class="col-lg-3 col-md-6">
                            <label for="report-category-select" class="form-label-sm">Category</label>
                            <select class="form-select form-select-sm" id="report-category-select">
                                <option value="ALL">All Categories</option>
                                <option value="General">General</option>
                                ${categoryOptions}
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="report-house-select" class="form-label-sm">House</label>
                            <select class="form-select form-select-sm" id="report-house-select">
                                <option value="ALL">All Houses</option>
                                ${houseOptions}
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <label for="report-event-type-select" class="form-label-sm">Event Type</label>
                            <select class="form-select form-select-sm" id="report-event-type-select">
                                <option value="ALL">All Events</option>
                                <option value="onStage">On-Stage</option>
                                <option value="offStage">Off-Stage</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6 d-grid">
                            <button class="btn btn-sm btn-primary" onclick="window.printCategoryEntrySheet()">Generate Sheet</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 2: Event Result Sheet -->
            <div class="col-12">
                <div class="ui-card">
                    <h6 class="mb-0">Event Result Sheet</h6>
                    <p class="small text-muted mb-2">A blank scoresheet for judges. Select multiple events to generate a combined report.</p>
                    <hr>
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3"><label class="form-label-sm">Category</label><select class="form-select form-select-sm" id="result-sheet-category-filter"><option value="all">All Categories</option><option value="General">General</option>${categoryOptions}</select></div>
                        <div class="col-md-3"><label class="form-label-sm">Type</label><select class="form-select form-select-sm" id="result-sheet-type-filter"><option value="all">All Types</option><option value="onStage">On-Stage</option><option value="offStage">Off-Stage</option></select></div>
                        <div class="col-md-4">
                            <label class="form-label-sm">Select Events</label>
                            <select class="form-select form-select-sm" id="report-event-multiselect" multiple size="4"></select>
                        </div>
                        <div class="col-md-2 d-grid gap-2">
                             <button class="btn btn-sm btn-outline-secondary" id="select-all-events-btn">Select All</button>
                             <button class="btn btn-sm btn-primary" onclick="window.printEventResultSheet()">Generate</button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Card 3: Blank Registration Sheet -->
            <div class="col-md-6">
                <div class="ui-card h-100 d-flex flex-column">
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                           <i class="fas fa-edit fa-lg"></i>
                        </div>
                        <div>
                             <h6 class="mb-0">Blank Registration Sheet</h6>
                             <p class="small text-muted mb-0">A blank form with empty rows for on-site manual registrations.</p>
                        </div>
                    </div>
                    <hr>
                    <div class="mt-auto">
                        <div class="mb-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="reg-sheet-type" id="reg-sheet-onstage" value="onStage" checked>
                                <label class="form-check-label" for="reg-sheet-onstage">On-Stage</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="reg-sheet-type" id="reg-sheet-offstage" value="offStage">
                                <label class="form-check-label" for="reg-sheet-offstage">Off-Stage</label>
                            </div>
                        </div>
                        <div class="input-group">
                            <select class="form-select" id="report-category-select-blank">
                               <option value="">-- Select a Category --</option>
                               <option value="General">General</option>
                               ${categoryOptions}
                            </select>
                            <button class="btn btn-outline-primary" onclick="window.printCategoryRegistrationSheet()">Generate</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Card 4 & 5: Simple Reports -->
            <div class="col-md-6">
                <div class="ui-card h-100 d-flex flex-column">
                     <div class="d-flex align-items-center mb-2">
                        <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                           <i class="fas fa-id-badge fa-lg"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">Participant Chest Cards</h6>
                            <p class="small text-muted mb-0">Printable layout of chest cards (10 per A4 page) for all participants.</p>
                        </div>
                    </div>
                    <div class="mt-auto text-end">
                        <button class="btn btn-primary" onclick="window.printChestNumbers()">
                            <i class="fas fa-file-pdf me-2"></i>Generate PDF
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="ui-card h-100 d-flex flex-column">
                    <div class="d-flex align-items-center mb-2">
                        <div class="bg-warning text-dark rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                           <i class="fas fa-trophy fa-lg"></i>
                        </div>
                        <div>
                            <h6 class="mb-0">Final House Rankings</h6>
                            <p class="small text-muted mb-0">A summary report of the final house standings with total points.</p>
                        </div>
                    </div>
                    <div class="mt-auto text-end">
                         <button class="btn btn-primary" onclick="window.printHouseRankings()">
                            <i class="fas fa-print me-2"></i>Print Rankings
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="ui-card h-100 d-flex flex-column">
                    <h6><i class="fas fa-user-graduate me-2 text-primary"></i>Individual Championships</h6>
                    <p class="small text-muted">A report showcasing the "Kalathilakam" (Top Girl) and "Kalaprathibha" (Top Boy) based on solo event points.</p>
                    <div class="mt-auto text-end">
                         <button class="btn btn-primary" onclick="window.printIndividualChampionships()">
                            <i class="fas fa-print me-2"></i>Generate Report
                        </button>
                    </div>
                </div>
            </div>

        </div>
    `;

    // --- Attach Listeners for the new Result Sheet filters ---
    const categoryFilter = document.getElementById('result-sheet-category-filter');
    const typeFilter = document.getElementById('result-sheet-type-filter');
    const eventMultiSelect = document.getElementById('report-event-multiselect');
    const selectAllBtn = document.getElementById('select-all-events-btn');

    const updateEventMultiSelect = () => {
        const selectedCategory = categoryFilter.value;
        const selectedType = typeFilter.value;
        
        let filteredEvents = festEvents.filter(e => e.festId === state.managingFest.id);
        if (selectedCategory !== 'all') filteredEvents = filteredEvents.filter(e => e.category === selectedCategory);
        if (selectedType !== 'all') filteredEvents = filteredEvents.filter(e => (e.type || 'onStage') === selectedType);
        
        eventMultiSelect.innerHTML = filteredEvents.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
    };

    categoryFilter.addEventListener('change', updateEventMultiSelect);
    typeFilter.addEventListener('change', updateEventMultiSelect);
    selectAllBtn.addEventListener('click', () => {
        Array.from(eventMultiSelect.options).forEach(opt => opt.selected = true);
    });

    // Initial population
    updateEventMultiSelect();

}


/**
 * Generates and prints the chest cards layout.
 */
window.printChestNumbers = function() {
    if (!state.managingFest) return showAlert('No fest selected.', 'warning');
    const festId = state.managingFest.id;

    const participants = festRegistrations.filter(r => r.festId === festId && r.chestNo).sort((a,b) => a.chestNo - b.chestNo);
    if (participants.length === 0) return showAlert('No participants with chest numbers found for this fest.', 'info');

    let contentHtml = participants.map(reg => {
        const student = students.find(s => s.id === reg.studentId);
        if (!student) return '';
        
        const eventNames = reg.events.map(eid => festEvents.find(e => e.id === eid)?.name).filter(Boolean).join(', ');
        
        return `
            <div class="chest-no-slip">
                <div class="chest-header">${schoolDetails.name || 'School Name'}</div>
                <div class="fest-name">${state.managingFest.name}</div>
                <div class="chest-number">${reg.chestNo}</div>
                <div class="chest-student-name">${student.name}</div>
                <small class="text-muted">${getStudentClassName(student.classId, student.division)}</small>
                <div class="chest-events">${eventNames}</div>
            </div>`;
    }).join('');

    const extraCss = `
        .chest-no-slip { 
            width: 85mm; height: 55mm; float: left; margin: 5mm; 
            padding: 5mm; border: 1px solid #ccc; box-sizing: border-box; 
            text-align: center; page-break-inside: avoid; overflow: hidden;
            display: flex; flex-direction: column; justify-content: center;
        }
        .chest-header { font-size: 0.9em; font-weight: bold; }
        .fest-name { font-size: 0.7em; color: #555; }
        .chest-number { font-size: 3.5em; font-weight: bold; margin: 5px 0; line-height: 1; }
        .chest-student-name { font-size: 1.1em; font-weight: 500;}
        .chest-events { font-size: 0.6em; color: #555; margin-top: 5px; line-height: 1.2; }
    `;
    printReport({ contentHtml, title: `Chest_Numbers_${festId}`, extraCss });
}

/**
 * Generates and prints the final house rankings.
 */
/**
 * Generates and prints the final house rankings report.
 */
window.printHouseRankings = function() {
    if (!state.managingFest) {
        return showAlert('No fest selected.', 'warning');
    }
    showAlert('Generating final report...', 'info');

    // 1. Calculate all the data
    const reportData = generateHouseRankingReportData(state.managingFest.id);
    if (!reportData) {
        return showAlert('Could not generate data for the report.', 'danger');
    }

    // 2. Build the HTML from the data
    const contentHtml = generateHouseRankingReportHTML(reportData);
    
    // 3. Prepare a professional header for the printout
    const customHeaderHtml = `
        <div style="text-align: center; margin-bottom: 20px;">
            ${schoolDetails.logoUrl ? `<img src="${schoolDetails.logoUrl}" alt="School Logo" style="max-height: 80px;">` : ''}
            <h3>${schoolDetails.name || 'School Name'}</h3>
            <h4 class="text-muted">Final Fest Rankings</h4>
            <h5>${reportData.festName}</h5>
        </div>
    `;

    // 4. Define specific CSS for this report
    const extraCss = `
        .printable-report { font-size: 10pt; }
        .section-header { 
            padding-bottom: 5px; 
            margin-bottom: 10px; 
            border-bottom: 1px solid #eee; 
            color: #0d6efd;
        }
        .ui-card {
            border: 1px solid #e9ecef;
            border-radius: .25rem;
            padding: 1rem;
            page-break-inside: avoid;
        }
    `;

    // 5. Call the print utility
    printReport({
        contentHtml: contentHtml,
        title: `House_Rankings_${reportData.festName}`,
        customHeaderHtml: customHeaderHtml,
        extraCss: extraCss,
        pageSize: 'A4 portrait'
    });
}
/**
 * Generates the complete HTML string for the printable house rankings report.
 * @param {object} reportData The data generated by generateHouseRankingReportData.
 * @returns {string} The full HTML content for the report.
 */
function generateHouseRankingReportHTML(reportData) {
    if (!reportData) return '<p>Could not generate report data.</p>';

    // --- Section 1: Final Standings Table ---
    const finalStandingsTable = `
        <h5 class="section-header">Final Standings</h5>
        <table class="table table-sm table-bordered">
            <thead class="table-light"><tr><th>Rank</th><th>House</th><th>Total Points</th></tr></thead>
            <tbody>
                ${reportData.houses.map(h => `
                    <tr>
                        <td class="text-center fw-bold">${h.finalRank}</td>
                        <td><span class="color-dot-display" style="background-color:${h.houseColor};"></span>${h.houseName}</td>
                        <td class="text-center fw-bold">${h.totalPoints}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>`;

    // --- Section 2: Category-wise Score Breakdown ---
    const categoryBreakdownTable = `
        <h5 class="section-header mt-4">Category-wise Score Breakdown</h5>
        <table class="table table-sm table-bordered text-center">
            <thead class="table-light">
                <tr><th>House</th>${reportData.categories.map(cat => `<th>${cat}</th>`).join('')}<th>Grand Total</th></tr>
            </thead>
            <tbody>
                ${reportData.houses.map(h => `
                    <tr>
                        <td class="text-start">${h.houseName}</td>
                        ${reportData.categories.map(cat => `<td>${h.categoryPoints[cat] || 0}</td>`).join('')}
                        <td class="fw-bold">${h.totalPoints}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>`;
        
    // --- Section 3: House-wise Toppers ---
    const houseToppersSection = `
        <h5 class="section-header mt-4">House-wise Top Performers</h5>
        <div class="row g-3">
            ${reportData.houses.map(h => `
                <div class="col-md-6">
                    <div class="ui-card h-100">
                        <h6 style="color: ${h.houseColor};">${h.houseName}</h6>
                        <ul class="list-group list-group-flush">
                            ${h.toppers.length > 0 ? h.toppers.map((topper, i) => `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>${i + 1}. ${topper.studentName}</span>
                                    <span class="badge bg-primary rounded-pill">${topper.points} pts</span>
                                </li>
                            `).join('') : '<li class="list-group-item text-muted">No points scored.</li>'}
                        </ul>
                    </div>
                </div>
            `).join('')}
        </div>`;

    return `
        <div class="printable-report">
            ${finalStandingsTable}
            ${categoryBreakdownTable}
            ${houseToppersSection}
        </div>
    `;
}
/**
 * Calculates and aggregates all data needed for the final house ranking report.
 * @param {string} festId The ID of the fest to analyze.
 * @returns {object} A structured object containing all report data.
 */
function generateHouseRankingReportData(festId) {
    const fest = fests.find(f => f.id === festId);
    if (!fest) return null;

    // --- Step 1: Initialize data structures ---
    const houseData = {};
    festHouses.forEach(h => {
        houseData[h.id] = {
            houseId: h.id,
            houseName: h.name,
            houseColor: h.color,
            totalPoints: 0,
            categoryPoints: {},
            studentPoints: {} // { studentId: points }
        };
    });

    const relevantResults = festResults.filter(r => r.festId === festId);

    // --- Step 2: Aggregate points from all event results ---
    relevantResults.forEach(result => {
        const event = festEvents.find(e => e.id === result.eventId);
        if (!event) return;

        result.results.forEach(standing => {
            let participants = [];
            if (standing.studentId) {
                // It's a solo event result
                participants.push(festRegistrations.find(r => r.studentId === standing.studentId && r.festId === festId));
            } else if (standing.groupId) {
                // It's a group event result
                const group = festGroups.find(g => g.id === standing.groupId);
                group?.members.forEach(member => {
                    participants.push(festRegistrations.find(r => r.studentId === member.studentId && r.festId === festId));
                });
            }
            
            participants.filter(Boolean).forEach(reg => {
                if (reg && reg.houseId && houseData[reg.houseId]) {
                    const points = standing.points || 0;
                    const category = event.category || 'General';

                    // Add to house total
                    houseData[reg.houseId].totalPoints += points;
                    // Add to category-specific total for the house
                    houseData[reg.houseId].categoryPoints[category] = (houseData[reg.houseId].categoryPoints[category] || 0) + points;
                    // Add to individual student's total for that house
                    houseData[reg.houseId].studentPoints[reg.studentId] = (houseData[reg.houseId].studentPoints[reg.studentId] || 0) + points;
                }
            });
        });
    });

    // --- Step 3: Finalize data and calculate ranks ---
    let finalHouseArray = Object.values(houseData);
    
    // Find top 3 students for each house
    finalHouseArray.forEach(house => {
        house.toppers = Object.entries(house.studentPoints)
            .sort(([, pointsA], [, pointsB]) => pointsB - pointsA)
            .slice(0, 3) // Get top 3
            .map(([studentId, points]) => ({
                studentId,
                studentName: students.find(s => s.id === studentId)?.name || 'Unknown',
                points
            }));
    });

    // Sort houses by total points to determine final rank
    finalHouseArray.sort((a, b) => b.totalPoints - a.totalPoints);
    finalHouseArray.forEach((house, index) => {
        house.finalRank = index + 1;
    });

    return {
        festName: fest.name,
        categories: [...new Set(festEvents.filter(e => e.festId === festId).map(e => e.category))].sort(),
        houses: finalHouseArray
    };
}
/**
 * 1. Main function to orchestrate the generation and printing of the championships report.
 */
window.printIndividualChampionships = function() {
    if (!state.managingFest) {
        return showAlert('No fest selected.', 'warning');
    }
    showAlert('Generating Individual Championships report...', 'info');

    // Calculate all the data first
    const reportData = calculateIndividualChampionships(state.managingFest.id);
    if (!reportData) {
        return showAlert('Could not generate data for the report.', 'danger');
    }

    // Build the HTML from the data
    const contentHtml = generateIndividualChampionshipsHTML(reportData);
    
    // Prepare a professional header for the printout
    const customHeaderHtml = `
        <div style="text-align: center; margin-bottom: 20px;">
            ${schoolDetails.logoUrl ? `<img src="${schoolDetails.logoUrl}" alt="School Logo" style="max-height: 80px;">` : ''}
            <h3>${schoolDetails.name || 'School Name'}</h3>
            <h4 class="text-muted">Individual Championships</h4>
            <h5>${reportData.festName}</h5>
        </div>
    `;

    // Define specific CSS for this report
    const extraCss = `
        .winner-card { border: 2px solid #0d6efd; page-break-inside: avoid; }
        .winner-photo { width: 120px; height: 120px; object-fit: cover; border: 3px solid #fff; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        .section-header { padding-bottom: 5px; margin-bottom: 10px; border-bottom: 1px solid #eee; }
    `;

    // Call the print utility
    printReport({
        contentHtml: contentHtml,
        title: `Individual_Championships_${reportData.festName}`,
        customHeaderHtml: customHeaderHtml,
        extraCss: extraCss,
        pageSize: 'A4 portrait'
    });
}

/**
 * 2. Calculates the top male and female performers based on solo event points.
 * @param {string} festId The ID of the fest to analyze.
 * @returns {object|null} A structured object with all report data, or null if it fails.
 */
function calculateIndividualChampionships(festId) {
    const fest = fests.find(f => f.id === festId);
    if (!fest) return null;

    const studentPoints = {}; // { studentId: { points: number, gender: 'M'/'F' } }

    const relevantResults = festResults.filter(r => r.festId === festId);

    relevantResults.forEach(result => {
        const event = festEvents.find(e => e.id === result.eventId);
        // CRITICAL: Skip group events
        if (!event || event.isGroupEvent) {
            return;
        }

        result.results.forEach(standing => {
            // Only process results for individual students
            if (standing.studentId && standing.points > 0) {
                const student = students.find(s => s.id === standing.studentId);
                if (student) {
                    if (!studentPoints[student.id]) {
                        studentPoints[student.id] = { points: 0, gender: student.gender };
                    }
                    studentPoints[student.id].points += standing.points;
                }
            }
        });
    });

    const allPerformers = Object.entries(studentPoints).map(([studentId, data]) => ({
        studentId,
        points: data.points,
        gender: data.gender
    }));

    // Separate and sort male and female performers
    const topFemale = allPerformers.filter(p => p.gender === 'F').sort((a, b) => b.points - a.points);
    const topMale = allPerformers.filter(p => p.gender === 'M').sort((a, b) => b.points - a.points);

    // Function to enrich student data for the report
    const enrichStudentData = (performer) => {
        const student = students.find(s => s.id === performer.studentId);
        const registration = festRegistrations.find(r => r.studentId === performer.studentId && r.festId === festId);
        const house = festHouses.find(h => h.id === registration?.houseId);
        return {
            ...performer,
            studentName: student?.name || 'Unknown',
            className: getStudentClassName(student?.classId, student?.division),
            houseName: house?.name || 'N/A',
            photoDriveId: student?.photoDriveId || null
        };
    };

    return {
        festName: fest.name,
        kalathilakam: topFemale.length > 0 ? enrichStudentData(topFemale[0]) : null,
        kalaprathibha: topMale.length > 0 ? enrichStudentData(topMale[0]) : null,
        topFemalePerformers: topFemale.slice(0, 5).map(enrichStudentData),
        topMalePerformers: topMale.slice(0, 5).map(enrichStudentData)
    };
}

/**
 * 3. Generates the final HTML for the championship report.
 * @param {object} reportData The data from calculateIndividualChampionships.
 * @returns {string} The complete HTML string for the report.
 */
function generateIndividualChampionshipsHTML(reportData) {
    const fest = state.managingFest;
    
    // --- DYNAMIC TITLES ---
    const femaleChampionTitle = fest.eventType === 'Sports' ? 'Individual Champion (Girl)' : 'Kalathilakam';
    const maleChampionTitle = fest.eventType === 'Sports' ? 'Individual Champion (Boy)' : 'Kalaprathibha';


    const renderWinnerCard = (title, winner) => {
        if (!winner) {
            return `<div class="ui-card text-center p-5"><h5 class="section-header">${title}</h5><p class="text-muted">No winner found.</p></div>`;
        }
        const photoUrl = winner.photoDriveId ? `https://drive.google.com/thumbnail?id=${winner.photoDriveId}&sz=200` : 'https://placehold.co/120x120?text=Photo';
        return `
            <div class="card winner-card text-center p-3 mb-4">
                <h4 class="section-header text-danger">${title}</h4>
                <img src="${photoUrl}" class="rounded-circle mx-auto winner-photo">
                <h5 class="mt-3 mb-0">${winner.studentName}</h5>
                <p class="text-muted mb-1">${winner.className} | ${winner.houseName}</p>
                <p class="fs-4 fw-bold text-primary">${winner.points} Points</p>
            </div>`;
    };

    const renderToppersList = (title, toppers) => {
        if (toppers.length === 0) return '';
        return `
            <h6 class="mt-4">${title}</h6>
            <table class="table table-sm table-striped">
                <thead><tr><th>Rank</th><th>Name</th><th>Points</th></tr></thead>
                <tbody>
                    ${toppers.map((p, i) => `<tr><td>${i + 1}</td><td>${p.studentName}</td><td>${p.points}</td></tr>`).join('')}
                </tbody>
            </table>`;
    };

    return `
        <div class="row">
            <div class="col-md-6">
                ${renderWinnerCard(femaleChampionTitle, reportData.kalathilakam)}
                ${renderToppersList('Top 5 Female Performers', reportData.topFemalePerformers)}
            </div>
            <div class="col-md-6">
                ${renderWinnerCard(maleChampionTitle, reportData.kalaprathibha)}
                ${renderToppersList('Top 5 Male Performers', reportData.topMalePerformers)}
            </div>
        </div>
    `;
}

/**
 * Reads filter values and triggers the printing of the category entry sheet.
 */
/**
 * Reads filter values and triggers the printing of the category entry sheet.
 */
window.printCategoryEntrySheet = function() {
    if (!state.managingFest) return showAlert('Please select a fest.', 'warning');
    
    // 1. Get filter values from all three dropdowns
    const categoryValue = document.getElementById('report-category-select').value;
    const houseValue = document.getElementById('report-house-select').value;
    const eventTypeValue = document.getElementById('report-event-type-select').value;
    
    // 2. Generate the report HTML using all three filters
    const { contentHtml, reportTitle } = generateCategoryEntrySheetHTML(state.managingFest.id, categoryValue, houseValue, eventTypeValue);
    
    // If the generator function returns null (e.g., no data), stop here.
    if (!contentHtml) return;

    // 3. Define the CSS for the report
    const extraCss = `
        .entry-sheet-table { font-size: 9pt; border-collapse: collapse; width: 100%; }
        .entry-sheet-table th, .entry-sheet-table td { border: 1px solid #dee2e6; padding: 4px 6px; }
        
        /* --- MODIFIED CSS FOR CENTER ALIGNMENT --- */
        .vertical-header { 
            height: 180px; 
            white-space: nowrap; 
            text-align: center;      /* Center horizontally */
            vertical-align: middle;  /* Center vertically */
            position: relative; 
        }
        .vertical-header div { 
            transform-origin: center; /* Rotate around the center */
            transform: translate(-50%, -50%) rotate(-90deg); /* Center, then rotate */
            position: absolute; 
            top: 50%; 
            left: 50%;
            width: 170px; /* Width must be less than the header height */
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        /* --- END OF MODIFIED CSS --- */

        .tick-box { width: 35px; text-align: center; }
        .not-participating { background-color: #f0f0f0; }
        .house-header-row td { background-color: #e9ecef; font-weight: bold; text-align: center; }
        .report-footer { margin-top: 40px; text-align: right; font-size: 10pt; }
    `;

    // 4. Call the generic print utility
    printReport({ 
        contentHtml, 
        title: `Entry_Sheet_${state.managingFest.name}_${reportTitle}`, 
        extraCss, 
        pageSize: 'A4 landscape'
    });
}

/**
 * Generates the HTML for the entry sheet based on category, house, and event type filters.
 * @param {string} festId - The ID of the current fest.
 * @param {string} selectedCategory - The category name, or "ALL".
 * @param {string} selectedHouseId - The house ID, or "ALL".
 * @param {string} selectedEventType - The event type (onStage, offStage), or "ALL".
 * @returns {object} An object with the HTML content and a title for the report.
 */
function generateCategoryEntrySheetHTML(festId, selectedCategory, selectedHouseId, selectedEventType) {
    const fest = fests.find(f => f.id === festId);

    // --- Step 1: Filter Events (NOW INCLUDES EVENT TYPE) ---
    let eventsToDisplay = festEvents.filter(e => e.festId === festId);

    if (selectedCategory !== 'ALL') {
        eventsToDisplay = eventsToDisplay.filter(e => e.category === selectedCategory);
    }
    
    // *** THIS IS THE NEW, CORRECTED LOGIC ***
    if (selectedEventType !== 'ALL') {
        // This handles both 'onStage' and 'offStage' selections.
        // It also correctly treats events with a missing 'type' property as 'onStage' by default.
        eventsToDisplay = eventsToDisplay.filter(e => {
            const eventType = e.type || 'onStage'; // Default to 'onStage' if type is not defined
            return eventType === selectedEventType;
        });
    }
    eventsToDisplay.sort((a, b) => a.name.localeCompare(b.name));

    // --- Step 2: Filter Participants (No change needed here) ---
    let filteredParticipants = festRegistrations.filter(r => r.festId === festId);

    if (selectedHouseId !== 'ALL') {
        filteredParticipants = filteredParticipants.filter(r => r.houseId === selectedHouseId);
    }
    
    const eventIdsToDisplay = eventsToDisplay.map(e => e.id);
    // Only keep participants who are in at least one of the events we are displaying.
    filteredParticipants = filteredParticipants.filter(r => r.events.some(eventId => eventIdsToDisplay.includes(eventId)));

    if (filteredParticipants.length === 0) {
        showAlert('No participants found for the selected filters.', 'info');
        return { contentHtml: null, reportTitle: '' };
    }
    
    // --- Step 3: Group Participants by House (No change needed here) ---
    const participantsByHouse = filteredParticipants.reduce((acc, reg) => {
        const houseId = reg.houseId || 'UNASSIGNED';
        if (!acc[houseId]) acc[houseId] = [];
        acc[houseId].push(reg);
        return acc;
    }, {});
    
    const sortedHouseIds = Object.keys(participantsByHouse).sort((a, b) => {
        if (a === 'UNASSIGNED') return 1;
        if (b === 'UNASSIGNED') return -1;
        const houseA = festHouses.find(h => h.id === a)?.name || '';
        const houseB = festHouses.find(h => h.id === b)?.name || '';
        return houseA.localeCompare(houseB);
    });
    
    // --- Step 4: Build the HTML Table Body (No change needed here) ---
    let tableBodyHtml = '';
    let serialNumber = 1;

    sortedHouseIds.forEach(houseId => {
        const house = festHouses.find(h => h.id === houseId);
        const houseName = house ? house.name : 'Unassigned';
        tableBodyHtml += `<tr class="house-header-row"><td colspan="${4 + eventsToDisplay.length}">${houseName.toUpperCase()}</td></tr>`;
        
        const participantsInHouse = participantsByHouse[houseId].sort((a, b) => 
            (a.chestNo || a.studentName).toString().localeCompare((b.chestNo || b.studentName).toString(), undefined, { numeric: true })
        );
        
        participantsInHouse.forEach(reg => {
            const student = students.find(s => s.id === reg.studentId);
            tableBodyHtml += `<tr>
                <td>${serialNumber++}</td>
                <td>${reg.chestNo || 'N/A'}</td>
                <td>${reg.studentName}</td>
                <td>${getStudentClassName(student?.classId, student?.division)}</td>
                ${eventsToDisplay.map(event => reg.events.includes(event.id) ? '<td class="tick-box text-center fw-bold">âœ“</td>' : '<td class="not-participating"></td>').join('')}
            </tr>`;
        });
    });

    // --- Step 5: Create a dynamic title for the report (Now includes event type) ---
    const houseNameForTitle = selectedHouseId === 'ALL' ? 'All_Houses' : festHouses.find(h=>h.id === selectedHouseId)?.name.replace(' ','_') || 'House';
    const eventTypeTitle = selectedEventType !== 'ALL' ? `_${selectedEventType}` : '';
    const reportTitle = `${selectedCategory}${eventTypeTitle}_(${houseNameForTitle})`;
    const displayTitle = `Entry Sheet: ${selectedCategory}${eventTypeTitle.replace('_',' ')} - ${houseNameForTitle.replace('_',' ')}`;

    // --- Step 6: Assemble the final report HTML (No change needed here) ---
    const contentHtml = `
        <div class="printable-report">
            <h3 class="text-center">${fest?.name || ''}</h3>
            <h4 class="text-center text-muted">${displayTitle}</h4>
            <table class="table table-bordered table-sm mt-4 entry-sheet-table">
                <thead><tr>
                    <th style="width: 3%;">Sl.</th>
                    <th style="width: 5%;">Chest</th>
                    <th style="width: 15%;">Name</th>
                    <th style="width: 5%;">Class</th>
                    ${eventsToDisplay.map(e => `<th class="vertical-header"><div>${e.name}</div></th>`).join('')}
                </tr></thead>
                <tbody>${tableBodyHtml}</tbody>
            </table>
            <div class="report-footer"><p>Official's Signature: _________________________</p></div>
        </div>
    `;
    
    return { contentHtml, reportTitle };
}
/**
 * Generates the HTML for the entry sheet based on category and house filters.
 * @param {string} festId - The ID of the current fest.
 * @param {string} selectedCategory - The category name, or "ALL".
 * @param {string} selectedHouseId - The house ID, or "ALL".
 * @returns {object} An object with the HTML content and a title for the report.
 */
function generateCategoryEntrySheetHTML2(festId, selectedCategory, selectedHouseId) {
    const fest = fests.find(f => f.id === festId);

    // 1. Filter events based on the selected category
    const eventsToDisplay = (selectedCategory === 'ALL')
        ? festEvents.filter(e => e.festId === festId)
        : festEvents.filter(e => e.festId === festId && e.category === selectedCategory);
    eventsToDisplay.sort((a, b) => a.name.localeCompare(b.name));

    // 2. Filter participants based on the selected house AND if they are in any of the selected events
    let filteredParticipants = festRegistrations.filter(r => r.festId === festId);

    if (selectedHouseId !== 'ALL') {
        filteredParticipants = filteredParticipants.filter(r => r.houseId === selectedHouseId);
    }
    
    // Only keep participants who are in at least one of the events we are displaying
    const eventIdsToDisplay = eventsToDisplay.map(e => e.id);
    filteredParticipants = filteredParticipants.filter(r => r.events.some(eventId => eventIdsToDisplay.includes(eventId)));

    if (filteredParticipants.length === 0) {
        showAlert('No participants found for the selected filters.', 'info');
        return { contentHtml: null };
    }
    
    // 3. Group the filtered participants by their house
    const participantsByHouse = filteredParticipants.reduce((acc, reg) => {
        const houseId = reg.houseId || 'UNASSIGNED';
        if (!acc[houseId]) acc[houseId] = [];
        acc[houseId].push(reg);
        return acc;
    }, {});
    
    const sortedHouseIds = Object.keys(participantsByHouse).sort(/* ...sorting logic from original code... */);
    
    // 4. Build the table body, grouped by house
    let tableBodyHtml = '';
    let serialNumber = 1;

    sortedHouseIds.forEach(houseId => {
        const house = festHouses.find(h => h.id === houseId);
        const houseName = house ? house.name : 'Unassigned';
        tableBodyHtml += `<tr class="house-header-row"><td colspan="${4 + eventsToDisplay.length}">${houseName.toUpperCase()}</td></tr>`;
        
        const participantsInHouse = participantsByHouse[houseId].sort((a, b) => 
            (a.chestNo || a.studentName).toString().localeCompare((b.chestNo || b.studentName).toString(), undefined, { numeric: true })
        );
        
        participantsInHouse.forEach(reg => {
            const student = students.find(s => s.id === reg.studentId);
            tableBodyHtml += `<tr>
                <td>${serialNumber++}</td>
                <td>${reg.chestNo || 'N/A'}</td>
                <td>${reg.studentName}</td>
                <td>${getStudentClassName(student?.classId, student?.division)}</td>
                ${eventsToDisplay.map(event => reg.events.includes(event.id) ? '<td class="tick-box text-center fw-bold">âœ“</td>' : '<td class="not-participating"></td>').join('')}
            </tr>`;
        });
    });

    // 5. Create a dynamic title for the report
    const houseNameForTitle = selectedHouseId === 'ALL' ? 'All_Houses' : festHouses.find(h=>h.id === selectedHouseId)?.name.replace(' ','_') || 'House';
    const reportTitle = `${selectedCategory}_(${houseNameForTitle})`;
    const displayTitle = `Entry Sheet: ${selectedCategory} (${houseNameForTitle.replace('_',' ')})`;

    // 6. Assemble the final report HTML
    const contentHtml = `
        <div class="printable-report">
            <h3 class="text-center">${fest?.name || ''}</h3>
            <h4 class="text-center text-muted">${displayTitle}</h4>
            <table class="table table-bordered table-sm mt-4 entry-sheet-table">
                <thead><tr>
                    <th>Sl.</th>
                    <th style="width: 5%;">Chest</th>
                    <th style="width: 15%;">Name</th>
                    <th style="width: 3%;">Class</th>
                    ${eventsToDisplay.map(e => `<th class="vertical-header"><div>${e.name}</div></th>`).join('')}
                </tr></thead>
                <tbody>${tableBodyHtml}</tbody>
            </table>
            <div class="report-footer"><p>Official's Signature: _________________________</p></div>
        </div>
    `;
    
    return { contentHtml, reportTitle };
}

/**
 * Generates the HTML for the entry sheet, now grouped by house.
 * @param {string} festId The ID of the fest.
 * @param {string} categoryName The name of the category.
 * @returns {string|null} The HTML string for the report, or null if no data.
 */
function generateCategoryEntrySheetHTMLold(festId, categoryName) {
    const fest = fests.find(f => f.id === festId);

    // 1. Find all events and participants relevant to this category
    const eventsInCategory = festEvents.filter(e => e.festId === festId && e.category === categoryName).sort((a,b) => a.name.localeCompare(b.name));
    const allParticipants = festRegistrations.filter(r => r.festId === festId && r.events.some(eventId => eventsInCategory.some(ev => ev.id === eventId)));

    if (allParticipants.length === 0) {
        showAlert(`No participants found for the '${categoryName}' category.`, 'info');
        return null;
    }
    
    // 2. Group participants by their assigned house
    const participantsByHouse = allParticipants.reduce((acc, reg) => {
        const houseId = reg.houseId || 'UNASSIGNED';
        if (!acc[houseId]) {
            acc[houseId] = [];
        }
        acc[houseId].push(reg);
        return acc;
    }, {});

    const sortedHouseIds = Object.keys(participantsByHouse).sort((a, b) => {
        if (a === 'UNASSIGNED') return 1; // Put unassigned at the end
        if (b === 'UNASSIGNED') return -1;
        const houseA = festHouses.find(h => h.id === a)?.name || '';
        const houseB = festHouses.find(h => h.id === b)?.name || '';
        return houseA.localeCompare(houseB);
    });

    // 3. Build the table HTML with house groupings
    let tableBodyHtml = '';
    let serialNumber = 1;

    sortedHouseIds.forEach(houseId => {
        const house = festHouses.find(h => h.id === houseId);
        const houseName = house ? house.name : 'Unassigned';
        const houseColor = house ? house.color : '#f8f9fa';

        // Add a header row for the house
        tableBodyHtml += `<tr class="house-header-row"><td colspan="${4 + eventsInCategory.length}" style="background-color: ${houseColor}30;">${houseName.toUpperCase()}</td></tr>`;

        // Sort participants within the house by chest number or name
        const participantsInHouse = participantsByHouse[houseId].sort((a, b) => 
            (a.chestNo || a.studentName).toString().localeCompare((b.chestNo || b.studentName).toString(), undefined, { numeric: true })
        );

        participantsInHouse.forEach(reg => {
            const student = students.find(s => s.id === reg.studentId);
            tableBodyHtml += `
                <tr>
                    <td>${serialNumber++}</td>
                    <td>${reg.chestNo || 'N/A'}</td>
                    <td>${reg.studentName}</td>
                    <td>${getStudentClassName(student?.classId, student?.division)}</td>
                    ${eventsInCategory.map(event => {
                        const isParticipating = reg.events.includes(event.id);
                        return isParticipating ? '<td class="tick-box text-center fw-bold">âœ“</td>' : '<td class="not-participating"></td>';
                    }).join('')}
                </tr>`;
        });
    });

    // 4. Assemble the final report HTML
    return `
        <div class="printable-report">
            <h3 class="text-center">${fest?.name || ''}</h3>
            <h4 class="text-center text-muted">Entry Sheet: ${categoryName}</h4>
            <table class="table table-bordered table-sm mt-4 entry-sheet-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">Sl.No.</th>
                        <th style="width: 8%;">Chest No.</th>
                        <th>Name</th>
                        <th style="width: 10%;">Class</th>
                        ${eventsInCategory.map(e => `<th class="vertical-header"><div>${e.name} (${e.id})</div></th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${tableBodyHtml}
                </tbody>
            </table>
            <div class="report-footer">
                <p>Official's Signature: _________________________</p>
            </div>
        </div>
    `;
}
/**
 * Generates and prints a multi-page document with a result sheet for each selected event.
 */
window.printEventResultSheet = function() {
    if (!state.managingFest) {
        return showAlert('Please select a fest first.', 'warning');
    }
    const festId = state.managingFest.id;

    // Get all selected event IDs from the multi-select box
    const selectedEventIds = Array.from(document.getElementById('report-event-multiselect').selectedOptions).map(opt => opt.value);

    if (selectedEventIds.length === 0) {
        return showAlert('Please select at least one event to generate a sheet.', 'warning');
    }
    
    // Generate the HTML for each selected event's scoresheet
    let allSheetsHtml = '';
    selectedEventIds.forEach(eventId => {
        const singleSheetHtml = generateEventResultSheetHTML(festId, eventId);
        if (singleSheetHtml) {
            // Wrap each sheet in a div to control page breaks
            allSheetsHtml += `<div class="printable-page">${singleSheetHtml}</div>`;
        }
    });

    if (!allSheetsHtml) {
        // This can happen if all selected events have no participants
        showAlert('Could not generate sheets for the selected events (they may have no participants).', 'info');
        return;
    }

    // Define the CSS for printing, including page break rules
    const extraCss = `
        .printable-page { 
            page-break-after: always; 
        }
        .printable-page:last-child { 
            page-break-after: avoid; 
        }
        .result-sheet-table .entry-cell { height: 40px; }
        .result-sheet-table .group-members { font-size: 0.8em; list-style-type: none; padding-left: 0; }
        .report-footer { margin-top: 50px; display: flex; justify-content: space-around; font-size: 10pt; }
    `;

    // Call the generic print utility with the combined HTML
    printReport({ 
        contentHtml: allSheetsHtml, 
        title: `Result_Sheets_${state.managingFest.name}`, 
        extraCss 
    });
}

/**
 * Generates and prints a BLANK registration sheet for a specific category,
 * with 25 empty rows for manual entry.
 * @param {string} festId The ID of the fest.
 * @param {string} categoryName The name of the category.
 */
window.printCategoryRegistrationSheet = () => {
    const eventType = document.getElementById('reg-sheet-offstage').checked ? 'offStage' : 'onStage';
    const festId = state.managingFest.id;
    const categoryName = document.getElementById('report-category-select-blank').value;
    const fest = fests.find(f => f.id === festId);
    if (!fest) return;
    if (!categoryName) return showAlert('Please select a category first.', 'warning');

    // 1. Filter events by category AND the selected event type.
    const eventsInCategory = festEvents.filter(e =>
        e.festId === festId &&
        e.category === categoryName &&
        (e.type === eventType || (eventType === 'onStage' && e.type === undefined))
    ).sort((a, b) => a.name.localeCompare(b.name));

    if (eventsInCategory.length === 0) {
        showAlert(`No '${eventType}' events found for the '${categoryName}' category.`, 'info');
        return;
    }

    // 2. Create 25 empty rows for manual entry
    let emptyRowsHtml = '';
    for (let i = 1; i <= 35; i++) {
        emptyRowsHtml += `
            <tr>
                <td>${i}</td>
                <td class="entry-cell"></td>
                <td class="entry-cell"></td>
                <td class="entry-cell"></td>
                ${eventsInCategory.map(() => '<td class="tick-box"></td>').join('')}
            </tr>
        `;
    }

    // 3. Assemble the final report HTML
    const contentHtml = `
        <div class="printable-report">
            <h3 class="text-center">${fest.name}</h3>
            <h4 class="text-center text-muted">Registration Sheet: ${categoryName} (${eventType === 'offStage' ? 'Off-Stage' : 'On-Live'})</h4>
            <p style="margin-bottom:0px;">HOUSE NAME: _________________________</p>
            <table class="table table-bordered table-sm mt-4 entry-sheet-table">
                <thead>
                    <tr>
                        <th style="width: 4%;">Sl</th>
                        <th style="width: 4%;">Ad.No.</th>
                        <th style="width: 18%;">Name</th>
                        <th style="width: 5%;">Class</th>
                        ${eventsInCategory.map(e => `<th class="vertical-header"><div>${e.name}</div></th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${emptyRowsHtml}
                </tbody>
            </table>
            <div class="report-footer">
                <p>Official's Signature: _________________________</p>
            </div>
        </div>
    `;

    // 4. Define the CSS and call the print utility
    // EDIT: The CSS for .vertical-header and its div has been updated for centering.
    const extraCss = `
        .entry-sheet-table { font-size: 9pt; border-collapse: collapse; width: 100%; }
        .entry-sheet-table th, .entry-sheet-table td { border: 1px solid #dee2e6; }
        .vertical-header { 
            height: 180px; 
            white-space: nowrap; 
            text-align: center; 
            vertical-align: middle; 
            position: relative; 
        }
        .vertical-header div { 
            /* This transform first centers the element, then rotates it */
            transform: translate(-50%, -50%) rotate(-90deg); 
            position: absolute; 
            top: 50%; 
            left: 50%;
            width: 170px; /* Should be slightly less than the header height */
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .tick-box { width: 35px; text-align: center; }
        .entry-cell { height: 25px; } /* Space for handwriting */
        .report-footer { margin-top: 40px; text-align: right; font-size: 10pt; }
    `;

    printReport({
        contentHtml,
        title: `Registration_Sheet_${categoryName}_${eventType}`,
        extraCss,
        pageSize: 'A4 landscape'
    });
}







/**
 * Generates the HTML for the result sheet, adapting for solo or group events.
 * @param {string} festId The ID of the fest.
 * @param {string} eventId The ID of the event.
 * @returns {string|null} The HTML string for the report, or null if no data.
 */
function generateEventResultSheetHTML(festId, eventId) {
    const fest = fests.find(f => f.id === festId);
    const event = festEvents.find(e => e.id === eventId);
    if (!event) return null;

    const participants = festRegistrations.filter(r => r.festId === festId && r.events.includes(eventId));

    if (participants.length === 0) {
        showAlert(`No participants are registered for the event: ${event.name}.`, 'info');
        return null;
    }

    let tableBodyHtml = '';

    // --- SMART LAYOUT LOGIC ---
    if (event.isGroupEvent) {
        // --- RENDER FOR GROUP EVENT ---
        const participantsByGroup = participants.reduce((acc, reg) => {
            const group = festGroups.find(g => g.festId === festId && g.members.includes(reg.studentId));
            const groupId = group ? group.id : `INDIVIDUAL_${reg.studentId}`; // Fallback for individuals in a group event
            const groupName = group ? group.name : `${reg.studentName} (Individual)`;

            if (!acc[groupId]) {
                acc[groupId] = { name: groupName, houseId: reg.houseId, members: [] };
            }
            acc[groupId].members.push(reg);
            return acc;
        }, {});

        Object.values(participantsByGroup).forEach(group => {
            const house = festHouses.find(h => h.id === group.houseId);
            const memberList = group.members.map(mem => `<li>${mem.studentName} (${mem.chestNo || 'N/A'})</li>`).join('');
            tableBodyHtml += `
                <tr>
                    <td>
                        <strong>${group.name}</strong>
                        <ul class="group-members text-muted">${memberList}</ul>
                    </td>
                    <td>${house?.name || ''}</td>
                    <td class="entry-cell"></td>
                    <td class="entry-cell"></td>
                </tr>
            `;
        });

    } else {
        // --- RENDER FOR SOLO EVENT ---
        participants.sort((a, b) => (a.chestNo || a.studentName).toString().localeCompare((b.chestNo || b.studentName).toString(), undefined, { numeric: true }));
        
        participants.forEach(reg => {
            const house = festHouses.find(h => h.id === reg.houseId);
            tableBodyHtml += `
                <tr>
                    <td>${reg.chestNo || 'N/A'}</td>
                    <td>${reg.studentName}</td>
                    <td>${house?.name || ''}</td>
                    <td class="entry-cell"></td>
                    <td class="entry-cell"></td>
                </tr>`;
        });
    }

    // Add a few extra blank rows for write-ins
    const blankRows = Array(3).fill(`<tr><td class="entry-cell" colspan="${event.isGroupEvent ? 2 : 3}"></td><td class="entry-cell"></td><td class="entry-cell"></td></tr>`).join('');

    return `
        <div class="printable-report">
            <h3 class="text-center">${fest?.name || ''}</h3>
            <h4 class="text-center text-muted">Result Sheet: ${event.name} (${event.category})</h4>
            
            <table class="table table-bordered mt-4 result-sheet-table">
                <thead class="table-light">
                    <tr>
                        ${event.isGroupEvent 
                            ? `<th style="width:50%">Group / Participants</th>`
                            : `<th style="width:10%">Chest No.</th><th style="width:40%">Name</th>`
                        }
                        <th style="width:15%">House</th>
                        <th style="width:10%">Score</th>
                        <th style="width:25%">Remarks</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableBodyHtml}
                    ${blankRows}
                </tbody>
            </table>

            <div class="report-footer">
                <p>Judge 1 Signature: _________________________</p>
                <p>Judge 2 Signature: _________________________</p>
            </div>
        </div>
    `;
}
// -------------------------------------------------------------------------
// --- 8. GLOBAL HELPER & UTILITY FUNCTIONS ---
// -------------------------------------------------------------------------

/**
 * Calculates aggregate points for houses and events from all saved results.
 * @param {string} festId The ID of the fest to calculate results for.
 * @returns {object} An object containing aggregated points.
 */
function calculateFinalResults(festId) {
    const housePoints = {};
    festHouses.forEach(h => housePoints[h.id] = 0); // Initialize all houses with 0 points
    const eventBreakdown = {};

    const relevantResults = festResults.filter(r => r.festId === festId);

    for (const result of relevantResults) {
        const event = festEvents.find(e => e.id === result.eventId);
        if (!event) continue; // Skip if event not found

        // Initialize category and event name in breakdown if they don't exist
        if (!eventBreakdown[event.category]) eventBreakdown[event.category] = {};
        if (!eventBreakdown[event.category][event.name]) eventBreakdown[event.category][event.name] = {};

        for (const standing of result.results) {
            if (standing.points > 0) {
                // Find the participant's registration to get their house
                const registration = festRegistrations.find(r => r.festId === festId && r.studentId === standing.studentId);
                if (registration?.houseId) {
                    const houseId = registration.houseId;
                    // Add points to the house's total
                    housePoints[houseId] = (housePoints[houseId] || 0) + standing.points;
                    // Add points to the event-specific breakdown
                    eventBreakdown[event.category][event.name][houseId] = (eventBreakdown[event.category][event.name][houseId] || 0) + standing.points;
                }
            }
        }
    }
    return { housePoints, eventBreakdown };
}
function getStudentAgeCategory(studentDob) {
    if (!studentDob || !managingFest.ageCategories || managingFest.ageCategories.length === 0) {
        return 'General';
    }
    const dob = new Date(studentDob);
    // The categories should already be sorted from youngest to oldest (latest bornAfterDate to earliest)
    const sortedCategories = managingFest.ageCategories;

    for (const category of sortedCategories) {
        if (dob >= new Date(category.bornAfterDate)) {
            return category.name;
        }
    }
    // If the student is older than all defined categories, you might have a default "Seniors" category
    // or return the last category name as a fallback.
    return 'General'; // Default fallback
}


function getStudentClassName(classId, division) {
    if (!classId) return 'N/A';
    if(classId&&division){
    const classInfo = classes.find(c => c.id === classId);
    return classInfo ? `${classInfo.name}-${division}` : 'N/A';
    }
    if(classId&&!division){
        const classInfo = classes.find(c => c.id === classId);
    return classInfo ? `${classInfo.name}` : 'N/A';

    }
}
window.deleteFestItem = async(collectionName, id, rerenderFunctionName) =>{
    // Add specific checks for cascading deletes if needed
    if (collectionName === 'fests') {
        if (festEvents.some(e => e.festId === id)) {
            return showAlert('Cannot delete fest. It has associated events.', 'danger');
        }
    }

    if (confirm(`Are you sure you want to delete this item? This action cannot be undone.`)) {
        try {
            await deleteDoc(getDocRef(collectionName, id));
            showAlert('Item deleted successfully.', 'success');
            
            // Clear any edit state related to the deleted item
            if (collectionName === 'fests' && state.festToEdit?.id === id) clearFestEdit();
            if (collectionName === 'festHouses' && state.houseToEdit?.id === id) clearHouseEdit();
            if (collectionName === 'festEvents' && state.eventToEdit?.id === id) clearEventEdit();
            
            // The Firestore listener will auto-update the data array,
            // so we just need to re-render the view.
            if (window[rerenderFunctionName]) {
                window[rerenderFunctionName]();
            }
        } catch (error) {
            console.error(`Error deleting item from ${collectionName}:`, error);
            showAlert('Failed to delete item. See console for details.', 'danger');
        }
    }
}

// State management helpers
window.selectFestToManage = (festId) => { state.managingFest = fests.find(f => f.id === festId) || null; renderFestManagement(); };
window.unselectFest = () => { state.managingFest = null; renderFestManagement(); };
window.editFest = (festId) => { state.festToEdit = fests.find(f => f.id === festId); renderFestSetupTab(); };
window.clearFestEdit = () => { state.festToEdit = null; renderFestSetupTab(); };
window.editHouse = (houseId) => { state.houseToEdit = festHouses.find(h => h.id === houseId); renderFestSetupTab(); };
window.clearHouseEdit = () => { state.houseToEdit = null; renderFestSetupTab(); };
window.editEvent = (eventId) => { state.eventToEdit = festEvents.find(e => e.id === eventId); renderFestEventsTab(); };
window.clearEventEdit = () => { state.eventToEdit = null; renderFestEventsTab(); };

window.renderMyFestEvents = () => {
    mainContent.innerHTML = `
        <h1 class="h2 mb-4">My Fest Participation</h1>
        <div class="card shadow">
            <div class="card-body">
                <div class="mb-4">
                    <label for="my-fest-select" class="form-label">Select a Fest to View Your Details:</label>
                    <select id="my-fest-select" class="form-select">
                        ${fests.map(f => `<option value="${f.id}">${f.name}</option>`).join('')}
                    </select>
                </div>
                <div id="my-events-list-container">
                    </div>
            </div>
        </div>
    `;

    const festSelect = document.getElementById('my-fest-select');
    festSelect.addEventListener('change', () => renderMyEventsList());

    // Initial render for the default selected fest
    renderMyEventsList();
}

/**
 * Renders the list of events a student is registered for in a selected fest.
 * This is a helper function called by renderMyFestEvents.
 */
function renderMyEventsList() {
    const container = document.getElementById('my-events-list-container');
    const festSelect = document.getElementById('my-fest-select');
    const festId = festSelect.value;

    if (!festId) {
        container.innerHTML = '<p class="text-muted">Please select a fest.</p>';
        return;
    }

    // Find the student's registration document for the selected fest
    const registration = festRegistrations.find(r => r.festId === festId && r.studentId === selectedUser.id);

    if (!registration || registration.events.length === 0) {
        container.innerHTML = '<p class="alert alert-info">You are not registered for any events in this fest.</p>';
        return;
    }

    // Get the full details for each registered event
    const registeredEvents = registration.events.map(eventId => {
        return festEvents.find(e => e.id === eventId);
    }).filter(Boolean); // Filter out any undefined events

    container.innerHTML = `
        <div class="text-center mb-4">
            <h5 class="text-muted">Your Chest Number</h5>
            <span class="badge bg-primary p-3 fs-2">${registration.chestNo || "Not Assigned"}</span>
        </div>
        <h5 class="mt-4">You are registered for the following events:</h5>
        <ul class="list-group">
            ${registeredEvents.map(event => `
                <li class="list-group-item">
                    <strong>${event.name}(${event.category})</strong>
                    <span class="badge bg-info float-end">${event.category}</span>
                </li>
            `).join('')}
        </ul>
    `;
}





    window.renderTimetableManagement = () => {
    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Timetable Management</h1>
        <div class="card shadow">
            <div class="card-body">
                <div classs="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Class</label>
                        <select id="timetable-class" class="form-select">
                            <option value="">-- Select Class --</option>
                            ${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Division</label>
                        <select id="timetable-division" class="form-select" disabled></select>
                    </div>
                </div>
                <div id="timetable-grid-container" class="mt-4"></div>
            </div>
        </div>`;
    attachTimetableListeners();
};

function attachTimetableListeners() {
    const classSelect = document.getElementById('timetable-class');
    const divisionSelect = document.getElementById('timetable-division');

    classSelect.addEventListener('change', () => {
        const selectedClass = classes.find(c => c.id === classSelect.value);
        divisionSelect.innerHTML = '<option value="">-- Select Division --</option>';
        if (selectedClass) {
            divisionSelect.disabled = false;
            divisionSelect.innerHTML += selectedClass.divisions.map(d => `<option value="${d}">${d}</option>`).join('');
        } else {
            divisionSelect.disabled = true;
        }
    });

    divisionSelect.addEventListener('change', () => {
        if (classSelect.value && divisionSelect.value) {
            renderTimetableGrid(classSelect.value, divisionSelect.value);
        }
    });
}

function renderTimetableGrid(classId, division) {
    const container = document.getElementById('timetable-grid-container');
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const periods = Array.from({ length: 8 }, (_, i) => i + 1);
    const allocatedSubjects = classroomSubjects.filter(cs => cs.classId === classId && cs.division === division)
        .map(cs => ({ ...cs, subjectName: subjects.find(s => s.id === cs.subjectId)?.name || 'N/A' }));

    let gridHTML = `<table class="table table-bordered text-center">
                        <thead><tr><th>Day</th>${periods.map(p => `<th>Period ${p}</th>`).join('')}</tr></thead>
                        <tbody>`;

    days.forEach(day => {
        gridHTML += `<tr><td class="fw-bold">${day}</td>`;
        periods.forEach(period => {
            gridHTML += `<td>
                            <select class="form-select form-select-sm timetable-period-select" data-day="${day}" data-period="${period}">
                                <option value="">-</option>
                                ${allocatedSubjects.map(s => `<option value="${s.subjectId}">${s.subjectName}</option>`).join('')}
                            </select>
                         </td>`;
        });
        gridHTML += `</tr>`;
    });

    gridHTML += `</tbody></table>
                 <div class="text-end mt-3">
                    <button id="save-timetable-btn" class="btn btn-primary">Save Timetable</button>
                 </div>`;
    container.innerHTML = gridHTML;
}

document.getElementById('save-timetable-btn')?.addEventListener('click', async () => {
    const classId = document.getElementById('timetable-class').value;
    const division = document.getElementById('timetable-division').value;
    const timetableId = `${classId}_${division}`;
    const schedule = {};

    document.querySelectorAll('.timetable-period-select').forEach(select => {
        const day = select.dataset.day;
        const period = select.dataset.period;
        if (!schedule[day]) schedule[day] = {};
        schedule[day][period] = select.value;
    });

    try {
        await setDoc(getDocRef('timetables', timetableId), { schedule });
        showAlert('Timetable saved successfully!', 'success');
    } catch (error) {
        showAlert('Failed to save timetable.', 'danger');
    }
});

    
window.renderClassTimetableView = async () => {
    let classId, division;
    if (currentUserRole === 'student') {
        classId = selectedUser.classId;
        division = selectedUser.division;
    } else if (currentUserRole === 'teacher' && selectedUser.classCharge) {
        classId = selectedUser.classCharge.classId;
        division = selectedUser.classCharge.division;
    }

    if (!classId || !division) {
        mainContent.innerHTML = '<p>Timetable not available.</p>';
        return;
    }

    const timetableId = `${classId}_${division}`;
    const timetableDoc = await getDoc(getDocRef('timetables', timetableId));
    const timetableData = timetableDoc.exists() ? timetableDoc.data().schedule : {};

    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const periods = Array.from({ length: 8 }, (_, i) => i + 1);

    let tableHTML = `<h1 class="h2 mb-4">Class Timetable</h1>
                     <div class="table-responsive">
                        <table class="table table-bordered text-center">
                            <thead><tr><th>Day</th>${periods.map(p => `<th>Period ${p}</th>`).join('')}</tr></thead>
                            <tbody>`;
    days.forEach(day => {
        tableHTML += `<tr><td class="fw-bold">${day}</td>`;
        periods.forEach(period => {
            const subjectId = timetableData[day]?.[period] || '';
            const subjectName = subjects.find(s => s.id === subjectId)?.name || '-';
            tableHTML += `<td>${subjectName}</td>`;
        });
        tableHTML += `</tr>`;
    });
    tableHTML += `      </tbody>
                     </table>
                    </div>`;
    mainContent.innerHTML = tableHTML;
};



function saveFormToLocalStorage(formId) {
    const form = document.getElementById(formId);
    if (!form || !currentUserRole) return;

    const formData = {};
    for (const element of form.elements) {
        if (element.id) {
            if (element.type === 'checkbox') {
                formData[element.id] = element.checked;
            } else if (element.type !== 'submit' && element.type !== 'button') {
                formData[element.id] = element.value;
            }
        }
    }
    // We prefix the key with the user's role and form ID to keep data separate
    const storageKey = `formData_${currentUserRole}_${formId}`;
    localStorage.setItem(storageKey, JSON.stringify(formData));
}

/**
 * Loads and populates a form with data from localStorage.
 * @param {string} formId The ID of the form to load.
 */
/**
 * Loads and populates a form with data from localStorage, now safely ignoring file inputs.
 * @param {string} formId The ID of the form to load.
 */
window.loadFormFromLocalStorage = (formId) => {
    const form = document.getElementById(formId);
    const storageKey = `formData_${currentUserRole}_${formId}`;
    const savedDataJSON = localStorage.getItem(storageKey);

    if (!form || !savedDataJSON) return;

    const savedData = JSON.parse(savedDataJSON);
    for (const key in savedData) {
        const element = form.elements[key];
        if (element) {
            // --- THIS IS THE FIX ---
            // Add a check to ensure the element is not a file input before setting its value.
            if (element.type !== 'file') { 
                if (element.type === 'checkbox') {
                    element.checked = savedData[key];
                } else {
                    element.value = savedData[key];
                }
            }
        }
    }
    showAlert('Unsaved form data has been restored.', 'info');
    // It's also good practice to clear the data after restoring it
    localStorage.removeItem(storageKey); 
}

// Add this event listener to handle browser back/forward buttons
window.addEventListener('popstate', (event) => {
    if (event.state && event.state.viewId) {
        // The 'false' argument is crucial. It prevents pushState from being called again,
        // which would break the browser's history.
        navigateTo(event.state.viewId, false);
    } else {
        // If the state is null, it might be the initial page load.
        // You can default to the dashboard.
        if (currentUserRole) {
            navigateTo('dashboard', false);
        }
    }
});




// // Global variable to store the currently selected Exam ID in this module
let selectedExamForControl = null;

/**
         * Renders the main Examination Control module interface.
         * Access is restricted to Admins and Teachers with 'exam_controller' role.
         */
        window.renderExamControlModule = () => {
            const isAdmin = currentUserRole === 'admin';
            const isExamController = currentUserRole === 'teacher' || selectedUser.roles && selectedUser.roles.includes('exam_controller');

            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;

            const hasAccess = currentUserRole === 'admin' || (selectedUser?.roles && selectedUser.roles.includes('exam_controller'));

            if (!hasAccess) {
                mainContent.innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Access Denied</h4>
                        <p>You do not have permission to access the Examination Control module.</p>
                    </div>`;
                return;
            }

            mainContent.innerHTML = `
                <h1 class="h2 mb-4">Examination Control</h1>
                <div class="tabs-container">
                <ul class="nav nav-tabs" id="examControlTab" role="tablist">
                ${isAdmin ? `<li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#add-exam" type="button">Add Exam</button></li>` : ''}
                ${isAdmin ? `<li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#schedule" type="button">Schedule</button></li>` : '<li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#schedule" type="button">Schedule</button></li>'}
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#consolidated-view" type="button">Consolidated View</button></li>
                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#timetable-view" type="button">Timetable</button></li>
                
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#exam-control-overview" type="button" role="tab" aria-controls="exam-control-overview" aria-selected="true">Exam Overview</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#exam-control-rooms" type="button" role="tab" aria-controls="exam-control-rooms" aria-selected="false">Room Management</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#exam-control-duty" type="button" role="tab" aria-controls="exam-control-duty" aria-selected="false">Duty Assignment</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#exam-control-absentee" type="button" role="tab" aria-controls="exam-control-absentee" aria-selected="false">Absentee Reporting</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#exam-control-reg-no" type="button" role="tab" aria-controls="exam-control-reg-no" aria-selected="false">Reg. No. Assignment</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#exam-control-room-alloc" type="button" role="tab" aria-controls="exam-control-room-alloc" aria-selected="false">Room Allocation</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#exam-control-hall-ticket" type="button" role="tab" aria-controls="exam-control-hall-ticket" aria-selected="false">Hall Ticket</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#exam-control-reports" type="button" role="tab" aria-controls="exam-control-reports" aria-selected="false">Reports</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#exam-control-notifications" type="button" role="tab" aria-controls="exam-control-notifications" aria-selected="false">Notifications</button>
                    </li>
                </ul>
                </div>
                <div class="tab-content card" id="examControlTabContent">
                     ${isAdmin ? `<div class="tab-pane fade p-2" id="add-exam" role="tabpanel"></div>` : ''}
        ${isAdmin ? `<div class="tab-pane fade p-2" id="schedule" role="tabpanel"></div>` : '<div class="tab-pane fade p-4" id="schedule" role="tabpanel"></div>'}
        <div class="tab-pane fade p-2" id="timetable-view" role="tabpanel"></div>
        <div class="tab-pane fade p-2" id="consolidated-view" role="tabpanel"></div>
    
                    <div class="tab-pane fade show active p-4" id="exam-control-overview" role="tabpanel" aria-labelledby="exam-control-overview-tab"></div>
                    <div class="tab-pane fade p-2" id="exam-control-rooms" role="tabpanel" aria-labelledby="exam-control-rooms-tab"></div>
                    <div class="tab-pane fade p-3" id="exam-control-duty" role="tabpanel" aria-labelledby="exam-control-duty-tab"></div>
                    <div class="tab-pane fade p-2" id="exam-control-absentee" role="tabpanel" aria-labelledby="exam-control-absentee-tab"></div>
                    <div class="tab-pane fade p-2" id="exam-control-reg-no" role="tabpanel" aria-labelledby="exam-control-reg-no-tab"></div>
                    <div class="tab-pane fade p-2" id="exam-control-room-alloc" role="tabpanel" aria-labelledby="exam-control-room-alloc-tab"></div>
                    <div class="tab-pane fade p-2" id="exam-control-hall-ticket" role="tabpanel" aria-labelledby="exam-control-hall-ticket-tab"></div>
                    <div class="tab-pane fade p-2" id="exam-control-reports" role="tabpanel" aria-labelledby="exam-control-reports-tab"></div>
                    <div class="tab-pane fade p-2" id="exam-control-notifications" role="tabpanel" aria-labelledby="exam-control-notifications-tab"></div>
                </div>
            `;

            // Render content for each sub-tab
            if (isAdmin) {
        renderExamAddTab();
        
    }
    renderExamScheduleTab();
    renderExamTimetableView();
    renderConsolidatedTimetableView(); 
            renderExamControlOverviewTab();
            renderExamControlRoomManagementTab();
            renderExamControlDutyAssignmentTab();
            renderExamControlAbsenteeReportingTab();
            renderExamControlRegNoAssignmentTab();
            renderExamControlRoomAllocationTab();
            renderExamControlHallTicketTab();
            renderExamControlReportsTab();
            renderExamControlNotificationsTab();

            // Attach listener for tab changes to re-render selected sub-tab
            document.querySelectorAll('#examControlTab .nav-link').forEach(tab => {
                tab.addEventListener('shown.bs.tab', (event) => {
                    const targetId = event.target.dataset.bsTarget;
                    switch(targetId) {
                        case '#exam-control-overview': renderExamControlOverviewTab(); break;
                        case '#exam-control-rooms': renderExamControlRoomManagementTab(); break;
                        case '#exam-control-duty': renderExamControlDutyAssignmentTab(); break;
                        case '#exam-control-absentee': renderExamControlAbsenteeReportingTab(); break;
                        case '#exam-control-reg-no': renderExamControlRegNoAssignmentTab(); break;
                        case '#exam-control-room-alloc': renderExamControlRoomAllocationTab(); break;
                        case '#exam-control-hall-ticket': renderExamControlHallTicketTab(); break;
                        case '#exam-control-reports': renderExamControlReportsTab(); break;
                        case '#exam-control-notifications': renderExamControlNotificationsTab(); break;
                    }
                });
            });
        };

        /**
         * Renders the Exam Overview tab content.
         * Shows exams and schedule details based on selection.
         */
        function renderExamControlOverviewTab() {
            const container = document.getElementById('exam-control-overview');
            if (!container) return;

            container.innerHTML = `
                <div class="row g-3 align-items-end mb-4">
                    <div class="col-md-6">
                        <label class="form-label" for="exam-overview-select">Select Exam</label>
                        <select id="exam-overview-select" class="form-select">
                            <option value="">-- Select an Exam --</option>
                            ${exams.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div id="exam-overview-details-container">
                    <p class="text-muted text-center p-4">Select an exam to view its schedule.</p>
                </div>
            `;

            const examSelect = document.getElementById('exam-overview-select');
            examSelect.addEventListener('change', () => {
                window.selectedExamForControl = examSelect.value;
                displayExamOverviewDetails(window.selectedExamForControl);
            });

            // Initial display if an exam was previously selected or to default to first
            if (exams.length > 0) {
                if (!window.selectedExamForControl) {
                    window.selectedExamForControl = exams[0].id; // Default to first exam
                }
                examSelect.value = window.selectedExamForControl;
                displayExamOverviewDetails(window.selectedExamForControl);
            }
        }

        /**
         * Displays the schedule details for the selected exam in the Overview tab.
         * @param {string} examId
         */
        function displayExamOverviewDetails(examId) {
            const container = document.getElementById('exam-overview-details-container');
            if (!container || !examId) {
                container.innerHTML = `<p class="text-muted text-center p-4">Select an exam to view its schedule.</p>`;
                return;
            }

            const schedules = examSchedules.filter(s => s.examId === examId);
            if (schedules.length === 0) {
                container.innerHTML = `<p class="alert alert-info text-center">No schedules found for this exam.</p>`;
                return;
            }

            // Group schedules by date and session
            const groupedSchedules = schedules.reduce((acc, schedule) => {
                const dateKey = schedule.date;
                const sessionKey = schedule.session;
                if (!acc[dateKey]) acc[dateKey] = {};
                if (!acc[dateKey][sessionKey]) acc[dateKey][sessionKey] = [];
                acc[dateKey][sessionKey].push(schedule);
                return acc;
            }, {});

            let html = `<h5>Exam Schedule Details</h5>`;
            Object.keys(groupedSchedules).sort().forEach(date => {
                html += `<h6 class="mt-3">${new Date(date).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h6>`;
                Object.keys(groupedSchedules[date]).sort().forEach(session => {
                    html += `<strong>Session: ${session === 'FN' ? 'Forenoon' : 'Afternoon'}</strong>`;
                    html += `<table class="table table-bordered table-sm mt-2">
                                <thead><tr><th>Class</th><th>Subject</th><th>Max TE</th><th>Max CE</th></tr></thead>
                                <tbody>`;
                    groupedSchedules[date][session].forEach(schedule => {
                        const className = classes.find(c => c.id === schedule.classId)?.name || 'N/A';
                        const subjectName = subjects.find(s => s.id === schedule.subjectId)?.name || 'N/A';
                        html += `<tr>
                                    <td>${className} - ${schedule.division}</td>
                                    <td>${subjectName}</td>
                                    <td>${schedule.maxTE}</td>
                                    <td>${schedule.maxCE}</td>
                                </tr>`;
                    });
                    html += `</tbody></table>`;
                });
            });
            container.innerHTML = html;
        }

/**
 * Renders the Room Management tab content (CRUD for exam rooms).
 */
function renderExamControlRoomManagementTab() {
    const container = document.getElementById('exam-control-rooms');
    if (!container) return;

    
    container.innerHTML = `
        <div class="row">
            <div class="col-lg-5">
                <div class="card shadow mb-4">
                    <div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">Add/Edit Exam Room</h6></div>
                    <div class="card-body">
                        <form id="exam-room-form">
                            <div class="mb-3">
                                <label class="form-label">Room No</label>
                                <input type="text" id="room-number" class="form-control" placeholder="e.g., 01" required ${roomToEdit ? '' : ''} value="${roomToEdit?.roomNumber || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Room ID</label>
                                <input type="text" id="room-id" class="form-control" placeholder="e.g., HALL-A" required ${roomToEdit ? 'readonly' : ''} value="${roomToEdit?.id || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Room Name</label>
                                <input type="text" id="room-name" class="form-control" placeholder="e.g., Main Exam Hall" required value="${roomToEdit?.name || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Capacity</label>
                                <input type="number" id="room-capacity" class="form-control" placeholder="e.g., 50" required min="1" value="${roomToEdit?.capacity || ''}">
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" id="room-is-lab" class="form-check-input" ${roomToEdit?.isLab ? 'checked' : ''}>
                                <label class="form-check-label" for="room-is-lab">Is this a Lab (for practicals)?</label>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea id="room-description" class="form-control" rows="2">${roomToEdit?.description || ''}</textarea>
                            </div>
                            <div class="d-flex justify-content-end gap-2">
                                ${roomToEdit ? `<button type="button" class="btn btn-secondary" id="cancel-room-edit-btn">Cancel</button>` : ''}
                                <button type="submit" class="btn btn-primary">Save Room</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="card shadow mb-4">
                    <div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">Existing Exam Rooms</h6></div>
                    <div class="card-body" id="exam-rooms-list-container"></div>
                </div>
            </div>
        </div>
    `;

    const renderRoomsList = () => {
        const listContainer = document.getElementById('exam-rooms-list-container');
        if (!listContainer) return;
        if (examRooms.length === 0) {
            listContainer.innerHTML = '<p class="text-muted">No exam rooms defined.</p>';
            return;
        }
        listContainer.innerHTML = `
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm">
                    <thead><tr><th>No</th><th>ID</th><th>Name</th><th>Capacity</th><th>Type</th><th class="text-end">Actions</th></tr></thead>
                    <tbody>
                        ${examRooms.map(room => `
                            <tr>
                                <td>${room.roomNumber}</td>
                                <td>${room.id}</td>
                                <td>${room.name}</td>
                                <td>${room.capacity}</td>
                                <td>${room.isLab ? 'Lab' : 'Hall'}</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1" onclick="window.editExamRoom('${room.id}')"><i class="fas fa-edit fa-xs"></i></button>
                                    <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="window.deleteExamRoom('${room.id}')"><i class="fas fa-trash fa-xs"></i></button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    };

    // Attach form submission listener
    document.getElementById('exam-room-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const roomNumber = document.getElementById('room-number').value.trim().toUpperCase();
        const id = document.getElementById('room-id').value.trim().toUpperCase();
        const name = document.getElementById('room-name').value.trim();
        const capacity = parseInt(document.getElementById('room-capacity').value);
        const isLab = document.getElementById('room-is-lab').checked;
        const description = document.getElementById('room-description').value.trim();

        if (!id || !name || isNaN(capacity) || capacity <= 0) {
            showAlert('Please fill all required fields correctly.', 'danger');
            return;
        }

        try {
            await setDoc(getDocRef('examRooms', id), { id, name, capacity, isLab, description,roomNumber }, { merge: true });
            showAlert('Exam room saved successfully!', 'success');
            roomToEdit = null; // Clear edit state
            renderExamControlRoomManagementTab(); // Re-render the tab
        } catch (error) {
            console.error("Error saving exam room:", error);
            showAlert('Failed to save exam room. See console.', 'danger');
        }
    });

    // Attach cancel edit listener
    document.getElementById('cancel-room-edit-btn')?.addEventListener('click', () => {
        roomToEdit = null;
        renderExamControlRoomManagementTab();
    });

    // Global helper functions for editing/deleting (defined outside for accessibility)
    window.editExamRoom = (id) => {
        roomToEdit = examRooms.find(r => r.id === id);
        renderExamControlRoomManagementTab();
    };
    window.deleteExamRoom = async (id) => {
        if (confirm("Are you sure you want to delete this exam room?")) {
            try {
                await deleteDoc(getDocRef('examRooms', id));
                showAlert('Exam room deleted.', 'success');
                renderExamControlRoomManagementTab();
            } catch (error) {
                console.error("Error deleting exam room:", error);
                showAlert('Failed to delete exam room.', 'danger');
            }
        }
    };

    renderRoomsList(); // Initial render of the list
}
// =========================================================================
// --- âš™ï¸ DUTY ROSTER MODULE (FINAL PROFESSIONAL VERSION w/ Categorized Dropdowns) ---
// =========================================================================

/**
 * Renders the enhanced Duty Roster tab with a two-panel layout.
 */
function renderExamControlDutyAssignmentTab() {
    const container = document.getElementById('exam-control-duty');
    if (!container) return;

    container.innerHTML = `
        <div class="ui-card mb-4">
            <h5 class="section-header">Duty Roster Planner</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-6"><label class="form-label" for="duty-exam-select">1. Select Exam</label><select id="duty-exam-select" class="form-select"><option value="">-- Select --</option>${exams.filter(e => e.isActive).map(e => `<option value="${e.id}">${e.name}</option>`).join('')}</select></div>
                <div class="col-md-6"><label class="form-label" for="duty-date-select">2. Select Date</label><select id="duty-date-select" class="form-select" disabled><option>-- Select Exam --</option></select></div>
            </div>
        </div>
        <div id="duty-consolidation-container" class="ui-card mb-4 d-none"></div>
        <div class="row g-4">
            <div class="col-lg-4">
                <div id="teacher-availability-container" class="ui-card h-100"></div>
            </div>
            <div class="col-lg-8">
                <div id="duty-assignment-grid-container" class="ui-card h-100"></div>
            </div>
        </div>
    `;

    const examSelect = document.getElementById('duty-exam-select');
    const dateSelect = document.getElementById('duty-date-select');

    const loadDutyData = () => {
    const examId = examSelect.value;
    const date = dateSelect.value;
    
    // --- KEY FIX IS HERE ---
    // First, clear the assignment grid container. This ensures that when the
    // new date's grid is drawn, it doesn't accidentally pick up unsaved
    // selections from the previously viewed date.
    const gridContainer = document.getElementById('duty-assignment-grid-container');
    if (gridContainer) {
        gridContainer.innerHTML = `<p class="text-muted text-center p-4">Loading assignments for ${new Date(date).toLocaleDateString()}...</p>`;
    }

    // Now, load the new data.
    displayDutyConsolidation(examId);
    displayTeacherAvailabilityRoster(examId, date); // This will call displayDutyAssignmentGrid
};

    examSelect.addEventListener('change', () => {
        const examId = examSelect.value;
        dateSelect.innerHTML = '<option value="">-- Select Date --</option>';
        if (examId) {
            const uniqueDates = [...new Set(examSchedules.filter(s => s.examId === examId).map(s => s.date))].sort();
            uniqueDates.forEach(d => dateSelect.innerHTML += `<option value="${d}">${new Date(d).toLocaleDateString('en-GB')}</option>`);
            dateSelect.disabled = false;
        } else { dateSelect.disabled = true; }
        loadDutyData();
    });

    dateSelect.addEventListener('change', loadDutyData);

    if (exams.length > 0) {
        examSelect.value = exams.find(e => e.isActive)?.id || exams[0].id;
        examSelect.dispatchEvent(new Event('change'));
    }
}


/**
 * Displays a consolidation sheet of duty counts for the entire exam.
 */
function displayDutyConsolidation(examId) {
    const container = document.getElementById('duty-consolidation-container');
    if (!container || !examId) { container.classList.add('d-none'); return; }
    container.classList.remove('d-none');
    const dutiesForExam = examDuties.filter(d => d.examId === examId);
    const teacherCounts = teachers.map(t => ({ name: t.name, count: dutiesForExam.filter(d => d.dutyTeacherId === t.id).length })).sort((a, b) => b.count - a.count);
    container.innerHTML = `<h5 class="section-header mb-0">Teacher Duty Consolidation (Entire Exam)</h5><div class="table-responsive mt-3" style="max-height: 200px;"><table class="table table-sm table-striped"><thead><tr><th>Teacher Name</th><th class="text-center">Total Duties</th></tr></thead><tbody>${teacherCounts.map(t => `<tr><td>${t.name}</td><td class="text-center">${t.count}</td></tr>`).join('')}</tbody></table></div>`;
}


/**
 * Displays the checklist for setting teacher availability.
 */
function displayTeacherAvailabilityRoster(examId, date) {
    const container = document.getElementById('teacher-availability-container');
    if (!container || !date) {
        container.innerHTML = '<p class="text-muted text-center p-4">Select a date.</p>';
        displayDutyAssignmentGrid(examId, date);
        return;
    }
    const eligibleTeachers = teachers.filter(t => t.role !== 'admin' && !(t.roles && t.roles.includes('exam_controller'))).sort((a, b) => a.name.localeCompare(b.name));
    const availabilityKey = `duty_availability_${date}`;
    const savedAvailableIds = JSON.parse(localStorage.getItem(availabilityKey));
    container.innerHTML = `<h5 class="section-header">Availability for ${new Date(date).toLocaleDateString('en-GB')}</h5><div class="form-check mb-2"><input class="form-check-input" type="checkbox" id="toggle-all-availability"><label class="form-check-label" for="toggle-all-availability"><strong>Toggle All</strong></label></div><div class="list-group" style="max-height: 400px; overflow-y: auto;">${eligibleTeachers.map(t => `<label class="list-group-item"><input class="form-check-input me-2 teacher-availability-checkbox" type="checkbox" value="${t.id}" ${savedAvailableIds ? (savedAvailableIds.includes(t.id) ? 'checked' : '') : 'checked'}> ${t.name}</label>`).join('')}</div>`;
    document.getElementById('toggle-all-availability').checked = savedAvailableIds ? savedAvailableIds.length === eligibleTeachers.length : true;
    container.addEventListener('change', e => {
        if (e.target.id === 'toggle-all-availability') container.querySelectorAll('.teacher-availability-checkbox').forEach(cb => cb.checked = e.target.checked);
        localStorage.setItem(availabilityKey, JSON.stringify(Array.from(container.querySelectorAll('.teacher-availability-checkbox:checked')).map(cb => cb.value)));
        displayDutyAssignmentGrid(examId, date);
    });
    displayDutyAssignmentGrid(examId, date);
}


/**
 * Intelligently SUGGESTS duties for a SINGLE session using the multi-pass system.
 * This is the final, corrected version with advanced logic.
 */
window.autoSuggestDutiesForSession = function(examId, date, session) {
    let slotsToFill = [];
    document.querySelectorAll(`#duty-assignment-table tr[data-room-id]`).forEach(row => {
        const select = row.querySelector(`select[data-session="${session}"]`);
        if (select && select.value === '') {
            slotsToFill.push({ date, session, roomId: row.dataset.roomId });
        }
    });

    if (slotsToFill.length === 0) {
        showAlert(`All ${session} duties are already assigned or no teachers are available.`, 'info');
        return;
    }
    
    // 1. Get initial state for calculations
    const dutiesForExam = examDuties.filter(d => d.examId === examId);
    const teacherDutyCounts = teachers.map(t => ({
        teacherId: t.id,
        name: t.name,
        count: dutiesForExam.filter(d => d.dutyTeacherId === t.id).length
    }));
    
    const availableTeacherIds = new Set(Array.from(document.querySelectorAll('.teacher-availability-checkbox:checked')).map(cb => cb.value));
    
    // This tracks assignments made *during this suggestion run* to prevent conflicts
    const sessionAssignments = new Set(Array.from(document.querySelectorAll(`select[data-session="${session}"]`)).map(s => s.value).filter(Boolean));

    // Helper function to assign a teacher and update our temporary trackers
    const assignTeacherToSlot = (teacher, slot) => {
        const selectToUpdate = document.querySelector(`tr[data-room-id="${slot.roomId}"] select[data-session="${slot.session}"]`);
        if (selectToUpdate) {
            selectToUpdate.value = teacher.teacherId;
            // Update temporary trackers
            const teacherInCount = teacherDutyCounts.find(t => t.teacherId === teacher.teacherId);
            if (teacherInCount) teacherInCount.count++;
            sessionAssignments.add(teacher.teacherId);
        }
    };

    // --- The Multi-Pass Logic ---

    // PASS 1: Assign specific SUBJECT TEACHERS
    slotsToFill.forEach(slot => {
        const sessionKey = `${examId}_${date.replace(/-/g, '')}_${slot.session}`;
        const studentsInRoom = students.filter(s => s.examRoomAllocations?.[sessionKey] === slot.roomId);
        const availableNow = teacherDutyCounts.filter(t => availableTeacherIds.has(t.teacherId) && !sessionAssignments.has(t.teacherId));
        if (studentsInRoom.length === 0 || availableNow.length === 0) return;

        const subjectsInRoom = new Set(examSchedules.filter(sch => sch.date === date && sch.session === slot.session && studentsInRoom.some(s => s.classId === sch.classId && s.division === sch.division)).map(sch => sch.subjectId));
        const preferredTeacherIds = new Set();
        studentsInRoom.forEach(student => subjectsInRoom.forEach(subjectId => {
            const subjectTeacher = classroomSubjects.find(cs => cs.classId === student.classId && cs.division === student.division && cs.subjectId === subjectId);
            if (subjectTeacher) preferredTeacherIds.add(subjectTeacher.teacherId);
        }));

        let preferredAndAvailable = availableNow.filter(t => preferredTeacherIds.has(t.teacherId));
        if (preferredAndAvailable.length > 0) {
            preferredAndAvailable.sort((a, b) => a.count - b.count);
            assignTeacherToSlot(preferredAndAvailable[0], slot);
        }
    });

    // Update slotsToFill to only include the remaining empty ones
    slotsToFill = slotsToFill.filter(slot => document.querySelector(`tr[data-room-id="${slot.roomId}"] select[data-session="${slot.session}"]`).value === '');

    // PASS 2: Assign any CLASS TEACHERS
    if (slotsToFill.length > 0) {
        slotsToFill.forEach(slot => {
            const sessionKey = `${examId}_${date.replace(/-/g, '')}_${slot.session}`;
            const studentsInRoom = students.filter(s => s.examRoomAllocations?.[sessionKey] === slot.roomId);
            const availableNow = teacherDutyCounts.filter(t => availableTeacherIds.has(t.teacherId) && !sessionAssignments.has(t.teacherId));
            if (studentsInRoom.length === 0 || availableNow.length === 0) return;

            const studentClassesInRoom = new Set(studentsInRoom.map(s => `${s.classId}_${s.division}`));
            const classTeacherIds = new Set();
            classroomSubjects.forEach(cs => {
                if (studentClassesInRoom.has(`${cs.classId}_${cs.division}`)) classTeacherIds.add(cs.teacherId);
            });

            let classTeachersAvailable = availableNow.filter(t => classTeacherIds.has(t.teacherId));
            if (classTeachersAvailable.length > 0) {
                classTeachersAvailable.sort((a, b) => a.count - b.count);
                assignTeacherToSlot(classTeachersAvailable[0], slot);
            }
        });
    }

    // Update slotsToFill again
    slotsToFill = slotsToFill.filter(slot => document.querySelector(`tr[data-room-id="${slot.roomId}"] select[data-session="${slot.session}"]`).value === '');

    // PASS 3: Assign ANY remaining teacher
    if (slotsToFill.length > 0) {
        slotsToFill.forEach(slot => {
            let availableNow = teacherDutyCounts.filter(t => availableTeacherIds.has(t.teacherId) && !sessionAssignments.has(t.teacherId));
            if (availableNow.length > 0) {
                availableNow.sort((a, b) => a.count - b.count);
                assignTeacherToSlot(availableNow[0], slot);
            }
        });
    }

    // Refresh the entire grid to reflect all suggestions and update disabled options
    displayDutyAssignmentGrid(examId, date);
    showAlert(`Suggestions for ${session} session have been filled in. Review and click "Save All" to confirm.`, 'success');
}
/**
 * MODIFIED: Clears all duty selections from the UI for the selected day, WITHOUT saving.
 */
window.clearAllDutiesForDay = function(examId, date) {
    if (!confirm(`This will clear all unsaved assignments from the screen for ${new Date(date).toLocaleDateString()}. It will not affect saved data. Continue?`)) return;
    document.querySelectorAll('#duty-assignment-table .duty-teacher-select').forEach(select => {
        select.value = '';
    });
    displayDutyAssignmentGrid(examId, date);
}


/**
 * Displays the duty assignment grid with categorized dropdowns.
 */
/**
 * Displays the duty assignment grid with categorized dropdowns and now includes
 * a summary of classes allocated to each room for each session.
 */
function displayDutyAssignmentGrid(examId, date) {
    const container = document.getElementById('duty-assignment-grid-container');
    if (!container || !examId || !date) { container.innerHTML = `<p class="text-muted text-center p-4">Select an exam and date.</p>`; return; }
    
    // Before redrawing, capture the current unsaved selections from the UI.
    const currentSelections = {};
    document.querySelectorAll('#duty-assignment-table .duty-teacher-select').forEach(select => {
        if (select.value) {
            currentSelections[`${select.dataset.session}_${select.closest('tr').dataset.roomId}`] = select.value;
        }
    });

    const rooms = examRooms.sort((a, b) => a.name.localeCompare(b.name));
    if (rooms.length === 0) { container.innerHTML = `<p class="alert alert-warning">No exam rooms defined.</p>`; return; }
    
    container.innerHTML = `
        <h5 class="section-header">Assignments for ${new Date(date).toLocaleDateString('en-GB')}</h5>
        <div class="table-responsive"><table class="table table-bordered table-sm" id="duty-assignment-table">
            <thead><tr>
                <th class="align-middle">Room & Class Summary</th>
                <th class="text-center">Forenoon (FN) <button class="btn btn-xs btn-info ms-2" onclick="window.autoSuggestDutiesForSession('${examId}', '${date}', 'FN')">Suggest</button></th>
                <th class="text-center">Afternoon (AN) <button class="btn btn-xs btn-info ms-2" onclick="window.autoSuggestDutiesForSession('${examId}', '${date}', 'AN')">Suggest</button></th>
            </tr></thead>
            <tbody></tbody>
        </table></div>
        <div class="d-flex justify-content-end mt-3">
            <button class="btn btn-outline-secondary me-2" onclick="window.clearDutiesFromUI('${examId}', '${date}')"><i class="fas fa-eraser me-2"></i>Clear Screen</button>
            <button class="btn btn-outline-danger me-2" onclick="window.clearSavedDutiesForDay('${examId}', '${date}')"><i class="fas fa-trash-alt me-2"></i>Clear & Un-assign</button>
            <button class="btn btn-success" onclick="window.saveAllDuties('${examId}', '${date}')"><i class="fas fa-save me-2"></i>Save Assignments</button>
        </div>
    `;
    
    const dutiesForExam = examDuties.filter(d => d.examId === examId);
    const teacherDutyCounts = teachers.map(t => ({ teacherId: t.id, name: t.name, count: dutiesForExam.filter(d => d.dutyTeacherId === t.id).length }));
    const availableTeacherIds = new Set(Array.from(document.querySelectorAll('.teacher-availability-checkbox:checked')).map(cb => cb.value));
    const tbody = container.querySelector('#duty-assignment-table tbody');

    // --- NEW LOGIC IS INTEGRATED HERE ---
    tbody.innerHTML = rooms.map(room => {
        const getSessionInfo = (session) => {
            const sessionKey = `${examId}_${date.replace(/-/g, '')}_${session}`;
            const studentsInRoom = students.filter(s => s.examRoomAllocations?.[sessionKey] === room.id);
            const classSummary = [...new Set(studentsInRoom.map(s => classes.find(c => c.id === s.classId)?.name))]
                                .sort().join(', ');
            return { studentsInRoom, classSummary };
        };

        const fnInfo = getSessionInfo('FN');
        const anInfo = getSessionInfo('AN');

        return `<tr data-room-id="${room.id}">
                    <td class="align-middle">
                        <strong>${room.name}</strong>
                        <div class="small text-muted">FN Classes: ${fnInfo.classSummary || 'N/A'}</div>
                        <div class="small text-muted">AN Classes: ${anInfo.classSummary || 'N/A'}</div>
                    </td>
                    <td><select class="form-select form-select-sm duty-teacher-select" data-session="FN"></select></td>
                    <td><select class="form-select form-select-sm duty-teacher-select" data-session="AN"></select></td>
                </tr>`;
    }).join('');


    ['FN', 'AN'].forEach(session => {
        const assignedInSession = Object.entries(currentSelections).filter(([key]) => key.startsWith(session)).map(([, value]) => value);
        container.querySelectorAll(`select[data-session="${session}"]`).forEach(select => {
            const roomId = select.closest('tr').dataset.roomId;
            const currentSelection = currentSelections[`${session}_${roomId}`] || examDuties.find(d => d.examId === examId && d.date === date && d.session === session && d.roomId === roomId)?.dutyTeacherId;
            const availableNow = teacherDutyCounts.filter(t => availableTeacherIds.has(t.teacherId) && (!assignedInSession.includes(t.teacherId) || t.teacherId === currentSelection));
            
            // Categorize available teachers
            const sessionKey = `${examId}_${date.replace(/-/g, '')}_${session}`;
            const studentsInRoom = students.filter(s => s.examRoomAllocations?.[sessionKey] === roomId);
            const subjectTeacherIds = new Set();
             if (studentsInRoom.length > 0) {
                const subjectsInRoom = new Set(examSchedules.filter(sch => sch.date === date && sch.session === session && studentsInRoom.some(s => s.classId === sch.classId && s.division === sch.division)).map(sch => sch.subjectId));
                studentsInRoom.forEach(student => subjectsInRoom.forEach(subjectId => {
                    const subjectTeacher = classroomSubjects.find(cs => cs.classId === student.classId && cs.division === student.division && cs.subjectId === subjectId);
                    if (subjectTeacher) subjectTeacherIds.add(subjectTeacher.teacherId);
                }));
            }
            const classTeacherIds = new Set();
            if (studentsInRoom.length > 0) {
                const studentClassesInRoom = new Set(studentsInRoom.map(s => `${s.classId}_${s.division}`));
                classroomSubjects.forEach(cs => { if (studentClassesInRoom.has(`${cs.classId}_${cs.division}`)) classTeacherIds.add(cs.teacherId); });
            }
            const bestMatches = availableNow.filter(t => subjectTeacherIds.has(t.teacherId)).sort((a,b)=>a.count-b.count);
            const goodMatches = availableNow.filter(t => classTeacherIds.has(t.teacherId) && !subjectTeacherIds.has(t.teacherId)).sort((a,b)=>a.count-b.count);
            const otherMatches = availableNow.filter(t => !subjectTeacherIds.has(t.teacherId) && !classTeacherIds.has(t.teacherId)).sort((a,b)=>a.count-b.count);

            const renderOptGroup = (teachers, label) => {
                if(teachers.length === 0) return '';
                return `<optgroup label="${label}">${teachers.map(t => `<option value="${t.teacherId}">${t.name} (${t.count})</option>`).join('')}</optgroup>`;
            }

            select.innerHTML = `<option value="">-- Un-assign --</option>
                                ${renderOptGroup(bestMatches, 'Best Match (Subject Teachers)')}
                                ${renderOptGroup(goodMatches, 'Good Match (Class Teachers)')}
                                ${renderOptGroup(otherMatches, 'Other Available Teachers')}`;
            select.value = currentSelection || "";
        });
    });
    
    //container.querySelector('#duty-assignment-table').addEventListener('change', () => displayDutyAssignmentGrid(examId, date));
}
/**
 * Clears saved duties for a day from the database.
 */
async function clearSavedDutiesForDay(examId, date) {
    if (!confirm(`DANGER: This will permanently delete all saved duties for ${new Date(date).toLocaleDateString()} from the database. Are you sure?`)) return;
    const batch = writeBatch(db);
    const dutiesToClear = examDuties.filter(d => d.examId === examId && d.date === date);
    if (dutiesToClear.length === 0) return showAlert('No saved duties to clear.', 'info');
    dutiesToClear.forEach(duty => batch.delete(getDocRef('examDuties', duty.id)));
    await batch.commit();
    showAlert('All saved duties for this day have been permanently cleared.', 'success');
}


/**
 * Saves all duties for a specific day from the grid.
 * This function first deletes all existing duties for the day, then adds back
 * only the ones currently assigned in the UI, correctly handling un-assignments.
 */
window.saveAllDuties = async function(examId, date) {
    // 1. Get all the assignments from the UI
    const rows = document.querySelectorAll('#duty-assignment-table tbody tr');
    if (!rows || rows.length === 0) {
        return showAlert('No duty roster to save.', 'info');
    }

    if (!confirm('Are you sure you want to save these assignments? This will overwrite any previously saved duties for this day.')) {
        return;
    }

    const batch = writeBatch(db);

    // 2. Clear all previously saved duties for this specific day and exam.
    // This is the key step that handles un-assignments.
    const dutiesToClear = examDuties.filter(d => d.examId === examId && d.date === date);
    dutiesToClear.forEach(oldDuty => {
        batch.delete(getDocRef('examDuties', oldDuty.id));
    });

    // 3. Loop through the UI and add the currently assigned duties to the batch.
    rows.forEach(row => {
        const roomId = row.dataset.roomId;

        // Process Forenoon Session
        const fnTeacherId = row.querySelector('select[data-session="FN"]').value;
        if (fnTeacherId) { // Only create a record if a teacher is selected
            const dutyId = `${examId}_${date.replace(/-/g, '')}_FN_${roomId}`;
            const teacherName = teachers.find(t => t.id === fnTeacherId)?.name || 'Unknown';
            batch.set(getDocRef('examDuties', dutyId), { 
                id: dutyId, examId, date, session: 'FN', roomId, 
                dutyTeacherId: fnTeacherId, dutyTeacherName: teacherName 
            });
        }

        // Process Afternoon Session
        const anTeacherId = row.querySelector('select[data-session="AN"]').value;
        if (anTeacherId) { // Only create a record if a teacher is selected
            const dutyId = `${examId}_${date.replace(/-/g, '')}_AN_${roomId}`;
            const teacherName = teachers.find(t => t.id === anTeacherId)?.name || 'Unknown';
            batch.set(getDocRef('examDuties', dutyId), { 
                id: dutyId, examId, date, session: 'AN', roomId, 
                dutyTeacherId: anTeacherId, dutyTeacherName: teacherName 
            });
        }
    });

    try {
        // 4. Commit all changes to the database in one operation
        await batch.commit();
        showAlert('Duty assignments for this day have been saved successfully!', 'success');
        
        // Refresh the consolidation stats to reflect the changes
        displayDutyConsolidation(examId);

    } catch (error) {
        console.error("Error saving duties:", error);
        showAlert('Failed to save duty assignments. See console for details.', 'danger');
    }
};

window.clearDutiesFromUI = function(examId, date) {
    if (!confirm(`This will clear all unsaved assignments from the screen. It will not affect saved data. Continue?`)) return;
    document.querySelectorAll('#duty-assignment-table .duty-teacher-select').forEach(select => {
        select.value = '';
    });
    //displayDutyAssignmentGrid(examId, date);
};


function renderExamControlHallTicketTab() {
    const container = document.getElementById('exam-control-hall-ticket');
    if (!container) return;

    const classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

    container.innerHTML = `
        <div class="ui-card mb-4">
            <h5 class="section-header">Generate Hall Tickets</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label" for="hall-ticket-exam-select">Select Exam</label>
                    <select id="hall-ticket-exam-select" class="form-select">
                        <option value="">-- Select Exam --</option>
                        ${exams.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="hall-ticket-class-select">Select Class</label>
                    <select id="hall-ticket-class-select" class="form-select">
                        <option value="">-- Select Class --</option>
                        ${classOptions}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="hall-ticket-division-select">Select Division</label>
                    <select id="hall-ticket-division-select" class="form-select" disabled>
                        <option value="">-- Select Division --</option>
                    </select>
                </div>
                <div class="col-md-3 d-grid">
                    <button id="generate-all-hall-tickets-btn" class="btn btn-primary" disabled>Generate All Hall Tickets</button>
                </div>
            </div>
            <div id="hall-ticket-student-list-container" class="mt-4">
                <p class="text-muted text-center p-4">Select an exam, class and division to load students.</p>
            </div>
        </div>
        
        <div class="modal fade" id="hallTicketModal" tabindex="-1" aria-labelledby="hallTicketModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="hallTicketModalLabel">Hall Ticket Preview</h5>
                        <button type="button" class="btn-close no-print" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="hall-ticket-modal-body">
                        </div>
                    <div class="modal-footer no-print">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="print-hall-ticket-btn"><i class="fas fa-print me-2"></i>Print Hall Ticket</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    const examSelect = document.getElementById('hall-ticket-exam-select');
    const classSelect = document.getElementById('hall-ticket-class-select');
    const divisionSelect = document.getElementById('hall-ticket-division-select');
    const generateAllBtn = document.getElementById('generate-all-hall-tickets-btn');
    const studentListContainer = document.getElementById('hall-ticket-student-list-container');

    // --- NEW LOCAL VARIABLE TO STORE THE CURRENTLY DISPLAYED STUDENTS ---
    let currentStudentsForHallTicket = [];

    const loadStudentsForHallTicket = () => {
        hallTicketClassId = classSelect.value;
        hallTicketDivision = divisionSelect.value;
        hallTicketExamId = examSelect.value;

        if (hallTicketExamId && hallTicketClassId && hallTicketDivision) {
            // displayHallTicketStudentList will now return the filtered list of students
            currentStudentsForHallTicket = displayHallTicketStudentList(hallTicketExamId, hallTicketClassId, hallTicketDivision);
            generateAllBtn.disabled = (currentStudentsForHallTicket.length === 0); // Disable if no students found
        } else {
            studentListContainer.innerHTML = `<p class="text-muted text-center p-4">Select an exam, class and division to load students.</p>`;
            generateAllBtn.disabled = true;
            currentStudentsForHallTicket = []; // Clear student list
        }
    };

    examSelect.addEventListener('change', loadStudentsForHallTicket);

    classSelect.addEventListener('change', () => {
        const selectedClass = classes.find(c => c.id === classSelect.value);
        divisionSelect.innerHTML = '<option value="">-- Select Division --</option>';
        if (selectedClass) {
            divisionSelect.disabled = false;
            selectedClass.divisions.forEach(d => {
                const option = document.createElement('option');
                option.value = d;
                option.textContent = d;
                divisionSelect.appendChild(option);
            });
        } else {
            divisionSelect.disabled = true;
        }
        loadStudentsForHallTicket();
    });

    divisionSelect.addEventListener('change', loadStudentsForHallTicket);

    generateAllBtn.addEventListener('click', () => {
        if (currentStudentsForHallTicket.length === 0) {
            showAlert('No students found for generating hall tickets for the selected exam, class, and division.', 'info');
            return;
        }

        let allHallTicketsHtml = '';
        currentStudentsForHallTicket.forEach(student => { // Iterate through the stored list
            allHallTicketsHtml += generateSingleHallTicketHTML(student.id, hallTicketExamId);
        });

        const printWindow = window.open('', '_blank');
        if (!printWindow) { showAlert('Please allow pop-ups to generate and print.', 'warning'); return; }
        printWindow.document.write(`
            <!DOCTYPE html><html><head><title>All Hall Tickets</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
                /* The .hall-ticket-page ensures each ticket is a logical "page" for print */
                
                .hall-ticket-page:last-child { page-break-after: avoid; } /* No break after last one */
                @media print {
                    .hall-ticket-page {
                        border: none !important;
                        margin: 0 !important;
                        padding: .5cm !important;
                        box-shadow: none !important;
                        width: 210mm; /* A4 width */
                        min-height: 297mm; /* A4 height */
                        page-break-after: always !important; /* Don't force break after single ticket in modal print */
                        
                    }
                    /* Ensure headers/footers/logos print correctly */
                    img, h1, h2, h3, h4, h5, p, table, hr {
                        -webkit-print-color-adjust: exact !important;
                        print-color-adjust: exact !important;
                    }
                }
            </style>
            </head><body>
            ${allHallTicketsHtml}
            </body></html>
        `);
       // printWindow.document.close();
        printWindow.focus();
        // setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
    });

    document.getElementById('print-hall-ticket-btn')?.addEventListener('click', () => {
        const modalBody = document.getElementById('hall-ticket-modal-body');
        if (modalBody) {
            printContentOfDiv('hall-ticket-modal-body', 'Hall Ticket', {
                pageSize: 'A4 portrait',
                pageMargins: '0.5cm',
                extraCss: `
                    .modal-body { overflow: visible !important; }
                    .hall-ticket-content { width: 100%; height: auto; margin: 0; padding: 0; }
                    .hall-ticket-page { /* For individual print from modal, treat the content as a single page */
                        min-width: 210mm; 
                        min-height: 297mm; 
                        padding: .5cm;
                        box-sizing: border-box;
                        page-break-after: always !important; /* Don't force break after single ticket in modal print */
                        border: none !important;
                        margin: 0 !important;
                        box-shadow: none !important;
                    }
                    .tabledetails table,
.tabledetails table th,
.tabledetails table td {
    border: none !important;
}

                `
            });
        }
    });
}


/**
 * Renders the Examination Control Reports tab content.
 */
/**
 * Renders the main UI for the Examination Reports tab with specific report sections.
 */
/**
 * Renders the UI for the Examination Reports tab with an improved layout.
 */
function renderExamControlReportsTab() {
    const container = document.getElementById('exam-control-reports');
    if (!container) return;

    // The classOptions are now removed from here, as they will be populated dynamically.
    container.innerHTML = `
        <div class="ui-card mb-4">
            <h5 class="section-header">Report Filters</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-4"><label class="form-label">Exam</label><select id="report-exam-select" class="form-select"><option value="">-- Select --</option>        ${exams
            .filter(e => e.isActive) // This line only keeps active exams
            .map(e => `<option value="${e.id}">${e.name}</option>`)
            .join('')}</select></div>
                <div class="col-md-4"><label class="form-label">Date</label><select id="report-date-select" class="form-select" disabled><option>-- Select Exam --</option></select></div>
                <div class="col-md-4"><label class="form-label">Session</label><select id="report-session-select" class="form-select"><option value="FN">Forenoon</option><option value="AN">Afternoon</option></select></div>
            </div>
        </div>
        
        <div class="ui-card">
            <h5 class="section-header">Available Reports</h5>
            <div class="list-group">
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">Full Day Duty Report</h6>
                        <button id="print-full-day-duty-report-btn" class="btn btn-sm btn-outline-primary">Generate</button>
                    </div>
                    <p class="mb-1 small text-muted">A complete list of room duties and allocations for the selected date.</p>
                </div>

                <div class="list-group-item">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h6 class="mb-1">Class Seating Summary</h6>
                            <p class="mb-1 small text-muted">A gender-separated summary of which rooms selected classes are in.</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small">Select Class(es) with Scheduled Exams</label>
                            <select id="report-class-select" class="form-select form-select-sm" multiple size="5" disabled></select>
                        </div>
                        <div class="col-md-2 d-grid">
                            <button id="print-class-summary-btn" class="btn btn-sm btn-primary">Generate</button>
                        </div>
                    </div>
                </div>

                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                         <h6 class="mb-1">Exam Room Labels (4 per page)</h6>
                         <button id="print-room-labels-btn" class="btn btn-sm btn-outline-info">Generate</button>
                     </div>
                     <p class="mb-1 small text-muted">Print labels for each exam room door for the selected session.</p>
                 </div>
                 <div class="list-group-item">
                     <div class="d-flex w-100 justify-content-between">
                         <h6 class="mb-1">Question Paper Bundle Labels</h6>
                         <button id="print-qp-labels-btn" class="btn btn-sm btn-outline-dark">Generate</button>
                     </div>
                    <p class="mb-1 small text-muted">Labels for QP bundles with class, subject, and medium counts for the selected session.</p>
                 </div>
            </div>
        </div>
    `;
    
    attachReportsTabListeners();
}


/**
 * Attaches event listeners and handles dynamic population of the class filter.
 */
function attachReportsTabListeners() {
    const examSelect = document.getElementById('report-exam-select');
    const dateSelect = document.getElementById('report-date-select');
    const classSelect = document.getElementById('report-class-select');
    
    // --- NEW: Helper function to update the class filter ---
    const updateClassFilter = () => {
        const examId = examSelect.value;
        const date = dateSelect.value;
        classSelect.innerHTML = ''; // Clear existing options

        if (examId && date) {
            // 1. Find schedules for the selected exam and date.
            const schedulesForDay = examSchedules.filter(s => s.examId === examId && s.date === date);
            // 2. Get a unique list of class IDs from those schedules.
            const classIdsWithExams = [...new Set(schedulesForDay.map(s => s.classId))];
            
            // 3. Populate the dropdown with only those classes, and select them by default.
            classIdsWithExams.forEach(classId => {
                const classData = classes.find(c => c.id === classId);
                if (classData) {
                    classSelect.innerHTML += `<option value="${classData.id}" selected>${classData.name}</option>`;
                }
            });
            classSelect.disabled = false;
        } else {
            classSelect.disabled = true;
        }
    };

    // When the user selects an exam, update the date dropdown
    examSelect.addEventListener('change', () => {
        const examId = examSelect.value;
        dateSelect.innerHTML = '<option value="">-- Select Date --</option>';
        if (examId) {
            const uniqueDates = [...new Set(examSchedules.filter(s => s.examId === examId).map(s => s.date))].sort();
            uniqueDates.forEach(date => dateSelect.innerHTML += `<option value="${date}">${new Date(date).toLocaleDateString('en-GB')}</option>`);
            dateSelect.disabled = false;
        } else {
            dateSelect.disabled = true;
        }
        // After updating dates, also update the class filter
        updateClassFilter();
    });

    // When the date changes, update the class filter
    dateSelect.addEventListener('change', updateClassFilter);

    // --- Button Listeners ---
    document.getElementById('print-full-day-duty-report-btn').addEventListener('click', () => {
        generateAndPrintDutyReport(examSelect.value, dateSelect.value);
    });
    
    document.getElementById('print-class-summary-btn').addEventListener('click', () => {
        const selectedClassIds = Array.from(classSelect.selectedOptions).map(opt => opt.value);
        const session = document.getElementById('report-session-select').value;
        generateClassSeatingSummary(examSelect.value, dateSelect.value, selectedClassIds, session);
    });

    document.getElementById('print-room-labels-btn').addEventListener('click', () => {
        const session = document.getElementById('report-session-select').value;
        generateExamRoomLabels(examSelect.value, dateSelect.value, session);
    });

    document.getElementById('print-qp-labels-btn').addEventListener('click', () => {
        const session = document.getElementById('report-session-select').value;
        generateQuestionPaperLabels(examSelect.value, dateSelect.value, session);
    });
}

/**
 * REPORT 4: Generates enhanced printable labels for question paper bundles.
 */
/**
 * Generates enhanced, professional labels for Question Paper bundles.
 * - Groups students by Class and Subject.
 * - Creates dynamic columns for each Instruction Medium.
 * - Shows registration number ranges for each class.
 * - Includes the Duty Teacher's name.
 * - NEW: Adds an empty column for handwriting absentee registration numbers.
 * @param {string} examId
 * @param {string} date
 * @param {string} session
 */
function generateQuestionPaperLabels(examId, date, session) {
    if (!examId || !date || !session) return showAlert('Please select Exam, Date, and Session.', 'danger');
    
    const sessionKey = `${examId}_${date.replace(/-/g, '')}_${session}`;
    const studentsWithAllocation = students.filter(s => s.examRoomAllocations?.[sessionKey]);
    if (studentsWithAllocation.length === 0) return showAlert('No students allocated to generate QP labels.', 'info');

    const dataByRoom = studentsWithAllocation.reduce((acc, student) => {
        const roomId = student.examRoomAllocations[sessionKey];
        if (!acc[roomId]) {
            acc[roomId] = { 
                room: examRooms.find(r => r.id === roomId), 
                students: [],
                duty: examDuties.find(d => d.examId === examId && d.date === date && d.session === session && d.roomId === roomId)
            };
        }
        acc[roomId].students.push(student);
        return acc;
    }, {});

    const contentHtml = Object.values(dataByRoom).map(data => {
        // --- 1. Advanced Grouping Logic ---
        const countsByClassAndSubject = data.students.reduce((acc, s) => {
            const schedule = examSchedules.find(sch => sch.examId === examId && sch.date === date && sch.session === session && sch.classId === s.classId && sch.division === s.division);
            if (!schedule) return acc;
            
            const subjectId = schedule.subjectId;
            const classId = s.classId;
            const key = `${classId}_${subjectId}`;
            
            const specialMediumClasses = new Set(['2025-2026_VIII_C', '2025-2026_IX_B', '2025-2026_X_C']);
            const studentClassKey = `${s.classId}_${s.division}`;
            const medium = specialMediumClasses.has(studentClassKey) ? 'Malayalam' : ('English');

            if (!acc[key]) {
                acc[key] = {
                    className: classes.find(c => c.id === classId)?.name,
                    subjectName: subjects.find(sub => sub.id === subjectId)?.name,
                    regNos: [],
                    mediums: {}
                };
            }

            if (!acc[key].mediums[medium]) {
                acc[key].mediums[medium] = { M: 0, F: 0, Total: 0 };
            }
            
            acc[key].regNos.push(s.examRegNumbers?.[examId]);
            acc[key].mediums[medium][s.gender]++;
            acc[key].mediums[medium].Total++;
            return acc;
        }, {});

        // --- 2. Build the Dynamic Table ---
        const allMediumsInRoom = [...new Set(Object.values(countsByClassAndSubject).flatMap(c => Object.keys(c.mediums)))].sort();
        const mediumHeaderHtml = allMediumsInRoom.map(m => `<th colspan="3" class="text-center">${m}</th>`).join('');
        const subHeaderHtml = allMediumsInRoom.map(() => `<th>M</th><th>F</th><th>Total</th>`).join('');

        const tableBodyHtml = Object.values(countsByClassAndSubject).map(data => {
            const regNoSummary = generateCompactRegNoRanges(data.regNos.filter(Boolean));
            const classDisplay = `${data.className}<br><small class="text-bold">${regNoSummary}</small>`;
            
            const mediumCellsHtml = allMediumsInRoom.map(medium => {
                const mediumData = data.mediums[medium];
                if (mediumData) {
                    return `<td>${mediumData.M}</td><td>${mediumData.F}</td><td><b>${mediumData.Total}</b></td>`;
                }
                return `<td>0</td><td>0</td><td><b>0</b></td>`;
            }).join('');

            return `<tr><td>${classDisplay}</td><td>${data.subjectName}</td>${mediumCellsHtml}<td></td></tr>`;
        }).join('');

        const dutyTeacherName = data.duty?.dutyTeacherName || 'Not Assigned';
        
        return `
            <div class="qp-label">
                <h6>${exams.find(e=>e.id===examId).name} - ${new Date(date).toLocaleDateString('en-GB')} (${session})</h6>
                <div class="d-flex justify-content-between align-items-center">
                    <h5>ROOM: ${data.room?.name || 'N/A'}</h5>
                    <span class="small"><strong>Duty:</strong> ${dutyTeacherName}</span>
                </div>
                <table class="table table-sm table-bordered">
                    <thead style="font-size: 0.7em;">
                        <tr>
                            <th rowspan="2" class="align-middle">Class & Reg. Nos</th>
                            <th rowspan="2" class="align-middle">Subject</th>
                            ${mediumHeaderHtml}
                            <th rowspan="2" class="align-middle">Absentees (Reg. No.)</th>
                        </tr>
                        <tr>${subHeaderHtml}</tr>
                    </thead>
                    <tbody style="font-size: 0.7em;">${tableBodyHtml}</tbody>
                </table>
                <p class="total-count"><strong>Total Question Papers: ${data.students.length}</strong></p>
            </div>`;
    }).join('');

    const extraCss = `
        .qp-label { width: 100%; padding: 15px; border: 1px dashed black; box-sizing: border-box; page-break-inside: avoid; margin-bottom: 15px; }
        .qp-label h5 { font-size: 1.2rem; } .total-count { text-align: right; font-size: 1rem; margin-top: 10px; }
    `;
    printReport({ contentHtml, title: 'Question Paper Labels', extraCss, pageSize: 'A4' });
}

/**
 * Generates a notice board summary for multiple classes in a clean, consolidated
 * table format, showing FN and AN allocations side-by-side for each rule.
 * @param {string} examId
 * @param {string} date
 * @param {Array<string>} classIds - An array of selected class IDs.
 */
/**
 * Generates a notice board summary for multiple classes for a single session,
 * creating separate tables for Boys and Girls based on registration number prefixes.
 * @param {string} examId
 * @param {string} date
 * @param {Array<string>} classIds - An array of selected class IDs.
 * @param {string} session - The selected session ('FN' or 'AN').
 */
function generateClassSeatingSummary(examId, date, classIds, session) {
    if (!examId || !date || !classIds || classIds.length === 0 || !session) {
        return showAlert('Please select an Exam, Date, Session, and at least one Class.', 'danger');
    }

    let combinedHtml = '';

    classIds.forEach(classId => {
        const className = classes.find(c => c.id === classId)?.name || classId;
        const sessionKey = `${examId}_${date.replace(/-/g, '')}_${session}`;
        
        // Find all rules for this specific session
        const rulesForSession = examRoomAllocationRules.filter(rule => 
            rule.examId === examId && rule.date === date && rule.session === session
        );

        const genderGroups = { M: [], F: [] }; // To hold rules for Boys (M) and Girls (F)

        rulesForSession.forEach(rule => {
            const regNoRegex = /^([A-Z0-9]+)_(\d+)$/;
            const affectedRegNos = new Set();
            const rangeParts = (rule.regNoRangeText || '').split('-').map(p => p.trim());
            const startMatch = rangeParts[0].match(regNoRegex);
            const endMatch = (rangeParts[1] || rangeParts[0]).match(regNoRegex);

            if (startMatch && endMatch && startMatch[1] === endMatch[1]) {
                const prefix = startMatch[1];
                for (let i = parseInt(startMatch[2]); i <= parseInt(endMatch[2]); i++) {
                    affectedRegNos.add(`${prefix}_${i.toString().padStart(3, '0')}`);
                }
            }
            
            // Count only students from the current classId that match the rule's reg numbers
            const studentCount = students.filter(s => 
                s.classId === classId && 
                affectedRegNos.has(s.examRegNumbers?.[examId]) &&
                s.examRoomAllocations?.[sessionKey] === rule.roomId
            ).length;

            if (studentCount > 0) {
                const genderPrefix = (startMatch[1] || '').charAt(0).toUpperCase();
                if (genderPrefix === 'M' || genderPrefix === 'F') {
                    genderGroups[genderPrefix].push({
                        range: rule.regNoRangeText,
                        room: examRooms.find(r => r.id === rule.roomId)?.name || rule.roomId,
                        count: studentCount
                    });
                }
            }
        });

        // Function to build a table for a specific gender
        const buildGenderTable = (gender, rules) => {
            if (rules.length === 0) return '';
            rules.sort((a, b) => a.range.localeCompare(b.range, undefined, { numeric: true }));
            return `
                <h6 class="mt-3">${gender}</h6>
                <table class="table table-sm table-bordered" style="font-size: 1.85em;">
                    <thead class="table-light"><tr><th>Reg. No. Range</th><th>Exam Room</th><th class="text-center">Count</th></tr></thead>
                    <tbody>${rules.map(r => `<tr><td>${r.range}</td><td>${r.room}</td><td class="text-center">${r.count}</td></tr>`).join('')}</tbody>
                </table>`;
        };
        
        const boysTable = buildGenderTable('Boys', genderGroups.M);
        const girlsTable = buildGenderTable('Girls', genderGroups.F);

        if (boysTable || girlsTable) {
            combinedHtml += `
                <div class="class-summary-section">
                    <div class="class-summary-section2">
                    <h4 class="class-title">${className}</h4>
                    <div class="column class-summary-section2">
                        <div class="border-end pe-4">${boysTable || '<p class="text-muted">No boys allocated.</p>'}</div>
                        <div class="ps-4">${girlsTable || '<p class="text-muted">No girls allocated.</p>'}</div>
                    </div>
                    </div>
                </div>`;
        }
    });

    if (combinedHtml === '') {
        return showAlert('No applicable allocation rules found for the selected class(es).', 'info');
    }

    const reportTitle = `Seating Arrangement Summary`;
    const subTitle = `Exam: ${exams.find(e => e.id === examId).name} | Date: ${new Date(date).toLocaleDateString('en-GB')} | Session: ${session}`;
    const customHeaderHtml = `<div class='text-center'><h3>${reportTitle}</h3><p class="text-muted">${subTitle}</p></div>`;
    const extraCss = `.class-summary-section2 { margin-top: 20px; page-break-inside: avoid; } .class-title { text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee; }`;

    printReport({ contentHtml: combinedHtml, title: reportTitle, customHeaderHtml, extraCss });
}
/**
 * REPORT 3: Generates printable labels for exam room doors (4 per page).
 */
function generateExamRoomLabels(examId, date, session) {
    if (!examId || !date || !session) return showAlert('Please select Exam, Date, and Session.', 'danger');
    const sessionKey = `${examId}_${date.replace(/-/g, '')}_${session}`;
    const studentsWithAllocation = students.filter(s => s.examRoomAllocations?.[sessionKey]);
    if (studentsWithAllocation.length === 0) return showAlert('No students allocated to generate room labels.', 'info');

    const dataByRoom = studentsWithAllocation.reduce((acc, student) => {
        const roomId = student.examRoomAllocations[sessionKey];
        if (!acc[roomId]) acc[roomId] = { room: examRooms.find(r => r.id === roomId), duty: examDuties.find(d => d.roomId === roomId && d.date === date && d.session === session), students: [] };
        acc[roomId].students.push(student);
        return acc;
    }, {});

    const contentHtml = Object.values(dataByRoom).map(data => {
        const regNos = data.students.map(s => s.examRegNumbers?.[examId]).filter(Boolean);
        const regNoSummary = generateCompactRegNoRanges(regNos);
        const classSummary = [...new Set(data.students.map(s => classes.find(c=>c.id===s.classId)?.name))].join(', ');

        return `<div class="room-label">
                    <h5 class="text-center">${schoolDetails.name}</h5>
                    <p class="text-center small mb-2">${exams.find(e=>e.id===examId).name} - ${new Date(date).toLocaleDateString('en-GB')} (${session})</p>
                    <hr class="my-1">
                    <h3 class="text-center my-3">ROOM: ${data.room?.name || 'N/A'}</h3>
                    <p><strong>Classes:</strong> ${classSummary}</p>
                    <p><strong>Registration Nos:</strong></p>
                    <p class="reg-no-summary">${regNoSummary}</p>
                    <p><strong>Total Students:</strong> ${data.students.length}</p>
                    <hr class="my-1">
                    <p><strong>Duty Teacher:</strong> ${data.duty?.dutyTeacherName || 'Not Assigned'}</p>
                </div>`;
    }).join('');

    const extraCss = `.room-label { width: 48%; height: 48%; float: left; margin: 1%; padding: 15px; border: 2px solid black; box-sizing: border-box; page-break-inside: avoid; overflow: hidden; } .reg-no-summary { font-size: 0.85em; font-weight: bold; }`;
    printReport({ contentHtml, title: 'Exam Room Labels', extraCss, pageSize: 'A4 portrait' });
}


/**
 * Generates and prints a summary report of allocation RULES and their student counts.
 * @param {string} examId
 * @param {string} date
 * @param {string} session
 */
function generateAndPrintRuleSummaryReport(examId, date, session) {
    if (!examId || !date || !session) {
        showAlert('Please select Exam, Date, and Session to generate the report.', 'danger');
        return;
    }

    // 1. Find all rules for the selected session
    const rulesForSession = examRoomAllocationRules.filter(rule =>
        rule.examId === examId && rule.date === date && rule.session === session
    ).sort((a, b) => (examRooms.find(r => r.id === a.roomId)?.name || '').localeCompare(examRooms.find(r => r.id === b.roomId)?.name || ''));

    if (rulesForSession.length === 0) {
        showAlert('No allocation rules found for this session.', 'info');
        return;
    }

    const examName = exams.find(e => e.id === examId)?.name || examId;
    const reportTitle = `Room Allocation Summary: ${examName}`;
    const subTitle = `Date: ${new Date(date).toLocaleDateString('en-GB', { dateStyle: 'long' })} | Session: ${session === 'FN' ? 'Forenoon' : 'Afternoon'}`;

    let tableRowsHtml = '';

    // 2. For each rule, calculate the ACTUAL number of students it allocated
    rulesForSession.forEach(rule => {
        const regNoRegex = /^([A-Z0-9]+)_(\d+)$/;
        const affectedRegNos = new Set();
        const lines = (rule.regNoRangeText || '').split('\n').map(line => line.trim()).filter(Boolean);

        lines.forEach(line => {
            const rangeParts = line.split('-').map(p => p.trim());
            const startMatch = rangeParts[0].match(regNoRegex);
            const endMatch = (rangeParts[1] || rangeParts[0]).match(regNoRegex);
            if (startMatch && endMatch && startMatch[1] === endMatch[1]) {
                const prefix = startMatch[1];
                for (let i = parseInt(startMatch[2]); i <= parseInt(endMatch[2]); i++) {
                    affectedRegNos.add(`${prefix}_${i.toString().padStart(3, '0')}`);
                }
            }
        });

        // Cross-reference with the main students list to get an accurate count
        const studentCount = students.filter(s => affectedRegNos.has(s.examRegNumbers?.[examId])).length;
        const roomName = examRooms.find(r => r.id === rule.roomId)?.name || rule.roomId;

        tableRowsHtml += `
            <tr>
                <td>${roomName}</td>
                <td>${rule.regNoRangeText.replace(/\n/g, ', ')}</td>
                <td class="text-center fw-bold">${studentCount}</td>
            </tr>
        `;
    });
    
    // 3. Build the final HTML for printing
    const reportHtml = `
        <table class="table table-bordered table-sm">
            <thead class="table-light">
                <tr>
                    <th>Room</th>
                    <th>Allocation Rule (Reg. No. Range)</th>
                    <th class="text-center">Student Count</th>
                </tr>
            </thead>
            <tbody>
                ${tableRowsHtml}
            </tbody>
        </table>
    `;

    const customHeader = `
        <div style="text-align: center; margin-bottom: 20px;">
            <h3>${schoolDetails.name || 'School Name'}</h3>
            <h4>${reportTitle}</h4>
            <p>${subTitle}</p>
        </div>
    `;

    const tempDiv = document.createElement('div');
    tempDiv.id = 'temp-rule-summary-report';
    tempDiv.innerHTML = reportHtml;
    document.body.appendChild(tempDiv);
    
    printContentOfDiv('temp-rule-summary-report', reportTitle, {
        customHeaderHtml: customHeader,
        pageSize: 'A4 portrait',
    });
    
    document.body.removeChild(tempDiv);
}
/**
 * Generates a flexible seating plan summary, grouped by either Room or Class.
 * @param {string} examId
 * @param {string} date
 * @param {string} reportType - 'room' or 'class'
 * @param {string} [classIdFilter] - Optional class ID to filter by when grouping by class.
 */
function generateAndPrintSeatingPlanSummary(examId, date, reportType, classIdFilter) {
    if (!examId || !date) {
        showAlert('Please select an Exam and Date.', 'danger');
        return;
    }

    // 1. Get all students allocated for ANY session on the selected date and sort them by Reg. No.
    const allStudentsForDate = students.filter(s => 
        Object.keys(s.examRoomAllocations || {}).some(key => key.startsWith(`${examId}_${date.replace(/-/g, '')}`))
    ).sort((a, b) => {
        const regNoA = a.examRegNumbers?.[examId] || '';
        const regNoB = b.examRegNumbers?.[examId] || '';
        return regNoA.localeCompare(regNoB, undefined, { numeric: true });
    });

    if (allStudentsForDate.length === 0) {
        showAlert('No students have been allocated to rooms for this date.', 'info');
        return;
    }

    let reportHtml = '';
    const examName = exams.find(e => e.id === examId)?.name || examId;
    let reportTitle = `Seating Plan: ${examName}`;
    let subTitle = `Date: ${new Date(date).toLocaleDateString('en-GB', { dateStyle: 'long' })}`;

    // --- LOGIC FOR GROUPING BY ROOM ---
    if (reportType === 'room') {
        const dataByRoom = {};
        allStudentsForDate.forEach(student => {
            const fnRoomId = student.examRoomAllocations[`${examId}_${date.replace(/-/g, '')}_FN`];
            const anRoomId = student.examRoomAllocations[`${examId}_${date.replace(/-/g, '')}_AN`];
            
            // Add student to FN room data
            if (fnRoomId) {
                if (!dataByRoom[fnRoomId]) dataByRoom[fnRoomId] = { roomName: examRooms.find(r => r.id === fnRoomId)?.name || fnRoomId, studentsFN: [], studentsAN: [] };
                dataByRoom[fnRoomId].studentsFN.push(student);
            }
            // Add student to AN room data
            if (anRoomId) {
                if (!dataByRoom[anRoomId]) dataByRoom[anRoomId] = { roomName: examRooms.find(r => r.id === anRoomId)?.name || anRoomId, studentsFN: [], studentsAN: [] };
                dataByRoom[anRoomId].studentsAN.push(student);
            }
        });
        
        Object.keys(dataByRoom).sort((a,b) => dataByRoom[a].roomName.localeCompare(dataByRoom[b].roomName)).forEach(roomId => {
            const roomData = dataByRoom[roomId];
            reportHtml += `<div class="room-summary-item">
                <h5 class="section-header">${roomData.roomName}</h5>
                <div class="row">
                    <div class="col-6"><h6>Forenoon (FN) - Total: ${roomData.studentsFN.length}</h6>${renderStudentListTable(roomData.studentsFN, examId, date, 'FN')}</div>
                    <div class="col-6"><h6>Afternoon (AN) - Total: ${roomData.studentsAN.length}</h6>${renderStudentListTable(roomData.studentsAN, examId, date, 'AN')}</div>
                </div>
            </div>`;
        });

    // --- LOGIC FOR GROUPING BY CLASS ---
    } else if (reportType === 'class') {
        if (!classIdFilter) {
            showAlert('Please select a class to generate this report.', 'warning');
            return;
        }
        const studentsInClass = allStudentsForDate.filter(s => s.classId === classIdFilter&&s.status!== 'TC Issued');
        const className = classes.find(c => c.id === classIdFilter)?.name || classIdFilter;
        subTitle += ` | Class: ${className}`;

        const dataByDivision = {};
        studentsInClass.forEach(student => {
            if (!dataByDivision[student.division]) dataByDivision[student.division] = [];
            dataByDivision[student.division].push(student);
        });

        Object.keys(dataByDivision).sort().forEach(division => {
            reportHtml += `<div class="room-summary-item">
                <h5 class="section-header">Division: ${division}</h5>
                <div class="row">
                    <div class="col-6"><h6>Forenoon (FN) Seating</h6>${renderStudentListTable(dataByDivision[division], examId, date, 'FN', true)}</div>
                    <div class="col-6"><h6>Afternoon (AN) Seating</h6>${renderStudentListTable(dataByDivision[division], examId, date, 'AN', true)}</div>
                </div>
            </div>`;
        });
    }

    const customHeader = `... (your existing customHeaderHtml logic) ...`;
    const tempDiv = document.createElement('div');
    tempDiv.id = 'temp-seating-plan';
    tempDiv.innerHTML = reportHtml;
    document.body.appendChild(tempDiv);
    printContentOfDiv('temp-seating-plan', reportTitle, { /* your print options */ });
    document.body.removeChild(tempDiv);
}

/**
 * A robust, centralized function for printing HTML content in a new window.
 * Handles custom headers, styles, and waits for content to load before printing.
 * @param {object} options - The printing options.
 * @param {string} options.contentHtml - The HTML string of the main content to print.
 * @param {string} options.title - The title of the document.
 * @param {string} [options.customHeaderHtml=''] - Optional HTML for a header.
 * @param {string} [options.extraCss=''] - Optional additional CSS styles.
 * @param {string} [options.pageSize='A4 portrait'] - Page size and orientation.
 */
function printReport({ contentHtml, title, customHeaderHtml = '', extraCss = '', pageSize = 'A4 portrait' }) {
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
        showAlert('Please allow pop-ups to generate reports.', 'warning');
        return;
    }

    printWindow.document.write(`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${title}</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
            <style>
                body { 
                    font-family: 'Inter', sans-serif; 
                    margin: 0;
                }
                @page {
                    size: ${pageSize};
                    margin: 0.5cm;
                }
                @media print {
                    body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                    .no-print { display: none !important; }
                    .hall-ticket-page, .room-summary-item, .qp-label, .room-label {
                        page-break-inside: avoid;
                    }
                }
                ${extraCss}
            </style>
        </head>
        <body>
            ${customHeaderHtml ? `<header>${customHeaderHtml}</header>` : ''}
            <main>${contentHtml}</main>
        </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.onload = function() {
        printWindow.focus();
    };
}
/**
 * A robust, centralized function for generating a PDF with professional tables
 * using jsPDF and the jsPDF-AutoTable plugin.
 * @param {object} options - The printing options.
 * @param {string} options.tableHtml - An HTML string containing the <table> to be printed.
 * @param {string} options.title - The title for the downloaded PDF file.
 * @param {string} [options.customHeaderHtml=''] - Optional HTML for a header.
 * @param {string} [options.pageSize='A4 portrait'] - Page size and orientation.
 */
async function printReporttab({ tableHtml, title, customHeaderHtml = '', pageSize = 'A4 portrait' }) {
    showAlert('Generating PDF... please wait.', 'info');

    const { jsPDF } = window.jspdf;
    const orientation = pageSize.includes('landscape') ? 'l' : 'p';
    const doc = new jsPDF(orientation, 'mm', 'a4');

    // Create a temporary, off-screen div to parse the HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = tableHtml;
    const table = tempDiv.querySelector('table');
    if (!table) {
        showAlert('No table found in the content to generate a PDF.', 'danger');
        return;
    }

    // --- Header ---
    if (customHeaderHtml) {
        const headerDiv = document.createElement('div');
        headerDiv.innerHTML = customHeaderHtml;
        // You can add more complex header rendering here if needed
        doc.html(headerDiv, {
            callback: function(doc) {
                // Once the header is rendered, add the table
                addTableToPdf(doc, table, title);
            },
            x: 10,
            y: 10
        });
    } else {
        addTableToPdf(doc, table, title);
    }
}

/**
 * Helper function to parse an HTML table and add it to a jsPDF document.
 */
function addTableToPdf(doc, tableElement, title) {
    // Extract headers and body from the HTML table
    const head = Array.from(tableElement.querySelectorAll('thead tr')).map(row => 
        Array.from(row.cells).map(cell => cell.innerText)
    );
    const body = Array.from(tableElement.querySelectorAll('tbody tr')).map(row => 
        Array.from(row.cells).map(cell => cell.innerText)
    );

    doc.autoTable({
        head: head,
        body: body,
        startY: doc.autoTable.previous.finalY ? doc.autoTable.previous.finalY + 10 : 25,
        theme: 'grid',
        styles: {
            fontSize: 8,
            cellPadding: 2,
        },
        headStyles: {
            fillColor: [22, 160, 133], // A professional green
            textColor: 255,
            fontStyle: 'bold'
        }
    });

    // Save the PDF
    doc.save(`${title.replace(/\s+/g, '_')}.pdf`);
    showAlert('PDF generated successfully!', 'success');
}
/**
 * A robust, centralized function for generating a PDF from HTML content.
 * It intelligently uses jsPDF-AutoTable for reports containing tables,
 * and falls back to html2canvas for non-tabular content like labels.
 *
 * @param {object} options - The printing options.
 * @param {string} options.contentHtml - The HTML string of the main content to print.
 * @param {string} options.title - The title for the downloaded PDF file.
 * @param {string} [options.customHeaderHtml=''] - Optional HTML for a header.
 * @param {string} [options.extraCss=''] - Optional additional CSS styles for html2canvas.
 * @param {string} [options.pageSize='A4 portrait'] - Page size and orientation.
 */
async function printReportcanva({ contentHtml, title, customHeaderHtml = '', extraCss = '', pageSize = 'A4 portrait' }) {
    showAlert('Generating PDF... please wait.', 'info');

    const { jsPDF } = window.jspdf;
    const orientation = pageSize.includes('landscape') ? 'l' : 'p';
    const doc = new jsPDF(orientation, 'mm', 'a4');

    // Create a temporary, off-screen div to parse the HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = contentHtml;
    const tableElement = tempDiv.querySelector('table');

    // --- Add Header ---
    if (customHeaderHtml) {
        // We use html2canvas for the header to preserve its rich styling
        const headerDiv = document.createElement('div');
        headerDiv.style.width = orientation === 'p' ? '210mm' : '297mm';
        headerDiv.style.padding = '10mm';
        headerDiv.innerHTML = customHeaderHtml;
        document.body.appendChild(headerDiv);

        const headerCanvas = await window.html2canvas(headerDiv, { scale: 2, useCORS: true });
        const headerImgData = headerCanvas.toDataURL('image/png');
        const headerImgWidth = doc.internal.pageSize.getWidth() - 20; // with margin
        const headerImgHeight = (headerCanvas.height * headerImgWidth) / headerCanvas.width;
        doc.addImage(headerImgData, 'PNG', 10, 10, headerImgWidth, headerImgHeight);
        
        document.body.removeChild(headerDiv);
        doc.autoTableSetDefaults({ startY: headerImgHeight + 15 });
    } else {
        doc.autoTableSetDefaults({ startY: 15 });
    }


    // --- INTELLIGENTLY CHOOSE THE RENDERING METHOD ---

    if (tableElement) {
        // METHOD 1: If a table is found, use jsPDF-AutoTable for a clean, high-quality result.
        console.log("Table detected. Generating PDF with jsPDF-AutoTable.");
        
        doc.autoTable({
            html: tableElement,
            theme: 'grid',
            styles: { fontSize: 8, cellPadding: 2 },
            headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' }
        });

    } else {
        // METHOD 2: If no table is found, use html2canvas. This is perfect for labels.
        console.log("No table found. Generating PDF with html2canvas.");
        
        const contentCanvas = await window.html2canvas(tempDiv, { scale: 2, useCORS: true });
        const contentImgData = contentCanvas.toDataURL('image/png');
        const contentImgWidth = doc.internal.pageSize.getWidth() - 20;
        const contentImgHeight = (contentCanvas.height * contentImgWidth) / contentCanvas.width;
        
        doc.addImage(contentImgData, 'PNG', 10, doc.autoTable.previous.finalY || 15, contentImgWidth, contentImgHeight);
    }

    // Save the final PDF
    doc.save(`${title.replace(/\s+/g, '_')}.pdf`);
    showAlert('PDF generated successfully!', 'success');
}
/**
 * Helper function to render a table of students for the seating plan.
 * @param {Array} studentList - The list of students to render.
 * @param {string} examId
 * @param {string} date
 * @param {string} session
 * @param {boolean} [showRoom=false] - Whether to show the 'Room' column.
 * @returns {string} The HTML string for the table.
 */
function renderStudentListTable(studentList, examId, date, session, showRoom = false) {
    if (studentList.length === 0) return '<p class="text-muted small">No students allocated.</p>';
    
    const sessionKey = `${examId}_${date.replace(/-/g, '')}_${session}`;
    const males = studentList.filter(s => s.gender === 'M' && s.examRoomAllocations[sessionKey]);
    const females = studentList.filter(s => s.gender === 'F' && s.examRoomAllocations[sessionKey]);

    const createTable = (students, gender) => {
        if (students.length === 0) return '';
        return `
            <h6 class="mt-3">${gender} (${students.length})</h6>
            <table class="table table-sm table-bordered" style="font-size: 0.8em;">
                <thead><tr><th>Reg. No</th><th>Name</th>${showRoom ? '<th>Room</th>' : ''}</tr></thead>
                <tbody>
                    ${students.map(s => `
                    <tr>
                        <td>${s.examRegNumbers?.[examId] || 'N/A'}</td>
                        <td>${s.name}</td>
                        ${showRoom ? `<td>${examRooms.find(r => r.id === s.examRoomAllocations[sessionKey])?.name || 'N/A'}</td>` : ''}
                    </tr>`).join('')}
                </tbody>
            </table>`;
    };

    return createTable(males, 'Males') + createTable(females, 'Females');
}
/**
 * Generates and prints the Full Day Duty Assignment Report, showing room allocations,
 * FN/AN duties side-by-side, and signature columns, suitable for a notice board.
 * @param {string} examId - The ID of the exam.
 * @param {string} date - The date of the exam session.
 */
/**
 * Generates and prints the Full Day Duty Assignment Report with dynamic styling
 * to fit content onto an A4 page and correctly displays all allocation rules.
 * @param {string} examId - The ID of the exam.
 * @param {string} date - The date of the exam session.
 */
function generateAndPrintDutyReport(examId, date) {
    if (!examId || !date) {
        showAlert('Please select Exam and Date to generate Full Day Duty Report.', 'danger');
        return;
    }

    const examName = exams.find(e => e.id === examId)?.name || examId;
    const reportTitle = `Duty Assignment Report`;
    const reportSubTitle = `Exam: ${examName} | Date: ${new Date(date).toLocaleDateString('en-GB', { dateStyle: 'long' })}`;

    // 1. Get all duties for the specific date
    const dutiesForDate = examDuties.filter(d => d.examId === examId && d.date === date);
    
    // 2. Get all rooms that have either a duty or an allocation on this day
    const roomsInvolvedIds = new Set();
    dutiesForDate.forEach(d => roomsInvolvedIds.add(d.roomId));
    examRoomAllocationRules.filter(r => r.examId === examId && r.date === date).forEach(r => roomsInvolvedIds.add(r.roomId));

    const roomsConsolidatedData = Array.from(roomsInvolvedIds).map(roomId => {
        const room = examRooms.find(r => r.id === roomId);
        return {
            roomId: roomId,
            roomName: room?.name || roomId,
            capacity: room?.capacity || 'N/A',
            dutyFN: dutiesForDate.find(d => d.roomId === roomId && d.session === 'FN'),
            dutyAN: dutiesForDate.find(d => d.roomId === roomId && d.session === 'AN')
        };
    }).sort((a, b) => a.roomName.localeCompare(b.roomName));

    // 3. Build the report's HTML content
    const reportHtml = `
        <table class="report-table">
            <thead>
                <tr>
                    <th rowspan="2">Room</th>
                    <th rowspan="2">Cap.</th>
                    <th colspan="2">Forenoon (FN) Duty</th>
                    <th colspan="2">Afternoon (AN) Duty</th>
                  <!---  <th rowspan="2">Allocation Rules</th> --->
                </tr>
                <tr>
                    <th>Teacher</th>
                    <th>Sign</th>
                    <th>Teacher</th>
                    <th>Sign</th>
                </tr>
            </thead>
            <tbody>
                ${roomsConsolidatedData.map(room => {
                    // Find all allocation rules for each session in this room
                    const rulesFN = examRoomAllocationRules.filter(r => r.examId === examId && r.date === date && r.session === 'FN' && r.roomId === room.roomId);
                    const rulesAN = examRoomAllocationRules.filter(r => r.examId === examId && r.date === date && r.session === 'AN' && r.roomId === room.roomId);
                    
                    const fnRulesHtml = rulesFN.map(r => `<div>${r.regNoRangeText}</div>`).join('');
                    const anRulesHtml = rulesAN.map(r => `<div>${r.regNoRangeText}</div>`).join('');

                    return `
                        <tr>
                            <td>${room.roomName}</td>
                            <td class="text-center">${room.capacity}</td>
                            <td>${room.dutyFN?.dutyTeacherName || 'â€“'}</td>
                            <td class="sign-cell"></td>
                            <td>${room.dutyAN?.dutyTeacherName || 'â€“'}</td>
                            <td class="sign-cell"></td>
                             <!--- <td class="rule-cell">
                                ${fnRulesHtml ? `<strong>FN:</strong> ${fnRulesHtml}` : ''}
                                ${anRulesHtml ? `<strong>AN:</strong> ${anRulesHtml}` : ''}
                            </td> -->
                        </tr>`;
                }).join('')}
            </tbody>
        </table>
    `;

    // --- 4. DYNAMIC STYLING LOGIC ---
    const rowCount = roomsConsolidatedData.length;
    let dynamicFontSize = "0.85em";
    let dynamicPadding = "6px";

    if (rowCount > 25) { // Threshold for when to shrink content
        dynamicFontSize = "0.75em"; // Smaller font
        dynamicPadding = "4px";  // Tighter padding
    }
    
    const extraCss = `
        .report-table { width: 100%; border-collapse: collapse; }
        .report-table th, .report-table td { 
            border: 1px solid #aaa !important; 
            padding: ${dynamicPadding} !important; 
            font-size: ${dynamicFontSize} !important;
            vertical-align: middle;
        }
        .report-table thead tr { background-color: #f0f0f0; }
        .report-table th { text-align: center; }
        .sign-cell { width: 12%; }
        .rule-cell { font-size: 0.9em; text-align: left; }
    `;

    const customHeader = `
        <div style="display: flex; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 5px;">
            <div style="flex: 0 0 80px;">${schoolDetails.logoUrl ? `<img src="${schoolDetails.logoUrl}" alt="School Logo" style="max-height: 70px;">` : ''}</div>
            <div style="flex-grow: 1; text-align: center;">
                <h4 style="margin-bottom: 0px;">${schoolDetails.name || 'School Name'}</h4>
                <p style="font-size: 0.9em; margin-bottom: 0;">${schoolDetails.address || 'School Address'}</p>
            </div>
            <div style="flex: 0 0 80px;"></div>
        </div>
        <div style="text-align: center;">
            <h5 style="font-weight: bold;">${reportTitle}</h5>
            <p style="font-size: 0.85em;">${reportSubTitle}</p>
        </div>
    `;

    // Use your centralized print function
    printReport({
        contentHtml: reportHtml,
        title: 'Full_Day_Duty_Report',
        customHeaderHtml: customHeader,
        pageSize: 'A4',
        extraCss: extraCss
    });
}
/**
 * Generates and prints the Room Allocation Report, summarizing allocations by room with gender-specific registration number ranges.
 * This version is designed for a simplified notice board view, without listing individual students.
 * @param {string} examId - The ID of the exam.
 * @param {string} date - The date of the exam session.
 * @param {string} session - The session ('FN' or 'AN').
 */
function generateAndPrintRoomAllocationReport(examId, date, session) {
    if (!examId || !date || !session) {
        showAlert('Please select Exam, Date, and Session to generate Room Allocation Report.', 'danger');
        return;
    }

    const sessionKey = `${examId}_${date.replace(/-/g, '')}_${session}`;

    const studentsWithAllocation = students.filter(s => s.examRoomAllocations?.[sessionKey]);

    if (studentsWithAllocation.length === 0) {
        showAlert('No students allocated to rooms for this session.', 'info');
        return;
    }

    const examName = exams.find(e => e.id === examId)?.name || examId;
    const reportTitle = `Room Allocation Report: ${examName}`;
    const subTitle = `Date: ${new Date(date).toLocaleDateString('en-GB', { dateStyle: 'long' })} | Session: ${session === 'FN' ? 'Forenoon' : 'Afternoon'}`;

    // --- Group by Class, then Division, then Room ---
    const groupedAllocations = {}; // { classId: { division: { roomId: { students: [], rule: {} } } } }

    studentsWithAllocation.forEach(student => {
        const roomId = student.examRoomAllocations[sessionKey];
        const classId = student.classId;
        const division = student.division;

        if (!groupedAllocations[classId]) groupedAllocations[classId] = {};
        if (!groupedAllocations[classId][division]) groupedAllocations[classId][division] = {};
        if (!groupedAllocations[classId][division][roomId]) {
            groupedAllocations[classId][division][roomId] = {
                roomName: examRooms.find(r => r.id === roomId)?.name || roomId,
                students: [], // Keep students array to generate ranges from it
                maleRegNos: [],
                femaleRegNos: [],
                totalStudentsInRoom: 0
            };
        }
        groupedAllocations[classId][division][roomId].students.push(student);
    });

    let reportHtml = '';

    // Sort classes numerically (e.g., Class V before Class VI)
    const sortedClassIds = Object.keys(groupedAllocations).sort((idA, idB) => {
        const nameA = classes.find(c => c.id === idA)?.name || idA;
        const nameB = classes.find(c => c.id === idB)?.name || idB;
        const numA = parseInt(nameA.match(/\d+/)?.[0] || '0', 10);
        const numB = parseInt(nameB.match(/\d+/)?.[0] || '0', 10);
        return numA - numB;
    });

    sortedClassIds.forEach(classId => {
        const className = classes.find(c => c.id === classId)?.name || classId;
        reportHtml += `<h5 style="margin-top: 20px; margin-bottom: 10px; color: #0056b3;">Class: ${className}</h5>`;

        // Sort divisions alphabetically
        const sortedDivisions = Object.keys(groupedAllocations[classId]).sort();

        sortedDivisions.forEach(division => {
            reportHtml += `<h6 style="margin-top: 15px; margin-bottom: 8px; color: #333;">Division: ${division}</h6>`;

            // Sort rooms by name within each class-division
            const sortedRoomIds = Object.keys(groupedAllocations[classId][division]).sort((idA, idB) => {
                const roomNameA = examRooms.find(r => r.id === idA)?.name || idA;
                const roomNameB = examRooms.find(r => r.id === idB)?.name || idB;
                return roomNameA.localeCompare(roomNameB);
            });

            // Start table for this Class-Division group
            reportHtml += `
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                    <thead>
                        <tr style="background-color: #e6f7ff; border-bottom: 1px solid #aaddff;">
                            <th style="padding: 6px; text-align: left; border: 1px solid #ccc; width: 25%;">Room</th>
                            <th style="padding: 6px; text-align: left; border: 1px solid #ccc; width: 35%;">Male Reg. Nos</th>
                            <th style="padding: 6px; text-align: left; border: 1px solid #ccc; width: 35%;">Female Reg. Nos</th>
                            <th style="padding: 6px; text-align: center; border: 1px solid #ccc; width: 5%;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedRoomIds.forEach(roomId => {
                const roomData = groupedAllocations[classId][division][roomId];
                roomData.students.sort((a, b) => {
                    const regNoA = a.examRegNumbers?.[examId] || '';
                    const regNoB = b.examRegNumbers?.[examId] || '';
                    return regNoA.localeCompare(regNoB, undefined, { numeric: true });
                });

                // Separate male and female reg numbers for this room
                const maleRegNosInRoom = roomData.students.filter(s => s.gender === 'M').map(s => s.examRegNumbers?.[examId]).filter(Boolean);
                const femaleRegNosInRoom = roomData.students.filter(s => s.gender === 'F').map(s => s.examRegNumbers?.[examId]).filter(Boolean);

                const maleRangesDisplay = generateCompactRegNoRanges(maleRegNosInRoom);
                const femaleRangesDisplay = generateCompactRegNoRanges(femaleRegNosInRoom);

                reportHtml += `
                    <tr>
                        <td style="padding: 6px; border: 1px solid #ddd; font-weight: bold;">${roomData.roomName}</td>
                        <td style="padding: 6px; border: 1px solid #ddd; color: #0056b3;">${maleRangesDisplay || 'N/A'}</td>
                        <td style="padding: 6px; border: 1px solid #ddd; color: #d9534f;">${femaleRangesDisplay || 'N/A'}</td>
                        <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${roomData.students.length}</td>
                    </tr>
                `;
            });
            reportHtml += `</tbody></table>`; // Close table for this Class-Division group
        });
    });

    const customHeader = `
        <div style="text-align: center; margin-bottom: 20px;">
            ${schoolDetails.logoUrl ? `<img src="${schoolDetails.logoUrl}" alt="School Logo" style="max-height: 70px; margin-bottom: 0.5rem;">` : ''}
            <h4 style="margin-bottom: 0px; color: #333;">${schoolDetails.name || 'School Name'}</h4>
            <p style="font-size: 0.9em; color: #555; margin-bottom: 10px;">${schoolDetails.address || 'School Address'}</p>
            <hr style="border-top: 1px solid #ccc; margin: 15px auto; width: 80%;">
            <h5 style="font-weight: bold; margin-bottom: 5px; color: #0056b3;">${reportTitle}</h5>
            <p style="font-size: 0.85em; color: #666; margin: 0;">${subTitle}</p>
        </div>
    `;

    const tempDiv = document.createElement('div');
    tempDiv.id = 'temp-room-alloc-report';
    tempDiv.innerHTML = reportHtml;
    document.body.appendChild(tempDiv);

    printContentOfDiv('temp-room-alloc-report', reportTitle, {
        customHeaderHtml: customHeader,
        pageSize: 'A4 portrait',
        pageMargins: '1cm'
    });

    document.body.removeChild(tempDiv);
}

// generateCompactRegNoRanges helper function (remains unchanged, it handles the sorting internally)
/*
function generateCompactRegNoRanges(regNos) {
    // ... (your existing implementation) ...
}
*/


function generateCompactRegNoRanges(regNos) {
    if (!regNos || regNos.length === 0) return '';

    // Sort the numbers to ensure correct range generation
    regNos.sort((a, b) => {
        const parseRegNo = (reg) => {
            const parts = reg.split('_');
            return { prefix: parts[0], num: parseInt(parts[1], 10) };
        };

        const parsedA = parseRegNo(a);
        const parsedB = parseRegNo(b);

        const prefixCompare = parsedA.prefix.localeCompare(parsedB.prefix);
        if (prefixCompare !== 0) return prefixCompare;
        return parsedA.num - parsedB.num;
    });

    let ranges = [];
    let currentRangeStart = regNos[0];
    let currentRangeEnd = regNos[0];

    for (let i = 1; i < regNos.length; i++) {
        const currentPrefix = regNos[i].substring(0, regNos[i].lastIndexOf('_'));
        const currentNum = parseInt(regNos[i].substring(regNos[i].lastIndexOf('_') + 1), 10);

        const prevPrefix = currentRangeEnd.substring(0, currentRangeEnd.lastIndexOf('_'));
        const prevNum = parseInt(currentRangeEnd.substring(currentRangeEnd.lastIndexOf('_') + 1), 10);

        if (currentPrefix === prevPrefix && currentNum === prevNum + 1) {
            currentRangeEnd = regNos[i]; // Extend current range
        } else {
            // End of a range, add it
            ranges.push(currentRangeStart === currentRangeEnd ? currentRangeStart : `${currentRangeStart}-${currentRangeEnd}`);
            // Start a new range
            currentRangeStart = regNos[i];
            currentRangeEnd = regNos[i];
        }
    }
    // Add the last range
    ranges.push(currentRangeStart === currentRangeEnd ? currentRangeStart : `${currentRangeStart}------${currentRangeEnd}`);

    return ranges.join(', ');
}

/**
 * Renders the Absentee Reporting tab content.
 * Allows duty teachers to mark absentees by Exam Registration Number.
 */
function renderExamControlAbsenteeReportingTabold() {
    const container = document.getElementById('exam-control-absentee');
    if (!container) return;

    container.innerHTML = `
        <div class="ui-card mb-4">
            <h5 class="section-header">Report Absentees</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Exam Date</label>
                    <input type="date" id="absentee-date" class="form-control" value="${new Date().toISOString().slice(0, 10)}">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Session</label>
                    <select id="absentee-session" class="form-select">
                        <option value="FN">Forenoon</option>
                        <option value="AN">Afternoon</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Student Exam Reg. No.</label>
                    <input type="text" id="absentee-reg-no" class="form-control" placeholder="Enter Exam Reg. No." autofocus>
                </div>
            </div>
            <div class="text-end mt-3">
                <button id="mark-absent-btn" class="btn btn-danger">Mark Absent</button>
            </div>
        </div>
        <div id="absentee-list-container" class="ui-card">
            <h5 class="section-header">Today's Reported Absentees</h5>
            <div id="today-absentees-table">
                <p class="text-muted text-center p-4">No absentees reported for today yet.</p>
            </div>
        </div>
    `;

    const dateInput = document.getElementById('absentee-date');
    const sessionSelect = document.getElementById('absentee-session');
    const regNoInput = document.getElementById('absentee-reg-no');
    const markAbsentBtn = document.getElementById('mark-absent-btn');
    const todayAbsenteesTable = document.getElementById('today-absentees-table');

    const loadTodayAbsentees = () => {
        displayTodayAbsentees(dateInput.value, sessionSelect.value);
    };

    markAbsentBtn.addEventListener('click', async () => {
        const date = dateInput.value;
        const session = sessionSelect.value;
        const examRegNo = regNoInput.value.trim().toUpperCase();

        if (!date || !session || !examRegNo) {
            showAlert('Please provide date, session, and student Exam Reg. No.', 'danger');
            return;
        }

        let student = null;
        let foundExamId = null;
        for (const s of students) {
            if (s.examRegNumbers) {
                for (const examId_key in s.examRegNumbers) {
                    if (s.examRegNumbers[examId_key] === examRegNo) {
                        student = s;
                        foundExamId = examId_key;
                        break;
                    }
                }
            }
            if (student) break;
        }

        if (!student) {
            showAlert('Student not found with this Exam Reg. No. for any exam.', 'danger');
            return;
        }

        // --- NEW: Role-based Override for Duty Teacher Control ---
        const isAdminOrExamController = currentUserRole === 'admin' || (selectedUser?.roles && selectedUser.roles.includes('exam_controller'));

        if (!isAdminOrExamController) { // Only apply duty check if not admin/exam_controller
            const dutiesForThisTeacherToday = examDuties.filter(duty =>
                duty.dutyTeacherId === selectedUser.id &&
                duty.date === date &&
                duty.session === session
            );

            if (dutiesForThisTeacherToday.length === 0) {
                showAlert('You are not assigned duty for this date and session. Cannot mark absentees.', 'danger');
                return;
            }
            const assignedRoomIds = dutiesForThisTeacherToday.map(d => d.roomId);

            const sessionKey = `${foundExamId}_${date.replace(/-/g, '')}_${session}`;
            const studentAllocatedRoomId = student.examRoomAllocations?.[sessionKey];

            if (!studentAllocatedRoomId) {
                showAlert(`Student ${student.name} is not allocated to any room for Exam ${foundExamId} on this session. Cannot mark absent.`, 'warning');
                return;
            }

            if (!assignedRoomIds.includes(studentAllocatedRoomId)) {
                showAlert(`Student ${student.name} is allocated to Room ${studentAllocatedRoomId}, but you are not assigned duty there.`, 'danger');
                return;
            }
        }
        // --- End Role-based Override ---


        // Find relevant exam schedules for this student on this date/session
        const relevantSchedules = examSchedules.filter(sch =>
            sch.examId === foundExamId &&
            sch.date === date && sch.session === session &&
            sch.classId === student.classId && sch.division === student.division
        );

        if (relevantSchedules.length === 0) {
            showAlert(`No exam scheduled for student ${student.name} for Exam ${foundExamId} on the selected date/session.`, 'warning');
            return;
        }

        const batch = writeBatch(db);
        let absenteeismRecorded = false;

        relevantSchedules.forEach(sch => {
            const absenteeId = `${sch.examId}_${student.id}_${date.replace(/-/g, '')}_${session}_${sch.subjectId}`;
            const existingAbsentee = examAbsentees.find(a => a.id === absenteeId);

            if (!existingAbsentee) {
                const absenteeData = {
                    id: absenteeId,
                    examId: sch.examId,
                    classId: sch.classId,
                    division: sch.division,
                    subjectId: sch.subjectId,
                    date: date,
                    session: session,
                    studentId: student.id,
                    studentName: student.name,
                    admissionNumber: student.admissionNumber,
                    reportedByTeacherId: selectedUser.id,
                    reportedAt: serverTimestamp(),
                    notifiedToClassCharge: false
                };
                console.log(absenteeData);
                batch.set(getDocRef('examAbsentees', absenteeId), absenteeData);
                absenteeismRecorded = true;
            }
        });

        if (absenteeismRecorded) {
            try {
                await batch.commit();
                showAlert(`Student ${student.name} marked absent for relevant subjects.`, 'success');
                regNoInput.value = '';
                loadTodayAbsentees();
            } catch (error) {
                console.error("Error marking absent:", error);
                showAlert('Failed to mark absent. See console.', 'danger');
            }
        } else {
            showAlert('Student was already marked absent for all relevant subjects on this session.', 'info');
        }
    });

    dateInput.addEventListener('change', loadTodayAbsentees);
    sessionSelect.addEventListener('change', loadTodayAbsentees);

    loadTodayAbsentees();

}


/**
 * Renders a dedicated "Mark Absentee" module for teachers,
 * enforcing duty assignment checks.
 */
window.renderTeacherMarkAbsenteeModule = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) return;

    // Default values for date and session
    const defaultDate = new Date().toISOString().slice(0, 10);
    const defaultSession = 'FN';

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Mark Student Absentee (Exams)</h1>
        <div class="ui-card mb-4">
            <h5 class="section-header">Report Absentees</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Exam Date</label>
                    <input type="date" id="absentee-date" class="form-control" value="${defaultDate}">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Session</label>
                    <select id="absentee-session" class="form-select">
                        <option value="FN" ${defaultSession === 'FN' ? 'selected' : ''}>Forenoon</option>
                        <option value="AN" ${defaultSession === 'AN' ? 'selected' : ''}>Afternoon</option>
                    </select>
                </div>
                 <div class="col-md-4">
                    <label class="form-label">Select Exam (For your duty)</label>
                    <select id="absentee-exam-select" class="form-select">
                        <option value="">-- Select Exam --</option>
                                ${exams
            .filter(e => e.isActive) // This line only keeps active exams
            .map(e => `<option value="${e.id}">${e.name}</option>`)
            .join('')}
                    </select>
                </div>
            </div>
            <div id="absentee-reporting-interface" class="mt-4">
                <p class="text-muted text-center p-4">Select Exam Date, Session, and Exam to check your duty assignment and report absentees.</p>
            </div>
        </div>
        <div id="absentee-list-container" class="ui-card">
            <h5 class="section-header">Today's Reported Absentees</h5>
            <div id="today-absentees-table">
                <p class="text-muted text-center p-4">No absentees reported for today yet.</p>
            </div>
        </div>
    `;

    const dateInput = document.getElementById('absentee-date');
    const sessionSelect = document.getElementById('absentee-session');
    const examSelect = document.getElementById('absentee-exam-select');
    const reportingInterface = document.getElementById('absentee-reporting-interface');
    const loadTodayAbsentees = () => {
        displayTodayAbsentees(dateInput.value, sessionSelect.value);
    };


    const updateReportingInterface = () => {
        const selectedDate = dateInput.value;
        const selectedSession = sessionSelect.value;
        const selectedExamId = examSelect.value;

        // For regular teachers, strict check for duty
        if (selectedExamId && selectedDate && selectedSession) {
            const hasDuty = checkCurrentUserDuty(selectedExamId, selectedDate, selectedSession); // Use helper
            if (hasDuty) {
                // Render the actual absentee input form
                renderAbsenteeInputForm(reportingInterface, selectedExamId, selectedDate, selectedSession, false); // Pass false for no admin override
            } else {
                reportingInterface.innerHTML = `<p class="alert alert-warning text-center">You are not assigned duty for Exam: ${exams.find(e=>e.id===selectedExamId)?.name || selectedExamId} on ${new Date(selectedDate).toLocaleDateString()} (${selectedSession === 'FN' ? 'Forenoon' : 'Afternoon'}).</p>`;
            }
        } else {
            reportingInterface.innerHTML = `<p class="text-muted text-center p-4">Select Exam Date, Session, and Exam to check your duty assignment and report absentees.</p>`;
        }
        loadTodayAbsentees(selectedDate, selectedSession); // Always load today's absentees regardless of duty check
    };

    // Attach listeners for filter changes
    dateInput.addEventListener('change', updateReportingInterface);
    sessionSelect.addEventListener('change', updateReportingInterface);
    examSelect.addEventListener('change', updateReportingInterface);

    // Initial load of the interface
    updateReportingInterface();
};
// Update displayTodayAbsentees to show Exam Reg. No. (if desired)
function displayTodayAbsentees(date, session) {
    const container = document.getElementById('today-absentees-table');
    if (!container) return;

    const absenteesForSession = examAbsentees.filter(a => a.date === date && a.session === session);

    if (absenteesForSession.length === 0) {
        container.innerHTML = `<p class="text-muted text-center p-4">No absentees reported for ${new Date(date).toLocaleDateString()} (${session}) yet.</p>`;
        return;
    }

    // Group by student, then show subjects
    const groupedAbsentees = absenteesForSession.reduce((acc, abs) => {
        if (!acc[abs.studentId]) {
            acc[abs.studentId] = {
                studentName: abs.studentName,
                studentId:abs.studentId,
                admissionNumber: abs.admissionNumber,
                classId: abs.classId,
                division: abs.division,
                examRegNo: students.find(s => s.id === abs.studentId)?.examRegNumbers?.[abs.examId] || 'N/A', // Fetch exam reg no
                subjectsAbsent: []
            };
        }
        const subjectName = subjects.find(s => s.id === abs.subjectId)?.name || abs.subjectId;
        acc[abs.studentId].subjectsAbsent.push(subjectName);
        return acc;
    }, {});
    console.log(Object.values(groupedAbsentees));
    let tableHtml = `
        <table class="table table-striped table-sm">
            <thead><tr><th>Student Name</th><th>Admn No.</th><th>Exam Reg. No.</th><th>Class</th><th>Subjects Absent</th><th class="text-end">Actions</th></tr></thead>
            <tbody>
                ${Object.values(groupedAbsentees).map(studentData => {
                    const classInfo = classes.find(c => c.id === studentData.classId);
                    const className = classInfo ? `${classInfo.name} - ${studentData.division}` : 'N/A';
                    return `
                        <tr>
                            <td>${studentData.studentName}</td>
                            <td>${studentData.admissionNumber}/${studentData.studentId}</td>
                            <td>${studentData.examRegNo}</td>
                            <td>${className}</td>
                            <td>${studentData.subjectsAbsent.join(', ')}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="window.removeAbsenteeReport('${date}', '${session}', '${studentData.studentId}')">Remove All</button>
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
    container.innerHTML = tableHtml;

    // Helper to remove absentee reports (defined globally for onclick)
    window.removeAbsenteeReport = async (date, session, studentId) => {
        if (confirm(`Are you sure you want to remove all absentee reports for ${studentId} on ${date} (${session})?`)) {
            const batch = writeBatch(db);
            const toDelete = examAbsentees.filter(a => a.date === date && a.session === session && a.studentId === studentId);
            toDelete.forEach(abs => {
                batch.delete(getDocRef('examAbsentees', abs.id));
            });
            try {
                await batch.commit();
                showAlert('Absentee report(s) removed.', 'success');
                displayTodayAbsentees(date, session); // Refresh list
            } catch (error) {
                console.error("Error removing absentee:", error);
                showAlert('Failed to remove absentee report. See console.', 'danger');
            }
        }
    };
}

// --- Re-usable functions that are called by both Exam Control and Mark Absentee modules ---
// (These are assumed to be defined globally already or in a shared utility file)

// currentUserDuty (global variable)
// checkCurrentUserDuty(examId, date, session) (helper function)
// renderAbsenteeInputForm(container, examId, date, session, isAdminOverride)
// displayTodayAbsentees(date, session)
// loadTodayAbsentees(date, session) // (This simply calls displayTodayAbsentees)
// This variable will hold the user's specific duty if they select it
let currentUserDuty = null;

// Helper to check if the current user has duty for selected date/session
// And to store that duty for later use (e.g., for filtering the Absentee tab view)
function checkCurrentUserDuty(examId, date, session) {
    if (currentUserRole !== 'teacher' || !selectedUser?.id) {
        currentUserDuty = null; // Admins don't have specific "duty" here
        return false;
    }

    const duty = examDuties.find(d =>
        d.dutyTeacherId === selectedUser.id &&
        d.date === date &&
        d.session === session
    );
    currentUserDuty = duty; // Store the found duty object
    return !!duty; // Returns true if duty found, false otherwise
}

// =========================================================================
// --- âš™ï¸ ABSENTEE REPORTING MODULE (FINAL PROFESSIONAL VERSION) ---
// =========================================================================

/**
 * Renders the enhanced Absentee Reporting tab with a user-friendly workflow.
 */
function renderExamControlAbsenteeReportingTab() {
    const container = document.getElementById('exam-control-absentee');
    if (!container) return;

    container.innerHTML = `
        <div class="ui-card mb-4">
            <h5 class="section-header">Report Absentees</h5>
            <div class="row g-3">
                <div class="col-md-4"><label class="form-label">Exam</label><select id="absentee-exam-select" class="form-select">${exams.filter(e=>e.isActive).map(e => `<option value="${e.id}">${e.name}</option>`).join('')}</select></div>
                <div class="col-md-4"><label class="form-label">Date</label><select id="absentee-date-select" class="form-select" disabled><option>-- Select Exam --</option></select></div>
                <div class="col-md-4"><label class="form-label">Session</label><select id="absentee-session-select" class="form-select"><option value="FN">Forenoon</option><option value="AN">Afternoon</option></select></div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-5">
                <div class="ui-card h-100">
                    <h5 class="section-header">Find Student</h5>
                    <div class="input-group">
                        <select id="absentee-search-type" class="form-select" style="max-width: 150px;"><option value="regNo">Exam Reg. No.</option><option value="admnNo">Admission No.</option></select>
                        <input type="text" id="absentee-search-input" class="form-control" placeholder="Enter Exam Reg. No.">
                        <button id="find-student-btn" class="btn btn-primary">Find</button>
                    </div>
                    <div id="absentee-student-details" class="mt-4"></div>
                </div>
            </div>
            <div class="col-lg-7">
                <div id="absentee-list-container" class="ui-card h-100"></div>
            </div>
        </div>
    `;
    
    attachAbsenteeTabListeners();
}

/**
 * Attaches all event listeners for the Absentee Reporting tab.
 */
function attachAbsenteeTabListeners() {
    const examSelect = document.getElementById('absentee-exam-select');
    const dateSelect = document.getElementById('absentee-date-select');
    const sessionSelect = document.getElementById('absentee-session-select');
    const searchType = document.getElementById('absentee-search-type');
    const searchInput = document.getElementById('absentee-search-input');
    const findBtn = document.getElementById('find-student-btn');

    const loadData = () => {
        displayAbsenteesForSession(examSelect.value, dateSelect.value, sessionSelect.value);
        document.getElementById('absentee-student-details').innerHTML = '';
    };

    examSelect.addEventListener('change', () => {
        const examId = examSelect.value;
        dateSelect.innerHTML = '<option value="">-- Select Date --</option>';
        if (examId) {
            const uniqueDates = [...new Set(examSchedules.filter(s => s.examId === examId).map(s => s.date))].sort();
            uniqueDates.forEach(d => dateSelect.innerHTML += `<option value="${d}">${new Date(d).toLocaleDateString('en-GB')}</option>`);
            dateSelect.disabled = false;
        } else {
            dateSelect.disabled = true;
        }
        loadData();
    });

    dateSelect.addEventListener('change', loadData);
    sessionSelect.addEventListener('change', loadData);

    searchType.addEventListener('change', () => {
        searchInput.placeholder = searchType.value === 'regNo' ? 'Enter Exam Reg. No.' : 'Enter Admission No.';
    });

    findBtn.addEventListener('click', () => {
        findAndDisplayStudentForAbsence(examSelect.value, searchType.value, searchInput.value);
    });

    if (exams.length > 0) {
        examSelect.value = exams.find(e=>e.isActive)?.id || '';
        examSelect.dispatchEvent(new Event('change'));
    }
}

/**
 * Finds a student and displays their details for confirmation.
 */
function findAndDisplayStudentForAbsence(examId, searchType, searchValue) {
    const detailsContainer = document.getElementById('absentee-student-details');
    if (!examId || !searchValue) {
        detailsContainer.innerHTML = `<p class="alert alert-warning">Please select an exam and enter a search value.</p>`;
        return;
    }
    
    searchValue = searchValue.trim().toUpperCase();
    let student = students.find(s => searchType === 'regNo' ? s.examRegNumbers?.[examId] === searchValue : s.admissionNumber === searchValue);

    if (!student) {
        detailsContainer.innerHTML = `<p class="alert alert-danger">No student found with the provided ID.</p>`;
        return;
    }
    
    const studentPhoto = student.photoDriveId ? `https://drive.google.com/thumbnail?id=${student.photoDriveId}` : 'https://placehold.co/100x120';
    const className = classes.find(c => c.id === student.classId)?.name || 'N/A';
    
    detailsContainer.innerHTML = `
        <div class="card bg-light"><div class="card-body">
            <div class="d-flex">
                <img src="${studentPhoto}" class="img-thumbnail me-3" style="width: 100px;">
                <div>
                    <h6 class="card-title">${student.name}</h6>
                    <p class="card-text small mb-1"><strong>Class:</strong> ${className} - ${student.division}</p>
                    <p class="card-text small"><strong>Exam Reg. No:</strong> ${student.examRegNumbers?.[examId] || 'N/A'}</p>
                </div>
            </div>
            <div class="d-grid mt-3"><button class="btn btn-danger" onclick="window.markStudentAbsent('${student.id}', '${examId}')">Confirm & Mark Absent</button></div>
        </div></div>`;
}

/**
 * The final logic to mark a student absent after confirmation.
 */
window.markStudentAbsent = async function(studentId, examId) {
    const date = document.getElementById('absentee-date-select').value;
    const session = document.getElementById('absentee-session-select').value;
    const student = students.find(s => s.id === studentId);
    if (!student) return showAlert('Student not found.', 'danger');

    const isAdminOrController = currentUserRole === 'admin' || (selectedUser?.roles?.includes('exam_controller'));
    if (!isAdminOrController) {
        const sessionKey = `${examId}_${date.replace(/-/g, '')}_${session}`;
        const studentRoomId = student.examRoomAllocations?.[sessionKey];
        if (!studentRoomId) return showAlert(`Student ${student.name} is not allocated to a room.`, 'warning');
        const teacherIsOnDutyInRoom = examDuties.some(d => d.dutyTeacherId === selectedUser.id && d.date === date && d.session === session && d.roomId === studentRoomId);
        if (!teacherIsOnDutyInRoom) return showAlert(`You are not assigned duty in Room ${examRooms.find(r=>r.id===studentRoomId)?.name}. Cannot mark absent.`, 'danger');
    }

    const relevantSchedules = examSchedules.filter(sch => sch.examId === examId && sch.date === date && sch.session === session && sch.classId === student.classId && sch.division === student.division);
    if (relevantSchedules.length === 0) return showAlert(`No exam scheduled for ${student.name} in this session.`, 'warning');

    const batch = writeBatch(db);
    let absenteesToCreate = 0;
    relevantSchedules.forEach(sch => {
        const absenteeId = `${sch.examId}_${student.id}_${date.replace(/-/g, '')}_${session}_${sch.subjectId}`;
        if (!examAbsentees.some(a => a.id === absenteeId)) {
            batch.set(getDocRef('examAbsentees', absenteeId), {
                id: absenteeId, examId, classId: student.classId, division: student.division,
                subjectId: sch.subjectId, date, session, studentId, studentName: student.name,
                admissionNumber: student.admissionNumber, reportedByTeacherId: selectedUser.id,
                reportedAt: serverTimestamp()
            });
            absenteesToCreate++;
        }
    });

    if (absenteesToCreate > 0) {
        await batch.commit();
        showAlert(`Student ${student.name} marked absent.`, 'success');
        document.getElementById('absentee-search-input').value = '';
        document.getElementById('absentee-student-details').innerHTML = '';
    } else {
        showAlert('Student already marked absent for all subjects in this session.', 'info');
    }
}

/**
 * Displays the list of absentees for the selected session with checkboxes for deletion.
 */
function displayAbsenteesForSession(examId, date, session) {
    const container = document.getElementById('absentee-list-container');
    if (!container || !examId || !date || !session) { container.innerHTML = ''; return; }

    const absentees = examAbsentees.filter(a => a.examId === examId && a.date === date && a.session === session);
    
    container.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="section-header mb-0">Absentees on ${new Date(date).toLocaleDateString()} (${session})</h5>
            <div>
                <button class="btn btn-sm btn-danger me-2" id="remove-selected-absentees-btn" disabled><i class="fas fa-trash-alt me-1"></i>Remove Selected</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="window.printAbsenteesList('${examId}', '${date}', '${session}')" ${absentees.length === 0 ? 'disabled' : ''}><i class="fas fa-print me-1"></i>Print List</button>
            </div>
        </div>
        <div id="today-absentees-table" class="mt-3 table-responsive"></div>`;
    
    const tableContainer = document.getElementById('today-absentees-table');
    if (absentees.length === 0) {
        tableContainer.innerHTML = `<p class="text-muted text-center p-4">No absentees reported yet.</p>`;
        return;
    }

    const grouped = absentees.reduce((acc, abs) => {
        if (!acc[abs.studentId]) {
            const student = students.find(s => s.id === abs.studentId);
            acc[abs.studentId] = {
                studentId: abs.studentId, studentName: abs.studentName,
                examRegNo: student?.examRegNumbers?.[examId] || 'N/A',
                className: classes.find(c => c.id === abs.classId)?.name + ' - ' + abs.division,
                subjects: []
            };
        }
        acc[abs.studentId].subjects.push(subjects.find(s => s.id === abs.subjectId)?.name || 'Unknown');
        return acc;
    }, {});
    
    tableContainer.innerHTML = `<table class="table table-striped table-sm">
        <thead><tr>
            <th><input class="form-check-input" type="checkbox" id="select-all-absentees"></th>
            <th>Exam Reg. No.</th><th>Student Name</th><th>Class</th><th>Subjects Absent</th>
        </tr></thead>
        <tbody>${Object.values(grouped).map(data => `<tr>
            <td><input class="form-check-input absentee-select-checkbox" type="checkbox" value="${data.studentId}"></td>
            <td>${data.examRegNo}</td><td>${data.studentName}</td><td>${data.className}</td><td>${data.subjects.join(', ')}</td>
        </tr>`).join('')}</tbody>
    </table>`;

    // Add listeners for the new checkboxes and button
    const removeBtn = document.getElementById('remove-selected-absentees-btn');
    const selectAll = document.getElementById('select-all-absentees');
    const checkboxes = tableContainer.querySelectorAll('.absentee-select-checkbox');

    const updateButtonState = () => {
        const anyChecked = tableContainer.querySelector('.absentee-select-checkbox:checked');
        removeBtn.disabled = !anyChecked;
    };

    selectAll.addEventListener('change', () => {
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
        updateButtonState();
    });
    checkboxes.forEach(cb => cb.addEventListener('change', updateButtonState));

    removeBtn.addEventListener('click', () => {
        const selectedStudentIds = Array.from(tableContainer.querySelectorAll('.absentee-select-checkbox:checked')).map(cb => cb.value);
        window.removeSelectedAbsentees(examId, date, session, selectedStudentIds);
    });
}

/**
 * Removes all absentee records for multiple students in a given session.
 */
window.removeSelectedAbsentees = async function(examId, date, session, studentIds) {
    if (studentIds.length === 0 || !confirm(`Are you sure you want to remove all absentee reports for ${studentIds.length} selected student(s)?`)) return;

    const batch = writeBatch(db);
    const absenteesToDelete = examAbsentees.filter(a => a.examId === examId && a.date === date && a.session === session && studentIds.includes(a.studentId));
    
    if (absenteesToDelete.length === 0) return showAlert('Could not find absentee records to delete.', 'warning');
    
    absenteesToDelete.forEach(absentee => batch.delete(getDocRef('examAbsentees', absentee.id)));

    await batch.commit();
    showAlert('Selected absentee reports removed successfully.', 'success');
}

/**
 * Renders the Absentee Notifications tab content.
 * Displays pending notifications and allows sending them.
 */
function renderExamControlNotificationsTab() {
    const container = document.getElementById('exam-control-notifications');
    if (!container) return;

    container.innerHTML = `
        <h5 class="section-header">Absentee Notifications to Class Charges</h5>
        <div id="absentee-notification-list">
            <p class="text-muted text-center p-4">Checking for pending notifications...</p>
        </div>
    `;

    // This calls the global notification checker, which will update the bell and render this list
    checkAbsenteeNotifications();
}

/**
 * Checks for upcoming absentee notifications (today/next day) and updates the bell icon.
 * This should be triggered by the examAbsentees listener.
 */
function checkAbsenteeNotifications() {
    // This function will primarily populate the 'Notifications' tab for Exam Control
    // and also contribute to the main notification bell.

    const notifications = [];
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Normalize to start of day

    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);

    const relevantAbsentees = examAbsentees.filter(abs => {
        const absDate = new Date(abs.date);
        return (absDate.toDateString() === today.toDateString() || absDate.toDateString() === tomorrow.toDateString()) && !abs.notifiedToClassCharge;
    });

    // Group absentees by class teacher to send a single notification per class teacher
    const classTeacherNotifications = {}; // { teacherId: { classId: { division: { date: { session: [absentee_objects] } } } } }

    relevantAbsentees.forEach(abs => {
        const studentClass = classes.find(c => c.id === abs.classId);
        if (studentClass) {
            const classTeacher = teachers.find(t => t.classCharge?.classId === abs.classId && t.classCharge?.division === abs.division);
            if (classTeacher) {
                if (!classTeacherNotifications[classTeacher.id]) classTeacherNotifications[classTeacher.id] = {
                    name: classTeacher.name,
                    mobile: classTeacher.mobile, // To send SMS/WhatsApp
                    notifications: {}
                };
                if (!classTeacherNotifications[classTeacher.id].notifications[abs.classId]) classTeacherNotifications[classTeacher.id].notifications[abs.classId] = {};
                if (!classTeacherNotifications[classTeacher.id].notifications[abs.classId][abs.division]) classTeacherNotifications[classTeacher.id].notifications[abs.classId][abs.division] = {};
                if (!classTeacherNotifications[classTeacher.id].notifications[abs.classId][abs.division][abs.date]) classTeacherNotifications[classTeacher.id].notifications[abs.classId][abs.division][abs.date] = {};
                if (!classTeacherNotifications[classTeacher.id].notifications[abs.classId][abs.division][abs.date][abs.session]) classTeacherNotifications[classTeacher.id].notifications[abs.classId][abs.division][abs.date][abs.session] = [];
                
                classTeacherNotifications[classTeacher.id].notifications[abs.classId][abs.division][abs.date][abs.session].push(abs);
            }
        }
    });

    const notificationsForDisplay = []; // For the tab view
    const mainBellNotifications = []; // For the main bell (simpler, just count)

    Object.keys(classTeacherNotifications).forEach(teacherId => {
        const teacherData = classTeacherNotifications[teacherId];
        let message = `Absentee Report for ${teacherData.name}:\n\n`;
        let studentCount = 0;

        Object.keys(teacherData.notifications).forEach(classId => {
            const className = classes.find(c => c.id === classId)?.name || classId;
            Object.keys(teacherData.notifications[classId]).forEach(division => {
                message += `Class: ${className}-${division}\n`;
                Object.keys(teacherData.notifications[classId][division]).forEach(date => {
                    message += `Date: ${new Date(date).toLocaleDateString('en-GB')}\n`;
                    Object.keys(teacherData.notifications[classId][division][date]).forEach(session => {
                        message += `  Session: ${session === 'FN' ? 'Forenoon' : 'Afternoon'}\n`;
                        teacherData.notifications[classId][division][date][session].forEach(abs => {
                            message += `    - ${abs.studentName} (${abs.admissionNumber}) absent for ${subjects.find(s=>s.id === abs.subjectId)?.name || abs.subjectId}\n`;
                            studentCount++;
                        });
                    });
                });
            });
        });

        // Add to main bell notifications
        mainBellNotifications.push({
            type: 'exam_absentee_summary',
            id: `exam_abs_sum_${teacherId}`,
            title: `Absentee Notification for ${teacherData.name}`,
            text: `You have ${studentCount} absentee(s) reported.`,
            targetView: 'exam-control', // Directs to Exam Control Module
            subTab: 'exam-control-notifications' // Suggests the tab to go to
        });

        notificationsForDisplay.push({
            teacherId,
            teacherName: teacherData.name,
            classTeacherMobile: teacherData.mobile,
            fullMessage: message,
            absenteeIds: relevantAbsentees.filter(abs => { // Get IDs of absentees related to this notification
                const studentClass = classes.find(c => c.id === abs.classId);
                return studentClass && teachers.find(t => t.id === teacherId && t.classCharge?.classId === abs.classId && t.classCharge?.division === abs.division);
            }).map(abs => abs.id)
        });
    });

    // Render in the tab
    const notificationListContainer = document.getElementById('absentee-notification-list');
    if (notificationListContainer) {
        if (notificationsForDisplay.length === 0) {
            notificationListContainer.innerHTML = `<p class="text-success text-center p-4">No pending absentee notifications for today or tomorrow.</p>`;
        } else {
            notificationListContainer.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead><tr><th>Class Teacher</th><th>Details</th><th class="text-end">Actions</th></tr></thead>
                        <tbody>
                            ${notificationsForDisplay.map(n => `
                                <tr>
                                    <td>${n.teacherName}</td>
                                    <td><pre style="white-space: pre-wrap; font-size: 0.8em; margin: 0;">${n.fullMessage}</pre></td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-success me-1" onclick="sendAbsenteeNotification('${n.teacherId}', '${encodeURIComponent(n.fullMessage)}', '${n.classTeacherMobile}', ${JSON.stringify(n.absenteeIds).replace(/"/g, '&quot;')})">
                                            <i class="fab fa-whatsapp me-1"></i>Send
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="markAbsenteeNotificationSent(${JSON.stringify(n.absenteeIds).replace(/"/g, '&quot;')})">
                                            Mark Sent
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    }

    // Update main notification bell (combining with other notification types)
    // You'll need to pass 'mainBellNotifications' to updateAllNotifications
    // or modify updateAllNotifications to fetch its own exam_absentee_summary
    // For now, let's just make sure `updateAllNotifications` uses this.
    // Assuming `updateAllNotifications` combines various sources.
    // This is a complex interaction: `checkAbsenteeNotifications` is *triggered by* `examAbsentees` updates,
    // and *then* updates the overall notification system.
    // For simplicity, let's ensure the main `updateAllNotifications` is called whenever any relevant data changes.
    updateAllNotifications(); // Call the main function to refresh the bell
}

// Global functions for notification actions
window.sendAbsenteeNotification = (teacherId, encodedMessage, mobile, absenteeIds) => {
    // Implement your WhatsApp sending logic here.
    // You might use an Apps Script or other API for automated sending.
    // For now, it will just open a WhatsApp Web link.
    const whatsappUrl = `https://wa.me/${mobile}?text=${encodedMessage}`;
    window.open(whatsappUrl, '_blank');
    
    // Optionally, mark as sent after opening WhatsApp
    if (confirm("Did you successfully send the message? Mark as sent?")) {
        markAbsenteeNotificationSent(absenteeIds);
    }
};

window.markAbsenteeNotificationSent = async (absenteeIds) => {
    const batch = writeBatch(db);
    absenteeIds.forEach(id => {
        const absRef = getDocRef('examAbsentees', id);
        batch.update(absRef, { notifiedToClassCharge: true });
    });
    try {
        await batch.commit();
        showAlert('Notifications marked as sent.', 'success');
        // The listener on examAbsentees will re-trigger checkAbsenteeNotifications
    } catch (error) {
        console.error("Error marking notification sent:", error);
        showAlert('Failed to mark notification sent. See console.', 'danger');
    }
};

// Global variable for current exam settings (to avoid re-fetching)
let currentExamRegSettings = {};

/**
 * Renders the tab for assigning unique exam registration numbers to students.
 */
function renderExamControlRegNoAssignmentTab() {
    const container = document.getElementById('exam-control-reg-no');
    if (!container) return;

    const classOptions = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

    container.innerHTML = `
        <div class="ui-card mb-4">
            <h5 class="section-header">Assign Exam Registration Numbers (Class-wide)</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Select Exam</label>
                    <select id="reg-exam-select" class="form-select">
                        <option value="">-- Select Exam --</option>
                                ${exams
            .filter(e => e.isActive) // This line only keeps active exams
            .map(e => `<option value="${e.id}">${e.name}</option>`)
            .join('')}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Select Class</label>
                    <select id="reg-class-select" class="form-select">
                        <option value="">-- Select Class --</option>
                        ${classOptions}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Male Start No.</label>
                    <input type="number" id="reg-male-start" class="form-control" value="101" min="1">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Female Start No.</label>
                    <input type="number" id="reg-female-start" class="form-control" value="101" min="1">
                </div>
            </div>
            <div class="text-end mt-3">
                <button id="generate-reg-nos-btn" class="btn btn-primary" disabled>Generate Numbers</button>
            </div>
            <div id="reg-no-assignment-list" class="mt-4">
                <p class="text-muted text-center p-4">Select an exam and class to generate registration numbers.</p>
            </div>
        </div>
    `;

    const examSelect = document.getElementById('reg-exam-select');
    const classSelect = document.getElementById('reg-class-select');
    const maleStartInput = document.getElementById('reg-male-start');
    const femaleStartInput = document.getElementById('reg-female-start');
    const generateBtn = document.getElementById('generate-reg-nos-btn');
    const assignmentListContainer = document.getElementById('reg-no-assignment-list');

    const updateUIAndButton = async () => {
        const examId = examSelect.value;
        const classId = classSelect.value;

        generateBtn.disabled = !(examId && classId);

        // Load and pre-fill starting numbers from settings
        if (examRegistrationSettings && examRegistrationSettings[`${classId}_M`]) {
            maleStartInput.value = examRegistrationSettings[`${classId}_M`];
        } else {
            maleStartInput.value = '101'; // Default
        }
        if (examRegistrationSettings && examRegistrationSettings[`${classId}_F`]) {
            femaleStartInput.value = examRegistrationSettings[`${classId}_F`];
        } else {
            femaleStartInput.value = '101'; // Default
        }
        
        displayRegNoStatus(examId, classId); // Pass only classId, no division
    };

    classSelect.addEventListener('change', updateUIAndButton);
    examSelect.addEventListener('change', updateUIAndButton);
    maleStartInput.addEventListener('input', updateUIAndButton); // Re-evaluate button state
    femaleStartInput.addEventListener('input', updateUIAndButton); // Re-evaluate button state

    generateBtn.addEventListener('click', async () => {
        const examId = examSelect.value;
        const classId = classSelect.value;
        const maleStart = parseInt(maleStartInput.value, 10);
        const femaleStart = parseInt(femaleStartInput.value, 10);
        await generateAndSaveExamRegNumbers(examId, classId, maleStart, femaleStart);
    });

    // Initial display
    updateUIAndButton();
}

/**
 * Displays the current registration number status for selected class/exam.
 * @param {string} examId
 * @param {string} classId
 */
/**
 * Displays the student list for a class with their exam registration numbers.
 * Now includes an inline editing feature to manually assign/change a Reg. No.
 * @param {string} examId
 * @param {string} classId
 */
function displayRegNoStatus(examId, classId) {
    const container = document.getElementById('reg-no-assignment-list');
    if (!container || !examId || !classId) {
        container.innerHTML = `<p class="text-muted text-center p-4">Select an exam and class to view.</p>`;
        return;
    }

    const studentsInClass = students.filter(s => s.classId === classId&&s.status !== 'TC Issued')
        .sort((a, b) => {
            const divCompare = (a.division || '').localeCompare(b.division || '');
            if (divCompare !== 0) return divCompare;
            const genderCompare = (a.gender || '').localeCompare(b.gender || '');
            if (genderCompare !== 0) return genderCompare;
            return (a.name || '').localeCompare(b.name || '');
        });

    if (studentsInClass.length === 0) {
        container.innerHTML = `<p class="alert alert-info text-center">No students found in this class.</p>`;
        return;
    }

    // --- RENDER THE MAIN TABLE STRUCTURE ---
    container.innerHTML = `
        <h5>Students in ${classes.find(c => c.id === classId)?.name || ''} for Exam: ${exams.find(e => e.id === examId)?.name || ''}</h5>
        <div class="table-responsive">
            <table class="table table-bordered table-sm" id="reg-no-table">
                <thead><tr><th>Student Name</th><th>Division</th><th>Admn No.</th><th>Gender</th><th>Exam Reg. No.</th><th class="text-end">Actions</th></tr></thead>
                <tbody>
                    ${studentsInClass.map(student => {
                        const regNo = student.examRegNumbers?.[examId] || 'N/A';
                        return `
                            <tr data-student-id="${student.id}">
                                <td>${student.name}</td>
                                <td>${student.division}</td>
                                <td>${student.admissionNumber}</td>
                                <td>${student.gender === 'M' ? 'Male' : 'Female'}</td>
                                <td class="reg-no-cell ${regNo !== 'N/A' ? 'fw-bold text-primary' : 'text-muted'}">${regNo}</td>
                                <td class="actions-cell text-end">
                                    <button class="btn btn-sm btn-outline-primary py-0 px-1 edit-reg-no-btn">Edit</button>
                                </td>
                            </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>
        <div class="text-end mt-3">
            <button id="clear-reg-nos-btn" class="btn btn-warning">Clear All Reg. Nos. for this Exam/Class</button>
        </div>`;

    // --- ATTACH ALL EVENT LISTENERS FOR THIS TABLE ---
    const table = container.querySelector('#reg-no-table');
    
    table.addEventListener('click', async (e) => {
        const target = e.target;

        // --- EDIT BUTTON LOGIC ---
        if (target.classList.contains('edit-reg-no-btn')) {
            const row = target.closest('tr');
            const regNoCell = row.querySelector('.reg-no-cell');
            const actionsCell = row.querySelector('.actions-cell');
            const currentRegNo = regNoCell.textContent;

            // Switch to edit mode
            regNoCell.innerHTML = `<input type="text" class="form-control form-control-sm" value="${currentRegNo === 'N/A' ? '' : currentRegNo}">`;
            actionsCell.innerHTML = `<button class="btn btn-sm btn-success py-0 px-1 save-reg-no-btn">Save</button>`;
            
            regNoCell.querySelector('input').focus();
        }

        // --- SAVE BUTTON LOGIC ---
        if (target.classList.contains('save-reg-no-btn')) {
            const row = target.closest('tr');
            const studentId = row.dataset.studentId;
            const student = students.find(s => s.id === studentId);
            const input = row.querySelector('.reg-no-cell input');
            const newRegNo = input.value.trim().toUpperCase();

            if (!student) {
                showAlert('Could not find student data.', 'danger');
                return;
            }

            // Prepare the updated registration numbers object
            let updatedRegNumbers = { ...student.examRegNumbers };
            if (newRegNo) {
                updatedRegNumbers[examId] = newRegNo; // Add or update the reg no
            } else {
                delete updatedRegNumbers[examId]; // Remove the reg no if the input is empty
            }

            try {
                const studentRef = getDocRef('students', student.id);
                await updateDoc(studentRef, { examRegNumbers: updatedRegNumbers });
                showAlert('Registration number updated successfully!', 'success');
                // The real-time listener will handle the UI update automatically,
                // but an explicit refresh ensures it's instant.
                displayRegNoStatus(examId, classId);
            } catch (error) {
                console.error("Error updating registration number:", error);
                showAlert('Failed to save the registration number.', 'danger');
            }
        }
    });
    
    document.getElementById('clear-reg-nos-btn')?.addEventListener('click', async () => {
        if (confirm("Are you sure you want to clear all exam registration numbers for this class/exam? This will also reset the starting sequence for future assignments.")) {
            const batch = writeBatch(db);
            studentsInClass.forEach(student => {
                const studentRef = getDocRef('students', student.id);
                let updatedRegNumbers = { ...student.examRegNumbers };
                delete updatedRegNumbers[examId]; // Remove only for this exam
                batch.update(studentRef, { examRegNumbers: updatedRegNumbers });
            });

            // --- NEW: Reset starting sequence in examRegistrationSettings ---
            const settingsRef = getDocRef('examRegistrationSettings', 'main');
            batch.update(settingsRef, {
                [`${classId}_M`]: 101, // Reset male starting sequence to 101
                [`${classId}_F`]: 101  // Reset female starting sequence to 101
            });

            try {
                await batch.commit();
                showAlert('Exam registration numbers and starting sequences cleared.', 'success');
                displayRegNoStatus(examId, classId); // Refresh UI
                // Also, force a re-evaluation of the start numbers inputs
                document.getElementById('reg-class-select').dispatchEvent(new Event('change'));

            } catch (error) {
                console.error("Error clearing reg nos and resetting settings:", error);
                showAlert('Failed to clear registration numbers and reset settings. See console.', 'danger');
            }
        }
    });
}
/**
 * Generates and saves unique exam registration numbers for students in a class.
 * @param {string} examId
 * @param {string} classId
 * @param {number} maleStart - Starting sequence for male students.
 * @param {number} femaleStart - Starting sequence for female students.
 */
async function generateAndSaveExamRegNumbers2(examId, classId, maleStart, femaleStart) {
    const studentsInClass = students.filter(s => s.classId === classId&&s.status !== 'TC Issued'); // All divisions
    if (studentsInClass.length === 0) {
        showAlert('No students found to generate numbers for.', 'info');
        return;
    }

    let nextMaleSeq = maleStart;
    let nextFemaleSeq = femaleStart;

    const maleStudents = studentsInClass.filter(s => s.gender === 'M').sort((a, b) => a.name.localeCompare(b.name));
    const femaleStudents = studentsInClass.filter(s => s.gender === 'F').sort((a, b) => a.name.localeCompare(b.name));

    const classNameAbbr = classes.find(c => c.id === classId)?.alias.replace(/\s+/g, '').toUpperCase()|| classId.slice(0, 5).toUpperCase();
    const batch = writeBatch(db);
    let updatedCount = 0;

    maleStudents.forEach(student => {
        if (!student.examRegNumbers?.[examId]||student.examRegNumbers?.[examId]) {
            const regNo = `M${classNameAbbr}_${nextMaleSeq.toString().padStart(3, '0')}`;
            const studentRef = getDocRef('students', student.id);
            let updatedRegNumbers = { ...(student.examRegNumbers || {}), [examId]: regNo };
            batch.update(studentRef, { examRegNumbers: updatedRegNumbers });
            nextMaleSeq++;
            updatedCount++;
        }
    });

    femaleStudents.forEach(student => {
        if (!student.examRegNumbers?.[examId] || student.examRegNumbers?.[examId]) {
            const regNo = `F${classNameAbbr}_${nextFemaleSeq.toString().padStart(3, '0')}`;
            const studentRef = getDocRef('students', student.id);
            let updatedRegNumbers = { ...(student.examRegNumbers || {}), [examId]: regNo };
            batch.update(studentRef, { examRegNumbers: updatedRegNumbers });
            nextFemaleSeq++;
            updatedCount++;
        }
    });

    // Update the next sequence numbers in examRegistrationSettings
    const settingsRef = getDocRef('examRegistrationSettings', 'main');
    batch.set(settingsRef, {
        [`${classId}_M`]: nextMaleSeq,
        [`${classId}_F`]: nextFemaleSeq
    }, { merge: true });

    if (updatedCount > 0) {
        try {
            await batch.commit();
            showAlert(`${updatedCount} exam registration numbers assigned successfully!`, 'success');
            displayRegNoStatus(examId, classId); // Refresh list
        } catch (error) {
            console.error("Error assigning registration numbers:", error);
            showAlert('Failed to assign registration numbers. See console.', 'danger');
        }
    } else {
        showAlert('All students in this group already have exam registration numbers for this exam.', 'info');
    }
}

/**
 * Displays the current registration number status for selected class/division/exam.
 * @param {string} examId
 * @param {string} classId
 * @param {string} division
 */
function displayRegNoStatus2(examId, classId, division) {
    const container = document.getElementById('reg-no-assignment-list');
    if (!container || !examId || !classId || !division) {
        container.innerHTML = `<p class="text-muted text-center p-4">Select an exam, class, and division to generate registration numbers.</p>`;
        return;
    }

    const studentsInClass = students.filter(s => s.classId === classId && s.division === division)
        .sort((a, b) => a.name.localeCompare(b.name));

    if (studentsInClass.length === 0) {
        container.innerHTML = `<p class="alert alert-info text-center">No students found in this class/division.</p>`;
        return;
    }

    let tableHtml = `
        <h5>Students in ${classes.find(c => c.id === classId)?.name || ''} - ${division} for Exam: ${exams.find(e => e.id === examId)?.name || ''}</h5>
        <div class="table-responsive">
            <table class="table table-bordered table-sm">
                <thead><tr><th>Student Name</th><th>Admn No.</th><th>Gender</th><th>Exam Reg. No.</th></tr></thead>
                <tbody>
                    ${studentsInClass.map(student => {
                        const regNo = student.examRegNumbers?.[examId] || 'N/A';
                        return `
                            <tr>
                                <td>${student.name}</td>
                                <td>${student.admissionNumber}</td>
                                <td>${student.gender === 'M' ? 'Male' : 'Female'}</td>
                                <td class="${regNo !== 'N/A' ? 'fw-bold text-primary' : 'text-muted'}">${regNo}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
        <div class="text-end mt-3">
            <button id="clear-reg-nos-btn" class="btn btn-warning">Clear All Reg. Nos.</button>
        </div>
    `;
    container.innerHTML = tableHtml;

    document.getElementById('clear-reg-nos-btn')?.addEventListener('click', async () => {
        if (confirm("Are you sure you want to clear all exam registration numbers for this class/division/exam?")) {
            const batch = writeBatch(db);
            studentsInClass.forEach(student => {
                const studentRef = getDocRef('students', student.id);
                // Create a copy of examRegNumbers and remove the specific exam's entry
                let updatedRegNumbers = { ...student.examRegNumbers };
                delete updatedRegNumbers[examId];
                batch.update(studentRef, { examRegNumbers: updatedRegNumbers });
            });
            try {
                await batch.commit();
                showAlert('Exam registration numbers cleared.', 'success');
                displayRegNoStatus(examId, classId, division); // Refresh
            } catch (error) {
                console.error("Error clearing reg nos:", error);
                showAlert('Failed to clear registration numbers.', 'danger');
            }
        }
    });
}

/**
 * Generates and saves unique exam registration numbers for students in a class/division.
 * @param {string} examId
 * @param {string} classId
 * @param {string} division
 */
async function generateAndSaveExamRegNumbers(examId, classId, division) {
    const studentsInClass = students.filter(s => s.classId === classId &&(s.division === "A"||s.division === "B"||s.division === "C"));
    if (studentsInClass.length === 0) {
        showAlert('No students found to generate numbers for.', 'info');
        return;
    }

    // Get current registration settings for the class
    const regSettingsId = `CLASS_${classId}`;
    let currentSettings = examRegistrationSettings || {}; // Ensure it's initialized

    let nextMaleSeq = currentSettings[`${classId}_M`] || 101; // Start from 101 by default
    let nextFemaleSeq = currentSettings[`${classId}_F`] || 101;

    const maleStudents = studentsInClass.filter(s => s.gender === 'M').sort((a, b) => a.name.localeCompare(b.name));
    const femaleStudents = studentsInClass.filter(s => s.gender === 'F').sort((a, b) => a.name.localeCompare(b.name));

    const classNameAbbr = classes.find(c => c.id === classId)?.alias.toUpperCase() || classId.slice(0, 5).toUpperCase();
    const batch = writeBatch(db);
    let updatedCount = 0;

    maleStudents.forEach(student => {
        if (!student.examRegNumbers?.[examId]|| student.examRegNumbers?.[examId]) { // Only assign if not already assigned for this exam
            const regNo = `M${classNameAbbr}_${nextMaleSeq.toString().padStart(3, '0')}`;
            const studentRef = getDocRef('students', student.id);
            let updatedRegNumbers = { ...student.examRegNumbers, [examId]: regNo };
            batch.update(studentRef, { examRegNumbers: updatedRegNumbers });
            nextMaleSeq++;
            updatedCount++;
        }
    });

    femaleStudents.forEach(student => {
        if (!student.examRegNumbers?.[examId]|| student.examRegNumbers?.[examId]) { // Only assign if not already assigned for this exam
            const regNo = `F${classNameAbbr}_${nextFemaleSeq.toString().padStart(3, '0')}`;
            const studentRef = getDocRef('students', student.id);
            let updatedRegNumbers = { ...student.examRegNumbers, [examId]: regNo };
            batch.update(studentRef, { examRegNumbers: updatedRegNumbers });
            nextFemaleSeq++;
            updatedCount++;
        }
    });

    // Update the next sequence numbers in examRegistrationSettings
    const settingsRef = getDocRef('examRegistrationSettings', 'main'); // Assuming 'main' is the single settings doc
    batch.set(settingsRef, {
        [`${classId}_M`]: nextMaleSeq,
        [`${classId}_F`]: nextFemaleSeq
    }, { merge: true });

    if (updatedCount > 0) {
        try {
            await batch.commit();
            showAlert(`${updatedCount} exam registration numbers assigned successfully!`, 'success');
            displayRegNoStatus(examId, classId, division); // Refresh list
        } catch (error) {
            console.error("Error assigning registration numbers:", error);
            showAlert('Failed to assign registration numbers. See console.', 'danger');
        }
    } else {
        showAlert('All students in this group already have exam registration numbers for this exam.', 'info');
    }
}

// Local variable to store selected session and exam for allocation
let currentAllocationExamId = null;
let currentAllocationDate = null;
let currentAllocationSession = null;
/**
 * Renders the main tab for student-wise exam room allocation.
 */
function renderExamControlRoomAllocationTab() {
    const container = document.getElementById('exam-control-room-alloc');
    if (!container) return;

    container.innerHTML = `
        <div class="ui-card mb-4">
            <h5 class="section-header">1. Select Exam & Session(s)</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label" for="alloc-exam-select">Exam</label>
                    <select id="alloc-exam-select" class="form-select"> 
                        <option value="">-- Select an Exam --</option>
                           ${exams
            .filter(e => e.isActive) // This line only keeps active exams
            .map(e => `<option value="${e.id}">${e.name}</option>`).join('')}</select>
                </div>
                <div class="col-md-6">
                    <label class="form-label" for="alloc-session-select">Session(s)</label>
                    <select id="alloc-session-select" class="form-select" multiple size="5" disabled>
                        <option>-- Select an Exam --</option>
                    </select>
                </div>
            </div>
            <div class="form-text text-muted mt-2">Hold Ctrl (or Cmd) to select multiple sessions. The same rules will be applied to all.</div>
            <div id="allocation-summary" class="mt-4"></div>
        </div>

        <div id="allocation-rules-grid" class="ui-card mb-4 d-none">
            <h5 class="section-header">2. Define Allocation Rules</h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Room</th>
                            <th>Capacity</th>
                            <th>Remaining</th>
                            <th>Start Reg No.</th>
                            <th>Count</th>
                            <th>Available</th>
                            <th>End Reg No.</th>
                            <th style="min-width: 150px;">Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="allocation-rules-tbody"></tbody>
                </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <button id="add-alloc-rule-btn" class="btn btn-sm btn-outline-primary"><i class="fas fa-plus me-1"></i>Add Rule</button>
                <button id="save-all-allocations-btn" class="btn btn-success btn-lg">
                    <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                    Save All Allocations
                </button>
            </div>
        </div>

        <div id="room-allocation-list-container" class="ui-card mt-4">
             <h5 class="section-header">3. Current Allocations & Reports</h5>
             <div class="d-flex justify-content-end mb-3">
                 <button id="view-full-allocation-btn" class="btn btn-outline-secondary">
                    <i class="fas fa-users me-2"></i>View Full Allocation Details Report
                 </button>
             </div>
             <div id="current-room-allocations-table"></div>
             <div id="exam-reports-preview" class="mt-4"></div>
        </div>
    `;
    attachAllocationTabListeners();
}

/**
 * Attaches all necessary event listeners for the allocation tab.
 */
function attachAllocationTabListeners() {
    const examSelect = document.getElementById('alloc-exam-select');
    const sessionSelect = document.getElementById('alloc-session-select');
    const rulesGrid = document.getElementById('allocation-rules-grid');
    const rulesTbody = document.getElementById('allocation-rules-tbody');

    const loadDataForSession = () => {
        const examId = examSelect.value;
        const selectedSessions = Array.from(sessionSelect.selectedOptions).map(opt => opt.value);
        updateAllocationStatusSummary(examId, selectedSessions);

        // Clear previous views
        document.getElementById('exam-reports-preview').innerHTML = '';

        if (examId && selectedSessions.length > 0) {
            rulesGrid.classList.remove('d-none');
            rulesTbody.innerHTML = '';
            addAllocationRuleRow();
            const [firstDate, firstSession] = selectedSessions[0].split('_');
            displayCurrentAllocations(examId, firstDate, firstSession);
        } else {
            rulesGrid.classList.add('d-none');
            displayCurrentAllocations(null, null, null);
        }
    };

    examSelect.addEventListener('change', () => {
        const examId = examSelect.value;
        sessionSelect.innerHTML = '';
        if (examId) {
            const uniqueSessions = new Set(examSchedules.filter(s => s.examId === examId).map(s => `${s.date}_${s.session}`));
            Array.from(uniqueSessions).sort().forEach(sessionKey => {
                const [date, session] = sessionKey.split('_');
                const sessionText = session === 'FN' ? 'Forenoon' : 'Afternoon';
                sessionSelect.innerHTML += `<option value="${sessionKey}">${new Date(date).toLocaleDateString('en-GB')} (${sessionText})</option>`;
            });
            sessionSelect.disabled = false;
        } else {
            sessionSelect.innerHTML = '<option>-- Select an Exam First --</option>';
            sessionSelect.disabled = true;
        }
        loadDataForSession();
    });

    sessionSelect.addEventListener('change', loadDataForSession);

    // Delegate events for the dynamic rules table
    rulesTbody.addEventListener('input', recalculateAllocationGrid);
    rulesTbody.addEventListener('change', recalculateAllocationGrid);

    rulesTbody.addEventListener('click', (e) => {
        if (e.target.closest('.remove-rule-btn')) {
            e.target.closest('tr').remove();
            recalculateAllocationGrid();
        }
    });

    document.getElementById('add-alloc-rule-btn').addEventListener('click', addAllocationRuleRow);
    document.getElementById('save-all-allocations-btn').addEventListener('click', saveAllAllocations);

    document.getElementById('view-full-allocation-btn').addEventListener('click', () => {
        const examId = examSelect.value;
        const selectedSessions = Array.from(sessionSelect.selectedOptions).map(opt => opt.value);
        if (!examId || selectedSessions.length === 0) {
            showAlert('Please select an exam and at least one session to view the report.', 'warning');
            return;
        }
        displayFullAllocationDetailsByClass(examId, selectedSessions);
    });
}


/**
 * Adds a new row to the allocation table with several UI enhancements:
 * - Moves the remove button to the left.
 * - Auto-selects the next available exam room.
 * - Auto-fills the next sequential registration number.
 * - Auto-focuses the 'Start Reg No.' input field.
 */
function addAllocationRuleRow() {
    const tbody = document.getElementById('allocation-rules-tbody');
    let nextStartRegNo = '';
    let nextRoomId = null;
    // --- KEY CHANGE IS HERE: Sort exam rooms by roomNumber ---
    const sortedExamRooms = [...examRooms].sort((a, b) => {
        // Ensure roomNumber is treated as a number for correct sorting
        const numA = parseInt(a.roomNumber, 10) || 0;
        const numB = parseInt(b.roomNumber, 10) || 0;
        return numA - numB;
    });

    const lastRow = tbody.querySelector('tr:last-child');
    if (lastRow) {
        // 1. Get the next sequential registration number from the previous row
        const lastEndRegNo = lastRow.querySelector('.end-reg-no').textContent;
        const regNoRegex = /^([A-Z0-9]+)_(\d+)$/;
        const match = lastEndRegNo.match(regNoRegex);
        if (match) {
            const prefix = match[1];
            const nextNum = parseInt(match[2], 10) + 1;
            nextStartRegNo = `${prefix}_${nextNum.toString().padStart(3, '0')}`;
        }

        // 2. Get the next room in the sequence
        const lastRoomId = lastRow.querySelector('.room-select').value;
        const lastRoomIndex = sortedExamRooms.findIndex(r => r.id === lastRoomId);
        if (lastRoomIndex > -1) {
            // Modulo operator (%) ensures it wraps around to the start if at the end
            const nextRoomIndex = (lastRoomIndex + 1) % sortedExamRooms.length;
            nextRoomId = sortedExamRooms[nextRoomIndex].id;
        }
    }


    const newRow = document.createElement('tr');
    
    // Create room options, pre-selecting the next room if available
    const roomOptions = examRooms.map(r => 
        `<option value="${r.id}" data-capacity="${r.capacity}" ${r.id === nextRoomId ? 'selected' : ''}>${r.name}</option>`
    ).join('');

    // 3. Update the HTML structure with the remove button on the left
    newRow.innerHTML = `
        <td><button type="button" class="btn btn-sm btn-outline-danger remove-rule-btn">&times;</button></td>
        <td><select class="form-select form-select-sm room-select">${roomOptions}</select></td>
        <td class="room-capacity text-center align-middle fw-bold"></td>
        <td class="room-remaining text-center align-middle fw-bold"></td>
        <td><input type="text" class="form-control form-control-sm start-reg-no" placeholder="e.g., MV_101" value="${nextStartRegNo}"></td>
        <td><input type="number" class="form-control form-control-sm count" min="1" value="1"></td>
        <td class="available-count text-center align-middle fw-bold"></td>
        <td class="end-reg-no text-muted"></td>
        <td class="status"></td>
    `;
    tbody.appendChild(newRow);

    // 4. Auto-focus the 'Start Reg No.' input field for immediate typing
    const startRegNoInput = newRow.querySelector('.count');
    if (startRegNoInput) {
        startRegNoInput.focus();
    }

    // Refresh the entire grid to update all calculations
    recalculateAllocationGrid();
}

/**
 * Updates the summary card with total, allocated, and balance counts for selected sessions.
 */
async function updateAllocationStatusSummary(examId, selectedSessions) {
    const summaryContainer = document.getElementById('allocation-summary');
    if (!summaryContainer || !examId || selectedSessions.length === 0) {
        summaryContainer.innerHTML = '';
        return;
    }

    let totalSlotsToFill = 0;
    let totalAllocatedSlots = 0;

    for (const sessionKeyString of selectedSessions) {
        const [date, session] = sessionKeyString.split('_');
        const schedulesForSession = examSchedules.filter(s => s.examId === examId && s.date === date && s.session === session);
        let studentsInThisSession = 0;
        schedulesForSession.forEach(schedule => {
            studentsInThisSession += students.filter(student => student.classId === schedule.classId && student.division === schedule.division).length;
        });
        totalSlotsToFill += studentsInThisSession;

        const firestoreSessionKey = `${examId}_${date.replace(/-/g, '')}_${session}`;
        students.forEach(student => {
            if (student.examRoomAllocations?.[firestoreSessionKey]) {
                totalAllocatedSlots++;
            }
        });
    }

    const balance = totalSlotsToFill - totalAllocatedSlots;
    summaryContainer.innerHTML = `
        <div class="row text-center g-3">
            <div class="col"><div class="p-3 border rounded bg-light"><h6 class="text-muted mb-1">Total Slots to Fill</h6><h4 class="fw-bold mb-0">${totalSlotsToFill}</h4></div></div>
            <div class="col"><div class="p-3 border rounded bg-light"><h6 class="text-muted mb-1">Slots Allocated</h6><h4 class="fw-bold mb-0 text-success">${totalAllocatedSlots}</h4></div></div>
            <div class="col"><div class="p-3 border rounded ${balance > 0 ? 'bg-danger text-white' : 'bg-success text-white'}"><h6 class="mb-1">Balance</h6><h4 class="fw-bold mb-0">${balance}</h4></div></div>
        </div>`;
}

/**
 * Recalculates the entire allocation grid, ensuring each row is aware of allocations above it and in the database.
 */
function recalculateAllocationGrid() {
    const examId = document.getElementById('alloc-exam-select').value;
    const selectedSessions = Array.from(document.getElementById('alloc-session-select').selectedOptions).map(opt => opt.value);
    
    const [date, session] = selectedSessions[0] ? selectedSessions[0].split('_') : [null, null];
    if (!date || !session) return;
    
    const sessionKey = `${examId}_${date.replace(/-/g, '')}_${session}`;

    const roomUsageFromDB = {};
    const allocatedRegNosFromDB = new Set();
    students.forEach(student => {
        const roomId = student.examRoomAllocations?.[sessionKey];
        if (roomId) {
            roomUsageFromDB[roomId] = (roomUsageFromDB[roomId] || 0) + 1;
            const regNo = student.examRegNumbers?.[examId];
            if (regNo) allocatedRegNosFromDB.add(regNo);
        }
    });

    const roomUsageInGrid = {};
    const allocatedRegNosInGrid = new Set();

    document.querySelectorAll('#allocation-rules-tbody tr').forEach(row => {
        const combinedAllocatedNos = new Set([...allocatedRegNosFromDB, ...allocatedRegNosInGrid]);
        const result = updateAllocationRow(row, examId, roomUsageInGrid, roomUsageFromDB, combinedAllocatedNos);
        
        if (result.isValid) {
            const roomId = row.querySelector('.room-select').value;
            roomUsageInGrid[roomId] = (roomUsageInGrid[roomId] || 0) + result.count;
            result.regNos.forEach(regNo => allocatedRegNosInGrid.add(regNo));
        }
    });
}

/**
 * Updates a single row's status based on its inputs and the allocations made so far.
 * @returns {object} An object containing the count, regNos, and validity status.
 */
function updateAllocationRow(rowElement, examId, roomUsageInGrid, roomUsageFromDB, combinedAllocatedNos) {
    const roomSelect = rowElement.querySelector('.room-select');
    const capacityCell = rowElement.querySelector('.room-capacity');
    const remainingCell = rowElement.querySelector('.room-remaining');
    const startRegNoInput = rowElement.querySelector('.start-reg-no');
    const countInput = rowElement.querySelector('.count');
    const availableCountCell = rowElement.querySelector('.available-count');
    const endRegNoCell = rowElement.querySelector('.end-reg-no');
    const statusCell = rowElement.querySelector('.status');

    const roomId = roomSelect.value;
    const totalCapacity = parseInt(roomSelect.options[roomSelect.selectedIndex]?.dataset.capacity) || 0;
    capacityCell.textContent = totalCapacity;

    const usedInDB = roomUsageFromDB[roomId] || 0;
    const usedInGridAbove = roomUsageInGrid[roomId] || 0;
    const remainingCapacity = totalCapacity - usedInDB - usedInGridAbove;
    remainingCell.textContent = remainingCapacity;
    remainingCell.className = `room-remaining text-center align-middle fw-bold ${remainingCapacity < 0 ? 'text-danger' : ''}`;
    
    const startRegNo = startRegNoInput.value.trim().toUpperCase();
    const count = parseInt(countInput.value) || 0;
    const regNoRegex = /^([A-Z0-9]+)_(\d+)$/;
    const match = startRegNo.match(regNoRegex);

    if (!match || count <= 0) {
        endRegNoCell.textContent = '';
        statusCell.innerHTML = '';
        availableCountCell.textContent = '';
        return { count: 0, regNos: [], isValid: false };
    }

    const prefix = match[1], startNum = parseInt(match[2], 10);
    const endNum = startNum + count - 1;
    endRegNoCell.textContent = `${prefix}_${endNum.toString().padStart(3, '0')}`;

    const rangeRegNos = Array.from({length: count}, (_, i) => `${prefix}_${(startNum + i).toString().padStart(3, '0')}`);
    
    const alreadyAllocated = rangeRegNos.filter(regNo => combinedAllocatedNos.has(regNo));
    const nonExistent = rangeRegNos.filter(regNo => !students.some(s => s.examRegNumbers?.[examId] === regNo));
    
    const availableCount = count - nonExistent.length - alreadyAllocated.length;
    availableCountCell.textContent = availableCount;
    availableCountCell.className = `available-count text-center align-middle fw-bold ${availableCount < count ? 'text-danger' : 'text-success'}`;

    let statusHtml = '';
    let isValid = true;
    if (count > remainingCapacity) {
        statusHtml = `<span class="badge bg-danger" title="Requires ${count} seats, but only ${remainingCapacity} are free.">Capacity Exceeded</span>`;
        isValid = false;
    } else if (alreadyAllocated.length > 0) {
        statusHtml = `<span class="badge bg-danger" title="Duplicates: ${alreadyAllocated.join(', ')}">${alreadyAllocated.length} Already Allocated</span>`;
        isValid = false;
    } else if (nonExistent.length > 0) {
        statusHtml = `<span class="badge bg-warning text-dark" title="Invalid: ${nonExistent.join(', ')}">${nonExistent.length} Do Not Exist</span>`;
        isValid = false;
    } else {
        statusHtml = `<span class="badge bg-success">OK</span>`;
    }
    statusCell.innerHTML = statusHtml;
    
    const validRegNos = rangeRegNos.filter(regNo => !nonExistent.includes(regNo) && !alreadyAllocated.includes(regNo));
    return { count: validRegNos.length, regNos: validRegNos, isValid };
}
/**
 * Saves all valid allocation rules from the UI to all selected sessions.
 * This is the complete and corrected version.
 */
async function saveAllAllocations() {
    const saveBtn = document.getElementById('save-all-allocations-btn');
    const spinner = saveBtn.querySelector('.spinner-border');
    const examId = document.getElementById('alloc-exam-select').value;
    const selectedSessions = Array.from(document.getElementById('alloc-session-select').selectedOptions).map(opt => opt.value);

    if (!examId || selectedSessions.length === 0) {
        showAlert('Please select an exam and at least one session before saving.', 'warning');
        return;
    }

    const validRows = Array.from(document.querySelectorAll('#allocation-rules-tbody tr'))
        .filter(row => row.querySelector('.status .badge')?.textContent === 'OK');

    if (validRows.length === 0) {
        showAlert('No valid "OK" rules to save. Please fix any errors.', 'info');
        return;
    }

    saveBtn.disabled = true;
    if (spinner) spinner.classList.remove('d-none');

    try {
        const batch = writeBatch(db);
        let totalStudentsAllocated = 0;

        for (const sessionKeyString of selectedSessions) {
            const [date, session] = sessionKeyString.split('_');
            const firestoreSessionKey = `${examId}_${date.replace(/-/g, '')}_${session}`;

            for (const row of validRows) {
                const roomId = row.querySelector('.room-select').value;
                const startRegNo = row.querySelector('.start-reg-no').value.trim().toUpperCase();
                const count = parseInt(row.querySelector('.count').value);
                const regNoRegex = /^([A-Z0-9]+)_(\d+)$/;
                const match = startRegNo.match(regNoRegex);

                if (!match) continue;

                const prefix = match[1];
                const startNum = parseInt(match[2], 10);

                // Find all valid students that match this rule's range
                const studentsToAllocate = [];
                for (let i = 0; i < count; i++) {
                    const regNo = `${prefix}_${(startNum + i).toString().padStart(3, '0')}`;
                    const student = students.find(s => s.examRegNumbers?.[examId] === regNo);
                    if (student && student.id) { // Ensure student is valid
                        studentsToAllocate.push(student);
                    }
                }

                if (studentsToAllocate.length > 0) {
                    // Update each student's record
                    studentsToAllocate.forEach(student => {
                        const studentRef = getDocRef('students', student.id);
                        const updatedAllocations = { ...student.examRoomAllocations, [firestoreSessionKey]: roomId };
                        batch.update(studentRef, { examRoomAllocations: updatedAllocations });
                    });

                    // Only count the students once for the final alert message
                    if (sessionKeyString === selectedSessions[0]) {
                        totalStudentsAllocated += studentsToAllocate.length;
                    }

                    // --- KEY FIX IS HERE ---
                    // 1. Create a reference for a NEW document with an AUTO-GENERATED ID.
                    const newRuleRef = doc(collection(db, `artifacts/${appId}/public/data/examRoomAllocationRules`));
                    
                    // 2. Create the data for the rule, including its own new ID.
                    const ruleData = {
                        id: newRuleRef.id, // Use the new, auto-generated ID
                        examId,
                        date,
                        session,
                        roomId,
                        regNoRangeText: `${startRegNo} - ${row.querySelector('.end-reg-no').textContent}`,
                        allocatedBy: selectedUser.id,
                        allocatedAt: serverTimestamp()
                    };
                    
                    // 3. Add the "set" operation for the new rule to the batch.
                    batch.set(newRuleRef, ruleData);
                }
            }
        }

        if (totalStudentsAllocated > 0) {
            await batch.commit();
            showAlert(`${totalStudentsAllocated} student allocations saved successfully across ${selectedSessions.length} session(s)!`, 'success');
            // Refresh the UI to show the newly saved rules
            document.getElementById('alloc-session-select').dispatchEvent(new Event('change'));
        } else {
            showAlert('No students matched the valid rules provided.', 'warning');
        }
    } catch (error) {
        console.error("Error saving allocations:", error);
        showAlert(`Failed to save allocations. Error: ${error.message}`, 'danger');
    } finally {
        saveBtn.disabled = false;
        if (spinner) spinner.classList.add('d-none');
    }
}

/**
 * Displays the current room allocation RULES for a specific exam session.
 */
/**
 * Displays current room allocation rules for a specific exam session,
 * now sorted by the registration number sequence.
 * @param {string} examId
 * @param {string} date
 * @param {string} session
 */
/**
 * Displays current room allocation rules with bulk-deletion and a "destructive delete" toggle.
 * @param {string} examId
 * @param {string} date
 * @param {string} session
 */
function displayCurrentAllocations(examId, date, session) {
    
    const container = document.getElementById('current-room-allocations-table');
    if (!container || !examId || !date || !session) {
        container.innerHTML = `<p class="text-muted text-center p-4">Select an exam and session to view current allocations.</p>`;
        return;
    }
    const rulesForSession = examRoomAllocationRules.filter(r => r.examId === examId && r.date === date && r.session === session)
        .sort((a, b) => (a.regNoRangeText || '').localeCompare(b.regNoRangeText || '', undefined, { numeric: true }));

    if (rulesForSession.length === 0) {
        container.innerHTML = `<p class="alert alert-info text-center">No allocation rules saved for this session yet.</p>`;
        return;
    }

    // --- NEW: Get other sessions for the "Copy To" dropdown ---
    const otherSessions = [...new Set(examSchedules.filter(s => s.examId === examId).map(s => `${s.date}_${s.session}`))]
        .filter(sKey => sKey !== `${date}_${session}`)
        .sort();



    const sessionKey = `${examId}_${date.replace(/-/g, '')}_${session}`;
    const studentCountsByRule = {};
    rulesForSession.forEach(rule => {
        const affectedRegNos = new Set();
        const [startStr, endStr] = (rule.regNoRangeText || '').split('-').map(s => s.trim());
        const regNoRegex = /^([A-Z0-9]+)_(\d+)$/;
        const startMatch = startStr.match(regNoRegex);
        const endMatch = (endStr || startStr).match(regNoRegex);

        if(startMatch && endMatch && startMatch[1] === endMatch[1]) {
            const prefix = startMatch[1];
            for (let i = parseInt(startMatch[2]); i <= parseInt(endMatch[2]); i++) {
                affectedRegNos.add(`${prefix}_${i.toString().padStart(3, '0')}`);
            }
        }
        
        studentCountsByRule[rule.id] = students.filter(s => 
            affectedRegNos.has(s.examRegNumbers?.[examId]) && s.examRoomAllocations?.[sessionKey] === rule.roomId
        ).length;
    });

    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-hover table-sm" id="allocation-rules-table">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40px;"><input class="form-check-input" type="checkbox" id="select-all-rules"></th>
                        <th>Room</th>
                        <th>Allocation Rule (Reg. No. Range)</th>
                        <th>Students Allocated</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${rulesForSession.map(rule => `
                        <tr>
                            <td><input class="form-check-input rule-select-checkbox" type="checkbox" value="${rule.id}"></td>
                            <td><strong>${examRooms.find(r => r.id === rule.roomId)?.name || 'N/A'}</strong></td>
                            <td><code>${rule.regNoRangeText}</code></td>
                            <td class="text-center">${studentCountsByRule[rule.id] || 0}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-primary" onclick="editAllocationRule('${rule.id}')" title="Edit Rule"><i class="fas fa-pencil-alt"></i></button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <div class="d-flex justify-content-end align-items-center mt-3 p-2 border-top">
            <div class="me-auto d-flex align-items-center">
                <select id="copy-to-session-select" class="form-select form-select-sm me-2" style="width: 250px;">
                    <option value="">-- Copy selected to another session --</option>
                    ${otherSessions.map(sKey => {
                        const [sDate, sSession] = sKey.split('_');
                        return `<option value="${sKey}">${new Date(sDate).toLocaleDateString('en-GB')} (${sSession})</option>`
                    }).join('')}
                </select>
                <button class="btn btn-sm btn-info" id="copy-selected-rules-btn" disabled>Copy</button>
            </div>

            <div class="form-check form-switch me-3">
                <input class="form-check-input" type="checkbox" id="destructive-delete-toggle">
                <label class="form-check-label" for="destructive-delete-toggle">Un-assign Students on Delete</label>
            </div>
            <button class="btn btn-sm btn-danger" id="delete-selected-rules-btn" disabled>
                <i class="fas fa-trash-alt me-2"></i>Delete Selected
            </button>
        </div>
    `;

    // Attach listeners for the bulk-action functionality
    const table = container.querySelector('#allocation-rules-table');
    const selectAll = container.querySelector('#select-all-rules');
    const checkboxes = container.querySelectorAll('.rule-select-checkbox');
    const deleteBtn = container.querySelector('#delete-selected-rules-btn');
    const copyBtn = container.querySelector('#copy-selected-rules-btn');

    const updateButtonState = () => {
        const anyChecked = container.querySelector('.rule-select-checkbox:checked');
        deleteBtn.disabled = !anyChecked;
        copyBtn.disabled = !anyChecked;
    };

    selectAll.addEventListener('change', () => {
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
        updateButtonState();
    });
    checkboxes.forEach(cb => cb.addEventListener('change', updateButtonState));

    deleteBtn.addEventListener('click', () => {
        const selectedRuleIds = Array.from(container.querySelectorAll('.rule-select-checkbox:checked')).map(cb => cb.value);
        const isDestructive = container.querySelector('#destructive-delete-toggle').checked;
        deleteSelectedAllocationRules(selectedRuleIds, isDestructive);
    });

    copyBtn.addEventListener('click', () => {
        const selectedRuleIds = Array.from(container.querySelectorAll('.rule-select-checkbox:checked')).map(cb => cb.value);
        const targetSessionKey = container.querySelector('#copy-to-session-select').value;
        copySelectedAllocationRules(examId,selectedRuleIds, targetSessionKey);
    });

}

/**
 * NEW: Copies selected allocation rules and their student assignments to a new session.
 */
async function copySelectedAllocationRules(examId,ruleIds, targetSessionKey) {
    if (ruleIds.length === 0 || !targetSessionKey) {
        showAlert('Please select one or more rules and a target session to copy to.', 'warning');
        return;
    }

    const [targetDate, targetSession] = targetSessionKey.split('_');
    const targetFirestoreSessionKey = `${examId}_${targetDate.replace(/-/g, '')}_${targetSession}`;

    if (!confirm(`Are you sure you want to copy ${ruleIds.length} rule(s) to the session on ${new Date(targetDate).toLocaleDateString()}? This will also allocate the corresponding students.`)) {
        return;
    }

    const batch = writeBatch(db);
    let totalStudentsAffected = 0;

    for (const ruleId of ruleIds) {
        const originalRule = examRoomAllocationRules.find(r => r.id === ruleId);
        if (!originalRule) continue;

        // Create a new rule for the target session
        const newRuleRef = doc(collection(db, `artifacts/${appId}/public/data/examRoomAllocationRules`));
        const newRuleData = {
            ...originalRule,
            id: newRuleRef.id,
            date: targetDate,
            session: targetSession,
            allocatedAt: serverTimestamp()
        };
        batch.set(newRuleRef, newRuleData);

        // Find and allocate students for the new rule
        const affectedRegNos = new Set();
        const [startStr, endStr] = (originalRule.regNoRangeText || '').split('-').map(s => s.trim());
        const regNoRegex = /^([A-Z0-9]+)_(\d+)$/;
        const startMatch = startStr.match(regNoRegex);
        const endMatch = (endStr || startStr).match(regNoRegex);

        if (startMatch && endMatch && startMatch[1] === endMatch[1]) {
            const prefix = startMatch[1];
            for (let i = parseInt(startMatch[2]); i <= parseInt(endMatch[2]); i++) {
                affectedRegNos.add(`${prefix}_${i.toString().padStart(3, '0')}`);
            }
        }
        
        const studentsToAllocate = students.filter(s => affectedRegNos.has(s.examRegNumbers?.[originalRule.examId]));
        studentsToAllocate.forEach(student => {
            const studentRef = getDocRef('students', student.id);
            const updatedAllocations = { ...student.examRoomAllocations, [targetFirestoreSessionKey]: originalRule.roomId };
            batch.update(studentRef, { examRoomAllocations: updatedAllocations });
        });
        totalStudentsAffected += studentsToAllocate.length;
    }

    try {
        await batch.commit();
        showAlert(`Successfully copied ${ruleIds.length} rule(s) and allocated ${totalStudentsAffected} students to the new session.`, 'success');
        // The real-time listener will refresh the data, but you might want to switch views
        // to the new session to see the results immediately.
    } catch (error) {
        console.error("Error copying allocation rules:", error);
        showAlert('Failed to copy the selected rules. See console for details.', 'danger');
    }
}

/**
 * Deletes selected allocation rules. If 'isDestructive' is true, it also
 * de-allocates all associated students.
 * @param {Array<string>} ruleIds - An array of rule IDs to delete.
 * @param {boolean} isDestructive - Whether to un-assign students.
 */
async function deleteSelectedAllocationRules(ruleIds, isDestructive) {
    if (ruleIds.length === 0) return;

    let confirmMessage = `Are you sure you want to delete ${ruleIds.length} rule(s)?`;
    if (isDestructive) {
        confirmMessage += `\n\nDANGER: You have chosen to also un-assign all students covered by these rules. This action cannot be undone.`;
    }

    if (!confirm(confirmMessage)) return;

    const batch = writeBatch(db);
    let totalStudentsAffected = 0;

    for (const ruleId of ruleIds) {
        const rule = examRoomAllocationRules.find(r => r.id === ruleId);
        if (!rule) continue;

        // If in destructive mode, find and de-allocate all affected students
        if (isDestructive) {
            const { examId, date, session, regNoRangeText } = rule;
            const sessionKey = `${examId}_${date.replace(/-/g, '')}_${session}`;
            const affectedRegNos = new Set();
            const [startStr, endStr] = (regNoRangeText || '').split('-').map(s => s.trim());
            const regNoRegex = /^([A-Z0-9]+)_(\d+)$/;
            const startMatch = startStr.match(regNoRegex);
            const endMatch = (endStr || startStr).match(regNoRegex);

            if (startMatch && endMatch && startMatch[1] === endMatch[1]) {
                const prefix = startMatch[1];
                for (let i = parseInt(startMatch[2]); i <= parseInt(endMatch[2]); i++) {
                    affectedRegNos.add(`${prefix}_${i.toString().padStart(3, '0')}`);
                }
            }
            
            const studentsToDeallocate = students.filter(s => 
                affectedRegNos.has(s.examRegNumbers?.[examId]) && 
                s.examRoomAllocations?.[sessionKey] === rule.roomId
            );

            studentsToDeallocate.forEach(student => {
                const studentRef = getDocRef('students', student.id);
                let updatedAllocations = { ...student.examRoomAllocations };
                delete updatedAllocations[sessionKey];
                batch.update(studentRef, { examRoomAllocations: updatedAllocations });
            });
            totalStudentsAffected += studentsToDeallocate.length;
        }
        
        // Always delete the rule document itself
        batch.delete(getDocRef('examRoomAllocationRules', ruleId));
    }

    try {
        await batch.commit();
        let successMessage = `${ruleIds.length} rule(s) deleted successfully.`;
        if (isDestructive && totalStudentsAffected > 0) {
            successMessage += ` ${totalStudentsAffected} student allocations were removed.`;
        }
        showAlert(successMessage, 'success');
        // The real-time listener will refresh the data and UI automatically.
        const examSelect = document.getElementById('alloc-exam-select');
        const sessionSelect = document.getElementById('alloc-session-select');
        const selectedSessions = Array.from(sessionSelect.selectedOptions).map(opt => opt.value);
        const [firstDate, firstSession] = selectedSessions[0].split('_');

        displayCurrentAllocations(examId, firstDate, firstSession);
Â  Â  Â  Â  updateAllocationStatusSummary(examId, [firstDate + '_' + firstSession]);


    } catch (error) {
        console.error("Error deleting allocation rules:", error);
        showAlert('Failed to delete the selected rules. See console for details.', 'danger');
    }
}
/**
 * Displays a detailed, student-wise allocation report with checkboxes for bulk removal.
 * @param {string} examId The ID of the exam.
 * @param {string[]} selectedSessions An array of selected session strings.
 */
/**
/**
 * Displays a detailed, student-wise allocation report for all classes on a given day,
 * with checkboxes for bulk removal and properly attached event listeners.
 */
function displayFullAllocationDetailsByClass(examId, selectedSessions) {
    const container = document.getElementById('exam-reports-preview');
    if (!container) return;
    const [date, ] = selectedSessions[0].split('_');

    if (!examId || !date) {
        container.innerHTML = `<p class="alert alert-info text-center mt-3">Please select an Exam and Date.</p>`;
        return;
    }

    const fnSessionKey = `${examId}_${date.replace(/-/g, '')}_FN`;
    const anSessionKey = `${examId}_${date.replace(/-/g, '')}_AN`;

    const allocatedStudents = students.filter(s => s.examRoomAllocations && (s.examRoomAllocations[fnSessionKey] || s.examRoomAllocations[anSessionKey]));

    if (allocatedStudents.length === 0) {
        container.innerHTML = `<p class="alert alert-info text-center mt-3">No students allocated for the selected date.</p>`;
        return;
    }

    const studentsByClass = allocatedStudents.reduce((acc, student) => {
        (acc[student.classId] = acc[student.classId] || []).push(student);
        return acc;
    }, {});

    const sortedClassIds = Object.keys(studentsByClass).sort((a, b) => (classes.find(c => c.id === a)?.name || '').localeCompare(classes.find(c => c.id === b)?.name || ''));

    let reportHtml = `<h4 class="text-center mt-4">Full Allocation Details for ${new Date(date).toLocaleDateString('en-GB')}</h4>`;

    sortedClassIds.forEach(classId => {
        const className = classes.find(c => c.id === classId)?.name || classId;
        const studentsInClass = studentsByClass[classId].sort((a, b) => (a.examRegNumbers?.[examId] || '').localeCompare(b.examRegNumbers?.[examId] || ''));

        reportHtml += `
            <div class="mt-4">
                <h5 class="section-header">${className}</h5>
                <div class="table-responsive">
                    <table class="table table-bordered table-sm table-striped" id="class-table-${classId}">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 40px;"><input class="form-check-input" type="checkbox" title="Select All in this Class"></th>
                                <th>Reg. No</th>
                                <th>Student Name</th>
                                <th>Forenoon Room</th>
                                <th>Afternoon Room</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${studentsInClass.map(student => {
                                const fnRoomId = student.examRoomAllocations[fnSessionKey];
                                const anRoomId = student.examRoomAllocations[anSessionKey];
                                let fnCellHtml = fnRoomId ? `<div class="d-flex align-items-center"><input class="form-check-input student-alloc-checkbox me-2" type="checkbox" value="${student.id}__FN"><span>${examRooms.find(r => r.id === fnRoomId)?.name || fnRoomId}</span></div>` : 'â€“';
                                let anCellHtml = anRoomId ? `<div class="d-flex align-items-center"><input class="form-check-input student-alloc-checkbox me-2" type="checkbox" value="${student.id}__AN"><span>${examRooms.find(r => r.id === anRoomId)?.name || anRoomId}</span></div>` : 'â€“';
                                
                                return `<tr>
                                    <td>${student.admissionNumber || 'N/A'}</td>
                                    <td>${student.examRegNumbers?.[examId] || 'N/A'}</td>
                                    <td>${student.name}</td>
                                    <td>${fnCellHtml}</td>
                                    <td>${anCellHtml}</td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                        <tfoot>
                            <tr><td colspan="5" class="text-end">
                                <button class="btn btn-sm btn-danger remove-selected-btn" data-class-id="${classId}">
                                    <i class="fas fa-trash-alt me-2"></i>Remove Selected from ${className}
                                </button>
                            </td></tr>
                        </tfoot>
                    </table>
                </div>
            </div>`;
    });
    container.innerHTML = reportHtml;

    // --- Add Event Listeners After Rendering ---
    container.querySelectorAll('thead .form-check-input').forEach(headerCheckbox => {
        headerCheckbox.addEventListener('change', (e) => {
            e.target.closest('table').querySelectorAll('tbody .student-alloc-checkbox').forEach(cb => cb.checked = e.target.checked);
        });
    });

    container.querySelectorAll('.remove-selected-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const classId = e.target.dataset.classId;
            // Correctly call the global function
            window.removeSelectedAllocations(classId, examId, date);
        });
    });
}


/**
 * Removes all selected student allocations for a specific class from the database
 * and ensures the local data is updated instantly for a reliable UI refresh.
 * @param {string} classId The ID of the class table to process.
 * @param {string} examId The ID of the current exam.
 * @param {string} date The date of the allocations (YYYY-MM-DD).
 */
window.removeSelectedAllocations = async function(classId, examId, date) {
    const table = document.getElementById(`class-table-${classId}`);
    if (!table) return;

    const selectedCheckboxes = table.querySelectorAll('tbody .student-alloc-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        showAlert('No students selected to remove.', 'info');
        return;
    }

    if (!confirm(`Are you sure you want to remove ${selectedCheckboxes.length} selected allocation(s)? This action cannot be undone.`)) {
        return;
    }

    const batch = writeBatch(db);
    // Create a temporary map to track which students and sessions are being updated
    const studentsToUpdateLocally = new Map();

    selectedCheckboxes.forEach(checkbox => {
        const [studentId, session] = checkbox.value.split('__');
        const student = students.find(s => s.id === studentId);
        
        if (student) {
            const sessionKey = `${examId}_${date.replace(/-/g, '')}_${session}`;
            const studentRef = getDocRef('students', student.id);
            
            // This correctly removes the single, unique key for that session from a copy of the object
            let updatedAllocations = { ...student.examRoomAllocations };
            delete updatedAllocations[sessionKey];

            batch.update(studentRef, { examRoomAllocations: updatedAllocations });

            // Store the planned update for our local data refresh
            studentsToUpdateLocally.set(studentId, updatedAllocations);
        }
    });

    try {
        // 1. Commit changes to the database
        await batch.commit();
        showAlert(`${selectedCheckboxes.length} allocation(s) removed successfully.`, 'success');
        
        // --- KEY FIX IS HERE ---
        // 2. Manually update the local 'students' array immediately.
        // This avoids waiting for the real-time listener and prevents the refresh error.
        studentsToUpdateLocally.forEach((newAllocations, studentId) => {
            const studentIndex = students.findIndex(s => s.id === studentId);
            if (studentIndex > -1) {
                // Directly mutate the student object in the global array
                students[studentIndex].examRoomAllocations = newAllocations;
            }
        });

        // 3. Now, refresh the view with the guaranteed-to-be-correct local data.
        displayFullAllocationDetailsByClass(examId, date);

    } catch (error) {
        console.error("Error removing selected allocations:", error);
        showAlert('Failed to remove allocations. See console for details.', 'danger');
    }
};

/**
 * Removes a single student's room allocation for a specific session.
 * This is a window function to be accessible from onclick attributes.
 * @param {string} studentId - The ID of the student to update.
 * @param {string} examId - The ID of the current exam.
 * @param {string} date - The date of the session (YYYY-MM-DD).
 * @param {string} session - The session identifier ('FN' or 'AN').
 */
window.removeStudentAllocation = async (studentId, examId, date, session) => {
    // 1. Confirm the action with the user
    if (!confirm("Are you sure you want to remove this student's room allocation for this session?")) {
        return;
    }

    const student = students.find(s => s.id === studentId);
    if (!student) {
        showAlert('Student not found.', 'danger');
        return;
    }

    // 2. Prepare the data for the update
    const sessionKey = `${examId}_${date.replace(/-/g, '')}_${session}`;
    const studentRef = getDocRef('students', student.id);
    
    // Create a new map of allocations, omitting the one to be removed
    let updatedAllocations = { ...student.examRoomAllocations };
    delete updatedAllocations[sessionKey];

    try {
        // 3. Update the student's document in Firestore
        await updateDoc(studentRef, { examRoomAllocations: updatedAllocations });
        showAlert('Student room allocation removed successfully.', 'success');

        // 4. Refresh the UI to reflect the change
        // Note: The real-time listener will update the 'students' array automatically,
        // but calling these ensures the UI refreshes instantly.
        const examSelect = document.getElementById('alloc-exam-select');
        const sessionSelect = document.getElementById('alloc-session-select');
        const selectedSessions = Array.from(sessionSelect.selectedOptions).map(opt => opt.value);

        displayFullAllocationDetailsByClass(examId, selectedSessions);
        updateAllocationStatusSummary(examId, selectedSessions);
        
    } catch (error) {
        console.error("Error removing student allocation:", error);
        showAlert('Failed to remove allocation. See console for details.', 'danger');
    }
};
/**
 * Deletes an allocation rule and de-allocates all associated students from that room for that session.
 * @param {string} ruleId The ID of the examRoomAllocationRules document.
 */
window.deleteAllocationRule = async (ruleId) => {
    if (!confirm('Are you sure you want to delete this rule? This will remove the room assignment for all students covered by it.')) return;

    const rule = examRoomAllocationRules.find(r => r.id === ruleId);
    if (!rule) {
        showAlert('Allocation rule not found.', 'danger');
        return;
    }

    const { examId, date, session, regNoRangeText } = rule;
    const sessionKey = `${examId}_${date.replace(/-/g, '')}_${session}`;
    const affectedRegNos = new Set();
    const [startStr, endStr] = regNoRangeText.split('-').map(s => s.trim());
    const regNoRegex = /^([A-Z0-9]+)_(\d+)$/;
    const startMatch = startStr.match(regNoRegex);
    const endMatch = endStr.match(regNoRegex);
    if(startMatch && endMatch && startMatch[1] === endMatch[1]) {
        const prefix = startMatch[1];
        for (let i = parseInt(startMatch[2]); i <= parseInt(endMatch[2]); i++) {
            affectedRegNos.add(`${prefix}_${i.toString().padStart(3, '0')}`);
        }
    }

    const studentsToDeallocate = students.filter(s => affectedRegNos.has(s.examRegNumbers?.[examId]));
    const batch = writeBatch(db);

    studentsToDeallocate.forEach(student => {
        const studentRef = getDocRef('students', student.id);
        let updatedAllocations = { ...student.examRoomAllocations };
        delete updatedAllocations[sessionKey];
        batch.update(studentRef, { examRoomAllocations: updatedAllocations });
    });
    batch.delete(getDocRef('examRoomAllocationRules', ruleId));
    try {
        await batch.commit();
        showAlert('Allocation rule and student assignments successfully removed.', 'success');
        // The real-time listener will refresh data, but this ensures instant UI update
        displayCurrentAllocations(examId, date, session);
        updateAllocationStatusSummary(examId, [date + '_' + session]);
    } catch (error) {
        console.error("Error deleting allocation rule:", error);
        showAlert('Failed to delete the rule. See console for details.', 'danger');
    }
};

/**
 * Prepares the UI for editing an allocation rule by repopulating the input grid with its values.
 * This version does NOT delete the old rule, promoting a safer "review and save" workflow.
 * @param {string} ruleId The ID of the rule to edit.
 */
window.editAllocationRule = (ruleId) => {
    const rule = examRoomAllocationRules.find(r => r.id === ruleId);
    if (!rule) return;

    window.scrollTo({ top: 0, behavior: 'smooth' });

    const tbody = document.getElementById('allocation-rules-tbody');
    let targetRow = Array.from(tbody.querySelectorAll('tr')).find(row => !row.querySelector('.start-reg-no').value);
    if (!targetRow) {
        addAllocationRuleRow();
        targetRow = tbody.lastElementChild;
    }

    targetRow.querySelector('.room-select').value = rule.roomId;
    
    const [startStr, endStr] = rule.regNoRangeText.split('-').map(p => p.trim());
    targetRow.querySelector('.start-reg-no').value = startStr;

    const regNoRegex = /^([A-Z0-9]+)_(\d+)$/;
    const startMatch = startStr.match(regNoRegex);
    const endMatch = endStr.match(regNoRegex);
    
    if (startMatch && endMatch) {
        const count = parseInt(endMatch[2]) - parseInt(startMatch[2]) + 1;
        targetRow.querySelector('.count').value = count > 0 ? count : 1;
    } else {
        targetRow.querySelector('.count').value = 1;
    }

    recalculateAllocationGrid();
    showAlert(`Editing rule for room ${examRooms.find(r=>r.id===rule.roomId)?.name}. Please review, make changes, and click "Save All Allocations". The original rule will be deleted upon saving.`, 'info');
};


// Local variables to store selected filters for Hall Ticket generation
let hallTicketClassId = null;
let hallTicketDivision = null;
let hallTicketExamId = null; // Added this variable for Hall Ticket's exam selection



        /**
 * Displays the list of students for Hall Ticket generation.
 * @param {string} examId - The selected Exam ID.
 * @param {string} classId - The selected Class ID.
 * @param {string} division - The selected Division.
 * @returns {Array<object>} The filtered list of student objects.
 */
function displayHallTicketStudentList(examId, classId, division) {
    const container = document.getElementById('hall-ticket-student-list-container');
    if (!container || !examId || !classId || !division) {
        container.innerHTML = `<p class="text-muted text-center p-4">Select an exam, class and division to load students.</p>`;
        return []; // Return empty array if filters are incomplete
    }

    // Filter students by class, division AND if they have a reg number for the selected exam
    const studentsForHT = students.filter(s =>
        s.classId === classId &&
        s.division === division &&
        s.examRegNumbers?.[examId] // Student must have a reg number for this exam
    ).sort((a, b) => {
        // Sort by exam registration number for the selected exam
        const regNoA = a.examRegNumbers[examId] || '';
        const regNoB = b.examRegNumbers[examId] || '';
        return regNoA.localeCompare(regNoB, undefined, { numeric: true });
    });

    if (studentsForHT.length === 0) {
        container.innerHTML = `<p class="alert alert-info text-center">No students found in this class/division with an assigned Exam Reg. No. for the selected exam.</p>`;
        return []; // Return empty array
    }

    let tableHtml = `
        <h5>Students in ${classes.find(c => c.id === classId)?.name || ''} - ${division} for Exam: ${exams.find(e=>e.id===examId)?.name || examId}</h5>
        <div class="table-responsive">
            <table class="table table-bordered table-sm">
                <thead><tr><th>Student Name</th><th>Admn No.</th><th>Exam Reg. No.</th><th>Assigned Room(s)</th><th>Actions</th></tr></thead>
                <tbody>
                    ${studentsForHT.map(student => {
                        const examRegNoDisplay = student.examRegNumbers?.[examId] || 'N/A';
                        
                        // Filter room allocations specifically for the selected exam
                        const relevantRoomAllocations = Object.keys(student.examRoomAllocations || {})
                            .filter(sessionKey => sessionKey.startsWith(`${examId}_`)); // Filter by current examId

                        const roomAllocDisplay = relevantRoomAllocations.length > 0
                            ? relevantRoomAllocations.map(sessionKey => {
                                const [examIdFromKey, dateRaw, session] = sessionKey.split('_');
                                const roomName = examRooms.find(r => r.id === student.examRoomAllocations[sessionKey])?.name || student.examRoomAllocations[sessionKey];
                                const formattedDate = new Date(dateRaw.slice(0,4) + '-' + dateRaw.slice(4,6) + '-' + dateRaw.slice(6,8)).toLocaleDateString('en-GB');
                                return `${formattedDate} (${session}): ${roomName}`;
                            }).join('<br>')
                            : 'N/A';

                        return `
                            <tr>
                                <td>${student.name}</td>
                                <td>${student.admissionNumber}</td>
                                <td>${examRegNoDisplay}</td>
                                <td>${roomAllocDisplay}</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-info" onclick="window.showSingleHallTicketModal('${student.id}', '${examId}')">View/Print</button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
    container.innerHTML = tableHtml;

    // --- CRITICAL CHANGE: Return the filtered list of students ---
    return studentsForHT;
}

// Helper to show a single hall ticket in a modal (now internal)
        window. showSingleHallTicketModal=(studentId, examId)=> {
            const modalBody = document.getElementById('hall-ticket-modal-body');
            if (!modalBody) return;

            modalBody.innerHTML = generateSingleHallTicketHTML(studentId, examId); // Pass examId to generator
            const hallTicketModal = new bootstrap.Modal(document.getElementById('hallTicketModal'));
            hallTicketModal.show();
        };

        


        function generateSingleHallTicketHTML(studentId, examId) {
            const student = students.find(s => s.id === studentId);
            const exam = exams.find(e => e.id === examId);

            if (!student || !exam) return `<p class="alert alert-danger">Student or Exam details not found.</p>`;

            const studentClass = classes.find(c => c.id === student.classId);
            const className = studentClass?.name || 'N/A';

            let examScheduleHtml = '';
            // Filter schedules for this specific student, class, division AND the selected exam
            const relevantSchedules = examSchedules.filter(sch =>
                sch.examId === examId && // Filter by selected exam
                sch.classId === student.classId &&
                sch.division === student.division
            ).sort((a, b) => {
  // Primary: sort by date
  const dateDiff = new Date(a.date) - new Date(b.date);
  if (dateDiff !== 0) return dateDiff;

  // Secondary: custom session order
  const order = { FN: 0, AN: 1 }; // Lower number comes first
  return order[a.session] - order[b.session];
});


            relevantSchedules.forEach(schedule => {
                const subjectName = subjects.find(s => s.id === schedule.subjectId)?.name || schedule.subjectId;
                const classTeacher = teachers.find(s => s.classCharge === schedule.classId&&s.division===schedule.division)?.name || 'iqbal c';
                const examDate = new Date(schedule.date).toLocaleDateString('en-GB');
                const examDay = new Date(schedule.date).toLocaleString('en-GB', { weekday: 'long' });

                const session = schedule.session === 'FN' ? 'Forenoon' : 'Afternoon';
                
                const sessionKey = `${schedule.examId}_${schedule.date.replace(/-/g, '')}_${schedule.session}`;
                const allocatedRoomId = student.examRoomAllocations?.[sessionKey];
                const roomName = examRooms.find(r => r.id === allocatedRoomId)?.name || allocatedRoomId || 'N/A';
                
                examScheduleHtml += `
                    <tr>
                        <td >${subjectName}</td>
                        <td >${examDate}/( ${examDay} )</td>
                        <td class="text-center">${session}</td>
                        <td class="text-center">${''}</td>
                    </tr>
                `;
            });
            const classTeacher = teachers.find(t => t.classCharge?.classId === student.classId && t.classCharge?.division === student.division)?.name || 'Not Assigned';

            const studentPhotoSrc = student.photoDriveId
                ? `https://drive.google.com/thumbnail?id=${student.photoDriveId}&sz=400`
                : 'https://placehold.co/100x120?text=Photo';

            const hmSignPng = schoolDetails.hmSignPng || 'https://via.placeholder.com/100x50?text=HM+Sign';
            const schoolSealPng = schoolDetails.schoolSealPng || 'https://via.placeholder.com/100x100?text=School+Seal';

            return `
                <div class="hall-ticket-page">
                    <div style="position: relative; top: 0; left: 0; width:21cm; min-height:27cm; height: 27cm; border: 2px solid #333; box-sizing: border-box; padding: 5mm;">
                        <div class="text-center mb-4">
                            ${schoolDetails.logoUrl ? `<img src="${schoolDetails.logoUrl}" alt="School Logo" style="max-height: 70px; margin-bottom: 0.5rem;">` : ''}
                            <h4 class="mb-0 text-primary">${schoolDetails.address.toUpperCase() || 'School Name'}</h4>
                            <p class="text-muted" style="font-size: 0.8em; margin-bottom: 5px;">${schoolDetails.name || 'School Address'}</p>
                            <h5 class="mt-2 p-2 text-white text-uppercase fw-bold d-block mx-auto" 
    style="background-color: black; border-radius: 4px; width: fit-content;">
  HALL TICKET
</h5>
<h5 class="mt-0" style="font-weight: bold;">${exam.name} Examination (25-26)</h5>
                        </div>
                        
                        <div class="row mb-4 align-items-center">
                            <div class="col-8 tabledetails">
                                <table class="table table-sm table-borderless" style="font-size: 0.9em;">
                                    <tbody>
                                        <tr><th colspan="2" class="text-center">Exam Reg. No. ${student.examRegNumbers?.[examId] || 'Not Assigned'}</th></tr>
                                
                                        <tr><th style="width: 120px;">Student Name</th><td>: ${student.name}</td></tr>
                                        <tr><th>Admission No</th><td>: ${student.admissionNumber || 'N/A'}</td></tr>
                                        <tr><th>Class / Div</th><td>: ${className} - ${student.division || 'N/A'}</td></tr>
                                        <tr><th colspan="2">Signature of the Student ................ </th></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-4 text-center">
                                <img src="${studentPhotoSrc}"
                                        alt="Student Photo" class="img-thumbnail" style="width: 150px; height: 200px; object-fit: cover; border: 1px solid #ccc; background-color: #f8f8f8;">
                                <p class="mt-1 mb-0" style="font-size: 0.7em;">(Student Photo)</p>
                            </div>
                        </div>

                        <h6 class="text-info border-bottom pb-1 mb-2" style="font-weight: bold;">Examination Schedule</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm" style="font-size: 0.85em;">
                                <thead>
                                    <tr>
                                        <th class="text-center">Subject</th>
                                        <th class="text-center">Date</th>
                                        <th class="text-center">Session</th>
                                        <th class="text-center">Invigilator Sign</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${examScheduleHtml || '<tr><td colspan="4" class="text-muted text-center">No exams scheduled for this student.</td></tr>'}
                                </tbody>
                            </table>
                        </div>

                        <div class="row mt-9" style="position: absolute; bottom: 10mm; left: 5mm; right: 5mm; font-size: 0.85em;">
                            <div class="col-4 text-center">
                                <img src="sign3.jpg" alt="HM Sign" style="max-height: 80px; opacity: 0.7;"><br>
                                <hr class="mx-auto w-50 my-1">
                                <p>Signature of H.M. / Principal</p>
                            </div>
                            <div class="col-4 text-center">
                                <img src="SEAL.jpg" alt="School Seal" style="max-height: 90px; opacity: 0.8;"><br>
                                <p class="mt-1">School Seal</p>
                            </div>
                            <div class="col-4 text-center">
                                <br>
                                <hr class="mx-auto w-50 my-1">
                                <span style="gap:0px;">
                                    <p  class="mx-auto w-90 my-1">Signature of classTeacher</p>
                                    <p class="mt-0">(${classTeacher})</p>
                                </span>
                            </div>
                        </div>
                        <div class="text-center text-muted" style="position: absolute; bottom: 0px; left: 0; right: 0; font-size: 0.75em;">
                           <p>KATTILANGADI YATHEEMKHANA HIGHER SECONDARY SCHOOL ATHAVANAD, MOB: 9447570250 GMAIL: KYHSSCHOOL@GMAIL.COM</p>
                        </div>

                        <div class="text-center text-muted" style="position: absolute; bottom: -10px; left: 0; right: 0; font-size: 0.75em;">
                            <p>Generated on: ${new Date().toLocaleDateString('en-GB', { dateStyle: 'long' })} | Exam Control Module</p>
                        </div>
                    </div>
                </div>
            `;
        }
        // // Initialize the module when the DOM is ready
        // document.addEventListener('DOMContentLoaded', () => {
        //     renderExamControlModule();
        // });
// Re-use currentUserDuty variable and checkCurrentUserDuty helper
// These are assumed to be available globally or moved to a utility scope.


window.renderExamReportsModule = () => {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) return;

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Exam Reports & Analysis</h1>
        <ul class="nav nav-tabs" id="examReportsTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#exam-reports-toppers" type="button">Overall Toppers</button>
            </li>
            
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#exam-reports-subject-toppers" type="button">Subject Toppers</button>
            </li>

            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#exam-reports-grade-dist" type="button">Grade Distribution</button>
            </li>
        </ul>
        <div class="tab-content card" id="examReportsTabContent">
            <div class="tab-pane fade show active p-4" id="exam-reports-toppers" role="tabpanel"></div>
            
            <div class="tab-pane fade p-4" id="exam-reports-subject-toppers" role="tabpanel"></div>

            <div class="tab-pane fade p-4" id="exam-reports-grade-dist" role="tabpanel"></div>
        </div>
    `;

    // Render content for each sub-tab
    renderExamReportsToppersTab();
    renderSubjectToppersTab(); // <-- Call the new function
    renderExamReportsGradeDistributionTab();

    // Attach listener for tab changes
    document.querySelectorAll('#examReportsTab .nav-link').forEach(tab => {
        tab.addEventListener('shown.bs.tab', (event) => {
            const targetId = event.target.dataset.bsTarget;
            switch(targetId) {
                case '#exam-reports-toppers': renderExamReportsToppersTab(); break;
                case '#exam-reports-subject-toppers': renderSubjectToppersTab(); break; // <-- Handle new tab
                case '#exam-reports-grade-dist': renderExamReportsGradeDistributionTab(); break;
            }
        });
    });
};

/**
 * Renders the Subject Toppers tab content and filters.
 */
function renderSubjectToppersTab() {
    const container = document.getElementById('exam-reports-subject-toppers');
    if (!container) return;

    container.innerHTML = `
        <div class="ui-card mb-4">
            <h5 class="section-header">Subject-wise Toppers (Top 3 Positions)</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label">Select Exam</label>
                    <select id="subject-toppers-exam-select" class="form-select">
                        <option value="">-- Select Exam --</option>
                        ${exams.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}
                    </select>
                </div>
            </div>
        </div>
        <div id="subject-toppers-display-container" class="mt-4">
            <p class="text-muted text-center p-4">Select an exam to view subject-wise toppers.</p>
        </div>
    `;

    const examSelect = document.getElementById('subject-toppers-exam-select');
    examSelect.addEventListener('change', () => {
        displaySubjectWiseToppers(examSelect.value);
    });

    // Initial load
    if (exams.length > 0) {
        examSelect.value = exams[0].id;
        displaySubjectWiseToppers(examSelect.value);
    }
}
/**
 * Calculates and displays the top 3 students for each subject in an exam.
 * @param {string} examId
 */
function displaySubjectWiseToppers(examId) {
    const container = document.getElementById('subject-toppers-display-container');
    if (!container) return;
    if (!examId) {
        container.innerHTML = `<p class="text-muted text-center p-4">Select an exam to view subject-wise toppers.</p>`;
        return;
    }

    container.innerHTML = `<div class="text-center p-4"><div class="spinner-border"></div><p>Calculating subject toppers...</p></div>`;

    const schedulesForExam = examSchedules.filter(s => s.examId === examId);
    const uniqueSubjectIds = [...new Set(schedulesForExam.map(s => s.subjectId))];

    if (uniqueSubjectIds.length === 0) {
        container.innerHTML = `<p class="alert alert-info text-center">No subjects are scheduled for this exam.</p>`;
        return;
    }

    let subjectToppersHtml = `
        <div class="text-end mb-3 no-print">
            <button id="print-subject-toppers-btn" class="btn btn-secondary">
                <i class="fas fa-print me-2"></i>Print Subject Toppers
            </button>
        </div>
    `;

    uniqueSubjectIds.forEach(subjectId => {
        const subject = subjects.find(s => s.id === subjectId);
        if (!subject) return;

        // Get all marks for this specific subject in this exam
        const subjectMarks = [];
        students.forEach(student => {
            const markId = `${examId}_${student.id}_${subjectId}`;
            if (marks[markId]) {
                const mark = marks[markId];
                const schedule = schedulesForExam.find(s => s.subjectId === subjectId && s.classId === student.classId && s.division === student.division);
                if (schedule) {
                    const total = (mark.te === 'AB' || mark.ce === 'AB') ? -1 : (Number(mark.te) || 0) + (Number(mark.ce) || 0);
                    const maxTotal = (schedule.maxTE || 0) + (schedule.maxCE || 0);
                    const grade = calculateGrade(total, maxTotal);

                    // Add to list only if they did not fail this specific subject
                    if (grade !== 'E' && grade !== 'F' && total !== -1) {
                        subjectMarks.push({
                            studentName: student.name,
                            photoDriveId: student.photoDriveId,
                            total,
                            maxTotal
                        });
                    }
                }
            }
        });

        // Sort by total marks (descending) and get top 3
        const toppers = subjectMarks.sort((a, b) => b.total - a.total).slice(0, 3);

        if (toppers.length > 0) {
            subjectToppersHtml += `
                <div class="ui-card mb-4 printable-section">
                    <h6 class="section-header text-primary">${subject.name}</h6>
                    <ul class="list-group list-group-flush">
                        ${toppers.map((topper, index) => `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="fw-bold me-2">#${index + 1}</span>
                                    ${topper.studentName}
                                </div>
                                <span class="badge bg-success rounded-pill">${topper.total} / ${topper.maxTotal}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }
    });

    if (subjectToppersHtml.includes('ui-card')) {
        container.innerHTML = subjectToppersHtml;
        document.getElementById('print-subject-toppers-btn').addEventListener('click', () => {
            const exam = exams.find(e => e.id === examId);
            printContentOfDiv('subject-toppers-display-container', `Subject Toppers - ${exam.name}`);
        });
    } else {
        container.innerHTML = `<p class="alert alert-info text-center">No results found to determine subject toppers.</p>`;
    }
}
/**
 * Renders the Exam Toppers tab content.
 */
function renderExamReportsToppersTab() { // Renamed from renderExamControlToppersTab
    const container = document.getElementById('exam-reports-toppers'); // Updated ID
    if (!container) return;


    container.innerHTML = `
        <div class="ui-card mb-4">
            <h5 class="section-header">Exam Toppers (Top 4 Positions)</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label">Select Exam</label>
                    <select id="toppers-exam-select" class="form-select">
                        <option value="">-- Select Exam --</option>
                        ${exams.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}
                    </select>
                </div>
                 <div class="col-md-6">
                    <label class="form-label">Grading System (for percentages)</label>
                    <select id="toppers-grading-system" class="form-select">
                        <option value="type1">A+, A, B+, B...</option>
                        <option value="type2">O, A, B, C...</option>
                    </select>
                </div>
            </div>
        </div>
        <div id="toppers-display-container" class="mt-4">
            <p class="text-muted text-center p-4">Select an exam to view toppers.</p>
        </div>
    `;

    const examSelect = document.getElementById('toppers-exam-select');
    const gradingSystemSelect = document.getElementById('toppers-grading-system');

    const generateToppers = () => {
        const examId = examSelect.value;
        const gradingSystem = gradingSystemSelect.value;
        if (examId) {
            displayClassWiseToppers(examId, gradingSystem);
        } else {
            document.getElementById('toppers-display-container').innerHTML = `<p class="text-muted text-center p-4">Select an exam to view toppers.</p>`;
        }
    };

    examSelect.addEventListener('change', generateToppers);
    gradingSystemSelect.addEventListener('change', generateToppers);

    // Initial load
    if (exams.length > 0) {
        examSelect.value = exams[0].id;
        generateToppers();
    }
}


/**
 * Displays class-wise toppers for a selected exam.
 * @param {string} examId
 * @param {string} gradingSystem
 */
/**
 * Displays class-wise toppers for a selected exam.
 * @param {string} examId
 * @param {string} gradingSystem
 */
/**
 * Displays class-wise toppers for a selected exam.
 * @param {string} examId
 * @param {string} gradingSystem
 */
function displayClassWiseToppers(examId, gradingSystem) {
    const container = document.getElementById('toppers-display-container');
    if (!container) return;

    container.innerHTML = `<div class="text-center p-4"><div class="spinner-border"></div><p>Calculating toppers...</p></div>`;

    // Group students by class and division
    const studentsByClassDiv = students.reduce((acc, student) => {
        const key = `${student.classId}-${student.division}`;
        if (!acc[key]) {
            acc[key] = {
                classId: student.classId,
                division: student.division,
                students: []
            };
        }
        acc[key].students.push(student);
        return acc;
    }, {});

    let toppersHtml = `
        <div class="text-end mb-3 no-print">
            <button id="print-toppers-report-btn" class="btn btn-secondary">
                <i class="fas fa-print me-2"></i>Print Toppers List
            </button>
        </div>
    `;

    // --- COMPLETED: Sorts classes numerically, then divisions alphabetically ---
    const sortedClassDivKeys = Object.keys(studentsByClassDiv).sort((a, b) => {
        const [classA, divA] = a.split('-');
        const [classB, divB] = b.split('-');
        const classNameA = classes.find(c => c.id === classA)?.name || '';
        const classNameB = classes.find(c => c.id === classB)?.name || '';

        // Numeric class name comparison (e.g., CLASS10 vs CLASS5)
        const numA = parseInt(classNameA.match(/\d+/)?.[0] || '0', 10);
        const numB = parseInt(classNameB.match(/\d+/)?.[0] || '0', 10);
        if (numA !== numB) return numA - numB;

        return divA.localeCompare(divB); // Alphabetical division comparison
    });

    sortedClassDivKeys.forEach(key => {
        const { classId, division, students: studentsInThisClassDiv } = studentsByClassDiv[key];
        const className = classes.find(c => c.id === classId)?.name || classId;

        // Filter schedules to ONLY include the ones for this specific class and division.
        const schedulesForThisClass = examSchedules.filter(s =>
            s.examId === examId &&
            s.classId === classId &&
            s.division === division
        );

        // Call the processing function with the correctly scoped schedules.
        const classResults = processExamResultsData(studentsInThisClassDiv, schedulesForThisClass, marks, examId, gradingSystem);

        const toppers = classResults
            .filter(r => r.finalStatus === 'PASS')
            .sort((a, b) => b.grandPct - a.grandPct)
            .slice(0, 4); // Get top 4

        if (toppers.length > 0) {
            toppersHtml += `
                <div class="ui-card mb-4 printable-section">
                    <h6 class="section-header text-primary">Toppers for ${className} - ${division}</h6>
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3">
                        
                        ${toppers.map((topper, index) => {
                            const student = students.find(s => s.id === topper.studentId);
                            const exam = exams.find(e => e.id === examId);
                            const studentPhotoSrc = topper.studentId && students.find(s => s.id === topper.studentId)?.photoDriveId
                                ? `https://drive.google.com/thumbnail?id=${students.find(s => s.id === topper.studentId).photoDriveId}&sz=200`
                                : 'https://placehold.co/100x120?text=No+Photo';
                            
                            const positionColor = ['#FFD700', '#C0C0C0', '#CD7F32'][index] || '#6c757d'; // Gold, Silver, Bronze, Gray

                            return `
                                <div class="col">
                                    <div class="card h-100 shadow-sm border-${index < 3 ? 'success' : 'light'}" style="border-width: 2px;">
                                        <div class="card-body text-center pb-2">
                                            <div class="position-absolute top-0 start-50 translate-middle badge rounded-pill fs-5"
                                                 style="background-color: ${positionColor}; color: white; padding: 0.4em 0.8em; margin-top: -15px;">
                                                #${index + 1}
                                            </div>
                                            <img src="${studentPhotoSrc}" alt="${topper.studentName}" class="rounded-circle mt-3 mb-2" style="width: 80px; height: 80px; object-fit: cover;">
                                            <h6 class="mb-0">${topper.studentName}</h6>
                                            <p class="text-muted small mb-1">${topper.grandPct?.toFixed(2) || '0.00'}%</p>
                                            <p class="mb-0 small text-success fw-bold">${topper.overallGrade}</p>
                                            <button class="btn btn-sm btn-outline-primary mt-2" 
                        onclick="generateTopperPoster('${topper.studentId}', '${examId}', ${index + 1})">
                    <i class="fas fa-award me-1"></i> Generate Poster

                </button>

                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
    });
    
    // Final rendering and attaching the print listener
    if (toppersHtml.includes('ui-card')) {
        container.innerHTML = toppersHtml;
        document.getElementById('print-toppers-report-btn').addEventListener('click', () => {
            const exam = exams.find(e => e.id === examId);
            printContentOfDiv('toppers-display-container', `Exam Toppers - ${exam.name}`);
        });
    } else {
        container.innerHTML = `<p class="alert alert-info text-center">No toppers found for this exam (or no students passed).</p>`;
    }
}
// Variable to hold the Chart.js instance for grade distribution
let gradeDistributionChart = null;

/**
 * Renders the Grade Distribution tab content.
 */
function renderExamReportsGradeDistributionTab() { // Renamed from renderExamControlGradeDistributionTab
    const container = document.getElementById('exam-reports-grade-dist'); // Updated ID
    if (!container) return;

    const classOptions = `<option value="all">-- All Classes --</option>${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}`;


    container.innerHTML = `
        <div class="ui-card mb-4">
            <h5 class="section-header">Grade Distribution Analysis</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Select Exam</label>
                    <select id="grade-dist-exam-select" class="form-select">
                        <option value="all">-- All Exams (Cumulative) --</option>
                        ${exams.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Select Class</label>
                    <select id="grade-dist-class-select" class="form-select">${classOptions}</select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Grading System</label>
                    <select id="grade-dist-grading-system" class="form-select">
                        <option value="type1">A+, A, B+, B...</option>
                        <option value="type2">O, A, B, C...</option>
                    </select>
                </div>
            </div>
            <div class="text-end mt-3">
                <button id="generate-grade-dist-btn" class="btn btn-primary">Generate Distribution</button>
            </div>
        </div>
        <div id="grade-dist-results-container" class="mt-4">
            <p class="text-muted text-center p-4">Select filters and click 'Generate Distribution'.</p>
        </div>
        <div id="grade-dist-chart-container" class="mt-4" style="height: 400px;">
            <canvas id="grade-distribution-chart"></canvas>
        </div>
    `;

    const examSelect = document.getElementById('grade-dist-exam-select');
    const classSelect = document.getElementById('grade-dist-class-select');
    const gradingSystemSelect = document.getElementById('grade-dist-grading-system');
    const generateBtn = document.getElementById('generate-grade-dist-btn');
    const resultsContainer = document.getElementById('grade-dist-results-container');
    const chartCanvas = document.getElementById('grade-distribution-chart');

    const generateDistribution = () => {
        const selectedExamId = examSelect.value;
        const selectedClassId = classSelect.value;
        const selectedGradingSystem = gradingSystemSelect.value;

        displayGradeDistribution(selectedExamId, selectedClassId, selectedGradingSystem);
    };

    generateBtn.addEventListener('click', generateDistribution);

    // Initial load
    if (exams.length > 0 || classes.length > 0) {
        generateDistribution();
    }
}


/**
 * Displays the grade distribution table and chart.
 * @param {string} examId - 'all' or a specific exam ID.
 * @param {string} classId - 'all' or a specific class ID.
 * @param {string} gradingSystem - 'type1' or 'type2'.
 */
function displayGradeDistribution(examId, classId, gradingSystem) {
    const resultsContainer = document.getElementById('grade-dist-results-container');
    const chartCanvas = document.getElementById('grade-distribution-chart');

    resultsContainer.innerHTML = `<div class="text-center p-4"><div class="spinner-border"></div><p>Calculating distribution...</p></div>`;
    if (gradeDistributionChart) {
        gradeDistributionChart.destroy();
        gradeDistributionChart = null;
    }

    // Determine students to analyze
    let studentsToAnalyze = students;
    if (classId !== 'all') {
        studentsToAnalyze = studentsToAnalyze.filter(s => s.classId === classId);
    }

    if (studentsToAnalyze.length === 0) {
        resultsContainer.innerHTML = `<p class="alert alert-info text-center">No students found for analysis in this selection.</p>`;
        return;
    }

    const gradeCounts = {};
    const gradeScale = gradingSystem === 'type1'
        ? ['A+', 'A', 'B+', 'B', 'C+', 'C', 'D', 'E', 'F', 'AB']
        : ['O', 'A', 'B', 'C', 'D', 'E', 'F', 'AB'];

    // Initialize counts for all grades
    gradeScale.forEach(grade => gradeCounts[grade] = 0);
    gradeCounts['N/A'] = 0; // For subjects without marks/schedules

    studentsToAnalyze.forEach(student => {
        let relevantSchedules = examSchedules;
        if (examId !== 'all') {
            relevantSchedules = relevantSchedules.filter(s => s.examId === examId);
        }
        // Filter schedules for subjects actually belonging to the student's class
        relevantSchedules = relevantSchedules.filter(sch =>
            sch.classId === student.classId &&
            sch.division === student.division
        );

        relevantSchedules.forEach(schedule => {
            const markId = `${schedule.examId}_${student.id}_${schedule.subjectId}`;
            const mark = marks[markId];
            const maxTotal = (schedule.maxTE || 0) + (schedule.maxCE || 0);

            let grade = 'N/A';
            if (mark) {
                const te = mark.te === 'AB' ? 'AB' : Number(mark.te || 0);
                const ce = mark.ce === 'AB' ? 'AB' : Number(mark.ce || 0);
                const total = te === 'AB' || ce === 'AB' ? 'AB' : te + ce;
                grade = (total === 'AB') ? 'AB' : (maxTotal > 0 ? (gradingSystem === 'type1' ? calculateGrade(total, maxTotal) : calculateGradeType2(total, maxTotal)) : 'N/A');
            }

            if (gradeCounts[grade] !== undefined) {
                gradeCounts[grade]++;
            } else {
                gradeCounts['N/A']++; // Catch unexpected grades or missing data
            }
        });
    });

    // Display results in a table
    let tableHtml = `
        <table class="table table-bordered table-sm">
            <thead><tr><th>Grade</th><th>Count</th><th>Percentage</th></tr></thead>
            <tbody>`;
    let totalGrades = 0;
    gradeScale.forEach(grade => totalGrades += gradeCounts[grade]);
    totalGrades += gradeCounts['N/A']; // Include N/A in total for percentage calculation

    gradeScale.forEach(grade => {
        const count = gradeCounts[grade];
        const percentage = totalGrades > 0 ? ((count / totalGrades) * 100).toFixed(1) : '0.0';
        tableHtml += `<tr><td>${grade}</td><td>${count}</td><td>${percentage}%</td></tr>`;
    });
    // Add N/A row
    if (gradeCounts['N/A'] > 0) {
        const naPercentage = totalGrades > 0 ? ((gradeCounts['N/A'] / totalGrades) * 100).toFixed(1) : '0.0';
        tableHtml += `<tr><td>N/A</td><td>${gradeCounts['N/A']}</td><td>${naPercentage}%</td></tr>`;
    }
    tableHtml += `</tbody></table>`;
    resultsContainer.innerHTML = tableHtml;

    // Render the chart
    renderGradeDistributionChart(gradeCounts, gradeScale, chartCanvas);
}

/**
 * Renders the Chart.js bar chart for grade distribution.
 * @param {object} gradeCounts - Object with grade counts (e.g., {'A+': 10, 'B': 5}).
 * @param {Array<string>} gradeScale - Ordered list of grade labels.
 * @param {HTMLCanvasElement} canvas - The canvas element for the chart.
 */
function renderGradeDistributionChart(gradeCounts, gradeScale, canvas) {
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    if (gradeDistributionChart) {
        gradeDistributionChart.destroy();
    }

    const labels = gradeScale;
    const data = gradeScale.map(grade => gradeCounts[grade] || 0);

    gradeDistributionChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Number of Students',
                data: data,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 },
                    title: { display: true, text: 'Number of Students' }
                }
            },
            plugins: {
                title: { display: true, text: 'Grade Distribution' },
                legend: { display: false }
            }
        }
    });
}

function attachDataListenersnew(collectionsToWatch, main = false) {
    
    
    
    const collectionMap = {
        students: { setter: data => students = data, renderer: null },
        // ... rest of your collectionMap ...
    };

    collectionsToWatch.forEach(name => {
        const config = collectionMap[name];
        const unsub = onSnapshot(getCollectionRef(name), snapshot => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            //config.setter(data); // Updates global JS array
            updateGlobalDataAndCache(name, Object.values(data));
            
            if (config.renderer) {
                config.renderer();
            }
        });
        activeListeners[name] = unsub;
        if (collectionLoadPromises[name] && collectionLoadPromises[name].resolve) {
                collectionLoadPromises[name].resolve();
            }
    });
}
// --- In your <script type="module"> block ---
// REPLACE your entire updateGlobalDataAndCache function with this one

const updateGlobalDataAndCache = async (collectionName, data) => {
    try {
        // Step 1: Clear the entire table first.
        // This ensures no data from a previous user (like an admin) remains.
        await appDb[collectionName].clear();
        console.log(`Cleared IndexedDB table: ${collectionName}.`);

        // Step 2: Add the new, freshly fetched data.
        // This populates the empty table with only the data for the current user.
        await appDb[collectionName].bulkPut(data);
        console.log(`Synced ${data.length} records to ${collectionName}.`);

    } catch (e) {
        console.error(`Error during full refresh of ${collectionName} in IndexedDB:`, e);
    }
};

/**
 * Main function to render the "Birthdays" module shell, including the date selector.
 */
window.renderBirthdaysModule = () => {
    const mainContent = document.getElementById('main-content');

    // Get today's date in YYYY-MM-DD format, which is required for the date input value
    const today = new Date();
    // Adjust for timezone offset to prevent yesterday's date
    today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
    const todayString = today.toISOString().slice(0, 10);

    mainContent.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2 mb-0">Birthday Finder</h1>
            <div class="d-flex align-items-center">
                <label for="birthday-date-selector" class="form-label me-2 mb-0">Select Date:</label>
                <input type="date" id="birthday-date-selector" class="form-control" style="width: auto;">
            </div>
        </div>
        
        <div id="birthday-list-container"></div>
    `;

    const dateSelector = document.getElementById('birthday-date-selector');
    
    // Set the initial value to today and load the list
    dateSelector.value = todayString;
    displayBirthdayList(todayString);

    // Add a listener to update the list whenever the date changes
    dateSelector.addEventListener('change', () => {
        displayBirthdayList(dateSelector.value);
    });
};

/**
 * Finds and displays the list of students with birthdays on the selected date.
 * @param {string} dateString - The selected date in "YYYY-MM-DD" format.
 */
function displayBirthdayList(dateString) {
    const container = document.getElementById('birthday-list-container');
    if (!container) return;

    // Convert the input string to a Date object
    // Adding 'T00:00:00' ensures the date is parsed in the local timezone
    const selectedDate = new Date(`${dateString}T00:00:00`);
    const birthdaysOnDate = getBirthdaysForDate(selectedDate);
    
    let content = '';

    if (birthdaysOnDate.length === 0) {
        content = `<p class="alert alert-info">No student birthdays on this date.</p>`;
    } else {
        content += `<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">`;
        birthdaysOnDate.forEach(student => {
            const studentPhotoSrc = student.photoDriveId
                ? `https://drive.google.com/thumbnail?id=${student.photoDriveId}&sz=200`
                : 'https://placehold.co/100x100?text=No+Photo';
            
            const className = classes.find(c => c.id === student.classId)?.name || 'N/A';
            
            content += `
                <div class="col">
                    <div class="card h-100 text-center shadow-sm">
                        <div class="card-body">
                            <img src="${studentPhotoSrc}" alt="${student.name}" class="rounded-circle mb-3" style="width: 100px; height: 100px; object-fit: cover;">
                            <h5 class="card-title">${student.name}</h5>
                            <p class="card-text text-muted">${className} - ${student.division}</p>
                        </div>
                        <div class="card-footer bg-white border-0 pb-3">
                            <button class="btn btn-success me-2" onclick="sendBirthdayWhatsapp('${student.id}')">
                                <i class="fab fa-whatsapp"></i> Wish
                            </button>
                            <button class="btn btn-primary" onclick="generateBirthdayPoster('${student.id}')">
                                <i class="fas fa-paint-brush"></i> Poster
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        content += `</div>`;
    }
    container.innerHTML = content;
}
/**
 * Helper function to filter students for birthdays on a specific date.
 * @param {Date} selectedDate - A JavaScript Date object for the date to check.
 * @returns {Array<object>} An array of student objects.
 */
function getBirthdaysForDate(selectedDate) {
    const checkMonth = selectedDate.getMonth() + 1; // getMonth() is 0-indexed
    const checkDay = selectedDate.getDate();

    return students.filter(student => {
        if (!student.dob) return false;
        try {
            // Adding 'T00:00:00' to the DOB string also helps prevent timezone issues
            const dob = new Date(`${student.dob}T00:00:00`); 
            const dobMonth = dob.getMonth() + 1;
            const dobDay = dob.getDate();
            return dobMonth === checkMonth && dobDay === checkDay;
        } catch (e) {
            return false;
        }
    });
}

/**
 * Opens WhatsApp with a pre-filled birthday message.
 * @param {string} studentId - The ID of the student to wish.
 */
window.sendBirthdayWhatsapp = (studentId) => {
    const student = students.find(s => s.id === studentId);
    if (!student) return;

    // Use student's WhatsApp number or fallback to mobile1
    const whatsAppNumber = student.whatsappNo || student.mobile1;
    if (!whatsAppNumber) {
        showAlert('No WhatsApp number found for this student.', 'warning');
        return;
    }

    const schoolName = schoolDetails.name || 'Our School';
    const message = `Happy Birthday, ${student.name}! ðŸŽ‰ðŸŽ‚\n\nWishing you a fantastic day from everyone at ${schoolName}.`;
    const encodedMessage = encodeURIComponent(message);
    const whatsappUrl = `https://wa.me/${whatsAppNumber}?text=${encodedMessage}`;
    
    window.open(whatsappUrl, '_blank');
};


/**
 * Generates a birthday poster on a canvas and shows it in the preview modal.
 * @param {string} studentId - The ID of the birthday student.
 */
window.generateBirthdayPoster = async (studentId) => {
    const student = students.find(s => s.id === studentId);
    if (!student) return;

    showAlert('Generating birthday poster...', 'info');
    
    // A few simple quotes to choose from
    const quotes = [
        "May your day be as bright as your smile.",
        "Wishing you a year full of success and happiness.",
        "Hope your special day brings you all that your heart desires!"
    ];
    const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];

    try {
        // --- Load Images ---
        const backgroundUrl ='KYHSSLOGO.jpg';//  'https://i.imgur.com/L5nLrlf.png'; // A sample birthday background
        const studentPhotoUrl = student.photoDriveId ? await getSafeImageFromDrive(student.photoDriveId) : 'https://placehold.co/200x250?text=No+Photo';

        const [bgImage, studentImage] = await Promise.all([
            loadImage(backgroundUrl),
            loadImage(studentPhotoUrl)
        ]);

        // --- Setup and Draw on Canvas ---
        const canvas = document.createElement('canvas');
        canvas.width = 1080;
        canvas.height = 1920;
        const ctx = canvas.getContext('2d');

        ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);

        // Draw student photo
        ctx.drawImage(studentImage, 340, 450, 400, 500);

        // Draw Text
        ctx.textAlign = 'center';
        
        ctx.font = 'bold 100px Inter';
        ctx.fillStyle = '#FFFFFF';
        ctx.fillText("Happy Birthday", 540, 250);

        ctx.font = 'bold 80px Inter';
        ctx.fillStyle = '#FFD700'; // Gold
        ctx.fillText(student.name.toUpperCase(), 540, 1100);

        ctx.font = 'italic 45px Inter';
        ctx.fillStyle = '#FFFFFF';
        ctx.fillText(`"${randomQuote}"`, 540, 1250);

        // --- Display in the Reusable Modal ---
        const dataUrl = canvas.toDataURL('image/png');
        const posterImageEl = document.getElementById('poster-image-display');
        const saveBtnEl = document.getElementById('save-poster-btn');
        const posterModalEl = document.getElementById('poster-modal');
        const posterModalLabel = document.getElementById('posterModalLabel');

        if (posterImageEl && saveBtnEl && posterModalEl) {
            posterModalLabel.textContent = `Birthday Poster for ${student.name}`;
            posterImageEl.src = dataUrl;
            saveBtnEl.href = dataUrl;
            saveBtnEl.download = `HappyBirthday_${student.name}.png`;
            const modal = new bootstrap.Modal(posterModalEl);
            modal.show();
        }

    } catch (error) {
        console.error('Error generating birthday poster:', error);
        showAlert(`Failed to generate poster. Error: ${error.message}`, 'danger');
    }
};

// =========================================================================
// --- âš™ï¸ MASTER CONTROL MODULE (DATABASE EXPLORER VERSION - FINAL) ---
// =========================================================================

// Global state for this module
let masterControlPath = [];
const masterControlCollections = {
    'root': ['students', 'teachers', 'classes', 'subjects', 'classroomSubjects', 'exams', 'examSchedules', 'holidays', 'attendance', 'books', 'bookIssuances', 'reports', 'vehicles', 'forms', 'formResponses', 'festHouses', 'fests', 'festEvents', 'festRegistrations', 'festResults', 'examRooms', 'examRoomAllocationRules', 'examDuties', 'examAbsentees', 'feeData', 'schoolDetails', 'examRegistrationSettings', 'festSettings','syllabuses'],
    'feeData': () => {
        const years = new Set();
        [...feeStructures, ...studentFeeSetups, ...receipts].forEach(item => {
            if (item && item.financialYear) years.add(item.financialYear);
        });
        return Array.from(years).sort().reverse();
    },
    'feeData/{year}': () => ['feeStructures', 'studentFeeSetups', 'receipts', 'pendingPayments']
};

/**
 * Renders the main shell for the Master Control "Database Explorer".
 */
window.renderMasterControlModule = () => {
    const mainContent = document.getElementById('main-content');
    if (currentUserRole !== 'admin') {
        mainContent.innerHTML = `<div class="alert alert-danger"><h4>Access Denied</h4><p>This feature is available for administrators only.</p></div>`;
        return;
    }

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Database Explorer</h1>
        <div class="alert alert-warning">
            <strong><i class="fas fa-exclamation-triangle me-2"></i>Warning:</strong> You are directly editing the database. Changes are immediate and permanent.
        </div>
        <div class="row">
            <div class="col-md-4 col-lg-3">
                <div class="card">
                    <div class="card-header fw-bold">Collections</div>
                    <div id="master-control-tree" class="list-group list-group-flush"></div>
                </div>
            </div>
            <div class="col-md-8 col-lg-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span id="master-control-header-text" class="fw-bold">Select a collection</span>
                        <div id="master-control-actions" class="d-none align-items-center flex-grow-1 justify-content-end">
                            <input type="search" id="master-control-search" class="form-control form-control-sm w-auto me-3" placeholder="Search...">
                            
                            <button id="expand-all-btn" class="btn btn-sm btn-outline-secondary me-2">Expand All</button>
                            <button id="collapse-all-btn" class="btn btn-sm btn-outline-secondary me-3">Collapse All</button>

                            <div class="form-check me-3">
                                <input class="form-check-input" type="checkbox" id="master-control-select-all">
                                <label class="form-check-label" for="master-control-select-all">Select All</label>
                            </div>
                            <button id="delete-selected-docs-btn" class="btn btn-sm btn-danger" disabled>
                                <i class="fas fa-trash me-1"></i>Delete (<span id="selected-doc-count">0</span>)
                            </button>
                        </div>
                    </div>
                    <div id="master-control-content" class="card-body">
                        <p class="text-muted p-5 text-center">Select a collection from the tree on the left.</p>
                    </div>
                </div>
            </div>
        </div>
        `;
    
    renderNavigationTree();
    attachMasterControlListeners();
}
/**
 * Renders the collapsible navigation tree on the left.
 */
function renderNavigationTree() {
    const treeContainer = document.getElementById('master-control-tree');
    let treeHtml = '';
    masterControlCollections.root.forEach(collectionName => {
        if (collectionName === 'feeData') {
            const years = masterControlCollections.feeData();
            treeHtml += `
                <div class="list-group-item">
                    <a href="#feeDataCollapse" data-bs-toggle="collapse" class="text-decoration-none d-block"><i class="fas fa-folder me-2"></i>feeData</a>
                    <div class="collapse" id="feeDataCollapse">
                        <div class="list-group ps-3 mt-1">
                            ${years.map(year => `
                                <a href="#feeData-${year}-Collapse" data-bs-toggle="collapse" class="list-group-item list-group-item-action border-0 py-1"><i class="fas fa-folder-open me-2"></i>${year}</a>
                                <div class="collapse" id="feeData-${year}-Collapse">
                                    <div class="list-group ps-4">
                                        ${masterControlCollections['feeData/{year}']().map(subColl => `<a href="#" class="list-group-item list-group-item-action border-0 py-1" data-path="feeData/${year}/${subColl}"><i class="fas fa-table me-2"></i>${subColl}</a>`).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
        } else {
            treeHtml += `<a href="#" class="list-group-item list-group-item-action" data-path="${collectionName}"><i class="fas fa-table me-2"></i>${collectionName}</a>`;
        }
    });
    treeContainer.innerHTML = treeHtml;
}

/**
 * Displays a list of documents with previews for the selected collection.
 */
async function displayDocumentList(path) {
    const contentDiv = document.getElementById('master-control-content');
    const headerText = document.getElementById('master-control-header-text');
    const actionsDiv = document.getElementById('master-control-actions');
    
    if (!contentDiv || !headerText || !actionsDiv) return;

    masterControlPath = path.split('/');
    headerText.textContent = `Documents in: ${masterControlPath.join(' / ')}`;
    contentDiv.innerHTML = `<div class="text-center p-5"><div class="spinner-border"></div></div>`;
    actionsDiv.classList.add('d-none');

    let collectionRef;
    if (masterControlPath.length === 1) {
        collectionRef = getCollectionRef(masterControlPath[0]);
    } else if (masterControlPath.length === 3 && masterControlPath[0] === 'feeData') {
        collectionRef = getFeeCollectionRef(masterControlPath[1], masterControlPath[2]);
    } else {
        contentDiv.innerHTML = '<p class="alert alert-danger">Invalid path selected.</p>';
        return;
    }
    
    const snapshot = await getDocs(collectionRef);
    const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    if (docs.length === 0) {
        contentDiv.innerHTML = '<p class="text-muted text-center p-5">This collection is empty.</p>';
        return;
    }
    
    actionsDiv.classList.remove('d-none');
    actionsDiv.classList.add('d-flex');

    contentDiv.innerHTML = `<div class="list-group">` + docs.map(doc => {
        const previewKeys = Object.keys(doc).filter(k => k !== 'id' && typeof doc[k] !== 'object').slice(0, 3);
        const previewHtml = previewKeys.map(key => {
            let value = String(doc[key]);
            if (value.length > 40) value = value.substring(0, 40) + '...';
            return `<span class="me-3"><strong class="text-muted">${key}:</strong> ${value}</span>`;
        }).join('');
        
        return `
            <div class="list-group-item" id="doc-${doc.id}">
                <div class="doc-summary d-flex align-items-center">
                    <div class="me-3"><input class="form-check-input doc-select-checkbox" type="checkbox" data-doc-id="${doc.id}"></div>
                    <div class="flex-grow-1">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1 fw-bold">${doc.id}</h6>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary py-0 px-1 me-1 expand-doc-btn" title="View Details"><i class="fas fa-chevron-down fa-xs"></i> View</button>
                                <button class="btn btn-sm btn-outline-primary py-0 px-1 me-1 edit-doc-btn" title="Edit"><i class="fas fa-edit fa-xs"></i> Edit</button>
                                <button class="btn btn-sm btn-outline-danger py-0 px-1 delete-doc-btn" title="Delete"><i class="fas fa-trash fa-xs"></i> Delete</button>
                            </div>
                        </div>
                        <p class="mb-1 small text-truncate">${previewHtml}</p>
                    </div>
                </div>
                <div class="details-and-edit-container mt-2 pt-2 border-top" style="display: none;"></div>
            </div>`;
    }).join('') + `</div>`;
}

/**
 * Attaches event listeners for the entire module using event delegation.
 */
function attachMasterControlListeners() {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) return;

    const updateBulkActionUI = () => {
        const checkboxes = mainContent.querySelectorAll('.doc-select-checkbox');
        const checkedCheckboxes = mainContent.querySelectorAll('.doc-select-checkbox:checked');
        const selectAllCheckbox = mainContent.querySelector('#master-control-select-all');
        const deleteBtn = mainContent.querySelector('#delete-selected-docs-btn');
        const countSpan = mainContent.querySelector('#selected-doc-count');
        if (!deleteBtn || !countSpan || !selectAllCheckbox) return;
        deleteBtn.disabled = (checkedCheckboxes.length === 0);
        countSpan.textContent = checkedCheckboxes.length;
        selectAllCheckbox.checked = checkboxes.length > 0 && checkedCheckboxes.length === checkboxes.length;
    };

    mainContent.addEventListener('input', e => {
        // --- NEW: Live Search Filter ---
        if (e.target.id === 'master-control-search') {
            const searchTerm = e.target.value.toLowerCase();
            const documents = mainContent.querySelectorAll('.list-group-item');
            documents.forEach(doc => {
                const docText = doc.textContent.toLowerCase();
                doc.style.display = docText.includes(searchTerm) ? 'block' : 'none';
            });
        }
    });

    mainContent.addEventListener('click', async e => {
        const target = e.target;

        // Navigation Tree
        const navLink = target.closest('#master-control-tree a[data-path]');
        if (navLink && !navLink.hasAttribute('data-bs-toggle')) {
            e.preventDefault();
            document.querySelectorAll('#master-control-tree a').forEach(a => a.classList.remove('active'));
            navLink.classList.add('active');
            displayDocumentList(navLink.dataset.path);
        }
        if (target.id === 'expand-all-btn') {
            document.querySelectorAll('.list-group-item').forEach(item => {
                const container = item.querySelector('.details-and-edit-container');
                const icon = item.querySelector('.expand-doc-btn i');
                if (container && icon && container.style.display !== 'block') {
                    // We need to fetch and render the full details first
                    const docId = item.id.replace('doc-', '');
                    getDocumentForEditing(docId).then(doc => {
                         const fullDetailsHtml = Object.keys(doc).map(key => `<div class="row mb-1"><dt class="col-sm-3 text-muted">${key}</dt><dd class="col-sm-9"><pre class="mb-0"><code>${typeof doc[key] === 'object' ? JSON.stringify(doc[key], null, 2) : (doc[key] || '')}</code></pre></dd></div>`).join('');
                         container.innerHTML = `<dl class="row">${fullDetailsHtml}</dl>`;
                         container.style.display = 'block';
                         icon.classList.remove('fa-chevron-down');
                         icon.classList.add('fa-chevron-up');
                    });
                }
            });
            return; // Action is complete
        }
        
        // Collapse All Button
        if (target.id === 'collapse-all-btn') {
            document.querySelectorAll('.list-group-item').forEach(item => {
                const container = item.querySelector('.details-and-edit-container');
                const icon = item.querySelector('.expand-doc-btn i');
                if (container && icon) {
                    container.style.display = 'none';
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                }
            });
            return; // Action is complete
        }


        // Bulk selection actions
        if (target.id === 'master-control-select-all' || target.classList.contains('doc-select-checkbox')) {
            if(target.id === 'master-control-select-all') {
                mainContent.querySelectorAll('.doc-select-checkbox').forEach(cb => cb.checked = target.checked);
            }
            updateBulkActionUI();
            return; // Action is complete
        }


        // if (target.classList.contains('doc-select-checkbox')) {
        //     updateBulkActionUI();
        // }
        if (target.id === 'delete-selected-docs-btn') {
            const checkedCheckboxes = mainContent.querySelectorAll('.doc-select-checkbox:checked');
            const idsToDelete = Array.from(checkedCheckboxes).map(cb => cb.dataset.docId);
            const deleteModal = new bootstrap.Modal(document.getElementById('delete-confirm-modal'));
            
            if (idsToDelete.length > 0) {
                // Prepare and show the modal instead of a simple confirm
                document.getElementById('delete-confirm-text').innerHTML = `You are about to permanently delete <strong>${idsToDelete.length}</strong> document(s). This action cannot be undone.`;
                const confirmInput = document.getElementById('delete-confirm-input');
                const finalDeleteBtn = document.getElementById('final-delete-btn');
                
                confirmInput.value = '';
                finalDeleteBtn.disabled = true;
                
                // Store IDs on the button for later retrieval
                finalDeleteBtn.dataset.idsToDelete = JSON.stringify(idsToDelete);

                deleteModal.show();
            }
        }

        // --- NEW: Logic for inside the confirmation modal ---
        if (target.id === 'final-delete-btn') {
            const idsToDelete = JSON.parse(target.dataset.idsToDelete || '[]');
            const deleteModal = bootstrap.Modal.getInstance(document.getElementById('delete-confirm-modal'));

            if (idsToDelete.length > 0) {
                const batch = writeBatch(db);
                if (masterControlPath.length === 1) {
                    idsToDelete.forEach(id => batch.delete(getDocRef(masterControlPath[0], id)));
                } else if (masterControlPath.length === 3) {
                    idsToDelete.forEach(id => batch.delete(getFeeDocRef(masterControlPath[1], masterControlPath[2], id)));
                }
                
                await batch.commit();
                showAlert(`${idsToDelete.length} documents deleted.`, 'success');
                deleteModal.hide();
                displayDocumentList(masterControlPath.join('/'));
            }
        }


        // Single Document Actions
        const docItem = target.closest('.list-group-item');
        if (!docItem) return;
        const docId = docItem.id.replace('doc-', '');
        if (target.id === 'expand-all-btn') {
            document.querySelectorAll('.list-group-item').forEach(item => {
                const container = item.querySelector('.details-and-edit-container');
                const icon = item.querySelector('.expand-doc-btn i');
                if (container && icon) {
                    container.style.display = 'block';
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                }
            });
        }
        

        if (target.closest('.expand-doc-btn')) {
            // This logic is now simpler and also fetches the data on demand
            const container = docItem.querySelector('.details-and-edit-container');
            const icon = target.closest('.expand-doc-btn').querySelector('i');
            const isVisible = container.style.display === 'block';

            if (isVisible) {
                container.style.display = 'none';
                icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
            } else {
                // Fetch full data before showing
                const doc = await getDocumentForEditing(docId);
                const fullDetailsHtml = Object.keys(doc).map(key => `<div class="row mb-1"><dt class="col-sm-3 text-muted">${key}</dt><dd class="col-sm-9"><pre class="mb-0"><code>${typeof doc[key] === 'object' ? JSON.stringify(doc[key], null, 2) : (doc[key] || '')}</code></pre></dd></div>`).join('');
                container.innerHTML = `<dl class="row">${fullDetailsHtml}</dl>`;
                container.style.display = 'block';
                icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
            }
        }


        if (target.closest('.edit-doc-btn')) {
            const doc = await getDocumentForEditing(docId);
            const container = docItem.querySelector('.details-and-edit-container');
            
            let formHtml = '';
            for (const key in doc) {
                const value = typeof doc[key] === 'object' ? JSON.stringify(doc[key], null, 2) : (doc[key] || '');
                formHtml += `<div class="mb-2"><label class="form-label small fw-bold">${key}</label><textarea class="form-control form-control-sm" data-key="${key}" ${key === 'id' ? 'readonly' : ''} rows="${key === 'id' ? 1 : 4}">${value}</textarea></div>`;
            }
            
            // NEW: HTML for adding a new field
            const addNewFieldHtml = `
                <hr>
                <div class="p-2 border rounded bg-light">
                    <h6 class="small fw-bold">Add New Field</h6>
                    <div class="row g-2">
                        <div class="col-5"><input type="text" id="new-field-key" class="form-control form-control-sm" placeholder="Field Name (Key)"></div>
                        <div class="col-5"><input type="text" id="new-field-value" class="form-control form-control-sm" placeholder="Field Value"></div>
                        <div class="col-2 d-grid"><button type="button" class="btn btn-sm btn-secondary add-new-field-btn">Add</button></div>
                    </div>
                </div>`;

            container.innerHTML = `<div class="edit-form">${formHtml}</div>${addNewFieldHtml}<div class="text-end mt-2"><button class="btn btn-sm btn-secondary me-2 cancel-edit-btn">Cancel</button><button class="btn btn-sm btn-success save-doc-btn">Save Changes</button></div>`;
            container.style.display = 'block';
        }
        
        // --- NEW: Add New Field Button Click ---
        if (target.classList.contains('add-new-field-btn')) {
            const editContainer = target.closest('.details-and-edit-container');
            const keyInput = editContainer.querySelector('#new-field-key');
            const valueInput = editContainer.querySelector('#new-field-value');
            const key = keyInput.value.trim();
            const value = valueInput.value;

            if (!key) {
                showAlert('Field Name cannot be empty.', 'warning');
                return;
            }
            
            // Check if field already exists
            if (editContainer.querySelector(`.edit-form textarea[data-key="${key}"]`)) {
                showAlert(`Field "${key}" already exists. You can edit it above.`, 'warning');
                return;
            }

            // Create and append the new field's HTML
            const newFieldHtml = `<div class="mb-2"><label class="form-label small fw-bold text-primary">${key} (new)</label><textarea class="form-control form-control-sm" data-key="${key}" rows="4">${value}</textarea></div>`;
            editContainer.querySelector('.edit-form').insertAdjacentHTML('beforeend', newFieldHtml);
            
            // Clear the input fields
            keyInput.value = '';
            valueInput.value = '';
        }

        
        if (target.closest('.cancel-edit-btn')) {
            displayDocumentList(masterControlPath.join('/'));
        }

        if (target.closest('.save-doc-btn')) {
            const newData = {};
            docItem.querySelectorAll('.edit-form textarea').forEach(input => {
                const key = input.dataset.key;
                const valueStr = input.value;
                try { newData[key] = JSON.parse(valueStr); }
                catch (e) {
                    if (valueStr.toLowerCase() === 'true') newData[key] = true;
                    else if (valueStr.toLowerCase() === 'false') newData[key] = false;
                    else if (!isNaN(valueStr) && valueStr.trim() !== '') newData[key] = Number(valueStr);
                    else newData[key] = valueStr;
                }
            });
            let docRef;
            if (masterControlPath.length === 1) docRef = getDocRef(masterControlPath[0], docId);
            else if (masterControlPath.length === 3) docRef = getFeeDocRef(masterControlPath[1], masterControlPath[2], docId);
            if (docRef) {
                await setDoc(docRef, newData, { merge: true });
                showAlert('Document updated!', 'success');
                displayDocumentList(masterControlPath.join('/'));
            }
        }

        if (target.closest('.delete-doc-btn')) {
            if (confirm(`Permanently delete document ${docId}?`)) {
                let docRef;
                if (masterControlPath.length === 1) docRef = getDocRef(masterControlPath[0], docId);
                else if (masterControlPath.length === 3) docRef = getFeeDocRef(masterControlPath[1], masterControlPath[2], docId);
                if (docRef) {
                    await deleteDoc(docRef);
                    showAlert('Document deleted!', 'success');
                    displayDocumentList(masterControlPath.join('/'));
                }
            }
        }

    });
    
const confirmInput = document.getElementById('delete-confirm-input');
    if (confirmInput) {
        confirmInput.addEventListener('input', () => {
            const finalDeleteBtn = document.getElementById('final-delete-btn');
            finalDeleteBtn.disabled = (confirmInput.value.trim() !== 'DELETE');
        });
    }
}
/**
 * Helper to get a single document for editing.
 */
async function getDocumentForEditing(docId) {
    let docRef;
    if (masterControlPath.length === 1) {
        docRef = getDocRef(masterControlPath[0], docId);
    } else if (masterControlPath.length === 3 && masterControlPath[0] === 'feeData') {
        docRef = getFeeDocRef(masterControlPath[1], masterControlPath[2], docId);
    }
    const docSnap = await getDoc(docRef);
    return docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null;
}


// --- NEW: STUDENT PROGRESSION MODULE ---

window.renderProgressionModule = () => {
    const mainContent = document.getElementById('main-content');
    const sortedClasses = [...classes].sort((a, b) => (a.order || 0) - (b.order || 0));
    const classOptions = sortedClasses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

    let sourceClassId = '';
    let sourceDivision = '';
    let isTeacherView = false;

    if (currentUserRole === 'teacher' && selectedUser.classCharge) {
        sourceClassId = selectedUser.classCharge.classId;
        sourceDivision = selectedUser.classCharge.division;
        isTeacherView = true;
    }

    mainContent.innerHTML = `
        <h1 class="h2 mb-4">Student Progression</h1>
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow mb-4">
                    <div class="card-header"><h5 class="m-0">1. Select Students to Promote</h5></div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="source-class-select" class="form-label">Source Class</label>
                                <select id="source-class-select" class="form-select" ${isTeacherView ? 'disabled' : ''}>
                                    <option value="">-- Select Class --</option>
                                    ${classOptions}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="source-division-select" class="form-label">Source Division</label>
                                <select id="source-division-select" class="form-select" ${isTeacherView ? 'disabled' : ''}>
                                    <option value="">-- Select Division --</option>
                                </select>
                            </div>
                        </div>
                        <div id="promotion-student-list" class="mt-4"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card shadow">
                    <div class="card-header"><h5 class="m-0">2. Select Destination</h5></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="dest-class-select" class="form-label">Promote to Class</label>
                            <select id="dest-class-select" class="form-select">${classOptions}</select>
                        </div>
                        <div class="mb-3">
                            <label for="dest-division-select" class="form-label">Promote to Division</label>
                            <select id="dest-division-select" class="form-select"></select>
                        </div>
                        <div class="d-grid">
                            <button id="promote-students-btn" class="btn btn-success btn-lg">
                                <i class="fas fa-user-graduate me-2"></i>Promote Selected Students
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    const sourceClassSelect = document.getElementById('source-class-select');
    const sourceDivisionSelect = document.getElementById('source-division-select');
    const destClassSelect = document.getElementById('dest-class-select');
    const destDivisionSelect = document.getElementById('dest-division-select');

    sourceClassSelect.addEventListener('change', () => {
        const classId = sourceClassSelect.value;
        const selectedClass = classes.find(c => c.id === classId);
        sourceDivisionSelect.innerHTML = '<option value="">-- Select Division --</option>';
        if (selectedClass) {
            sourceDivisionSelect.innerHTML += selectedClass.divisions.map(d => `<option value="${d}">${d}</option>`).join('');
        }
        displayStudentsForPromotion();

        // Smartly select the next class in order
        const currentOrder = selectedClass?.order || 0;
        const nextClass = sortedClasses.find(c => (c.order || 0) > currentOrder);
        if (nextClass) {
            destClassSelect.value = nextClass.id;
            destClassSelect.dispatchEvent(new Event('change'));
        }
    });

    destClassSelect.addEventListener('change', () => {
        const classId = destClassSelect.value;
        const selectedClass = classes.find(c => c.id === classId);
        destDivisionSelect.innerHTML = '';
        if (selectedClass) {
            destDivisionSelect.innerHTML = selectedClass.divisions.map(d => `<option value="${d}">${d}</option>`).join('');
        }
    });

    sourceDivisionSelect.addEventListener('change', displayStudentsForPromotion);
    document.getElementById('promote-students-btn').addEventListener('click', handleStudentPromotion);

    // If it's a teacher, pre-fill and trigger their class view
    if (isTeacherView) {
        sourceClassSelect.value = sourceClassId;
        sourceClassSelect.dispatchEvent(new Event('change'));
        sourceDivisionSelect.value = sourceDivision;
        sourceDivisionSelect.dispatchEvent(new Event('change'));
    }
};

function displayStudentsForPromotion() {
    const container = document.getElementById('promotion-student-list');
    const classId = document.getElementById('source-class-select').value;
    const division = document.getElementById('source-division-select').value;

    if (!classId || !division) {
        container.innerHTML = '<p class="text-muted text-center p-3">Please select a class and division.</p>';
        return;
    }

    const studentsToList = students.filter(s => s.classId === classId && s.division === division);
    if (studentsToList.length === 0) {
        container.innerHTML = '<p class="text-muted text-center p-3">No students found in this class.</p>';
        return;
    }

    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th><input type="checkbox" class="form-check-input" id="select-all-students"></th>
                        <th>Name</th>
                        <th>Admission No.</th>
                    </tr>
                </thead>
                <tbody>
                    ${studentsToList.map(s => `
                        <tr data-student-id="${s.id}">
                            <td><input type="checkbox" class="form-check-input student-promote-check"></td>
                            <td>${s.name}</td>
                            <td>${s.admissionNumber}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>`;

    document.getElementById('select-all-students').addEventListener('change', e => {
        container.querySelectorAll('.student-promote-check').forEach(cb => cb.checked = e.target.checked);
    });
}

async function handleStudentPromotion() {
    const selectedRows = document.querySelectorAll('.student-promote-check:checked');
    if (selectedRows.length === 0) {
        return showAlert('Please select at least one student to promote.', 'warning');
    }

    const destClassId = document.getElementById('dest-class-select').value;
    const destDivision = document.getElementById('dest-division-select').value;
    if (!destClassId || !destDivision) {
        return showAlert('Please select a destination class and division.', 'warning');
    }

    if (!confirm(`Are you sure you want to promote ${selectedRows.length} student(s)? This will update their class and archive their current record.`)) {
        return;
    }

    const batch = writeBatch(db);
    const studentIdsToPromote = Array.from(selectedRows).map(cb => cb.closest('tr').dataset.studentId);

    for (const studentId of studentIdsToPromote) {
        const student = students.find(s => s.id === studentId);
        if (student) {
            const studentRef = getDocRef('students', studentId);
            const historyEntry = {
                academicYear: activeFinancialYear,
                classId: student.classId,
                division: student.division
            };
            
            // Using arrayUnion is a safe way to add to an array field in Firestore
            batch.update(studentRef, {
                classId: destClassId,
                division: destDivision,
                promotionHistory: firebase.firestore.FieldValue.arrayUnion(historyEntry)
            });
        }
    }

    try {
        await batch.commit();
        showAlert(`${studentIdsToPromote.length} student(s) promoted successfully!`, 'success');
        // Refresh the view to show the students have moved
        displayStudentsForPromotion();
    } catch (error) {
        console.error("Error promoting students:", error);
        showAlert('An error occurred during promotion. See console for details.', 'danger');
    }
}
        // --- View Renderers ---


        window.viewRenderers = {
            'exam-control': window.renderExamControlModule, // <-- ADD THIS LINE
            'dashboard': window.renderDashboard, 'add-student': window.renderAddStudentForm,
            'student-mgt': window.renderStudentManagement, 'teacher-mgt': window.renderTeacherManagement,
            'birthdays': window.renderBirthdaysModule, // ðŸŽ‚ Add this line
            'class-mgt': window.renderClassManagement, 'subject-mgt': window.renderSubjectManagement,
            'subject-allocation': window.renderSubjectAllocation, 'exam-mgt': window.renderExamManagement,
            'attendance-mgt': window.renderAttendanceManagement, 'holiday-mgt': window.renderHolidayManagement, 'my-results': window.renderMyResults,
            'my-attendance': window.renderMyAttendance, 'syllabus-tracker': window.renderSyllabusTracker,
            'fee-mgt': window.renderFeeManagement, 'my-fees': window.renderMyFees,
            'form-mgt': window.renderFormManagement,    // Admin form creation
            'forms': window.renderMyForms,
            'teacher-forms': window.renderTeacherForms,
            'classwise-forms':window.renderTeacherclasswiseForms,
            'response-forms': window.renderTeacherclasswiseForms,
            'my-forms': window.renderStudentFormResponses,'fee-details':window.renderTeacherFeeDetails,
            'reports': window.renderReportsModule, // <-- ADD THIS LINE
             'school-details': window.renderSchoolDetailsModule, // <-- ADD THIS
'vehicle-mgt': window.renderVehicleManagement, // <-- ADD THIS LINE
    'mark-absentee': window.renderTeacherMarkAbsenteeModule, // <-- ADD THIS LINE
        'exam-reports': window.renderExamReportsModule, // <-- NEW TOP-LEVEL MODULE FUNCTION
    
            'bulk-import': window.renderBulkImportTool,
            'exam-timetable': window.renderUserExamTimetableView,    // For Teacher
    'my-exam-timetable': window.renderUserExamTimetableView, // For Student
    'timetable-mgt': window.renderTimetableManagement,
    // Inside the window.viewRenderers object
'library-mgt': window.renderLibraryManagement,
'library-status': window.renderTeacherLibraryStatus,
'my-library': window.renderMyLibrary,
// Inside the window.viewRenderers object
'fest-mgt': window.renderFestManagement,
'fest-registration': window.renderFestRegistration,
'my-fest-events': window.renderMyFestEvents,
'fest-scoreboard': window.renderFestScoreboard,
'timetable-mgt': window.renderTimetableManagement,
    'class-timetable': window.renderClassTimetableView,
    'master-control': window.renderMasterControlModule,
    'progression-mgt': window.renderProgressionModule, // <-- ADD THIS LINE
};      
// --- In your <script type="module"> block ---

const appDb = new Dexie("SchoolAppDB");
// Increment the version number if you are changing the schema
appDb.version(4.4).stores({
    classes: "&id, name", // &id means primary key and must be unique
    subjects: "&id, name",
    students: "&id, classId, division, admissionNumber, name",
    teachers: "&id, email, name",
    exams: "&id, name",
    examSchedules :'&id',
    examRooms :'&id',
    examRoomAllocationRules :'&id',
    examRegistrationSettings :'&id',
    examAbsentees :'&id',
    examDuties :'&id',
    marks: "&id",
    classroomSubjects: "&id, classId, division, subjectId, teacherId",
    examSchedules: "&id, examId, classId, division",
    holidays: "&id",
    attendance:"&id",
    // Add any other collections you frequently use
    books: "&id, title",
    bookIssuances: "&id, studentId, bookId, status",
    // You can also cache fee data, but be mindful of financial year changes
    feeStructures: "&id, financialYear, feeHead, classId, stage",
    studentFeeSetups: "&id, financialYear, classId, division",
    pendingPayments:"&id",
    receipts:"&id",
    //festAssociates
    fests:"&id",
    festHouses:"&id",
    festEvents:"&id",
    festSettings:"&id",
    festRegistrations:"&id",
    festResults:"&id",
    festGroups:"&id",
    //vehicles
    vehicles:"&id",
    //syllabus
    timetables:"&id",
    syllabuses:"&id",
    chapters:"&id",
    syllabusCompletion:"&id",
    schoolDetails:"&id",
    //forms
    forms :"&id",
    formResponses :"&id",
    reports :"&id",
    
});
    

    
 export async function getStudentsData(studentId = null) {
    if (studentId) {
        let student = null;
        
        // Get all students
        let allStudents = [];
        try {
            // AWAIT the result from IndexedDB
            allStudents = await appDb.students.toArray();
            
            if (allStudents.length === 0 && students.length > 0) {
               console.warn("IndexedDB students empty, falling back to global array.");
               return students;
            }
        } catch (error) {
            console.error("Error getting all students from IndexedDB:", error);
            return students; // Fallback
        }
        return allStudents;
    }
} 
/**
 * A generic, reusable function to get data from any store.
 * Implements a "cache-first, then network" strategy.
 *
 * @param {string} storeName - The name of the store/collection (e.g., 'students').
 * @param {object} [queryObj=null] - An optional query object, e.g., { classId: 'CLASS10', division: 'A' }.
 * @returns {Promise<Array|object|null>} A promise that resolves to the query result.
 */
// This is the corrected version of the function.
// Notice the `async` keyword and the `await` before the database calls.


//let students = Objects.values(appDb.students.toArray());

const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
const sidebarOverlay = document.getElementById('sidebar-overlay');

// Function to show the sidebar
export function showSidebar() {
    sidebar.classList.add('show');
    sidebarOverlay.classList.add('show');
    document.body.style.overflow = 'hidden'; // Prevent scrolling main content when sidebar is open
}

// Function to hide the sidebar
export function hideSidebar() {
    sidebar.classList.remove('show');
    sidebarOverlay.classList.remove('show');
    document.body.style.overflow = ''; // Restore scrolling
}

// Event Listeners
if (sidebarToggleBtn) {
    sidebarToggleBtn.addEventListener('click', showSidebar);
}

if (sidebarCloseBtn) {
    sidebarCloseBtn.addEventListener('click', hideSidebar);
}

if (sidebarOverlay) {
    sidebarOverlay.addEventListener('click', hideSidebar); // Clicking outside closes sidebar
}
window.addEventListener('DOMContentLoaded', () => {
    const mediaQuery = window.matchMedia('(max-width: 991.98px)');
    if (mediaQuery.matches) {
        // If it's a mobile view, ensure sidebar is hidden initially
        hideSidebar(); // Also ensures overflow is not hidden
    } else {
        // Desktop view, ensure sidebar is visible and overlay is hidden
        sidebar.classList.remove('show'); // Ensure no mobile 'show' class
        sidebarOverlay.classList.remove('show');
        document.body.style.overflow = ''; // Ensure scrolling is normal
    }
});

// Re-evaluate sidebar state on window resize
window.addEventListener('resize', () => {
    const mediaQuery = window.matchMedia('(max-width: 991.98px)');
    if (mediaQuery.matches) {
        // If resized to mobile, hide sidebar if not already hidden
        if (!sidebar.classList.contains('show')) { // Only hide if it's not already intentionally open
            hideSidebar();
        }
    } else {
        // If resized to desktop, ensure sidebar is visible and overlay is hidden
        sidebar.classList.remove('show'); // Ensure desktop default state
        sidebarOverlay.classList.remove('show');
        document.body.style.overflow = '';
    }
});

const offlineIndicator = document.getElementById('offline-indicator');

export function handleOffline() {
    if (offlineIndicator) offlineIndicator.style.display = 'block';
    showAlert('You are offline. Functionality will be limited.', 'warning');
    // Detach Firebase listeners to prevent console errors and unnecessary retries
    if (unsubscribeListeners.length > 0) {
        unsubscribeListeners.forEach(unsub => unsub());
        unsubscribeListeners = [];
        console.log('Firebase listeners detached due to offline status.');
    }
    if (unsubscribeFeeListeners.length > 0) {
        unsubscribeFeeListeners.forEach(unsub => unsub());
        unsubscribeFeeListeners = [];
    }
}

export function handleOnline() {
    if (offlineIndicator) offlineIndicator.style.display = 'none';
    showAlert('You are back online!', 'success');
    // Re-initialize data listeners if a user is logged in to get the latest data
    if (currentUserRole) {
        console.log('Re-attaching Firebase listeners...');
        //attachDataListeners();
        attachFeeDataListeners(activeFinancialYear);
    }
}

window.addEventListener('offline', handleOffline);
window.addEventListener('online', handleOnline);

// --- SESSION SAVE & RESTORE LOGIC ---

// Save the last active view before the page is unloaded
window.addEventListener('beforeunload', (event) => {
    // Only save state if a user is logged in
    if (currentUserRole && selectedUser) {
        const activeNavId = document.querySelector('.nav-link.active')?.id.replace('nav-', '');
        if (activeNavId) {
            const sessionState = {
                userId: selectedUser.id,
                viewId: activeNavId,
                timestamp: Date.now()
            };
            localStorage.setItem('schoolAppLastSession', JSON.stringify(sessionState));
        }
        // This will trigger the browser's confirmation prompt
        event.preventDefault();
        event.returnValue = '';
    }
});

// --- In your <script type="module"> block ---
// Add these new functions

/**
 * The main function to generate and download a topper poster.
 * @param {string} studentId - The ID of the topper.
 * @param {string} examId - The ID of the exam.
 * @param {number} rank - The rank/position of the student.
 */

window.generateTopperPoster = async (studentId, examId, rank)=> {
    const student = students.find(s => s.id === studentId);
    const exam = exams.find(e => e.id === examId);
    if (!student || !exam) {
        showAlert('Could not find student or exam data.', 'danger');
        return;
    }

    showAlert('Generating poster... please wait.', 'info');

    try {
        // 1. --- Load Images (This part is the same) ---
        const backgroundUrl = 'KYHSSLOGO.jpg'; // Example background
        const studentPhotoUrl = student.photoDriveId ? await getSafeImageFromDrive(student.photoDriveId) : 'https://placehold.co/200x250?text=No+Photo';

        const [bgImage, studentImage] = await Promise.all([
            loadImage(backgroundUrl),
            loadImage(studentPhotoUrl)
        ]);

        // 2. --- Setup Canvas (This part is the same) ---
        const canvas = document.createElement('canvas');
        canvas.width = 1080;
        canvas.height = 1920;
        const ctx = canvas.getContext('2d');

        // 3. --- Draw on Canvas (This part is the same) ---
        ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.beginPath();
        ctx.arc(540, 550, 200, 0, Math.PI * 2, true);
        ctx.closePath();
        ctx.clip();
        ctx.drawImage(studentImage, 340, 350, 400, 500);
        ctx.restore();

        const rankText = `${rank}${rank === 1 ? 'st' : rank === 2 ? 'nd' : rank === 3 ? 'rd' : 'th'}`;
        ctx.font = 'bold 120px Inter';
        ctx.fillStyle = '#FFD700';
        ctx.textAlign = 'center';
        ctx.strokeStyle = '#8B4513';
        ctx.lineWidth = 5;
        ctx.strokeText(rankText, 540, 950);
        ctx.fillText(rankText, 540, 950);
        
        ctx.font = 'bold 72px Inter';
        ctx.fillStyle = '#FFFFFF';
        ctx.fillText(student.name.toUpperCase(), 540, 1100);

        const className = classes.find(c => c.id === student.classId)?.name || '';
        ctx.font = '50px Inter';
        ctx.fillStyle = '#E0E0E0';
        ctx.fillText(`${className} - ${student.division}`, 540, 1180);
        
        ctx.font = 'italic 40px Inter';
        ctx.fillText(exam.name, 540, 1250);

        // 4. --- ðŸ‘‡ NEW: Display Poster in Modal (Replaces old download logic) ðŸ‘‡ ---
        const dataUrl = canvas.toDataURL('image/png');

        // Get the modal elements we created in the HTML
        const posterImageEl = document.getElementById('poster-image-display');
        const saveBtnEl = document.getElementById('save-poster-btn');
        const posterModalEl = document.getElementById('poster-modal');

        if (posterImageEl && saveBtnEl && posterModalEl) {
            // Set the image source in the modal
            posterImageEl.src = dataUrl;

            // Set the download attributes on the save button
            saveBtnEl.href = dataUrl;
            saveBtnEl.download = `${student.name}_Topper_Poster.png`;

            // Use Bootstrap's JS to show the modal
            const modal = new bootstrap.Modal(posterModalEl);
            modal.show();
        } else {
            // Fallback in case modal elements are not found
            console.error('Poster modal elements not found!');
            showAlert('Could not display poster preview.', 'danger');
        }

    } catch (error) {
        console.error('Error generating poster:', error);
        showAlert(`Failed to generate poster. Error: ${error.message}`, 'danger');
    }
}

/**
 * Helper function to fetch a Google Drive image safely using our Apps Script proxy.
 * @param {string} fileId - The Google Drive file ID.
 * @returns {Promise<string>} A promise that resolves to the Base64 image data URL.
 */
export async function getSafeImageFromDrive(fileId) {
    // ðŸ‘‡ PASTE THE GOOGLE APPS SCRIPT URL YOU COPIED IN STEP 1 HERE ðŸ‘‡
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyBkmSNI8H6eotJjuQabNL5EpMaQbVNTru3w_06onbOSXbGboJ3WvwBWbwwfaGnK6ktjg/exec';
    
    const response = await fetch(`${SCRIPT_URL}?fileId=${fileId}`);
    if (!response.ok) {
        throw new Error('Network response from Apps Script was not ok.');
    }
    const result = await response.json();
    if (result.success) {
        return result.imageData;
    } else {
        throw new Error(`Apps Script Error: ${result.error}`);
    }
}
/**
 * Helper function to load an image and return it as a promise.
 * @param {string} src - The source URL or Base64 data of the image.
 * @returns {Promise<Image>}
 */
function loadImage(src) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous"; // Important for external images
        img.onload = () => resolve(img);
        img.onerror = (err) => reject(new Error(`Failed to load image: ${src}`));
        img.src = src;
    });
}

function printContentOfDiv(divId, title = 'Report', options = {}) {
    const {
        customHeaderHtml = '',
        customFooterHtml = '',
        extraCss = '',
        pageSize = 'A4 portrait', // Default to A4 portrait
        pageMargins = '0.5cm' // Default to 1cm margins
    } = options;

    const contentEl = document.getElementById(divId);
    if (!contentEl) {
        showAlert('Could not find content to print.', 'danger');
        return;
    }

    // Clone the content to avoid modifying the live DOM
    const contentToPrint = contentEl.cloneNode(true);

    // Handle .printable-group for page breaks (if used, e.g., in Reports module)
    const groups = contentToPrint.querySelectorAll('.printable-group');
    if (groups.length > 0) {
        groups.forEach(group => {
            const headerNode = document.createElement('div');
            headerNode.innerHTML = customHeaderHtml;
            group.insertBefore(headerNode, group.firstChild);
        });
    }

    // Create a new window for printing
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
        showAlert('Please allow pop-ups for this website to print the report.', 'warning');
        return;
    }

    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${title}</title>
                <!-- Include Bootstrap CSS for consistent styling -->
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    /* --- General Print Styles --- */
                    body {
                        font-family: 'Inter', sans-serif; /* Use your app's font */
                        margin: 0; /* Reset default body margin */
                        padding: 0; /* Reset default body padding */
                        color: #333; /* Darker text for print clarity */
                    }
                    
                    /* Page setup for print */
                    @page {
                        size: ${pageSize}; /* A4 portrait, Letter landscape, etc. */
                        margin: ${pageMargins}; /* Minimal margins for more content */
                        /* Optional: Add headers/footers for print here */
                        /* @top-center { content: "${title}"; } */
                        /* @bottom-center { content: counter(page); } */
                    }

                    /* Ensure all elements are visible and print correctly */
                    * {
                        box-sizing: border-box;
                        -webkit-print-color-adjust: exact !important; /* Forces background colors/images to print */
                        print-color-adjust: exact !important;
                    }

                    /* Hide elements not meant for print */
                    .no-print {
                        display: none !important;
                    }

                    /* --- Table Specific Styles --- */
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 0.85rem; /* Slightly larger for readability than 0.8rem */
                        margin-bottom: 1rem; /* Space after tables */
                    }
                    th, td {
                        border: 1px solid #ccc; /* Lighter border */
                        padding: 0.5rem 0.75rem; /* More padding for readability */
                        text-align: left;
                        vertical-align: top; /* Align text to top in cells */
                    }
                    thead th {
                        background-color: #e9ecef; /* Lighter header background */
                        font-weight: bold;
                        color: #495057;
                    }
                    tbody tr:nth-child(even) {
                        background-color: #f8f9fa; /* Zebra striping for readability */
                    }
                    /* Ensure borders are visible on print */
                    table, th, td {
                        border-color: #dee2e6 !important;
                    }

                    /* --- Header/Footer/Group Specific Styles --- */
                    .report-header {
                        text-align: center;
                        margin-bottom: 2rem;
                        padding-bottom: 1rem;
                        border-bottom: 1px solid #eee;
                    }
                    .report-header h1, .report-header h2, .report-header h3, .report-header h4, .report-header h5 {
                        margin-top: 0;
                        margin-bottom: 0.5rem;
                        color: #343a40;
                    }
                    .report-header p {
                        margin-bottom: 0.25rem;
                        font-size: 0.95rem;
                        color: #6c757d;
                    }
                    
                    /* Page breaks for groups (if applicable) */
                    .printable-group {
                        page-break-before: always; /* Start each group on a new page */
                        padding-top: 1rem; /* Padding at top of new page */
                    }
                    .printable-group:first-child {
                        page-break-before: auto; /* Don't break before the very first group */
                        padding-top: 0;
                    }
                    
                    /* Ensure no content is cut off */
                    img, table, pre, blockquote {
                        page-break-inside: avoid;
                    }

                    /* Additional custom CSS passed in options */
                    ${extraCss}
                </style>
            </head>
            <body>
                <div style="padding: ${pageMargins};"> <!-- Apply padding to body content for consistent margins -->
                    ${groups.length === 0 ? customHeaderHtml : ''} <!-- Render header only if no groups, otherwise groups handle it -->
                    ${contentToPrint.innerHTML}
                    ${customFooterHtml}
                </div>
            </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.focus(); // Focus the new window
    // Use a slightly longer timeout to ensure all assets (like images) are loaded before printing
    // setTimeout(() => {
    //     try {
    //         // printWindow.print();
    //         // printWindow.close(); // Close the print window after printing
    //     } catch (e) {
    //         console.error("Error during print:", e);
    //         showAlert("Printing failed. Please check your browser's print settings.", "danger");
    //     }
    // }, 500); // Increased timeout for better reliability
}
        // Start App
        initializeAppAndAuth();

        
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs/qrcode.min.js"></script>
    <!-- Cropper CSS -->
<link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet">

<!-- Bootstrap & Cropper JS (at end of body) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> 
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>

</body>
</html>
